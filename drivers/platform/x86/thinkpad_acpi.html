<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › platform › x86 › thinkpad_acpi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>thinkpad_acpi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  thinkpad_acpi.c - ThinkPad ACPI Extras</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2004-2005 Borislav Deianov &lt;borislav@users.sf.net&gt;</span>
<span class="cm"> *  Copyright (C) 2006-2009 Henrique de Moraes Holschuh &lt;hmh@hmh.eng.br&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> *  02110-1301, USA.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define TPACPI_VERSION &quot;0.24&quot;</span>
<span class="cp">#define TPACPI_SYSFS_VERSION 0x020700</span>

<span class="cm">/*</span>
<span class="cm"> *  Changelog:</span>
<span class="cm"> *  2007-10-20		changelog trimmed down</span>
<span class="cm"> *</span>
<span class="cm"> *  2007-03-27  0.14	renamed to thinkpad_acpi and moved to</span>
<span class="cm"> *  			drivers/misc.</span>
<span class="cm"> *</span>
<span class="cm"> *  2006-11-22	0.13	new maintainer</span>
<span class="cm"> *  			changelog now lives in git commit history, and will</span>
<span class="cm"> *  			not be updated further in-file.</span>
<span class="cm"> *</span>
<span class="cm"> *  2005-03-17	0.11	support for 600e, 770x</span>
<span class="cm"> *			    thanks to Jamie Lentin &lt;lentinj@dial.pipex.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  2005-01-16	0.9	use MODULE_VERSION</span>
<span class="cm"> *			    thanks to Henrik Brix Andersen &lt;brix@gentoo.org&gt;</span>
<span class="cm"> *			fix parameter passing on module loading</span>
<span class="cm"> *			    thanks to Rusty Russell &lt;rusty@rustcorp.com.au&gt;</span>
<span class="cm"> *			    thanks to Jim Radford &lt;radford@blackbean.org&gt;</span>
<span class="cm"> *  2004-11-08	0.8	fix init error case, don&#39;t return from a macro</span>
<span class="cm"> *			    thanks to Chris Wright &lt;chrisw@osdl.org&gt;</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/nvram.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/rfkill.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>

<span class="cp">#include &lt;acpi/acpi_drivers.h&gt;</span>

<span class="cp">#include &lt;linux/pci_ids.h&gt;</span>


<span class="cm">/* ThinkPad CMOS commands */</span>
<span class="cp">#define TP_CMOS_VOLUME_DOWN	0</span>
<span class="cp">#define TP_CMOS_VOLUME_UP	1</span>
<span class="cp">#define TP_CMOS_VOLUME_MUTE	2</span>
<span class="cp">#define TP_CMOS_BRIGHTNESS_UP	4</span>
<span class="cp">#define TP_CMOS_BRIGHTNESS_DOWN	5</span>
<span class="cp">#define TP_CMOS_THINKLIGHT_ON	12</span>
<span class="cp">#define TP_CMOS_THINKLIGHT_OFF	13</span>

<span class="cm">/* NVRAM Addresses */</span>
<span class="k">enum</span> <span class="n">tp_nvram_addr</span> <span class="p">{</span>
	<span class="n">TP_NVRAM_ADDR_HK2</span>		<span class="o">=</span> <span class="mh">0x57</span><span class="p">,</span>
	<span class="n">TP_NVRAM_ADDR_THINKLIGHT</span>	<span class="o">=</span> <span class="mh">0x58</span><span class="p">,</span>
	<span class="n">TP_NVRAM_ADDR_VIDEO</span>		<span class="o">=</span> <span class="mh">0x59</span><span class="p">,</span>
	<span class="n">TP_NVRAM_ADDR_BRIGHTNESS</span>	<span class="o">=</span> <span class="mh">0x5e</span><span class="p">,</span>
	<span class="n">TP_NVRAM_ADDR_MIXER</span>		<span class="o">=</span> <span class="mh">0x60</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* NVRAM bit masks */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TP_NVRAM_MASK_HKT_THINKPAD</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_HKT_ZOOM</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_HKT_DISPLAY</span>	<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_HKT_HIBERNATE</span>	<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_THINKLIGHT</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_HKT_DISPEXPND</span>	<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_HKT_BRIGHTNESS</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_LEVEL_BRIGHTNESS</span>	<span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="n">TP_NVRAM_POS_LEVEL_BRIGHTNESS</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_MUTE</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_HKT_VOLUME</span>	<span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">TP_NVRAM_MASK_LEVEL_VOLUME</span>	<span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span>
	<span class="n">TP_NVRAM_POS_LEVEL_VOLUME</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Misc NVRAM-related */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TP_NVRAM_LEVEL_VOLUME_MAX</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ACPI HIDs */</span>
<span class="cp">#define TPACPI_ACPI_IBM_HKEY_HID	&quot;IBM0068&quot;</span>
<span class="cp">#define TPACPI_ACPI_LENOVO_HKEY_HID	&quot;LEN0068&quot;</span>
<span class="cp">#define TPACPI_ACPI_EC_HID		&quot;PNP0C09&quot;</span>

<span class="cm">/* Input IDs */</span>
<span class="cp">#define TPACPI_HKEY_INPUT_PRODUCT	0x5054 </span><span class="cm">/* &quot;TP&quot; */</span><span class="cp"></span>
<span class="cp">#define TPACPI_HKEY_INPUT_VERSION	0x4101</span>

<span class="cm">/* ACPI \WGSV commands */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TP_ACPI_WGSV_GET_STATE</span>		<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span> <span class="cm">/* Get state information */</span>
	<span class="n">TP_ACPI_WGSV_PWR_ON_ON_RESUME</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span> <span class="cm">/* Resume WWAN powered on */</span>
	<span class="n">TP_ACPI_WGSV_PWR_OFF_ON_RESUME</span>	<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>	<span class="cm">/* Resume WWAN powered off */</span>
	<span class="n">TP_ACPI_WGSV_SAVE_STATE</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span> <span class="cm">/* Save state for S4/S5 */</span>
<span class="p">};</span>

<span class="cm">/* TP_ACPI_WGSV_GET_STATE bits */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TP_ACPI_WGSV_STATE_WWANEXIST</span>	<span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="cm">/* WWAN hw available */</span>
	<span class="n">TP_ACPI_WGSV_STATE_WWANPWR</span>	<span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="cm">/* WWAN radio enabled */</span>
	<span class="n">TP_ACPI_WGSV_STATE_WWANPWRRES</span>	<span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="cm">/* WWAN state at resume */</span>
	<span class="n">TP_ACPI_WGSV_STATE_WWANBIOSOFF</span>	<span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="cm">/* WWAN disabled in BIOS */</span>
	<span class="n">TP_ACPI_WGSV_STATE_BLTHEXIST</span>	<span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="cm">/* BLTH hw available */</span>
	<span class="n">TP_ACPI_WGSV_STATE_BLTHPWR</span>	<span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="cm">/* BLTH radio enabled */</span>
	<span class="n">TP_ACPI_WGSV_STATE_BLTHPWRRES</span>	<span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="cm">/* BLTH state at resume */</span>
	<span class="n">TP_ACPI_WGSV_STATE_BLTHBIOSOFF</span>	<span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="cm">/* BLTH disabled in BIOS */</span>
	<span class="n">TP_ACPI_WGSV_STATE_UWBEXIST</span>	<span class="o">=</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="cm">/* UWB hw available */</span>
	<span class="n">TP_ACPI_WGSV_STATE_UWBPWR</span>	<span class="o">=</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="cm">/* UWB radio enabled */</span>
<span class="p">};</span>

<span class="cm">/* HKEY events */</span>
<span class="k">enum</span> <span class="n">tpacpi_hkey_event_t</span> <span class="p">{</span>
	<span class="cm">/* Hotkey-related */</span>
	<span class="n">TP_HKEY_EV_HOTKEY_BASE</span>		<span class="o">=</span> <span class="mh">0x1001</span><span class="p">,</span> <span class="cm">/* first hotkey (FN+F1) */</span>
	<span class="n">TP_HKEY_EV_BRGHT_UP</span>		<span class="o">=</span> <span class="mh">0x1010</span><span class="p">,</span> <span class="cm">/* Brightness up */</span>
	<span class="n">TP_HKEY_EV_BRGHT_DOWN</span>		<span class="o">=</span> <span class="mh">0x1011</span><span class="p">,</span> <span class="cm">/* Brightness down */</span>
	<span class="n">TP_HKEY_EV_VOL_UP</span>		<span class="o">=</span> <span class="mh">0x1015</span><span class="p">,</span> <span class="cm">/* Volume up or unmute */</span>
	<span class="n">TP_HKEY_EV_VOL_DOWN</span>		<span class="o">=</span> <span class="mh">0x1016</span><span class="p">,</span> <span class="cm">/* Volume down or unmute */</span>
	<span class="n">TP_HKEY_EV_VOL_MUTE</span>		<span class="o">=</span> <span class="mh">0x1017</span><span class="p">,</span> <span class="cm">/* Mixer output mute */</span>

	<span class="cm">/* Reasons for waking up from S3/S4 */</span>
	<span class="n">TP_HKEY_EV_WKUP_S3_UNDOCK</span>	<span class="o">=</span> <span class="mh">0x2304</span><span class="p">,</span> <span class="cm">/* undock requested, S3 */</span>
	<span class="n">TP_HKEY_EV_WKUP_S4_UNDOCK</span>	<span class="o">=</span> <span class="mh">0x2404</span><span class="p">,</span> <span class="cm">/* undock requested, S4 */</span>
	<span class="n">TP_HKEY_EV_WKUP_S3_BAYEJ</span>	<span class="o">=</span> <span class="mh">0x2305</span><span class="p">,</span> <span class="cm">/* bay ejection req, S3 */</span>
	<span class="n">TP_HKEY_EV_WKUP_S4_BAYEJ</span>	<span class="o">=</span> <span class="mh">0x2405</span><span class="p">,</span> <span class="cm">/* bay ejection req, S4 */</span>
	<span class="n">TP_HKEY_EV_WKUP_S3_BATLOW</span>	<span class="o">=</span> <span class="mh">0x2313</span><span class="p">,</span> <span class="cm">/* battery empty, S3 */</span>
	<span class="n">TP_HKEY_EV_WKUP_S4_BATLOW</span>	<span class="o">=</span> <span class="mh">0x2413</span><span class="p">,</span> <span class="cm">/* battery empty, S4 */</span>

	<span class="cm">/* Auto-sleep after eject request */</span>
	<span class="n">TP_HKEY_EV_BAYEJ_ACK</span>		<span class="o">=</span> <span class="mh">0x3003</span><span class="p">,</span> <span class="cm">/* bay ejection complete */</span>
	<span class="n">TP_HKEY_EV_UNDOCK_ACK</span>		<span class="o">=</span> <span class="mh">0x4003</span><span class="p">,</span> <span class="cm">/* undock complete */</span>

	<span class="cm">/* Misc bay events */</span>
	<span class="n">TP_HKEY_EV_OPTDRV_EJ</span>		<span class="o">=</span> <span class="mh">0x3006</span><span class="p">,</span> <span class="cm">/* opt. drive tray ejected */</span>
	<span class="n">TP_HKEY_EV_HOTPLUG_DOCK</span>		<span class="o">=</span> <span class="mh">0x4010</span><span class="p">,</span> <span class="cm">/* docked into hotplug dock</span>
<span class="cm">						     or port replicator */</span>
	<span class="n">TP_HKEY_EV_HOTPLUG_UNDOCK</span>	<span class="o">=</span> <span class="mh">0x4011</span><span class="p">,</span> <span class="cm">/* undocked from hotplug</span>
<span class="cm">						     dock or port replicator */</span>

	<span class="cm">/* User-interface events */</span>
	<span class="n">TP_HKEY_EV_LID_CLOSE</span>		<span class="o">=</span> <span class="mh">0x5001</span><span class="p">,</span> <span class="cm">/* laptop lid closed */</span>
	<span class="n">TP_HKEY_EV_LID_OPEN</span>		<span class="o">=</span> <span class="mh">0x5002</span><span class="p">,</span> <span class="cm">/* laptop lid opened */</span>
	<span class="n">TP_HKEY_EV_TABLET_TABLET</span>	<span class="o">=</span> <span class="mh">0x5009</span><span class="p">,</span> <span class="cm">/* tablet swivel up */</span>
	<span class="n">TP_HKEY_EV_TABLET_NOTEBOOK</span>	<span class="o">=</span> <span class="mh">0x500a</span><span class="p">,</span> <span class="cm">/* tablet swivel down */</span>
	<span class="n">TP_HKEY_EV_PEN_INSERTED</span>		<span class="o">=</span> <span class="mh">0x500b</span><span class="p">,</span> <span class="cm">/* tablet pen inserted */</span>
	<span class="n">TP_HKEY_EV_PEN_REMOVED</span>		<span class="o">=</span> <span class="mh">0x500c</span><span class="p">,</span> <span class="cm">/* tablet pen removed */</span>
	<span class="n">TP_HKEY_EV_BRGHT_CHANGED</span>	<span class="o">=</span> <span class="mh">0x5010</span><span class="p">,</span> <span class="cm">/* backlight control event */</span>

	<span class="cm">/* Key-related user-interface events */</span>
	<span class="n">TP_HKEY_EV_KEY_NUMLOCK</span>		<span class="o">=</span> <span class="mh">0x6000</span><span class="p">,</span> <span class="cm">/* NumLock key pressed */</span>
	<span class="n">TP_HKEY_EV_KEY_FN</span>		<span class="o">=</span> <span class="mh">0x6005</span><span class="p">,</span> <span class="cm">/* Fn key pressed? E420 */</span>

	<span class="cm">/* Thermal events */</span>
	<span class="n">TP_HKEY_EV_ALARM_BAT_HOT</span>	<span class="o">=</span> <span class="mh">0x6011</span><span class="p">,</span> <span class="cm">/* battery too hot */</span>
	<span class="n">TP_HKEY_EV_ALARM_BAT_XHOT</span>	<span class="o">=</span> <span class="mh">0x6012</span><span class="p">,</span> <span class="cm">/* battery critically hot */</span>
	<span class="n">TP_HKEY_EV_ALARM_SENSOR_HOT</span>	<span class="o">=</span> <span class="mh">0x6021</span><span class="p">,</span> <span class="cm">/* sensor too hot */</span>
	<span class="n">TP_HKEY_EV_ALARM_SENSOR_XHOT</span>	<span class="o">=</span> <span class="mh">0x6022</span><span class="p">,</span> <span class="cm">/* sensor critically hot */</span>
	<span class="n">TP_HKEY_EV_THM_TABLE_CHANGED</span>	<span class="o">=</span> <span class="mh">0x6030</span><span class="p">,</span> <span class="cm">/* thermal table changed */</span>

	<span class="n">TP_HKEY_EV_UNK_6040</span>		<span class="o">=</span> <span class="mh">0x6040</span><span class="p">,</span> <span class="cm">/* Related to AC change?</span>
<span class="cm">						     some sort of APM hint,</span>
<span class="cm">						     W520 */</span>

	<span class="cm">/* Misc */</span>
	<span class="n">TP_HKEY_EV_RFKILL_CHANGED</span>	<span class="o">=</span> <span class="mh">0x7000</span><span class="p">,</span> <span class="cm">/* rfkill switch changed */</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> * Main driver</span>
<span class="cm"> */</span>

<span class="cp">#define TPACPI_NAME &quot;thinkpad&quot;</span>
<span class="cp">#define TPACPI_DESC &quot;ThinkPad ACPI Extras&quot;</span>
<span class="cp">#define TPACPI_FILE TPACPI_NAME &quot;_acpi&quot;</span>
<span class="cp">#define TPACPI_URL &quot;http:</span><span class="c1">//ibm-acpi.sf.net/&quot;</span>
<span class="cp">#define TPACPI_MAIL &quot;ibm-acpi-devel@lists.sourceforge.net&quot;</span>

<span class="cp">#define TPACPI_PROC_DIR &quot;ibm&quot;</span>
<span class="cp">#define TPACPI_ACPI_EVENT_PREFIX &quot;ibm&quot;</span>
<span class="cp">#define TPACPI_DRVR_NAME TPACPI_FILE</span>
<span class="cp">#define TPACPI_DRVR_SHORTNAME &quot;tpacpi&quot;</span>
<span class="cp">#define TPACPI_HWMON_DRVR_NAME TPACPI_NAME &quot;_hwmon&quot;</span>

<span class="cp">#define TPACPI_NVRAM_KTHREAD_NAME &quot;ktpacpi_nvramd&quot;</span>
<span class="cp">#define TPACPI_WORKQUEUE_NAME &quot;ktpacpid&quot;</span>

<span class="cp">#define TPACPI_MAX_ACPI_ARGS 3</span>

<span class="cm">/* Debugging printk groups */</span>
<span class="cp">#define TPACPI_DBG_ALL		0xffff</span>
<span class="cp">#define TPACPI_DBG_DISCLOSETASK	0x8000</span>
<span class="cp">#define TPACPI_DBG_INIT		0x0001</span>
<span class="cp">#define TPACPI_DBG_EXIT		0x0002</span>
<span class="cp">#define TPACPI_DBG_RFKILL	0x0004</span>
<span class="cp">#define TPACPI_DBG_HKEY		0x0008</span>
<span class="cp">#define TPACPI_DBG_FAN		0x0010</span>
<span class="cp">#define TPACPI_DBG_BRGHT	0x0020</span>
<span class="cp">#define TPACPI_DBG_MIXER	0x0040</span>

<span class="cp">#define onoff(status, bit) ((status) &amp; (1 &lt;&lt; (bit)) ? &quot;on&quot; : &quot;off&quot;)</span>
<span class="cp">#define enabled(status, bit) ((status) &amp; (1 &lt;&lt; (bit)) ? &quot;enabled&quot; : &quot;disabled&quot;)</span>
<span class="cp">#define strlencmp(a, b) (strncmp((a), (b), strlen(b)))</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> * Driver-wide structs and misc. variables</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ibm_struct</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">tp_acpi_drv_struct</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="o">*</span><span class="n">hid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">notify</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
	<span class="n">acpi_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">exit</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">resume</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">suspend</span><span class="p">)</span> <span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">shutdown</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">all_drivers</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tp_acpi_drv_struct</span> <span class="o">*</span><span class="n">acpi</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">acpi_driver_registered</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">acpi_notify_installed</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">proc_created</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">init_called</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">experimental</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">param</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">umode_t</span> <span class="n">base_procfs_mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">bluetooth</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotkey</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotkey_mask</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotkey_wlsw</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotkey_tablet</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">light</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">light_status</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bright_acpimode</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bright_unkfw</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wan</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uwb</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fan_ctrl_status_undef</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">second_fan</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">beep_needs_two_args</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mixer_no_level_control</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">input_device_registered</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">platform_drv_registered</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">platform_drv_attrs_registered</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sensors_pdrv_registered</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sensors_pdrv_attrs_registered</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sensors_pdev_attrs_registered</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hotkey_poll_active</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tp_features</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">hotkey_mask_ff</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">volume_ctrl_forbidden</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tp_warned</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">thinkpad_id_data</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vendor</span><span class="p">;</span>	<span class="cm">/* ThinkPad vendor:</span>
<span class="cm">				 * PCI_VENDOR_ID_IBM/PCI_VENDOR_ID_LENOVO */</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">bios_version_str</span><span class="p">;</span>	<span class="cm">/* Something like 1ZET51WW (1.03z) */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ec_version_str</span><span class="p">;</span>	<span class="cm">/* Something like 1ZHT51WW-1.04a */</span>

	<span class="n">u16</span> <span class="n">bios_model</span><span class="p">;</span>		<span class="cm">/* 1Y = 0x5931, 0 = unknown */</span>
	<span class="n">u16</span> <span class="n">ec_model</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bios_release</span><span class="p">;</span>	<span class="cm">/* 1ZETK1WW = 0x314b, 0 = unknown */</span>
	<span class="n">u16</span> <span class="n">ec_release</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">model_str</span><span class="p">;</span>	<span class="cm">/* ThinkPad T43 */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">nummodel_str</span><span class="p">;</span>	<span class="cm">/* 9384A9C for a 9384-A9C model */</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">thinkpad_id_data</span> <span class="n">thinkpad_id</span><span class="p">;</span>

<span class="k">static</span> <span class="k">enum</span> <span class="p">{</span>
	<span class="n">TPACPI_LIFE_INIT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TPACPI_LIFE_RUNNING</span><span class="p">,</span>
	<span class="n">TPACPI_LIFE_EXITING</span><span class="p">,</span>
<span class="p">}</span> <span class="n">tpacpi_lifecycle</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">experimental</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">dbg_level</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">tpacpi_wq</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">led_status_t</span> <span class="p">{</span>
	<span class="n">TPACPI_LED_OFF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TPACPI_LED_ON</span><span class="p">,</span>
	<span class="n">TPACPI_LED_BLINK</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Special LED class that can defer work */</span>
<span class="k">struct</span> <span class="n">tpacpi_led_classdev</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">led_classdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">led_status_t</span> <span class="n">new_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* brightness level capabilities */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bright_maxlvl</span><span class="p">;</span>	<span class="cm">/* 0 = unknown */</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dbg_wlswemul</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">tpacpi_wlsw_emulstate</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dbg_bluetoothemul</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">tpacpi_bluetooth_emulstate</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dbg_wwanemul</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">tpacpi_wwan_emulstate</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dbg_uwbemul</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">tpacpi_uwb_emulstate</span><span class="p">;</span>
<span class="cp">#endif</span>


<span class="cm">/*************************************************************************</span>
<span class="cm"> *  Debugging helpers</span>
<span class="cm"> */</span>

<span class="cp">#define dbg_printk(a_dbg_level, format, arg...)				\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (dbg_level &amp; (a_dbg_level))					\</span>
<span class="cp">		printk(KERN_DEBUG pr_fmt(&quot;%s: &quot; format),		\</span>
<span class="cp">		       __func__, ##arg);				\</span>
<span class="cp">} while (0)</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUG</span>
<span class="cp">#define vdbg_printk dbg_printk</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_supported</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_supported</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">str_supported</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_supported</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#define vdbg_printk(a_dbg_level, format, arg...)	\</span>
<span class="cp">	no_printk(format, ##arg)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_log_usertask</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">pr_fmt</span><span class="p">(</span><span class="s">&quot;%s: access by process with PID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">),</span>
	       <span class="n">what</span><span class="p">,</span> <span class="n">task_tgid_vnr</span><span class="p">(</span><span class="n">current</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define tpacpi_disclose_usertask(what, format, arg...)			\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (unlikely((dbg_level &amp; TPACPI_DBG_DISCLOSETASK) &amp;&amp;		\</span>
<span class="cp">		     (tpacpi_lifecycle == TPACPI_LIFE_RUNNING))) {	\</span>
<span class="cp">		printk(KERN_DEBUG pr_fmt(&quot;%s: PID %d: &quot; format),	\</span>
<span class="cp">		       what, task_tgid_vnr(current), ## arg);		\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * Quirk handling helpers</span>
<span class="cm"> *</span>
<span class="cm"> * ThinkPad IDs and versions seen in the field so far</span>
<span class="cm"> * are two-characters from the set [0-9A-Z], i.e. base 36.</span>
<span class="cm"> *</span>
<span class="cm"> * We use values well outside that range as specials.</span>
<span class="cm"> */</span>

<span class="cp">#define TPACPI_MATCH_ANY		0xffffU</span>
<span class="cp">#define TPACPI_MATCH_UNKNOWN		0U</span>

<span class="cm">/* TPID(&#39;1&#39;, &#39;Y&#39;) == 0x5931 */</span>
<span class="cp">#define TPID(__c1, __c2) (((__c2) &lt;&lt; 8) | (__c1))</span>

<span class="cp">#define TPACPI_Q_IBM(__id1, __id2, __quirk)	\</span>
<span class="cp">	{ .vendor = PCI_VENDOR_ID_IBM,		\</span>
<span class="cp">	  .bios = TPID(__id1, __id2),		\</span>
<span class="cp">	  .ec = TPACPI_MATCH_ANY,		\</span>
<span class="cp">	  .quirks = (__quirk) }</span>

<span class="cp">#define TPACPI_Q_LNV(__id1, __id2, __quirk)	\</span>
<span class="cp">	{ .vendor = PCI_VENDOR_ID_LENOVO,	\</span>
<span class="cp">	  .bios = TPID(__id1, __id2),		\</span>
<span class="cp">	  .ec = TPACPI_MATCH_ANY,		\</span>
<span class="cp">	  .quirks = (__quirk) }</span>

<span class="cp">#define TPACPI_QEC_LNV(__id1, __id2, __quirk)	\</span>
<span class="cp">	{ .vendor = PCI_VENDOR_ID_LENOVO,	\</span>
<span class="cp">	  .bios = TPACPI_MATCH_ANY,		\</span>
<span class="cp">	  .ec = TPID(__id1, __id2),		\</span>
<span class="cp">	  .quirks = (__quirk) }</span>

<span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vendor</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bios</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ec</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">quirks</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * tpacpi_check_quirks() - search BIOS/EC version on a list</span>
<span class="cm"> * @qlist:		array of &amp;struct tpacpi_quirk</span>
<span class="cm"> * @qlist_size:		number of elements in @qlist</span>
<span class="cm"> *</span>
<span class="cm"> * Iterates over a quirks list until one is found that matches the</span>
<span class="cm"> * ThinkPad&#39;s vendor, BIOS and EC model.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if nothing matches, otherwise returns the quirks field of</span>
<span class="cm"> * the matching &amp;struct tpacpi_quirk entry.</span>
<span class="cm"> *</span>
<span class="cm"> * The match criteria is: vendor, ec and bios much match.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__init</span> <span class="nf">tpacpi_check_quirks</span><span class="p">(</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="o">*</span><span class="n">qlist</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">qlist_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">qlist_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">qlist</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">thinkpad_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">||</span>
				<span class="n">qlist</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">qlist</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">==</span> <span class="n">thinkpad_id</span><span class="p">.</span><span class="n">bios_model</span> <span class="o">||</span>
				<span class="n">qlist</span><span class="o">-&gt;</span><span class="n">bios</span> <span class="o">==</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">qlist</span><span class="o">-&gt;</span><span class="n">ec</span> <span class="o">==</span> <span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_model</span> <span class="o">||</span>
				<span class="n">qlist</span><span class="o">-&gt;</span><span class="n">ec</span> <span class="o">==</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">qlist</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="p">;</span>

		<span class="n">qlist_size</span><span class="o">--</span><span class="p">;</span>
		<span class="n">qlist</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="n">__pure</span> <span class="n">__init</span> <span class="nf">tpacpi_is_lenovo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">thinkpad_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_LENOVO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="n">__pure</span> <span class="n">__init</span> <span class="nf">tpacpi_is_ibm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">thinkpad_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * ACPI Helpers and device model</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * ACPI basic handles</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">acpi_handle</span> <span class="n">root_handle</span><span class="p">;</span>
<span class="k">static</span> <span class="n">acpi_handle</span> <span class="n">ec_handle</span><span class="p">;</span>

<span class="cp">#define TPACPI_HANDLE(object, parent, paths...)			\</span>
<span class="cp">	static acpi_handle  object##_handle;			\</span>
<span class="cp">	static const acpi_handle *object##_parent __initdata =	\</span>
<span class="cp">						&amp;parent##_handle; \</span>
<span class="cp">	static char *object##_paths[] __initdata = { paths }</span>

<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">ecrd</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="s">&quot;ECRD&quot;</span><span class="p">);</span>	<span class="cm">/* 570 */</span>
<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">ecwr</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="s">&quot;ECWR&quot;</span><span class="p">);</span>	<span class="cm">/* 570 */</span>

<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">cmos</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">UCMS&quot;</span><span class="p">,</span>	<span class="cm">/* R50, R50e, R50p, R51, */</span>
					<span class="cm">/* T4x, X31, X40 */</span>
	   <span class="s">&quot;</span><span class="se">\\</span><span class="s">CMOS&quot;</span><span class="p">,</span>		<span class="cm">/* A3x, G4x, R32, T23, T30, X22-24, X30 */</span>
	   <span class="s">&quot;</span><span class="se">\\</span><span class="s">CMS&quot;</span><span class="p">,</span>		<span class="cm">/* R40, R40e */</span>
	   <span class="p">);</span>			<span class="cm">/* all others */</span>

<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">hkey</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.HKEY&quot;</span><span class="p">,</span>	<span class="cm">/* 600e/x, 770e, 770x */</span>
	   <span class="s">&quot;^HKEY&quot;</span><span class="p">,</span>		<span class="cm">/* R30, R31 */</span>
	   <span class="s">&quot;HKEY&quot;</span><span class="p">,</span>		<span class="cm">/* all others */</span>
	   <span class="p">);</span>			<span class="cm">/* 570 */</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * ACPI helpers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_evalf</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fmt0</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">in_objs</span><span class="p">[</span><span class="n">TPACPI_MAX_ACPI_ARGS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">result</span><span class="p">,</span> <span class="o">*</span><span class="n">resultp</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">out_obj</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">res_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">success</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">quiet</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;acpi_evalf() called with empty format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span> <span class="o">==</span> <span class="sc">&#39;q&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">quiet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">quiet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res_type</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">fmt</span><span class="o">++</span><span class="p">);</span>

	<span class="n">params</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_objs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">fmt</span><span class="o">++</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:	<span class="cm">/* int */</span>
			<span class="n">in_objs</span><span class="p">[</span><span class="n">params</span><span class="p">.</span><span class="n">count</span><span class="p">].</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
			<span class="n">in_objs</span><span class="p">[</span><span class="n">params</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* add more types as needed */</span>
		<span class="nl">default:</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;acpi_evalf() called &quot;</span>
			       <span class="s">&quot;with invalid format character &#39;%c&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
			<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_type</span> <span class="o">!=</span> <span class="sc">&#39;v&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out_obj</span><span class="p">);</span>
		<span class="n">result</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">out_obj</span><span class="p">;</span>
		<span class="n">resultp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">resultp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="n">resultp</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">res_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:		<span class="cm">/* int */</span>
		<span class="n">success</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">AE_OK</span> <span class="o">&amp;&amp;</span>
			   <span class="n">out_obj</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="n">res</span><span class="p">)</span>
			<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">res</span> <span class="o">=</span> <span class="n">out_obj</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;v&#39;</span>:		<span class="cm">/* void */</span>
		<span class="n">success</span> <span class="o">=</span> <span class="n">status</span> <span class="o">==</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* add more types as needed */</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;acpi_evalf() called &quot;</span>
		       <span class="s">&quot;with invalid format character &#39;%c&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">quiet</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;acpi_evalf(%s, %s, ...) failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">method</span><span class="p">,</span> <span class="n">fmt0</span><span class="p">,</span> <span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">success</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_ec_read</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ecrd_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ecrd_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;dd&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ec_read</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_ec_write</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">u8</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecwr_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ecwr_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vdd&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ec_write</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">issue_thinkpad_cmos_command</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmos_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmos_handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">cmos_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="n">cmos_cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * ACPI device model</span>
<span class="cm"> */</span>

<span class="cp">#define TPACPI_ACPIHANDLE_INIT(object) \</span>
<span class="cp">	drv_acpi_handle_init(#object, &amp;object##_handle, *object##_parent, \</span>
<span class="cp">		object##_paths, ARRAY_SIZE(object##_paths))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">drv_acpi_handle_init</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			   <span class="n">acpi_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="k">const</span> <span class="n">acpi_handle</span> <span class="n">parent</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">**</span><span class="n">paths</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">num_paths</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;trying to locate ACPI handle for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">name</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_paths</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
				   <span class="s">&quot;Found ACPI handle %s for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">paths</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;ACPI handle for %s not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">name</span><span class="p">);</span>
	<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="n">__init</span> <span class="nf">tpacpi_acpi_handle_locate_callback</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">level</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">return_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="o">*</span><span class="p">)</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">AE_CTRL_TERMINATE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">tpacpi_acpi_handle_locate</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">hid</span><span class="p">,</span>
		<span class="n">acpi_handle</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">device_found</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">name</span> <span class="o">||</span> <span class="o">!</span><span class="n">hid</span> <span class="o">||</span> <span class="o">!</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
			<span class="s">&quot;trying to locate ACPI handle for %s, using HID %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span> <span class="n">hid</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device_found</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">device_found</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_devices</span><span class="p">(</span><span class="n">hid</span><span class="p">,</span> <span class="n">tpacpi_acpi_handle_locate_callback</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_found</span><span class="p">);</span>

	<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">device_found</span><span class="p">;</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
			   <span class="s">&quot;Found ACPI handle for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
			    <span class="s">&quot;Could not locate an ACPI handle for %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">name</span><span class="p">,</span> <span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dispatch_acpi_notify</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_lifecycle</span> <span class="o">!=</span> <span class="n">TPACPI_LIFE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibm</span> <span class="o">||</span> <span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span> <span class="o">||</span> <span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">setup_acpi_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
		<span class="s">&quot;setting up ACPI notify for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">acpi_bus_get_device</span><span class="p">(</span><span class="o">*</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;acpi_bus_get_device(%s) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">ibm</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">acpi_device_class</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">),</span> <span class="s">&quot;%s/%s&quot;</span><span class="p">,</span>
		<span class="n">TPACPI_ACPI_EVENT_PREFIX</span><span class="p">,</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_install_notify_handler</span><span class="p">(</span><span class="o">*</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
			<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">dispatch_acpi_notify</span><span class="p">,</span> <span class="n">ibm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">AE_ALREADY_EXISTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;another device driver is already &quot;</span>
				  <span class="s">&quot;handling %s events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;acpi_install_notify_handler(%s) failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">acpi_format_exception</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">acpi_notify_installed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tpacpi_device_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">register_tpacpi_subdriver</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
		<span class="s">&quot;registering %s as an ACPI driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="p">);</span>

	<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_driver</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to allocate memory for ibm-&gt;acpi-&gt;driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s_%s&quot;</span><span class="p">,</span> <span class="n">TPACPI_NAME</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ids</span> <span class="o">=</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">;</span>

	<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">add</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpacpi_device_add</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">acpi_bus_register_driver</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;acpi_bus_register_driver(%s) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">acpi_driver_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Procfs Helpers</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dispatch_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibm</span> <span class="o">||</span> <span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dispatch_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">dispatch_proc_show</span><span class="p">,</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">dispatch_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userbuf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">kernbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibm</span> <span class="o">||</span> <span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">kernbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kernbuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">kernbuf</span><span class="p">,</span> <span class="n">userbuf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">kernbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kernbuf</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">kernbuf</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">kernbuf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">kernbuf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">dispatch_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">dispatch_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">dispatch_proc_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">next_cmd</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">cmds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="o">*</span><span class="n">cmds</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">end</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="sc">&#39;,&#39;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">end</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">end</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">cmds</span> <span class="o">=</span> <span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/****************************************************************************</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Device model: input, hwmon and platform</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> ****************************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">tpacpi_pdev</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">tpacpi_sensors_pdev</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">tpacpi_hwmon</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">tpacpi_inputdev</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">tpacpi_inputdev_send_mutex</span><span class="p">;</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">tpacpi_all_drivers</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_suspend_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span><span class="p">,</span> <span class="o">*</span><span class="n">itmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="n">itmp</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">tpacpi_all_drivers</span><span class="p">,</span>
				 <span class="n">all_drivers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
			<span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)(</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_resume_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span><span class="p">,</span> <span class="o">*</span><span class="n">itmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="n">itmp</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">tpacpi_all_drivers</span><span class="p">,</span>
				 <span class="n">all_drivers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
			<span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_shutdown_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span><span class="p">,</span> <span class="o">*</span><span class="n">itmp</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="n">itmp</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">tpacpi_all_drivers</span><span class="p">,</span>
				 <span class="n">all_drivers</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
			<span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">tpacpi_pdriver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TPACPI_DRVR_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">tpacpi_suspend_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">tpacpi_resume_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">tpacpi_shutdown_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">tpacpi_hwmon_pdriver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">TPACPI_HWMON_DRVR_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * sysfs support helpers</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">attribute_set</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">members</span><span class="p">,</span> <span class="n">max_members</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">group</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">attribute_set_obj</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute_set</span> <span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">a</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_set</span> <span class="o">*</span><span class="nf">create_attr_set</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_members</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">attribute_set_obj</span> <span class="o">*</span><span class="n">sobj</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_members</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Allocates space for implicit NULL at the end too */</span>
	<span class="n">sobj</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute_set_obj</span><span class="p">)</span> <span class="o">+</span>
		    <span class="n">max_members</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="p">),</span>
		    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sobj</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sobj</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">max_members</span> <span class="o">=</span> <span class="n">max_members</span><span class="p">;</span>
	<span class="n">sobj</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">group</span><span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sobj</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">;</span>
	<span class="n">sobj</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">group</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">sobj</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define destroy_attr_set(_set) \</span>
<span class="cp">	kfree(_set);</span>

<span class="cm">/* not multi-threaded safe, use it in a single thread per set */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_to_attr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute_set</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span> <span class="o">||</span> <span class="o">!</span><span class="n">attr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">members</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">max_members</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">members</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">members</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_many_to_attr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute_set</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">attribute</span> <span class="o">**</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">add_to_attr_set</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">attr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_attr_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">attribute_set</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">);</span>
	<span class="n">destroy_attr_set</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define register_attr_set_with_sysfs(_attr_set, _kobj) \</span>
<span class="cp">	sysfs_create_group(_kobj, &amp;_attr_set-&gt;group)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_strtoul</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">endp</span><span class="p">;</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">skip_spaces</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">endp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">endp</span> <span class="o">=</span> <span class="n">skip_spaces</span><span class="p">(</span><span class="n">endp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">endp</span> <span class="o">||</span> <span class="o">*</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_disable_brightness_delay</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;PWMS&quot;</span><span class="p">,</span> <span class="s">&quot;qvd&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;ACPI backlight control delay disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">printk_deprecated_attribute</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">what</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">details</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_log_usertask</span><span class="p">(</span><span class="s">&quot;deprecated sysfs attribute&quot;</span><span class="p">);</span>
	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;WARNING: sysfs attribute %s is deprecated and &quot;</span>
		<span class="s">&quot;will be removed. %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">what</span><span class="p">,</span> <span class="n">details</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * rfkill and radio control support helpers</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ThinkPad-ACPI firmware handling model:</span>
<span class="cm"> *</span>
<span class="cm"> * WLSW (master wireless switch) is event-driven, and is common to all</span>
<span class="cm"> * firmware-controlled radios.  It cannot be controlled, just monitored,</span>
<span class="cm"> * as expected.  It overrides all radio state in firmware</span>
<span class="cm"> *</span>
<span class="cm"> * The kernel, a masked-off hotkey, and WLSW can change the radio state</span>
<span class="cm"> * (TODO: verify how WLSW interacts with the returned radio state).</span>
<span class="cm"> *</span>
<span class="cm"> * The only time there are shadow radio state changes, is when</span>
<span class="cm"> * masked-off hotkeys are used.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Internal driver API for radio state:</span>
<span class="cm"> *</span>
<span class="cm"> * int: &lt; 0 = error, otherwise enum tpacpi_rfkill_state</span>
<span class="cm"> * bool: true means radio blocked (off)</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">tpacpi_rfkill_state</span> <span class="p">{</span>
	<span class="n">TPACPI_RFK_RADIO_OFF</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TPACPI_RFK_RADIO_ON</span>
<span class="p">};</span>

<span class="cm">/* rfkill switches */</span>
<span class="k">enum</span> <span class="n">tpacpi_rfk_id</span> <span class="p">{</span>
	<span class="n">TPACPI_RFK_BLUETOOTH_SW_ID</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TPACPI_RFK_WWAN_SW_ID</span><span class="p">,</span>
	<span class="n">TPACPI_RFK_UWB_SW_ID</span><span class="p">,</span>
	<span class="n">TPACPI_RFK_SW_MAX</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tpacpi_rfkill_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">TPACPI_RFK_BLUETOOTH_SW_ID</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;bluetooth&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TPACPI_RFK_WWAN_SW_ID</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;wwan&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TPACPI_RFK_UWB_SW_ID</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;uwb&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">TPACPI_RFK_SW_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/* ThinkPad-ACPI rfkill subdriver */</span>
<span class="k">struct</span> <span class="n">tpacpi_rfk</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfkill</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">tpacpi_rfk_id</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_rfk_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">tpacpi_rfk_ops</span> <span class="p">{</span>
	<span class="cm">/* firmware interface */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_status</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_status</span><span class="p">)(</span><span class="k">const</span> <span class="k">enum</span> <span class="n">tpacpi_rfkill_state</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tpacpi_rfk</span> <span class="o">*</span><span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">TPACPI_RFK_SW_MAX</span><span class="p">];</span>

<span class="cm">/* Query FW and update rfkill sw state for a given rfkill switch */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_rfk_update_swstate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_rfk</span> <span class="o">*</span><span class="n">tp_rfk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_rfk</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp_rfk</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_status</span><span class="p">)();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">tp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Query FW and update rfkill sw state for all rfkill switches */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_rfk_update_swstate_all</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPACPI_RFK_SW_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tpacpi_rfk_update_swstate</span><span class="p">(</span><span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sync the HW-blocking state of all rfkill switches,</span>
<span class="cm"> * do notice it causes the rfkill core to schedule uevents</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_rfk_update_hwblock_state</span><span class="p">(</span><span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacpi_rfk</span> <span class="o">*</span><span class="n">tp_rfk</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPACPI_RFK_SW_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp_rfk</span> <span class="o">=</span> <span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp_rfk</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rfkill_set_hw_state</span><span class="p">(</span><span class="n">tp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">,</span>
						<span class="n">blocked</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* ignore -- we track sw block */</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Call to get the WLSW state from the firmware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hotkey_get_wlsw</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* Call to query WLSW state and update all rfkill switches */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">tpacpi_rfk_check_hwblock_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_get_wlsw</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">hw_blocked</span><span class="p">;</span>

	<span class="cm">/* When unknown or unsupported, we have to assume it is unblocked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">hw_blocked</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">);</span>
	<span class="n">tpacpi_rfk_update_hwblock_state</span><span class="p">(</span><span class="n">hw_blocked</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hw_blocked</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_rfk_hook_set_block</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacpi_rfk</span> <span class="o">*</span><span class="n">tp_rfk</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
		   <span class="s">&quot;request to change radio state to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">blocked</span> <span class="o">?</span> <span class="s">&quot;blocked&quot;</span> <span class="o">:</span> <span class="s">&quot;unblocked&quot;</span><span class="p">);</span>

	<span class="cm">/* try to set radio state */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp_rfk</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_status</span><span class="p">)(</span><span class="n">blocked</span> <span class="o">?</span>
				<span class="n">TPACPI_RFK_RADIO_OFF</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">);</span>

	<span class="cm">/* and update the rfkill core with whatever the FW really did */</span>
	<span class="n">tpacpi_rfk_update_swstate</span><span class="p">(</span><span class="n">tp_rfk</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">res</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">tpacpi_rfk_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">tpacpi_rfk_hook_set_block</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tpacpi_new_rfkill</span><span class="p">(</span><span class="k">const</span> <span class="k">enum</span> <span class="n">tpacpi_rfk_id</span> <span class="n">id</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_rfk_ops</span> <span class="o">*</span><span class="n">tp_rfkops</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">enum</span> <span class="n">rfkill_type</span> <span class="n">rfktype</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">bool</span> <span class="n">set_default</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacpi_rfk</span> <span class="o">*</span><span class="n">atp_rfk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">sw_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hw_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sw_status</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">TPACPI_RFK_SW_MAX</span> <span class="o">||</span> <span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>

	<span class="n">atp_rfk</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacpi_rfk</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atp_rfk</span><span class="p">)</span>
		<span class="n">atp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">rfktype</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tpacpi_rfk_rfkill_ops</span><span class="p">,</span>
						<span class="n">atp_rfk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atp_rfk</span> <span class="o">||</span> <span class="o">!</span><span class="n">atp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to allocate memory for rfkill class</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">atp_rfk</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atp_rfk</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">atp_rfk</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">tp_rfkops</span><span class="p">;</span>

	<span class="n">sw_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp_rfkops</span><span class="o">-&gt;</span><span class="n">get_status</span><span class="p">)();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sw_status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to read initial state for %s, error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">name</span><span class="p">,</span> <span class="n">sw_status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sw_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">sw_status</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set_default</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* try to keep the initial state, since we ask the</span>
<span class="cm">			 * firmware to preserve it across S5 in NVRAM */</span>
			<span class="n">rfkill_init_sw_state</span><span class="p">(</span><span class="n">atp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">,</span> <span class="n">sw_state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hw_state</span> <span class="o">=</span> <span class="n">tpacpi_rfk_check_hwblock_state</span><span class="p">();</span>
	<span class="n">rfkill_set_hw_state</span><span class="p">(</span><span class="n">atp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">,</span> <span class="n">hw_state</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">atp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to register %s rfkill switch: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">atp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">atp_rfk</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">atp_rfk</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rfkill switch %s: radio is %sblocked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">sw_state</span> <span class="o">||</span> <span class="n">hw_state</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_destroy_rfkill</span><span class="p">(</span><span class="k">const</span> <span class="k">enum</span> <span class="n">tpacpi_rfk_id</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacpi_rfk</span> <span class="o">*</span><span class="n">tp_rfk</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">TPACPI_RFK_SW_MAX</span><span class="p">);</span>

	<span class="n">tp_rfk</span> <span class="o">=</span> <span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_rfk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">tp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">tp_rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tp_rfk</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">printk_deprecated_rfkill_attribute</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">what</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk_deprecated_attribute</span><span class="p">(</span><span class="n">what</span><span class="p">,</span>
			<span class="s">&quot;Please switch to generic rfkill before year 2010&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sysfs &lt;radio&gt; enable ------------------------------------------------ */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_rfk_sysfs_enable_show</span><span class="p">(</span><span class="k">const</span> <span class="k">enum</span> <span class="n">tpacpi_rfk_id</span> <span class="n">id</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">printk_deprecated_rfkill_attribute</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* This is in the ABI... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_rfk_check_hwblock_state</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">tpacpi_rfk_update_swstate</span><span class="p">(</span><span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_rfk_sysfs_enable_store</span><span class="p">(</span><span class="k">const</span> <span class="k">enum</span> <span class="n">tpacpi_rfk_id</span> <span class="n">id</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">printk_deprecated_rfkill_attribute</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="n">attr</span><span class="o">-&gt;</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;set to %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="cm">/* This is in the ABI... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_rfk_check_hwblock_state</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_status</span><span class="p">((</span><span class="o">!!</span><span class="n">t</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">TPACPI_RFK_RADIO_ON</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">);</span>
	<span class="n">tpacpi_rfk_update_swstate</span><span class="p">(</span><span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">res</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* procfs -------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_rfk_procfs_read</span><span class="p">(</span><span class="k">const</span> <span class="k">enum</span> <span class="n">tpacpi_rfk_id</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">TPACPI_RFK_SW_MAX</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

		<span class="cm">/* This is in the ABI... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_rfk_check_hwblock_state</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">tpacpi_rfk_update_swstate</span><span class="p">(</span>
						<span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span> <span class="o">?</span>
					<span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">enable, disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_rfk_procfs_write</span><span class="p">(</span><span class="k">const</span> <span class="k">enum</span> <span class="n">tpacpi_rfk_id</span> <span class="n">id</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">TPACPI_RFK_SW_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;enable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs&quot;</span><span class="p">,</span> <span class="s">&quot;attempt to %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span> <span class="o">?</span>
						<span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">,</span>
				<span class="n">tpacpi_rfkill_names</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_status</span><span class="p">)(</span><span class="n">status</span><span class="p">);</span>
		<span class="n">tpacpi_rfk_update_swstate</span><span class="p">(</span><span class="n">tpacpi_rfkill_switches</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * thinkpad-acpi driver attributes</span>
<span class="cm"> */</span>

<span class="cm">/* interface_version --------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_interface_version_show</span><span class="p">(</span>
				<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_SYSFS_VERSION</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">interface_version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">tpacpi_driver_interface_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* debug_level --------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_debug_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dbg_level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_debug_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dbg_level</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">tpacpi_driver_debug_show</span><span class="p">,</span> <span class="n">tpacpi_driver_debug_store</span><span class="p">);</span>

<span class="cm">/* version ------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_version_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s v%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">TPACPI_DESC</span><span class="p">,</span> <span class="n">TPACPI_VERSION</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">tpacpi_driver_version_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>

<span class="cm">/* wlsw_emulstate ------------------------------------------------------ */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_wlsw_emulstate_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="n">tpacpi_wlsw_emulstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_wlsw_emulstate_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_wlsw_emulstate</span> <span class="o">!=</span> <span class="o">!!</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpacpi_wlsw_emulstate</span> <span class="o">=</span> <span class="o">!!</span><span class="n">t</span><span class="p">;</span>
		<span class="n">tpacpi_rfk_update_hwblock_state</span><span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">);</span>	<span class="cm">/* negative logic */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">wlsw_emulstate</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">tpacpi_driver_wlsw_emulstate_show</span><span class="p">,</span>
		<span class="n">tpacpi_driver_wlsw_emulstate_store</span><span class="p">);</span>

<span class="cm">/* bluetooth_emulstate ------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_bluetooth_emulstate_show</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="n">tpacpi_bluetooth_emulstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_bluetooth_emulstate_store</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tpacpi_bluetooth_emulstate</span> <span class="o">=</span> <span class="o">!!</span><span class="n">t</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">bluetooth_emulstate</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">tpacpi_driver_bluetooth_emulstate_show</span><span class="p">,</span>
		<span class="n">tpacpi_driver_bluetooth_emulstate_store</span><span class="p">);</span>

<span class="cm">/* wwan_emulstate ------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_wwan_emulstate_show</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="n">tpacpi_wwan_emulstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_wwan_emulstate_store</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tpacpi_wwan_emulstate</span> <span class="o">=</span> <span class="o">!!</span><span class="n">t</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">wwan_emulstate</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">tpacpi_driver_wwan_emulstate_show</span><span class="p">,</span>
		<span class="n">tpacpi_driver_wwan_emulstate_store</span><span class="p">);</span>

<span class="cm">/* uwb_emulstate ------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_uwb_emulstate_show</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="n">tpacpi_uwb_emulstate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">tpacpi_driver_uwb_emulstate_store</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tpacpi_uwb_emulstate</span> <span class="o">=</span> <span class="o">!!</span><span class="n">t</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">uwb_emulstate</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">tpacpi_driver_uwb_emulstate_show</span><span class="p">,</span>
		<span class="n">tpacpi_driver_uwb_emulstate_store</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">driver_attribute</span> <span class="o">*</span><span class="n">tpacpi_driver_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">driver_attr_debug_level</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_version</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">driver_attr_interface_version</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tpacpi_create_driver_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tpacpi_driver_attributes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="n">tpacpi_driver_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">dbg_wlswemul</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_wlsw_emulstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">dbg_bluetoothemul</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_bluetooth_emulstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">dbg_wwanemul</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_wwan_emulstate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">dbg_uwbemul</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_uwb_emulstate</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_remove_driver_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tpacpi_driver_attributes</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="n">tpacpi_driver_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="cp">#ifdef THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_wlsw_emulstate</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_bluetooth_emulstate</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_wwan_emulstate</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_uwb_emulstate</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Firmware Data</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Table of recommended minimum BIOS versions</span>
<span class="cm"> *</span>
<span class="cm"> * Reasons for listing:</span>
<span class="cm"> *    1. Stable BIOS, listed because the unknown amount of</span>
<span class="cm"> *       bugs and bad ACPI behaviour on older versions</span>
<span class="cm"> *</span>
<span class="cm"> *    2. BIOS or EC fw with known bugs that trigger on Linux</span>
<span class="cm"> *</span>
<span class="cm"> *    3. BIOS with known reduced functionality in older versions</span>
<span class="cm"> *</span>
<span class="cm"> *  We recommend the latest BIOS and EC version.</span>
<span class="cm"> *  We only support the latest BIOS and EC fw version as a rule.</span>
<span class="cm"> *</span>
<span class="cm"> *  Sources: IBM ThinkPad Public Web Documents (update changelogs),</span>
<span class="cm"> *  Information from users in ThinkWiki</span>
<span class="cm"> *</span>
<span class="cm"> *  WARNING: we use this table also to detect that the machine is</span>
<span class="cm"> *  a ThinkPad in some cases, so don&#39;t remove entries lightly.</span>
<span class="cm"> */</span>

<span class="cp">#define TPV_Q(__v, __id1, __id2, __bv1, __bv2)		\</span>
<span class="cp">	{ .vendor	= (__v),			\</span>
<span class="cp">	  .bios		= TPID(__id1, __id2),		\</span>
<span class="cp">	  .ec		= TPACPI_MATCH_ANY,		\</span>
<span class="cp">	  .quirks	= TPACPI_MATCH_ANY &lt;&lt; 16	\</span>
<span class="cp">			  | (__bv1) &lt;&lt; 8 | (__bv2) }</span>

<span class="cp">#define TPV_Q_X(__v, __bid1, __bid2, __bv1, __bv2,	\</span>
<span class="cp">		__eid, __ev1, __ev2)			\</span>
<span class="cp">	{ .vendor	= (__v),			\</span>
<span class="cp">	  .bios		= TPID(__bid1, __bid2),		\</span>
<span class="cp">	  .ec		= __eid,			\</span>
<span class="cp">	  .quirks	= (__ev1) &lt;&lt; 24 | (__ev2) &lt;&lt; 16 \</span>
<span class="cp">			  | (__bv1) &lt;&lt; 8 | (__bv2) }</span>

<span class="cp">#define TPV_QI0(__id1, __id2, __bv1, __bv2) \</span>
<span class="cp">	TPV_Q(PCI_VENDOR_ID_IBM, __id1, __id2, __bv1, __bv2)</span>

<span class="cm">/* Outdated IBM BIOSes often lack the EC id string */</span>
<span class="cp">#define TPV_QI1(__id1, __id2, __bv1, __bv2, __ev1, __ev2) \</span>
<span class="cp">	TPV_Q_X(PCI_VENDOR_ID_IBM, __id1, __id2, 	\</span>
<span class="cp">		__bv1, __bv2, TPID(__id1, __id2),	\</span>
<span class="cp">		__ev1, __ev2),				\</span>
<span class="cp">	TPV_Q_X(PCI_VENDOR_ID_IBM, __id1, __id2, 	\</span>
<span class="cp">		__bv1, __bv2, TPACPI_MATCH_UNKNOWN,	\</span>
<span class="cp">		__ev1, __ev2)</span>

<span class="cm">/* Outdated IBM BIOSes often lack the EC id string */</span>
<span class="cp">#define TPV_QI2(__bid1, __bid2, __bv1, __bv2,		\</span>
<span class="cp">		__eid1, __eid2, __ev1, __ev2) 		\</span>
<span class="cp">	TPV_Q_X(PCI_VENDOR_ID_IBM, __bid1, __bid2, 	\</span>
<span class="cp">		__bv1, __bv2, TPID(__eid1, __eid2),	\</span>
<span class="cp">		__ev1, __ev2),				\</span>
<span class="cp">	TPV_Q_X(PCI_VENDOR_ID_IBM, __bid1, __bid2, 	\</span>
<span class="cp">		__bv1, __bv2, TPACPI_MATCH_UNKNOWN,	\</span>
<span class="cp">		__ev1, __ev2)</span>

<span class="cp">#define TPV_QL0(__id1, __id2, __bv1, __bv2) \</span>
<span class="cp">	TPV_Q(PCI_VENDOR_ID_LENOVO, __id1, __id2, __bv1, __bv2)</span>

<span class="cp">#define TPV_QL1(__id1, __id2, __bv1, __bv2, __ev1, __ev2) \</span>
<span class="cp">	TPV_Q_X(PCI_VENDOR_ID_LENOVO, __id1, __id2, 	\</span>
<span class="cp">		__bv1, __bv2, TPID(__id1, __id2),	\</span>
<span class="cp">		__ev1, __ev2)</span>

<span class="cp">#define TPV_QL2(__bid1, __bid2, __bv1, __bv2,		\</span>
<span class="cp">		__eid1, __eid2, __ev1, __ev2) 		\</span>
<span class="cp">	TPV_Q_X(PCI_VENDOR_ID_LENOVO, __bid1, __bid2, 	\</span>
<span class="cp">		__bv1, __bv2, TPID(__eid1, __eid2),	\</span>
<span class="cp">		__ev1, __ev2)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="n">tpacpi_bios_version_qtable</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*  Numeric models ------------------ */</span>
	<span class="cm">/*      FW MODEL   BIOS VERS	      */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">),</span>		 <span class="cm">/* 570 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">),</span>		 <span class="cm">/* 570E */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span>  <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">),</span>		 <span class="cm">/* 600 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">,</span>  <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">),</span>		 <span class="cm">/* 600E */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span>  <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">),</span>		 <span class="cm">/* 600E */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span>  <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">),</span>		 <span class="cm">/* 600X */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span>  <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">),</span>		 <span class="cm">/* 770, 770E, 770ED */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span>  <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">),</span>		 <span class="cm">/* 770X */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;O&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">),</span>		 <span class="cm">/* 770Z */</span>

	<span class="cm">/* A-series ------------------------- */</span>
	<span class="cm">/*      FW MODEL   BIOS VERS  EC VERS */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;W&#39;</span><span class="p">,</span>  <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">),</span>		 <span class="cm">/* A20m */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">),</span>		 <span class="cm">/* A20p */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">),</span>		 <span class="cm">/* A21e, A22e */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span>  <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">),</span>		 <span class="cm">/* A21e */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span>  <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">),</span>		 <span class="cm">/* A21m, A22m */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span>  <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">),</span>		 <span class="cm">/* A21p, A22p */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span>  <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">),</span>		 <span class="cm">/* A22e */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">),</span>		 <span class="cm">/* A22m */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span>  <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">),</span>		 <span class="cm">/* A30/p (0) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span>  <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span>  <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">),</span> <span class="cm">/* A31/p (0) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span>  <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span>  <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">),</span> <span class="cm">/* A31/p (0) */</span>

	<span class="cm">/* G-series ------------------------- */</span>
	<span class="cm">/*      FW MODEL   BIOS VERS	      */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span>  <span class="sc">&#39;A&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">),</span>		 <span class="cm">/* G40 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span>  <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">),</span>		 <span class="cm">/* G41 */</span>

	<span class="cm">/* R-series, T-series --------------- */</span>
	<span class="cm">/*      FW MODEL   BIOS VERS  EC VERS */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span>  <span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">),</span>		 <span class="cm">/* R30 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span>  <span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">),</span>		 <span class="cm">/* R31 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span>  <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">),</span>		 <span class="cm">/* R32 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;O&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">),</span>		 <span class="cm">/* R40 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">),</span>		 <span class="cm">/* R40 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span>  <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">),</span>		 <span class="cm">/* R40e */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span>  <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span>  <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">),</span> <span class="cm">/* R50/p, R51,</span>
<span class="cm">						    T40/p, T41/p, T42/p (1) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span>  <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">),</span> <span class="cm">/* R50e, R51 (1) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span>  <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span>  <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">),</span> <span class="cm">/* R51e (1) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span>  <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">),</span> <span class="cm">/* R52 (1) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">),</span> <span class="cm">/* R52, T43 (1) */</span>

	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">),</span>		 <span class="cm">/* T20 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="sc">&#39;Z&#39;</span><span class="p">,</span>  <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">),</span>		 <span class="cm">/* T21 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span>  <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">),</span>		 <span class="cm">/* T22 */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">),</span> <span class="cm">/* T23 (0) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span>  <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;1&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">),</span> <span class="cm">/* T30 (0) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">),</span> <span class="cm">/* T43/p (1) */</span>

	<span class="n">TPV_QL1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span>  <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span>  <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">),</span> <span class="cm">/* T60/p */</span>
	<span class="n">TPV_QL1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span>  <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">),</span> <span class="cm">/* R60, R60i */</span>
	<span class="n">TPV_QL1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span>  <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>  <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">),</span> <span class="cm">/* R60e, R60i */</span>

	<span class="cm">/*      BIOS FW    BIOS VERS  EC FW     EC VERS */</span>
	<span class="n">TPV_QI2</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;W&#39;</span><span class="p">,</span>  <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>  <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">),</span> <span class="cm">/* R50e (1) */</span>
	<span class="n">TPV_QL2</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span>  <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span>  <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">),</span> <span class="cm">/* T60/p wide */</span>

	<span class="cm">/* X-series ------------------------- */</span>
	<span class="cm">/*      FW MODEL   BIOS VERS  EC VERS */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;Z&#39;</span><span class="p">,</span>  <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">),</span>		 <span class="cm">/* X20, X21 */</span>
	<span class="n">TPV_QI0</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span>  <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">),</span>		 <span class="cm">/* X22, X23, X24 */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;K&#39;</span><span class="p">,</span>  <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span>  <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">),</span> <span class="cm">/* X30 (0) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;Q&#39;</span><span class="p">,</span>  <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">),</span> <span class="cm">/* X31, X32 (0) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span>  <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span>  <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="sc">&#39;2&#39;</span><span class="p">),</span> <span class="cm">/* X40 (0) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">),</span> <span class="cm">/* X41 (0) */</span>
	<span class="n">TPV_QI1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span>  <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>  <span class="sc">&#39;2&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">),</span> <span class="cm">/* X41t (0) */</span>

	<span class="n">TPV_QL1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span>  <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span>  <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">),</span> <span class="cm">/* X60/s */</span>
	<span class="n">TPV_QL1</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;J&#39;</span><span class="p">,</span>  <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span>  <span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">),</span> <span class="cm">/* X60t */</span>

	<span class="cm">/* (0) - older versions lack DMI EC fw string and functionality */</span>
	<span class="cm">/* (1) - older versions known to lack functionality */</span>
<span class="p">};</span>

<span class="cp">#undef TPV_QL1</span>
<span class="cp">#undef TPV_QL0</span>
<span class="cp">#undef TPV_QI2</span>
<span class="cp">#undef TPV_QI1</span>
<span class="cp">#undef TPV_QI0</span>
<span class="cp">#undef TPV_Q_X</span>
<span class="cp">#undef TPV_Q</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">tpacpi_check_outdated_fw</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fwvers</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ec_version</span><span class="p">,</span> <span class="n">bios_version</span><span class="p">;</span>

	<span class="n">fwvers</span> <span class="o">=</span> <span class="n">tpacpi_check_quirks</span><span class="p">(</span><span class="n">tpacpi_bios_version_qtable</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tpacpi_bios_version_qtable</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fwvers</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bios_version</span> <span class="o">=</span> <span class="n">fwvers</span> <span class="o">&amp;</span> <span class="mh">0xffffU</span><span class="p">;</span>
	<span class="n">ec_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwvers</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffU</span><span class="p">;</span>

	<span class="cm">/* note that unknown versions are set to 0x0000 and we use that */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bios_version</span> <span class="o">&gt;</span> <span class="n">thinkpad_id</span><span class="p">.</span><span class="n">bios_release</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ec_version</span> <span class="o">&gt;</span> <span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_release</span> <span class="o">&amp;&amp;</span>
				<span class="n">ec_version</span> <span class="o">!=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The changelogs would let us track down the exact</span>
<span class="cm">		 * reason, but it is just too much of a pain to track</span>
<span class="cm">		 * it.  We only list BIOSes that are either really</span>
<span class="cm">		 * broken, or really stable to begin with, so it is</span>
<span class="cm">		 * best if the user upgrades the firmware anyway.</span>
<span class="cm">		 */</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;WARNING: Outdated ThinkPad BIOS/EC firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;WARNING: This firmware may be missing critical bug &quot;</span>
			<span class="s">&quot;fixes and/or important features</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__init</span> <span class="nf">tpacpi_is_fw_known</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpacpi_check_quirks</span><span class="p">(</span><span class="n">tpacpi_bios_version_qtable</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tpacpi_bios_version_qtable</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Subdrivers</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * thinkpad-acpi metadata subdriver</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">thinkpad_acpi_driver_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;driver:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_DESC</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;version:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_VERSION</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">thinkpad_acpi_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;driver&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">thinkpad_acpi_driver_read</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Hotkey subdriver</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ThinkPad firmware event model</span>
<span class="cm"> *</span>
<span class="cm"> * The ThinkPad firmware has two main event interfaces: normal ACPI</span>
<span class="cm"> * notifications (which follow the ACPI standard), and a private event</span>
<span class="cm"> * interface.</span>
<span class="cm"> *</span>
<span class="cm"> * The private event interface also issues events for the hotkeys.  As</span>
<span class="cm"> * the driver gained features, the event handling code ended up being</span>
<span class="cm"> * built around the hotkey subdriver.  This will need to be refactored</span>
<span class="cm"> * to a more formal event API eventually.</span>
<span class="cm"> *</span>
<span class="cm"> * Some &quot;hotkeys&quot; are actually supposed to be used as event reports,</span>
<span class="cm"> * such as &quot;brightness has changed&quot;, &quot;volume has changed&quot;, depending on</span>
<span class="cm"> * the ThinkPad model and how the firmware is operating.</span>
<span class="cm"> *</span>
<span class="cm"> * Unlike other classes, hotkey-class events have mask/unmask control on</span>
<span class="cm"> * non-ancient firmware.  However, how it behaves changes a lot with the</span>
<span class="cm"> * firmware model and version.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span>	<span class="cm">/* hot key scan codes (derived from ACPI DSDT) */</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF1</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF2</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF3</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF4</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF5</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF6</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF7</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF8</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF9</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF10</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF11</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNF12</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNBACKSPACE</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNINSERT</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNDELETE</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNHOME</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNEND</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNPAGEUP</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNPAGEDOWN</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_FNSPACE</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_VOLUMEUP</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_VOLUMEDOWN</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_MUTE</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_THINKPAD</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_UNK1</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_UNK2</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_UNK3</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_UNK4</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_UNK5</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_UNK6</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_UNK7</span><span class="p">,</span>
	<span class="n">TP_ACPI_HOTKEYSCAN_UNK8</span><span class="p">,</span>

	<span class="cm">/* Hotkey keymap size */</span>
	<span class="n">TPACPI_HOTKEY_MAP_LEN</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>	<span class="cm">/* Keys/events available through NVRAM polling */</span>
	<span class="n">TPACPI_HKEY_NVRAM_KNOWN_MASK</span> <span class="o">=</span> <span class="mh">0x00fb88c0U</span><span class="p">,</span>
	<span class="n">TPACPI_HKEY_NVRAM_GOOD_MASK</span>  <span class="o">=</span> <span class="mh">0x00fb8000U</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>	<span class="cm">/* Positions of some of the keys in hotkey masks */</span>
	<span class="n">TP_ACPI_HKEY_DISPSWTCH_MASK</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_FNF7</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_DISPXPAND_MASK</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_FNF8</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_HIBERNATE_MASK</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_FNF12</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_BRGHTUP_MASK</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_FNHOME</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_BRGHTDWN_MASK</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_FNEND</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_THNKLGHT_MASK</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_FNPAGEUP</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_ZOOM_MASK</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_FNSPACE</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_VOLUP_MASK</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_VOLUMEUP</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_VOLDWN_MASK</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_VOLUMEDOWN</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_MUTE_MASK</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_MUTE</span><span class="p">,</span>
	<span class="n">TP_ACPI_HKEY_THINKPAD_MASK</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_THINKPAD</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>	<span class="cm">/* NVRAM to ACPI HKEY group map */</span>
	<span class="n">TP_NVRAM_HKEY_GROUP_HK2</span>		<span class="o">=</span> <span class="n">TP_ACPI_HKEY_THINKPAD_MASK</span> <span class="o">|</span>
					  <span class="n">TP_ACPI_HKEY_ZOOM_MASK</span> <span class="o">|</span>
					  <span class="n">TP_ACPI_HKEY_DISPSWTCH_MASK</span> <span class="o">|</span>
					  <span class="n">TP_ACPI_HKEY_HIBERNATE_MASK</span><span class="p">,</span>
	<span class="n">TP_NVRAM_HKEY_GROUP_BRIGHTNESS</span>	<span class="o">=</span> <span class="n">TP_ACPI_HKEY_BRGHTUP_MASK</span> <span class="o">|</span>
					  <span class="n">TP_ACPI_HKEY_BRGHTDWN_MASK</span><span class="p">,</span>
	<span class="n">TP_NVRAM_HKEY_GROUP_VOLUME</span>	<span class="o">=</span> <span class="n">TP_ACPI_HKEY_VOLUP_MASK</span> <span class="o">|</span>
					  <span class="n">TP_ACPI_HKEY_VOLDWN_MASK</span> <span class="o">|</span>
					  <span class="n">TP_ACPI_HKEY_MUTE_MASK</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_HOTKEY_POLL</span>
<span class="k">struct</span> <span class="n">tp_nvram_state</span> <span class="p">{</span>
       <span class="n">u16</span> <span class="n">thinkpad_toggle</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
       <span class="n">u16</span> <span class="n">zoom_toggle</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
       <span class="n">u16</span> <span class="n">display_toggle</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
       <span class="n">u16</span> <span class="n">thinklight_toggle</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
       <span class="n">u16</span> <span class="n">hibernate_toggle</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
       <span class="n">u16</span> <span class="n">displayexp_toggle</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
       <span class="n">u16</span> <span class="n">display_state</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
       <span class="n">u16</span> <span class="n">brightness_toggle</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
       <span class="n">u16</span> <span class="n">volume_toggle</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
       <span class="n">u16</span> <span class="n">mute</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

       <span class="n">u8</span> <span class="n">brightness_level</span><span class="p">;</span>
       <span class="n">u8</span> <span class="n">volume_level</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* kthread for the hotkey poller */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">tpacpi_hotkey_task</span><span class="p">;</span>

<span class="cm">/* Acquired while the poller kthread is running, use to sync start/stop */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">hotkey_thread_mutex</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Acquire mutex to write poller control variables as an</span>
<span class="cm"> * atomic block.</span>
<span class="cm"> *</span>
<span class="cm"> * Increment hotkey_config_change when changing them if you</span>
<span class="cm"> * want the kthread to forget old state.</span>
<span class="cm"> *</span>
<span class="cm"> * See HOTKEY_CONFIG_CRITICAL_START/HOTKEY_CONFIG_CRITICAL_END</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">hotkey_thread_data_mutex</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hotkey_config_change</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * hotkey poller control variables</span>
<span class="cm"> *</span>
<span class="cm"> * Must be atomic or readers will also need to acquire mutex</span>
<span class="cm"> *</span>
<span class="cm"> * HOTKEY_CONFIG_CRITICAL_START/HOTKEY_CONFIG_CRITICAL_END</span>
<span class="cm"> * should be used only when the changes need to be taken as</span>
<span class="cm"> * a block, OR when one needs to force the kthread to forget</span>
<span class="cm"> * old state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hotkey_source_mask</span><span class="p">;</span>		<span class="cm">/* bit mask 0=ACPI,1=NVRAM */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hotkey_poll_freq</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* Hz */</span>

<span class="cp">#define HOTKEY_CONFIG_CRITICAL_START \</span>
<span class="cp">	do { \</span>
<span class="cp">		mutex_lock(&amp;hotkey_thread_data_mutex); \</span>
<span class="cp">		hotkey_config_change++; \</span>
<span class="cp">	} while (0);</span>
<span class="cp">#define HOTKEY_CONFIG_CRITICAL_END \</span>
<span class="cp">	mutex_unlock(&amp;hotkey_thread_data_mutex);</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_THINKPAD_ACPI_HOTKEY_POLL */</span><span class="cp"></span>

<span class="cp">#define hotkey_source_mask 0U</span>
<span class="cp">#define HOTKEY_CONFIG_CRITICAL_START</span>
<span class="cp">#define HOTKEY_CONFIG_CRITICAL_END</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_THINKPAD_ACPI_HOTKEY_POLL */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">hotkey_mutex</span><span class="p">;</span>

<span class="k">static</span> <span class="k">enum</span> <span class="p">{</span>	<span class="cm">/* Reasons for waking up */</span>
	<span class="n">TP_ACPI_WAKEUP_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* None or unknown */</span>
	<span class="n">TP_ACPI_WAKEUP_BAYEJ</span><span class="p">,</span>		<span class="cm">/* Bay ejection request */</span>
	<span class="n">TP_ACPI_WAKEUP_UNDOCK</span><span class="p">,</span>		<span class="cm">/* Undock request */</span>
<span class="p">}</span> <span class="n">hotkey_wakeup_reason</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">hotkey_autosleep_ack</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">hotkey_orig_mask</span><span class="p">;</span>		<span class="cm">/* events the BIOS had enabled */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hotkey_all_mask</span><span class="p">;</span>		<span class="cm">/* all events supported in fw */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hotkey_reserved_mask</span><span class="p">;</span>	<span class="cm">/* events better left disabled */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hotkey_driver_mask</span><span class="p">;</span>		<span class="cm">/* events needed by the driver */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hotkey_user_mask</span><span class="p">;</span>		<span class="cm">/* events visible to userspace */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">hotkey_acpi_mask</span><span class="p">;</span>		<span class="cm">/* events enabled in firmware */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hotkey_report_mode</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u16</span> <span class="o">*</span><span class="n">hotkey_keycode_map</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_set</span> <span class="o">*</span><span class="n">hotkey_dev_attributes</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">tpacpi_driver_event</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hkey_event</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hotkey_driver_event</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hotkey_poll_setup</span><span class="p">(</span><span class="k">const</span> <span class="n">bool</span> <span class="n">may_warn</span><span class="p">);</span>

<span class="cm">/* HKEY.MHKG() return bits */</span>
<span class="cp">#define TP_HOTKEY_TABLET_MASK (1 &lt;&lt; 3)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_get_wlsw</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_wlsw</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_wlswemul</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">tpacpi_wlsw_emulstate</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">TPACPI_RFK_RADIO_ON</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;WLSW&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">?</span> <span class="n">TPACPI_RFK_RADIO_ON</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_get_tablet_mode</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;MHKG&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="p">((</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">TP_HOTKEY_TABLET_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Reads current event mask from firmware, and updates</span>
<span class="cm"> * hotkey_acpi_mask accordingly.  Also resets any bits</span>
<span class="cm"> * from hotkey_user_mask that are unavailable to be</span>
<span class="cm"> * delivered (shadow requirement of the userspace ABI).</span>
<span class="cm"> *</span>
<span class="cm"> * Call with hotkey_mutex held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_mask_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;DHKN&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">hotkey_acpi_mask</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* no mask support doesn&#39;t mean no event support... */</span>
		<span class="n">hotkey_acpi_mask</span> <span class="o">=</span> <span class="n">hotkey_all_mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sync userspace-visible mask */</span>
	<span class="n">hotkey_user_mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">hotkey_acpi_mask</span> <span class="o">|</span> <span class="n">hotkey_source_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="k">static</span> <span class="nf">hotkey_mask_warn_incomplete_mask</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* log only what the user can fix... */</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">wantedmask</span> <span class="o">=</span> <span class="n">hotkey_driver_mask</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="n">hotkey_acpi_mask</span> <span class="o">|</span> <span class="n">hotkey_source_mask</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">hotkey_all_mask</span> <span class="o">|</span> <span class="n">TPACPI_HKEY_NVRAM_KNOWN_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wantedmask</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;required events 0x%08x not enabled!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wantedmask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the firmware mask when supported</span>
<span class="cm"> *</span>
<span class="cm"> * Also calls hotkey_mask_get to update hotkey_acpi_mask.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: does not set bits in hotkey_user_mask, but may reset them.</span>
<span class="cm"> *</span>
<span class="cm"> * Call with hotkey_mutex held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_mask_set</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">const</span> <span class="n">u32</span> <span class="n">fwmask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_source_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;MHKM&quot;</span><span class="p">,</span> <span class="s">&quot;vdd&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					<span class="o">!!</span><span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))))</span> <span class="p">{</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We *must* make an inconditional call to hotkey_mask_get to</span>
<span class="cm">	 * refresh hotkey_acpi_mask and update hotkey_user_mask</span>
<span class="cm">	 *</span>
<span class="cm">	 * Take the opportunity to also log when we cannot _enable_</span>
<span class="cm">	 * a given event.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hotkey_mask_get</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fwmask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_acpi_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;asked for hotkey mask 0x%08x, but &quot;</span>
			  <span class="s">&quot;firmware forced it to 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fwmask</span><span class="p">,</span> <span class="n">hotkey_acpi_mask</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_lifecycle</span> <span class="o">!=</span> <span class="n">TPACPI_LIFE_EXITING</span><span class="p">)</span>
		<span class="n">hotkey_mask_warn_incomplete_mask</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sets hotkey_user_mask and tries to set the firmware mask</span>
<span class="cm"> *</span>
<span class="cm"> * Call with hotkey_mutex held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_user_mask_set</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Give people a chance to notice they are doing something that</span>
<span class="cm">	 * is bound to go boom on their users sooner or later */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_warned</span><span class="p">.</span><span class="n">hotkey_mask_ff</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">||</span> <span class="n">mask</span> <span class="o">==</span> <span class="mh">0xffffff</span> <span class="o">||</span>
	     <span class="n">mask</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp_warned</span><span class="p">.</span><span class="n">hotkey_mask_ff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;setting the hotkey mask to 0x%08x is likely &quot;</span>
			  <span class="s">&quot;not the best way to go about it</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;please consider using the driver defaults, &quot;</span>
			  <span class="s">&quot;and refer to up-to-date thinkpad-acpi &quot;</span>
			  <span class="s">&quot;documentation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Try to enable what the user asked for, plus whatever we need.</span>
<span class="cm">	 * this syncs everything but won&#39;t enable bits in hotkey_user_mask */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">hotkey_mask_set</span><span class="p">((</span><span class="n">mask</span> <span class="o">|</span> <span class="n">hotkey_driver_mask</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_source_mask</span><span class="p">);</span>

	<span class="cm">/* Enable the available bits in hotkey_user_mask */</span>
	<span class="n">hotkey_user_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">hotkey_acpi_mask</span> <span class="o">|</span> <span class="n">hotkey_source_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Sets the driver hotkey mask.</span>
<span class="cm"> *</span>
<span class="cm"> * Can be called even if the hotkey subdriver is inactive</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_hotkey_driver_mask_set</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Do the right thing if hotkey_init has not been called yet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hotkey_driver_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>

	<span class="n">HOTKEY_CONFIG_CRITICAL_START</span>
	<span class="n">hotkey_driver_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_HOTKEY_POLL</span>
	<span class="n">hotkey_source_mask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_all_mask</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">HOTKEY_CONFIG_CRITICAL_END</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hotkey_mask_set</span><span class="p">((</span><span class="n">hotkey_acpi_mask</span> <span class="o">|</span> <span class="n">hotkey_driver_mask</span><span class="p">)</span> <span class="o">&amp;</span>
							<span class="o">~</span><span class="n">hotkey_source_mask</span><span class="p">);</span>
	<span class="n">hotkey_poll_setup</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_status_get</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="s">&quot;DHKC&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_status_set</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;MHKC&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_input_send_tabletsw</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_tablet</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">hotkey_get_tablet_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_inputdev_send_mutex</span><span class="p">);</span>

		<span class="n">input_report_switch</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span>
				    <span class="n">SW_TABLET_MODE</span><span class="p">,</span> <span class="o">!!</span><span class="n">state</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_inputdev_send_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Do NOT call without validating scancode first */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_input_send_key</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">keycode</span> <span class="o">=</span> <span class="n">hotkey_keycode_map</span><span class="p">[</span><span class="n">scancode</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">!=</span> <span class="n">KEY_RESERVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_inputdev_send_mutex</span><span class="p">);</span>

		<span class="n">input_event</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">,</span> <span class="n">scancode</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">);</span>

		<span class="n">input_event</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">,</span> <span class="n">scancode</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_inputdev_send_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Do NOT call without validating scancode first */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_input_send_key_masked</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hotkey_driver_event</span><span class="p">(</span><span class="n">scancode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_user_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scancode</span><span class="p">))</span>
		<span class="n">tpacpi_input_send_key</span><span class="p">(</span><span class="n">scancode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_HOTKEY_POLL</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tp_acpi_drv_struct</span> <span class="n">ibm_hotkey_acpidriver</span><span class="p">;</span>

<span class="cm">/* Do NOT call without validating scancode first */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_hotkey_send_key</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_input_send_key_masked</span><span class="p">(</span><span class="n">scancode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_report_mode</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_bus_generate_proc_event</span><span class="p">(</span><span class="n">ibm_hotkey_acpidriver</span><span class="p">.</span><span class="n">device</span><span class="p">,</span>
				<span class="mh">0x80</span><span class="p">,</span> <span class="n">TP_HKEY_EV_HOTKEY_BASE</span> <span class="o">+</span> <span class="n">scancode</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_read_nvram</span><span class="p">(</span><span class="k">struct</span> <span class="n">tp_nvram_state</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_HKEY_GROUP_HK2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">TP_NVRAM_ADDR_HK2</span><span class="p">);</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">thinkpad_toggle</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_HKT_THINKPAD</span><span class="p">);</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">zoom_toggle</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_HKT_ZOOM</span><span class="p">);</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">display_toggle</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_HKT_DISPLAY</span><span class="p">);</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">hibernate_toggle</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_HKT_HIBERNATE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">TP_ACPI_HKEY_THNKLGHT_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">TP_NVRAM_ADDR_THINKLIGHT</span><span class="p">);</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">thinklight_toggle</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_THINKLIGHT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">TP_ACPI_HKEY_DISPXPAND_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">TP_NVRAM_ADDR_VIDEO</span><span class="p">);</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">displayexp_toggle</span> <span class="o">=</span>
				<span class="o">!!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_HKT_DISPEXPND</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_HKEY_GROUP_BRIGHTNESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">TP_NVRAM_ADDR_BRIGHTNESS</span><span class="p">);</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">brightness_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_LEVEL_BRIGHTNESS</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="n">TP_NVRAM_POS_LEVEL_BRIGHTNESS</span><span class="p">;</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">brightness_toggle</span> <span class="o">=</span>
				<span class="o">!!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_HKT_BRIGHTNESS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_HKEY_GROUP_VOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">TP_NVRAM_ADDR_MIXER</span><span class="p">);</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">volume_level</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_LEVEL_VOLUME</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="n">TP_NVRAM_POS_LEVEL_VOLUME</span><span class="p">;</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">mute</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_MUTE</span><span class="p">);</span>
		<span class="n">n</span><span class="o">-&gt;</span><span class="n">volume_toggle</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_HKT_VOLUME</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_compare_and_issue_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">tp_nvram_state</span> <span class="o">*</span><span class="n">oldn</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">tp_nvram_state</span> <span class="o">*</span><span class="n">newn</span><span class="p">,</span>
					   <span class="k">const</span> <span class="n">u32</span> <span class="n">event_mask</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#define TPACPI_COMPARE_KEY(__scancode, __member) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if ((event_mask &amp; (1 &lt;&lt; __scancode)) &amp;&amp; \</span>
<span class="cp">		    oldn-&gt;__member != newn-&gt;__member) \</span>
<span class="cp">			tpacpi_hotkey_send_key(__scancode); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#define TPACPI_MAY_SEND_KEY(__scancode) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (event_mask &amp; (1 &lt;&lt; __scancode)) \</span>
<span class="cp">			tpacpi_hotkey_send_key(__scancode); \</span>
<span class="cp">	} while (0)</span>

	<span class="kt">void</span> <span class="n">issue_volchange</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldvol</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">newvol</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">oldvol</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">newvol</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_VOLUMEDOWN</span><span class="p">);</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">newvol</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_VOLUMEUP</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kt">void</span> <span class="n">issue_brightnesschange</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oldbrt</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">newbrt</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">oldbrt</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">newbrt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNEND</span><span class="p">);</span>
			<span class="n">i</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">newbrt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNHOME</span><span class="p">);</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">TPACPI_COMPARE_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_THINKPAD</span><span class="p">,</span> <span class="n">thinkpad_toggle</span><span class="p">);</span>
	<span class="n">TPACPI_COMPARE_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNSPACE</span><span class="p">,</span> <span class="n">zoom_toggle</span><span class="p">);</span>
	<span class="n">TPACPI_COMPARE_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNF7</span><span class="p">,</span> <span class="n">display_toggle</span><span class="p">);</span>
	<span class="n">TPACPI_COMPARE_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNF12</span><span class="p">,</span> <span class="n">hibernate_toggle</span><span class="p">);</span>

	<span class="n">TPACPI_COMPARE_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNPAGEUP</span><span class="p">,</span> <span class="n">thinklight_toggle</span><span class="p">);</span>

	<span class="n">TPACPI_COMPARE_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNF8</span><span class="p">,</span> <span class="n">displayexp_toggle</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle volume</span>
<span class="cm">	 *</span>
<span class="cm">	 * This code is supposed to duplicate the IBM firmware behaviour:</span>
<span class="cm">	 * - Pressing MUTE issues mute hotkey message, even when already mute</span>
<span class="cm">	 * - Pressing Volume up/down issues volume up/down hotkey messages,</span>
<span class="cm">	 *   even when already at maximum or minimum volume</span>
<span class="cm">	 * - The act of unmuting issues volume up/down notification,</span>
<span class="cm">	 *   depending which key was used to unmute</span>
<span class="cm">	 *</span>
<span class="cm">	 * We are constrained to what the NVRAM can tell us, which is not much</span>
<span class="cm">	 * and certainly not enough if more than one volume hotkey was pressed</span>
<span class="cm">	 * since the last poll cycle.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Just to make our life interesting, some newer Lenovo ThinkPads have</span>
<span class="cm">	 * bugs in the BIOS and may fail to update volume_toggle properly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newn</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* muted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oldn</span><span class="o">-&gt;</span><span class="n">mute</span> <span class="o">||</span>
		    <span class="n">oldn</span><span class="o">-&gt;</span><span class="n">volume_toggle</span> <span class="o">!=</span> <span class="n">newn</span><span class="o">-&gt;</span><span class="n">volume_toggle</span> <span class="o">||</span>
		    <span class="n">oldn</span><span class="o">-&gt;</span><span class="n">volume_level</span> <span class="o">!=</span> <span class="n">newn</span><span class="o">-&gt;</span><span class="n">volume_level</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* recently muted, or repeated mute keypress, or</span>
<span class="cm">			 * multiple presses ending in mute */</span>
			<span class="n">issue_volchange</span><span class="p">(</span><span class="n">oldn</span><span class="o">-&gt;</span><span class="n">volume_level</span><span class="p">,</span> <span class="n">newn</span><span class="o">-&gt;</span><span class="n">volume_level</span><span class="p">);</span>
			<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_MUTE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* unmute */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldn</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* recently unmuted, issue &#39;unmute&#39; keypress */</span>
			<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_VOLUMEUP</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldn</span><span class="o">-&gt;</span><span class="n">volume_level</span> <span class="o">!=</span> <span class="n">newn</span><span class="o">-&gt;</span><span class="n">volume_level</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">issue_volchange</span><span class="p">(</span><span class="n">oldn</span><span class="o">-&gt;</span><span class="n">volume_level</span><span class="p">,</span> <span class="n">newn</span><span class="o">-&gt;</span><span class="n">volume_level</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oldn</span><span class="o">-&gt;</span><span class="n">volume_toggle</span> <span class="o">!=</span> <span class="n">newn</span><span class="o">-&gt;</span><span class="n">volume_toggle</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* repeated vol up/down keypress at end of scale ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">newn</span><span class="o">-&gt;</span><span class="n">volume_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_VOLUMEDOWN</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newn</span><span class="o">-&gt;</span><span class="n">volume_level</span> <span class="o">&gt;=</span> <span class="n">TP_NVRAM_LEVEL_VOLUME_MAX</span><span class="p">)</span>
				<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_VOLUMEUP</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* handle brightness */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oldn</span><span class="o">-&gt;</span><span class="n">brightness_level</span> <span class="o">!=</span> <span class="n">newn</span><span class="o">-&gt;</span><span class="n">brightness_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">issue_brightnesschange</span><span class="p">(</span><span class="n">oldn</span><span class="o">-&gt;</span><span class="n">brightness_level</span><span class="p">,</span>
				       <span class="n">newn</span><span class="o">-&gt;</span><span class="n">brightness_level</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oldn</span><span class="o">-&gt;</span><span class="n">brightness_toggle</span> <span class="o">!=</span> <span class="n">newn</span><span class="o">-&gt;</span><span class="n">brightness_toggle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* repeated key presses that didn&#39;t change state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newn</span><span class="o">-&gt;</span><span class="n">brightness_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNEND</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">newn</span><span class="o">-&gt;</span><span class="n">brightness_level</span> <span class="o">&gt;=</span> <span class="n">bright_maxlvl</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">bright_unkfw</span><span class="p">)</span>
			<span class="n">TPACPI_MAY_SEND_KEY</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNHOME</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#undef TPACPI_COMPARE_KEY</span>
<span class="cp">#undef TPACPI_MAY_SEND_KEY</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Polling driver</span>
<span class="cm"> *</span>
<span class="cm"> * We track all events in hotkey_source_mask all the time, since</span>
<span class="cm"> * most of them are edge-based.  We only issue those requested by</span>
<span class="cm"> * hotkey_user_mask or hotkey_driver_mask, though.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_kthread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tp_nvram_state</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">poll_mask</span><span class="p">,</span> <span class="n">event_mask</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">si</span><span class="p">,</span> <span class="n">so</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">change_detector</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">poll_freq</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">was_frozen</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_lifecycle</span> <span class="o">==</span> <span class="n">TPACPI_LIFE_EXITING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">set_freezable</span><span class="p">();</span>

	<span class="n">so</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">si</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initial state for compares */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_data_mutex</span><span class="p">);</span>
	<span class="n">change_detector</span> <span class="o">=</span> <span class="n">hotkey_config_change</span><span class="p">;</span>
	<span class="n">poll_mask</span> <span class="o">=</span> <span class="n">hotkey_source_mask</span><span class="p">;</span>
	<span class="n">event_mask</span> <span class="o">=</span> <span class="n">hotkey_source_mask</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">hotkey_driver_mask</span> <span class="o">|</span> <span class="n">hotkey_user_mask</span><span class="p">);</span>
	<span class="n">poll_freq</span> <span class="o">=</span> <span class="n">hotkey_poll_freq</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_data_mutex</span><span class="p">);</span>
	<span class="n">hotkey_read_nvram</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="n">so</span><span class="p">],</span> <span class="n">poll_mask</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">poll_freq</span><span class="p">))</span>
				<span class="n">t</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">/</span><span class="n">poll_freq</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">t</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* should never happen... */</span>
		<span class="p">}</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">kthread_freezable_should_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">was_frozen</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">was_frozen</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_data_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">was_frozen</span> <span class="o">||</span> <span class="n">hotkey_config_change</span> <span class="o">!=</span> <span class="n">change_detector</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* forget old state on thaw or config change */</span>
			<span class="n">si</span> <span class="o">=</span> <span class="n">so</span><span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">change_detector</span> <span class="o">=</span> <span class="n">hotkey_config_change</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">poll_mask</span> <span class="o">=</span> <span class="n">hotkey_source_mask</span><span class="p">;</span>
		<span class="n">event_mask</span> <span class="o">=</span> <span class="n">hotkey_source_mask</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">hotkey_driver_mask</span> <span class="o">|</span> <span class="n">hotkey_user_mask</span><span class="p">);</span>
		<span class="n">poll_freq</span> <span class="o">=</span> <span class="n">hotkey_poll_freq</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_data_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">poll_mask</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hotkey_read_nvram</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="n">si</span><span class="p">],</span> <span class="n">poll_mask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">si</span> <span class="o">!=</span> <span class="n">so</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">hotkey_compare_and_issue_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="n">so</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="n">si</span><span class="p">],</span>
								<span class="n">event_mask</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">so</span> <span class="o">=</span> <span class="n">si</span><span class="p">;</span>
		<span class="n">si</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* call with hotkey_mutex held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_poll_stop_sync</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_hotkey_task</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">tpacpi_hotkey_task</span><span class="p">);</span>
		<span class="n">tpacpi_hotkey_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_mutex</span><span class="p">);</span>
		<span class="cm">/* at this point, the thread did exit */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* call with hotkey_mutex held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_poll_setup</span><span class="p">(</span><span class="k">const</span> <span class="n">bool</span> <span class="n">may_warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">poll_driver_mask</span> <span class="o">=</span> <span class="n">hotkey_driver_mask</span> <span class="o">&amp;</span> <span class="n">hotkey_source_mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">poll_user_mask</span> <span class="o">=</span> <span class="n">hotkey_user_mask</span> <span class="o">&amp;</span> <span class="n">hotkey_source_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_poll_freq</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">poll_driver_mask</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">poll_user_mask</span> <span class="o">&amp;&amp;</span> <span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpacpi_hotkey_task</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tpacpi_hotkey_task</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">hotkey_kthread</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span> <span class="n">TPACPI_NVRAM_KTHREAD_NAME</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tpacpi_hotkey_task</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tpacpi_hotkey_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;could not create kernel thread &quot;</span>
				       <span class="s">&quot;for hotkey polling</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hotkey_poll_stop_sync</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">may_warn</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">poll_driver_mask</span> <span class="o">||</span> <span class="n">poll_user_mask</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hotkey_poll_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;hot keys 0x%08x and/or events 0x%08x &quot;</span>
				  <span class="s">&quot;require polling, which is currently &quot;</span>
				  <span class="s">&quot;disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">poll_user_mask</span><span class="p">,</span> <span class="n">poll_driver_mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_poll_setup_safe</span><span class="p">(</span><span class="k">const</span> <span class="n">bool</span> <span class="n">may_warn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>
	<span class="n">hotkey_poll_setup</span><span class="p">(</span><span class="n">may_warn</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* call with hotkey_mutex held */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_poll_set_freq</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq</span><span class="p">)</span>
		<span class="n">hotkey_poll_stop_sync</span><span class="p">();</span>

	<span class="n">hotkey_poll_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* CONFIG_THINKPAD_ACPI_HOTKEY_POLL */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_poll_setup</span><span class="p">(</span><span class="k">const</span> <span class="n">bool</span> <span class="n">__unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_poll_setup_safe</span><span class="p">(</span><span class="k">const</span> <span class="n">bool</span> <span class="n">__unused</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_THINKPAD_ACPI_HOTKEY_POLL */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_inputdev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tpacpi_lifecycle</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_LIFE_INIT</span>:
	<span class="k">case</span> <span class="n">TPACPI_LIFE_RUNNING</span>:
		<span class="n">hotkey_poll_setup_safe</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_LIFE_EXITING</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Should only happen if tpacpi_lifecycle is corrupt */</span>
	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_inputdev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable hotkey polling when possible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_lifecycle</span> <span class="o">!=</span> <span class="n">TPACPI_LIFE_EXITING</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">hotkey_source_mask</span> <span class="o">&amp;</span> <span class="n">hotkey_driver_mask</span><span class="p">))</span>
		<span class="n">hotkey_poll_setup_safe</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sysfs hotkey enable ------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">printk_deprecated_attribute</span><span class="p">(</span><span class="s">&quot;hotkey_enable&quot;</span><span class="p">,</span>
			<span class="s">&quot;Hotkey reporting is always enabled&quot;</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_status_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_enable_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">printk_deprecated_attribute</span><span class="p">(</span><span class="s">&quot;hotkey_enable&quot;</span><span class="p">,</span>
			<span class="s">&quot;Hotkeys can be disabled through hotkey_mask&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_enable</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_enable</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">hotkey_enable_show</span><span class="p">,</span> <span class="n">hotkey_enable_store</span><span class="p">);</span>

<span class="cm">/* sysfs hotkey mask --------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_mask_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hotkey_user_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_mask_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0xffffffffUL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_user_mask_set</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_HOTKEY_POLL</span>
	<span class="n">hotkey_poll_setup</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>

	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;hotkey_mask&quot;</span><span class="p">,</span> <span class="s">&quot;set to 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">?</span> <span class="n">res</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_mask</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_mask</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">hotkey_mask_show</span><span class="p">,</span> <span class="n">hotkey_mask_store</span><span class="p">);</span>

<span class="cm">/* sysfs hotkey bios_enabled ------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_bios_enabled_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_bios_enabled</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_bios_enabled</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">hotkey_bios_enabled_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* sysfs hotkey bios_mask ---------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_bios_mask_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk_deprecated_attribute</span><span class="p">(</span><span class="s">&quot;hotkey_bios_mask&quot;</span><span class="p">,</span>
			<span class="s">&quot;This attribute is useless.&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hotkey_orig_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_bios_mask</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_bios_mask</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">hotkey_bios_mask_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* sysfs hotkey all_mask ----------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_all_mask_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hotkey_all_mask</span> <span class="o">|</span> <span class="n">hotkey_source_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_all_mask</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_all_mask</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">hotkey_all_mask_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* sysfs hotkey recommended_mask --------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_recommended_mask_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">hotkey_all_mask</span> <span class="o">|</span> <span class="n">hotkey_source_mask</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_reserved_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_recommended_mask</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_recommended_mask</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">hotkey_recommended_mask_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_HOTKEY_POLL</span>

<span class="cm">/* sysfs hotkey hotkey_source_mask ------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_source_mask_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hotkey_source_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_source_mask_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r_ev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0xffffffffUL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">((</span><span class="n">t</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TPACPI_HKEY_NVRAM_KNOWN_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">HOTKEY_CONFIG_CRITICAL_START</span>
	<span class="n">hotkey_source_mask</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">HOTKEY_CONFIG_CRITICAL_END</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">hotkey_mask_set</span><span class="p">((</span><span class="n">hotkey_user_mask</span> <span class="o">|</span> <span class="n">hotkey_driver_mask</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="o">~</span><span class="n">hotkey_source_mask</span><span class="p">);</span>
	<span class="n">hotkey_poll_setup</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* check if events needed by the driver got disabled */</span>
	<span class="n">r_ev</span> <span class="o">=</span> <span class="n">hotkey_driver_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">hotkey_acpi_mask</span> <span class="o">&amp;</span> <span class="n">hotkey_all_mask</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_source_mask</span> <span class="o">&amp;</span> <span class="n">TPACPI_HKEY_NVRAM_KNOWN_MASK</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;hotkey_source_mask: &quot;</span>
		       <span class="s">&quot;failed to update the firmware event mask!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_ev</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;hotkey_source_mask: &quot;</span>
			  <span class="s">&quot;some important events were disabled: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">r_ev</span><span class="p">);</span>

	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;hotkey_source_mask&quot;</span><span class="p">,</span> <span class="s">&quot;set to 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_source_mask</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_source_mask</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">hotkey_source_mask_show</span><span class="p">,</span> <span class="n">hotkey_source_mask_store</span><span class="p">);</span>

<span class="cm">/* sysfs hotkey hotkey_poll_freq --------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_poll_freq_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hotkey_poll_freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_poll_freq_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">hotkey_poll_set_freq</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="n">hotkey_poll_setup</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>

	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;hotkey_poll_freq&quot;</span><span class="p">,</span> <span class="s">&quot;set to %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_poll_freq</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_poll_freq</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">hotkey_poll_freq_show</span><span class="p">,</span> <span class="n">hotkey_poll_freq_store</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_THINKPAD_ACPI_HOTKEY_POLL */</span><span class="cp"></span>

<span class="cm">/* sysfs hotkey radio_sw (pollable) ------------------------------------ */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_radio_sw_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_get_wlsw</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="cm">/* Opportunistic update */</span>
	<span class="n">tpacpi_rfk_update_hwblock_state</span><span class="p">((</span><span class="n">res</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_radio_sw</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_radio_sw</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">hotkey_radio_sw_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_radio_sw_notify_change</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_wlsw</span><span class="p">)</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			     <span class="s">&quot;hotkey_radio_sw&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sysfs hotkey tablet mode (pollable) --------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_tablet_mode_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_get_tablet_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!!</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_tablet_mode</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_tablet_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">hotkey_tablet_mode_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_tablet_mode_notify_change</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_tablet</span><span class="p">)</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			     <span class="s">&quot;hotkey_tablet_mode&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sysfs hotkey report_mode -------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_report_mode_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">hotkey_report_mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">hotkey_report_mode</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_report_mode</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">hotkey_report_mode</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">hotkey_report_mode_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* sysfs wakeup reason (pollable) -------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_wakeup_reason_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hotkey_wakeup_reason</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_wakeup_reason</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">wakeup_reason</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">hotkey_wakeup_reason_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_wakeup_reason_notify_change</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		     <span class="s">&quot;wakeup_reason&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sysfs wakeup hotunplug_complete (pollable) -------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">hotkey_wakeup_hotunplug_complete_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hotkey_autosleep_ack</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_hotkey_wakeup_hotunplug_complete</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">wakeup_hotunplug_complete</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	       <span class="n">hotkey_wakeup_hotunplug_complete_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_wakeup_hotunplug_complete_notify_change</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
		     <span class="s">&quot;wakeup_hotunplug_complete&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">hotkey_attributes</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_enable</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_bios_enabled</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_bios_mask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_report_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_wakeup_reason</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_wakeup_hotunplug_complete</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_mask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_all_mask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_recommended_mask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_HOTKEY_POLL</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_source_mask</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_hotkey_poll_freq</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Sync both the hw and sw blocking state of all switches</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_send_radiosw_update</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wlsw</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must sync all rfkill controllers *before* issuing any</span>
<span class="cm">	 * rfkill input events, or we will race the rfkill core input</span>
<span class="cm">	 * handler.</span>
<span class="cm">	 *</span>
<span class="cm">	 * tpacpi_inputdev_send_mutex works as a synchronization point</span>
<span class="cm">	 * for the above.</span>
<span class="cm">	 *</span>
<span class="cm">	 * We optimize to avoid numerous calls to hotkey_get_wlsw.</span>
<span class="cm">	 */</span>

	<span class="n">wlsw</span> <span class="o">=</span> <span class="n">hotkey_get_wlsw</span><span class="p">();</span>

	<span class="cm">/* Sync hw blocking state first if it is hw-blocked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlsw</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">)</span>
		<span class="n">tpacpi_rfk_update_hwblock_state</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="cm">/* Sync sw blocking state */</span>
	<span class="n">tpacpi_rfk_update_swstate_all</span><span class="p">();</span>

	<span class="cm">/* Sync hw blocking state last if it is hw-unblocked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlsw</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span>
		<span class="n">tpacpi_rfk_update_hwblock_state</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Issue rfkill input event for WLSW switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wlsw</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_inputdev_send_mutex</span><span class="p">);</span>

		<span class="n">input_report_switch</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span>
				    <span class="n">SW_RFKILL_ALL</span><span class="p">,</span> <span class="p">(</span><span class="n">wlsw</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_inputdev_send_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * this can be unconditional, as we will poll state again</span>
<span class="cm">	 * if userspace uses the notify to read data</span>
<span class="cm">	 */</span>
	<span class="n">hotkey_radio_sw_notify_change</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_HOTKEY_POLL</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>
	<span class="n">hotkey_poll_stop_sync</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_dev_attributes</span><span class="p">)</span>
		<span class="n">delete_attr_set</span><span class="p">(</span><span class="n">hotkey_dev_attributes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hotkey_keycode_map</span><span class="p">);</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_EXIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
		   <span class="s">&quot;restoring original HKEY status and mask</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* yes, there is a bitwise or below, we want the</span>
<span class="cm">	 * functions to be called even if one of them fail */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_mask</span> <span class="o">&amp;&amp;</span>
	      <span class="n">hotkey_mask_set</span><span class="p">(</span><span class="n">hotkey_orig_mask</span><span class="p">))</span> <span class="o">|</span>
	     <span class="n">hotkey_status_set</span><span class="p">(</span><span class="nb">false</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to restore hot key mask &quot;</span>
		       <span class="s">&quot;to BIOS defaults</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">hotkey_unmap</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_keycode_map</span><span class="p">[</span><span class="n">scancode</span><span class="p">]</span> <span class="o">!=</span> <span class="n">KEY_RESERVED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">hotkey_keycode_map</span><span class="p">[</span><span class="n">scancode</span><span class="p">],</span>
			  <span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
		<span class="n">hotkey_keycode_map</span><span class="p">[</span><span class="n">scancode</span><span class="p">]</span> <span class="o">=</span> <span class="n">KEY_RESERVED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * HKEY quirks:</span>
<span class="cm"> *   TPACPI_HK_Q_INIMASK:	Supports FN+F3,FN+F4,FN+F12</span>
<span class="cm"> */</span>

<span class="cp">#define	TPACPI_HK_Q_INIMASK	0x0001</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="n">tpacpi_hotkey_qtable</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* 600E */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* 600E */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* 770, 770E, 770ED */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;W&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* A20m */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* A20p */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* A21e, A22e */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* A21e */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* A21m, A22m */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* A21p, A22p */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* A22e */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* A22m */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* A30/p (0) */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* R30 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* R31 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* T20 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="sc">&#39;Z&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* T21 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* T22 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;Z&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* X20, X21 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;D&#39;</span><span class="p">,</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">),</span> <span class="cm">/* X22, X23, X24 */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="n">u16</span> <span class="n">tpacpi_keymap_entry_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">tpacpi_keymap_entry_t</span> <span class="n">tpacpi_keymap_t</span><span class="p">[</span><span class="n">TPACPI_HOTKEY_MAP_LEN</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hotkey_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Requirements for changing the default keymaps:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 1. Many of the keys are mapped to KEY_RESERVED for very</span>
<span class="cm">	 *    good reasons.  Do not change them unless you have deep</span>
<span class="cm">	 *    knowledge on the IBM and Lenovo ThinkPad firmware for</span>
<span class="cm">	 *    the various ThinkPad models.  The driver behaves</span>
<span class="cm">	 *    differently for KEY_RESERVED: such keys have their</span>
<span class="cm">	 *    hot key mask *unset* in mask_recommended, and also</span>
<span class="cm">	 *    in the initial hot key mask programmed into the</span>
<span class="cm">	 *    firmware at driver load time, which means the firm-</span>
<span class="cm">	 *    ware may react very differently if you change them to</span>
<span class="cm">	 *    something else;</span>
<span class="cm">	 *</span>
<span class="cm">	 * 2. You must be subscribed to the linux-thinkpad and</span>
<span class="cm">	 *    ibm-acpi-devel mailing lists, and you should read the</span>
<span class="cm">	 *    list archives since 2007 if you want to change the</span>
<span class="cm">	 *    keymaps.  This requirement exists so that you will</span>
<span class="cm">	 *    know the past history of problems with the thinkpad-</span>
<span class="cm">	 *    acpi driver keymaps, and also that you will be</span>
<span class="cm">	 *    listening to any bug reports;</span>
<span class="cm">	 *</span>
<span class="cm">	 * 3. Do not send thinkpad-acpi specific patches directly to</span>
<span class="cm">	 *    for merging, *ever*.  Send them to the linux-acpi</span>
<span class="cm">	 *    mailinglist for comments.  Merging is to be done only</span>
<span class="cm">	 *    through acpi-test and the ACPI maintainer.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the above is too much to ask, don&#39;t change the keymap.</span>
<span class="cm">	 * Ask the thinkpad-acpi maintainer to do it, instead.</span>
<span class="cm">	 */</span>

	<span class="k">enum</span> <span class="n">keymap_index</span> <span class="p">{</span>
		<span class="n">TPACPI_KEYMAP_IBM_GENERIC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">TPACPI_KEYMAP_LENOVO_GENERIC</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="n">tpacpi_keymap_t</span> <span class="n">tpacpi_keymaps</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Generic keymap for IBM ThinkPads */</span>
	<span class="p">[</span><span class="n">TPACPI_KEYMAP_IBM_GENERIC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Scan Codes 0x00 to 0x0B: ACPI HKEY FN+F1..F12 */</span>
		<span class="n">KEY_FN_F1</span><span class="p">,</span>	<span class="n">KEY_BATTERY</span><span class="p">,</span>	<span class="n">KEY_COFFEE</span><span class="p">,</span>	<span class="n">KEY_SLEEP</span><span class="p">,</span>
		<span class="n">KEY_WLAN</span><span class="p">,</span>	<span class="n">KEY_FN_F6</span><span class="p">,</span> <span class="n">KEY_SWITCHVIDEOMODE</span><span class="p">,</span> <span class="n">KEY_FN_F8</span><span class="p">,</span>
		<span class="n">KEY_FN_F9</span><span class="p">,</span>	<span class="n">KEY_FN_F10</span><span class="p">,</span>	<span class="n">KEY_FN_F11</span><span class="p">,</span>	<span class="n">KEY_SUSPEND</span><span class="p">,</span>

		<span class="cm">/* Scan codes 0x0C to 0x1F: Other ACPI HKEY hot keys */</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span>	<span class="cm">/* 0x0C: FN+BACKSPACE */</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span>	<span class="cm">/* 0x0D: FN+INSERT */</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span>	<span class="cm">/* 0x0E: FN+DELETE */</span>

		<span class="cm">/* brightness: firmware always reacts to them */</span>
		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x0F: FN+HOME (brightness up) */</span>
		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x10: FN+END (brightness down) */</span>

		<span class="cm">/* Thinklight: firmware always react to it */</span>
		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x11: FN+PGUP (thinklight toggle) */</span>

		<span class="n">KEY_UNKNOWN</span><span class="p">,</span>	<span class="cm">/* 0x12: FN+PGDOWN */</span>
		<span class="n">KEY_ZOOM</span><span class="p">,</span>	<span class="cm">/* 0x13: FN+SPACE (zoom) */</span>

		<span class="cm">/* Volume: firmware always react to it and reprograms</span>
<span class="cm">		 * the built-in *extra* mixer.  Never map it to control</span>
<span class="cm">		 * another mixer by default. */</span>
		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x14: VOLUME UP */</span>
		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x15: VOLUME DOWN */</span>
		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x16: MUTE */</span>

		<span class="n">KEY_VENDOR</span><span class="p">,</span>	<span class="cm">/* 0x17: Thinkpad/AccessIBM/Lenovo */</span>

		<span class="cm">/* (assignments unknown, please report if found) */</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span>
		<span class="p">},</span>

	<span class="cm">/* Generic keymap for Lenovo ThinkPads */</span>
	<span class="p">[</span><span class="n">TPACPI_KEYMAP_LENOVO_GENERIC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Scan Codes 0x00 to 0x0B: ACPI HKEY FN+F1..F12 */</span>
		<span class="n">KEY_FN_F1</span><span class="p">,</span>	<span class="n">KEY_COFFEE</span><span class="p">,</span>	<span class="n">KEY_BATTERY</span><span class="p">,</span>	<span class="n">KEY_SLEEP</span><span class="p">,</span>
		<span class="n">KEY_WLAN</span><span class="p">,</span>	<span class="n">KEY_CAMERA</span><span class="p">,</span> <span class="n">KEY_SWITCHVIDEOMODE</span><span class="p">,</span> <span class="n">KEY_FN_F8</span><span class="p">,</span>
		<span class="n">KEY_FN_F9</span><span class="p">,</span>	<span class="n">KEY_FN_F10</span><span class="p">,</span>	<span class="n">KEY_FN_F11</span><span class="p">,</span>	<span class="n">KEY_SUSPEND</span><span class="p">,</span>

		<span class="cm">/* Scan codes 0x0C to 0x1F: Other ACPI HKEY hot keys */</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span>	<span class="cm">/* 0x0C: FN+BACKSPACE */</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span>	<span class="cm">/* 0x0D: FN+INSERT */</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span>	<span class="cm">/* 0x0E: FN+DELETE */</span>

		<span class="cm">/* These should be enabled --only-- when ACPI video</span>
<span class="cm">		 * is disabled (i.e. in &quot;vendor&quot; mode), and are handled</span>
<span class="cm">		 * in a special way by the init code */</span>
		<span class="n">KEY_BRIGHTNESSUP</span><span class="p">,</span>	<span class="cm">/* 0x0F: FN+HOME (brightness up) */</span>
		<span class="n">KEY_BRIGHTNESSDOWN</span><span class="p">,</span>	<span class="cm">/* 0x10: FN+END (brightness down) */</span>

		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x11: FN+PGUP (thinklight toggle) */</span>

		<span class="n">KEY_UNKNOWN</span><span class="p">,</span>	<span class="cm">/* 0x12: FN+PGDOWN */</span>
		<span class="n">KEY_ZOOM</span><span class="p">,</span>	<span class="cm">/* 0x13: FN+SPACE (zoom) */</span>

		<span class="cm">/* Volume: z60/z61, T60 (BIOS version?): firmware always</span>
<span class="cm">		 * react to it and reprograms the built-in *extra* mixer.</span>
<span class="cm">		 * Never map it to control another mixer by default.</span>
<span class="cm">		 *</span>
<span class="cm">		 * T60?, T61, R60?, R61: firmware and EC tries to send</span>
<span class="cm">		 * these over the regular keyboard, so these are no-ops,</span>
<span class="cm">		 * but there are still weird bugs re. MUTE, so do not</span>
<span class="cm">		 * change unless you get test reports from all Lenovo</span>
<span class="cm">		 * models.  May cause the BIOS to interfere with the</span>
<span class="cm">		 * HDA mixer.</span>
<span class="cm">		 */</span>
		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x14: VOLUME UP */</span>
		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x15: VOLUME DOWN */</span>
		<span class="n">KEY_RESERVED</span><span class="p">,</span>	<span class="cm">/* 0x16: MUTE */</span>

		<span class="n">KEY_VENDOR</span><span class="p">,</span>	<span class="cm">/* 0x17: Thinkpad/AccessIBM/Lenovo */</span>

		<span class="cm">/* (assignments unknown, please report if found) */</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span>

		<span class="cm">/*</span>
<span class="cm">		 * The mic mute button only sends 0x1a.  It does not</span>
<span class="cm">		 * automatically mute the mic or change the mute light.</span>
<span class="cm">		 */</span>
		<span class="n">KEY_MICMUTE</span><span class="p">,</span>	<span class="cm">/* 0x1a: Mic mute (since ?400 or so) */</span>

		<span class="cm">/* (assignments unknown, please report if found) */</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">KEY_UNKNOWN</span><span class="p">,</span>
		<span class="n">KEY_UNKNOWN</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="n">tpacpi_keymap_qtable</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Generic maps (fallback) */</span>
		<span class="p">{</span>
		  <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">bios</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span> <span class="p">.</span><span class="n">ec</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">TPACPI_KEYMAP_IBM_GENERIC</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span>
		  <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_LENOVO</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">bios</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span> <span class="p">.</span><span class="n">ec</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">TPACPI_KEYMAP_LENOVO_GENERIC</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">};</span>

<span class="cp">#define TPACPI_HOTKEY_MAP_SIZE		sizeof(tpacpi_keymap_t)</span>
<span class="cp">#define TPACPI_HOTKEY_MAP_TYPESIZE	sizeof(tpacpi_keymap_entry_t)</span>

	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hkeyv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">radiosw_state</span>  <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tabletsw_state</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">quirks</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">keymap_id</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
			<span class="s">&quot;initializing hotkey subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">tpacpi_inputdev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span>
	       <span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">hkey</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_HOTKEY_POLL</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_thread_data_mutex</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* hotkey not supported on 570 */</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey</span> <span class="o">=</span> <span class="n">hkey_handle</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
		<span class="s">&quot;hotkeys are %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">quirks</span> <span class="o">=</span> <span class="n">tpacpi_check_quirks</span><span class="p">(</span><span class="n">tpacpi_hotkey_qtable</span><span class="p">,</span>
				     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tpacpi_hotkey_qtable</span><span class="p">));</span>

	<span class="n">tpacpi_disable_brightness_delay</span><span class="p">();</span>

	<span class="cm">/* MUST have enough space for all attributes to be added to</span>
<span class="cm">	 * hotkey_dev_attributes */</span>
	<span class="n">hotkey_dev_attributes</span> <span class="o">=</span> <span class="n">create_attr_set</span><span class="p">(</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hotkey_attributes</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hotkey_dev_attributes</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">add_many_to_attr_set</span><span class="p">(</span><span class="n">hotkey_dev_attributes</span><span class="p">,</span>
			<span class="n">hotkey_attributes</span><span class="p">,</span>
			<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">hotkey_attributes</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>

	<span class="cm">/* mask not supported on 600e/x, 770e, 770x, A21e, A2xm/p,</span>
<span class="cm">	   A30, R30, R31, T20-22, X20-21, X22-24.  Detected by checking</span>
<span class="cm">	   for HKEY interface version 0x100 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hkeyv</span><span class="p">,</span> <span class="s">&quot;MHKV&quot;</span><span class="p">,</span> <span class="s">&quot;qd&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hkeyv</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unknown version of the HKEY interface: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">hkeyv</span><span class="p">);</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;please report this to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_MAIL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * MHKV 0x100 in A31, R40, R40e,</span>
<span class="cm">			 * T4x, X31, and later</span>
<span class="cm">			 */</span>
			<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
				<span class="s">&quot;firmware HKEY interface version: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">hkeyv</span><span class="p">);</span>

			<span class="cm">/* Paranoia check AND init hotkey_all_mask */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hotkey_all_mask</span><span class="p">,</span>
					<span class="s">&quot;MHKA&quot;</span><span class="p">,</span> <span class="s">&quot;qd&quot;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;missing MHKA handler, &quot;</span>
				       <span class="s">&quot;please report this to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">TPACPI_MAIL</span><span class="p">);</span>
				<span class="cm">/* Fallback: pre-init for FN+F3,F4,F12 */</span>
				<span class="n">hotkey_all_mask</span> <span class="o">=</span> <span class="mh">0x080cU</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_mask</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
		<span class="s">&quot;hotkey masks are %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_mask</span><span class="p">));</span>

	<span class="cm">/* Init hotkey_all_mask if not initialized yet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_mask</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hotkey_all_mask</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">TPACPI_HK_Q_INIMASK</span><span class="p">))</span>
		<span class="n">hotkey_all_mask</span> <span class="o">=</span> <span class="mh">0x080cU</span><span class="p">;</span>  <span class="cm">/* FN+F12, FN+F4, FN+F3 */</span>

	<span class="cm">/* Init hotkey_acpi_mask and hotkey_orig_mask */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* hotkey_source_mask *must* be zero for</span>
<span class="cm">		 * the first hotkey_mask_get to return hotkey_orig_mask */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_mask_get</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>

		<span class="n">hotkey_orig_mask</span> <span class="o">=</span> <span class="n">hotkey_acpi_mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hotkey_orig_mask</span> <span class="o">=</span> <span class="n">hotkey_all_mask</span><span class="p">;</span>
		<span class="n">hotkey_acpi_mask</span> <span class="o">=</span> <span class="n">hotkey_all_mask</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_wlswemul</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_wlsw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">radiosw_state</span> <span class="o">=</span> <span class="o">!!</span><span class="n">tpacpi_wlsw_emulstate</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;radio switch emulation enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="cm">/* Not all thinkpads have a hardware radio switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;WLSW&quot;</span><span class="p">,</span> <span class="s">&quot;qd&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_wlsw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">radiosw_state</span> <span class="o">=</span> <span class="o">!!</span><span class="n">status</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;radio switch found; radios are %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">enabled</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_wlsw</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">add_to_attr_set</span><span class="p">(</span><span class="n">hotkey_dev_attributes</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_hotkey_radio_sw</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>

	<span class="cm">/* For X41t, X60t, X61t Tablets... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;MHKG&quot;</span><span class="p">,</span> <span class="s">&quot;qd&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_tablet</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tabletsw_state</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_HOTKEY_TABLET_MASK</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;possible tablet mode switch found; &quot;</span>
			<span class="s">&quot;ThinkPad in %s mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">tabletsw_state</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;tablet&quot;</span> <span class="o">:</span> <span class="s">&quot;laptop&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">add_to_attr_set</span><span class="p">(</span><span class="n">hotkey_dev_attributes</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev_attr_hotkey_tablet_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">register_attr_set_with_sysfs</span><span class="p">(</span>
				<span class="n">hotkey_dev_attributes</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>

	<span class="cm">/* Set up key map */</span>
	<span class="n">hotkey_keycode_map</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">TPACPI_HOTKEY_MAP_SIZE</span><span class="p">,</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hotkey_keycode_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to allocate memory for key map</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">keymap_id</span> <span class="o">=</span> <span class="n">tpacpi_check_quirks</span><span class="p">(</span><span class="n">tpacpi_keymap_qtable</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tpacpi_keymap_qtable</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">keymap_id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tpacpi_keymaps</span><span class="p">));</span>
	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
		   <span class="s">&quot;using keymap number %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keymap_id</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hotkey_keycode_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpacpi_keymaps</span><span class="p">[</span><span class="n">keymap_id</span><span class="p">],</span>
		<span class="n">TPACPI_HOTKEY_MAP_SIZE</span><span class="p">);</span>

	<span class="n">input_set_capability</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span> <span class="n">EV_MSC</span><span class="p">,</span> <span class="n">MSC_SCAN</span><span class="p">);</span>
	<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">keycodesize</span> <span class="o">=</span> <span class="n">TPACPI_HOTKEY_MAP_TYPESIZE</span><span class="p">;</span>
	<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">keycodemax</span> <span class="o">=</span> <span class="n">TPACPI_HOTKEY_MAP_LEN</span><span class="p">;</span>
	<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">hotkey_keycode_map</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPACPI_HOTKEY_MAP_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_keycode_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">KEY_RESERVED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">input_set_capability</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span>
						<span class="n">hotkey_keycode_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hotkey_reserved_mask</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
				<span class="n">hotkey_reserved_mask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_wlsw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_set_capability</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span> <span class="n">EV_SW</span><span class="p">,</span> <span class="n">SW_RFKILL_ALL</span><span class="p">);</span>
		<span class="n">input_report_switch</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span>
				    <span class="n">SW_RFKILL_ALL</span><span class="p">,</span> <span class="n">radiosw_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_tablet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_set_capability</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span> <span class="n">EV_SW</span><span class="p">,</span> <span class="n">SW_TABLET_MODE</span><span class="p">);</span>
		<span class="n">input_report_switch</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">,</span>
				    <span class="n">SW_TABLET_MODE</span><span class="p">,</span> <span class="n">tabletsw_state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Do not issue duplicate brightness change events to</span>
<span class="cm">	 * userspace. tpacpi_detect_brightness_capabilities() must have</span>
<span class="cm">	 * been called before this point  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_video_backlight_support</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;This ThinkPad has standard ACPI backlight &quot;</span>
			<span class="s">&quot;brightness control, supported by the ACPI &quot;</span>
			<span class="s">&quot;video driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Disabling thinkpad-acpi brightness events &quot;</span>
			  <span class="s">&quot;by default...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Disable brightness up/down on Lenovo thinkpads when</span>
<span class="cm">		 * ACPI is handling them, otherwise it is plain impossible</span>
<span class="cm">		 * for userspace to do something even remotely sane */</span>
		<span class="n">hotkey_reserved_mask</span> <span class="o">|=</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_FNHOME</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_ACPI_HOTKEYSCAN_FNEND</span><span class="p">);</span>
		<span class="n">hotkey_unmap</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNHOME</span><span class="p">);</span>
		<span class="n">hotkey_unmap</span><span class="p">(</span><span class="n">TP_ACPI_HOTKEYSCAN_FNEND</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_HOTKEY_POLL</span>
	<span class="n">hotkey_source_mask</span> <span class="o">=</span> <span class="n">TPACPI_HKEY_NVRAM_GOOD_MASK</span>
				<span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_all_mask</span>
				<span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_reserved_mask</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
		    <span class="s">&quot;hotkey source mask 0x%08x, polling freq %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">hotkey_source_mask</span><span class="p">,</span> <span class="n">hotkey_poll_freq</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
			<span class="s">&quot;enabling firmware HKEY event interface...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_status_set</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hotkey_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_mask_set</span><span class="p">(((</span><span class="n">hotkey_all_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_reserved_mask</span><span class="p">)</span>
			       <span class="o">|</span> <span class="n">hotkey_driver_mask</span><span class="p">)</span>
			      <span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_source_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hotkey_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hotkey_user_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">hotkey_acpi_mask</span> <span class="o">|</span> <span class="n">hotkey_source_mask</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_reserved_mask</span><span class="p">;</span>
	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
		<span class="s">&quot;initial masks: user=0x%08x, fw=0x%08x, poll=0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">hotkey_user_mask</span><span class="p">,</span> <span class="n">hotkey_acpi_mask</span><span class="p">,</span> <span class="n">hotkey_source_mask</span><span class="p">);</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_HKEY</span><span class="p">,</span>
			<span class="s">&quot;legacy ibm/hotkey event reporting over procfs %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">hotkey_report_mode</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span>
				<span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hotkey_inputdev_open</span><span class="p">;</span>
	<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hotkey_inputdev_close</span><span class="p">;</span>

	<span class="n">hotkey_poll_setup_safe</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_exit:</span>
	<span class="n">delete_attr_set</span><span class="p">(</span><span class="n">hotkey_dev_attributes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">);</span>
	<span class="n">hotkey_dev_attributes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">?</span> <span class="n">res</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hotkey_notify_hotkey</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">hkey</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">send_acpi_ev</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">ignore_acpi_ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 0x1000-0x1FFF: key presses */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span> <span class="o">=</span> <span class="n">hkey</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="o">*</span><span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* HKEY event 0x1001 is scancode 0x00 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scancode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">scancode</span> <span class="o">&lt;=</span> <span class="n">TPACPI_HOTKEY_MAP_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scancode</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hotkey_source_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scancode</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">tpacpi_input_send_key_masked</span><span class="p">(</span><span class="n">scancode</span><span class="p">);</span>
			<span class="o">*</span><span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hotkey_notify_wakeup</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">hkey</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">send_acpi_ev</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">ignore_acpi_ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 0x2000-0x2FFF: Wakeup reason */</span>
	<span class="o">*</span><span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hkey</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_WKUP_S3_UNDOCK</span>: <span class="cm">/* suspend, undock */</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_WKUP_S4_UNDOCK</span>: <span class="cm">/* hibernation, undock */</span>
		<span class="n">hotkey_wakeup_reason</span> <span class="o">=</span> <span class="n">TP_ACPI_WAKEUP_UNDOCK</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TP_HKEY_EV_WKUP_S3_BAYEJ</span>: <span class="cm">/* suspend, bay eject */</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_WKUP_S4_BAYEJ</span>: <span class="cm">/* hibernation, bay eject */</span>
		<span class="n">hotkey_wakeup_reason</span> <span class="o">=</span> <span class="n">TP_ACPI_WAKEUP_BAYEJ</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TP_HKEY_EV_WKUP_S3_BATLOW</span>: <span class="cm">/* Battery on critical low level/S3 */</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_WKUP_S4_BATLOW</span>: <span class="cm">/* Battery on critical low level/S4 */</span>
		<span class="n">pr_alert</span><span class="p">(</span><span class="s">&quot;EMERGENCY WAKEUP: battery almost empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* how to auto-heal: */</span>
		<span class="cm">/* 2313: woke up from S3, go to S4/S5 */</span>
		<span class="cm">/* 2413: woke up from S4, go to S5 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_wakeup_reason</span> <span class="o">!=</span> <span class="n">TP_ACPI_WAKEUP_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;woke up due to a hot-unplug request...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hotkey_wakeup_reason_notify_change</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hotkey_notify_dockevent</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">hkey</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">send_acpi_ev</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">ignore_acpi_ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 0x4000-0x4FFF: dock-related events */</span>
	<span class="o">*</span><span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hkey</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_UNDOCK_ACK</span>:
		<span class="cm">/* ACPI undock operation completed after wakeup */</span>
		<span class="n">hotkey_autosleep_ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;undocked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hotkey_wakeup_hotunplug_complete_notify_change</span><span class="p">();</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TP_HKEY_EV_HOTPLUG_DOCK</span>: <span class="cm">/* docked to port replicator */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;docked into hotplug port replicator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_HOTPLUG_UNDOCK</span>: <span class="cm">/* undocked from port replicator */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;undocked from hotplug port replicator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hotkey_notify_usrevent</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">hkey</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">send_acpi_ev</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">ignore_acpi_ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 0x5000-0x5FFF: human interface helpers */</span>
	<span class="o">*</span><span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hkey</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_PEN_INSERTED</span>:  <span class="cm">/* X61t: tablet pen inserted into bay */</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_PEN_REMOVED</span>:   <span class="cm">/* X61t: tablet pen removed from bay */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TP_HKEY_EV_TABLET_TABLET</span>:   <span class="cm">/* X41t-X61t: tablet mode */</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_TABLET_NOTEBOOK</span>: <span class="cm">/* X41t-X61t: normal mode */</span>
		<span class="n">tpacpi_input_send_tabletsw</span><span class="p">();</span>
		<span class="n">hotkey_tablet_mode_notify_change</span><span class="p">();</span>
		<span class="o">*</span><span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TP_HKEY_EV_LID_CLOSE</span>:	<span class="cm">/* Lid closed */</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_LID_OPEN</span>:	<span class="cm">/* Lid opened */</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_BRGHT_CHANGED</span>:	<span class="cm">/* brightness changed */</span>
		<span class="cm">/* do not propagate these events */</span>
		<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">thermal_dump_all_sensors</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hotkey_notify_6xxx</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">hkey</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">send_acpi_ev</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="o">*</span><span class="n">ignore_acpi_ev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">known</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* 0x6000-0x6FFF: thermal alarms/notices and keyboard events */</span>
	<span class="o">*</span><span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hkey</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_THM_TABLE_CHANGED</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;EC reports that Thermal Table has changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* recommended action: do nothing, we don&#39;t have</span>
<span class="cm">		 * Lenovo ATM information */</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_ALARM_BAT_HOT</span>:
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;THERMAL ALARM: battery is too hot!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* recommended action: warn user through gui */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_ALARM_BAT_XHOT</span>:
		<span class="n">pr_alert</span><span class="p">(</span><span class="s">&quot;THERMAL EMERGENCY: battery is extremely hot!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* recommended action: immediate sleep/hibernate */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_ALARM_SENSOR_HOT</span>:
		<span class="n">pr_crit</span><span class="p">(</span><span class="s">&quot;THERMAL ALARM: &quot;</span>
			<span class="s">&quot;a sensor reports something is too hot!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* recommended action: warn user through gui, that */</span>
		<span class="cm">/* some internal component is too hot */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TP_HKEY_EV_ALARM_SENSOR_XHOT</span>:
		<span class="n">pr_alert</span><span class="p">(</span><span class="s">&quot;THERMAL EMERGENCY: &quot;</span>
			 <span class="s">&quot;a sensor reports something is extremely hot!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* recommended action: immediate sleep/hibernate */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TP_HKEY_EV_KEY_NUMLOCK</span>:
	<span class="k">case</span> <span class="n">TP_HKEY_EV_KEY_FN</span>:
		<span class="cm">/* key press events, we just ignore them as long as the EC</span>
<span class="cm">		 * is still reporting them in the normal keyboard stream */</span>
		<span class="o">*</span><span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;unknown possible thermal alarm or keyboard event received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">known</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">thermal_dump_all_sensors</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">known</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hkey</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">send_acpi_ev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ignore_acpi_ev</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">known_ev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unknown HKEY notification event %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="cm">/* forward it to userspace, maybe it knows how to handle it */</span>
		<span class="n">acpi_bus_generate_netlink_event</span><span class="p">(</span>
					<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">device_class</span><span class="p">,</span>
					<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
					<span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hkey</span><span class="p">,</span> <span class="s">&quot;MHKP&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to retrieve HKEY event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hkey</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* queue empty */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">ignore_acpi_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">hkey</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* 0x1000-0x1FFF: key presses */</span>
			<span class="n">known_ev</span> <span class="o">=</span> <span class="n">hotkey_notify_hotkey</span><span class="p">(</span><span class="n">hkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_acpi_ev</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">ignore_acpi_ev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="cm">/* 0x2000-0x2FFF: Wakeup reason */</span>
			<span class="n">known_ev</span> <span class="o">=</span> <span class="n">hotkey_notify_wakeup</span><span class="p">(</span><span class="n">hkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_acpi_ev</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">ignore_acpi_ev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="cm">/* 0x3000-0x3FFF: bay-related wakeups */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">hkey</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">TP_HKEY_EV_BAYEJ_ACK</span>:
				<span class="n">hotkey_autosleep_ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;bay ejected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">hotkey_wakeup_hotunplug_complete_notify_change</span><span class="p">();</span>
				<span class="n">known_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">TP_HKEY_EV_OPTDRV_EJ</span>:
				<span class="cm">/* FIXME: kick libata if SATA link offline */</span>
				<span class="n">known_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">known_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="cm">/* 0x4000-0x4FFF: dock-related events */</span>
			<span class="n">known_ev</span> <span class="o">=</span> <span class="n">hotkey_notify_dockevent</span><span class="p">(</span><span class="n">hkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_acpi_ev</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ignore_acpi_ev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="cm">/* 0x5000-0x5FFF: human interface helpers */</span>
			<span class="n">known_ev</span> <span class="o">=</span> <span class="n">hotkey_notify_usrevent</span><span class="p">(</span><span class="n">hkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_acpi_ev</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">ignore_acpi_ev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="cm">/* 0x6000-0x6FFF: thermal alarms/notices and</span>
<span class="cm">			 *                keyboard events */</span>
			<span class="n">known_ev</span> <span class="o">=</span> <span class="n">hotkey_notify_6xxx</span><span class="p">(</span><span class="n">hkey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">send_acpi_ev</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">ignore_acpi_ev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="cm">/* 0x7000-0x7FFF: misc */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey_wlsw</span> <span class="o">&amp;&amp;</span>
					<span class="n">hkey</span> <span class="o">==</span> <span class="n">TP_HKEY_EV_RFKILL_CHANGED</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tpacpi_send_radiosw_update</span><span class="p">();</span>
				<span class="n">send_acpi_ev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">known_ev</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fallthrough to default */</span>
		<span class="nl">default:</span>
			<span class="n">known_ev</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">known_ev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;unhandled HKEY event 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hkey</span><span class="p">);</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;please report the conditions when this &quot;</span>
				  <span class="s">&quot;event happened to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_MAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Legacy events */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_acpi_ev</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">send_acpi_ev</span> <span class="o">||</span> <span class="n">hotkey_report_mode</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">acpi_bus_generate_proc_event</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span>
						     <span class="n">event</span><span class="p">,</span> <span class="n">hkey</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* netlink events */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_acpi_ev</span> <span class="o">&amp;&amp;</span> <span class="n">send_acpi_ev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">acpi_bus_generate_netlink_event</span><span class="p">(</span>
					<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">device_class</span><span class="p">,</span>
					<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span>
					<span class="n">event</span><span class="p">,</span> <span class="n">hkey</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_suspend</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Do these on suspend, we get the events on early resume! */</span>
	<span class="n">hotkey_wakeup_reason</span> <span class="o">=</span> <span class="n">TP_ACPI_WAKEUP_NONE</span><span class="p">;</span>
	<span class="n">hotkey_autosleep_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_disable_brightness_delay</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_status_set</span><span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">hotkey_mask_set</span><span class="p">(</span><span class="n">hotkey_acpi_mask</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error while attempting to reset the event &quot;</span>
		       <span class="s">&quot;firmware interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tpacpi_send_radiosw_update</span><span class="p">();</span>
	<span class="n">hotkey_tablet_mode_notify_change</span><span class="p">();</span>
	<span class="n">hotkey_wakeup_reason_notify_change</span><span class="p">();</span>
	<span class="n">hotkey_wakeup_hotunplug_complete_notify_change</span><span class="p">();</span>
	<span class="n">hotkey_poll_setup_safe</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* procfs -------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_status_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_mask_get</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_all_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;mask:</span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hotkey_user_mask</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">enable, disable, reset, &lt;mask&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;mask:</span><span class="se">\t\t</span><span class="s">not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">enable, disable, reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_enabledisable_warn</span><span class="p">(</span><span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_log_usertask</span><span class="p">(</span><span class="s">&quot;procfs hotkey enable/disable&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WARN</span><span class="p">((</span><span class="n">tpacpi_lifecycle</span> <span class="o">==</span> <span class="n">TPACPI_LIFE_RUNNING</span> <span class="o">||</span> <span class="o">!</span><span class="n">enable</span><span class="p">),</span>
		  <span class="n">pr_fmt</span><span class="p">(</span><span class="s">&quot;hotkey enable/disable functionality has been &quot;</span>
			 <span class="s">&quot;removed from the driver.  &quot;</span>
			 <span class="s">&quot;Hotkeys are always enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Please remove the hotkey=enable module &quot;</span>
		       <span class="s">&quot;parameter, it is deprecated.  &quot;</span>
		       <span class="s">&quot;Hotkeys are always enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hotkey_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">hotkey</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">hotkey_user_mask</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;enable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hotkey_enabledisable_warn</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hotkey_enabledisable_warn</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">hotkey_all_mask</span> <span class="o">|</span> <span class="n">hotkey_source_mask</span><span class="p">)</span>
				<span class="o">&amp;</span> <span class="o">~</span><span class="n">hotkey_reserved_mask</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;0x%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* mask set */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* mask set */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">errexit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs hotkey&quot;</span><span class="p">,</span>
			<span class="s">&quot;set mask to 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hotkey_user_mask_set</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">errexit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hotkey_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="n">ibm_htk_device_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">TPACPI_ACPI_IBM_HKEY_HID</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">TPACPI_ACPI_LENOVO_HKEY_HID</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tp_acpi_drv_struct</span> <span class="n">ibm_hotkey_acpidriver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">hid</span> <span class="o">=</span> <span class="n">ibm_htk_device_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notify</span> <span class="o">=</span> <span class="n">hotkey_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hkey_handle</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_DEVICE_NOTIFY</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">hotkey_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hotkey&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">hotkey_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">hotkey_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">hotkey_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">hotkey_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">hotkey_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">acpi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ibm_hotkey_acpidriver</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Bluetooth subdriver</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* ACPI GBDC/SBDC bits */</span>
	<span class="n">TP_ACPI_BLUETOOTH_HWPRESENT</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* Bluetooth hw available */</span>
	<span class="n">TP_ACPI_BLUETOOTH_RADIOSSW</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>	<span class="cm">/* Bluetooth radio enabled */</span>
	<span class="n">TP_ACPI_BLUETOOTH_RESUMECTRL</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>	<span class="cm">/* Bluetooth state at resume:</span>
<span class="cm">						   0 = disable, 1 = enable */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* ACPI \BLTH commands */</span>
	<span class="n">TP_ACPI_BLTH_GET_ULTRAPORT_ID</span>	<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span> <span class="cm">/* Get Ultraport BT ID */</span>
	<span class="n">TP_ACPI_BLTH_GET_PWR_ON_RESUME</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span> <span class="cm">/* Get power-on-resume state */</span>
	<span class="n">TP_ACPI_BLTH_PWR_ON_ON_RESUME</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span> <span class="cm">/* Resume powered on */</span>
	<span class="n">TP_ACPI_BLTH_PWR_OFF_ON_RESUME</span>	<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>	<span class="cm">/* Resume powered off */</span>
	<span class="n">TP_ACPI_BLTH_SAVE_STATE</span>		<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span> <span class="cm">/* Save state for S4/S5 */</span>
<span class="p">};</span>

<span class="cp">#define TPACPI_RFK_BLUETOOTH_SW_NAME	&quot;tpacpi_bluetooth_sw&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bluetooth_get_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_bluetoothemul</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">tpacpi_bluetooth_emulstate</span><span class="p">)</span> <span class="o">?</span>
		       <span class="n">TPACPI_RFK_RADIO_ON</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;GBDC&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_ACPI_BLUETOOTH_RADIOSSW</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">TPACPI_RFK_RADIO_ON</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bluetooth_set_status</span><span class="p">(</span><span class="k">enum</span> <span class="n">tpacpi_rfkill_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
		<span class="s">&quot;will attempt to %s bluetooth</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_bluetoothemul</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpacpi_bluetooth_emulstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TP_ACPI_BLUETOOTH_RADIOSSW</span>
			  <span class="o">|</span> <span class="n">TP_ACPI_BLUETOOTH_RESUMECTRL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;SBDC&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sysfs bluetooth enable ---------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bluetooth_enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpacpi_rfk_sysfs_enable_show</span><span class="p">(</span><span class="n">TPACPI_RFK_BLUETOOTH_SW_ID</span><span class="p">,</span>
			<span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bluetooth_enable_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpacpi_rfk_sysfs_enable_store</span><span class="p">(</span><span class="n">TPACPI_RFK_BLUETOOTH_SW_ID</span><span class="p">,</span>
				<span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_bluetooth_enable</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">bluetooth_enable</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">bluetooth_enable_show</span><span class="p">,</span> <span class="n">bluetooth_enable_store</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">bluetooth_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_bluetooth_enable</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">bluetooth_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">bluetooth_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_rfk_ops</span> <span class="n">bluetooth_tprfk_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_status</span> <span class="o">=</span> <span class="n">bluetooth_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_status</span> <span class="o">=</span> <span class="n">bluetooth_set_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bluetooth_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Order firmware to save current state to NVRAM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">BLTH&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span>
			<span class="n">TP_ACPI_BLTH_SAVE_STATE</span><span class="p">))</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;failed to save bluetooth state to NVRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
			<span class="s">&quot;bluetooth state saved to NVRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bluetooth_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">bluetooth_attr_group</span><span class="p">);</span>

	<span class="n">tpacpi_destroy_rfkill</span><span class="p">(</span><span class="n">TPACPI_RFK_BLUETOOTH_SW_ID</span><span class="p">);</span>

	<span class="n">bluetooth_shutdown</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bluetooth_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
			<span class="s">&quot;initializing bluetooth subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">hkey</span><span class="p">);</span>

	<span class="cm">/* bluetooth not supported on 570, 600e/x, 770e, 770x, A21e, A2xm/p,</span>
<span class="cm">	   G4x, R30, R31, R40e, R50e, T20-22, X20-21 */</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">bluetooth</span> <span class="o">=</span> <span class="n">hkey_handle</span> <span class="o">&amp;&amp;</span>
	    <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;GBDC&quot;</span><span class="p">,</span> <span class="s">&quot;qd&quot;</span><span class="p">);</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
		<span class="s">&quot;bluetooth is %s, status 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">bluetooth</span><span class="p">),</span>
		<span class="n">status</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_bluetoothemul</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">bluetooth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;bluetooth switch emulation enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">bluetooth</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_ACPI_BLUETOOTH_HWPRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no bluetooth hardware present in system */</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">bluetooth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
			   <span class="s">&quot;bluetooth hardware not installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">bluetooth</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">tpacpi_new_rfkill</span><span class="p">(</span><span class="n">TPACPI_RFK_BLUETOOTH_SW_ID</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">bluetooth_tprfk_ops</span><span class="p">,</span>
				<span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">,</span>
				<span class="n">TPACPI_RFK_BLUETOOTH_SW_NAME</span><span class="p">,</span>
				<span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">bluetooth_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpacpi_destroy_rfkill</span><span class="p">(</span><span class="n">TPACPI_RFK_BLUETOOTH_SW_ID</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* procfs -------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bluetooth_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpacpi_rfk_procfs_read</span><span class="p">(</span><span class="n">TPACPI_RFK_BLUETOOTH_SW_ID</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bluetooth_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpacpi_rfk_procfs_write</span><span class="p">(</span><span class="n">TPACPI_RFK_BLUETOOTH_SW_ID</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">bluetooth_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bluetooth&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">bluetooth_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">bluetooth_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">bluetooth_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">bluetooth_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Wan subdriver</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* ACPI GWAN/SWAN bits */</span>
	<span class="n">TP_ACPI_WANCARD_HWPRESENT</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* Wan hw available */</span>
	<span class="n">TP_ACPI_WANCARD_RADIOSSW</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>	<span class="cm">/* Wan radio enabled */</span>
	<span class="n">TP_ACPI_WANCARD_RESUMECTRL</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>	<span class="cm">/* Wan state at resume:</span>
<span class="cm">						   0 = disable, 1 = enable */</span>
<span class="p">};</span>

<span class="cp">#define TPACPI_RFK_WWAN_SW_NAME		&quot;tpacpi_wwan_sw&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wan_get_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_wwanemul</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">tpacpi_wwan_emulstate</span><span class="p">)</span> <span class="o">?</span>
		       <span class="n">TPACPI_RFK_RADIO_ON</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;GWAN&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_ACPI_WANCARD_RADIOSSW</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">TPACPI_RFK_RADIO_ON</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wan_set_status</span><span class="p">(</span><span class="k">enum</span> <span class="n">tpacpi_rfkill_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
		<span class="s">&quot;will attempt to %s wwan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_wwanemul</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpacpi_wwan_emulstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TP_ACPI_WANCARD_RADIOSSW</span>
			 <span class="o">|</span> <span class="n">TP_ACPI_WANCARD_RESUMECTRL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;SWAN&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sysfs wan enable ---------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wan_enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpacpi_rfk_sysfs_enable_show</span><span class="p">(</span><span class="n">TPACPI_RFK_WWAN_SW_ID</span><span class="p">,</span>
			<span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">wan_enable_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpacpi_rfk_sysfs_enable_store</span><span class="p">(</span><span class="n">TPACPI_RFK_WWAN_SW_ID</span><span class="p">,</span>
			<span class="n">attr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_wan_enable</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">wwan_enable</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">wan_enable_show</span><span class="p">,</span> <span class="n">wan_enable_store</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">wan_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wan_enable</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">wan_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">wan_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_rfk_ops</span> <span class="n">wan_tprfk_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_status</span> <span class="o">=</span> <span class="n">wan_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_status</span> <span class="o">=</span> <span class="n">wan_set_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wan_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Order firmware to save current state to NVRAM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">WGSV&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span>
			<span class="n">TP_ACPI_WGSV_SAVE_STATE</span><span class="p">))</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;failed to save WWAN state to NVRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
			<span class="s">&quot;WWAN state saved to NVRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wan_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">wan_attr_group</span><span class="p">);</span>

	<span class="n">tpacpi_destroy_rfkill</span><span class="p">(</span><span class="n">TPACPI_RFK_WWAN_SW_ID</span><span class="p">);</span>

	<span class="n">wan_shutdown</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">wan_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
			<span class="s">&quot;initializing wan subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">hkey</span><span class="p">);</span>

	<span class="n">tp_features</span><span class="p">.</span><span class="n">wan</span> <span class="o">=</span> <span class="n">hkey_handle</span> <span class="o">&amp;&amp;</span>
	    <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;GWAN&quot;</span><span class="p">,</span> <span class="s">&quot;qd&quot;</span><span class="p">);</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
		<span class="s">&quot;wan is %s, status 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">wan</span><span class="p">),</span>
		<span class="n">status</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_wwanemul</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">wan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;wwan switch emulation enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">wan</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_ACPI_WANCARD_HWPRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no wan hardware present in system */</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">wan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
			   <span class="s">&quot;wan hardware not installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">wan</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">tpacpi_new_rfkill</span><span class="p">(</span><span class="n">TPACPI_RFK_WWAN_SW_ID</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">wan_tprfk_ops</span><span class="p">,</span>
				<span class="n">RFKILL_TYPE_WWAN</span><span class="p">,</span>
				<span class="n">TPACPI_RFK_WWAN_SW_NAME</span><span class="p">,</span>
				<span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">wan_attr_group</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpacpi_destroy_rfkill</span><span class="p">(</span><span class="n">TPACPI_RFK_WWAN_SW_ID</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* procfs -------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wan_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpacpi_rfk_procfs_read</span><span class="p">(</span><span class="n">TPACPI_RFK_WWAN_SW_ID</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wan_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tpacpi_rfk_procfs_write</span><span class="p">(</span><span class="n">TPACPI_RFK_WWAN_SW_ID</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">wan_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;wan&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">wan_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">wan_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">wan_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">wan_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * UWB subdriver</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="cm">/* ACPI GUWB/SUWB bits */</span>
	<span class="n">TP_ACPI_UWB_HWPRESENT</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* UWB hw available */</span>
	<span class="n">TP_ACPI_UWB_RADIOSSW</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>	<span class="cm">/* UWB radio enabled */</span>
<span class="p">};</span>

<span class="cp">#define TPACPI_RFK_UWB_SW_NAME	&quot;tpacpi_uwb_sw&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uwb_get_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_uwbemul</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">tpacpi_uwb_emulstate</span><span class="p">)</span> <span class="o">?</span>
		       <span class="n">TPACPI_RFK_RADIO_ON</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;GUWB&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_ACPI_UWB_RADIOSSW</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">TPACPI_RFK_RADIO_ON</span> <span class="o">:</span> <span class="n">TPACPI_RFK_RADIO_OFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uwb_set_status</span><span class="p">(</span><span class="k">enum</span> <span class="n">tpacpi_rfkill_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
		<span class="s">&quot;will attempt to %s UWB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_uwbemul</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpacpi_uwb_emulstate</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TPACPI_RFK_RADIO_ON</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TP_ACPI_UWB_RADIOSSW</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;SUWB&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_rfk_ops</span> <span class="n">uwb_tprfk_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_status</span> <span class="o">=</span> <span class="n">uwb_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_status</span> <span class="o">=</span> <span class="n">uwb_set_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uwb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_destroy_rfkill</span><span class="p">(</span><span class="n">TPACPI_RFK_UWB_SW_ID</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">uwb_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
			<span class="s">&quot;initializing uwb subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">hkey</span><span class="p">);</span>

	<span class="n">tp_features</span><span class="p">.</span><span class="n">uwb</span> <span class="o">=</span> <span class="n">hkey_handle</span> <span class="o">&amp;&amp;</span>
	    <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">hkey_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;GUWB&quot;</span><span class="p">,</span> <span class="s">&quot;qd&quot;</span><span class="p">);</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_RFKILL</span><span class="p">,</span>
		<span class="s">&quot;uwb is %s, status 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">uwb</span><span class="p">),</span>
		<span class="n">status</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dbg_uwbemul</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">uwb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;uwb switch emulation enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">uwb</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_ACPI_UWB_HWPRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* no uwb hardware present in system */</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">uwb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
			   <span class="s">&quot;uwb hardware not installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">uwb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">tpacpi_new_rfkill</span><span class="p">(</span><span class="n">TPACPI_RFK_UWB_SW_ID</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">uwb_tprfk_ops</span><span class="p">,</span>
				<span class="n">RFKILL_TYPE_UWB</span><span class="p">,</span>
				<span class="n">TPACPI_RFK_UWB_SW_NAME</span><span class="p">,</span>
				<span class="nb">false</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">uwb_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;uwb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">uwb_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span><span class="p">.</span><span class="n">experimental</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Video subdriver</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_VIDEO</span>

<span class="k">enum</span> <span class="n">video_access_mode</span> <span class="p">{</span>
	<span class="n">TPACPI_VIDEO_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TPACPI_VIDEO_570</span><span class="p">,</span>	<span class="cm">/* 570 */</span>
	<span class="n">TPACPI_VIDEO_770</span><span class="p">,</span>	<span class="cm">/* 600e/x, 770e, 770x */</span>
	<span class="n">TPACPI_VIDEO_NEW</span><span class="p">,</span>	<span class="cm">/* all others */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>	<span class="cm">/* video status flags, based on VIDEO_570 */</span>
	<span class="n">TP_ACPI_VIDEO_S_LCD</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* LCD output enabled */</span>
	<span class="n">TP_ACPI_VIDEO_S_CRT</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>	<span class="cm">/* CRT output enabled */</span>
	<span class="n">TP_ACPI_VIDEO_S_DVI</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>	<span class="cm">/* DVI output enabled */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>  <span class="cm">/* TPACPI_VIDEO_570 constants */</span>
	<span class="n">TP_ACPI_VIDEO_570_PHSCMD</span> <span class="o">=</span> <span class="mh">0x87</span><span class="p">,</span>	<span class="cm">/* unknown magic constant :( */</span>
	<span class="n">TP_ACPI_VIDEO_570_PHSMASK</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>	<span class="cm">/* PHS bits that map to</span>
<span class="cm">						 * video_status_flags */</span>
	<span class="n">TP_ACPI_VIDEO_570_PHS2CMD</span> <span class="o">=</span> <span class="mh">0x8b</span><span class="p">,</span>	<span class="cm">/* unknown magic constant :( */</span>
	<span class="n">TP_ACPI_VIDEO_570_PHS2SET</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>	<span class="cm">/* unknown magic constant :( */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">video_access_mode</span> <span class="n">video_supported</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_orig_autosw</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">video_autosw_get</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_autosw_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>

<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">vid</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span>
	      <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PCI.AGP.VGA&quot;</span><span class="p">,</span>	<span class="cm">/* 570 */</span>
	      <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PCI0.AGP0.VID0&quot;</span><span class="p">,</span>	<span class="cm">/* 600e/x, 770x */</span>
	      <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PCI0.VID0&quot;</span><span class="p">,</span>	<span class="cm">/* 770e */</span>
	      <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PCI0.VID&quot;</span><span class="p">,</span>		<span class="cm">/* A21e, G4x, R50e, X30, X40 */</span>
	      <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PCI0.AGP.VGA&quot;</span><span class="p">,</span>	<span class="cm">/* X100e and a few others */</span>
	      <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PCI0.AGP.VID&quot;</span><span class="p">,</span>	<span class="cm">/* all others */</span>
	<span class="p">);</span>				<span class="cm">/* R30, R31 */</span>

<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">vid2</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PCI0.AGPB.VID&quot;</span><span class="p">);</span>	<span class="cm">/* G41 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">video_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ivga</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;initializing video subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">vid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_is_ibm</span><span class="p">())</span>
		<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">vid2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vid2_handle</span> <span class="o">&amp;&amp;</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivga</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">IVGA&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ivga</span><span class="p">)</span>
		<span class="cm">/* G41, assume IVGA doesn&#39;t change */</span>
		<span class="n">vid_handle</span> <span class="o">=</span> <span class="n">vid2_handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vid_handle</span><span class="p">)</span>
		<span class="cm">/* video switching not supported on R30, R31 */</span>
		<span class="n">video_supported</span> <span class="o">=</span> <span class="n">TPACPI_VIDEO_NONE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_is_ibm</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
		 <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">vid_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_orig_autosw</span><span class="p">,</span> <span class="s">&quot;SWIT&quot;</span><span class="p">,</span> <span class="s">&quot;qd&quot;</span><span class="p">))</span>
		<span class="cm">/* 570 */</span>
		<span class="n">video_supported</span> <span class="o">=</span> <span class="n">TPACPI_VIDEO_570</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_is_ibm</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
		 <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">vid_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_orig_autosw</span><span class="p">,</span> <span class="s">&quot;^VADL&quot;</span><span class="p">,</span> <span class="s">&quot;qd&quot;</span><span class="p">))</span>
		<span class="cm">/* 600e/x, 770e, 770x */</span>
		<span class="n">video_supported</span> <span class="o">=</span> <span class="n">TPACPI_VIDEO_770</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="cm">/* all others */</span>
		<span class="n">video_supported</span> <span class="o">=</span> <span class="n">TPACPI_VIDEO_NEW</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;video is %s, mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">video_supported</span> <span class="o">!=</span> <span class="n">TPACPI_VIDEO_NONE</span><span class="p">),</span>
		<span class="n">video_supported</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">video_supported</span> <span class="o">!=</span> <span class="n">TPACPI_VIDEO_NONE</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">video_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_EXIT</span><span class="p">,</span>
		   <span class="s">&quot;restoring original video autoswitch mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_autosw_set</span><span class="p">(</span><span class="n">video_orig_autosw</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;error while trying to restore original &quot;</span>
			<span class="s">&quot;video autoswitch mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_outputsw_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">video_supported</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_570</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PHS&quot;</span><span class="p">,</span> <span class="s">&quot;dd&quot;</span><span class="p">,</span>
				 <span class="n">TP_ACPI_VIDEO_570_PHSCMD</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="n">TP_ACPI_VIDEO_570_PHSMASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_770</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VCDL&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_LCD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VCDC&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_CRT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_NEW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VUPS&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VCDC&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_CRT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VUPS&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VCDL&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_LCD</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VCDD&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_DVI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_outputsw_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">autosw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">video_supported</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_570</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PHS2&quot;</span><span class="p">,</span> <span class="s">&quot;vdd&quot;</span><span class="p">,</span>
				 <span class="n">TP_ACPI_VIDEO_570_PHS2CMD</span><span class="p">,</span>
				 <span class="n">status</span> <span class="o">|</span> <span class="n">TP_ACPI_VIDEO_570_PHS2SET</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_770</span>:
		<span class="n">autosw</span> <span class="o">=</span> <span class="n">video_autosw_get</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">autosw</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">autosw</span><span class="p">;</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">video_autosw_set</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">vid_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="s">&quot;ASWT&quot;</span><span class="p">,</span> <span class="s">&quot;vdd&quot;</span><span class="p">,</span> <span class="n">status</span> <span class="o">*</span> <span class="mh">0x100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autosw</span> <span class="o">&amp;&amp;</span> <span class="n">video_autosw_set</span><span class="p">(</span><span class="n">autosw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;video auto-switch left enabled due to error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_NEW</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VUPS&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VSDS&quot;</span><span class="p">,</span> <span class="s">&quot;vdd&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_autosw_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">autosw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">video_supported</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_570</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">vid_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">autosw</span><span class="p">,</span> <span class="s">&quot;SWIT&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_770</span>:
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_NEW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">vid_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">autosw</span><span class="p">,</span> <span class="s">&quot;^VDEE&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">autosw</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_autosw_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">vid_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;_DOS&quot;</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_outputsw_cycle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">autosw</span> <span class="o">=</span> <span class="n">video_autosw_get</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">autosw</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">autosw</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">video_supported</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_570</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">video_autosw_set</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;_Q16&quot;</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_770</span>:
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_NEW</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">video_autosw_set</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">vid_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;VSWT&quot;</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autosw</span> <span class="o">&amp;&amp;</span> <span class="n">video_autosw_set</span><span class="p">(</span><span class="n">autosw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;video auto-switch left enabled due to error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_expand_toggle</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">video_supported</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_570</span>:
		<span class="k">return</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;_Q17&quot;</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">)</span><span class="o">?</span>
			<span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_770</span>:
		<span class="k">return</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">vid_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;VEXP&quot;</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">)</span><span class="o">?</span>
			<span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VIDEO_NEW</span>:
		<span class="k">return</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">VEXP&quot;</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">)</span><span class="o">?</span>
			<span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* not reached */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">autosw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_supported</span> <span class="o">==</span> <span class="n">TPACPI_VIDEO_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Even reads can crash X.org, so... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">video_outputsw_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">autosw</span> <span class="o">=</span> <span class="n">video_autosw_get</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autosw</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">autosw</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;lcd:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;crt:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_supported</span> <span class="o">==</span> <span class="n">TPACPI_VIDEO_NEW</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;dvi:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;auto:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="p">(</span><span class="n">autosw</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">lcd_enable, lcd_disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">crt_enable, crt_disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_supported</span> <span class="o">==</span> <span class="n">TPACPI_VIDEO_NEW</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">dvi_enable, dvi_disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">auto_enable, auto_disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">video_switch, expand_toggle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable</span><span class="p">,</span> <span class="n">disable</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video_supported</span> <span class="o">==</span> <span class="n">TPACPI_VIDEO_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Even reads can crash X.org, let alone writes... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">enable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;lcd_enable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enable</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_LCD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;lcd_disable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disable</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_LCD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;crt_enable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enable</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_CRT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;crt_disable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disable</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_CRT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">video_supported</span> <span class="o">==</span> <span class="n">TPACPI_VIDEO_NEW</span> <span class="o">&amp;&amp;</span>
			   <span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;dvi_enable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">enable</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_DVI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">video_supported</span> <span class="o">==</span> <span class="n">TPACPI_VIDEO_NEW</span> <span class="o">&amp;&amp;</span>
			   <span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;dvi_disable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">disable</span> <span class="o">|=</span> <span class="n">TP_ACPI_VIDEO_S_DVI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;auto_enable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">video_autosw_set</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;auto_disable&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">video_autosw_set</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;video_switch&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">video_outputsw_cycle</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;expand_toggle&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">video_expand_toggle</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">||</span> <span class="n">disable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">video_outputsw_get</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">video_outputsw_set</span><span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">disable</span><span class="p">)</span> <span class="o">|</span> <span class="n">enable</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">video_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;video&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">video_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">video_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">video_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_THINKPAD_ACPI_VIDEO */</span><span class="cp"></span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Light (thinklight) subdriver</span>
<span class="cm"> */</span>

<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">lght</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">LGHT&quot;</span><span class="p">);</span>	<span class="cm">/* A21e, A2xm/p, T20-22, X20-21 */</span>
<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">ledb</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="s">&quot;LEDB&quot;</span><span class="p">);</span>		<span class="cm">/* G4x */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">light_get_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">light_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;KBLT&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">!!</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">light_set_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">light</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmos_handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">cmos_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">?</span>
						<span class="n">TP_CMOS_THINKLIGHT_ON</span> <span class="o">:</span>
						<span class="n">TP_CMOS_THINKLIGHT_OFF</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">lght_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">light_set_status_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacpi_led_classdev</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tpacpi_led_classdev</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tpacpi_lifecycle</span> <span class="o">==</span> <span class="n">TPACPI_LIFE_RUNNING</span><span class="p">))</span>
		<span class="n">light_set_status</span><span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">new_state</span> <span class="o">!=</span> <span class="n">TPACPI_LED_OFF</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">light_sysfs_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacpi_led_classdev</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tpacpi_led_classdev</span><span class="p">,</span>
			     <span class="n">led_classdev</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">new_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">!=</span> <span class="n">LED_OFF</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">TPACPI_LED_ON</span> <span class="o">:</span> <span class="n">TPACPI_LED_OFF</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">tpacpi_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="nf">light_sysfs_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">light_get_status</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span> <span class="n">LED_FULL</span> <span class="o">:</span> <span class="n">LED_OFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tpacpi_led_classdev</span> <span class="n">tpacpi_led_thinklight</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">led_classdev</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;tpacpi::thinklight&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">brightness_set</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">light_sysfs_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">brightness_get</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">light_sysfs_get</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">light_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;initializing light subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_is_ibm</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">ledb</span><span class="p">);</span>
		<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">lght</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">cmos</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_led_thinklight</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="n">light_set_status_worker</span><span class="p">);</span>

	<span class="cm">/* light not supported on 570, 600e/x, 770e, 770x, G4x, R30, R31 */</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">light</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmos_handle</span> <span class="o">||</span> <span class="n">lght_handle</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ledb_handle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">light</span><span class="p">)</span>
		<span class="cm">/* light status not supported on</span>
<span class="cm">		   570, 600e/x, 770e, 770x, G4x, R30, R31, R32, X20 */</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">light_status</span> <span class="o">=</span>
			<span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;KBLT&quot;</span><span class="p">,</span> <span class="s">&quot;qv&quot;</span><span class="p">);</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;light is %s, light status is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">light</span><span class="p">),</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">light_status</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">light</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">tpacpi_led_thinklight</span><span class="p">.</span><span class="n">led_classdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">light</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">light_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>  <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">light_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_led_thinklight</span><span class="p">.</span><span class="n">led_classdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_led_thinklight</span><span class="p">.</span><span class="n">work</span><span class="p">))</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">tpacpi_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">light_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">light</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">light_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">on, off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">light_get_status</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">onoff</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">on, off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">light_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">light</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newstatus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">newstatus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">light_set_status</span><span class="p">(</span><span class="n">newstatus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">light_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;light&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">light_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">light_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">light_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * CMOS subdriver</span>
<span class="cm"> */</span>

<span class="cm">/* sysfs cmos_command -------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">cmos_command_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmos_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmos_cmd</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">issue_thinkpad_cmos_command</span><span class="p">(</span><span class="n">cmos_cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">?</span> <span class="n">res</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_cmos_command</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">cmos_command</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">cmos_command_store</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">cmos_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
		<span class="s">&quot;initializing cmos commands subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">cmos</span><span class="p">);</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;cmos commands are %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">cmos_handle</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_cmos_command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">cmos_handle</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cmos_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_cmos_command</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmos_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* cmos not supported on 570, 600e/x, 770e, 770x, A21e, A2xm/p,</span>
<span class="cm">	   R30, R31, T20-22, X20-21 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmos_handle</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">&lt;cmd&gt; (&lt;cmd&gt; is 0-21)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmos_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmos_cmd</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmos_cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">cmos_cmd</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">cmos_cmd</span> <span class="o">&lt;=</span> <span class="mi">21</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* cmos_cmd set */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">res</span> <span class="o">=</span> <span class="n">issue_thinkpad_cmos_command</span><span class="p">(</span><span class="n">cmos_cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">cmos_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cmos&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">cmos_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">cmos_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">cmos_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * LED subdriver</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">led_access_mode</span> <span class="p">{</span>
	<span class="n">TPACPI_LED_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">TPACPI_LED_570</span><span class="p">,</span>	<span class="cm">/* 570 */</span>
	<span class="n">TPACPI_LED_OLD</span><span class="p">,</span>	<span class="cm">/* 600e/x, 770e, 770x, A21e, A2xm/p, T20-22, X20-21 */</span>
	<span class="n">TPACPI_LED_NEW</span><span class="p">,</span>	<span class="cm">/* all others */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span>	<span class="cm">/* For TPACPI_LED_OLD */</span>
	<span class="n">TPACPI_LED_EC_HLCL</span> <span class="o">=</span> <span class="mh">0x0c</span><span class="p">,</span>	<span class="cm">/* EC reg to get led to power on */</span>
	<span class="n">TPACPI_LED_EC_HLBL</span> <span class="o">=</span> <span class="mh">0x0d</span><span class="p">,</span>	<span class="cm">/* EC reg to blink a lit led */</span>
	<span class="n">TPACPI_LED_EC_HLMS</span> <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>	<span class="cm">/* EC reg to select led to command */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_access_mode</span> <span class="n">led_supported</span><span class="p">;</span>

<span class="k">static</span> <span class="n">acpi_handle</span> <span class="n">led_handle</span><span class="p">;</span>

<span class="cp">#define TPACPI_LED_NUMLEDS 16</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tpacpi_led_classdev</span> <span class="o">*</span><span class="n">tpacpi_leds</span><span class="p">;</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">led_status_t</span> <span class="n">tpacpi_led_state_cache</span><span class="p">[</span><span class="n">TPACPI_LED_NUMLEDS</span><span class="p">];</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tpacpi_led_names</span><span class="p">[</span><span class="n">TPACPI_LED_NUMLEDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* there&#39;s a limit of 19 chars + NULL before 2.6.26 */</span>
	<span class="s">&quot;tpacpi::power&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi:orange:batt&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi:green:batt&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::dock_active&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::bay_active&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::dock_batt&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::unknown_led&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::standby&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::dock_status1&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::dock_status2&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::unknown_led2&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::unknown_led3&quot;</span><span class="p">,</span>
	<span class="s">&quot;tpacpi::thinkvantage&quot;</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#define TPACPI_SAFE_LEDS	0x1081U</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">tpacpi_is_led_restricted</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_UNSAFE_LEDS</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TPACPI_SAFE_LEDS</span> <span class="o">&gt;&gt;</span> <span class="n">led</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_get_status</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">led_status_t</span> <span class="n">led_s</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">led_supported</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_LED_570</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="s">&quot;GLED&quot;</span><span class="p">,</span> <span class="s">&quot;dd&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">led</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">led_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">?</span>
				<span class="n">TPACPI_LED_OFF</span> <span class="o">:</span>
				<span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">?</span>
					<span class="n">TPACPI_LED_ON</span> <span class="o">:</span>
					<span class="n">TPACPI_LED_BLINK</span><span class="p">);</span>
		<span class="n">tpacpi_led_state_cache</span><span class="p">[</span><span class="n">led</span><span class="p">]</span> <span class="o">=</span> <span class="n">led_s</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">led_s</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* not reached */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_set_status</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">enum</span> <span class="n">led_status_t</span> <span class="n">ledstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* off, on, blink. Index is led_status_t */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led_sled_arg1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led_led_arg1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xc0</span> <span class="p">};</span>

	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">led_supported</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_LED_570</span>:
		<span class="cm">/* 570 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">led</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tpacpi_is_led_restricted</span><span class="p">(</span><span class="n">led</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">led_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vdd&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">led</span><span class="p">),</span> <span class="n">led_sled_arg1</span><span class="p">[</span><span class="n">ledstatus</span><span class="p">]))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_LED_OLD</span>:
		<span class="cm">/* 600e/x, 770e, 770x, A21e, A2xm/p, T20-22, X20 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">led</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tpacpi_is_led_restricted</span><span class="p">(</span><span class="n">led</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ec_write</span><span class="p">(</span><span class="n">TPACPI_LED_EC_HLMS</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">led</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ec_write</span><span class="p">(</span><span class="n">TPACPI_LED_EC_HLBL</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">ledstatus</span> <span class="o">==</span> <span class="n">TPACPI_LED_BLINK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">led</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ec_write</span><span class="p">(</span><span class="n">TPACPI_LED_EC_HLCL</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">ledstatus</span> <span class="o">!=</span> <span class="n">TPACPI_LED_OFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">led</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_LED_NEW</span>:
		<span class="cm">/* all others */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">led</span> <span class="o">&gt;=</span> <span class="n">TPACPI_LED_NUMLEDS</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tpacpi_is_led_restricted</span><span class="p">(</span><span class="n">led</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">led_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vdd&quot;</span><span class="p">,</span>
				<span class="n">led</span><span class="p">,</span> <span class="n">led_led_arg1</span><span class="p">[</span><span class="n">ledstatus</span><span class="p">]))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">tpacpi_led_state_cache</span><span class="p">[</span><span class="n">led</span><span class="p">]</span> <span class="o">=</span> <span class="n">ledstatus</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">led_set_status_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacpi_led_classdev</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tpacpi_led_classdev</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tpacpi_lifecycle</span> <span class="o">==</span> <span class="n">TPACPI_LIFE_RUNNING</span><span class="p">))</span>
		<span class="n">led_set_status</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">new_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">led_sysfs_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacpi_led_classdev</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tpacpi_led_classdev</span><span class="p">,</span> <span class="n">led_classdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">==</span> <span class="n">LED_OFF</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">new_state</span> <span class="o">=</span> <span class="n">TPACPI_LED_OFF</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_led_state_cache</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TPACPI_LED_BLINK</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">new_state</span> <span class="o">=</span> <span class="n">TPACPI_LED_ON</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">new_state</span> <span class="o">=</span> <span class="n">TPACPI_LED_BLINK</span><span class="p">;</span>

	<span class="n">queue_work</span><span class="p">(</span><span class="n">tpacpi_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_sysfs_blink_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">delay_on</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">delay_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacpi_led_classdev</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tpacpi_led_classdev</span><span class="p">,</span> <span class="n">led_classdev</span><span class="p">);</span>

	<span class="cm">/* Can we choose the flash rate? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">delay_on</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">delay_off</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* yes. set them to the hardware blink rate (1 Hz) */</span>
		<span class="o">*</span><span class="n">delay_on</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="o">*</span><span class="n">delay_off</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span> <span class="cm">/* ms */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">delay_on</span> <span class="o">!=</span> <span class="mi">500</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">delay_off</span> <span class="o">!=</span> <span class="mi">500</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">new_state</span> <span class="o">=</span> <span class="n">TPACPI_LED_BLINK</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">tpacpi_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="nf">led_sysfs_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">tpacpi_led_classdev</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">tpacpi_led_classdev</span><span class="p">,</span> <span class="n">led_classdev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">led_get_status</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">TPACPI_LED_OFF</span> <span class="o">||</span> <span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>	<span class="cm">/* no error handling in led class :( */</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">LED_FULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">led_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPACPI_LED_NUMLEDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_classdev</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
			<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">led_classdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">tpacpi_leds</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tpacpi_init_led</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">led</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led</span> <span class="o">=</span> <span class="n">led</span><span class="p">;</span>

	<span class="cm">/* LEDs with no name don&#39;t get registered */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpacpi_led_names</span><span class="p">[</span><span class="n">led</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led_classdev</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">led_sysfs_set</span><span class="p">;</span>
	<span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led_classdev</span><span class="p">.</span><span class="n">blink_set</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">led_sysfs_blink_set</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">led_supported</span> <span class="o">==</span> <span class="n">TPACPI_LED_570</span><span class="p">)</span>
		<span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led_classdev</span><span class="p">.</span><span class="n">brightness_get</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">led_sysfs_get</span><span class="p">;</span>

	<span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led_classdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">tpacpi_led_names</span><span class="p">[</span><span class="n">led</span><span class="p">];</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">work</span><span class="p">,</span> <span class="n">led_set_status_worker</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led_classdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tpacpi_leds</span><span class="p">[</span><span class="n">led</span><span class="p">].</span><span class="n">led_classdev</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="n">led_useful_qtable</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="mh">0x009f</span><span class="p">),</span> <span class="cm">/* A30 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="mh">0x009f</span><span class="p">),</span> <span class="cm">/* A31 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span> <span class="mh">0x009f</span><span class="p">),</span> <span class="cm">/* A31 */</span>

	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">),</span> <span class="cm">/* T30 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">),</span> <span class="cm">/* T40, T41, T42, R50, R51 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">),</span> <span class="cm">/* T43, R52 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">),</span> <span class="cm">/* T43 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;W&#39;</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">),</span> <span class="cm">/* R50e */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">),</span> <span class="cm">/* R51 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">),</span> <span class="cm">/* R51e */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="mh">0x0097</span><span class="p">),</span> <span class="cm">/* R52 */</span>

	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;K&#39;</span><span class="p">,</span> <span class="mh">0x00bf</span><span class="p">),</span> <span class="cm">/* X30 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;Q&#39;</span><span class="p">,</span> <span class="mh">0x00bf</span><span class="p">),</span> <span class="cm">/* X31, X32 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="mh">0x00bf</span><span class="p">),</span> <span class="cm">/* X40 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="mh">0x00bf</span><span class="p">),</span> <span class="cm">/* X41 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="mh">0x00bf</span><span class="p">),</span> <span class="cm">/* X41t */</span>

	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="mh">0x1f97</span><span class="p">),</span> <span class="cm">/* T60 (1) */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="mh">0x1f97</span><span class="p">),</span> <span class="cm">/* Z60* (1) */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="mh">0x1f97</span><span class="p">),</span> <span class="cm">/* Z61* (1) */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="mh">0x1fb7</span><span class="p">),</span> <span class="cm">/* X60 (1) */</span>

	<span class="cm">/* (1) - may have excess leds enabled on MSB */</span>

	<span class="cm">/* Defaults (order matters, keep last, don&#39;t reorder!) */</span>
	<span class="p">{</span> <span class="cm">/* Lenovo */</span>
	  <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_LENOVO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bios</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span> <span class="p">.</span><span class="n">ec</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">quirks</span> <span class="o">=</span> <span class="mh">0x1fffU</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* IBM ThinkPads with no EC version string */</span>
	  <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bios</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span> <span class="p">.</span><span class="n">ec</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_UNKNOWN</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">quirks</span> <span class="o">=</span> <span class="mh">0x00ffU</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="cm">/* IBM ThinkPads with EC version string */</span>
	  <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bios</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span> <span class="p">.</span><span class="n">ec</span> <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">quirks</span> <span class="o">=</span> <span class="mh">0x00bfU</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cp">#undef TPACPI_LEDQ_IBM</span>
<span class="cp">#undef TPACPI_LEDQ_LNV</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_access_mode</span> <span class="n">__init</span> <span class="nf">led_init_detect_mode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_is_ibm</span><span class="p">())</span> <span class="p">{</span>
		<span class="cm">/* 570 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="s">&quot;SLED&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">TPACPI_LED_570</span><span class="p">;</span>

		<span class="cm">/* 600e/x, 770e, 770x, A21e, A2xm/p, T20-22, X20-21 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="s">&quot;SYSL&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">TPACPI_LED_OLD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* most others */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="s">&quot;LED&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">TPACPI_LED_NEW</span><span class="p">;</span>

	<span class="cm">/* R30, R31, and unknown firmwares */</span>
	<span class="n">led_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">TPACPI_LED_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">led_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">useful_leds</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;initializing LED subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">led_supported</span> <span class="o">=</span> <span class="n">led_init_detect_mode</span><span class="p">();</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;LED commands are %s, mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">led_supported</span><span class="p">),</span> <span class="n">led_supported</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led_supported</span> <span class="o">==</span> <span class="n">TPACPI_LED_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tpacpi_leds</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tpacpi_leds</span><span class="p">)</span> <span class="o">*</span> <span class="n">TPACPI_LED_NUMLEDS</span><span class="p">,</span>
			      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpacpi_leds</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Out of memory for LED data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">useful_leds</span> <span class="o">=</span> <span class="n">tpacpi_check_quirks</span><span class="p">(</span><span class="n">led_useful_qtable</span><span class="p">,</span>
					  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">led_useful_qtable</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TPACPI_LED_NUMLEDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpacpi_is_led_restricted</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">useful_leds</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">tpacpi_init_led</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">led_exit</span><span class="p">();</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_UNSAFE_LEDS</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;warning: userspace override of important &quot;</span>
		  <span class="s">&quot;firmware LEDs is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define str_led_status(s) \</span>
<span class="cp">	((s) == TPACPI_LED_OFF ? &quot;off&quot; : \</span>
<span class="cp">		((s) == TPACPI_LED_ON ? &quot;on&quot; : &quot;blinking&quot;))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led_supported</span> <span class="o">==</span> <span class="n">TPACPI_LED_570</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 570 */</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">led_get_status</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span> <span class="n">str_led_status</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">&quot;</span>
		       <span class="s">&quot;&lt;led&gt; on, &lt;led&gt; off, &lt;led&gt; blink (&lt;led&gt; is 0-15)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">led_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">led</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">led_status_t</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">led</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">led</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">TPACPI_LED_OFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">TPACPI_LED_ON</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;blink&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">=</span> <span class="n">TPACPI_LED_BLINK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">led_set_status</span><span class="p">(</span><span class="n">led</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">led_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;led&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">led_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">led_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">led_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Beep subdriver</span>
<span class="cm"> */</span>

<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">beep</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="s">&quot;BEEP&quot;</span><span class="p">);</span>	<span class="cm">/* all except R30, R31 */</span>

<span class="cp">#define TPACPI_BEEP_Q1 0x0001</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="n">beep_quirk_table</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="n">TPACPI_BEEP_Q1</span><span class="p">),</span> <span class="cm">/* 570 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="n">TPACPI_BEEP_Q1</span><span class="p">),</span> <span class="cm">/* 570E - unverified */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">beep_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">quirks</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;initializing beep subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">beep</span><span class="p">);</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;beep is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">beep_handle</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">));</span>

	<span class="n">quirks</span> <span class="o">=</span> <span class="n">tpacpi_check_quirks</span><span class="p">(</span><span class="n">beep_quirk_table</span><span class="p">,</span>
				     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">beep_quirk_table</span><span class="p">));</span>

	<span class="n">tp_features</span><span class="p">.</span><span class="n">beep_needs_two_args</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">TPACPI_BEEP_Q1</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">beep_handle</span><span class="p">)</span><span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beep_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beep_handle</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">&lt;cmd&gt; (&lt;cmd&gt; is 0-17)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">beep_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">beep_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beep_handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">beep_cmd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="n">beep_cmd</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">beep_cmd</span> <span class="o">&lt;=</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* beep_cmd set */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">beep_needs_two_args</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">beep_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vdd&quot;</span><span class="p">,</span>
					<span class="n">beep_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">beep_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span>
					<span class="n">beep_cmd</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">beep_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;beep&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">beep_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">beep_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Thermal subdriver</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="n">thermal_access_mode</span> <span class="p">{</span>
	<span class="n">TPACPI_THERMAL_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* No thermal support */</span>
	<span class="n">TPACPI_THERMAL_ACPI_TMP07</span><span class="p">,</span>	<span class="cm">/* Use ACPI TMP0-7 */</span>
	<span class="n">TPACPI_THERMAL_ACPI_UPDT</span><span class="p">,</span>	<span class="cm">/* Use ACPI TMP0-7 with UPDT */</span>
	<span class="n">TPACPI_THERMAL_TPEC_8</span><span class="p">,</span>		<span class="cm">/* Use ACPI EC regs, 8 sensors */</span>
	<span class="n">TPACPI_THERMAL_TPEC_16</span><span class="p">,</span>		<span class="cm">/* Use ACPI EC regs, 16 sensors */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="p">{</span> <span class="cm">/* TPACPI_THERMAL_TPEC_* */</span>
	<span class="n">TP_EC_THERMAL_TMP0</span> <span class="o">=</span> <span class="mh">0x78</span><span class="p">,</span>	<span class="cm">/* ACPI EC regs TMP 0..7 */</span>
	<span class="n">TP_EC_THERMAL_TMP8</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">,</span>	<span class="cm">/* ACPI EC regs TMP 8..15 */</span>
	<span class="n">TP_EC_THERMAL_TMP_NA</span> <span class="o">=</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span>	<span class="cm">/* ACPI EC sensor not available */</span>

	<span class="n">TPACPI_THERMAL_SENSOR_NA</span> <span class="o">=</span> <span class="o">-</span><span class="mi">128000</span><span class="p">,</span> <span class="cm">/* Sensor not available */</span>
<span class="p">};</span>


<span class="cp">#define TPACPI_MAX_THERMAL_SENSORS 16	</span><span class="cm">/* Max thermal sensors supported */</span><span class="cp"></span>
<span class="k">struct</span> <span class="n">ibm_thermal_sensors_struct</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">temp</span><span class="p">[</span><span class="n">TPACPI_MAX_THERMAL_SENSORS</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">thermal_access_mode</span> <span class="n">thermal_read_mode</span><span class="p">;</span>

<span class="cm">/* idx is zero-based */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">thermal_get_sensor</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tmpi</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">TP_EC_THERMAL_TMP0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">thermal_read_mode</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if TPACPI_MAX_THERMAL_SENSORS &gt;= 16</span>
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_TPEC_16</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">TP_EC_THERMAL_TMP8</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fallthrough */</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_TPEC_8</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TPACPI_THERMAL_ACPI_UPDT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">tmpi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpi</span><span class="p">),</span> <span class="s">&quot;TMP%c&quot;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;UPDT&quot;</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">tmpi</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="mi">2732</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TPACPI_THERMAL_ACPI_TMP07</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">tmpi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmpi</span><span class="p">),</span> <span class="s">&quot;TMP%c&quot;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="n">tmpi</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="mi">127</span> <span class="o">||</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">127</span><span class="p">)</span>
				<span class="n">t</span> <span class="o">=</span> <span class="n">TP_EC_THERMAL_TMP_NA</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TPACPI_THERMAL_NONE</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">thermal_get_sensors</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_thermal_sensors_struct</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thermal_read_mode</span> <span class="o">==</span> <span class="n">TPACPI_THERMAL_TPEC_16</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">thermal_get_sensor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">thermal_dump_all_sensors</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibm_thermal_sensors_struct</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">thermal_get_sensors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;temperatures (Celsius):&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TPACPI_THERMAL_SENSOR_NA</span><span class="p">)</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">t</span><span class="p">.</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; N/A&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sysfs temp##_input -------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">thermal_temp_input_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="o">*</span><span class="n">sensor_attr</span> <span class="o">=</span>
					<span class="n">to_sensor_dev_attr</span><span class="p">(</span><span class="n">attr</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">sensor_attr</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">thermal_get_sensor</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">TPACPI_THERMAL_SENSOR_NA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define THERMAL_SENSOR_ATTR_TEMP(_idxA, _idxB) \</span>
<span class="cp">	 SENSOR_ATTR(temp##_idxA##_input, S_IRUGO, \</span>
<span class="cp">		     thermal_temp_input_show, NULL, _idxB)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sensor_device_attribute</span> <span class="n">sensor_dev_attr_thermal_temp_input</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">14</span><span class="p">),</span>
	<span class="n">THERMAL_SENSOR_ATTR_TEMP</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define THERMAL_ATTRS(X) \</span>
<span class="cp">	&amp;sensor_dev_attr_thermal_temp_input[X].dev_attr.attr</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">thermal_temp_input_attr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span>
	<span class="n">THERMAL_ATTRS</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">thermal_temp_input16_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">thermal_temp_input_attr</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">thermal_temp_input8_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">thermal_temp_input_attr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
<span class="p">};</span>

<span class="cp">#undef THERMAL_SENSOR_ATTR_TEMP</span>
<span class="cp">#undef THERMAL_ATTRS</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">thermal_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">t</span><span class="p">,</span> <span class="n">ta1</span><span class="p">,</span> <span class="n">ta2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">acpi_tmp7</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;initializing thermal subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">acpi_tmp7</span> <span class="o">=</span> <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;TMP7&quot;</span><span class="p">,</span> <span class="s">&quot;qv&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Direct EC access mode: sensors at registers</span>
<span class="cm">		 * 0x78-0x7F, 0xC0-0xC7.  Registers return 0x00 for</span>
<span class="cm">		 * non-implemented, thermal sensors return 0x80 when</span>
<span class="cm">		 * not available</span>
<span class="cm">		 */</span>

		<span class="n">ta1</span> <span class="o">=</span> <span class="n">ta2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">TP_EC_THERMAL_TMP0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ta1</span> <span class="o">|=</span> <span class="n">t</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ta1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">TP_EC_THERMAL_TMP8</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ta2</span> <span class="o">|=</span> <span class="n">t</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ta1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ta1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is sheer paranoia, but we handle it anyway */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">acpi_tmp7</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ThinkPad ACPI EC access misbehaving, &quot;</span>
				       <span class="s">&quot;falling back to ACPI TMPx access &quot;</span>
				       <span class="s">&quot;mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">thermal_read_mode</span> <span class="o">=</span> <span class="n">TPACPI_THERMAL_ACPI_TMP07</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ThinkPad ACPI EC access misbehaving, &quot;</span>
				       <span class="s">&quot;disabling thermal sensors access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">thermal_read_mode</span> <span class="o">=</span> <span class="n">TPACPI_THERMAL_NONE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">thermal_read_mode</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">ta2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">TPACPI_THERMAL_TPEC_16</span> <span class="o">:</span> <span class="n">TPACPI_THERMAL_TPEC_8</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">acpi_tmp7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_is_ibm</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
		    <span class="n">acpi_evalf</span><span class="p">(</span><span class="n">ec_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;UPDT&quot;</span><span class="p">,</span> <span class="s">&quot;qv&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* 600e/x, 770e, 770x */</span>
			<span class="n">thermal_read_mode</span> <span class="o">=</span> <span class="n">TPACPI_THERMAL_ACPI_UPDT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* IBM/LENOVO DSDT EC.TMPx access, max 8 sensors */</span>
			<span class="n">thermal_read_mode</span> <span class="o">=</span> <span class="n">TPACPI_THERMAL_ACPI_TMP07</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* temperatures not supported on 570, G4x, R30, R31, R32 */</span>
		<span class="n">thermal_read_mode</span> <span class="o">=</span> <span class="n">TPACPI_THERMAL_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;thermal is %s, mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">thermal_read_mode</span> <span class="o">!=</span> <span class="n">TPACPI_THERMAL_NONE</span><span class="p">),</span>
		<span class="n">thermal_read_mode</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">thermal_read_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_TPEC_16</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">thermal_temp_input16_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_TPEC_8</span>:
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_ACPI_TMP07</span>:
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_ACPI_UPDT</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">thermal_temp_input8_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_NONE</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">thermal_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">thermal_read_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_TPEC_16</span>:
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">thermal_temp_input16_group</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_TPEC_8</span>:
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_ACPI_TMP07</span>:
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_ACPI_UPDT</span>:
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">thermal_temp_input8_group</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_THERMAL_NONE</span>:
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">thermal_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibm_thermal_sensors_struct</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">thermal_get_sensors</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;temperatures:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">.</span><span class="n">temp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">thermal_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;thermal&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">thermal_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">thermal_exit</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Backlight/brightness subdriver</span>
<span class="cm"> */</span>

<span class="cp">#define TPACPI_BACKLIGHT_DEV_NAME &quot;thinkpad_screen&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * ThinkPads can read brightness from two places: EC HBRV (0x31), or</span>
<span class="cm"> * CMOS NVRAM byte 0x5E, bits 0-3.</span>
<span class="cm"> *</span>
<span class="cm"> * EC HBRV (0x31) has the following layout</span>
<span class="cm"> *   Bit 7: unknown function</span>
<span class="cm"> *   Bit 6: unknown function</span>
<span class="cm"> *   Bit 5: Z: honour scale changes, NZ: ignore scale changes</span>
<span class="cm"> *   Bit 4: must be set to zero to avoid problems</span>
<span class="cm"> *   Bit 3-0: backlight brightness level</span>
<span class="cm"> *</span>
<span class="cm"> * brightness_get_raw returns status data in the HBRV layout</span>
<span class="cm"> *</span>
<span class="cm"> * WARNING: The X61 has been verified to use HBRV for something else, so</span>
<span class="cm"> * this should be used _only_ on IBM ThinkPads, and maybe with some careful</span>
<span class="cm"> * testing on the very early *60 Lenovo models...</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TP_EC_BACKLIGHT</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">,</span>

	<span class="cm">/* TP_EC_BACKLIGHT bitmasks */</span>
	<span class="n">TP_EC_BACKLIGHT_LVLMSK</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">,</span>
	<span class="n">TP_EC_BACKLIGHT_CMDMSK</span> <span class="o">=</span> <span class="mh">0xE0</span><span class="p">,</span>
	<span class="n">TP_EC_BACKLIGHT_MAPSW</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">tpacpi_brightness_access_mode</span> <span class="p">{</span>
	<span class="n">TPACPI_BRGHT_MODE_AUTO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Not implemented yet */</span>
	<span class="n">TPACPI_BRGHT_MODE_EC</span><span class="p">,</span>		<span class="cm">/* EC control */</span>
	<span class="n">TPACPI_BRGHT_MODE_UCMS_STEP</span><span class="p">,</span>	<span class="cm">/* UCMS step-based control */</span>
	<span class="n">TPACPI_BRGHT_MODE_ECNVRAM</span><span class="p">,</span>	<span class="cm">/* EC control w/ NVRAM store */</span>
	<span class="n">TPACPI_BRGHT_MODE_MAX</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">ibm_backlight_device</span><span class="p">;</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">tpacpi_brightness_access_mode</span> <span class="n">brightness_mode</span> <span class="o">=</span>
		<span class="n">TPACPI_BRGHT_MODE_MAX</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">brightness_enable</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* 2 = auto, 0 = no, 1 = yes */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">brightness_mutex</span><span class="p">;</span>

<span class="cm">/* NVRAM brightness access,</span>
<span class="cm"> * call with brightness_mutex held! */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">tpacpi_brightness_nvram_get</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">lnvram</span><span class="p">;</span>

	<span class="n">lnvram</span> <span class="o">=</span> <span class="p">(</span><span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">TP_NVRAM_ADDR_BRIGHTNESS</span><span class="p">)</span>
		  <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_LEVEL_BRIGHTNESS</span><span class="p">)</span>
		  <span class="o">&gt;&gt;</span> <span class="n">TP_NVRAM_POS_LEVEL_BRIGHTNESS</span><span class="p">;</span>
	<span class="n">lnvram</span> <span class="o">&amp;=</span> <span class="n">bright_maxlvl</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">lnvram</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_brightness_checkpoint_nvram</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">lec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b_nvram</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">brightness_mode</span> <span class="o">!=</span> <span class="n">TPACPI_BRGHT_MODE_ECNVRAM</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
		<span class="s">&quot;trying to checkpoint backlight level to NVRAM...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brightness_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">TP_EC_BACKLIGHT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lec</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="n">lec</span> <span class="o">&amp;=</span> <span class="n">TP_EC_BACKLIGHT_LVLMSK</span><span class="p">;</span>
	<span class="n">b_nvram</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">TP_NVRAM_ADDR_BRIGHTNESS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lec</span> <span class="o">!=</span> <span class="p">((</span><span class="n">b_nvram</span> <span class="o">&amp;</span> <span class="n">TP_NVRAM_MASK_LEVEL_BRIGHTNESS</span><span class="p">)</span>
			     <span class="o">&gt;&gt;</span> <span class="n">TP_NVRAM_POS_LEVEL_BRIGHTNESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* NVRAM needs update */</span>
		<span class="n">b_nvram</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TP_NVRAM_MASK_LEVEL_BRIGHTNESS</span> <span class="o">&lt;&lt;</span>
				<span class="n">TP_NVRAM_POS_LEVEL_BRIGHTNESS</span><span class="p">);</span>
		<span class="n">b_nvram</span> <span class="o">|=</span> <span class="n">lec</span><span class="p">;</span>
		<span class="n">nvram_write_byte</span><span class="p">(</span><span class="n">b_nvram</span><span class="p">,</span> <span class="n">TP_NVRAM_ADDR_BRIGHTNESS</span><span class="p">);</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
			   <span class="s">&quot;updated NVRAM backlight level to %u (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lec</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">b_nvram</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
			   <span class="s">&quot;NVRAM backlight level already is %u (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lec</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">b_nvram</span><span class="p">);</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brightness_mutex</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* call with brightness_mutex held! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_brightness_get_raw</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">lec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">brightness_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_BRGHT_MODE_UCMS_STEP</span>:
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">tpacpi_brightness_nvram_get</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_BRGHT_MODE_EC</span>:
	<span class="k">case</span> <span class="n">TPACPI_BRGHT_MODE_ECNVRAM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">TP_EC_BACKLIGHT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lec</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">lec</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* call with brightness_mutex held! */</span>
<span class="cm">/* do NOT call with illegal backlight level value */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_brightness_set_ec</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">lec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">TP_EC_BACKLIGHT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lec</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_write</span><span class="p">(</span><span class="n">TP_EC_BACKLIGHT</span><span class="p">,</span>
				<span class="p">(</span><span class="n">lec</span> <span class="o">&amp;</span> <span class="n">TP_EC_BACKLIGHT_CMDMSK</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">TP_EC_BACKLIGHT_LVLMSK</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* call with brightness_mutex held! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tpacpi_brightness_set_ucmsstep</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmos_cmd</span><span class="p">,</span> <span class="n">inc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">current_value</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">current_value</span> <span class="o">=</span> <span class="n">tpacpi_brightness_nvram_get</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">current_value</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmos_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">current_value</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">TP_CMOS_BRIGHTNESS_UP</span> <span class="o">:</span>
			<span class="n">TP_CMOS_BRIGHTNESS_DOWN</span><span class="p">;</span>
	<span class="n">inc</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">current_value</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">current_value</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">value</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">inc</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">issue_thinkpad_cmos_command</span><span class="p">(</span><span class="n">cmos_cmd</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* May return EINTR which can always be mapped to ERESTARTSYS */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brightness_set</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">bright_maxlvl</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
			<span class="s">&quot;set backlight level to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brightness_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">brightness_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_BRGHT_MODE_EC</span>:
	<span class="k">case</span> <span class="n">TPACPI_BRGHT_MODE_ECNVRAM</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">tpacpi_brightness_set_ec</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_BRGHT_MODE_UCMS_STEP</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">tpacpi_brightness_set_ucmsstep</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brightness_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* sysfs backlight class ----------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brightness_update_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">fb_blank</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span> <span class="o">&amp;&amp;</span>
		 <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
			<span class="s">&quot;backlight: attempt to set level to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">level</span><span class="p">);</span>

	<span class="cm">/* it is the backlight class&#39;s job (caller) to handle</span>
<span class="cm">	 * EINTR and other errors properly */</span>
	<span class="k">return</span> <span class="n">brightness_set</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brightness_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brightness_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">tpacpi_brightness_get_raw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brightness_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_EC_BACKLIGHT_LVLMSK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_brightness_notify_change</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">backlight_force_update</span><span class="p">(</span><span class="n">ibm_backlight_device</span><span class="p">,</span>
			       <span class="n">BACKLIGHT_UPDATE_HOTKEY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">ibm_backlight_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">brightness_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_status</span>  <span class="o">=</span> <span class="n">brightness_update_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * Call _BCL method of video device.  On some ThinkPads this will</span>
<span class="cm"> * switch the firmware to the ACPI brightness control mode.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tpacpi_query_bcl_levels</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;_BCL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span> <span class="o">||</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_PACKAGE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown _BCL data, please report this to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">TPACPI_MAIL</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">package</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Returns 0 (no ACPI _BCL or _BCL invalid), or size of brightness map</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">tpacpi_check_std_acpi_brightness_support</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">video_device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bcl_levels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tpacpi_acpi_handle_locate</span><span class="p">(</span><span class="s">&quot;video&quot;</span><span class="p">,</span> <span class="n">ACPI_VIDEO_HID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_device</span><span class="p">)</span>
		<span class="n">bcl_levels</span> <span class="o">=</span> <span class="n">tpacpi_query_bcl_levels</span><span class="p">(</span><span class="n">video_device</span><span class="p">);</span>

	<span class="n">tp_features</span><span class="p">.</span><span class="n">bright_acpimode</span> <span class="o">=</span> <span class="p">(</span><span class="n">bcl_levels</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">bcl_levels</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">bcl_levels</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These are only useful for models that have only one possibility</span>
<span class="cm"> * of GPU.  If the BIOS model handles both ATI and Intel, don&#39;t use</span>
<span class="cm"> * these quirks.</span>
<span class="cm"> */</span>
<span class="cp">#define TPACPI_BRGHT_Q_NOEC	0x0001	</span><span class="cm">/* Must NOT use EC HBRV */</span><span class="cp"></span>
<span class="cp">#define TPACPI_BRGHT_Q_EC	0x0002  </span><span class="cm">/* Should or must use EC HBRV */</span><span class="cp"></span>
<span class="cp">#define TPACPI_BRGHT_Q_ASK	0x8000	</span><span class="cm">/* Ask for user report */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="n">brightness_quirk_table</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Models with ATI GPUs known to require ECNVRAM mode */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_EC</span><span class="p">),</span>	<span class="cm">/* T43/p ATI */</span>

	<span class="cm">/* Models with ATI GPUs that can use ECNVRAM */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_EC</span><span class="p">),</span>	<span class="cm">/* R50,51 T40-42 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;Q&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_ASK</span><span class="o">|</span><span class="n">TPACPI_BRGHT_Q_EC</span><span class="p">),</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_EC</span><span class="p">),</span>	<span class="cm">/* R52 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_ASK</span><span class="o">|</span><span class="n">TPACPI_BRGHT_Q_EC</span><span class="p">),</span>

	<span class="cm">/* Models with Intel Extreme Graphics 2 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_NOEC</span><span class="p">),</span>	<span class="cm">/* X40 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;V&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_ASK</span><span class="o">|</span><span class="n">TPACPI_BRGHT_Q_EC</span><span class="p">),</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;W&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_ASK</span><span class="o">|</span><span class="n">TPACPI_BRGHT_Q_EC</span><span class="p">),</span>

	<span class="cm">/* Models with Intel GMA900 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_NOEC</span><span class="p">),</span>	<span class="cm">/* T43, R52 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;4&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_NOEC</span><span class="p">),</span>	<span class="cm">/* X41 */</span>
	<span class="n">TPACPI_Q_IBM</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="n">TPACPI_BRGHT_Q_NOEC</span><span class="p">),</span>	<span class="cm">/* X41 Tablet */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Returns &lt; 0 for error, otherwise sets tp_features.bright_*</span>
<span class="cm"> * and bright_maxlvl.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">tpacpi_detect_brightness_capabilities</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">b</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
		    <span class="s">&quot;detecting firmware brightness interface capabilities</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* we could run a quirks check here (same table used by</span>
<span class="cm">	 * brightness_init) if needed */</span>

	<span class="cm">/*</span>
<span class="cm">	 * We always attempt to detect acpi support, so as to switch</span>
<span class="cm">	 * Lenovo Vista BIOS to ACPI brightness mode even if we are not</span>
<span class="cm">	 * going to publish a backlight interface</span>
<span class="cm">	 */</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">tpacpi_check_std_acpi_brightness_support</span><span class="p">();</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">bright_maxlvl</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;detected a 16-level brightness capable ThinkPad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">bright_maxlvl</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;detected a 8-level brightness capable ThinkPad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unsupported brightness interface, &quot;</span>
		       <span class="s">&quot;please contact %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_MAIL</span><span class="p">);</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">bright_unkfw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bright_maxlvl</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">brightness_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">quirks</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;initializing brightness subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brightness_mutex</span><span class="p">);</span>

	<span class="n">quirks</span> <span class="o">=</span> <span class="n">tpacpi_check_quirks</span><span class="p">(</span><span class="n">brightness_quirk_table</span><span class="p">,</span>
				<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">brightness_quirk_table</span><span class="p">));</span>

	<span class="cm">/* tpacpi_detect_brightness_capabilities() must have run already */</span>

	<span class="cm">/* if it is unknown, we don&#39;t handle it: it wouldn&#39;t be safe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">bright_unkfw</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">brightness_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
			   <span class="s">&quot;brightness support disabled by &quot;</span>
			   <span class="s">&quot;module parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_video_backlight_support</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brightness_enable</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Standard ACPI backlight interface &quot;</span>
				<span class="s">&quot;available, not loading native one</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brightness_enable</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Cannot enable backlight brightness support, &quot;</span>
				<span class="s">&quot;ACPI is already handling it.  Refer to the &quot;</span>
				<span class="s">&quot;acpi_backlight kernel parameter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">bright_acpimode</span> <span class="o">&amp;&amp;</span> <span class="n">brightness_enable</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Standard ACPI backlight interface not &quot;</span>
			  <span class="s">&quot;available, thinkpad_acpi native &quot;</span>
			  <span class="s">&quot;brightness control enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for module parameter bogosity, note that we</span>
<span class="cm">	 * init brightness_mode to TPACPI_BRGHT_MODE_MAX in order to be</span>
<span class="cm">	 * able to detect &quot;unspecified&quot;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brightness_mode</span> <span class="o">&gt;</span> <span class="n">TPACPI_BRGHT_MODE_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* TPACPI_BRGHT_MODE_AUTO not implemented yet, just use default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brightness_mode</span> <span class="o">==</span> <span class="n">TPACPI_BRGHT_MODE_AUTO</span> <span class="o">||</span>
	    <span class="n">brightness_mode</span> <span class="o">==</span> <span class="n">TPACPI_BRGHT_MODE_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">TPACPI_BRGHT_Q_EC</span><span class="p">)</span>
			<span class="n">brightness_mode</span> <span class="o">=</span> <span class="n">TPACPI_BRGHT_MODE_ECNVRAM</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">brightness_mode</span> <span class="o">=</span> <span class="n">TPACPI_BRGHT_MODE_UCMS_STEP</span><span class="p">;</span>

		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
			   <span class="s">&quot;driver auto-selected brightness_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">brightness_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Safety */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpacpi_is_ibm</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">brightness_mode</span> <span class="o">==</span> <span class="n">TPACPI_BRGHT_MODE_ECNVRAM</span> <span class="o">||</span>
	     <span class="n">brightness_mode</span> <span class="o">==</span> <span class="n">TPACPI_BRGHT_MODE_EC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_brightness_get_raw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_properties</span><span class="p">));</span>
	<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_PLATFORM</span><span class="p">;</span>
	<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">bright_maxlvl</span><span class="p">;</span>
	<span class="n">props</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="n">TP_EC_BACKLIGHT_LVLMSK</span><span class="p">;</span>
	<span class="n">ibm_backlight_device</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="n">TPACPI_BACKLIGHT_DEV_NAME</span><span class="p">,</span>
							 <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">ibm_backlight_data</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ibm_backlight_device</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ibm_backlight_device</span><span class="p">);</span>
		<span class="n">ibm_backlight_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not register backlight device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
			<span class="s">&quot;brightness is supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">TPACPI_BRGHT_Q_ASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;brightness: will use unverified default: &quot;</span>
			  <span class="s">&quot;brightness_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">brightness_mode</span><span class="p">);</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;brightness: please report to %s whether it works well &quot;</span>
			  <span class="s">&quot;or not on your ThinkPad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_MAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Added by mistake in early 2007.  Probably useless, but it could</span>
<span class="cm">	 * be working around some unknown firmware problem where the value</span>
<span class="cm">	 * read at startup doesn&#39;t match the real hardware state... so leave</span>
<span class="cm">	 * it in place just in case */</span>
	<span class="n">backlight_update_status</span><span class="p">(</span><span class="n">ibm_backlight_device</span><span class="p">);</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
			<span class="s">&quot;brightness: registering brightness hotkeys &quot;</span>
			<span class="s">&quot;as change notification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tpacpi_hotkey_driver_mask_set</span><span class="p">(</span><span class="n">hotkey_driver_mask</span>
				<span class="o">|</span> <span class="n">TP_ACPI_HKEY_BRGHTUP_MASK</span>
				<span class="o">|</span> <span class="n">TP_ACPI_HKEY_BRGHTDWN_MASK</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brightness_suspend</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_brightness_checkpoint_nvram</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brightness_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_brightness_checkpoint_nvram</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brightness_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ibm_backlight_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_EXIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_BRGHT</span><span class="p">,</span>
			    <span class="s">&quot;calling backlight_device_unregister()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">ibm_backlight_device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tpacpi_brightness_checkpoint_nvram</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brightness_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">level</span> <span class="o">=</span> <span class="n">brightness_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;level:</span><span class="se">\t\t</span><span class="s">unreadable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;level:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">up, down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">level &lt;level&gt; (&lt;level&gt; is 0-%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bright_maxlvl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brightness_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">level</span> <span class="o">=</span> <span class="n">brightness_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;up&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="n">bright_maxlvl</span><span class="p">)</span>
				<span class="n">level</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;down&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">level</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;level %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
			   <span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="n">bright_maxlvl</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* new level set */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs brightness&quot;</span><span class="p">,</span>
			<span class="s">&quot;set level to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now we know what the final level should be, so we try to set it.</span>
<span class="cm">	 * Doing it this way makes the syscall restartable in case of EINTR</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">brightness_set</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="n">ibm_backlight_device</span><span class="p">)</span>
		<span class="n">backlight_force_update</span><span class="p">(</span><span class="n">ibm_backlight_device</span><span class="p">,</span>
					<span class="n">BACKLIGHT_UPDATE_SYSFS</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span><span class="o">?</span> <span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">:</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">brightness_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;brightness&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">brightness_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">brightness_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">brightness_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">brightness_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">brightness_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Volume subdriver</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * IBM ThinkPads have a simple volume controller with MUTE gating.</span>
<span class="cm"> * Very early Lenovo ThinkPads follow the IBM ThinkPad spec.</span>
<span class="cm"> *</span>
<span class="cm"> * Since the *61 series (and probably also the later *60 series), Lenovo</span>
<span class="cm"> * ThinkPads only implement the MUTE gate.</span>
<span class="cm"> *</span>
<span class="cm"> * EC register 0x30</span>
<span class="cm"> *   Bit 6: MUTE (1 mutes sound)</span>
<span class="cm"> *   Bit 3-0: Volume</span>
<span class="cm"> *   Other bits should be zero as far as we know.</span>
<span class="cm"> *</span>
<span class="cm"> * This is also stored in CMOS NVRAM, byte 0x60, bit 6 (MUTE), and</span>
<span class="cm"> * bits 3-0 (volume).  Other bits in NVRAM may have other functions,</span>
<span class="cm"> * such as bit 7 which is used to detect repeated presses of MUTE,</span>
<span class="cm"> * and we leave them unchanged.</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_ALSA_SUPPORT</span>

<span class="cp">#define TPACPI_ALSA_DRVNAME  &quot;ThinkPad EC&quot;</span>
<span class="cp">#define TPACPI_ALSA_SHRTNAME &quot;ThinkPad Console Audio Control&quot;</span>
<span class="cp">#define TPACPI_ALSA_MIXERNAME TPACPI_ALSA_SHRTNAME</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">alsa_index</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">3</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* last three slots */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alsa_id</span> <span class="o">=</span> <span class="s">&quot;ThinkPadEC&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">alsa_enable</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_ENABLE1</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">tpacpi_alsa_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="o">*</span><span class="n">ctl_mute_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_ctl_elem_id</span> <span class="o">*</span><span class="n">ctl_vol_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">alsa_card</span><span class="p">;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">TP_EC_AUDIO</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>

	<span class="cm">/* TP_EC_AUDIO bits */</span>
	<span class="n">TP_EC_AUDIO_MUTESW</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>

	<span class="cm">/* TP_EC_AUDIO bitmasks */</span>
	<span class="n">TP_EC_AUDIO_LVL_MSK</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">,</span>
	<span class="n">TP_EC_AUDIO_MUTESW_MSK</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">TP_EC_AUDIO_MUTESW</span><span class="p">),</span>

	<span class="cm">/* Maximum volume */</span>
	<span class="n">TP_EC_VOLUME_MAX</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">tpacpi_volume_access_mode</span> <span class="p">{</span>
	<span class="n">TPACPI_VOL_MODE_AUTO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Not implemented yet */</span>
	<span class="n">TPACPI_VOL_MODE_EC</span><span class="p">,</span>		<span class="cm">/* Pure EC control */</span>
	<span class="n">TPACPI_VOL_MODE_UCMS_STEP</span><span class="p">,</span>	<span class="cm">/* UCMS step-based control: N/A */</span>
	<span class="n">TPACPI_VOL_MODE_ECNVRAM</span><span class="p">,</span>	<span class="cm">/* EC control w/ NVRAM store */</span>
	<span class="n">TPACPI_VOL_MODE_MAX</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">tpacpi_volume_capabilities</span> <span class="p">{</span>
	<span class="n">TPACPI_VOL_CAP_AUTO</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* Use white/blacklist */</span>
	<span class="n">TPACPI_VOL_CAP_VOLMUTE</span><span class="p">,</span>		<span class="cm">/* Output vol and mute */</span>
	<span class="n">TPACPI_VOL_CAP_MUTEONLY</span><span class="p">,</span>	<span class="cm">/* Output mute only */</span>
	<span class="n">TPACPI_VOL_CAP_MAX</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">tpacpi_volume_access_mode</span> <span class="n">volume_mode</span> <span class="o">=</span>
	<span class="n">TPACPI_VOL_MODE_MAX</span><span class="p">;</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">tpacpi_volume_capabilities</span> <span class="n">volume_capabilities</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">volume_control_allowed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Used to syncronize writers to TP_EC_AUDIO and</span>
<span class="cm"> * TP_NVRAM_ADDR_MIXER, as we need to do read-modify-write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">volume_mutex</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_volume_checkpoint_nvram</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">lec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">b_nvram</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ec_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_mode</span> <span class="o">!=</span> <span class="n">TPACPI_VOL_MODE_ECNVRAM</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">volume_control_allowed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
		<span class="s">&quot;trying to checkpoint mixer state to NVRAM...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span><span class="p">)</span>
		<span class="n">ec_mask</span> <span class="o">=</span> <span class="n">TP_EC_AUDIO_MUTESW_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ec_mask</span> <span class="o">=</span> <span class="n">TP_EC_AUDIO_MUTESW_MSK</span> <span class="o">|</span> <span class="n">TP_EC_AUDIO_LVL_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">TP_EC_AUDIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lec</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="n">lec</span> <span class="o">&amp;=</span> <span class="n">ec_mask</span><span class="p">;</span>
	<span class="n">b_nvram</span> <span class="o">=</span> <span class="n">nvram_read_byte</span><span class="p">(</span><span class="n">TP_NVRAM_ADDR_MIXER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lec</span> <span class="o">!=</span> <span class="p">(</span><span class="n">b_nvram</span> <span class="o">&amp;</span> <span class="n">ec_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* NVRAM needs update */</span>
		<span class="n">b_nvram</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ec_mask</span><span class="p">;</span>
		<span class="n">b_nvram</span> <span class="o">|=</span> <span class="n">lec</span><span class="p">;</span>
		<span class="n">nvram_write_byte</span><span class="p">(</span><span class="n">b_nvram</span><span class="p">,</span> <span class="n">TP_NVRAM_ADDR_MIXER</span><span class="p">);</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
			   <span class="s">&quot;updated NVRAM mixer status to 0x%02x (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lec</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">b_nvram</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
			   <span class="s">&quot;NVRAM mixer status already is 0x%02x (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lec</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">b_nvram</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_get_status_ec</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">TP_EC_AUDIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span> <span class="s">&quot;status 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_get_status</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">volume_get_status_ec</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_set_status_ec</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_write</span><span class="p">(</span><span class="n">TP_EC_AUDIO</span><span class="p">,</span> <span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span> <span class="s">&quot;set EC mixer to 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_set_status</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">volume_set_status_ec</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* returns &lt; 0 on error, 0 on no change, 1 on change */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__volume_set_mute_ec</span><span class="p">(</span><span class="k">const</span> <span class="n">bool</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_get_status_ec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span> <span class="o">?</span> <span class="n">s</span> <span class="o">|</span> <span class="n">TP_EC_AUDIO_MUTESW_MSK</span> <span class="o">:</span>
		     <span class="n">s</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TP_EC_AUDIO_MUTESW_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_set_status_ec</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_alsa_set_mute</span><span class="p">(</span><span class="k">const</span> <span class="n">bool</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span> <span class="s">&quot;ALSA: trying to %smute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">mute</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__volume_set_mute_ec</span><span class="p">(</span><span class="n">mute</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_set_mute</span><span class="p">(</span><span class="k">const</span> <span class="n">bool</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span> <span class="s">&quot;trying to %smute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">mute</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">__volume_set_mute_ec</span><span class="p">(</span><span class="n">mute</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns &lt; 0 on error, 0 on no change, 1 on change */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__volume_set_volume_ec</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vol</span> <span class="o">&gt;</span> <span class="n">TP_EC_VOLUME_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume_mutex</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_get_status_ec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TP_EC_AUDIO_LVL_MSK</span><span class="p">)</span> <span class="o">|</span> <span class="n">vol</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_set_status_ec</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_alsa_set_volume</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">vol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
		   <span class="s">&quot;ALSA: trying to set volume level to %hu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vol</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">__volume_set_volume_ec</span><span class="p">(</span><span class="n">vol</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">volume_alsa_notify_change</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tpacpi_alsa_data</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alsa_card</span> <span class="o">&amp;&amp;</span> <span class="n">alsa_card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">alsa_card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ctl_mute_id</span><span class="p">)</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">alsa_card</span><span class="p">,</span>
					<span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
					<span class="n">d</span><span class="o">-&gt;</span><span class="n">ctl_mute_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">ctl_vol_id</span><span class="p">)</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">alsa_card</span><span class="p">,</span>
					<span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
					<span class="n">d</span><span class="o">-&gt;</span><span class="n">ctl_vol_id</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_alsa_vol_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span><span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">TP_EC_VOLUME_MAX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_alsa_vol_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">TP_EC_AUDIO_LVL_MSK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_alsa_vol_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;ALSA&quot;</span><span class="p">,</span> <span class="s">&quot;set volume to %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">volume_alsa_set_volume</span><span class="p">(</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cp">#define volume_alsa_mute_info snd_ctl_boolean_mono_info</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_alsa_mute_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">TP_EC_AUDIO_MUTESW_MSK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_alsa_mute_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span><span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;ALSA&quot;</span><span class="p">,</span> <span class="s">&quot;%smute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span>
					<span class="s">&quot;un&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">volume_alsa_set_mute</span><span class="p">(</span><span class="o">!</span><span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">volume_alsa_control_vol</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Console Playback Volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">volume_alsa_vol_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">volume_alsa_vol_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">volume_alsa_control_mute</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">iface</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_IFACE_MIXER</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Console Playback Switch&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">access</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_ACCESS_READ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">volume_alsa_mute_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">volume_alsa_mute_get</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">volume_suspend</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_volume_checkpoint_nvram</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">volume_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">volume_alsa_notify_change</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">volume_shutdown</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_volume_checkpoint_nvram</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">volume_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alsa_card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">alsa_card</span><span class="p">);</span>
		<span class="n">alsa_card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tpacpi_volume_checkpoint_nvram</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">volume_create_alsa_mixer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tpacpi_alsa_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl_vol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">ctl_mute</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">alsa_index</span><span class="p">,</span> <span class="n">alsa_id</span><span class="p">,</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpacpi_alsa_data</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to create ALSA card structures: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">TPACPI_ALSA_DRVNAME</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">TPACPI_ALSA_SHRTNAME</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">),</span> <span class="s">&quot;ThinkPad EC %s&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_version_str</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_version_str</span> <span class="o">:</span> <span class="s">&quot;(unknown)&quot;</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">),</span>
		 <span class="s">&quot;%s at EC reg 0x%02x, fw %s&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="n">TP_EC_AUDIO</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_version_str</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_version_str</span> <span class="o">:</span> <span class="s">&quot;unknown&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_control_allowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">volume_alsa_control_vol</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">volume_alsa_vol_put</span><span class="p">;</span>
		<span class="n">volume_alsa_control_vol</span><span class="p">.</span><span class="n">access</span> <span class="o">=</span>
				<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">;</span>

		<span class="n">volume_alsa_control_mute</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">volume_alsa_mute_put</span><span class="p">;</span>
		<span class="n">volume_alsa_control_mute</span><span class="p">.</span><span class="n">access</span> <span class="o">=</span>
				<span class="n">SNDRV_CTL_ELEM_ACCESS_READWRITE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctl_vol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume_alsa_control_vol</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctl_vol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to create ALSA volume control: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">ctl_vol_id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctl_vol</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctl_mute</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume_alsa_control_mute</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">ctl_mute</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to create ALSA mute control: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">ctl_mute_id</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctl_mute</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to register ALSA card: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">alsa_card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_exit:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TPACPI_VOL_Q_MUTEONLY	0x0001	</span><span class="cm">/* Mute-only control available */</span><span class="cp"></span>
<span class="cp">#define TPACPI_VOL_Q_LEVEL	0x0002  </span><span class="cm">/* Volume control available */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="n">volume_quirk_table</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Whitelist volume level on all IBM by default */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bios</span>   <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ec</span>     <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">TPACPI_VOL_Q_LEVEL</span> <span class="p">},</span>

	<span class="cm">/* Lenovo models with volume control (needs confirmation) */</span>
	<span class="n">TPACPI_QEC_LNV</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="n">TPACPI_VOL_Q_LEVEL</span><span class="p">),</span> <span class="cm">/* R60/i */</span>
	<span class="n">TPACPI_QEC_LNV</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="n">TPACPI_VOL_Q_LEVEL</span><span class="p">),</span> <span class="cm">/* R60e/i */</span>
	<span class="n">TPACPI_QEC_LNV</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="n">TPACPI_VOL_Q_LEVEL</span><span class="p">),</span> <span class="cm">/* T60/p */</span>
	<span class="n">TPACPI_QEC_LNV</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;B&#39;</span><span class="p">,</span> <span class="n">TPACPI_VOL_Q_LEVEL</span><span class="p">),</span> <span class="cm">/* X60/s */</span>
	<span class="n">TPACPI_QEC_LNV</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;J&#39;</span><span class="p">,</span> <span class="n">TPACPI_VOL_Q_LEVEL</span><span class="p">),</span> <span class="cm">/* X60t */</span>
	<span class="n">TPACPI_QEC_LNV</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="n">TPACPI_VOL_Q_LEVEL</span><span class="p">),</span> <span class="cm">/* Z60 */</span>
	<span class="n">TPACPI_QEC_LNV</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">,</span> <span class="n">TPACPI_VOL_Q_LEVEL</span><span class="p">),</span> <span class="cm">/* Z61 */</span>

	<span class="cm">/* Whitelist mute-only on all Lenovo by default */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_LENOVO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bios</span>   <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ec</span>	  <span class="o">=</span> <span class="n">TPACPI_MATCH_ANY</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">TPACPI_VOL_Q_MUTEONLY</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">volume_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">quirks</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;initializing volume subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">volume_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check for module parameter bogosity, note that we</span>
<span class="cm">	 * init volume_mode to TPACPI_VOL_MODE_MAX in order to be</span>
<span class="cm">	 * able to detect &quot;unspecified&quot;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">volume_mode</span> <span class="o">&gt;</span> <span class="n">TPACPI_VOL_MODE_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_mode</span> <span class="o">==</span> <span class="n">TPACPI_VOL_MODE_UCMS_STEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;UCMS step volume mode not implemented, &quot;</span>
		       <span class="s">&quot;please contact %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_MAIL</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_capabilities</span> <span class="o">&gt;=</span> <span class="n">TPACPI_VOL_CAP_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ALSA mixer is our primary interface.</span>
<span class="cm">	 * When disabled, don&#39;t install the subdriver at all</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alsa_enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
			    <span class="s">&quot;ALSA mixer disabled by parameter, &quot;</span>
			    <span class="s">&quot;not loading volume subdriver...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">quirks</span> <span class="o">=</span> <span class="n">tpacpi_check_quirks</span><span class="p">(</span><span class="n">volume_quirk_table</span><span class="p">,</span>
				     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">volume_quirk_table</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">volume_capabilities</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_VOL_CAP_AUTO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">TPACPI_VOL_Q_MUTEONLY</span><span class="p">)</span>
			<span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">TPACPI_VOL_Q_LEVEL</span><span class="p">)</span>
			<span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* no mixer */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VOL_CAP_VOLMUTE</span>:
		<span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_VOL_CAP_MUTEONLY</span>:
		<span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_capabilities</span> <span class="o">!=</span> <span class="n">TPACPI_VOL_CAP_AUTO</span><span class="p">)</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
				<span class="s">&quot;using user-supplied volume_capabilities=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">volume_capabilities</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_mode</span> <span class="o">==</span> <span class="n">TPACPI_VOL_MODE_AUTO</span> <span class="o">||</span>
	    <span class="n">volume_mode</span> <span class="o">==</span> <span class="n">TPACPI_VOL_MODE_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">volume_mode</span> <span class="o">=</span> <span class="n">TPACPI_VOL_MODE_ECNVRAM</span><span class="p">;</span>

		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
				<span class="s">&quot;driver auto-selected volume_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">volume_mode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
				<span class="s">&quot;using user-supplied volume_mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">volume_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
			<span class="s">&quot;mute is supported, volume control is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">str_supported</span><span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span><span class="p">));</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_create_alsa_mixer</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not create the ALSA mixer interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Console audio control enabled, mode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">volume_control_allowed</span><span class="p">)</span> <span class="o">?</span>
			<span class="s">&quot;override (read/write)&quot;</span> <span class="o">:</span>
			<span class="s">&quot;monitor (read only)&quot;</span><span class="p">);</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_MIXER</span><span class="p">,</span>
		<span class="s">&quot;registering volume hotkeys as change notification</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tpacpi_hotkey_driver_mask_set</span><span class="p">(</span><span class="n">hotkey_driver_mask</span>
			<span class="o">|</span> <span class="n">TP_ACPI_HKEY_VOLUP_MASK</span>
			<span class="o">|</span> <span class="n">TP_ACPI_HKEY_VOLDWN_MASK</span>
			<span class="o">|</span> <span class="n">TP_ACPI_HKEY_MUTE_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">volume_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;level:</span><span class="se">\t\t</span><span class="s">unreadable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;level:</span><span class="se">\t\t</span><span class="s">unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;level:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_EC_AUDIO_LVL_MSK</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;mute:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">onoff</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">TP_EC_AUDIO_MUTESW</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">volume_control_allowed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">unmute, mute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
					       <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">up, down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
					       <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">level &lt;level&gt;&quot;</span>
					       <span class="s">&quot; (&lt;level&gt; is 0-%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">TP_EC_VOLUME_MAX</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">volume_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">new_level</span><span class="p">,</span> <span class="n">new_mute</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We do allow volume control at driver startup, so that the</span>
<span class="cm">	 * user can set initial state through the volume=... parameter hack.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">volume_control_allowed</span> <span class="o">&amp;&amp;</span> <span class="n">tpacpi_lifecycle</span> <span class="o">!=</span> <span class="n">TPACPI_LIFE_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">tp_warned</span><span class="p">.</span><span class="n">volume_ctrl_forbidden</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tp_warned</span><span class="p">.</span><span class="n">volume_ctrl_forbidden</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Console audio control in monitor mode, &quot;</span>
				  <span class="s">&quot;changes are not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Use the volume_control=1 module parameter &quot;</span>
				  <span class="s">&quot;to enable volume control</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">new_level</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">TP_EC_AUDIO_LVL_MSK</span><span class="p">;</span>
	<span class="n">new_mute</span>  <span class="o">=</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="n">TP_EC_AUDIO_MUTESW_MSK</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;up&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_mute</span><span class="p">)</span>
					<span class="n">new_mute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_level</span> <span class="o">&lt;</span> <span class="n">TP_EC_VOLUME_MAX</span><span class="p">)</span>
					<span class="n">new_level</span><span class="o">++</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;down&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">new_mute</span><span class="p">)</span>
					<span class="n">new_mute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">new_level</span><span class="o">--</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;level %u&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
				   <span class="n">l</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="n">TP_EC_VOLUME_MAX</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">new_level</span> <span class="o">=</span> <span class="n">l</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;mute&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">new_mute</span> <span class="o">=</span> <span class="n">TP_EC_AUDIO_MUTESW_MSK</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;unmute&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">new_mute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">mixer_no_level_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs volume&quot;</span><span class="p">,</span> <span class="s">&quot;%smute</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">new_mute</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_set_mute</span><span class="p">(</span><span class="o">!!</span><span class="n">new_mute</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs volume&quot;</span><span class="p">,</span>
					<span class="s">&quot;%smute and set level to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">new_mute</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;un&quot;</span><span class="p">,</span> <span class="n">new_level</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">volume_set_status</span><span class="p">(</span><span class="n">new_mute</span> <span class="o">|</span> <span class="n">new_level</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">volume_alsa_notify_change</span><span class="p">();</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">:</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">volume_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;volume&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">volume_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">volume_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">volume_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">volume_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">volume_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">volume_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_THINKPAD_ACPI_ALSA_SUPPORT */</span><span class="cp"></span>

<span class="cp">#define alsa_card NULL</span>

<span class="k">static</span> <span class="kt">void</span> <span class="kr">inline</span> <span class="nf">volume_alsa_notify_change</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">volume_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;volume: disabled as there is no ALSA support in this kernel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">volume_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;volume&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_THINKPAD_ACPI_ALSA_SUPPORT */</span><span class="cp"></span>

<span class="cm">/*************************************************************************</span>
<span class="cm"> * Fan subdriver</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * FAN ACCESS MODES</span>
<span class="cm"> *</span>
<span class="cm"> * TPACPI_FAN_RD_ACPI_GFAN:</span>
<span class="cm"> * 	ACPI GFAN method: returns fan level</span>
<span class="cm"> *</span>
<span class="cm"> * 	see TPACPI_FAN_WR_ACPI_SFAN</span>
<span class="cm"> * 	EC 0x2f (HFSP) not available if GFAN exists</span>
<span class="cm"> *</span>
<span class="cm"> * TPACPI_FAN_WR_ACPI_SFAN:</span>
<span class="cm"> * 	ACPI SFAN method: sets fan level, 0 (stop) to 7 (max)</span>
<span class="cm"> *</span>
<span class="cm"> * 	EC 0x2f (HFSP) might be available *for reading*, but do not use</span>
<span class="cm"> * 	it for writing.</span>
<span class="cm"> *</span>
<span class="cm"> * TPACPI_FAN_WR_TPEC:</span>
<span class="cm"> * 	ThinkPad EC register 0x2f (HFSP): fan control loop mode</span>
<span class="cm"> * 	Supported on almost all ThinkPads</span>
<span class="cm"> *</span>
<span class="cm"> * 	Fan speed changes of any sort (including those caused by the</span>
<span class="cm"> * 	disengaged mode) are usually done slowly by the firmware as the</span>
<span class="cm"> * 	maximum amount of fan duty cycle change per second seems to be</span>
<span class="cm"> * 	limited.</span>
<span class="cm"> *</span>
<span class="cm"> * 	Reading is not available if GFAN exists.</span>
<span class="cm"> * 	Writing is not available if SFAN exists.</span>
<span class="cm"> *</span>
<span class="cm"> * 	Bits</span>
<span class="cm"> *	 7	automatic mode engaged;</span>
<span class="cm"> *  		(default operation mode of the ThinkPad)</span>
<span class="cm"> * 		fan level is ignored in this mode.</span>
<span class="cm"> *	 6	full speed mode (takes precedence over bit 7);</span>
<span class="cm"> *		not available on all thinkpads.  May disable</span>
<span class="cm"> *		the tachometer while the fan controller ramps up</span>
<span class="cm"> *		the speed (which can take up to a few *minutes*).</span>
<span class="cm"> *		Speeds up fan to 100% duty-cycle, which is far above</span>
<span class="cm"> *		the standard RPM levels.  It is not impossible that</span>
<span class="cm"> *		it could cause hardware damage.</span>
<span class="cm"> *	5-3	unused in some models.  Extra bits for fan level</span>
<span class="cm"> *		in others, but still useless as all values above</span>
<span class="cm"> *		7 map to the same speed as level 7 in these models.</span>
<span class="cm"> *	2-0	fan level (0..7 usually)</span>
<span class="cm"> *			0x00 = stop</span>
<span class="cm"> * 			0x07 = max (set when temperatures critical)</span>
<span class="cm"> * 		Some ThinkPads may have other levels, see</span>
<span class="cm"> * 		TPACPI_FAN_WR_ACPI_FANS (X31/X40/X41)</span>
<span class="cm"> *</span>
<span class="cm"> *	FIRMWARE BUG: on some models, EC 0x2f might not be initialized at</span>
<span class="cm"> *	boot. Apparently the EC does not initialize it, so unless ACPI DSDT</span>
<span class="cm"> *	does so, its initial value is meaningless (0x07).</span>
<span class="cm"> *</span>
<span class="cm"> *	For firmware bugs, refer to:</span>
<span class="cm"> *	http://thinkwiki.org/wiki/Embedded_Controller_Firmware#Firmware_Issues</span>
<span class="cm"> *</span>
<span class="cm"> * 	----</span>
<span class="cm"> *</span>
<span class="cm"> *	ThinkPad EC register 0x84 (LSB), 0x85 (MSB):</span>
<span class="cm"> *	Main fan tachometer reading (in RPM)</span>
<span class="cm"> *</span>
<span class="cm"> *	This register is present on all ThinkPads with a new-style EC, and</span>
<span class="cm"> *	it is known not to be present on the A21m/e, and T22, as there is</span>
<span class="cm"> *	something else in offset 0x84 according to the ACPI DSDT.  Other</span>
<span class="cm"> *	ThinkPads from this same time period (and earlier) probably lack the</span>
<span class="cm"> *	tachometer as well.</span>
<span class="cm"> *</span>
<span class="cm"> *	Unfortunately a lot of ThinkPads with new-style ECs but whose firmware</span>
<span class="cm"> *	was never fixed by IBM to report the EC firmware version string</span>
<span class="cm"> *	probably support the tachometer (like the early X models), so</span>
<span class="cm"> *	detecting it is quite hard.  We need more data to know for sure.</span>
<span class="cm"> *</span>
<span class="cm"> *	FIRMWARE BUG: always read 0x84 first, otherwise incorrect readings</span>
<span class="cm"> *	might result.</span>
<span class="cm"> *</span>
<span class="cm"> *	FIRMWARE BUG: may go stale while the EC is switching to full speed</span>
<span class="cm"> *	mode.</span>
<span class="cm"> *</span>
<span class="cm"> *	For firmware bugs, refer to:</span>
<span class="cm"> *	http://thinkwiki.org/wiki/Embedded_Controller_Firmware#Firmware_Issues</span>
<span class="cm"> *</span>
<span class="cm"> *	----</span>
<span class="cm"> *</span>
<span class="cm"> *	ThinkPad EC register 0x31 bit 0 (only on select models)</span>
<span class="cm"> *</span>
<span class="cm"> *	When bit 0 of EC register 0x31 is zero, the tachometer registers</span>
<span class="cm"> *	show the speed of the main fan.  When bit 0 of EC register 0x31</span>
<span class="cm"> *	is one, the tachometer registers show the speed of the auxiliary</span>
<span class="cm"> *	fan.</span>
<span class="cm"> *</span>
<span class="cm"> *	Fan control seems to affect both fans, regardless of the state</span>
<span class="cm"> *	of this bit.</span>
<span class="cm"> *</span>
<span class="cm"> *	So far, only the firmware for the X60/X61 non-tablet versions</span>
<span class="cm"> *	seem to support this (firmware TP-7M).</span>
<span class="cm"> *</span>
<span class="cm"> * TPACPI_FAN_WR_ACPI_FANS:</span>
<span class="cm"> *	ThinkPad X31, X40, X41.  Not available in the X60.</span>
<span class="cm"> *</span>
<span class="cm"> *	FANS ACPI handle: takes three arguments: low speed, medium speed,</span>
<span class="cm"> *	high speed.  ACPI DSDT seems to map these three speeds to levels</span>
<span class="cm"> *	as follows: STOP LOW LOW MED MED HIGH HIGH HIGH HIGH</span>
<span class="cm"> *	(this map is stored on FAN0..FAN8 as &quot;0,1,1,2,2,3,3,3,3&quot;)</span>
<span class="cm"> *</span>
<span class="cm"> * 	The speeds are stored on handles</span>
<span class="cm"> * 	(FANA:FAN9), (FANC:FANB), (FANE:FAND).</span>
<span class="cm"> *</span>
<span class="cm"> * 	There are three default speed sets, accessible as handles:</span>
<span class="cm"> * 	FS1L,FS1M,FS1H; FS2L,FS2M,FS2H; FS3L,FS3M,FS3H</span>
<span class="cm"> *</span>
<span class="cm"> * 	ACPI DSDT switches which set is in use depending on various</span>
<span class="cm"> * 	factors.</span>
<span class="cm"> *</span>
<span class="cm"> * 	TPACPI_FAN_WR_TPEC is also available and should be used to</span>
<span class="cm"> * 	command the fan.  The X31/X40/X41 seems to have 8 fan levels,</span>
<span class="cm"> * 	but the ACPI tables just mention level 7.</span>
<span class="cm"> */</span>

<span class="k">enum</span> <span class="p">{</span>					<span class="cm">/* Fan control constants */</span>
	<span class="n">fan_status_offset</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">,</span>	<span class="cm">/* EC register 0x2f */</span>
	<span class="n">fan_rpm_offset</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">,</span>		<span class="cm">/* EC register 0x84: LSB, 0x85 MSB (RPM)</span>
<span class="cm">					 * 0x84 must be read before 0x85 */</span>
	<span class="n">fan_select_offset</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">,</span>	<span class="cm">/* EC register 0x31 (Firmware 7M)</span>
<span class="cm">					   bit 0 selects which fan is active */</span>

	<span class="n">TP_EC_FAN_FULLSPEED</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/* EC fan mode: full speed */</span>
	<span class="n">TP_EC_FAN_AUTO</span>	    <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>	<span class="cm">/* EC fan mode: auto fan control */</span>

	<span class="n">TPACPI_FAN_LAST_LEVEL</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">,</span>	<span class="cm">/* Use cached last-seen fan level */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">fan_status_access_mode</span> <span class="p">{</span>
	<span class="n">TPACPI_FAN_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* No fan status or control */</span>
	<span class="n">TPACPI_FAN_RD_ACPI_GFAN</span><span class="p">,</span>	<span class="cm">/* Use ACPI GFAN */</span>
	<span class="n">TPACPI_FAN_RD_TPEC</span><span class="p">,</span>		<span class="cm">/* Use ACPI EC regs 0x2f, 0x84-0x85 */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">fan_control_access_mode</span> <span class="p">{</span>
	<span class="n">TPACPI_FAN_WR_NONE</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* No fan control */</span>
	<span class="n">TPACPI_FAN_WR_ACPI_SFAN</span><span class="p">,</span>	<span class="cm">/* Use ACPI SFAN */</span>
	<span class="n">TPACPI_FAN_WR_TPEC</span><span class="p">,</span>		<span class="cm">/* Use ACPI EC reg 0x2f */</span>
	<span class="n">TPACPI_FAN_WR_ACPI_FANS</span><span class="p">,</span>	<span class="cm">/* Use ACPI FANS and EC reg 0x2f */</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">fan_control_commands</span> <span class="p">{</span>
	<span class="n">TPACPI_FAN_CMD_SPEED</span> 	<span class="o">=</span> <span class="mh">0x0001</span><span class="p">,</span>	<span class="cm">/* speed command */</span>
	<span class="n">TPACPI_FAN_CMD_LEVEL</span> 	<span class="o">=</span> <span class="mh">0x0002</span><span class="p">,</span>	<span class="cm">/* level command  */</span>
	<span class="n">TPACPI_FAN_CMD_ENABLE</span>	<span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>	<span class="cm">/* enable/disable cmd,</span>
<span class="cm">						 * and also watchdog cmd */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">fan_control_allowed</span><span class="p">;</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">fan_status_access_mode</span> <span class="n">fan_status_access_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">fan_control_access_mode</span> <span class="n">fan_control_access_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">fan_control_commands</span> <span class="n">fan_control_commands</span><span class="p">;</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">fan_control_initial_status</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">fan_control_desired_level</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">fan_control_resume_level</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fan_watchdog_maxinterval</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">fan_mutex</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fan_watchdog_fire</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">fan_watchdog_task</span><span class="p">,</span> <span class="n">fan_watchdog_fire</span><span class="p">);</span>

<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">fans</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="s">&quot;FANS&quot;</span><span class="p">);</span>	<span class="cm">/* X31, X40, X41 */</span>
<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">gfan</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="s">&quot;GFAN&quot;</span><span class="p">,</span>	<span class="cm">/* 570 */</span>
	   <span class="s">&quot;</span><span class="se">\\</span><span class="s">FSPD&quot;</span><span class="p">,</span>		<span class="cm">/* 600e/x, 770e, 770x */</span>
	   <span class="p">);</span>			<span class="cm">/* all others */</span>
<span class="n">TPACPI_HANDLE</span><span class="p">(</span><span class="n">sfan</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="s">&quot;SFAN&quot;</span><span class="p">,</span>	<span class="cm">/* 570 */</span>
	   <span class="s">&quot;JFNS&quot;</span><span class="p">,</span>		<span class="cm">/* 770x-JL */</span>
	   <span class="p">);</span>			<span class="cm">/* all others */</span>

<span class="cm">/*</span>
<span class="cm"> * Unitialized HFSP quirk: ACPI DSDT and EC fail to initialize the</span>
<span class="cm"> * HFSP register at boot, so it contains 0x07 but the Thinkpad could</span>
<span class="cm"> * be in auto mode (0x80).</span>
<span class="cm"> *</span>
<span class="cm"> * This is corrected by any write to HFSP either by the driver, or</span>
<span class="cm"> * by the firmware.</span>
<span class="cm"> *</span>
<span class="cm"> * We assume 0x07 really means auto mode while this quirk is active,</span>
<span class="cm"> * as this is far more likely than the ThinkPad being in level 7,</span>
<span class="cm"> * which is only used by the firmware during thermal emergencies.</span>
<span class="cm"> *</span>
<span class="cm"> * Enable for TP-1Y (T43), TP-78 (R51e), TP-76 (R52),</span>
<span class="cm"> * TP-70 (T43, R52), which are known to be buggy.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fan_quirk1_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_control_initial_status</span> <span class="o">==</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;fan_init: initial fan status is unknown, &quot;</span>
			  <span class="s">&quot;assuming it is in auto mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">fan_ctrl_status_undef</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fan_quirk1_handle</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">fan_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">fan_ctrl_status_undef</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fan_status</span> <span class="o">!=</span> <span class="n">fan_control_initial_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* something changed the HFSP regisnter since</span>
<span class="cm">			 * driver init time, so it is not undefined</span>
<span class="cm">			 * anymore */</span>
			<span class="n">tp_features</span><span class="p">.</span><span class="n">fan_ctrl_status_undef</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Return most likely status. In fact, it</span>
<span class="cm">			 * might be the only possible status */</span>
			<span class="o">*</span><span class="n">fan_status</span> <span class="o">=</span> <span class="n">TP_EC_FAN_AUTO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Select main fan on X60/X61, NOOP on others */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">fan_select_fan1</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">second_fan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ec_read</span><span class="p">(</span><span class="n">fan_select_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xFEU</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ec_write</span><span class="p">(</span><span class="n">fan_select_offset</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Select secondary fan on X60/X61 */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">fan_select_fan2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp_features</span><span class="p">.</span><span class="n">second_fan</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ec_read</span><span class="p">(</span><span class="n">fan_select_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x01U</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ec_write</span><span class="p">(</span><span class="n">fan_select_offset</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call with fan_mutex held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fan_update_desired_level</span><span class="p">(</span><span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">TP_EC_FAN_AUTO</span> <span class="o">|</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">fan_control_desired_level</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fan_control_desired_level</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_get_status</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">;</span>

	<span class="cm">/* TODO:</span>
<span class="cm">	 * Add TPACPI_FAN_RD_ACPI_FANS ? */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fan_status_access_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_RD_ACPI_GFAN</span>:
		<span class="cm">/* 570, 600e/x, 770e, 770x */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">gfan_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">s</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TPACPI_FAN_RD_TPEC</span>:
		<span class="cm">/* all except 570, 600e/x, 770e, 770x */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">fan_status_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
			<span class="n">fan_quirk1_handle</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_get_status_safe</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fan_update_desired_level</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_get_speed</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fan_status_access_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_RD_TPEC</span>:
		<span class="cm">/* all except 570, 600e/x, 770e, 770x */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">fan_select_fan1</span><span class="p">()))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">fan_rpm_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">)</span> <span class="o">||</span>
			     <span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">fan_rpm_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">speed</span><span class="p">))</span>
			<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">lo</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan2_get_speed</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fan_status_access_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_RD_TPEC</span>:
		<span class="cm">/* all except 570, 600e/x, 770e, 770x */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">fan_select_fan2</span><span class="p">()))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">fan_rpm_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">)</span> <span class="o">||</span>
			     <span class="o">!</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">fan_rpm_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">);</span>
		<span class="n">fan_select_fan1</span><span class="p">();</span> <span class="cm">/* play it safe */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">speed</span><span class="p">))</span>
			<span class="o">*</span><span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">lo</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_set_level</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fan_control_allowed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fan_control_access_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_SFAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">level</span> <span class="o">&lt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">sfan_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_FANS</span>:
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_TPEC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">level</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_AUTO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">level</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* safety net should the EC not support AUTO</span>
<span class="cm">		 * or FULLSPEED mode bits and just ignore them */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">)</span>
			<span class="n">level</span> <span class="o">|=</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* safety min speed 7 */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_AUTO</span><span class="p">)</span>
			<span class="n">level</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* safety min speed 4 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_write</span><span class="p">(</span><span class="n">fan_status_offset</span><span class="p">,</span> <span class="n">level</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tp_features</span><span class="p">.</span><span class="n">fan_ctrl_status_undef</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_FAN</span><span class="p">,</span>
		<span class="s">&quot;fan control: set fan control register to 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_set_level_safe</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fan_control_allowed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="n">TPACPI_FAN_LAST_LEVEL</span><span class="p">)</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">fan_control_desired_level</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_set_level</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">fan_update_desired_level</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_set_enable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fan_control_allowed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fan_control_access_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_FANS</span>:
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_TPEC</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Don&#39;t go out of emergency fan mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span> <span class="o">&amp;=</span> <span class="mh">0x07</span><span class="p">;</span>
			<span class="n">s</span> <span class="o">|=</span> <span class="n">TP_EC_FAN_AUTO</span> <span class="o">|</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* min fan speed 4 */</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_write</span><span class="p">(</span><span class="n">fan_status_offset</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">tp_features</span><span class="p">.</span><span class="n">fan_ctrl_status_undef</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_SFAN</span>:
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">s</span> <span class="o">&amp;=</span> <span class="mh">0x07</span><span class="p">;</span>

		<span class="cm">/* Set fan to at least level 4 */</span>
		<span class="n">s</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">sfan_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_FAN</span><span class="p">,</span>
			<span class="s">&quot;fan control: set fan control register to 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_set_disable</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fan_control_allowed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fan_control_access_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_FANS</span>:
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_TPEC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_ec_write</span><span class="p">(</span><span class="n">fan_status_offset</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">fan_control_desired_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tp_features</span><span class="p">.</span><span class="n">fan_ctrl_status_undef</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_SFAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">sfan_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vd&quot;</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fan_control_desired_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_FAN</span><span class="p">,</span>
			<span class="s">&quot;fan control: set fan control register to 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_set_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fan_control_allowed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fan_control_access_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_FANS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">&lt;=</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_evalf</span><span class="p">(</span><span class="n">fans_handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;vddd&quot;</span><span class="p">,</span>
					<span class="n">speed</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">speed</span><span class="p">))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fan_watchdog_reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">fan_watchdog_active</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_control_access_mode</span> <span class="o">==</span> <span class="n">TPACPI_FAN_WR_NONE</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_watchdog_active</span><span class="p">)</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_watchdog_task</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_watchdog_maxinterval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">tpacpi_lifecycle</span> <span class="o">!=</span> <span class="n">TPACPI_LIFE_EXITING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fan_watchdog_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">tpacpi_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fan_watchdog_task</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">fan_watchdog_maxinterval</span>
						 <span class="o">*</span> <span class="mi">1000</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to queue the fan watchdog, &quot;</span>
			       <span class="s">&quot;watchdog will not trigger</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">fan_watchdog_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fan_watchdog_fire</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_lifecycle</span> <span class="o">!=</span> <span class="n">TPACPI_LIFE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;fan watchdog: enabling fan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_set_enable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;fan watchdog: error %d while enabling fan, &quot;</span>
		       <span class="s">&quot;will try again later...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">rc</span><span class="p">);</span>
		<span class="cm">/* reschedule for later */</span>
		<span class="n">fan_watchdog_reset</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SYSFS fan layout: hwmon compatible (device)</span>
<span class="cm"> *</span>
<span class="cm"> * pwm*_enable:</span>
<span class="cm"> * 	0: &quot;disengaged&quot; mode</span>
<span class="cm"> * 	1: manual mode</span>
<span class="cm"> * 	2: native EC &quot;auto&quot; mode (recommended, hardware default)</span>
<span class="cm"> *</span>
<span class="cm"> * pwm*: set speed in manual mode, ignored otherwise.</span>
<span class="cm"> * 	0 is level 0; 255 is level 7. Intermediate points done with linear</span>
<span class="cm"> * 	interpolation.</span>
<span class="cm"> *</span>
<span class="cm"> * fan*_input: tachometer reading, RPM</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * SYSFS fan layout: extensions</span>
<span class="cm"> *</span>
<span class="cm"> * fan_watchdog (driver):</span>
<span class="cm"> * 	fan watchdog interval in seconds, 0 disables (default), max 120</span>
<span class="cm"> */</span>

<span class="cm">/* sysfs fan pwm1_enable ----------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fan_pwm1_enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">fan_get_status_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fan_pwm1_enable_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;hwmon pwm1_enable&quot;</span><span class="p">,</span>
			<span class="s">&quot;set fan mode to %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="n">TPACPI_FAN_LAST_LEVEL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">level</span> <span class="o">=</span> <span class="n">TP_EC_FAN_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* reserved for software-controlled auto mode */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">fan_set_level_safe</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">fan_watchdog_reset</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_fan_pwm1_enable</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pwm1_enable</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">fan_pwm1_enable_show</span><span class="p">,</span> <span class="n">fan_pwm1_enable_store</span><span class="p">);</span>

<span class="cm">/* sysfs fan pwm1 ------------------------------------------------------ */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fan_pwm1_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">fan_get_status_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">TP_EC_FAN_AUTO</span> <span class="o">|</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">fan_control_desired_level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span> <span class="o">*</span> <span class="mi">255</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fan_pwm1_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">newlevel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;hwmon pwm1&quot;</span><span class="p">,</span>
			<span class="s">&quot;set fan speed to %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="cm">/* scale down from 0-255 to 0-7 */</span>
	<span class="n">newlevel</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_killable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">TP_EC_FAN_AUTO</span> <span class="o">|</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_set_level</span><span class="p">(</span><span class="n">newlevel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fan_update_desired_level</span><span class="p">(</span><span class="n">newlevel</span><span class="p">);</span>
			<span class="n">fan_watchdog_reset</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span><span class="o">?</span> <span class="n">rc</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_fan_pwm1</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pwm1</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">fan_pwm1_show</span><span class="p">,</span> <span class="n">fan_pwm1_store</span><span class="p">);</span>

<span class="cm">/* sysfs fan fan1_input ------------------------------------------------ */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fan_fan1_input_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">fan_get_speed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_fan_fan1_input</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">fan1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">fan_fan1_input_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* sysfs fan fan2_input ------------------------------------------------ */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fan_fan2_input_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">fan2_get_speed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_fan_fan2_input</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">fan2_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">fan_fan2_input_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* sysfs fan fan_watchdog (hwmon driver) ------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fan_fan_watchdog_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fan_watchdog_maxinterval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fan_fan_watchdog_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parse_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fan_control_allowed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">fan_watchdog_maxinterval</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">fan_watchdog_reset</span><span class="p">();</span>

	<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;fan_watchdog&quot;</span><span class="p">,</span> <span class="s">&quot;set to %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">fan_watchdog</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		<span class="n">fan_fan_watchdog_show</span><span class="p">,</span> <span class="n">fan_fan_watchdog_store</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">fan_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fan_pwm1_enable</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_fan_pwm1</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fan_fan1_input</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* for fan2_input */</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">fan_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">fan_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define	TPACPI_FAN_Q1	0x0001		</span><span class="cm">/* Unitialized HFSP */</span><span class="cp"></span>
<span class="cp">#define TPACPI_FAN_2FAN	0x0002		</span><span class="cm">/* EC 0x31 bit 0 selects fan2 */</span><span class="cp"></span>

<span class="cp">#define TPACPI_FAN_QI(__id1, __id2, __quirks)	\</span>
<span class="cp">	{ .vendor = PCI_VENDOR_ID_IBM,		\</span>
<span class="cp">	  .bios = TPACPI_MATCH_ANY,		\</span>
<span class="cp">	  .ec = TPID(__id1, __id2),		\</span>
<span class="cp">	  .quirks = __quirks }</span>

<span class="cp">#define TPACPI_FAN_QL(__id1, __id2, __quirks)	\</span>
<span class="cp">	{ .vendor = PCI_VENDOR_ID_LENOVO,	\</span>
<span class="cp">	  .bios = TPACPI_MATCH_ANY,		\</span>
<span class="cp">	  .ec = TPID(__id1, __id2),		\</span>
<span class="cp">	  .quirks = __quirks }</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tpacpi_quirk</span> <span class="n">fan_quirk_table</span><span class="p">[]</span> <span class="n">__initconst</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">TPACPI_FAN_QI</span><span class="p">(</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span> <span class="n">TPACPI_FAN_Q1</span><span class="p">),</span>
	<span class="n">TPACPI_FAN_QI</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;8&#39;</span><span class="p">,</span> <span class="n">TPACPI_FAN_Q1</span><span class="p">),</span>
	<span class="n">TPACPI_FAN_QI</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;6&#39;</span><span class="p">,</span> <span class="n">TPACPI_FAN_Q1</span><span class="p">),</span>
	<span class="n">TPACPI_FAN_QI</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;0&#39;</span><span class="p">,</span> <span class="n">TPACPI_FAN_Q1</span><span class="p">),</span>
	<span class="n">TPACPI_FAN_QL</span><span class="p">(</span><span class="sc">&#39;7&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="n">TPACPI_FAN_2FAN</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#undef TPACPI_FAN_QL</span>
<span class="cp">#undef TPACPI_FAN_QI</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fan_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">quirks</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_FAN</span><span class="p">,</span>
			<span class="s">&quot;initializing fan subdriver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_mutex</span><span class="p">);</span>
	<span class="n">fan_status_access_mode</span> <span class="o">=</span> <span class="n">TPACPI_FAN_NONE</span><span class="p">;</span>
	<span class="n">fan_control_access_mode</span> <span class="o">=</span> <span class="n">TPACPI_FAN_WR_NONE</span><span class="p">;</span>
	<span class="n">fan_control_commands</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fan_watchdog_maxinterval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">fan_ctrl_status_undef</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">second_fan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fan_control_desired_level</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_is_ibm</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">fans</span><span class="p">);</span>
		<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">gfan</span><span class="p">);</span>
		<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">sfan</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">quirks</span> <span class="o">=</span> <span class="n">tpacpi_check_quirks</span><span class="p">(</span><span class="n">fan_quirk_table</span><span class="p">,</span>
				     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fan_quirk_table</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gfan_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 570, 600e/x, 770e, 770x */</span>
		<span class="n">fan_status_access_mode</span> <span class="o">=</span> <span class="n">TPACPI_FAN_RD_ACPI_GFAN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* all other ThinkPads: note that even old-style</span>
<span class="cm">		 * ThinkPad ECs supports the fan control register */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">acpi_ec_read</span><span class="p">(</span><span class="n">fan_status_offset</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">fan_control_initial_status</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">fan_status_access_mode</span> <span class="o">=</span> <span class="n">TPACPI_FAN_RD_TPEC</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">TPACPI_FAN_Q1</span><span class="p">)</span>
				<span class="n">fan_quirk1_setup</span><span class="p">();</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">TPACPI_FAN_2FAN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tp_features</span><span class="p">.</span><span class="n">second_fan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_FAN</span><span class="p">,</span>
					<span class="s">&quot;secondary fan support enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ThinkPad ACPI EC access misbehaving, &quot;</span>
			       <span class="s">&quot;fan status and control unavailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sfan_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 570, 770x-JL */</span>
		<span class="n">fan_control_access_mode</span> <span class="o">=</span> <span class="n">TPACPI_FAN_WR_ACPI_SFAN</span><span class="p">;</span>
		<span class="n">fan_control_commands</span> <span class="o">|=</span>
		    <span class="n">TPACPI_FAN_CMD_LEVEL</span> <span class="o">|</span> <span class="n">TPACPI_FAN_CMD_ENABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gfan_handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* gfan without sfan means no fan control */</span>
			<span class="cm">/* all other models implement TP EC 0x2f control */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">fans_handle</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* X31, X40, X41 */</span>
				<span class="n">fan_control_access_mode</span> <span class="o">=</span>
				    <span class="n">TPACPI_FAN_WR_ACPI_FANS</span><span class="p">;</span>
				<span class="n">fan_control_commands</span> <span class="o">|=</span>
				    <span class="n">TPACPI_FAN_CMD_SPEED</span> <span class="o">|</span>
				    <span class="n">TPACPI_FAN_CMD_LEVEL</span> <span class="o">|</span>
				    <span class="n">TPACPI_FAN_CMD_ENABLE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">fan_control_access_mode</span> <span class="o">=</span> <span class="n">TPACPI_FAN_WR_TPEC</span><span class="p">;</span>
				<span class="n">fan_control_commands</span> <span class="o">|=</span>
				    <span class="n">TPACPI_FAN_CMD_LEVEL</span> <span class="o">|</span>
				    <span class="n">TPACPI_FAN_CMD_ENABLE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_FAN</span><span class="p">,</span>
		<span class="s">&quot;fan is %s, modes %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">str_supported</span><span class="p">(</span><span class="n">fan_status_access_mode</span> <span class="o">!=</span> <span class="n">TPACPI_FAN_NONE</span> <span class="o">||</span>
		  <span class="n">fan_control_access_mode</span> <span class="o">!=</span> <span class="n">TPACPI_FAN_WR_NONE</span><span class="p">),</span>
		<span class="n">fan_status_access_mode</span><span class="p">,</span> <span class="n">fan_control_access_mode</span><span class="p">);</span>

	<span class="cm">/* fan control master switch */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fan_control_allowed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fan_control_access_mode</span> <span class="o">=</span> <span class="n">TPACPI_FAN_WR_NONE</span><span class="p">;</span>
		<span class="n">fan_control_commands</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_FAN</span><span class="p">,</span>
			   <span class="s">&quot;fan control features disabled by parameter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* update fan_control_desired_level */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_status_access_mode</span> <span class="o">!=</span> <span class="n">TPACPI_FAN_NONE</span><span class="p">)</span>
		<span class="n">fan_get_status_safe</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_status_access_mode</span> <span class="o">!=</span> <span class="n">TPACPI_FAN_NONE</span> <span class="o">||</span>
	    <span class="n">fan_control_access_mode</span> <span class="o">!=</span> <span class="n">TPACPI_FAN_WR_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">second_fan</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* attach second fan tachometer */</span>
			<span class="n">fan_attributes</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fan_attributes</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
					<span class="o">&amp;</span><span class="n">dev_attr_fan_fan2_input</span><span class="p">.</span><span class="n">attr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">fan_attr_group</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_hwmon_pdriver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">driver_attr_fan_watchdog</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">fan_attr_group</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fan_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_EXIT</span> <span class="o">|</span> <span class="n">TPACPI_DBG_FAN</span><span class="p">,</span>
		    <span class="s">&quot;cancelling any pending fan watchdog tasks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* FIXME: can we really do this unconditionally? */</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fan_attr_group</span><span class="p">);</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_hwmon_pdriver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">driver_attr_fan_watchdog</span><span class="p">);</span>

	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_watchdog_task</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">tpacpi_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fan_suspend</span><span class="p">(</span><span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fan_control_allowed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Store fan status in cache */</span>
	<span class="n">fan_control_resume_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_get_status_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fan_control_resume_level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;failed to read fan level for later &quot;</span>
			  <span class="s">&quot;restore during resume: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>

	<span class="cm">/* if it is undefined, don&#39;t attempt to restore it.</span>
<span class="cm">	 * KEEP THIS LAST */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">fan_ctrl_status_undef</span><span class="p">)</span>
		<span class="n">fan_control_resume_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fan_resume</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">current_level</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_set</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* DSDT *always* updates status on resume */</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">fan_ctrl_status_undef</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fan_control_allowed</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">fan_control_resume_level</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">fan_get_status_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_level</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fan_control_access_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_SFAN</span>:
		<span class="cm">/* never decrease fan level */</span>
		<span class="n">do_set</span> <span class="o">=</span> <span class="p">(</span><span class="n">fan_control_resume_level</span> <span class="o">&gt;</span> <span class="n">current_level</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_FANS</span>:
	<span class="k">case</span> <span class="n">TPACPI_FAN_WR_TPEC</span>:
		<span class="cm">/* never decrease fan level, scale is:</span>
<span class="cm">		 * TP_EC_FAN_FULLSPEED &gt; 7 &gt;= TP_EC_FAN_AUTO</span>
<span class="cm">		 *</span>
<span class="cm">		 * We expect the firmware to set either 7 or AUTO, but we</span>
<span class="cm">		 * handle FULLSPEED out of paranoia.</span>
<span class="cm">		 *</span>
<span class="cm">		 * So, we can safely only restore FULLSPEED or 7, anything</span>
<span class="cm">		 * else could slow the fan.  Restoring AUTO is useless, at</span>
<span class="cm">		 * best that&#39;s exactly what the DSDT already set (it is the</span>
<span class="cm">		 * slower it uses).</span>
<span class="cm">		 *</span>
<span class="cm">		 * Always keep in mind that the DSDT *will* have set the</span>
<span class="cm">		 * fans to what the vendor supposes is the best level.  We</span>
<span class="cm">		 * muck with it only to speed the fan up.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fan_control_resume_level</span> <span class="o">!=</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">fan_control_resume_level</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">do_set</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">current_level</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				 <span class="p">(</span><span class="n">current_level</span> <span class="o">!=</span> <span class="n">fan_control_resume_level</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;restoring fan level to 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">fan_control_resume_level</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_set_level_safe</span><span class="p">(</span><span class="n">fan_control_resume_level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;failed to restore fan level: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fan_status_access_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TPACPI_FAN_RD_ACPI_GFAN</span>:
		<span class="cm">/* 570, 600e/x, 770e, 770x */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_get_status_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;level:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TPACPI_FAN_RD_TPEC</span>:
		<span class="cm">/* all except 570, 600e/x, 770e, 770x */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_get_status_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_get_speed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;speed:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">)</span>
			<span class="cm">/* Disengaged mode takes precedence */</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;level:</span><span class="se">\t\t</span><span class="s">disengaged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TP_EC_FAN_AUTO</span><span class="p">)</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;level:</span><span class="se">\t\t</span><span class="s">auto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;level:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TPACPI_FAN_NONE</span>:
	<span class="nl">default:</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;status:</span><span class="se">\t\t</span><span class="s">not supported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_control_commands</span> <span class="o">&amp;</span> <span class="n">TPACPI_FAN_CMD_LEVEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">level &lt;level&gt;&quot;</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">fan_control_access_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TPACPI_FAN_WR_ACPI_SFAN</span>:
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (&lt;level&gt; is 0-7)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; (&lt;level&gt; is 0-7, &quot;</span>
				       <span class="s">&quot;auto, disengaged, full-speed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_control_commands</span> <span class="o">&amp;</span> <span class="n">TPACPI_FAN_CMD_ENABLE</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">enable, disable</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">watchdog &lt;timeout&gt; (&lt;timeout&gt; &quot;</span>
			       <span class="s">&quot;is 0 (off), 1-120 (seconds))</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_control_commands</span> <span class="o">&amp;</span> <span class="n">TPACPI_FAN_CMD_SPEED</span><span class="p">)</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;commands:</span><span class="se">\t</span><span class="s">speed &lt;speed&gt;&quot;</span>
			       <span class="s">&quot; (&lt;speed&gt; is 0-65535)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_write_cmd_level</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;level auto&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">TP_EC_FAN_AUTO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;level disengaged&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;level full-speed&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">level</span> <span class="o">=</span> <span class="n">TP_EC_FAN_FULLSPEED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;level %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">fan_set_level_safe</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;level command accepted for unsupported access mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fan_control_access_mode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs fan&quot;</span><span class="p">,</span>
			<span class="s">&quot;set level to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_write_cmd_enable</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;enable&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">fan_set_enable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;enable command accepted for unsupported access mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fan_control_access_mode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs fan&quot;</span><span class="p">,</span> <span class="s">&quot;enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_write_cmd_disable</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlencmp</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;disable&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">fan_set_disable</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;disable command accepted for unsupported access mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fan_control_access_mode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs fan&quot;</span><span class="p">,</span> <span class="s">&quot;disable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_write_cmd_speed</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">speed</span><span class="p">;</span>

	<span class="cm">/* TODO:</span>
<span class="cm">	 * Support speed &lt;low&gt; &lt;medium&gt; &lt;high&gt; ? */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;speed %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">speed</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="n">fan_set_speed</span><span class="p">(</span><span class="n">speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;speed command accepted for unsupported access mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fan_control_access_mode</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs fan&quot;</span><span class="p">,</span>
			<span class="s">&quot;set speed to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_write_cmd_watchdog</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">interval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="s">&quot;watchdog %d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interval</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">120</span><span class="p">)</span>
		<span class="o">*</span><span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">fan_watchdog_maxinterval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
		<span class="n">tpacpi_disclose_usertask</span><span class="p">(</span><span class="s">&quot;procfs fan&quot;</span><span class="p">,</span>
			<span class="s">&quot;set watchdog timer to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">interval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fan_write</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">next_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">fan_control_commands</span> <span class="o">&amp;</span> <span class="n">TPACPI_FAN_CMD_LEVEL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="n">fan_write_cmd_level</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">((</span><span class="n">fan_control_commands</span> <span class="o">&amp;</span> <span class="n">TPACPI_FAN_CMD_ENABLE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="p">(</span><span class="n">fan_write_cmd_enable</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">)</span> <span class="o">||</span>
		       <span class="n">fan_write_cmd_disable</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">)</span> <span class="o">||</span>
		       <span class="n">fan_write_cmd_watchdog</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">((</span><span class="n">fan_control_commands</span> <span class="o">&amp;</span> <span class="n">TPACPI_FAN_CMD_SPEED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		      <span class="n">fan_write_cmd_speed</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">))</span>
		    <span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">fan_watchdog_reset</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_struct</span> <span class="n">fan_driver_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fan&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">fan_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">fan_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span> <span class="o">=</span> <span class="n">fan_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">fan_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">fan_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/****************************************************************************</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Infrastructure</span>
<span class="cm"> *</span>
<span class="cm"> ****************************************************************************</span>
<span class="cm"> ****************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * HKEY event callout for other subdrivers go here</span>
<span class="cm"> * (yes, it is ugly, but it is quick, safe, and gets the job done</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tpacpi_driver_event</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hkey_event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ibm_backlight_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hkey_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TP_HKEY_EV_BRGHT_UP</span>:
		<span class="k">case</span> <span class="n">TP_HKEY_EV_BRGHT_DOWN</span>:
			<span class="n">tpacpi_brightness_notify_change</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alsa_card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hkey_event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TP_HKEY_EV_VOL_UP</span>:
		<span class="k">case</span> <span class="n">TP_HKEY_EV_VOL_DOWN</span>:
		<span class="k">case</span> <span class="n">TP_HKEY_EV_VOL_MUTE</span>:
			<span class="n">volume_alsa_notify_change</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hotkey_driver_event</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tpacpi_driver_event</span><span class="p">(</span><span class="n">TP_HKEY_EV_HOTKEY_BASE</span> <span class="o">+</span> <span class="n">scancode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* sysfs name ---------------------------------------------------------- */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">thinkpad_acpi_pdev_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_NAME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">dev_attr_thinkpad_acpi_pdev_name</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">thinkpad_acpi_pdev_name_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cm">/* /proc support */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_dir</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Module and infrastructure proble, init and exit handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">force_load</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">__init</span> <span class="nf">str_supported</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_supported</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">text_unsupported</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="s">&quot;not supported&quot;</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">is_supported</span><span class="p">)</span><span class="o">?</span> <span class="o">&amp;</span><span class="n">text_unsupported</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">text_unsupported</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_THINKPAD_ACPI_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ibm_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_EXIT</span><span class="p">,</span> <span class="s">&quot;removing %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">all_drivers</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">acpi_notify_installed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_EXIT</span><span class="p">,</span>
			<span class="s">&quot;%s: acpi_remove_notify_handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="p">);</span>
		<span class="n">acpi_remove_notify_handler</span><span class="p">(</span><span class="o">*</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
					   <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
					   <span class="n">dispatch_acpi_notify</span><span class="p">);</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">acpi_notify_installed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">proc_created</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_EXIT</span><span class="p">,</span>
			<span class="s">&quot;%s: remove_proc_entry</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">proc_dir</span><span class="p">);</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">proc_created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">acpi_driver_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_EXIT</span><span class="p">,</span>
			<span class="s">&quot;%s: acpi_bus_unregister_driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="p">);</span>
		<span class="n">acpi_bus_unregister_driver</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">acpi_driver_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_called</span> <span class="o">&amp;&amp;</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">exit</span><span class="p">();</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_called</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;finished removing %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ibm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="o">*</span><span class="n">iibm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span> <span class="o">=</span> <span class="n">iibm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ibm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">all_drivers</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">experimental</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">experimental</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
		<span class="s">&quot;probing for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iibm</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">iibm</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">iibm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* probe failed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">init_called</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">hid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">register_tpacpi_subdriver</span><span class="p">(</span><span class="n">ibm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">acpi</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_acpi_notify</span><span class="p">(</span><span class="n">ibm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;disabling subdriver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
		<span class="s">&quot;%s installed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">umode_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">iibm</span><span class="o">-&gt;</span><span class="n">base_procfs_mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mode</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">S_IWUSR</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">proc_dir</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">dispatch_proc_fops</span><span class="p">,</span> <span class="n">ibm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to create proc entry %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">.</span><span class="n">proc_created</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">all_drivers</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tpacpi_all_drivers</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out:</span>
	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span>
		<span class="s">&quot;%s: at error exit path with result %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ibm_exit</span><span class="p">(</span><span class="n">ibm</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Probing */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">__pure</span> <span class="n">__init</span> <span class="nf">tpacpi_is_fw_digit</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;A&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;Z&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Most models: xxyTkkWW (#.##c); Ancient 570/600 and -SL lacks (#.##c) */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">__pure</span> <span class="n">__init</span> <span class="nf">tpacpi_is_valid_fw_id</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">s</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
		<span class="n">tpacpi_is_fw_digit</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		<span class="n">tpacpi_is_fw_digit</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		<span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;T&#39;</span> <span class="o">&amp;&amp;</span>
		<span class="n">tpacpi_is_fw_digit</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
		<span class="n">tpacpi_is_fw_digit</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* returns 0 - probe ok, or &lt; 0 - probe error.</span>
<span class="cm"> * Probe ok doesn&#39;t mean thinkpad found.</span>
<span class="cm"> * On error, kfree() cleanup on tp-&gt;* is not performed, caller must do it */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__must_check</span> <span class="n">__init</span> <span class="nf">get_thinkpad_model_data</span><span class="p">(</span>
						<span class="k">struct</span> <span class="n">thinkpad_id_data</span> <span class="o">*</span><span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ec_fw_string</span><span class="p">[</span><span class="mi">18</span><span class="p">];</span>
	<span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmi_name_in_vendors</span><span class="p">(</span><span class="s">&quot;IBM&quot;</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dmi_name_in_vendors</span><span class="p">(</span><span class="s">&quot;LENOVO&quot;</span><span class="p">))</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">PCI_VENDOR_ID_LENOVO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_BIOS_VERSION</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bios_version_str</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">bios_version_str</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Really ancient ThinkPad 240X will fail this, which is fine */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpacpi_is_valid_fw_id</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">bios_version_str</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bios_model</span> <span class="o">=</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bios_version_str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			 <span class="o">|</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">bios_version_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">bios_release</span> <span class="o">=</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">bios_version_str</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			 <span class="o">|</span> <span class="n">tp</span><span class="o">-&gt;</span><span class="n">bios_version_str</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * ThinkPad T23 or newer, A31 or newer, R50e or newer,</span>
<span class="cm">	 * X32 or newer, all Z series;  Some models must have an</span>
<span class="cm">	 * up-to-date BIOS or they will not be detected.</span>
<span class="cm">	 *</span>
<span class="cm">	 * See http://thinkwiki.org/wiki/List_of_DMI_IDs</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dmi_find_device</span><span class="p">(</span><span class="n">DMI_DEV_TYPE_OEM_STRING</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			   <span class="s">&quot;IBM ThinkPad Embedded Controller -[%17c&quot;</span><span class="p">,</span>
			   <span class="n">ec_fw_string</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ec_fw_string</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ec_fw_string</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ec_fw_string</span><span class="p">[</span><span class="n">strcspn</span><span class="p">(</span><span class="n">ec_fw_string</span><span class="p">,</span> <span class="s">&quot; ]&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">tp</span><span class="o">-&gt;</span><span class="n">ec_version_str</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">ec_fw_string</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">ec_version_str</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_is_valid_fw_id</span><span class="p">(</span><span class="n">ec_fw_string</span><span class="p">,</span> <span class="sc">&#39;H&#39;</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">ec_model</span> <span class="o">=</span> <span class="n">ec_fw_string</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
						<span class="o">|</span> <span class="p">(</span><span class="n">ec_fw_string</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="n">tp</span><span class="o">-&gt;</span><span class="n">ec_release</span> <span class="o">=</span> <span class="p">(</span><span class="n">ec_fw_string</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
						<span class="o">|</span> <span class="n">ec_fw_string</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;ThinkPad firmware release %s &quot;</span>
					  <span class="s">&quot;doesn&#39;t match the known patterns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">ec_fw_string</span><span class="p">);</span>
				<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;please report this to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">TPACPI_MAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_PRODUCT_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;ThinkPad&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">strnicmp</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;Lenovo&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tp</span><span class="o">-&gt;</span><span class="n">model_str</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">model_str</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">);</span>
	<span class="n">tp</span><span class="o">-&gt;</span><span class="n">nummodel_str</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">nummodel_str</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">probe_for_thinkpad</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">is_thinkpad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* It would be dangerous to run the driver in this case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpacpi_is_ibm</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tpacpi_is_lenovo</span><span class="p">())</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Non-ancient models have better DMI tagging, but very old models</span>
<span class="cm">	 * don&#39;t.  tpacpi_is_fw_known() is a cheat to help in that case.</span>
<span class="cm">	 */</span>
	<span class="n">is_thinkpad</span> <span class="o">=</span> <span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">model_str</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
		      <span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_model</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
		      <span class="n">tpacpi_is_fw_known</span><span class="p">();</span>

	<span class="cm">/* The EC handler is required */</span>
	<span class="n">tpacpi_acpi_handle_locate</span><span class="p">(</span><span class="s">&quot;ec&quot;</span><span class="p">,</span> <span class="n">TPACPI_ACPI_EC_HID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ec_handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ec_handle</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_thinkpad</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Not yet supported ThinkPad detected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_thinkpad</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force_load</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">thinkpad_acpi_init_banner</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s v%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_DESC</span><span class="p">,</span> <span class="n">TPACPI_VERSION</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TPACPI_URL</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ThinkPad BIOS %s, EC %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">bios_version_str</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">thinkpad_id</span><span class="p">.</span><span class="n">bios_version_str</span> <span class="o">:</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_version_str</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_version_str</span> <span class="o">:</span> <span class="s">&quot;unknown&quot;</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">vendor</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">model_str</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s %s, model %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_IBM</span><span class="p">)</span> <span class="o">?</span>
				<span class="s">&quot;IBM&quot;</span> <span class="o">:</span> <span class="p">((</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span>
						<span class="n">PCI_VENDOR_ID_LENOVO</span><span class="p">)</span> <span class="o">?</span>
					<span class="s">&quot;Lenovo&quot;</span> <span class="o">:</span> <span class="s">&quot;Unknown vendor&quot;</span><span class="p">),</span>
			<span class="n">thinkpad_id</span><span class="p">.</span><span class="n">model_str</span><span class="p">,</span>
			<span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">nummodel_str</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">thinkpad_id</span><span class="p">.</span><span class="n">nummodel_str</span> <span class="o">:</span> <span class="s">&quot;unknown&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Module init, exit, parameters */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ibm_init_struct</span> <span class="n">ibms_init</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">thinkpad_acpi_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">hotkey_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hotkey_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">bluetooth_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bluetooth_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">wan_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wan_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">uwb_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uwb_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_VIDEO</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">video_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">base_procfs_mode</span> <span class="o">=</span> <span class="n">S_IRUSR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">video_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">light_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">light_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">cmos_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmos_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">led_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">led_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">beep_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">beep_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">thermal_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">thermal_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">brightness_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">brightness_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">volume_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">volume_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">fan_init</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fan_driver_data</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">set_ibm_param</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kp</span> <span class="o">||</span> <span class="o">!</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">||</span> <span class="o">!</span><span class="n">val</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ibms_init</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ibm</span> <span class="o">=</span> <span class="n">ibms_init</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ibm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ibm</span> <span class="o">||</span> <span class="o">!</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ibm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ibm</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ibms_init</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">param</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">ibms_init</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">param</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">strcat</span><span class="p">(</span><span class="n">ibms_init</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">param</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">experimental</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">experimental</span><span class="p">,</span>
		 <span class="s">&quot;Enables experimental features when non-zero&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">dbg_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Sets debug level bit-mask&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">force_load</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force_load</span><span class="p">,</span>
		 <span class="s">&quot;Attempts to load the driver even on a &quot;</span>
		 <span class="s">&quot;mis-identified ThinkPad when true&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">fan_control</span><span class="p">,</span> <span class="n">fan_control_allowed</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fan_control</span><span class="p">,</span>
		 <span class="s">&quot;Enables setting fan parameters features when true&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">brightness_mode</span><span class="p">,</span> <span class="n">brightness_mode</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">brightness_mode</span><span class="p">,</span>
		 <span class="s">&quot;Selects brightness control strategy: &quot;</span>
		 <span class="s">&quot;0=auto, 1=EC, 2=UCMS, 3=EC+NVRAM&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">brightness_enable</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">brightness_enable</span><span class="p">,</span>
		 <span class="s">&quot;Enables backlight control when 1, disables when 0&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">hotkey_report_mode</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hotkey_report_mode</span><span class="p">,</span>
		 <span class="s">&quot;used for backwards compatibility with userspace, &quot;</span>
		 <span class="s">&quot;see documentation&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_ALSA_SUPPORT</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">volume_mode</span><span class="p">,</span> <span class="n">volume_mode</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">volume_mode</span><span class="p">,</span>
		 <span class="s">&quot;Selects volume control strategy: &quot;</span>
		 <span class="s">&quot;0=auto, 1=EC, 2=N/A, 3=EC+NVRAM&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">volume_capabilities</span><span class="p">,</span> <span class="n">volume_capabilities</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">volume_capabilities</span><span class="p">,</span>
		 <span class="s">&quot;Selects the mixer capabilites: &quot;</span>
		 <span class="s">&quot;0=auto, 1=volume and mute, 2=mute only&quot;</span><span class="p">);</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">volume_control</span><span class="p">,</span> <span class="n">volume_control_allowed</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">volume_control</span><span class="p">,</span>
		 <span class="s">&quot;Enables software override for the console audio &quot;</span>
		 <span class="s">&quot;control when true&quot;</span><span class="p">);</span>

<span class="cm">/* ALSA module API parameters */</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">alsa_index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;ALSA index for the ACPI EC Mixer&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">alsa_id</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;ALSA id for the ACPI EC Mixer&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="n">alsa_enable</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable the ALSA interface for the ACPI EC Mixer&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_THINKPAD_ACPI_ALSA_SUPPORT */</span><span class="cp"></span>

<span class="cp">#define TPACPI_PARAM(feature) \</span>
<span class="cp">	module_param_call(feature, set_ibm_param, NULL, NULL, 0); \</span>
<span class="cp">	MODULE_PARM_DESC(feature, &quot;Simulates thinkpad-acpi procfs command &quot; \</span>
<span class="cp">			 &quot;at module load, see documentation&quot;)</span>

<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">hotkey</span><span class="p">);</span>
<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">bluetooth</span><span class="p">);</span>
<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">video</span><span class="p">);</span>
<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">light</span><span class="p">);</span>
<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">cmos</span><span class="p">);</span>
<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">led</span><span class="p">);</span>
<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">beep</span><span class="p">);</span>
<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">brightness</span><span class="p">);</span>
<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">volume</span><span class="p">);</span>
<span class="n">TPACPI_PARAM</span><span class="p">(</span><span class="n">fan</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_THINKPAD_ACPI_DEBUGFACILITIES</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dbg_wlswemul</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbg_wlswemul</span><span class="p">,</span> <span class="s">&quot;Enables WLSW emulation&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">wlsw_state</span><span class="p">,</span> <span class="n">tpacpi_wlsw_emulstate</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wlsw_state</span><span class="p">,</span>
		 <span class="s">&quot;Initial state of the emulated WLSW switch&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dbg_bluetoothemul</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbg_bluetoothemul</span><span class="p">,</span> <span class="s">&quot;Enables bluetooth switch emulation&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">bluetooth_state</span><span class="p">,</span> <span class="n">tpacpi_bluetooth_emulstate</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bluetooth_state</span><span class="p">,</span>
		 <span class="s">&quot;Initial state of the emulated bluetooth switch&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dbg_wwanemul</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbg_wwanemul</span><span class="p">,</span> <span class="s">&quot;Enables WWAN switch emulation&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">wwan_state</span><span class="p">,</span> <span class="n">tpacpi_wwan_emulstate</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wwan_state</span><span class="p">,</span>
		 <span class="s">&quot;Initial state of the emulated WWAN switch&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dbg_uwbemul</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dbg_uwbemul</span><span class="p">,</span> <span class="s">&quot;Enables UWB switch emulation&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">uwb_state</span><span class="p">,</span> <span class="n">tpacpi_uwb_emulstate</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">uwb_state</span><span class="p">,</span>
		 <span class="s">&quot;Initial state of the emulated UWB switch&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">thinkpad_acpi_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ibm_struct</span> <span class="o">*</span><span class="n">ibm</span><span class="p">,</span> <span class="o">*</span><span class="n">itmp</span><span class="p">;</span>

	<span class="n">tpacpi_lifecycle</span> <span class="o">=</span> <span class="n">TPACPI_LIFE_EXITING</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe_reverse</span><span class="p">(</span><span class="n">ibm</span><span class="p">,</span> <span class="n">itmp</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">tpacpi_all_drivers</span><span class="p">,</span>
					 <span class="n">all_drivers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ibm_exit</span><span class="p">(</span><span class="n">ibm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dbg_printk</span><span class="p">(</span><span class="n">TPACPI_DBG_INIT</span><span class="p">,</span> <span class="s">&quot;finished subdriver exit path...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">input_device_registered</span><span class="p">)</span>
			<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">input_free_device</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_hwmon</span><span class="p">)</span>
		<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">tpacpi_hwmon</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">sensors_pdev_attrs_registered</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">dev_attr_thinkpad_acpi_pdev_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_sensors_pdev</span><span class="p">)</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">tpacpi_sensors_pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_pdev</span><span class="p">)</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">tpacpi_pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">sensors_pdrv_attrs_registered</span><span class="p">)</span>
		<span class="n">tpacpi_remove_driver_attributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_hwmon_pdriver</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">platform_drv_attrs_registered</span><span class="p">)</span>
		<span class="n">tpacpi_remove_driver_attributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdriver</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">sensors_pdrv_registered</span><span class="p">)</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_hwmon_pdriver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tp_features</span><span class="p">.</span><span class="n">platform_drv_registered</span><span class="p">)</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdriver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">proc_dir</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">TPACPI_PROC_DIR</span><span class="p">,</span> <span class="n">acpi_root_dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tpacpi_wq</span><span class="p">)</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">tpacpi_wq</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">bios_version_str</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">ec_version_str</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">thinkpad_id</span><span class="p">.</span><span class="n">model_str</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">thinkpad_acpi_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tpacpi_lifecycle</span> <span class="o">=</span> <span class="n">TPACPI_LIFE_INIT</span><span class="p">;</span>

	<span class="cm">/* Parameter checking */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hotkey_report_mode</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Driver-level probe */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_thinkpad_model_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">thinkpad_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to get DMI data: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">probe_for_thinkpad</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Driver initialization */</span>

	<span class="n">thinkpad_acpi_init_banner</span><span class="p">();</span>
	<span class="n">tpacpi_check_outdated_fw</span><span class="p">();</span>

	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">ecrd</span><span class="p">);</span>
	<span class="n">TPACPI_ACPIHANDLE_INIT</span><span class="p">(</span><span class="n">ecwr</span><span class="p">);</span>

	<span class="n">tpacpi_wq</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">TPACPI_WORKQUEUE_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpacpi_wq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">proc_dir</span> <span class="o">=</span> <span class="n">proc_mkdir</span><span class="p">(</span><span class="n">TPACPI_PROC_DIR</span><span class="p">,</span> <span class="n">acpi_root_dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">proc_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to create proc dir &quot;</span> <span class="n">TPACPI_PROC_DIR</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdriver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register main platform driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">platform_drv_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_hwmon_pdriver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register hwmon platform driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">sensors_pdrv_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">tpacpi_create_driver_attributes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_pdriver</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">platform_drv_attrs_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">tpacpi_create_driver_attributes</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">tpacpi_hwmon_pdriver</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to create sysfs driver attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">sensors_pdrv_attrs_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


	<span class="cm">/* Device initialization */</span>
	<span class="n">tpacpi_pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="n">TPACPI_DRVR_NAME</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
							<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tpacpi_pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tpacpi_pdev</span><span class="p">);</span>
		<span class="n">tpacpi_pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register platform device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tpacpi_sensors_pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span>
						<span class="n">TPACPI_HWMON_DRVR_NAME</span><span class="p">,</span>
						<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tpacpi_sensors_pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tpacpi_sensors_pdev</span><span class="p">);</span>
		<span class="n">tpacpi_sensors_pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register hwmon platform device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">dev_attr_thinkpad_acpi_pdev_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to create sysfs hwmon device attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tp_features</span><span class="p">.</span><span class="n">sensors_pdev_attrs_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tpacpi_hwmon</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_sensors_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">tpacpi_hwmon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">tpacpi_hwmon</span><span class="p">);</span>
		<span class="n">tpacpi_hwmon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register hwmon device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpacpi_inputdev_send_mutex</span><span class="p">);</span>
	<span class="n">tpacpi_inputdev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tpacpi_inputdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to allocate input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Prepare input device, but don&#39;t register */</span>
		<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ThinkPad Extra Buttons&quot;</span><span class="p">;</span>
		<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">TPACPI_DRVR_NAME</span> <span class="s">&quot;/input0&quot;</span><span class="p">;</span>
		<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>
		<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="n">thinkpad_id</span><span class="p">.</span><span class="n">vendor</span><span class="p">;</span>
		<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">TPACPI_HKEY_INPUT_PRODUCT</span><span class="p">;</span>
		<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">TPACPI_HKEY_INPUT_VERSION</span><span class="p">;</span>
		<span class="n">tpacpi_inputdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tpacpi_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Init subdriver dependencies */</span>
	<span class="n">tpacpi_detect_brightness_capabilities</span><span class="p">();</span>

	<span class="cm">/* Init subdrivers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ibms_init</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ibm_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ibms_init</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">ibms_init</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">param</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ibms_init</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">ibms_init</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">param</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">tpacpi_lifecycle</span> <span class="o">=</span> <span class="n">TPACPI_LIFE_RUNNING</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">tpacpi_inputdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">thinkpad_acpi_module_exit</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tp_features</span><span class="p">.</span><span class="n">input_device_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="n">TPACPI_DRVR_SHORTNAME</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This will autoload the driver in almost every ThinkPad</span>
<span class="cm"> * in widespread use.</span>
<span class="cm"> *</span>
<span class="cm"> * Only _VERY_ old models, like the 240, 240x and 570 lack</span>
<span class="cm"> * the HKEY event interface.</span>
<span class="cm"> */</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">acpi</span><span class="p">,</span> <span class="n">ibm_htk_device_ids</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * DMI matching for module autoloading</span>
<span class="cm"> *</span>
<span class="cm"> * See http://thinkwiki.org/wiki/List_of_DMI_IDs</span>
<span class="cm"> * See http://thinkwiki.org/wiki/BIOS_Upgrade_Downloads</span>
<span class="cm"> *</span>
<span class="cm"> * Only models listed in thinkwiki will be supported, so add yours</span>
<span class="cm"> * if it is not there yet.</span>
<span class="cm"> */</span>
<span class="cp">#define IBM_BIOS_MODULE_ALIAS(__type) \</span>
<span class="cp">	MODULE_ALIAS(&quot;dmi:bvnIBM:bvr&quot; __type &quot;ET??WW*&quot;)</span>

<span class="cm">/* Ancient thinkpad BIOSes have to be identified by</span>
<span class="cm"> * BIOS type or model number, and there are far less</span>
<span class="cm"> * BIOS types than model numbers... */</span>
<span class="n">IBM_BIOS_MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;I[MU]&quot;</span><span class="p">);</span>		<span class="cm">/* 570, 570e */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Borislav Deianov &lt;borislav@users.sf.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Henrique de Moraes Holschuh &lt;hmh@hmh.eng.br&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">TPACPI_DESC</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">TPACPI_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">thinkpad_acpi_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">thinkpad_acpi_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
