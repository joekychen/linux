<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › platform › x86 › asus-laptop.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>asus-laptop.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  asus-laptop.c - Asus Laptop Support</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2002-2005 Julien Lerouge, 2003-2006 Karol Kozimor</span>
<span class="cm"> *  Copyright (C) 2006-2007 Corentin Chary</span>
<span class="cm"> *  Copyright (C) 2011 Wind River Systems</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  The development page for this driver is located at</span>
<span class="cm"> *  http://sourceforge.net/projects/acpi4asus/</span>
<span class="cm"> *</span>
<span class="cm"> *  Credits:</span>
<span class="cm"> *  Pontus Fuchs   - Helper functions, cleanup</span>
<span class="cm"> *  Johann Wiesner - Small compile fixes</span>
<span class="cm"> *  John Belmonte  - ACPI code for Toshiba laptop was a good starting point.</span>
<span class="cm"> *  Eric Burghard  - LED display support for W1N</span>
<span class="cm"> *  Josh Green     - Light Sens support</span>
<span class="cm"> *  Thomas Tuttle  - His first patch for led support was very helpful</span>
<span class="cm"> *  Sam Lin        - GPS support</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/input/sparse-keymap.h&gt;</span>
<span class="cp">#include &lt;linux/input-polldev.h&gt;</span>
<span class="cp">#include &lt;linux/rfkill.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi_drivers.h&gt;</span>
<span class="cp">#include &lt;acpi/acpi_bus.h&gt;</span>

<span class="cp">#define ASUS_LAPTOP_VERSION	&quot;0.42&quot;</span>

<span class="cp">#define ASUS_LAPTOP_NAME	&quot;Asus Laptop Support&quot;</span>
<span class="cp">#define ASUS_LAPTOP_CLASS	&quot;hotkey&quot;</span>
<span class="cp">#define ASUS_LAPTOP_DEVICE_NAME	&quot;Hotkey&quot;</span>
<span class="cp">#define ASUS_LAPTOP_FILE	KBUILD_MODNAME</span>
<span class="cp">#define ASUS_LAPTOP_PREFIX	&quot;\\_SB.ATKD.&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Julien Lerouge, Karol Kozimor, Corentin Chary&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">ASUS_LAPTOP_NAME</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * WAPF defines the behavior of the Fn+Fx wlan key</span>
<span class="cm"> * The significance of values is yet to be found, but</span>
<span class="cm"> * most of the time:</span>
<span class="cm"> * Bit | Bluetooth | WLAN</span>
<span class="cm"> *  0  | Hardware  | Hardware</span>
<span class="cm"> *  1  | Hardware  | Software</span>
<span class="cm"> *  4  | Software  | Software</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">wapf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">wapf</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wapf</span><span class="p">,</span> <span class="s">&quot;WAPF value&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">wled_type</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bled_type</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">wled_type</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wlan_status</span><span class="p">,</span> <span class="s">&quot;Set the wled type on boot &quot;</span>
		 <span class="s">&quot;(unknown, led or rfkill). &quot;</span>
		 <span class="s">&quot;default is unknown&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">bled_type</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bled_type</span><span class="p">,</span> <span class="s">&quot;Set the bled type on boot &quot;</span>
		 <span class="s">&quot;(unknown, led or rfkill). &quot;</span>
		 <span class="s">&quot;default is unknown&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wlan_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bluetooth_status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wimax_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wwan_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">als_status</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">wlan_status</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wlan_status</span><span class="p">,</span> <span class="s">&quot;Set the wireless status on boot &quot;</span>
		 <span class="s">&quot;(0 = disabled, 1 = enabled, -1 = don&#39;t do anything). &quot;</span>
		 <span class="s">&quot;default is -1&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">bluetooth_status</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bluetooth_status</span><span class="p">,</span> <span class="s">&quot;Set the wireless status on boot &quot;</span>
		 <span class="s">&quot;(0 = disabled, 1 = enabled, -1 = don&#39;t do anything). &quot;</span>
		 <span class="s">&quot;default is -1&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">wimax_status</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wimax_status</span><span class="p">,</span> <span class="s">&quot;Set the wireless status on boot &quot;</span>
		 <span class="s">&quot;(0 = disabled, 1 = enabled, -1 = don&#39;t do anything). &quot;</span>
		 <span class="s">&quot;default is -1&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">wwan_status</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">wwan_status</span><span class="p">,</span> <span class="s">&quot;Set the wireless status on boot &quot;</span>
		 <span class="s">&quot;(0 = disabled, 1 = enabled, -1 = don&#39;t do anything). &quot;</span>
		 <span class="s">&quot;default is -1&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">als_status</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">als_status</span><span class="p">,</span> <span class="s">&quot;Set the ALS status on boot &quot;</span>
		 <span class="s">&quot;(0 = disabled, 1 = enabled). &quot;</span>
		 <span class="s">&quot;default is 0&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Some events we use, same for all Asus</span>
<span class="cm"> */</span>
<span class="cp">#define ATKD_BR_UP	0x10	</span><span class="cm">/* (event &amp; ~ATKD_BR_UP) = brightness level */</span><span class="cp"></span>
<span class="cp">#define ATKD_BR_DOWN	0x20	</span><span class="cm">/* (event &amp; ~ATKD_BR_DOWN) = britghness level */</span><span class="cp"></span>
<span class="cp">#define ATKD_BR_MIN	ATKD_BR_UP</span>
<span class="cp">#define ATKD_BR_MAX	(ATKD_BR_DOWN | 0xF)	</span><span class="cm">/* 0x2f */</span><span class="cp"></span>
<span class="cp">#define ATKD_LCD_ON	0x33</span>
<span class="cp">#define ATKD_LCD_OFF	0x34</span>

<span class="cm">/*</span>
<span class="cm"> * Known bits returned by \_SB.ATKD.HWRS</span>
<span class="cm"> */</span>
<span class="cp">#define WL_HWRS		0x80</span>
<span class="cp">#define BT_HWRS		0x100</span>

<span class="cm">/*</span>
<span class="cm"> * Flags for hotk status</span>
<span class="cm"> * WL_ON and BT_ON are also used for wireless_status()</span>
<span class="cm"> */</span>
<span class="cp">#define WL_RSTS		0x01	</span><span class="cm">/* internal Wifi */</span><span class="cp"></span>
<span class="cp">#define BT_RSTS		0x02	</span><span class="cm">/* internal Bluetooth */</span><span class="cp"></span>
<span class="cp">#define WM_RSTS		0x08    </span><span class="cm">/* internal wimax */</span><span class="cp"></span>
<span class="cp">#define WW_RSTS		0x20    </span><span class="cm">/* internal wwan */</span><span class="cp"></span>

<span class="cm">/* WLED and BLED type */</span>
<span class="cp">#define TYPE_UNKNOWN	0</span>
<span class="cp">#define TYPE_LED	1</span>
<span class="cp">#define TYPE_RFKILL	2</span>

<span class="cm">/* LED */</span>
<span class="cp">#define METHOD_MLED		&quot;MLED&quot;</span>
<span class="cp">#define METHOD_TLED		&quot;TLED&quot;</span>
<span class="cp">#define METHOD_RLED		&quot;RLED&quot;	</span><span class="cm">/* W1JC */</span><span class="cp"></span>
<span class="cp">#define METHOD_PLED		&quot;PLED&quot;	</span><span class="cm">/* A7J */</span><span class="cp"></span>
<span class="cp">#define METHOD_GLED		&quot;GLED&quot;	</span><span class="cm">/* G1, G2 (probably) */</span><span class="cp"></span>

<span class="cm">/* LEDD */</span>
<span class="cp">#define METHOD_LEDD		&quot;SLCM&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Bluetooth and WLAN</span>
<span class="cm"> * WLED and BLED are not handled like other XLED, because in some dsdt</span>
<span class="cm"> * they also control the WLAN/Bluetooth device.</span>
<span class="cm"> */</span>
<span class="cp">#define METHOD_WLAN		&quot;WLED&quot;</span>
<span class="cp">#define METHOD_BLUETOOTH	&quot;BLED&quot;</span>

<span class="cm">/* WWAN and WIMAX */</span>
<span class="cp">#define METHOD_WWAN		&quot;GSMC&quot;</span>
<span class="cp">#define METHOD_WIMAX		&quot;WMXC&quot;</span>

<span class="cp">#define METHOD_WL_STATUS	&quot;RSTS&quot;</span>

<span class="cm">/* Brightness */</span>
<span class="cp">#define METHOD_BRIGHTNESS_SET	&quot;SPLV&quot;</span>
<span class="cp">#define METHOD_BRIGHTNESS_GET	&quot;GPLV&quot;</span>

<span class="cm">/* Display */</span>
<span class="cp">#define METHOD_SWITCH_DISPLAY	&quot;SDSP&quot;</span>

<span class="cp">#define METHOD_ALS_CONTROL	&quot;ALSC&quot; </span><span class="cm">/* Z71A Z71V */</span><span class="cp"></span>
<span class="cp">#define METHOD_ALS_LEVEL	&quot;ALSL&quot; </span><span class="cm">/* Z71A Z71V */</span><span class="cp"></span>

<span class="cm">/* GPS */</span>
<span class="cm">/* R2H use different handle for GPS on/off */</span>
<span class="cp">#define METHOD_GPS_ON		&quot;SDON&quot;</span>
<span class="cp">#define METHOD_GPS_OFF		&quot;SDOF&quot;</span>
<span class="cp">#define METHOD_GPS_STATUS	&quot;GPST&quot;</span>

<span class="cm">/* Keyboard light */</span>
<span class="cp">#define METHOD_KBD_LIGHT_SET	&quot;SLKB&quot;</span>
<span class="cp">#define METHOD_KBD_LIGHT_GET	&quot;GLKB&quot;</span>

<span class="cm">/* For Pegatron Lucid tablet */</span>
<span class="cp">#define DEVICE_NAME_PEGA	&quot;Lucid&quot;</span>

<span class="cp">#define METHOD_PEGA_ENABLE	&quot;ENPR&quot;</span>
<span class="cp">#define METHOD_PEGA_DISABLE	&quot;DAPR&quot;</span>
<span class="cp">#define PEGA_WLAN	0x00</span>
<span class="cp">#define PEGA_BLUETOOTH	0x01</span>
<span class="cp">#define PEGA_WWAN	0x02</span>
<span class="cp">#define PEGA_ALS	0x04</span>
<span class="cp">#define PEGA_ALS_POWER	0x05</span>

<span class="cp">#define METHOD_PEGA_READ	&quot;RDLN&quot;</span>
<span class="cp">#define PEGA_READ_ALS_H	0x02</span>
<span class="cp">#define PEGA_READ_ALS_L	0x03</span>

<span class="cp">#define PEGA_ACCEL_NAME &quot;pega_accel&quot;</span>
<span class="cp">#define PEGA_ACCEL_DESC &quot;Pegatron Lucid Tablet Accelerometer&quot;</span>
<span class="cp">#define METHOD_XLRX &quot;XLRX&quot;</span>
<span class="cp">#define METHOD_XLRY &quot;XLRY&quot;</span>
<span class="cp">#define METHOD_XLRZ &quot;XLRZ&quot;</span>
<span class="cp">#define PEGA_ACC_CLAMP 512 </span><span class="cm">/* 1G accel is reported as ~256, so clamp to 2G */</span><span class="cp"></span>
<span class="cp">#define PEGA_ACC_RETRIES 3</span>

<span class="cm">/*</span>
<span class="cm"> * Define a specific led structure to keep the main structure clean</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asus_led</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">wk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">led</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Same thing for rfkill</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="p">{</span>
	<span class="cm">/* type of control. Maps to PEGA_* values or *_RSTS  */</span>
	<span class="kt">int</span> <span class="n">control_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfkill</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This is the main structure, we can use it to store anything interesting</span>
<span class="cm"> * about the hotk device</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>		<span class="cm">/* laptop name */</span>

	<span class="k">struct</span> <span class="n">acpi_table_header</span> <span class="o">*</span><span class="n">dsdt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">platform_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>		<span class="cm">/* the device we are in */</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">backlight_device</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">inputdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">key_entry</span> <span class="o">*</span><span class="n">keymap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_polled_dev</span> <span class="o">*</span><span class="n">pega_accel_poll</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">asus_led</span> <span class="n">wled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="n">bled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="n">mled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="n">tled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="n">rled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="n">pled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="n">gled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="n">kled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">led_workqueue</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">wled_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bled_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wireless_status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">have_rsts</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_pega_lucid</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pega_acc_live</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pega_acc_x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pega_acc_y</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pega_acc_z</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="n">wlan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="n">bluetooth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="n">wwan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="n">wimax</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="n">gps</span><span class="p">;</span>

	<span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">;</span>	<span class="cm">/* the handle of the hotk device */</span>
	<span class="n">u32</span> <span class="n">ledd_status</span><span class="p">;</span>	<span class="cm">/* status of the LED display */</span>
	<span class="n">u8</span> <span class="n">light_level</span><span class="p">;</span>		<span class="cm">/* light sensor level */</span>
	<span class="n">u8</span> <span class="n">light_switch</span><span class="p">;</span>	<span class="cm">/* light sensor switch value */</span>
	<span class="n">u16</span> <span class="n">event_count</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>	<span class="cm">/* count for each event TODO make this better */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">key_entry</span> <span class="n">asus_keymap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Lenovo SL Specific keycodes */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SCREENLOCK</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_WLAN</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_F13</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_PROG2</span> <span class="p">}</span> <span class="p">},</span> <span class="cm">/* Dock */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_ZOOM</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_BATTERY</span> <span class="p">}</span> <span class="p">},</span>
	<span class="cm">/* End of Lenovo SL Specific keycodes */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_VOLUMEUP</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_VOLUMEDOWN</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_MUTE</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SWITCHVIDEOMODE</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SWITCHVIDEOMODE</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_PREVIOUSSONG</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_NEXTSONG</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_STOPCD</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_PLAYPAUSE</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_MEDIA</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_EMAIL</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_WWW</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_CALC</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SCREENLOCK</span> <span class="p">}</span> <span class="p">},</span>  <span class="cm">/* Screenlock */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_WLAN</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_WLAN</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_WLAN</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SWITCHVIDEOMODE</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SWITCHVIDEOMODE</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SWITCHVIDEOMODE</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SWITCHVIDEOMODE</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_F13</span> <span class="p">}</span> <span class="p">},</span> <span class="cm">/* Lock Touchpad */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x6C</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SLEEP</span> <span class="p">}</span> <span class="p">},</span> <span class="cm">/* Suspend */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x6D</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_SLEEP</span> <span class="p">}</span> <span class="p">},</span> <span class="cm">/* Hibernate */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x7E</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_BLUETOOTH</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_BLUETOOTH</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_CAMERA</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_WLAN</span>  <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x8A</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_PROG1</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_MEDIA</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_PHONE</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_KBDILLUMUP</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_KBDILLUMDOWN</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0xb5</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_CALC</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * This function evaluates an ACPI method, given an int as parameter, the</span>
<span class="cm"> * method is searched within the scope of the handle, can be NULL. The output</span>
<span class="cm"> * of the method is written is output, which can also be NULL</span>
<span class="cm"> *</span>
<span class="cm"> * returns 0 if write is successful, -1 else.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_acpi_int_ret</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="o">*</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">params</span><span class="p">;</span>	<span class="cm">/* list of input parameters (an int) */</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">in_obj</span><span class="p">;</span>	<span class="cm">/* the only param we use */</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">handle</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">params</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_obj</span><span class="p">;</span>
	<span class="n">in_obj</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">in_obj</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">method</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">AE_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_acpi_int</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">write_acpi_int_ret</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_check_handle</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">,</span>
			     <span class="n">acpi_handle</span> <span class="o">*</span><span class="n">ret</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">method</span><span class="p">,</span>
					 <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">acpi_handle</span> <span class="n">dummy</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">method</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error finding %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">asus_check_pega_lucid</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DEVICE_NAME_PEGA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_PEGA_ENABLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_PEGA_DISABLE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_PEGA_READ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_pega_lucid_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">unit</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">method</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">METHOD_PEGA_ENABLE</span> <span class="o">:</span> <span class="n">METHOD_PEGA_DISABLE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pega_acc_axis</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">curr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PEGA_ACC_RETRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

		<span class="cm">/* The output is noisy.  From reading the ASL</span>
<span class="cm">		 * dissassembly, timeout errors are returned with 1&#39;s</span>
<span class="cm">		 * in the high word, and the lack of locking around</span>
<span class="cm">		 * thei hi/lo byte reads means that a transition</span>
<span class="cm">		 * between (for example) -1 and 0 could be read as</span>
<span class="cm">		 * 0xff00 or 0x00ff. */</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">curr</span> <span class="o">-</span> <span class="p">(</span><span class="kt">short</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">128</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xffff</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">clamp_val</span><span class="p">((</span><span class="kt">short</span><span class="p">)</span><span class="n">val</span><span class="p">,</span> <span class="o">-</span><span class="n">PEGA_ACC_CLAMP</span><span class="p">,</span> <span class="n">PEGA_ACC_CLAMP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pega_accel_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_polled_dev</span> <span class="o">*</span><span class="n">ipd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="cm">/* In some cases, the very first call to poll causes a</span>
<span class="cm">	 * recursive fault under the polldev worker.  This is</span>
<span class="cm">	 * apparently related to very early userspace access to the</span>
<span class="cm">	 * device, and perhaps a firmware bug. Fake the first report. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_live</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_live</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Z</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_x</span> <span class="o">=</span> <span class="n">pega_acc_axis</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_x</span><span class="p">,</span> <span class="n">METHOD_XLRX</span><span class="p">);</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_y</span> <span class="o">=</span> <span class="n">pega_acc_axis</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_y</span><span class="p">,</span> <span class="n">METHOD_XLRY</span><span class="p">);</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_z</span> <span class="o">=</span> <span class="n">pega_acc_axis</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_z</span><span class="p">,</span> <span class="n">METHOD_XLRZ</span><span class="p">);</span>

	<span class="cm">/* Note transform, convert to &quot;right/up/out&quot; in the native</span>
<span class="cm">	 * landscape orientation (i.e. the vector is the direction of</span>
<span class="cm">	 * &quot;real up&quot; in the device&#39;s cartiesian coordinates). */</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="o">-</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="o">-</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_y</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Z</span><span class="p">,</span>  <span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_acc_z</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pega_accel_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_accel_poll</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_unregister_polled_device</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_accel_poll</span><span class="p">);</span>
		<span class="n">input_free_polled_device</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_accel_poll</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_accel_poll</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pega_accel_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_polled_dev</span> <span class="o">*</span><span class="n">ipd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">is_pega_lucid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_XLRX</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_XLRY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_XLRZ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ipd</span> <span class="o">=</span> <span class="n">input_allocate_polled_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ipd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ipd</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">pega_accel_poll</span><span class="p">;</span>
	<span class="n">ipd</span><span class="o">-&gt;</span><span class="n">poll_interval</span> <span class="o">=</span> <span class="mi">125</span><span class="p">;</span>
	<span class="n">ipd</span><span class="o">-&gt;</span><span class="n">poll_interval_min</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">ipd</span><span class="o">-&gt;</span><span class="n">poll_interval_max</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>

	<span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">PEGA_ACCEL_DESC</span><span class="p">;</span>
	<span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">PEGA_ACCEL_NAME</span> <span class="s">&quot;/input0&quot;</span><span class="p">;</span>
	<span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span>
			     <span class="o">-</span><span class="n">PEGA_ACC_CLAMP</span><span class="p">,</span> <span class="n">PEGA_ACC_CLAMP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span>
			     <span class="o">-</span><span class="n">PEGA_ACC_CLAMP</span><span class="p">,</span> <span class="n">PEGA_ACC_CLAMP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">ipd</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Z</span><span class="p">,</span>
			     <span class="o">-</span><span class="n">PEGA_ACC_CLAMP</span><span class="p">,</span> <span class="n">PEGA_ACC_CLAMP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_polled_device</span><span class="p">(</span><span class="n">ipd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_accel_poll</span> <span class="o">=</span> <span class="n">ipd</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="n">input_free_polled_device</span><span class="p">(</span><span class="n">ipd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Generic LED function */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_led_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">METHOD_MLED</span><span class="p">))</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">!</span><span class="n">value</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">METHOD_GLED</span><span class="p">))</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">!</span><span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">!!</span><span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LEDs</span>
<span class="cm"> */</span>
<span class="cm">/* /sys/class/led handlers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_led_cdev_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">asus_led</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">asus</span><span class="p">;</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">wk</span> <span class="o">=</span> <span class="o">!!</span><span class="n">value</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">led_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_led_cdev_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">asus_led</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">asus</span><span class="p">;</span>

	<span class="n">asus_led_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="nf">asus_led_cdev_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Keyboard backlight (also a LED)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_kled_lvl</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">kblv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">params</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">in_obj</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">rv</span><span class="p">;</span>

	<span class="n">params</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">in_obj</span><span class="p">;</span>
	<span class="n">in_obj</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">in_obj</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_KBD_LIGHT_GET</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kblv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">rv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error reading kled level</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">kblv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_kled_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kblv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kblv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kblv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">kblv</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">kblv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_KBD_LIGHT_SET</span><span class="p">,</span> <span class="n">kblv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Keyboard LED display write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_kled_cdev_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">asus_led</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">asus</span><span class="p">;</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">wk</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">led_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_kled_cdev_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">asus_led</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">asus</span><span class="p">;</span>

	<span class="n">asus_kled_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">wk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="nf">asus_kled_cdev_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">asus_led</span><span class="p">,</span> <span class="n">led</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">asus</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">asus_kled_lvl</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_led_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wled</span><span class="p">.</span><span class="n">led</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wled</span><span class="p">.</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">bled</span><span class="p">.</span><span class="n">led</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">bled</span><span class="p">.</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">mled</span><span class="p">.</span><span class="n">led</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">mled</span><span class="p">.</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">tled</span><span class="p">.</span><span class="n">led</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">tled</span><span class="p">.</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pled</span><span class="p">.</span><span class="n">led</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pled</span><span class="p">.</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">rled</span><span class="p">.</span><span class="n">led</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">rled</span><span class="p">.</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">gled</span><span class="p">.</span><span class="n">led</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">gled</span><span class="p">.</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">kled</span><span class="p">.</span><span class="n">led</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">kled</span><span class="p">.</span><span class="n">led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">led_workqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">led_workqueue</span><span class="p">);</span>
		<span class="n">asus</span><span class="o">-&gt;</span><span class="n">led_workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*  Ugly macro, need to fix that later */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_led_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">asus_led</span> <span class="o">*</span><span class="n">led</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">method</span> <span class="o">||</span> <span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Led not present */</span>

	<span class="n">led</span><span class="o">-&gt;</span><span class="n">asus</span> <span class="o">=</span> <span class="n">asus</span><span class="p">;</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">asus_led_cdev_update</span><span class="p">);</span>
	<span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">asus_led_cdev_set</span><span class="p">;</span>
	<span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">brightness_get</span> <span class="o">=</span> <span class="n">asus_led_cdev_get</span><span class="p">;</span>
	<span class="n">led_cdev</span><span class="o">-&gt;</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">led_cdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_led_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The Pegatron Lucid has no physical leds, but all methods are</span>
<span class="cm">	 * available in the DSDT...</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">is_pega_lucid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Functions that actually update the LED&#39;s are called from a</span>
<span class="cm">	 * workqueue. By doing this as separate work rather than when the LED</span>
<span class="cm">	 * subsystem asks, we avoid messing with the Asus ACPI stuff during a</span>
<span class="cm">	 * potentially bad time, such as a timer interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">led_workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;led_workqueue&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">led_workqueue</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wled_type</span> <span class="o">==</span> <span class="n">TYPE_LED</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">asus_led_register</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wled</span><span class="p">,</span> <span class="s">&quot;asus::wlan&quot;</span><span class="p">,</span>
				      <span class="n">METHOD_WLAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">bled_type</span> <span class="o">==</span> <span class="n">TYPE_LED</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">asus_led_register</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">bled</span><span class="p">,</span> <span class="s">&quot;asus::bluetooth&quot;</span><span class="p">,</span>
				      <span class="n">METHOD_BLUETOOTH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">asus_led_register</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">mled</span><span class="p">,</span> <span class="s">&quot;asus::mail&quot;</span><span class="p">,</span> <span class="n">METHOD_MLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">asus_led_register</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">tled</span><span class="p">,</span> <span class="s">&quot;asus::touchpad&quot;</span><span class="p">,</span> <span class="n">METHOD_TLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">asus_led_register</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">rled</span><span class="p">,</span> <span class="s">&quot;asus::record&quot;</span><span class="p">,</span> <span class="n">METHOD_RLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">asus_led_register</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pled</span><span class="p">,</span> <span class="s">&quot;asus::phone&quot;</span><span class="p">,</span> <span class="n">METHOD_PLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">asus_led_register</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">gled</span><span class="p">,</span> <span class="s">&quot;asus::gaming&quot;</span><span class="p">,</span> <span class="n">METHOD_GLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_KBD_LIGHT_SET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_KBD_LIGHT_GET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">asus_led</span> <span class="o">*</span><span class="n">led</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">kled</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">;</span>

		<span class="n">led</span><span class="o">-&gt;</span><span class="n">asus</span> <span class="o">=</span> <span class="n">asus</span><span class="p">;</span>

		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">asus_kled_cdev_update</span><span class="p">);</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;asus::kbd_backlight&quot;</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">asus_kled_cdev_set</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">brightness_get</span> <span class="o">=</span> <span class="n">asus_kled_cdev_get</span><span class="p">;</span>
		<span class="n">cdev</span><span class="o">-&gt;</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">cdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">asus_led_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Backlight device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_read_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">bl_get_data</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_BRIGHTNESS_GET</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">rv</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error reading brightness</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_set_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">bl_get_data</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_BRIGHTNESS_SET</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error changing brightness</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_bl_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">asus_set_brightness</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">asusbl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">asus_read_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_status</span> <span class="o">=</span> <span class="n">update_bl_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_backlight_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span> <span class="o">=</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">backlight_device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">;</span>

	<span class="n">backlight_force_update</span><span class="p">(</span><span class="n">bd</span><span class="p">,</span> <span class="n">BACKLIGHT_UPDATE_HOTKEY</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">old</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_backlight_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_BRIGHTNESS_GET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_BRIGHTNESS_SET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_properties</span><span class="p">));</span>
	<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_PLATFORM</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="n">ASUS_LAPTOP_FILE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">asus</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">asusbl_ops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not register asus backlight device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">asus</span><span class="o">-&gt;</span><span class="n">backlight_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">backlight_device</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">asus_read_brightness</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">;</span>
	<span class="n">backlight_update_status</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_backlight_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">backlight_device</span><span class="p">)</span>
		<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">backlight_device</span><span class="p">);</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">backlight_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Platform device handlers</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * We write our info in page, we begin at offset off and cannot write more</span>
<span class="cm"> * than count bytes. We set eof to 1 if we handle those 2 values. We return the</span>
<span class="cm"> * number of bytes written in page</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_infos</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>		<span class="cm">/* enough for all info */</span>
	<span class="n">acpi_status</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We use the easy way, we don&#39;t care of off and count,</span>
<span class="cm">	 * so we don&#39;t set eof to 1</span>
<span class="cm">	 */</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">ASUS_LAPTOP_NAME</span> <span class="s">&quot; &quot;</span> <span class="n">ASUS_LAPTOP_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;Model reference    : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The SFUN method probably allows the original driver to get the list</span>
<span class="cm">	 * of features supported by a given model. For now, 0x0100 or 0x0800</span>
<span class="cm">	 * bit signifies that the laptop is equipped with a Wi-Fi MiniPCI card.</span>
<span class="cm">	 * The significance of others is yet to be found.</span>
<span class="cm">	 */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;SFUN&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">rv</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;SFUN value         : %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">temp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * The HWRS method return informations about the hardware.</span>
<span class="cm">	 * 0x80 bit is for WLAN, 0x100 for Bluetooth.</span>
<span class="cm">	 * The significance of others is yet to be found.</span>
<span class="cm">	 * If we don&#39;t find the method, we assume the device are present.</span>
<span class="cm">	 */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;HRWS&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">rv</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;HRWS value         : %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">temp</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Another value for userspace: the ASYM method returns 0x02 for</span>
<span class="cm">	 * battery low and 0x04 for battery critical, its readings tend to be</span>
<span class="cm">	 * more accurate than those provided by _BST.</span>
<span class="cm">	 * Note: since not all the laptops provide this method, errors are</span>
<span class="cm">	 * silently ignored.</span>
<span class="cm">	 */</span>
	<span class="n">rv</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;ASYM&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">rv</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;ASYM value         : %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;DSDT length        : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="o">-&gt;</span><span class="n">checksum</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;DSDT checksum      : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;DSDT revision      : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="o">-&gt;</span><span class="n">oem_id</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;OEM id             : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="o">-&gt;</span><span class="n">oem_table_id</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;OEM table id       : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="o">-&gt;</span><span class="n">oem_revision</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;OEM revision       : 0x%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="o">-&gt;</span><span class="n">asl_compiler_id</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;ASL comp vendor id : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="o">-&gt;</span><span class="n">asl_compiler_revision</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;ASL comp revision  : 0x%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_arg</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">sysfs_acpi_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">method</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">parse_arg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">out</span> <span class="o">=</span> <span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LEDD display</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_ledd</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">ledd_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_ledd</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">parse_arg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_LEDD</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;LED display write failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">asus</span><span class="o">-&gt;</span><span class="n">ledd_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wireless</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_wireless_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">have_rsts</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wireless_status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WL_STATUS</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">rv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error reading Wireless status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * WLAN</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_wlan_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WLAN</span><span class="p">,</span> <span class="o">!!</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error setting wlan status to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_wlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asus_wireless_status</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">WL_RSTS</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_wlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sysfs_acpi_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">METHOD_WLAN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*e</span>
<span class="cm"> * Bluetooth</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_bluetooth_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_BLUETOOTH</span><span class="p">,</span> <span class="o">!!</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error setting bluetooth status to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bluetooth</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asus_wireless_status</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">BT_RSTS</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_bluetooth</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sysfs_acpi_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">METHOD_BLUETOOTH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wimax</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_wimax_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WIMAX</span><span class="p">,</span> <span class="o">!!</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error setting wimax status to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_wimax</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asus_wireless_status</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">WM_RSTS</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_wimax</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sysfs_acpi_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">METHOD_WIMAX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wwan</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_wwan_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WWAN</span><span class="p">,</span> <span class="o">!!</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error setting wwan status to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_wwan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asus_wireless_status</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">WW_RSTS</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_wwan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sysfs_acpi_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">METHOD_WWAN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Display</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_set_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* no sanity check needed for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_SWITCH_DISPLAY</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error setting display</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Experimental support for display switching. As of now: 1 should activate</span>
<span class="cm"> * the LCD output, 2 should do for CRT, 4 for TV-Out and 8 for DVI.</span>
<span class="cm"> * Any combination (bitwise) of these will suffice. I never actually tested 4</span>
<span class="cm"> * displays hooked up simultaneously, so be warned. See the acpi4asus README</span>
<span class="cm"> * for more info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_disp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">parse_arg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">asus_set_display</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Light Sens</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_als_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">is_pega_lucid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">asus_pega_lucid_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">PEGA_ALS</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">asus_pega_lucid_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">PEGA_ALS_POWER</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_ALS_CONTROL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;Error setting light sensor switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">light_switch</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_lssw</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">light_switch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_lssw</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">parse_arg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">asus_als_switch</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_als_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_ALS_LEVEL</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error setting light sensor level</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">light_level</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_lslvl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">light_level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_lslvl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">parse_arg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">)</span> <span class="o">?</span> <span class="p">((</span><span class="mi">15</span> <span class="o">&lt;</span> <span class="n">value</span><span class="p">)</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="n">value</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* 0 &lt;= value &lt;= 15 */</span>
		<span class="n">asus_als_level</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pega_int_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">write_acpi_int_ret</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_PEGA_READ</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span>
			<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_lsvalue</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pega_int_read</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">PEGA_READ_ALS_H</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pega_int_read</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">PEGA_READ_ALS_L</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">hi</span> <span class="o">+</span> <span class="n">lo</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * GPS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_gps_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_GPS_STATUS</span><span class="p">,</span>
				   <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">rv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error reading GPS status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">!!</span><span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_gps_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">meth</span> <span class="o">=</span> <span class="n">status</span> <span class="o">?</span> <span class="n">METHOD_GPS_ON</span> <span class="o">:</span> <span class="n">METHOD_GPS_OFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">meth</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_gps</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">asus_gps_status</span><span class="p">(</span><span class="n">asus</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_gps</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rv</span> <span class="o">=</span> <span class="n">parse_arg</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">asus_gps_switch</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!!</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">gps</span><span class="p">.</span><span class="n">rfkill</span><span class="p">,</span> <span class="o">!</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * rfkill</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_gps_rfkill_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">asus_gps_switch</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!</span><span class="n">blocked</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">asus_gps_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">asus_gps_rfkill_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_rfkill_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="o">*</span><span class="n">rfk</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">rfk</span><span class="o">-&gt;</span><span class="n">asus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">control_id</span> <span class="o">==</span> <span class="n">WL_RSTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">asus_wlan_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!</span><span class="n">blocked</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">control_id</span> <span class="o">==</span> <span class="n">BT_RSTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">asus_bluetooth_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!</span><span class="n">blocked</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">control_id</span> <span class="o">==</span> <span class="n">WM_RSTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">asus_wimax_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!</span><span class="n">blocked</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">control_id</span> <span class="o">==</span> <span class="n">WW_RSTS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">asus_wwan_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!</span><span class="n">blocked</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">asus_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">asus_rfkill_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_rfkill_terminate</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="o">*</span><span class="n">rfk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="n">rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_rfkill_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">asus_rfkill_terminate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wwan</span><span class="p">);</span>
	<span class="n">asus_rfkill_terminate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">bluetooth</span><span class="p">);</span>
	<span class="n">asus_rfkill_terminate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wlan</span><span class="p">);</span>
	<span class="n">asus_rfkill_terminate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">gps</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_rfkill_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="o">*</span><span class="n">rfk</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">control_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">rfk</span><span class="o">-&gt;</span><span class="n">control_id</span> <span class="o">=</span> <span class="n">control_id</span><span class="p">;</span>
	<span class="n">rfk</span><span class="o">-&gt;</span><span class="n">asus</span> <span class="o">=</span> <span class="n">asus</span><span class="p">;</span>
	<span class="n">rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">type</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">rfk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">rfk</span><span class="o">-&gt;</span><span class="n">rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_rfkill_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">is_pega_lucid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_GPS_ON</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_GPS_OFF</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_GPS_STATUS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">asus_rfkill_setup</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">gps</span><span class="p">,</span> <span class="s">&quot;asus-gps&quot;</span><span class="p">,</span>
					   <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">RFKILL_TYPE_GPS</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">asus_gps_rfkill_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WLAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">asus</span><span class="o">-&gt;</span><span class="n">wled_type</span> <span class="o">==</span> <span class="n">TYPE_RFKILL</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">asus_rfkill_setup</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wlan</span><span class="p">,</span> <span class="s">&quot;asus-wlan&quot;</span><span class="p">,</span>
					   <span class="n">WL_RSTS</span><span class="p">,</span> <span class="n">RFKILL_TYPE_WLAN</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">asus_rfkill_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_BLUETOOTH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">asus</span><span class="o">-&gt;</span><span class="n">bled_type</span> <span class="o">==</span> <span class="n">TYPE_RFKILL</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">asus_rfkill_setup</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">bluetooth</span><span class="p">,</span>
					   <span class="s">&quot;asus-bluetooth&quot;</span><span class="p">,</span> <span class="n">BT_RSTS</span><span class="p">,</span>
					   <span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">asus_rfkill_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WWAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">asus_rfkill_setup</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wwan</span><span class="p">,</span> <span class="s">&quot;asus-wwan&quot;</span><span class="p">,</span>
					   <span class="n">WW_RSTS</span><span class="p">,</span> <span class="n">RFKILL_TYPE_WWAN</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">asus_rfkill_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WIMAX</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">asus_rfkill_setup</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wimax</span><span class="p">,</span> <span class="s">&quot;asus-wimax&quot;</span><span class="p">,</span>
					   <span class="n">WM_RSTS</span><span class="p">,</span> <span class="n">RFKILL_TYPE_WIMAX</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">asus_rfkill_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="n">asus_rfkill_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pega_rfkill_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="o">*</span><span class="n">rfk</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">asus_pega_lucid_set</span><span class="p">(</span><span class="n">rfk</span><span class="o">-&gt;</span><span class="n">asus</span><span class="p">,</span> <span class="n">rfk</span><span class="o">-&gt;</span><span class="n">control_id</span><span class="p">,</span> <span class="o">!</span><span class="n">blocked</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">pega_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">pega_rfkill_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pega_rfkill_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="k">struct</span> <span class="n">asus_rfkill</span> <span class="o">*</span><span class="n">rfk</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">controlid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rfkill_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">asus_rfkill_setup</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">rfk</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">controlid</span><span class="p">,</span> <span class="n">rfkill_type</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">pega_rfkill_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pega_rfkill_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">is_pega_lucid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pega_rfkill_setup</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wlan</span><span class="p">,</span> <span class="s">&quot;pega-wlan&quot;</span><span class="p">,</span>
				<span class="n">PEGA_WLAN</span><span class="p">,</span> <span class="n">RFKILL_TYPE_WLAN</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pega_rfkill_setup</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">bluetooth</span><span class="p">,</span> <span class="s">&quot;pega-bt&quot;</span><span class="p">,</span>
				<span class="n">PEGA_BLUETOOTH</span><span class="p">,</span> <span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pega_rfkill_setup</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">wwan</span><span class="p">,</span> <span class="s">&quot;pega-wwan&quot;</span><span class="p">,</span>
				<span class="n">PEGA_WWAN</span><span class="p">,</span> <span class="n">RFKILL_TYPE_WWAN</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">asus_rfkill_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Input device (i.e. hotkeys)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_input_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sparse_keymap_report_event</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown key %x pressed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_input_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">input</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unable to allocate input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Asus Laptop extra buttons&quot;</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">ASUS_LAPTOP_FILE</span> <span class="s">&quot;/input0&quot;</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">sparse_keymap_setup</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">asus_keymap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to setup input device keymap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unable to register input device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_keymap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">inputdev</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_keymap:</span>
	<span class="n">sparse_keymap_free</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="nl">err_free_dev:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_input_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sparse_keymap_free</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">);</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">inputdev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">inputdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ACPI driver</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_acpi_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">acpi_driver_data</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">count</span><span class="p">;</span>

	<span class="cm">/* TODO Find a better way to handle events count. */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">event_count</span><span class="p">[</span><span class="n">event</span> <span class="o">%</span> <span class="mi">128</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">acpi_bus_generate_proc_event</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">acpi_bus_generate_netlink_event</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">pnp</span><span class="p">.</span><span class="n">device_class</span><span class="p">,</span>
					<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">event</span><span class="p">,</span>
					<span class="n">count</span><span class="p">);</span>

	<span class="cm">/* Brightness events are special */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">&gt;=</span> <span class="n">ATKD_BR_MIN</span> <span class="o">&amp;&amp;</span> <span class="n">event</span> <span class="o">&lt;=</span> <span class="n">ATKD_BR_MAX</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Ignore them completely if the acpi video driver is used */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">backlight_device</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Update the backlight device. */</span>
			<span class="n">asus_backlight_notify</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Accelerometer &quot;coarse orientation change&quot; event */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_accel_poll</span> <span class="o">&amp;&amp;</span> <span class="n">event</span> <span class="o">==</span> <span class="mh">0xEA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kobject_uevent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">pega_accel_poll</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
			       <span class="n">KOBJ_CHANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">asus_input_notify</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_infos</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wlan</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_wlan</span><span class="p">,</span> <span class="n">store_wlan</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">bluetooth</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">show_bluetooth</span><span class="p">,</span> <span class="n">store_bluetooth</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wimax</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_wimax</span><span class="p">,</span> <span class="n">store_wimax</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wwan</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_wwan</span><span class="p">,</span> <span class="n">store_wwan</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">store_disp</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ledd</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_ledd</span><span class="p">,</span> <span class="n">store_ledd</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ls_value</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_lsvalue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ls_level</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_lslvl</span><span class="p">,</span> <span class="n">store_lslvl</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ls_switch</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_lssw</span><span class="p">,</span> <span class="n">store_lssw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">gps</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_gps</span><span class="p">,</span> <span class="n">store_gps</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">asus_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_infos</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wlan</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_bluetooth</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wimax</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wwan</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_display</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ledd</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ls_value</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ls_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ls_switch</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_gps</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">asus_sysfs_is_visible</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">supported</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">is_pega_lucid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no ls_level interface on the Lucid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_ls_switch</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span>
			<span class="n">supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_ls_level</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span>
			<span class="n">supported</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">normal</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">supported</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">normal:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_wlan</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span> <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WLAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_bluetooth</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span> <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_BLUETOOTH</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_display</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span> <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_SWITCH_DISPLAY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_wimax</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span>
			<span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WIMAX</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_wwan</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span> <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WWAN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_ledd</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span> <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_LEDD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_ls_switch</span><span class="p">.</span><span class="n">attr</span> <span class="o">||</span>
		   <span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_ls_level</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span> <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_ALS_CONTROL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_ALS_LEVEL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_ls_value</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">is_pega_lucid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_gps</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span> <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_GPS_ON</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_GPS_OFF</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_GPS_STATUS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">supported</span> <span class="o">?</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">asus_attr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">is_visible</span>	<span class="o">=</span> <span class="n">asus_sysfs_is_visible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span>		<span class="o">=</span> <span class="n">asus_attributes</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_platform_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">ASUS_LAPTOP_FILE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">,</span> <span class="n">asus</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_platform_device</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">asus_attr_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_sysfs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_sysfs:</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">);</span>
<span class="nl">fail_platform_device:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">asus_platform_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus_attr_group</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">platform_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ASUS_LAPTOP_FILE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This function is used to initialize the context with right values. In this</span>
<span class="cm"> * method, we can make all the detection we want, and modify the asus_laptop</span>
<span class="cm"> * struct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_laptop_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">model</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">bsts_result</span><span class="p">,</span> <span class="n">hwrs_result</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">string</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get DSDT headers early enough to allow for differentiating between</span>
<span class="cm">	 * models, but late enough to allow acpi_bus_register_driver() to fail</span>
<span class="cm">	 * before doing anything ACPI-specific. Should we encounter a machine,</span>
<span class="cm">	 * which needs special handling (i.e. its hotkey device has a different</span>
<span class="cm">	 * HID), this bit will be moved.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_table</span><span class="p">(</span><span class="n">ACPI_SIG_DSDT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">dsdt_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t get the DSDT table header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* We have to write 0 on init this far for all ASUS models */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int_ret</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;INIT&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Hotkey initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This needs to be called for some laptops to init properly */</span>
	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;BSTS&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bsts_result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Error calling BSTS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bsts_result</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;BSTS called, 0x%02x returned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">bsts_result</span><span class="p">);</span>

	<span class="cm">/* This too ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_acpi_int</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;CWAP&quot;</span><span class="p">,</span> <span class="n">wapf</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error calling CWAP(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wapf</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Try to match the object returned by INIT to the specific model.</span>
<span class="cm">	 * Handle every possible object (or the lack of thereof) the DSDT</span>
<span class="cm">	 * writers might throw at us. When in trouble, we pass NULL to</span>
<span class="cm">	 * asus_model_match() and try something completely different.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">model</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">model</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACPI_TYPE_STRING</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACPI_TYPE_BUFFER</span>:
			<span class="n">string</span> <span class="o">=</span> <span class="n">model</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">string</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kstrdup</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">string</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  %s model detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The HWRS method return informations about the hardware.</span>
<span class="cm">	 * 0x80 bit is for WLAN, 0x100 for Bluetooth,</span>
<span class="cm">	 * 0x40 for WWAN, 0x10 for WIMAX.</span>
<span class="cm">	 * The significance of others is yet to be found.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="s">&quot;HRWS&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hwrs_result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;  HRWS returned %x&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hwrs_result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_WL_STATUS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">asus</span><span class="o">-&gt;</span><span class="n">have_rsts</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">asus_acpi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_get_status</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Hotkey device not present, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">asus_laptop_get_info</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">bled_type</span><span class="p">,</span> <span class="s">&quot;led&quot;</span><span class="p">))</span>
		<span class="n">asus</span><span class="o">-&gt;</span><span class="n">bled_type</span> <span class="o">=</span> <span class="n">TYPE_LED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">bled_type</span><span class="p">,</span> <span class="s">&quot;rfkill&quot;</span><span class="p">))</span>
		<span class="n">asus</span><span class="o">-&gt;</span><span class="n">bled_type</span> <span class="o">=</span> <span class="n">TYPE_RFKILL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">wled_type</span><span class="p">,</span> <span class="s">&quot;led&quot;</span><span class="p">))</span>
		<span class="n">asus</span><span class="o">-&gt;</span><span class="n">wled_type</span> <span class="o">=</span> <span class="n">TYPE_LED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">wled_type</span><span class="p">,</span> <span class="s">&quot;rfkill&quot;</span><span class="p">))</span>
		<span class="n">asus</span><span class="o">-&gt;</span><span class="n">wled_type</span> <span class="o">=</span> <span class="n">TYPE_RFKILL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bluetooth_status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">asus_bluetooth_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!!</span><span class="n">bluetooth_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlan_status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">asus_wlan_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!!</span><span class="n">wlan_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wimax_status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">asus_wimax_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!!</span><span class="n">wimax_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wwan_status</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">asus_wwan_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="o">!!</span><span class="n">wwan_status</span><span class="p">);</span>

	<span class="cm">/* Keyboard Backlight is on by default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_KBD_LIGHT_SET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">asus_kled_set</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* LED display is off by default */</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">ledd_status</span> <span class="o">=</span> <span class="mh">0xFFF</span><span class="p">;</span>

	<span class="cm">/* Set initial values of light sensor and level */</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">light_switch</span> <span class="o">=</span> <span class="o">!!</span><span class="n">als_status</span><span class="p">;</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">light_level</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>	<span class="cm">/* level 5 for sensor sensitivity */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">is_pega_lucid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">asus_als_switch</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">light_switch</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_ALS_CONTROL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">acpi_check_handle</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_ALS_LEVEL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">asus_als_switch</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">light_switch</span><span class="p">);</span>
		<span class="n">asus_als_level</span><span class="p">(</span><span class="n">asus</span><span class="p">,</span> <span class="n">asus</span><span class="o">-&gt;</span><span class="n">light_level</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">asus_dmi_check</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">model</span><span class="p">;</span>

	<span class="n">model</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">model</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* On L1400B WLED control the sound card, don&#39;t mess with it ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;L1400B&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlan_status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">asus_device_present</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">asus_acpi_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Asus Laptop Support version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ASUS_LAPTOP_VERSION</span><span class="p">);</span>
	<span class="n">asus</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">asus_laptop</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">acpi_device_name</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">ASUS_LAPTOP_DEVICE_NAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">acpi_device_class</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">ASUS_LAPTOP_CLASS</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">asus</span><span class="p">;</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>

	<span class="n">asus_dmi_check</span><span class="p">();</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">asus_acpi_init</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_platform</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Need platform type detection first, then the platform</span>
<span class="cm">	 * device.  It is used as a parent for the sub-devices below.</span>
<span class="cm">	 */</span>
	<span class="n">asus</span><span class="o">-&gt;</span><span class="n">is_pega_lucid</span> <span class="o">=</span> <span class="n">asus_check_pega_lucid</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">asus_platform_init</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_platform</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_video_backlight_support</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">asus_backlight_init</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_backlight</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Backlight controlled by ACPI video driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">asus_input_init</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_input</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">asus_led_init</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_led</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">asus_rfkill_init</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_rfkill</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">pega_accel_init</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_pega_accel</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">pega_rfkill_init</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_pega_rfkill</span><span class="p">;</span>

	<span class="n">asus_device_present</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_pega_rfkill:</span>
	<span class="n">pega_accel_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
<span class="nl">fail_pega_accel:</span>
	<span class="n">asus_rfkill_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
<span class="nl">fail_rfkill:</span>
	<span class="n">asus_led_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
<span class="nl">fail_led:</span>
	<span class="n">asus_input_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
<span class="nl">fail_input:</span>
	<span class="n">asus_backlight_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
<span class="nl">fail_backlight:</span>
	<span class="n">asus_platform_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
<span class="nl">fail_platform:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">asus_acpi_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">asus_laptop</span> <span class="o">*</span><span class="n">asus</span> <span class="o">=</span> <span class="n">acpi_driver_data</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">asus_backlight_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="n">asus_rfkill_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="n">asus_led_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="n">asus_input_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="n">pega_accel_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="n">asus_platform_exit</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">asus</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">asus</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="n">asus_device_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;ATK0100&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;ATK0101&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">acpi</span><span class="p">,</span> <span class="n">asus_device_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">acpi_driver</span> <span class="n">asus_acpi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ASUS_LAPTOP_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">ASUS_LAPTOP_CLASS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">asus_device_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ACPI_DRIVER_ALL_NOTIFY_EVENTS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">asus_acpi_add</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">asus_acpi_remove</span><span class="p">,</span>
		<span class="p">.</span><span class="n">notify</span> <span class="o">=</span> <span class="n">asus_acpi_notify</span><span class="p">,</span>
		<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">asus_laptop_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus_acpi_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_acpi_driver</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">asus_device_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_no_device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_no_device:</span>
	<span class="n">acpi_bus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus_acpi_driver</span><span class="p">);</span>
<span class="nl">fail_acpi_driver:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_driver</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">asus_laptop_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_bus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">asus_acpi_driver</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">platform_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">asus_laptop_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">asus_laptop_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
