<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › platform › x86 › compal-laptop.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>compal-laptop.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*-*-linux-c-*-*/</span>

<span class="cm">/*</span>
<span class="cm">  Copyright (C) 2008 Cezary Jackiewicz &lt;cezary.jackiewicz (at) gmail.com&gt;</span>

<span class="cm">  based on MSI driver</span>

<span class="cm">  Copyright (C) 2006 Lennart Poettering &lt;mzxreary (at) 0pointer (dot) de&gt;</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but</span>
<span class="cm">  WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	See the GNU</span>
<span class="cm">  General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm">  02110-1301, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * compal-laptop.c - Compal laptop support.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver exports a few files in /sys/devices/platform/compal-laptop/:</span>
<span class="cm"> *   wake_up_XXX   Whether or not we listen to such wake up events (rw)</span>
<span class="cm"> *</span>
<span class="cm"> * In addition to these platform device attributes the driver</span>
<span class="cm"> * registers itself in the Linux backlight control, power_supply, rfkill</span>
<span class="cm"> * and hwmon subsystem and is available to userspace under:</span>
<span class="cm"> *</span>
<span class="cm"> *   /sys/class/backlight/compal-laptop/</span>
<span class="cm"> *   /sys/class/power_supply/compal-laptop/</span>
<span class="cm"> *   /sys/class/rfkill/rfkillX/</span>
<span class="cm"> *   /sys/class/hwmon/hwmonX/</span>
<span class="cm"> *</span>
<span class="cm"> * Notes on the power_supply battery interface:</span>
<span class="cm"> *   - the &quot;minimum&quot; design voltage is *the* design voltage</span>
<span class="cm"> *   - the ambient temperature is the average battery temperature</span>
<span class="cm"> *     and the value is an educated guess (see commented code below)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This driver might work on other laptops produced by Compal. If you</span>
<span class="cm"> * want to try it you can pass force=1 as argument to the module which</span>
<span class="cm"> * will force it to load even when the DMI data doesn&#39;t identify the</span>
<span class="cm"> * laptop as compatible.</span>
<span class="cm"> *</span>
<span class="cm"> * Lots of data available at:</span>
<span class="cm"> * http://service1.marasst.com/Compal/JHL90_91/Service%20Manual/</span>
<span class="cm"> * JHL90%20service%20manual-Final-0725.pdf</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Support for the Compal JHL90 added by Roald Frederickx</span>
<span class="cm"> * (roald.frederickx@gmail.com):</span>
<span class="cm"> * Driver got large revision. Added functionalities: backlight</span>
<span class="cm"> * power, wake_on_XXX, a hwmon and power_supply interface.</span>
<span class="cm"> *</span>
<span class="cm"> * In case this gets merged into the kernel source: I want to dedicate this</span>
<span class="cm"> * to Kasper Meerts, the awesome guy who showed me Linux and C!</span>
<span class="cm"> */</span>

<span class="cm">/* NOTE: currently the wake_on_XXX, hwmon and power_supply interfaces are</span>
<span class="cm"> * only enabled on a JHL90 board until it is verified that they work on the</span>
<span class="cm"> * other boards too.  See the extra_features variable. */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/rfkill.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon.h&gt;</span>
<span class="cp">#include &lt;linux/hwmon-sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/power_supply.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>


<span class="cm">/* ======= */</span>
<span class="cm">/* Defines */</span>
<span class="cm">/* ======= */</span>
<span class="cp">#define DRIVER_NAME &quot;compal-laptop&quot;</span>
<span class="cp">#define DRIVER_VERSION	&quot;0.2.7&quot;</span>

<span class="cp">#define BACKLIGHT_LEVEL_ADDR		0xB9</span>
<span class="cp">#define BACKLIGHT_LEVEL_MAX		7</span>
<span class="cp">#define BACKLIGHT_STATE_ADDR		0x59</span>
<span class="cp">#define BACKLIGHT_STATE_ON_DATA		0xE1</span>
<span class="cp">#define BACKLIGHT_STATE_OFF_DATA	0xE2</span>

<span class="cp">#define WAKE_UP_ADDR			0xA4</span>
<span class="cp">#define WAKE_UP_PME			(1 &lt;&lt; 0)</span>
<span class="cp">#define WAKE_UP_MODEM			(1 &lt;&lt; 1)</span>
<span class="cp">#define WAKE_UP_LAN			(1 &lt;&lt; 2)</span>
<span class="cp">#define WAKE_UP_WLAN			(1 &lt;&lt; 4)</span>
<span class="cp">#define WAKE_UP_KEY			(1 &lt;&lt; 6)</span>
<span class="cp">#define WAKE_UP_MOUSE			(1 &lt;&lt; 7)</span>

<span class="cp">#define WIRELESS_ADDR			0xBB</span>
<span class="cp">#define WIRELESS_WLAN			(1 &lt;&lt; 0)</span>
<span class="cp">#define WIRELESS_BT			(1 &lt;&lt; 1)</span>
<span class="cp">#define WIRELESS_WLAN_EXISTS		(1 &lt;&lt; 2)</span>
<span class="cp">#define WIRELESS_BT_EXISTS		(1 &lt;&lt; 3)</span>
<span class="cp">#define WIRELESS_KILLSWITCH		(1 &lt;&lt; 4)</span>

<span class="cp">#define PWM_ADDRESS			0x46</span>
<span class="cp">#define PWM_DISABLE_ADDR		0x59</span>
<span class="cp">#define PWM_DISABLE_DATA		0xA5</span>
<span class="cp">#define PWM_ENABLE_ADDR			0x59</span>
<span class="cp">#define PWM_ENABLE_DATA			0xA8</span>

<span class="cp">#define FAN_ADDRESS			0x46</span>
<span class="cp">#define FAN_DATA			0x81</span>
<span class="cp">#define FAN_FULL_ON_CMD			0x59 </span><span class="cm">/* Doesn&#39;t seem to work. Just */</span><span class="cp"></span>
<span class="cp">#define FAN_FULL_ON_ENABLE		0x76 </span><span class="cm">/* force the pwm signal to its */</span><span class="cp"></span>
<span class="cp">#define FAN_FULL_ON_DISABLE		0x77 </span><span class="cm">/* maximum value instead */</span><span class="cp"></span>

<span class="cp">#define TEMP_CPU			0xB0</span>
<span class="cp">#define TEMP_CPU_LOCAL			0xB1</span>
<span class="cp">#define TEMP_CPU_DTS			0xB5</span>
<span class="cp">#define TEMP_NORTHBRIDGE		0xB6</span>
<span class="cp">#define TEMP_VGA			0xB4</span>
<span class="cp">#define TEMP_SKIN			0xB2</span>

<span class="cp">#define BAT_MANUFACTURER_NAME_ADDR	0x10</span>
<span class="cp">#define BAT_MANUFACTURER_NAME_LEN	9</span>
<span class="cp">#define BAT_MODEL_NAME_ADDR		0x19</span>
<span class="cp">#define BAT_MODEL_NAME_LEN		6</span>
<span class="cp">#define BAT_SERIAL_NUMBER_ADDR		0xC4</span>
<span class="cp">#define BAT_SERIAL_NUMBER_LEN		5</span>
<span class="cp">#define BAT_CHARGE_NOW			0xC2</span>
<span class="cp">#define BAT_CHARGE_DESIGN		0xCA</span>
<span class="cp">#define BAT_VOLTAGE_NOW			0xC6</span>
<span class="cp">#define BAT_VOLTAGE_DESIGN		0xC8</span>
<span class="cp">#define BAT_CURRENT_NOW			0xD0</span>
<span class="cp">#define BAT_CURRENT_AVG			0xD2</span>
<span class="cp">#define BAT_POWER			0xD4</span>
<span class="cp">#define BAT_CAPACITY			0xCE</span>
<span class="cp">#define BAT_TEMP			0xD6</span>
<span class="cp">#define BAT_TEMP_AVG			0xD7</span>
<span class="cp">#define BAT_STATUS0			0xC1</span>
<span class="cp">#define BAT_STATUS1			0xF0</span>
<span class="cp">#define BAT_STATUS2			0xF1</span>
<span class="cp">#define BAT_STOP_CHARGE1		0xF2</span>
<span class="cp">#define BAT_STOP_CHARGE2		0xF3</span>

<span class="cp">#define BAT_S0_DISCHARGE		(1 &lt;&lt; 0)</span>
<span class="cp">#define BAT_S0_DISCHRG_CRITICAL		(1 &lt;&lt; 2)</span>
<span class="cp">#define BAT_S0_LOW			(1 &lt;&lt; 3)</span>
<span class="cp">#define BAT_S0_CHARGING			(1 &lt;&lt; 1)</span>
<span class="cp">#define BAT_S0_AC			(1 &lt;&lt; 7)</span>
<span class="cp">#define BAT_S1_EXISTS			(1 &lt;&lt; 0)</span>
<span class="cp">#define BAT_S1_FULL			(1 &lt;&lt; 1)</span>
<span class="cp">#define BAT_S1_EMPTY			(1 &lt;&lt; 2)</span>
<span class="cp">#define BAT_S1_LiION_OR_NiMH		(1 &lt;&lt; 7)</span>
<span class="cp">#define BAT_S2_LOW_LOW			(1 &lt;&lt; 0)</span>
<span class="cp">#define BAT_STOP_CHRG1_BAD_CELL		(1 &lt;&lt; 1)</span>
<span class="cp">#define BAT_STOP_CHRG1_COMM_FAIL	(1 &lt;&lt; 2)</span>
<span class="cp">#define BAT_STOP_CHRG1_OVERVOLTAGE	(1 &lt;&lt; 6)</span>
<span class="cp">#define BAT_STOP_CHRG1_OVERTEMPERATURE	(1 &lt;&lt; 7)</span>


<span class="cm">/* ======= */</span>
<span class="cm">/* Structs */</span>
<span class="cm">/* ======= */</span>
<span class="k">struct</span> <span class="n">compal_data</span><span class="p">{</span>
	<span class="cm">/* Fan control */</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">hwmon_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pwm_enable</span><span class="p">;</span> <span class="cm">/* 0:full on, 1:set by pwm1, 2:control by moterboard */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">curr_pwm</span><span class="p">;</span>

	<span class="cm">/* Power supply */</span>
	<span class="k">struct</span> <span class="n">power_supply</span> <span class="n">psy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">power_supply_info</span> <span class="n">psy_info</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">bat_model_name</span><span class="p">[</span><span class="n">BAT_MODEL_NAME_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">bat_manufacturer_name</span><span class="p">[</span><span class="n">BAT_MANUFACTURER_NAME_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">bat_serial_number</span><span class="p">[</span><span class="n">BAT_SERIAL_NUMBER_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>


<span class="cm">/* =============== */</span>
<span class="cm">/* General globals */</span>
<span class="cm">/* =============== */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">force</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s">&quot;Force driver load, ignore DMI data&quot;</span><span class="p">);</span>

<span class="cm">/* Support for the wake_on_XXX, hwmon and power_supply interface. Currently</span>
<span class="cm"> * only gets enabled on a JHL90 board. Might work with the others too */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">extra_features</span><span class="p">;</span>

<span class="cm">/* Nasty stuff. For some reason the fan control is very un-linear.  I&#39;ve</span>
<span class="cm"> * come up with these values by looping through the possible inputs and</span>
<span class="cm"> * watching the output of address 0x4F (do an ec_transaction writing 0x33</span>
<span class="cm"> * into 0x4F and read a few bytes from the output, like so:</span>
<span class="cm"> *	u8 writeData = 0x33;</span>
<span class="cm"> *	ec_transaction(0x4F, &amp;writeData, 1, buffer, 32);</span>
<span class="cm"> * That address is labeled &quot;fan1 table information&quot; in the service manual.</span>
<span class="cm"> * It should be clear which value in &#39;buffer&#39; changes). This seems to be</span>
<span class="cm"> * related to fan speed. It isn&#39;t a proper &#39;realtime&#39; fan speed value</span>
<span class="cm"> * though, because physically stopping or speeding up the fan doesn&#39;t</span>
<span class="cm"> * change it. It might be the average voltage or current of the pwm output.</span>
<span class="cm"> * Nevertheless, it is more fine-grained than the actual RPM reading */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pwm_lookup_table</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
	<span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span>
	<span class="mi">13</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span>
	<span class="mi">75</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span>
	<span class="mi">94</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">141</span><span class="p">,</span> <span class="mi">141</span><span class="p">,</span> <span class="mi">238</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span>
	<span class="mi">139</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span>
	<span class="mi">76</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>
	<span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span> <span class="mi">219</span><span class="p">,</span>
	<span class="mi">219</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span>
	<span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span>
	<span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>
	<span class="mi">206</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span>
	<span class="mi">47</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span>
	<span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span>
	<span class="mi">189</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span>
	<span class="mi">191</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span>
	<span class="mi">187</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">50</span>
<span class="p">};</span>




<span class="cm">/* ========================= */</span>
<span class="cm">/* Hardware access functions */</span>
<span class="cm">/* ========================= */</span>
<span class="cm">/* General access */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ec_read_u8</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">ec_read</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s8</span> <span class="nf">ec_read_s8</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">ec_read_u8</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">ec_read_u16</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span><span class="p">;</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">lo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s16</span> <span class="nf">ec_read_s16</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">ec_read_u16</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ec_read_sequence</span><span class="p">(</span><span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ec_read</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Backlight access */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_backlight_level</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;</span> <span class="n">BACKLIGHT_LEVEL_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ec_write</span><span class="p">(</span><span class="n">BACKLIGHT_LEVEL_ADDR</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_backlight_level</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BACKLIGHT_LEVEL_ADDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_backlight_state</span><span class="p">(</span><span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span> <span class="n">BACKLIGHT_STATE_ON_DATA</span> <span class="o">:</span> <span class="n">BACKLIGHT_STATE_OFF_DATA</span><span class="p">;</span>
	<span class="n">ec_transaction</span><span class="p">(</span><span class="n">BACKLIGHT_STATE_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Fan control access */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwm_enable_control</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">writeData</span> <span class="o">=</span> <span class="n">PWM_ENABLE_DATA</span><span class="p">;</span>
	<span class="n">ec_transaction</span><span class="p">(</span><span class="n">PWM_ENABLE_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writeData</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwm_disable_control</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">writeData</span> <span class="o">=</span> <span class="n">PWM_DISABLE_DATA</span><span class="p">;</span>
	<span class="n">ec_transaction</span><span class="p">(</span><span class="n">PWM_DISABLE_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">writeData</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_pwm</span><span class="p">(</span><span class="kt">int</span> <span class="n">pwm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ec_transaction</span><span class="p">(</span><span class="n">PWM_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pwm_lookup_table</span><span class="p">[</span><span class="n">pwm</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_fan_rpm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">FAN_DATA</span><span class="p">;</span>
	<span class="n">ec_transaction</span><span class="p">(</span><span class="n">FAN_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>




<span class="cm">/* =================== */</span>
<span class="cm">/* Interface functions */</span>
<span class="cm">/* =================== */</span>

<span class="cm">/* Backlight interface */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bl_get_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_backlight_level</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bl_update_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">set_backlight_level</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">set_backlight_state</span><span class="p">((</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span>    <span class="o">!</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BL_CORE_SUSPENDED</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span>    <span class="o">!</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BL_CORE_FBBLANK</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">compalbl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">bl_get_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_status</span>	<span class="o">=</span> <span class="n">bl_update_status</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* Wireless interface */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">compal_rfkill_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">radio</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">WIRELESS_ADDR</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blocked</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">result</span> <span class="o">|</span> <span class="n">radio</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">radio</span><span class="p">);</span>
	<span class="n">ec_write</span><span class="p">(</span><span class="n">WIRELESS_ADDR</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">compal_rfkill_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfkill</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">WIRELESS_ADDR</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">hw_blocked</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">result</span> <span class="o">&amp;</span> <span class="n">WIRELESS_KILLSWITCH</span><span class="p">);</span>
	<span class="n">rfkill_set_hw_state</span><span class="p">(</span><span class="n">rfkill</span><span class="p">,</span> <span class="n">hw_blocked</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">compal_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">compal_rfkill_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">compal_rfkill_set</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* Wake_up interface */</span>
<span class="cp">#define SIMPLE_MASKED_STORE_SHOW(NAME, ADDR, MASK)			\</span>
<span class="cp">static ssize_t NAME##_show(struct device *dev,				\</span>
<span class="cp">	struct device_attribute *attr, char *buf)			\</span>
<span class="cp">{									\</span>
<span class="cp">	return sprintf(buf, &quot;%d\n&quot;, ((ec_read_u8(ADDR) &amp; MASK) != 0));	\</span>
<span class="cp">}									\</span>
<span class="cp">static ssize_t NAME##_store(struct device *dev,				\</span>
<span class="cp">	struct device_attribute *attr, const char *buf, size_t count)	\</span>
<span class="cp">{									\</span>
<span class="cp">	int state;							\</span>
<span class="cp">	u8 old_val = ec_read_u8(ADDR);					\</span>
<span class="cp">	if (sscanf(buf, &quot;%d&quot;, &amp;state) != 1 || (state &lt; 0 || state &gt; 1))	\</span>
<span class="cp">		return -EINVAL;						\</span>
<span class="cp">	ec_write(ADDR, state ? (old_val | MASK) : (old_val &amp; ~MASK));	\</span>
<span class="cp">	return count;							\</span>
<span class="cp">}</span>

<span class="n">SIMPLE_MASKED_STORE_SHOW</span><span class="p">(</span><span class="n">wake_up_pme</span><span class="p">,</span>	<span class="n">WAKE_UP_ADDR</span><span class="p">,</span> <span class="n">WAKE_UP_PME</span><span class="p">)</span>
<span class="n">SIMPLE_MASKED_STORE_SHOW</span><span class="p">(</span><span class="n">wake_up_modem</span><span class="p">,</span>	<span class="n">WAKE_UP_ADDR</span><span class="p">,</span> <span class="n">WAKE_UP_MODEM</span><span class="p">)</span>
<span class="n">SIMPLE_MASKED_STORE_SHOW</span><span class="p">(</span><span class="n">wake_up_lan</span><span class="p">,</span>	<span class="n">WAKE_UP_ADDR</span><span class="p">,</span> <span class="n">WAKE_UP_LAN</span><span class="p">)</span>
<span class="n">SIMPLE_MASKED_STORE_SHOW</span><span class="p">(</span><span class="n">wake_up_wlan</span><span class="p">,</span>	<span class="n">WAKE_UP_ADDR</span><span class="p">,</span> <span class="n">WAKE_UP_WLAN</span><span class="p">)</span>
<span class="n">SIMPLE_MASKED_STORE_SHOW</span><span class="p">(</span><span class="n">wake_up_key</span><span class="p">,</span>	<span class="n">WAKE_UP_ADDR</span><span class="p">,</span> <span class="n">WAKE_UP_KEY</span><span class="p">)</span>
<span class="n">SIMPLE_MASKED_STORE_SHOW</span><span class="p">(</span><span class="n">wake_up_mouse</span><span class="p">,</span>	<span class="n">WAKE_UP_ADDR</span><span class="p">,</span> <span class="n">WAKE_UP_MOUSE</span><span class="p">)</span>


<span class="cm">/* General hwmon interface */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">hwmon_name_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Fan control interface */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">pwm_enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">compal_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">pwm_enable_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">compal_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">strict_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:  <span class="cm">/* Full speed */</span>
		<span class="n">pwm_enable_control</span><span class="p">();</span>
		<span class="n">set_pwm</span><span class="p">(</span><span class="mi">255</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:  <span class="cm">/* As set by pwm1 */</span>
		<span class="n">pwm_enable_control</span><span class="p">();</span>
		<span class="n">set_pwm</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_pwm</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* Control by motherboard */</span>
		<span class="n">pwm_disable_control</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">pwm_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">compal_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hhu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_pwm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">pwm_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">compal_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">strict_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_pwm</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">set_pwm</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">fan_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_fan_rpm</span><span class="p">());</span>
<span class="p">}</span>


<span class="cm">/* Temperature interface */</span>
<span class="cp">#define TEMPERATURE_SHOW_TEMP_AND_LABEL(POSTFIX, ADDRESS, LABEL)	\</span>
<span class="cp">static ssize_t temp_##POSTFIX(struct device *dev,			\</span>
<span class="cp">		struct device_attribute *attr, char *buf)		\</span>
<span class="cp">{									\</span>
<span class="cp">	return sprintf(buf, &quot;%d\n&quot;, 1000 * (int)ec_read_s8(ADDRESS));	\</span>
<span class="cp">}									\</span>
<span class="cp">static ssize_t label_##POSTFIX(struct device *dev,			\</span>
<span class="cp">		struct device_attribute *attr, char *buf)		\</span>
<span class="cp">{									\</span>
<span class="cp">	return sprintf(buf, &quot;%s\n&quot;, LABEL);				\</span>
<span class="cp">}</span>

<span class="cm">/* Labels as in service guide */</span>
<span class="n">TEMPERATURE_SHOW_TEMP_AND_LABEL</span><span class="p">(</span><span class="n">cpu</span><span class="p">,</span>        <span class="n">TEMP_CPU</span><span class="p">,</span>        <span class="s">&quot;CPU_TEMP&quot;</span><span class="p">);</span>
<span class="n">TEMPERATURE_SHOW_TEMP_AND_LABEL</span><span class="p">(</span><span class="n">cpu_local</span><span class="p">,</span>  <span class="n">TEMP_CPU_LOCAL</span><span class="p">,</span>  <span class="s">&quot;CPU_TEMP_LOCAL&quot;</span><span class="p">);</span>
<span class="n">TEMPERATURE_SHOW_TEMP_AND_LABEL</span><span class="p">(</span><span class="n">cpu_DTS</span><span class="p">,</span>    <span class="n">TEMP_CPU_DTS</span><span class="p">,</span>    <span class="s">&quot;CPU_DTS&quot;</span><span class="p">);</span>
<span class="n">TEMPERATURE_SHOW_TEMP_AND_LABEL</span><span class="p">(</span><span class="n">northbridge</span><span class="p">,</span><span class="n">TEMP_NORTHBRIDGE</span><span class="p">,</span><span class="s">&quot;NorthBridge&quot;</span><span class="p">);</span>
<span class="n">TEMPERATURE_SHOW_TEMP_AND_LABEL</span><span class="p">(</span><span class="n">vga</span><span class="p">,</span>        <span class="n">TEMP_VGA</span><span class="p">,</span>        <span class="s">&quot;VGA_TEMP&quot;</span><span class="p">);</span>
<span class="n">TEMPERATURE_SHOW_TEMP_AND_LABEL</span><span class="p">(</span><span class="n">SKIN</span><span class="p">,</span>       <span class="n">TEMP_SKIN</span><span class="p">,</span>       <span class="s">&quot;SKIN_TEMP90&quot;</span><span class="p">);</span>


<span class="cm">/* Power supply interface */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bat_status</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status0</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_STATUS0</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status1</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_STATUS1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">BAT_S0_CHARGING</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_STATUS_CHARGING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">BAT_S0_DISCHARGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_STATUS_DISCHARGING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">BAT_S1_FULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_STATUS_FULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">POWER_SUPPLY_STATUS_NOT_CHARGING</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bat_health</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_STOP_CHARGE1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BAT_STOP_CHRG1_OVERTEMPERATURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_HEALTH_OVERHEAT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BAT_STOP_CHRG1_OVERVOLTAGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_HEALTH_OVERVOLTAGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BAT_STOP_CHRG1_BAD_CELL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_HEALTH_DEAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BAT_STOP_CHRG1_COMM_FAIL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_HEALTH_UNKNOWN</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">POWER_SUPPLY_HEALTH_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bat_is_present</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_STATUS2</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BAT_S1_EXISTS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bat_technology</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_STATUS1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BAT_S1_LiION_OR_NiMH</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_TECHNOLOGY_LION</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">POWER_SUPPLY_TECHNOLOGY_NiMH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bat_capacity_level</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status0</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_STATUS0</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status1</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_STATUS1</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status2</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_STATUS2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">BAT_S0_DISCHRG_CRITICAL</span>
			<span class="o">||</span> <span class="n">status1</span> <span class="o">&amp;</span> <span class="n">BAT_S1_EMPTY</span>
			<span class="o">||</span> <span class="n">status2</span> <span class="o">&amp;</span> <span class="n">BAT_S2_LOW_LOW</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status0</span> <span class="o">&amp;</span> <span class="n">BAT_S0_LOW</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_LOW</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status1</span> <span class="o">&amp;</span> <span class="n">BAT_S1_FULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_FULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">POWER_SUPPLY_CAPACITY_LEVEL_NORMAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bat_get_property</span><span class="p">(</span><span class="k">struct</span> <span class="n">power_supply</span> <span class="o">*</span><span class="n">psy</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">psp</span><span class="p">,</span>
				<span class="k">union</span> <span class="n">power_supply_propval</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">compal_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">psy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">compal_data</span><span class="p">,</span> <span class="n">psy</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">psp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_STATUS</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">bat_status</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_HEALTH</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">bat_health</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_PRESENT</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">bat_is_present</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TECHNOLOGY</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">bat_technology</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN</span>: <span class="cm">/* THE design voltage... */</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ec_read_u16</span><span class="p">(</span><span class="n">BAT_VOLTAGE_DESIGN</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ec_read_u16</span><span class="p">(</span><span class="n">BAT_VOLTAGE_NOW</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ec_read_s16</span><span class="p">(</span><span class="n">BAT_CURRENT_NOW</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ec_read_s16</span><span class="p">(</span><span class="n">BAT_CURRENT_AVG</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_POWER_NOW</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_POWER</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ec_read_u16</span><span class="p">(</span><span class="n">BAT_CHARGE_DESIGN</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CHARGE_NOW</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ec_read_u16</span><span class="p">(</span><span class="n">BAT_CHARGE_NOW</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CAPACITY</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_CAPACITY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_CAPACITY_LEVEL</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">bat_capacity_level</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* It smees that BAT_TEMP_AVG is a (2&#39;s complement?) value showing</span>
<span class="cm">	 * the number of degrees, whereas BAT_TEMP is somewhat more</span>
<span class="cm">	 * complicated. It looks like this is a negative nember with a</span>
<span class="cm">	 * 100/256 divider and an offset of 222. Both were determined</span>
<span class="cm">	 * experimentally by comparing BAT_TEMP and BAT_TEMP_AVG. */</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TEMP</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="p">((</span><span class="mi">222</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ec_read_u8</span><span class="p">(</span><span class="n">BAT_TEMP</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_TEMP_AMBIENT</span>: <span class="cm">/* Ambient, Avg, ... same thing */</span>
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">intval</span> <span class="o">=</span> <span class="n">ec_read_s8</span><span class="p">(</span><span class="n">BAT_TEMP_AVG</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* Neither the model name nor manufacturer name work for me. */</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_MODEL_NAME</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">strval</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bat_model_name</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_MANUFACTURER</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">strval</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bat_manufacturer_name</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">POWER_SUPPLY_PROP_SERIAL_NUMBER</span>:
		<span class="n">val</span><span class="o">-&gt;</span><span class="n">strval</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">bat_serial_number</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>





<span class="cm">/* ============== */</span>
<span class="cm">/* Driver Globals */</span>
<span class="cm">/* ============== */</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wake_up_pme</span><span class="p">,</span>
		<span class="mo">0644</span><span class="p">,</span> <span class="n">wake_up_pme_show</span><span class="p">,</span>		<span class="n">wake_up_pme_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wake_up_modem</span><span class="p">,</span>
		<span class="mo">0644</span><span class="p">,</span> <span class="n">wake_up_modem_show</span><span class="p">,</span>	<span class="n">wake_up_modem_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wake_up_lan</span><span class="p">,</span>
		<span class="mo">0644</span><span class="p">,</span> <span class="n">wake_up_lan_show</span><span class="p">,</span>	<span class="n">wake_up_lan_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wake_up_wlan</span><span class="p">,</span>
		<span class="mo">0644</span><span class="p">,</span> <span class="n">wake_up_wlan_show</span><span class="p">,</span>	<span class="n">wake_up_wlan_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wake_up_key</span><span class="p">,</span>
		<span class="mo">0644</span><span class="p">,</span> <span class="n">wake_up_key_show</span><span class="p">,</span>	<span class="n">wake_up_key_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wake_up_mouse</span><span class="p">,</span>
		<span class="mo">0644</span><span class="p">,</span> <span class="n">wake_up_mouse_show</span><span class="p">,</span>	<span class="n">wake_up_mouse_store</span><span class="p">);</span>

<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>        <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">hwmon_name_show</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">fan1_input</span><span class="p">,</span>  <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">fan_show</span><span class="p">,</span>          <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">temp_cpu</span><span class="p">,</span>          <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">temp_cpu_local</span><span class="p">,</span>    <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">temp_cpu_DTS</span><span class="p">,</span>      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp4_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">temp_northbridge</span><span class="p">,</span>  <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp5_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">temp_vga</span><span class="p">,</span>          <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp6_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">temp_SKIN</span><span class="p">,</span>         <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp1_label</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">label_cpu</span><span class="p">,</span>         <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp2_label</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">label_cpu_local</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp3_label</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">label_cpu_DTS</span><span class="p">,</span>     <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp4_label</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">label_northbridge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp5_label</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">label_vga</span><span class="p">,</span>         <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">temp6_label</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">label_SKIN</span><span class="p">,</span>        <span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm1</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">pwm_show</span><span class="p">,</span> <span class="n">pwm_store</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SENSOR_DEVICE_ATTR</span><span class="p">(</span><span class="n">pwm1_enable</span><span class="p">,</span>
		<span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">pwm_enable_show</span><span class="p">,</span> <span class="n">pwm_enable_store</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">compal_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wake_up_pme</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wake_up_modem</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wake_up_lan</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wake_up_wlan</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wake_up_key</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wake_up_mouse</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="cm">/* Maybe put the sensor-stuff in a separate hwmon-driver? That way,</span>
<span class="cm">	 * the hwmon sysfs won&#39;t be cluttered with the above files. */</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_name</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1_enable</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_pwm1</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_fan1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp4_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp5_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp6_input</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp1_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp2_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp3_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp4_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp5_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">sensor_dev_attr_temp6_label</span><span class="p">.</span><span class="n">dev_attr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">compal_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">compal_attributes</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">compal_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="n">compal_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">compal_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">compal_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">compal_remove</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">power_supply_property</span> <span class="n">compal_bat_properties</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">POWER_SUPPLY_PROP_STATUS</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_HEALTH</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_PRESENT</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_TECHNOLOGY</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_VOLTAGE_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CURRENT_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CURRENT_AVG</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_POWER_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CHARGE_NOW</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CAPACITY</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_CAPACITY_LEVEL</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_TEMP</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_TEMP_AMBIENT</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_MODEL_NAME</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_MANUFACTURER</span><span class="p">,</span>
	<span class="n">POWER_SUPPLY_PROP_SERIAL_NUMBER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">compalbl_device</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">compal_device</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">wifi_rfkill</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">bt_rfkill</span><span class="p">;</span>





<span class="cm">/* =================================== */</span>
<span class="cm">/* Initialization &amp; clean-up functions */</span>
<span class="cm">/* =================================== */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmi_check_cb</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Identified laptop model &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="n">extra_features</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmi_check_cb_extra</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Identified laptop model &#39;%s&#39;, enabling extra features</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="n">extra_features</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initdata</span> <span class="n">compal_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;FL90/IFL90&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;IFL90&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VERSION</span><span class="p">,</span> <span class="s">&quot;IFT00&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;FL90/IFL90&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;IFL90&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VERSION</span><span class="p">,</span> <span class="s">&quot;REFERENCE&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;FL91/IFL91&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;IFL91&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VERSION</span><span class="p">,</span> <span class="s">&quot;IFT00&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;FL92/JFL92&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;JFL92&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VERSION</span><span class="p">,</span> <span class="s">&quot;IFT00&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;FT00/IFT00&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;IFT00&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VERSION</span><span class="p">,</span> <span class="s">&quot;IFT00&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Mini 9&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Inspiron 910&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Mini 10&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Inspiron 1010&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Mini 10v&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Inspiron 1011&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Mini 1012&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Inspiron 1012&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Inspiron 11z&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Inspiron 1110&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Dell Mini 12&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Dell Inc.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Inspiron 1210&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;JHL90&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;JHL90&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VERSION</span><span class="p">,</span> <span class="s">&quot;REFERENCE&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb_extra</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;KHLB2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;KHLB2&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VERSION</span><span class="p">,</span> <span class="s">&quot;REFERENCE&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb_extra</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">dmi</span><span class="p">,</span> <span class="n">compal_dmi_table</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">initialize_power_supply_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">compal_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">POWER_SUPPLY_TYPE_BATTERY</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">compal_bat_properties</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">.</span><span class="n">num_properties</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">compal_bat_properties</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">.</span><span class="n">get_property</span> <span class="o">=</span> <span class="n">bat_get_property</span><span class="p">;</span>

	<span class="n">ec_read_sequence</span><span class="p">(</span><span class="n">BAT_MANUFACTURER_NAME_ADDR</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">bat_manufacturer_name</span><span class="p">,</span>
					<span class="n">BAT_MANUFACTURER_NAME_LEN</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bat_manufacturer_name</span><span class="p">[</span><span class="n">BAT_MANUFACTURER_NAME_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ec_read_sequence</span><span class="p">(</span><span class="n">BAT_MODEL_NAME_ADDR</span><span class="p">,</span>
					<span class="n">data</span><span class="o">-&gt;</span><span class="n">bat_model_name</span><span class="p">,</span>
					<span class="n">BAT_MODEL_NAME_LEN</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">bat_model_name</span><span class="p">[</span><span class="n">BAT_MODEL_NAME_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">scnprintf</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">bat_serial_number</span><span class="p">,</span> <span class="n">BAT_SERIAL_NUMBER_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
				<span class="n">ec_read_u16</span><span class="p">(</span><span class="n">BAT_SERIAL_NUMBER_ADDR</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">initialize_fan_control_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">compal_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">pwm_enable</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* Keep motherboard in control for now */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">curr_pwm</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="cm">/* Try not to cause a CPU_on_fire exception</span>
<span class="cm">				 if we take over... */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_rfkill</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wifi_rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="s">&quot;compal-wifi&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compal_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">RFKILL_TYPE_WLAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compal_rfkill_ops</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">WIRELESS_WLAN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wifi_rfkill</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_wifi</span><span class="p">;</span>

	<span class="n">bt_rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="s">&quot;compal-bluetooth&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compal_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compal_rfkill_ops</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">WIRELESS_BT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bt_rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_allocate_bt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">bt_rfkill</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_register_bt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_register_bt:</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">bt_rfkill</span><span class="p">);</span>

<span class="nl">err_allocate_bt:</span>
	<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>

<span class="nl">err_wifi:</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">compal_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ACPI needs to be enabled for this driver to work!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">compal_dmi_table</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Motherboard not recognized (You could try the module&#39;s force-parameter)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_video_backlight_support</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_properties</span><span class="p">));</span>
		<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_PLATFORM</span><span class="p">;</span>
		<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">BACKLIGHT_LEVEL_MAX</span><span class="p">;</span>
		<span class="n">compalbl_device</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">,</span>
							    <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">compalbl_ops</span><span class="p">,</span>
							    <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">compalbl_device</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">compalbl_device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compal_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_backlight</span><span class="p">;</span>

	<span class="n">compal_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compal_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_platform_driver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">compal_device</span><span class="p">);</span> <span class="cm">/* This calls compal_probe */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_platform_device</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">setup_rfkill</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_rfkill</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Driver &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot; successfully loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_rfkill:</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">compal_device</span><span class="p">);</span>

<span class="nl">err_platform_device:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">compal_device</span><span class="p">);</span>

<span class="nl">err_platform_driver:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compal_driver</span><span class="p">);</span>

<span class="nl">err_backlight:</span>
	<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">compalbl_device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">compal_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">compal_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extra_features</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Fan control */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">compal_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">initialize_fan_control_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compal_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span> <span class="o">=</span> <span class="n">hwmon_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
		<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">compal_attribute_group</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Power supply */</span>
	<span class="n">initialize_power_supply_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">power_supply_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compal_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">compal_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">compal_device</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">compal_driver</span><span class="p">);</span>
	<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">compalbl_device</span><span class="p">);</span>
	<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>
	<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">bt_rfkill</span><span class="p">);</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">bt_rfkill</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">compal_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">compal_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">extra_features</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unloading: resetting fan control to motherboard</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pwm_disable_control</span><span class="p">();</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">hwmon_device_unregister</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">hwmon_dev</span><span class="p">);</span>
	<span class="n">power_supply_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">psy</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compal_attribute_group</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">compal_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">compal_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Cezary Jackiewicz&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Roald Frederickx (roald.frederickx@gmail.com)&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Compal Laptop Support&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
