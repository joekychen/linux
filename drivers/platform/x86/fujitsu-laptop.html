<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › platform › x86 › fujitsu-laptop.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>fujitsu-laptop.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*-*-linux-c-*-*/</span>

<span class="cm">/*</span>
<span class="cm">  Copyright (C) 2007,2008 Jonathan Woithe &lt;jwoithe@just42.net&gt;</span>
<span class="cm">  Copyright (C) 2008 Peter Gruber &lt;nokos@gmx.net&gt;</span>
<span class="cm">  Copyright (C) 2008 Tony Vroon &lt;tony@linx.net&gt;</span>
<span class="cm">  Based on earlier work:</span>
<span class="cm">    Copyright (C) 2003 Shane Spencer &lt;shane@bogomip.com&gt;</span>
<span class="cm">    Adrian Yee &lt;brewt-fujitsu@brewt.org&gt;</span>

<span class="cm">  Templated from msi-laptop.c and thinkpad_acpi.c which is copyright</span>
<span class="cm">  by its respective authors.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but</span>
<span class="cm">  WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm">  General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm">  02110-1301, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * fujitsu-laptop.c - Fujitsu laptop support, providing access to additional</span>
<span class="cm"> * features made available on a range of Fujitsu laptops including the</span>
<span class="cm"> * P2xxx/P5xxx/S6xxx/S7xxx series.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver exports a few files in /sys/devices/platform/fujitsu-laptop/;</span>
<span class="cm"> * others may be added at a later date.</span>
<span class="cm"> *</span>
<span class="cm"> *   lcd_level - Screen brightness: contains a single integer in the</span>
<span class="cm"> *   range 0..7. (rw)</span>
<span class="cm"> *</span>
<span class="cm"> * In addition to these platform device attributes the driver</span>
<span class="cm"> * registers itself in the Linux backlight control subsystem and is</span>
<span class="cm"> * available to userspace under /sys/class/backlight/fujitsu-laptop/.</span>
<span class="cm"> *</span>
<span class="cm"> * Hotkeys present on certain Fujitsu laptops (eg: the S6xxx series) are</span>
<span class="cm"> * also supported by this driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver has been tested on a Fujitsu Lifebook S6410, S7020 and</span>
<span class="cm"> * P8010.  It should work on most P-series and S-series Lifebooks, but</span>
<span class="cm"> * YMMV.</span>
<span class="cm"> *</span>
<span class="cm"> * The module parameter use_alt_lcd_levels switches between different ACPI</span>
<span class="cm"> * brightness controls which are used by different Fujitsu laptops.  In most</span>
<span class="cm"> * cases the correct method is automatically detected. &quot;use_alt_lcd_levels=1&quot;</span>
<span class="cm"> * is applicable for a Fujitsu Lifebook S6410 if autodetection fails.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/kfifo.h&gt;</span>
<span class="cp">#include &lt;linux/video_output.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#if defined(CONFIG_LEDS_CLASS) || defined(CONFIG_LEDS_CLASS_MODULE)</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#define FUJITSU_DRIVER_VERSION &quot;0.6.0&quot;</span>

<span class="cp">#define FUJITSU_LCD_N_LEVELS 8</span>

<span class="cp">#define ACPI_FUJITSU_CLASS              &quot;fujitsu&quot;</span>
<span class="cp">#define ACPI_FUJITSU_HID                &quot;FUJ02B1&quot;</span>
<span class="cp">#define ACPI_FUJITSU_DRIVER_NAME	&quot;Fujitsu laptop FUJ02B1 ACPI brightness driver&quot;</span>
<span class="cp">#define ACPI_FUJITSU_DEVICE_NAME        &quot;Fujitsu FUJ02B1&quot;</span>
<span class="cp">#define ACPI_FUJITSU_HOTKEY_HID 	&quot;FUJ02E3&quot;</span>
<span class="cp">#define ACPI_FUJITSU_HOTKEY_DRIVER_NAME &quot;Fujitsu laptop FUJ02E3 ACPI hotkeys driver&quot;</span>
<span class="cp">#define ACPI_FUJITSU_HOTKEY_DEVICE_NAME &quot;Fujitsu FUJ02E3&quot;</span>

<span class="cp">#define ACPI_FUJITSU_NOTIFY_CODE1     0x80</span>

<span class="cp">#define ACPI_VIDEO_NOTIFY_INC_BRIGHTNESS     0x86</span>
<span class="cp">#define ACPI_VIDEO_NOTIFY_DEC_BRIGHTNESS     0x87</span>

<span class="cm">/* FUNC interface - command values */</span>
<span class="cp">#define FUNC_RFKILL	0x1000</span>
<span class="cp">#define FUNC_LEDS	0x1001</span>
<span class="cp">#define FUNC_BUTTONS	0x1002</span>
<span class="cp">#define FUNC_BACKLIGHT  0x1004</span>

<span class="cm">/* FUNC interface - responses */</span>
<span class="cp">#define UNSUPPORTED_CMD 0x80000000</span>

<span class="cp">#if defined(CONFIG_LEDS_CLASS) || defined(CONFIG_LEDS_CLASS_MODULE)</span>
<span class="cm">/* FUNC interface - LED control */</span>
<span class="cp">#define FUNC_LED_OFF	0x1</span>
<span class="cp">#define FUNC_LED_ON	0x30001</span>
<span class="cp">#define KEYBOARD_LAMPS	0x100</span>
<span class="cp">#define LOGOLAMP_POWERON 0x2000</span>
<span class="cp">#define LOGOLAMP_ALWAYS  0x4000</span>
<span class="cp">#endif</span>

<span class="cm">/* Hotkey details */</span>
<span class="cp">#define KEY1_CODE	0x410	</span><span class="cm">/* codes for the keys in the GIRB register */</span><span class="cp"></span>
<span class="cp">#define KEY2_CODE	0x411</span>
<span class="cp">#define KEY3_CODE	0x412</span>
<span class="cp">#define KEY4_CODE	0x413</span>

<span class="cp">#define MAX_HOTKEY_RINGBUFFER_SIZE 100</span>
<span class="cp">#define RINGBUFFERSIZE 40</span>

<span class="cm">/* Debugging */</span>
<span class="cp">#define FUJLAPTOP_LOG	   ACPI_FUJITSU_HID &quot;: &quot;</span>
<span class="cp">#define FUJLAPTOP_ERR	   KERN_ERR FUJLAPTOP_LOG</span>
<span class="cp">#define FUJLAPTOP_NOTICE   KERN_NOTICE FUJLAPTOP_LOG</span>
<span class="cp">#define FUJLAPTOP_INFO	   KERN_INFO FUJLAPTOP_LOG</span>
<span class="cp">#define FUJLAPTOP_DEBUG    KERN_DEBUG FUJLAPTOP_LOG</span>

<span class="cp">#define FUJLAPTOP_DBG_ALL	  0xffff</span>
<span class="cp">#define FUJLAPTOP_DBG_ERROR	  0x0001</span>
<span class="cp">#define FUJLAPTOP_DBG_WARN	  0x0002</span>
<span class="cp">#define FUJLAPTOP_DBG_INFO	  0x0004</span>
<span class="cp">#define FUJLAPTOP_DBG_TRACE	  0x0008</span>

<span class="cp">#define dbg_printk(a_dbg_level, format, arg...) \</span>
<span class="cp">	do { if (dbg_level &amp; a_dbg_level) \</span>
<span class="cp">		printk(FUJLAPTOP_DEBUG &quot;%s: &quot; format, __func__ , ## arg); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#ifdef CONFIG_FUJITSU_LAPTOP_DEBUG</span>
<span class="cp">#define vdbg_printk(a_dbg_level, format, arg...) \</span>
<span class="cp">	dbg_printk(a_dbg_level, format, ## arg)</span>
<span class="cp">#else</span>
<span class="cp">#define vdbg_printk(a_dbg_level, format, arg...)</span>
<span class="cp">#endif</span>

<span class="cm">/* Device controlling the backlight and associated keys */</span>
<span class="k">struct</span> <span class="n">fujitsu_t</span> <span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">acpi_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bl_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pf_device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keycode1</span><span class="p">,</span> <span class="n">keycode2</span><span class="p">,</span> <span class="n">keycode3</span><span class="p">,</span> <span class="n">keycode4</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_brightness</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">brightness_changed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">brightness_level</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fujitsu_t</span> <span class="o">*</span><span class="n">fujitsu</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">use_alt_lcd_levels</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_brightness_adjust</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Device used to access other hotkeys on the laptop */</span>
<span class="k">struct</span> <span class="n">fujitsu_hotkey_t</span> <span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">acpi_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pf_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kfifo</span> <span class="n">fifo</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">fifo_lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rfkill_supported</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rfkill_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">logolamp_registered</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kblamps_registered</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fujitsu_hotkey_t</span> <span class="o">*</span><span class="n">fujitsu_hotkey</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">acpi_fujitsu_hotkey_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_LEDS_CLASS) || defined(CONFIG_LEDS_CLASS_MODULE)</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">logolamp_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">logolamp_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">logolamp_led</span> <span class="o">=</span> <span class="p">{</span>
 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fujitsu::logolamp&quot;</span><span class="p">,</span>
 <span class="p">.</span><span class="n">brightness_get</span> <span class="o">=</span> <span class="n">logolamp_get</span><span class="p">,</span>
 <span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">logolamp_set</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">kblamps_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">kblamps_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">kblamps_led</span> <span class="o">=</span> <span class="p">{</span>
 <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fujitsu::kblamps&quot;</span><span class="p">,</span>
 <span class="p">.</span><span class="n">brightness_get</span> <span class="o">=</span> <span class="n">kblamps_get</span><span class="p">,</span>
 <span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">kblamps_set</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_FUJITSU_LAPTOP_DEBUG</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">dbg_level</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">acpi_fujitsu_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">);</span>

<span class="cm">/* Fujitsu ACPI interface function */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">call_fext_func</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">arg2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACPI_TYPE_INTEGER</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">arg_list</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">output</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">out_obj</span><span class="p">;</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">acpi_handle</span><span class="p">,</span> <span class="s">&quot;FUNC&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_ERROR</span><span class="p">,</span>
				<span class="s">&quot;FUNC interface is not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">arg0</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">arg1</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">arg2</span><span class="p">;</span>

	<span class="n">output</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out_obj</span><span class="p">);</span>
	<span class="n">output</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">out_obj</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_WARN</span><span class="p">,</span>
			<span class="s">&quot;FUNC 0x%x (args 0x%x, 0x%x, 0x%x) call failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">cmd</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out_obj</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_WARN</span><span class="p">,</span>
			<span class="s">&quot;FUNC 0x%x (args 0x%x, 0x%x, 0x%x) did not &quot;</span>
			<span class="s">&quot;return an integer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_TRACE</span><span class="p">,</span>
		<span class="s">&quot;FUNC 0x%x (args 0x%x, 0x%x, 0x%x) returned 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">cmd</span><span class="p">,</span> <span class="n">arg0</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">out_obj</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">out_obj</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_LEDS_CLASS) || defined(CONFIG_LEDS_CLASS_MODULE)</span>
<span class="cm">/* LED class callbacks */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">logolamp_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">&gt;=</span> <span class="n">LED_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">LOGOLAMP_POWERON</span><span class="p">,</span> <span class="n">FUNC_LED_ON</span><span class="p">);</span>
		<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">LOGOLAMP_ALWAYS</span><span class="p">,</span> <span class="n">FUNC_LED_ON</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">&gt;=</span> <span class="n">LED_HALF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">LOGOLAMP_POWERON</span><span class="p">,</span> <span class="n">FUNC_LED_ON</span><span class="p">);</span>
		<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">LOGOLAMP_ALWAYS</span><span class="p">,</span> <span class="n">FUNC_LED_OFF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">LOGOLAMP_POWERON</span><span class="p">,</span> <span class="n">FUNC_LED_OFF</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kblamps_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">&gt;=</span> <span class="n">LED_FULL</span><span class="p">)</span>
		<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">KEYBOARD_LAMPS</span><span class="p">,</span> <span class="n">FUNC_LED_ON</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="n">KEYBOARD_LAMPS</span><span class="p">,</span> <span class="n">FUNC_LED_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="nf">logolamp_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">poweron</span><span class="p">,</span> <span class="n">always</span><span class="p">;</span>

	<span class="n">poweron</span> <span class="o">=</span> <span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">LOGOLAMP_POWERON</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">poweron</span> <span class="o">==</span> <span class="n">FUNC_LED_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_HALF</span><span class="p">;</span>
		<span class="n">always</span> <span class="o">=</span> <span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">LOGOLAMP_ALWAYS</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">always</span> <span class="o">==</span> <span class="n">FUNC_LED_ON</span><span class="p">)</span>
			<span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_FULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">brightness</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="nf">kblamps_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_OFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="n">KEYBOARD_LAMPS</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">==</span> <span class="n">FUNC_LED_ON</span><span class="p">)</span>
		<span class="n">brightness</span> <span class="o">=</span> <span class="n">LED_FULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">brightness</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Hardware access for LCD brightness control */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_lcd_level</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">arg0</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_TYPE_INTEGER</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">arg_list</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg0</span> <span class="p">};</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;set lcd level via SBLL [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">level</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">max_brightness</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">acpi_handle</span><span class="p">,</span> <span class="s">&quot;SBLL&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_ERROR</span><span class="p">,</span> <span class="s">&quot;SBLL not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">arg0</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_list</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_lcd_level_alt</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="n">arg0</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_TYPE_INTEGER</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_object_list</span> <span class="n">arg_list</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg0</span> <span class="p">};</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;set lcd level via SBL2 [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">level</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">max_brightness</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">acpi_handle</span><span class="p">,</span> <span class="s">&quot;SBL2&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_ERROR</span><span class="p">,</span> <span class="s">&quot;SBL2 not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">arg0</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">acpi_evaluate_object</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg_list</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_lcd_level</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;get lcd level via GBLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">acpi_handle</span><span class="p">,</span> <span class="s">&quot;GBLL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">brightness_level</span> <span class="o">=</span> <span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x0fffffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
		<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">brightness_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">brightness_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">brightness_level</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_max_brightness</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>

	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;get max lcd level via RBLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">acpi_evaluate_integer</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">acpi_handle</span><span class="p">,</span> <span class="s">&quot;RBLL&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">max_brightness</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Backlight device stuff */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bl_get_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_lcd_level</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bl_update_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_BACKLIGHT</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_BACKLIGHT</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_ERROR</span><span class="p">,</span>
			<span class="s">&quot;Unable to adjust backlight power, error code %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_alt_lcd_levels</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_lcd_level_alt</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_lcd_level</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_ERROR</span><span class="p">,</span>
			<span class="s">&quot;Unable to adjust LCD brightness, error code %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">fujitsubl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">bl_get_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_status</span> <span class="o">=</span> <span class="n">bl_update_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Platform LCD brightness device */</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_max_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_max_brightness</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_brightness_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">brightness_changed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_lcd_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_lcd_level</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_lcd_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">max_brightness</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">use_alt_lcd_levels</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_lcd_level_alt</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_lcd_level</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_lcd_level</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">ignore_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_lid_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_supported</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_state</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_dock_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_supported</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_state</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;docked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;undocked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">show_radios_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_supported</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;unknown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_state</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;killed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">max_brightness</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_max_brightness</span><span class="p">,</span> <span class="n">ignore_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">brightness_changed</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_brightness_changed</span><span class="p">,</span>
		   <span class="n">ignore_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lcd_level</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_lcd_level</span><span class="p">,</span> <span class="n">store_lcd_level</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lid</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_lid_state</span><span class="p">,</span> <span class="n">ignore_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dock</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_dock_state</span><span class="p">,</span> <span class="n">ignore_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">radios</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_radios_state</span><span class="p">,</span> <span class="n">ignore_store</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">fujitsupf_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_brightness_changed</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_max_brightness</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lcd_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lid</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_dock</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_radios</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">fujitsupf_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">fujitsupf_attributes</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">fujitsupf_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fujitsu-laptop&quot;</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		   <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dmi_check_cb_common</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Identified laptop model &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">use_alt_lcd_levels</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
				<span class="s">&quot;</span><span class="se">\\</span><span class="s">_SB.PCI0.LPCB.FJEX.SBL2&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)))</span>
			<span class="n">use_alt_lcd_levels</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">use_alt_lcd_levels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_TRACE</span><span class="p">,</span> <span class="s">&quot;auto-detected usealt as &quot;</span>
			<span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">use_alt_lcd_levels</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmi_check_cb_s6410</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmi_check_cb_common</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode1</span> <span class="o">=</span> <span class="n">KEY_SCREENLOCK</span><span class="p">;</span>	<span class="cm">/* &quot;Lock&quot; */</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode2</span> <span class="o">=</span> <span class="n">KEY_HELP</span><span class="p">;</span>	<span class="cm">/* &quot;Mobility Center&quot; */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmi_check_cb_s6420</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmi_check_cb_common</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode1</span> <span class="o">=</span> <span class="n">KEY_SCREENLOCK</span><span class="p">;</span>	<span class="cm">/* &quot;Lock&quot; */</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode2</span> <span class="o">=</span> <span class="n">KEY_HELP</span><span class="p">;</span>	<span class="cm">/* &quot;Mobility Center&quot; */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmi_check_cb_p8010</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dmi_check_cb_common</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode1</span> <span class="o">=</span> <span class="n">KEY_HELP</span><span class="p">;</span>	<span class="cm">/* &quot;Support&quot; */</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode3</span> <span class="o">=</span> <span class="n">KEY_SWITCHVIDEOMODE</span><span class="p">;</span>	<span class="cm">/* &quot;Presentation&quot; */</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode4</span> <span class="o">=</span> <span class="n">KEY_WWW</span><span class="p">;</span>	<span class="cm">/* &quot;Internet&quot; */</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">fujitsu_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Fujitsu Siemens S6410&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;FUJITSU SIEMENS&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;LIFEBOOK S6410&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb_s6410</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Fujitsu Siemens S6420&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;FUJITSU SIEMENS&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;LIFEBOOK S6420&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb_s6420</span><span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Fujitsu LifeBook P8010&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;FUJITSU&quot;</span><span class="p">),</span>
		     <span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;LifeBook P8010&quot;</span><span class="p">),</span>
		     <span class="p">},</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb_p8010</span><span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/* ACPI device for LCD brightness control */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_fujitsu_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">acpi_handle</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">acpi_device_name</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ACPI_FUJITSU_DEVICE_NAME</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">acpi_device_class</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ACPI_FUJITSU_CLASS</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="p">;</span>

	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_stop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span>
		 <span class="s">&quot;%s/video/input0&quot;</span><span class="p">,</span> <span class="n">acpi_device_hid</span><span class="p">(</span><span class="n">device</span><span class="p">));</span>

	<span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">acpi_device_name</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_BRIGHTNESSUP</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_BRIGHTNESSDOWN</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_input_dev</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_update_power</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">acpi_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error reading power state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unregister_input_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ACPI: %s [%s] (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">acpi_device_name</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">acpi_device_bid</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
	       <span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">state</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span>
	    <span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_NAME__INI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_INFO</span><span class="p">,</span> <span class="s">&quot;Invoking _INI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span>
		    <span class="p">(</span><span class="n">acpi_evaluate_object</span>
		     <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_NAME__INI</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;_INI Method failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* do config (detect defaults) */</span>
	<span class="n">use_alt_lcd_levels</span> <span class="o">=</span> <span class="n">use_alt_lcd_levels</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">disable_brightness_adjust</span> <span class="o">=</span> <span class="n">disable_brightness_adjust</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_INFO</span><span class="p">,</span>
		    <span class="s">&quot;config: [alt interface: %d], [adjust disable: %d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">use_alt_lcd_levels</span><span class="p">,</span> <span class="n">disable_brightness_adjust</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_max_brightness</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">FUJITSU_LCD_N_LEVELS</span><span class="p">;</span>
	<span class="n">get_lcd_level</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">err_unregister_input_dev:</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="n">input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_free_input_dev:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="nl">err_stop:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_fujitsu_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fujitsu_t</span> <span class="o">*</span><span class="n">fujitsu</span> <span class="o">=</span> <span class="n">acpi_driver_data</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">acpi_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Brightness notify */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_fujitsu_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keycode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oldb</span><span class="p">,</span> <span class="n">newb</span><span class="p">;</span>

	<span class="n">input</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_FUJITSU_NOTIFY_CODE1</span>:
		<span class="n">keycode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">oldb</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">brightness_level</span><span class="p">;</span>
		<span class="n">get_lcd_level</span><span class="p">();</span>
		<span class="n">newb</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">brightness_level</span><span class="p">;</span>

		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_TRACE</span><span class="p">,</span>
			    <span class="s">&quot;brightness button event [%i -&gt; %i (%i)]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">oldb</span><span class="p">,</span> <span class="n">newb</span><span class="p">,</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">brightness_changed</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">oldb</span> <span class="o">&lt;</span> <span class="n">newb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disable_brightness_adjust</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">use_alt_lcd_levels</span><span class="p">)</span>
					<span class="n">set_lcd_level_alt</span><span class="p">(</span><span class="n">newb</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">set_lcd_level</span><span class="p">(</span><span class="n">newb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">acpi_bus_generate_proc_event</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">ACPI_VIDEO_NOTIFY_INC_BRIGHTNESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">keycode</span> <span class="o">=</span> <span class="n">KEY_BRIGHTNESSUP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">oldb</span> <span class="o">&gt;</span> <span class="n">newb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">disable_brightness_adjust</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">use_alt_lcd_levels</span><span class="p">)</span>
					<span class="n">set_lcd_level_alt</span><span class="p">(</span><span class="n">newb</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">set_lcd_level</span><span class="p">(</span><span class="n">newb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">acpi_bus_generate_proc_event</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">ACPI_VIDEO_NOTIFY_DEC_BRIGHTNESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">keycode</span> <span class="o">=</span> <span class="n">KEY_BRIGHTNESSDOWN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">keycode</span> <span class="o">=</span> <span class="n">KEY_UNKNOWN</span><span class="p">;</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_WARN</span><span class="p">,</span>
			    <span class="s">&quot;unsupported event [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ACPI device for hotkey handling */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_fujitsu_hotkey_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">device</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">acpi_handle</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">acpi_device_name</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
		<span class="n">ACPI_FUJITSU_HOTKEY_DEVICE_NAME</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">acpi_device_class</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ACPI_FUJITSU_CLASS</span><span class="p">);</span>
	<span class="n">device</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">=</span> <span class="n">fujitsu_hotkey</span><span class="p">;</span>

	<span class="cm">/* kfifo */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">fifo_lock</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">kfifo_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">,</span> <span class="n">RINGBUFFERSIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">),</span>
			<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;kfifo_alloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_stop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_fifo</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span>
		 <span class="s">&quot;%s/video/input0&quot;</span><span class="p">,</span> <span class="n">acpi_device_hid</span><span class="p">(</span><span class="n">device</span><span class="p">));</span>

	<span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">acpi_device_name</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode1</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode2</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode3</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode4</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_UNKNOWN</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_input_dev</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_update_power</span><span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">acpi_handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error reading power state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unregister_input_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ACPI: %s [%s] (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">acpi_device_name</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="n">acpi_device_bid</span><span class="p">(</span><span class="n">device</span><span class="p">),</span>
		<span class="o">!</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">state</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>

	<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span>
	    <span class="p">(</span><span class="n">acpi_get_handle</span><span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_NAME__INI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_INFO</span><span class="p">,</span> <span class="s">&quot;Invoking _INI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span>
		    <span class="p">(</span><span class="n">acpi_evaluate_object</span>
		     <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">METHOD_NAME__INI</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;_INI Method failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_BUTTONS</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_HOTKEY_RINGBUFFER_SIZE</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* No action, result is discarded */</span>
	<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_INFO</span><span class="p">,</span> <span class="s">&quot;Discarded %i ringbuffer entries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_supported</span> <span class="o">=</span>
		<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_RFKILL</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* Make sure our bitmask of supported functions is cleared if the</span>
<span class="cm">	   RFKILL function block is not implemented, like on the S7020. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_supported</span> <span class="o">==</span> <span class="n">UNSUPPORTED_CMD</span><span class="p">)</span>
		<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_supported</span><span class="p">)</span>
		<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_state</span> <span class="o">=</span>
			<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_RFKILL</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="cm">/* Suspect this is a keymap of the application panel, print it */</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;BTNI: [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_BUTTONS</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">));</span>

<span class="cp">#if defined(CONFIG_LEDS_CLASS) || defined(CONFIG_LEDS_CLASS_MODULE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">LOGOLAMP_POWERON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">logolamp_led</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">logolamp_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not register LED handler for logo lamp, error %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">result</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_LEDS</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">KEYBOARD_LAMPS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_BUTTONS</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">kblamps_led</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">kblamps_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not register LED handler for keyboard lamps, error %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">result</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="nl">err_unregister_input_dev:</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
	<span class="n">input</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">err_free_input_dev:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
<span class="nl">err_free_fifo:</span>
	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">);</span>
<span class="nl">err_stop:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acpi_fujitsu_hotkey_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fujitsu_hotkey_t</span> <span class="o">*</span><span class="n">fujitsu_hotkey</span> <span class="o">=</span> <span class="n">acpi_driver_data</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

<span class="cp">#if defined(CONFIG_LEDS_CLASS) || defined(CONFIG_LEDS_CLASS_MODULE)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">logolamp_registered</span><span class="p">)</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">logolamp_led</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">kblamps_registered</span><span class="p">)</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kblamps_led</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>

	<span class="n">kfifo_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">);</span>

	<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">acpi_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acpi_fujitsu_hotkey_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">acpi_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">keycode_r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">input</span> <span class="o">=</span> <span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_supported</span><span class="p">)</span>
		<span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">rfkill_state</span> <span class="o">=</span>
			<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_RFKILL</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACPI_FUJITSU_NOTIFY_CODE1</span>:
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">irb</span> <span class="o">=</span>
			<span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_BUTTONS</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_HOTKEY_RINGBUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">irb</span> <span class="o">&amp;</span> <span class="mh">0x4ff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">KEY1_CODE</span>:
				<span class="n">keycode</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY2_CODE</span>:
				<span class="n">keycode</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY3_CODE</span>:
				<span class="n">keycode</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KEY4_CODE</span>:
				<span class="n">keycode</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">keycode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_WARN</span><span class="p">,</span>
					    <span class="s">&quot;Unknown GIRB result [%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irb</span><span class="p">);</span>
				<span class="n">keycode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_TRACE</span><span class="p">,</span>
					<span class="s">&quot;Push keycode into ringbuffer [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">keycode</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">kfifo_in_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">,</span>
						   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">keycode</span><span class="p">,</span>
						   <span class="k">sizeof</span><span class="p">(</span><span class="n">keycode</span><span class="p">),</span>
						   <span class="o">&amp;</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">fifo_lock</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keycode</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_WARN</span><span class="p">,</span>
					    <span class="s">&quot;Could not push keycode [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">keycode</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="n">input_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span>
					<span class="n">kfifo_out_locked</span><span class="p">(</span>
					 <span class="o">&amp;</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">fifo</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">keycode_r</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">keycode_r</span><span class="p">),</span>
					 <span class="o">&amp;</span><span class="n">fujitsu_hotkey</span><span class="o">-&gt;</span><span class="n">fifo_lock</span><span class="p">))</span>
					 <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keycode_r</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">keycode_r</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">input_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
					<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_TRACE</span><span class="p">,</span>
					  <span class="s">&quot;Pop keycode from ringbuffer [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">keycode_r</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">keycode</span> <span class="o">=</span> <span class="n">KEY_UNKNOWN</span><span class="p">;</span>
		<span class="n">vdbg_printk</span><span class="p">(</span><span class="n">FUJLAPTOP_DBG_WARN</span><span class="p">,</span>
			    <span class="s">&quot;Unsupported event [0x%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">input</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialization */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="n">fujitsu_device_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">ACPI_FUJITSU_HID</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">acpi_driver</span> <span class="n">acpi_fujitsu_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ACPI_FUJITSU_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">ACPI_FUJITSU_CLASS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">fujitsu_device_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">acpi_fujitsu_add</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">acpi_fujitsu_remove</span><span class="p">,</span>
		<span class="p">.</span><span class="n">notify</span> <span class="o">=</span> <span class="n">acpi_fujitsu_notify</span><span class="p">,</span>
		<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="n">fujitsu_hotkey_device_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">ACPI_FUJITSU_HOTKEY_HID</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">acpi_driver</span> <span class="n">acpi_fujitsu_hotkey_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">ACPI_FUJITSU_HOTKEY_DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="n">ACPI_FUJITSU_CLASS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">fujitsu_hotkey_device_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">acpi_fujitsu_hotkey_add</span><span class="p">,</span>
		<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">acpi_fujitsu_hotkey_remove</span><span class="p">,</span>
		<span class="p">.</span><span class="n">notify</span> <span class="o">=</span> <span class="n">acpi_fujitsu_hotkey_notify</span><span class="p">,</span>
		<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fujitsu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">max_brightness</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">fujitsu</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fujitsu_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fujitsu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode1</span> <span class="o">=</span> <span class="n">KEY_PROG1</span><span class="p">;</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode2</span> <span class="o">=</span> <span class="n">KEY_PROG2</span><span class="p">;</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode3</span> <span class="o">=</span> <span class="n">KEY_PROG3</span><span class="p">;</span>
	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">keycode4</span> <span class="o">=</span> <span class="n">KEY_PROG4</span><span class="p">;</span>
	<span class="n">dmi_check_system</span><span class="p">(</span><span class="n">fujitsu_dmi_table</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_fujitsu_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_acpi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register platform stuff */</span>

	<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;fujitsu-laptop&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_platform_driver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_platform_device1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span>
	    <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">fujitsupf_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_platform_device2</span><span class="p">;</span>

	<span class="cm">/* Register backlight stuff */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_video_backlight_support</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_properties</span><span class="p">));</span>
		<span class="n">max_brightness</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">max_brightness</span><span class="p">;</span>
		<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_PLATFORM</span><span class="p">;</span>
		<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">max_brightness</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="s">&quot;fujitsu-laptop&quot;</span><span class="p">,</span>
							       <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
							       <span class="o">&amp;</span><span class="n">fujitsubl_ops</span><span class="p">,</span>
							       <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span><span class="p">);</span>
			<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail_sysfs_group</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">brightness_level</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsupf_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_backlight</span><span class="p">;</span>

	<span class="cm">/* Register hotkey driver */</span>

	<span class="n">fujitsu_hotkey</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fujitsu_hotkey_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fujitsu_hotkey</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_hotkey</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">acpi_bus_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_fujitsu_hotkey_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_hotkey1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sync backlight power status (needs FUJ02E3 device, hence deferred) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acpi_video_backlight_support</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">call_fext_func</span><span class="p">(</span><span class="n">FUNC_BACKLIGHT</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;driver &quot;</span> <span class="n">FUJITSU_DRIVER_VERSION</span> <span class="s">&quot; successfully loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_hotkey1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="p">);</span>
<span class="nl">fail_hotkey:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsupf_driver</span><span class="p">);</span>
<span class="nl">fail_backlight:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span><span class="p">)</span>
		<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span><span class="p">);</span>
<span class="nl">fail_sysfs_group:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">fujitsupf_attribute_group</span><span class="p">);</span>
<span class="nl">fail_platform_device2:</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="p">);</span>
<span class="nl">fail_platform_device1:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="p">);</span>
<span class="nl">fail_platform_driver:</span>
	<span class="n">acpi_bus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_fujitsu_driver</span><span class="p">);</span>
<span class="nl">fail_acpi:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fujitsu</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fujitsu_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_bus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_fujitsu_hotkey_driver</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fujitsu_hotkey</span><span class="p">);</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsupf_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span><span class="p">)</span>
		<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">bl_device</span><span class="p">);</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">fujitsupf_attribute_group</span><span class="p">);</span>

	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">fujitsu</span><span class="o">-&gt;</span><span class="n">pf_device</span><span class="p">);</span>

	<span class="n">acpi_bus_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acpi_fujitsu_driver</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fujitsu</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fujitsu_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fujitsu_cleanup</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">use_alt_lcd_levels</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">use_alt_lcd_levels</span><span class="p">,</span>
		 <span class="s">&quot;Use alternative interface for lcd_levels (needed for Lifebook s6410).&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_brightness_adjust</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_brightness_adjust</span><span class="p">,</span> <span class="s">&quot;Disable brightness adjustment .&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_FUJITSU_LAPTOP_DEBUG</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">dbg_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Sets debug level bit-mask&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jonathan Woithe, Peter Gruber, Tony Vroon&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Fujitsu laptop extras support&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">FUJITSU_DRIVER_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnFUJITSUSIEMENS:*:pvr:rvnFUJITSU:rnFJNB1D3:*:cvrS6410:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnFUJITSUSIEMENS:*:pvr:rvnFUJITSU:rnFJNB1E6:*:cvrS6420:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnFUJITSU:*:pvr:rvnFUJITSU:rnFJNB19C:*:cvrS7020:*&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">pnp_ids</span><span class="p">[]</span> <span class="n">__used</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;FUJ02bf&quot;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;FUJ02B1&quot;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;FUJ02E3&quot;</span><span class="p">},</span>
	<span class="p">{.</span><span class="n">id</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">pnp_ids</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
