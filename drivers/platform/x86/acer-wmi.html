<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › platform › x86 › acer-wmi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>acer-wmi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Acer WMI Laptop Extras</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007-2009	Carlos Corbacho &lt;carlos@strangeworlds.co.uk&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Based on acer_acpi:</span>
<span class="cm"> *    Copyright (C) 2005-2007	E.M. Smith</span>
<span class="cm"> *    Copyright (C) 2007-2008	Carlos Corbacho &lt;cathectic@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/i8042.h&gt;</span>
<span class="cp">#include &lt;linux/rfkill.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/input/sparse-keymap.h&gt;</span>

<span class="cp">#include &lt;acpi/acpi_drivers.h&gt;</span>
<span class="cp">#include &lt;acpi/video.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Carlos Corbacho&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Acer Laptop WMI Extras Driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Magic Number</span>
<span class="cm"> * Meaning is unknown - this number is required for writing to ACPI for AMW0</span>
<span class="cm"> * (it&#39;s also used in acerhk when directly accessing the BIOS)</span>
<span class="cm"> */</span>
<span class="cp">#define ACER_AMW0_WRITE	0x9610</span>

<span class="cm">/*</span>
<span class="cm"> * Bit masks for the AMW0 interface</span>
<span class="cm"> */</span>
<span class="cp">#define ACER_AMW0_WIRELESS_MASK  0x35</span>
<span class="cp">#define ACER_AMW0_BLUETOOTH_MASK 0x34</span>
<span class="cp">#define ACER_AMW0_MAILLED_MASK   0x31</span>

<span class="cm">/*</span>
<span class="cm"> * Method IDs for WMID interface</span>
<span class="cm"> */</span>
<span class="cp">#define ACER_WMID_GET_WIRELESS_METHODID		1</span>
<span class="cp">#define ACER_WMID_GET_BLUETOOTH_METHODID	2</span>
<span class="cp">#define ACER_WMID_GET_BRIGHTNESS_METHODID	3</span>
<span class="cp">#define ACER_WMID_SET_WIRELESS_METHODID		4</span>
<span class="cp">#define ACER_WMID_SET_BLUETOOTH_METHODID	5</span>
<span class="cp">#define ACER_WMID_SET_BRIGHTNESS_METHODID	6</span>
<span class="cp">#define ACER_WMID_GET_THREEG_METHODID		10</span>
<span class="cp">#define ACER_WMID_SET_THREEG_METHODID		11</span>

<span class="cm">/*</span>
<span class="cm"> * Acer ACPI method GUIDs</span>
<span class="cm"> */</span>
<span class="cp">#define AMW0_GUID1		&quot;67C3371D-95A3-4C37-BB61-DD47B491DAAB&quot;</span>
<span class="cp">#define AMW0_GUID2		&quot;431F16ED-0C2B-444C-B267-27DEB140CF9C&quot;</span>
<span class="cp">#define WMID_GUID1		&quot;6AF4F258-B401-42FD-BE91-3D4AC2D7C0D3&quot;</span>
<span class="cp">#define WMID_GUID2		&quot;95764E09-FB56-4E83-B31A-37761F60994A&quot;</span>
<span class="cp">#define WMID_GUID3		&quot;61EF69EA-865C-4BC3-A502-A0DEBA0CB531&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Acer ACPI event GUIDs</span>
<span class="cm"> */</span>
<span class="cp">#define ACERWMID_EVENT_GUID &quot;676AA15E-6A47-4D9F-A2CC-1E6D18D14026&quot;</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;wmi:67C3371D-95A3-4C37-BB61-DD47B491DAAB&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;wmi:6AF4F258-B401-42FD-BE91-3D4AC2D7C0D3&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;wmi:676AA15E-6A47-4D9F-A2CC-1E6D18D14026&quot;</span><span class="p">);</span>

<span class="k">enum</span> <span class="n">acer_wmi_event_ids</span> <span class="p">{</span>
	<span class="n">WMID_HOTKEY_EVENT</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">key_entry</span> <span class="n">acer_wmi_keymap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_WLAN</span><span class="p">}</span> <span class="p">},</span>     <span class="cm">/* WiFi */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_WLAN</span><span class="p">}</span> <span class="p">},</span>     <span class="cm">/* WiFi */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_WLAN</span><span class="p">}</span> <span class="p">},</span>     <span class="cm">/* WiFi */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_BLUETOOTH</span><span class="p">}</span> <span class="p">},</span>	<span class="cm">/* BT */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_PROG1</span><span class="p">}</span> <span class="p">},</span>    <span class="cm">/* Backup */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_PROG2</span><span class="p">}</span> <span class="p">},</span>    <span class="cm">/* Arcade */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_PROG3</span><span class="p">}</span> <span class="p">},</span>    <span class="cm">/* P_Key */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_PROG4</span><span class="p">}</span> <span class="p">},</span>    <span class="cm">/* Social networking_Key */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_PROG3</span><span class="p">}</span> <span class="p">},</span>    <span class="cm">/* P_Key for TM8372 */</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_MUTE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_PREVIOUSSONG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x4d</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_PREVIOUSSONG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_NEXTSONG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_NEXTSONG</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_PLAYPAUSE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_PLAYPAUSE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_STOP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_STOP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_VOLUMEUP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_SWITCHVIDEOMODE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_BRIGHTNESSUP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_BRIGHTNESSDOWN</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_SWITCHVIDEOMODE</span><span class="p">}</span> <span class="p">},</span>	<span class="cm">/* Display Switch */</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_SLEEP</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_TOUCHPAD_TOGGLE</span><span class="p">}</span> <span class="p">},</span>	<span class="cm">/* Touch Pad On/Off */</span>
	<span class="p">{</span><span class="n">KE_IGNORE</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_TOUCHPAD_TOGGLE</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">KE_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">acer_wmi_input_dev</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">event_return_value</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_num</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">device_state</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * GUID3 Get Device Status device flags</span>
<span class="cm"> */</span>
<span class="cp">#define ACER_WMID3_GDS_WIRELESS		(1&lt;&lt;0)	</span><span class="cm">/* WiFi */</span><span class="cp"></span>
<span class="cp">#define ACER_WMID3_GDS_THREEG		(1&lt;&lt;6)	</span><span class="cm">/* 3G */</span><span class="cp"></span>
<span class="cp">#define ACER_WMID3_GDS_WIMAX		(1&lt;&lt;7)	</span><span class="cm">/* WiMAX */</span><span class="cp"></span>
<span class="cp">#define ACER_WMID3_GDS_BLUETOOTH	(1&lt;&lt;11)	</span><span class="cm">/* BT */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">lm_input_params</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">function_num</span><span class="p">;</span>        <span class="cm">/* Function Number */</span>
	<span class="n">u16</span> <span class="n">commun_devices</span><span class="p">;</span>     <span class="cm">/* Communication type devices default status */</span>
	<span class="n">u16</span> <span class="n">devices</span><span class="p">;</span>            <span class="cm">/* Other type devices default status */</span>
	<span class="n">u8</span> <span class="n">lm_status</span><span class="p">;</span>           <span class="cm">/* Launch Manager Status */</span>
	<span class="n">u16</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">lm_return_value</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">error_code</span><span class="p">;</span>          <span class="cm">/* Error Code */</span>
	<span class="n">u8</span> <span class="n">ec_return_value</span><span class="p">;</span>     <span class="cm">/* EC Return Value */</span>
	<span class="n">u16</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">wmid3_gds_set_input_param</span> <span class="p">{</span>     <span class="cm">/* Set Device Status input parameter */</span>
	<span class="n">u8</span> <span class="n">function_num</span><span class="p">;</span>        <span class="cm">/* Function Number */</span>
	<span class="n">u8</span> <span class="n">hotkey_number</span><span class="p">;</span>       <span class="cm">/* Hotkey Number */</span>
	<span class="n">u16</span> <span class="n">devices</span><span class="p">;</span>            <span class="cm">/* Set Device */</span>
	<span class="n">u8</span> <span class="n">volume_value</span><span class="p">;</span>        <span class="cm">/* Volume Value */</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">wmid3_gds_get_input_param</span> <span class="p">{</span>     <span class="cm">/* Get Device Status input parameter */</span>
	<span class="n">u8</span> <span class="n">function_num</span><span class="p">;</span>	<span class="cm">/* Function Number */</span>
	<span class="n">u8</span> <span class="n">hotkey_number</span><span class="p">;</span>	<span class="cm">/* Hotkey Number */</span>
	<span class="n">u16</span> <span class="n">devices</span><span class="p">;</span>		<span class="cm">/* Get Device */</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">wmid3_gds_return_value</span> <span class="p">{</span>	<span class="cm">/* Get Device Status return value*/</span>
	<span class="n">u8</span> <span class="n">error_code</span><span class="p">;</span>		<span class="cm">/* Error Code */</span>
	<span class="n">u8</span> <span class="n">ec_return_value</span><span class="p">;</span>	<span class="cm">/* EC Return Value */</span>
	<span class="n">u16</span> <span class="n">devices</span><span class="p">;</span>		<span class="cm">/* Current Device Status */</span>
	<span class="n">u32</span> <span class="n">reserved</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="k">struct</span> <span class="n">hotkey_function_type_aa</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">commun_func_bitmap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">application_func_bitmap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">media_func_bitmap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">display_func_bitmap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">others_func_bitmap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">commun_fn_key_number</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">));</span>

<span class="cm">/*</span>
<span class="cm"> * Interface capability flags</span>
<span class="cm"> */</span>
<span class="cp">#define ACER_CAP_MAILLED		(1&lt;&lt;0)</span>
<span class="cp">#define ACER_CAP_WIRELESS		(1&lt;&lt;1)</span>
<span class="cp">#define ACER_CAP_BLUETOOTH		(1&lt;&lt;2)</span>
<span class="cp">#define ACER_CAP_BRIGHTNESS		(1&lt;&lt;3)</span>
<span class="cp">#define ACER_CAP_THREEG			(1&lt;&lt;4)</span>
<span class="cp">#define ACER_CAP_ANY			(0xFFFFFFFF)</span>

<span class="cm">/*</span>
<span class="cm"> * Interface type flags</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">interface_flags</span> <span class="p">{</span>
	<span class="n">ACER_AMW0</span><span class="p">,</span>
	<span class="n">ACER_AMW0_V2</span><span class="p">,</span>
	<span class="n">ACER_WMID</span><span class="p">,</span>
	<span class="n">ACER_WMID_v2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define ACER_DEFAULT_WIRELESS  0</span>
<span class="cp">#define ACER_DEFAULT_BLUETOOTH 0</span>
<span class="cp">#define ACER_DEFAULT_MAILLED   0</span>
<span class="cp">#define ACER_DEFAULT_THREEG    0</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">max_brightness</span> <span class="o">=</span> <span class="mh">0xF</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mailled</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">brightness</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">threeg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">force_series</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">ec_raw_mode</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">has_type_aa</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">commun_func_bitmap</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">commun_fn_key_number</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">mailled</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">brightness</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">threeg</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force_series</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ec_raw_mode</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mailled</span><span class="p">,</span> <span class="s">&quot;Set initial state of Mail LED&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">brightness</span><span class="p">,</span> <span class="s">&quot;Set initial LCD backlight brightness&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">threeg</span><span class="p">,</span> <span class="s">&quot;Set initial state of 3G hardware&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force_series</span><span class="p">,</span> <span class="s">&quot;Force a different laptop series&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ec_raw_mode</span><span class="p">,</span> <span class="s">&quot;Enable EC raw mode&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">acer_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">mailled</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">threeg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">brightness</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">acer_debug</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">devices</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wmid_devices</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">wireless_rfkill</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">bluetooth_rfkill</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">threeg_rfkill</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">rfkill_inited</span><span class="p">;</span>

<span class="cm">/* Each low-level interface must define at least some of the following */</span>
<span class="k">struct</span> <span class="n">wmi_interface</span> <span class="p">{</span>
	<span class="cm">/* The WMI device type */</span>
	<span class="n">u32</span> <span class="n">type</span><span class="p">;</span>

	<span class="cm">/* The capabilities this interface provides */</span>
	<span class="n">u32</span> <span class="n">capability</span><span class="p">;</span>

	<span class="cm">/* Private data for the current interface */</span>
	<span class="k">struct</span> <span class="n">acer_data</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* debugfs entries associated with this interface */</span>
	<span class="k">struct</span> <span class="n">acer_debug</span> <span class="n">debug</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* The static interface pointer, points to the currently detected interface */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wmi_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Embedded Controller quirks</span>
<span class="cm"> * Some laptops require us to directly access the EC to either enable or query</span>
<span class="cm"> * features that are not available through WMI.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">quirk_entry</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">wireless</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mailled</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">brightness</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bluetooth</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">quirk_entry</span> <span class="o">*</span><span class="n">quirks</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_quirks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">mailled</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmi_matched</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">dmi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">quirks</span> <span class="o">=</span> <span class="n">dmi</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">quirk_entry</span> <span class="n">quirk_unknown</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">quirk_entry</span> <span class="n">quirk_acer_aspire_1520</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">quirk_entry</span> <span class="n">quirk_acer_travelmate_2490</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mailled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* This AMW0 laptop has no bluetooth */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">quirk_entry</span> <span class="n">quirk_medion_md_98300</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">wireless</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">quirk_entry</span> <span class="n">quirk_fujitsu_amilo_li_1718</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">wireless</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">quirk_entry</span> <span class="n">quirk_lenovo_ideapad_s205</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">wireless</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* The Aspire One has a dummy ACPI-WMI interface - disable it */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__devinitdata</span> <span class="n">acer_blacklist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire One (SSD)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;AOA110&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire One (HDD)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;AOA150&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">acer_quirks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 1360&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 1360&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_aspire_1520</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 1520&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 1520&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_aspire_1520</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 3100&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 3100&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 3610&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 3610&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 5100&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 5100&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 5610&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 5610&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 5630&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 5630&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 5650&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 5650&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 5680&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 5680&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 9110&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 9110&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer TravelMate 2490&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TravelMate 2490&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer TravelMate 4200&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TravelMate 4200&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Fujitsu Siemens Amilo Li 1718&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;FUJITSU SIEMENS&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;AMILO Li 1718&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_fujitsu_amilo_li_1718</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Medion MD 98300&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;MEDION&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;WAM2030&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_medion_md_98300</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Lenovo Ideapad S205&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;LENOVO&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;10382LG&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_lenovo_ideapad_s205</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Lenovo Ideapad S205 (Brazos)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;LENOVO&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Brazos&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_lenovo_ideapad_s205</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_matched</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Lenovo 3000 N200&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;LENOVO&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;0687A31&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_fujitsu_amilo_li_1718</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_set_backlight_video_vendor</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Brightness must be controlled by generic video driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">video_vendor_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">video_set_backlight_video_vendor</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer TravelMate 4750&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TravelMate 4750&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">video_set_backlight_video_vendor</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Extensa 5235&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Extensa 5235&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">video_set_backlight_video_vendor</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer TravelMate 5760&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;TravelMate 5760&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">video_set_backlight_video_vendor</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Acer Aspire 5750&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;Acer&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;Aspire 5750&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="cm">/* Find which quirks are needed for a particular vendor/ model pair */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">find_quirks</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force_series</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dmi_check_system</span><span class="p">(</span><span class="n">acer_quirks</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">force_series</span> <span class="o">==</span> <span class="mi">2490</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">quirks</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_acer_travelmate_2490</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">quirks</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">quirk_unknown</span><span class="p">;</span>

	<span class="n">set_quirks</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * General interface convenience methods</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">has_cap</span><span class="p">(</span><span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">cap</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * AMW0 (V1) interface</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wmab_args</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">eax</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ebx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ecx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">edx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">wmab_ret</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">eax</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ebx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ecx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">edx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eex</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">wmab_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmab_args</span> <span class="o">*</span><span class="n">regbuf</span><span class="p">,</span>
<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="o">*</span><span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">input</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmab_args</span><span class="p">);</span>
	<span class="n">input</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">regbuf</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_evaluate_method</span><span class="p">(</span><span class="n">AMW0_GUID1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">AMW0_get_u32</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACER_CAP_MAILLED</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">mailled</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="mh">0xA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_WIRELESS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">wireless</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="mh">0x7B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="mh">0x71</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">err</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="mh">0x78</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="mh">0xA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BLUETOOTH</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">bluetooth</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="mh">0xA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BRIGHTNESS</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="mh">0x83</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">AMW0_set_u32</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmab_args</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">args</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">ACER_AMW0_WRITE</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">value</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACER_CAP_MAILLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">ebx</span> <span class="o">|=</span> <span class="n">ACER_AMW0_MAILLED_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_WIRELESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">ebx</span> <span class="o">|=</span> <span class="n">ACER_AMW0_WIRELESS_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BLUETOOTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="n">args</span><span class="p">.</span><span class="n">ebx</span> <span class="o">|=</span> <span class="n">ACER_AMW0_BLUETOOTH_MASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BRIGHTNESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">max_brightness</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">ec_write</span><span class="p">(</span><span class="mh">0x83</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Actually do the set */</span>
	<span class="k">return</span> <span class="n">wmab_execute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">AMW0_find_mailled</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmab_args</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmab_ret</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">out</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

	<span class="n">args</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="mh">0x86</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmab_execute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span> <span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_BUFFER</span> <span class="o">&amp;&amp;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmab_ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">wmab_ret</span> <span class="o">*</span><span class="p">)</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">eex</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">AMW0_set_cap_acpi_check_device_found</span><span class="p">;</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">AMW0_set_cap_acpi_check_device_cb</span><span class="p">(</span><span class="n">acpi_handle</span> <span class="n">handle</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">retval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">AMW0_set_cap_acpi_check_device_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="n">norfkill_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;VPC2004&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;IBM0068&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;LEN0068&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;SNY5001&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* sony-laptop in charge */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">AMW0_set_cap_acpi_check_device</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">acpi_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="n">norfkill_ids</span><span class="p">;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span>
		<span class="n">acpi_get_devices</span><span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">AMW0_set_cap_acpi_check_device_cb</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">AMW0_set_cap_acpi_check_device_found</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">AMW0_set_capabilities</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmab_args</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmab_ret</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">out</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On laptops with this strange GUID (non Acer), normal probing doesn&#39;t</span>
<span class="cm">	 * work.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">AMW0_GUID2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">quirks</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">quirk_unknown</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">AMW0_set_cap_acpi_check_device</span><span class="p">())</span>
			<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_WIRELESS</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">args</span><span class="p">.</span><span class="n">eax</span> <span class="o">=</span> <span class="n">ACER_AMW0_WRITE</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">ecx</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">edx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">args</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mh">0xa2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">ebx</span> <span class="o">|=</span> <span class="n">ACER_AMW0_WIRELESS_MASK</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmab_execute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_BUFFER</span> <span class="o">&amp;&amp;</span>
	<span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmab_ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">wmab_ret</span> <span class="o">*</span><span class="p">)</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">AE_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_WIRELESS</span><span class="p">;</span>

	<span class="n">args</span><span class="p">.</span><span class="n">ebx</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">args</span><span class="p">.</span><span class="n">ebx</span> <span class="o">|=</span> <span class="n">ACER_AMW0_BLUETOOTH_MASK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * It&#39;s ok to use existing buffer for next wmab_execute call.</span>
<span class="cm">	 * But we need to kfree(out.pointer) if next wmab_execute fail.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">wmab_execute</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span> <span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_BUFFER</span>
	<span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmab_ret</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">wmab_ret</span> <span class="o">*</span><span class="p">)</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">AE_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">eax</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_BLUETOOTH</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This appears to be safe to enable, since all Wistron based laptops</span>
<span class="cm">	 * appear to use the same EC register for brightness, even if they</span>
<span class="cm">	 * differ for wireless, etc</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wmi_interface</span> <span class="n">AMW0_interface</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACER_AMW0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wmi_interface</span> <span class="n">AMW0_V2_interface</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACER_AMW0_V2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * New interface (The WMID interface)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">acpi_status</span>
<span class="nf">WMI_execute_u32</span><span class="p">(</span><span class="n">u32</span> <span class="n">method_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">in</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">input</span> <span class="o">=</span> <span class="p">{</span> <span class="p">(</span><span class="n">acpi_size</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">in</span><span class="p">)</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">result</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_evaluate_method</span><span class="p">(</span><span class="n">WMID_GUID1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">method_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span> <span class="n">result</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_BUFFER</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span>
		<span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">WMID_get_u32</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">,</span> <span class="n">method_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACER_CAP_WIRELESS</span>:
		<span class="n">method_id</span> <span class="o">=</span> <span class="n">ACER_WMID_GET_WIRELESS_METHODID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BLUETOOTH</span>:
		<span class="n">method_id</span> <span class="o">=</span> <span class="n">ACER_WMID_GET_BLUETOOTH_METHODID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BRIGHTNESS</span>:
		<span class="n">method_id</span> <span class="o">=</span> <span class="n">ACER_WMID_GET_BRIGHTNESS_METHODID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_THREEG</span>:
		<span class="n">method_id</span> <span class="o">=</span> <span class="n">ACER_WMID_GET_THREEG_METHODID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_MAILLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">mailled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ec_read</span><span class="p">(</span><span class="mh">0x9f</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">WMI_execute_u32</span><span class="p">(</span><span class="n">method_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">result</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">WMID_set_u32</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">method_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">param</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BRIGHTNESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">max_brightness</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="n">method_id</span> <span class="o">=</span> <span class="n">ACER_WMID_SET_BRIGHTNESS_METHODID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_WIRELESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="n">method_id</span> <span class="o">=</span> <span class="n">ACER_WMID_SET_WIRELESS_METHODID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BLUETOOTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="n">method_id</span> <span class="o">=</span> <span class="n">ACER_WMID_SET_BLUETOOTH_METHODID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_THREEG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="n">method_id</span> <span class="o">=</span> <span class="n">ACER_WMID_SET_THREEG_METHODID</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_MAILLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">mailled</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param</span> <span class="o">=</span> <span class="n">value</span> <span class="o">?</span> <span class="mh">0x92</span> <span class="o">:</span> <span class="mh">0x93</span><span class="p">;</span>
			<span class="n">i8042_lock_chip</span><span class="p">();</span>
			<span class="n">i8042_command</span><span class="p">(</span><span class="o">&amp;</span><span class="n">param</span><span class="p">,</span> <span class="mh">0x1059</span><span class="p">);</span>
			<span class="n">i8042_unlock_chip</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">WMI_execute_u32</span><span class="p">(</span><span class="n">method_id</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">value</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">wmid3_get_device_status</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmid3_gds_return_value</span> <span class="n">return_value</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmid3_gds_get_input_param</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">function_num</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hotkey_number</span> <span class="o">=</span> <span class="n">commun_fn_key_number</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">device</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">input</span> <span class="o">=</span> <span class="p">{</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmid3_gds_get_input_param</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">params</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">output</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_evaluate_method</span><span class="p">(</span><span class="n">WMID_GUID3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unknown buffer length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">return_value</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">wmid3_gds_return_value</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span> <span class="o">||</span> <span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">)</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Get 0x%x Device Status failed: 0x%x - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">device</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">return_value</span><span class="p">.</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="n">device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">wmid_v2_get_u32</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">device</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACER_CAP_WIRELESS</span>:
		<span class="n">device</span> <span class="o">=</span> <span class="n">ACER_WMID3_GDS_WIRELESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BLUETOOTH</span>:
		<span class="n">device</span> <span class="o">=</span> <span class="n">ACER_WMID3_GDS_BLUETOOTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_THREEG</span>:
		<span class="n">device</span> <span class="o">=</span> <span class="n">ACER_WMID3_GDS_THREEG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">wmid3_get_device_status</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">wmid3_set_device_status</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u16</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wmid3_gds_return_value</span> <span class="n">return_value</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">devices</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wmid3_gds_get_input_param</span> <span class="n">get_params</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">function_num</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hotkey_number</span> <span class="o">=</span> <span class="n">commun_fn_key_number</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">commun_func_bitmap</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">get_input</span> <span class="o">=</span> <span class="p">{</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmid3_gds_get_input_param</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">get_params</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">wmid3_gds_set_input_param</span> <span class="n">set_params</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">function_num</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hotkey_number</span> <span class="o">=</span> <span class="n">commun_fn_key_number</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">commun_func_bitmap</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">set_input</span> <span class="o">=</span> <span class="p">{</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wmid3_gds_set_input_param</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">set_params</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">output</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">output2</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_evaluate_method</span><span class="p">(</span><span class="n">WMID_GUID3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">get_input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unknown buffer length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">return_value</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">wmid3_gds_return_value</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span> <span class="o">||</span> <span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Get Current Device Status failed: 0x%x - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">devices</span> <span class="o">=</span> <span class="n">return_value</span><span class="p">.</span><span class="n">devices</span><span class="p">;</span>
	<span class="n">set_params</span><span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">devices</span> <span class="o">|</span> <span class="n">device</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">device</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_evaluate_method</span><span class="p">(</span><span class="n">WMID_GUID3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set_input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">output2</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unknown buffer length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">return_value</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">wmid3_gds_return_value</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span> <span class="o">||</span> <span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">)</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Set Device Status failed: 0x%x - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">wmid_v2_set_u32</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">device</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACER_CAP_WIRELESS</span>:
		<span class="n">device</span> <span class="o">=</span> <span class="n">ACER_WMID3_GDS_WIRELESS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_BLUETOOTH</span>:
		<span class="n">device</span> <span class="o">=</span> <span class="n">ACER_WMID3_GDS_BLUETOOTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_CAP_THREEG</span>:
		<span class="n">device</span> <span class="o">=</span> <span class="n">ACER_WMID3_GDS_THREEG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">wmid3_set_device_status</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">type_aa_dmi_decode</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_header</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hotkey_function_type_aa</span> <span class="o">*</span><span class="n">type_aa</span><span class="p">;</span>

	<span class="cm">/* We are looking for OEM-specific Type AAh */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="mh">0xAA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">has_type_aa</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">type_aa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hotkey_function_type_aa</span> <span class="o">*</span><span class="p">)</span> <span class="n">header</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Function bitmap for Communication Button: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">type_aa</span><span class="o">-&gt;</span><span class="n">commun_func_bitmap</span><span class="p">);</span>
	<span class="n">commun_func_bitmap</span> <span class="o">=</span> <span class="n">type_aa</span><span class="o">-&gt;</span><span class="n">commun_func_bitmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type_aa</span><span class="o">-&gt;</span><span class="n">commun_func_bitmap</span> <span class="o">&amp;</span> <span class="n">ACER_WMID3_GDS_WIRELESS</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_WIRELESS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type_aa</span><span class="o">-&gt;</span><span class="n">commun_func_bitmap</span> <span class="o">&amp;</span> <span class="n">ACER_WMID3_GDS_THREEG</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_THREEG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type_aa</span><span class="o">-&gt;</span><span class="n">commun_func_bitmap</span> <span class="o">&amp;</span> <span class="n">ACER_WMID3_GDS_BLUETOOTH</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_BLUETOOTH</span><span class="p">;</span>

	<span class="n">commun_fn_key_number</span> <span class="o">=</span> <span class="n">type_aa</span><span class="o">-&gt;</span><span class="n">commun_fn_key_number</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">WMID_set_capabilities</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devices</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_query_block</span><span class="p">(</span><span class="n">WMID_GUID2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span> <span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_BUFFER</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">devices</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devices</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Function bitmap for Communication Device: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_WIRELESS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_THREEG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_BLUETOOTH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">devices</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span>
		<span class="n">max_brightness</span> <span class="o">=</span> <span class="mh">0x9</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wmi_interface</span> <span class="n">wmid_interface</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACER_WMID</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wmi_interface</span> <span class="n">wmid_v2_interface</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ACER_WMID_v2</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Generic Device (interface-independent)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">get_u32</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">AE_ERROR</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACER_AMW0</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">AMW0_get_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_AMW0_V2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">==</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">AMW0_get_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">ACER_WMID</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">WMID_get_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACER_WMID_v2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACER_CAP_WIRELESS</span> <span class="o">|</span>
			   <span class="n">ACER_CAP_BLUETOOTH</span> <span class="o">|</span>
			   <span class="n">ACER_CAP_THREEG</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">wmid_v2_get_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID2</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">WMID_get_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span> <span class="nf">set_u32</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACER_AMW0</span>:
			<span class="k">return</span> <span class="n">AMW0_set_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">ACER_AMW0_V2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">==</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">AMW0_set_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * On some models, some WMID methods don&#39;t toggle</span>
<span class="cm">			 * properly. For those cases, we want to run the AMW0</span>
<span class="cm">			 * method afterwards to be certain we&#39;ve really toggled</span>
<span class="cm">			 * the device state.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">==</span> <span class="n">ACER_CAP_WIRELESS</span> <span class="o">||</span>
				<span class="n">cap</span> <span class="o">==</span> <span class="n">ACER_CAP_BLUETOOTH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">WMID_set_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
					<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

				<span class="k">return</span> <span class="n">AMW0_set_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">ACER_WMID</span>:
			<span class="k">return</span> <span class="n">WMID_set_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">ACER_WMID_v2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ACER_CAP_WIRELESS</span> <span class="o">|</span>
				   <span class="n">ACER_CAP_BLUETOOTH</span> <span class="o">|</span>
				   <span class="n">ACER_CAP_THREEG</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">wmid_v2_set_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID2</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">WMID_set_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">AE_BAD_PARAMETER</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">acer_commandline_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * These will all fail silently if the value given is invalid, or the</span>
<span class="cm">	 * capability isn&#39;t available on the given interface</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mailled</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_u32</span><span class="p">(</span><span class="n">mailled</span><span class="p">,</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_type_aa</span> <span class="o">&amp;&amp;</span> <span class="n">threeg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_u32</span><span class="p">(</span><span class="n">threeg</span><span class="p">,</span> <span class="n">ACER_CAP_THREEG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brightness</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_u32</span><span class="p">(</span><span class="n">brightness</span><span class="p">,</span> <span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LED device (Mail LED only, no other LEDs known yet)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mail_led_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_u32</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">mail_led</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;acer-wmi::mail&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">mail_led_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">acer_led_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mail_led</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acer_led_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_u32</span><span class="p">(</span><span class="n">LED_OFF</span><span class="p">,</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">);</span>
	<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mail_led</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Backlight device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">acer_backlight_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">get_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_bl_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">intensity</span> <span class="o">=</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">!=</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span>
		<span class="n">intensity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">fb_blank</span> <span class="o">!=</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span>
		<span class="n">intensity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_u32</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">acer_bl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">read_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_status</span> <span class="o">=</span> <span class="n">update_bl_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">acer_backlight_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_properties</span><span class="p">));</span>
	<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_PLATFORM</span><span class="p">;</span>
	<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">max_brightness</span><span class="p">;</span>
	<span class="n">bd</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="s">&quot;acer-wmi&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acer_bl_ops</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not register Acer backlight device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">acer_backlight_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">acer_backlight_device</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>

	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">;</span>
	<span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">read_brightness</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="n">backlight_update_status</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acer_backlight_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">acer_backlight_device</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Rfkill devices</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">acer_rfkill_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">acer_rfkill_work</span><span class="p">,</span> <span class="n">acer_rfkill_update</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">acer_rfkill_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_WIRELESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">get_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">ACER_CAP_WIRELESS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">wireless</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">rfkill_set_hw_state</span><span class="p">(</span><span class="n">wireless_rfkill</span><span class="p">,</span> <span class="o">!</span><span class="n">state</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">wireless_rfkill</span><span class="p">,</span> <span class="o">!</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BLUETOOTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">get_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">ACER_CAP_BLUETOOTH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">,</span> <span class="o">!</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_THREEG</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">get_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">ACER_WMID3_GDS_THREEG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">threeg_rfkill</span><span class="p">,</span> <span class="o">!</span><span class="n">state</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acer_rfkill_work</span><span class="p">,</span> <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acer_rfkill_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cap</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfkill_inited</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">set_u32</span><span class="p">(</span><span class="o">!</span><span class="n">blocked</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">acer_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">acer_rfkill_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="nf">acer_rfkill_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">enum</span> <span class="n">rfkill_type</span> <span class="n">type</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfkill_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">rfkill_dev</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">acer_rfkill_ops</span><span class="p">,</span>
				  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfkill_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">get_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="n">cap</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">rfkill_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfkill_dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">rfkill_dev</span><span class="p">,</span> <span class="o">!</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rfkill_dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acer_rfkill_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_WIRELESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wireless_rfkill</span> <span class="o">=</span> <span class="n">acer_rfkill_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFKILL_TYPE_WLAN</span><span class="p">,</span>
			<span class="s">&quot;acer-wireless&quot;</span><span class="p">,</span> <span class="n">ACER_CAP_WIRELESS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">wireless_rfkill</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">wireless_rfkill</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_wireless</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BLUETOOTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bluetooth_rfkill</span> <span class="o">=</span> <span class="n">acer_rfkill_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">,</span> <span class="s">&quot;acer-bluetooth&quot;</span><span class="p">,</span>
			<span class="n">ACER_CAP_BLUETOOTH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_bluetooth</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_THREEG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">threeg_rfkill</span> <span class="o">=</span> <span class="n">acer_rfkill_register</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			<span class="n">RFKILL_TYPE_WWAN</span><span class="p">,</span> <span class="s">&quot;acer-threeg&quot;</span><span class="p">,</span>
			<span class="n">ACER_CAP_THREEG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">threeg_rfkill</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">threeg_rfkill</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error_threeg</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rfkill_inited</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ec_raw_mode</span> <span class="o">||</span> <span class="o">!</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">ACERWMID_EVENT_GUID</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_WIRELESS</span> <span class="o">|</span> <span class="n">ACER_CAP_BLUETOOTH</span> <span class="o">|</span> <span class="n">ACER_CAP_THREEG</span><span class="p">))</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acer_rfkill_work</span><span class="p">,</span>
			<span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_threeg:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BLUETOOTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">error_bluetooth:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_WIRELESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">wireless_rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">wireless_rfkill</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">error_wireless:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acer_rfkill_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ec_raw_mode</span> <span class="o">||</span> <span class="o">!</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">ACERWMID_EVENT_GUID</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_WIRELESS</span> <span class="o">|</span> <span class="n">ACER_CAP_BLUETOOTH</span> <span class="o">|</span> <span class="n">ACER_CAP_THREEG</span><span class="p">))</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acer_rfkill_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_WIRELESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">wireless_rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">wireless_rfkill</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BLUETOOTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_THREEG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">threeg_rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">threeg_rfkill</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sysfs interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bool_threeg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span> \
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;This threeg sysfs will be removed in 2012 - used by: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">get_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">result</span><span class="p">,</span> <span class="n">ACER_CAP_THREEG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_bool_threeg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">acpi_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">set_u32</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">ACER_CAP_THREEG</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;This threeg sysfs will be removed in 2012 - used by: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">threeg</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_bool_threeg</span><span class="p">,</span>
	<span class="n">set_bool_threeg</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;This interface sysfs will be removed in 2012 - used by: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACER_AMW0</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;AMW0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ACER_AMW0_V2</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;AMW0 v2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ACER_WMID</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;WMID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ACER_WMID_v2</span>:
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;WMID v2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acer_wmi_notify</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">response</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_return_value</span> <span class="n">return_value</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">device_state</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">key_entry</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_get_event_data</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bad event status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unknown response received %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unknown buffer length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">return_value</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">event_return_value</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">return_value</span><span class="p">.</span><span class="n">function</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WMID_HOTKEY_EVENT</span>:
		<span class="n">device_state</span> <span class="o">=</span> <span class="n">return_value</span><span class="p">.</span><span class="n">device_state</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;device state: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">device_state</span><span class="p">);</span>

		<span class="n">key</span> <span class="o">=</span> <span class="n">sparse_keymap_entry_from_scancode</span><span class="p">(</span><span class="n">acer_wmi_input_dev</span><span class="p">,</span>
							<span class="n">return_value</span><span class="p">.</span><span class="n">key_num</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unknown key number - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">return_value</span><span class="p">.</span><span class="n">key_num</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">KEY_WLAN</span>:
			<span class="k">case</span> <span class="n">KEY_BLUETOOTH</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_WIRELESS</span><span class="p">))</span>
					<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">wireless_rfkill</span><span class="p">,</span>
						<span class="o">!</span><span class="p">(</span><span class="n">device_state</span> <span class="o">&amp;</span> <span class="n">ACER_WMID3_GDS_WIRELESS</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_THREEG</span><span class="p">))</span>
					<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">threeg_rfkill</span><span class="p">,</span>
						<span class="o">!</span><span class="p">(</span><span class="n">device_state</span> <span class="o">&amp;</span> <span class="n">ACER_WMID3_GDS_THREEG</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BLUETOOTH</span><span class="p">))</span>
					<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">,</span>
						<span class="o">!</span><span class="p">(</span><span class="n">device_state</span> <span class="o">&amp;</span> <span class="n">ACER_WMID3_GDS_BLUETOOTH</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sparse_keymap_report_entry</span><span class="p">(</span><span class="n">acer_wmi_input_dev</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
						   <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unknown function number - %d - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">function</span><span class="p">,</span> <span class="n">return_value</span><span class="p">.</span><span class="n">key_num</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">acpi_status</span>
<span class="nf">wmid3_set_lm_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm_input_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">lm_return_value</span> <span class="o">*</span><span class="n">return_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">input</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lm_input_params</span><span class="p">),</span> <span class="n">params</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">output</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_evaluate_method</span><span class="p">(</span><span class="n">WMID_GUID3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Unknown buffer length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">AE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">return_value</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="k">struct</span> <span class="n">lm_return_value</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acer_wmi_enable_ec_raw</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm_return_value</span> <span class="n">return_value</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm_input_params</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">function_num</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">commun_devices</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lm_status</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>            <span class="cm">/* Launch Manager Deactive */</span>
	<span class="p">};</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmid3_set_lm_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">return_value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span> <span class="o">||</span> <span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">)</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Enabling EC raw mode failed: 0x%x - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Enabled EC raw mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acer_wmi_enable_lm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lm_return_value</span> <span class="n">return_value</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lm_input_params</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">function_num</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">commun_devices</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">lm_status</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>            <span class="cm">/* Launch Manager Active */</span>
	<span class="p">};</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmid3_set_lm_mode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">return_value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span> <span class="o">||</span> <span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">)</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Enabling Launch Manager failed: 0x%x - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">error_code</span><span class="p">,</span>
			<span class="n">return_value</span><span class="p">.</span><span class="n">ec_return_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acer_wmi_input_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">acer_wmi_input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acer_wmi_input_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">acer_wmi_input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Acer WMI hotkeys&quot;</span><span class="p">;</span>
	<span class="n">acer_wmi_input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="s">&quot;wmi/input0&quot;</span><span class="p">;</span>
	<span class="n">acer_wmi_input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sparse_keymap_setup</span><span class="p">(</span><span class="n">acer_wmi_input_dev</span><span class="p">,</span> <span class="n">acer_wmi_keymap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_install_notify_handler</span><span class="p">(</span><span class="n">ACERWMID_EVENT_GUID</span><span class="p">,</span>
						<span class="n">acer_wmi_notify</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_keymap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">acer_wmi_input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_uninstall_notifier</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_uninstall_notifier:</span>
	<span class="n">wmi_remove_notify_handler</span><span class="p">(</span><span class="n">ACERWMID_EVENT_GUID</span><span class="p">);</span>
<span class="nl">err_free_keymap:</span>
	<span class="n">sparse_keymap_free</span><span class="p">(</span><span class="n">acer_wmi_input_dev</span><span class="p">);</span>
<span class="nl">err_free_dev:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">acer_wmi_input_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acer_wmi_input_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wmi_remove_notify_handler</span><span class="p">(</span><span class="n">ACERWMID_EVENT_GUID</span><span class="p">);</span>
	<span class="n">sparse_keymap_free</span><span class="p">(</span><span class="n">acer_wmi_input_dev</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">acer_wmi_input_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * debugfs functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_wmid_devices</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devices</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_query_block</span><span class="p">(</span><span class="n">WMID_GUID2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span> <span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_BUFFER</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">||</span>
		<span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">devices</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACPI_TYPE_INTEGER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">devices</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">pointer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">devices</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Platform device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">acer_platform_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_MAILLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">acer_led_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_mailled</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">acer_backlight_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_brightness</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">acer_rfkill_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_rfkill</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">error_rfkill:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">))</span>
		<span class="n">acer_backlight_exit</span><span class="p">();</span>
<span class="nl">error_brightness:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_MAILLED</span><span class="p">))</span>
		<span class="n">acer_led_exit</span><span class="p">();</span>
<span class="nl">error_mailled:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acer_platform_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_MAILLED</span><span class="p">))</span>
		<span class="n">acer_led_exit</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">))</span>
		<span class="n">acer_backlight_exit</span><span class="p">();</span>

	<span class="n">acer_rfkill_exit</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acer_platform_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
<span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">acer_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_MAILLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">get_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">);</span>
		<span class="n">set_u32</span><span class="p">(</span><span class="n">LED_OFF</span><span class="p">,</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">mailled</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">get_u32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">acer_platform_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acer_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_MAILLED</span><span class="p">))</span>
		<span class="n">set_u32</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">mailled</span><span class="p">,</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">))</span>
		<span class="n">set_u32</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">brightness</span><span class="p">,</span> <span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">acer_platform_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acer_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_MAILLED</span><span class="p">))</span>
		<span class="n">set_u32</span><span class="p">(</span><span class="n">LED_OFF</span><span class="p">,</span> <span class="n">ACER_CAP_MAILLED</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">acer_platform_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;acer-wmi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">acer_platform_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">acer_platform_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">acer_platform_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">acer_platform_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">acer_platform_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">acer_platform_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_THREEG</span><span class="p">))</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_threeg</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_interface</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_sysfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_cap</span><span class="p">(</span><span class="n">ACER_CAP_THREEG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acer_platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">dev_attr_threeg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_sysfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acer_platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">dev_attr_interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_sysfs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_sysfs:</span>
		<span class="n">remove_sysfs</span><span class="p">(</span><span class="n">acer_platform_device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">remove_debugfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">devices</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">create_debugfs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;acer-wmi&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to create debugfs directory&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">interface</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">devices</span> <span class="o">=</span> <span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;devices&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
					<span class="n">interface</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">wmid_devices</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">devices</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_debugfs:</span>
	<span class="n">remove_debugfs</span><span class="p">();</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">acer_wmi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Acer Laptop ACPI-WMI Extras</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">acer_blacklist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Blacklisted hardware detected - not loading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">find_quirks</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * Detect which ACPI-WMI interface we&#39;re using.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">AMW0_GUID1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID1</span><span class="p">))</span>
		<span class="n">interface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">AMW0_V2_interface</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">AMW0_GUID1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID1</span><span class="p">))</span>
		<span class="n">interface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wmid_interface</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID3</span><span class="p">))</span>
		<span class="n">interface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wmid_v2_interface</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interface</span><span class="p">)</span>
		<span class="n">dmi_walk</span><span class="p">(</span><span class="n">type_aa_dmi_decode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_type_aa</span> <span class="o">&amp;&amp;</span> <span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">WMID_set_capabilities</span><span class="p">()))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to detect available WMID devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* WMID always provides brightness methods */</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">interface</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">has_type_aa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No WMID device detection method found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">AMW0_GUID1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">interface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">AMW0_interface</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">AMW0_set_capabilities</span><span class="p">()))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to detect available AMW0 devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">AMW0_GUID1</span><span class="p">))</span>
		<span class="n">AMW0_find_mailled</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No or unsupported WMI interface, unable to load</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_quirks</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_video_backlight_support</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">video_vendor_dmi_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">acpi_video_unregister</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">interface</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ACER_CAP_BRIGHTNESS</span><span class="p">;</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Brightness must be controlled by &quot;</span>
				<span class="s">&quot;acpi video driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID3</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ec_raw_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">acer_wmi_enable_ec_raw</span><span class="p">()))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot enable EC raw mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">acer_wmi_enable_lm</span><span class="p">()))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot enable Launch Manager mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ec_raw_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;No WMID EC raw mode enable method</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">ACERWMID_EVENT_GUID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">acer_wmi_input_setup</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acer_platform_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to register platform driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_platform_register</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acer_platform_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;acer-wmi&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acer_platform_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_device_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">acer_platform_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_device_add</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">create_sysfs</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_create_sys</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">WMID_GUID2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">interface</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">wmid_devices</span> <span class="o">=</span> <span class="n">get_wmid_devices</span><span class="p">();</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">create_debugfs</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error_create_debugfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Override any initial settings with values from the commandline */</span>
	<span class="n">acer_commandline_init</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_create_debugfs:</span>
	<span class="n">remove_sysfs</span><span class="p">(</span><span class="n">acer_platform_device</span><span class="p">);</span>
<span class="nl">error_create_sys:</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">acer_platform_device</span><span class="p">);</span>
<span class="nl">error_device_add:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">acer_platform_device</span><span class="p">);</span>
<span class="nl">error_device_alloc:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acer_platform_driver</span><span class="p">);</span>
<span class="nl">error_platform_register:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">ACERWMID_EVENT_GUID</span><span class="p">))</span>
		<span class="n">acer_wmi_input_destroy</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">acer_wmi_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">ACERWMID_EVENT_GUID</span><span class="p">))</span>
		<span class="n">acer_wmi_input_destroy</span><span class="p">();</span>

	<span class="n">remove_sysfs</span><span class="p">(</span><span class="n">acer_platform_device</span><span class="p">);</span>
	<span class="n">remove_debugfs</span><span class="p">();</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">acer_platform_device</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acer_platform_driver</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Acer Laptop WMI Extras unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">acer_wmi_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">acer_wmi_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
