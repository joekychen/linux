<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › platform › x86 › hp-wmi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>hp-wmi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * HP WMI hotkeys</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Red Hat &lt;mjg@redhat.com&gt;</span>
<span class="cm"> * Copyright (C) 2010, 2011 Anssi Hannula &lt;anssi.hannula@iki.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Portions based on wistron_btns.c:</span>
<span class="cm"> * Copyright (C) 2005 Miloslav Trmac &lt;mitr@volny.cz&gt;</span>
<span class="cm"> * Copyright (C) 2005 Bernhard Rosenkraenzer &lt;bero@arklinux.org&gt;</span>
<span class="cm"> * Copyright (C) 2005 Dmitry Torokhov &lt;dtor@mail.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/input/sparse-keymap.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/rfkill.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Matthew Garrett &lt;mjg59@srcf.ucam.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;HP laptop WMI hotkeys driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;wmi:95F24279-4D7B-4334-9387-ACCDC67EF61C&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;wmi:5FB7F034-2C63-45e9-BE91-3D44E2C707E4&quot;</span><span class="p">);</span>

<span class="cp">#define HPWMI_EVENT_GUID &quot;95F24279-4D7B-4334-9387-ACCDC67EF61C&quot;</span>
<span class="cp">#define HPWMI_BIOS_GUID &quot;5FB7F034-2C63-45e9-BE91-3D44E2C707E4&quot;</span>

<span class="cp">#define HPWMI_DISPLAY_QUERY 0x1</span>
<span class="cp">#define HPWMI_HDDTEMP_QUERY 0x2</span>
<span class="cp">#define HPWMI_ALS_QUERY 0x3</span>
<span class="cp">#define HPWMI_HARDWARE_QUERY 0x4</span>
<span class="cp">#define HPWMI_WIRELESS_QUERY 0x5</span>
<span class="cp">#define HPWMI_HOTKEY_QUERY 0xc</span>
<span class="cp">#define HPWMI_WIRELESS2_QUERY 0x1b</span>

<span class="k">enum</span> <span class="n">hp_wmi_radio</span> <span class="p">{</span>
	<span class="n">HPWMI_WIFI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">HPWMI_BLUETOOTH</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">HPWMI_WWAN</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">hp_wmi_event_ids</span> <span class="p">{</span>
	<span class="n">HPWMI_DOCK_EVENT</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">HPWMI_PARK_HDD</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="n">HPWMI_SMART_ADAPTER</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">HPWMI_BEZEL_BUTTON</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="n">HPWMI_WIRELESS</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">HPWMI_CPU_BATTERY_THROTTLE</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	<span class="n">HPWMI_LOCK_SWITCH</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">hp_wmi_bios_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="n">hp_wmi_bios_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hp_wmi_resume_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">bios_args</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">signature</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">commandtype</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">datasize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bios_return</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">sigpass</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">return_code</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">hp_return_value</span> <span class="p">{</span>
	<span class="n">HPWMI_RET_WRONG_SIGNATURE</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">HPWMI_RET_UNKNOWN_COMMAND</span>	<span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">HPWMI_RET_UNKNOWN_CMDTYPE</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">HPWMI_RET_INVALID_PARAMETERS</span>	<span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">hp_wireless2_bits</span> <span class="p">{</span>
	<span class="n">HPWMI_POWER_STATE</span>	<span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">HPWMI_POWER_SOFT</span>	<span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">HPWMI_POWER_BIOS</span>	<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
	<span class="n">HPWMI_POWER_HARD</span>	<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define IS_HWBLOCKED(x) ((x &amp; (HPWMI_POWER_BIOS | HPWMI_POWER_HARD)) \</span>
<span class="cp">			 != (HPWMI_POWER_BIOS | HPWMI_POWER_HARD))</span>
<span class="cp">#define IS_SWBLOCKED(x) !(x &amp; HPWMI_POWER_SOFT)</span>

<span class="k">struct</span> <span class="n">bios_rfkill2_device_state</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">radio_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bus_type</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">product_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subsys_vendor_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">subsys_product_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rfkill_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">power</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">unknown</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* 7 devices fit into the 128 byte buffer */</span>
<span class="cp">#define HPWMI_MAX_RFKILL2_DEVICES	7</span>

<span class="k">struct</span> <span class="n">bios_rfkill2_state</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">unknown</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pad</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">bios_rfkill2_device_state</span> <span class="n">device</span><span class="p">[</span><span class="n">HPWMI_MAX_RFKILL2_DEVICES</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">key_entry</span> <span class="n">hp_wmi_keymap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>   <span class="p">{</span> <span class="n">KEY_BRIGHTNESSUP</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>   <span class="p">{</span> <span class="n">KEY_BRIGHTNESSDOWN</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x20e6</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_PROG1</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x20e8</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_MEDIA</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x2142</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_MEDIA</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x213b</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_INFO</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x2169</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_DIRECTION</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">KE_KEY</span><span class="p">,</span> <span class="mh">0x231b</span><span class="p">,</span> <span class="p">{</span> <span class="n">KEY_HELP</span> <span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">KE_END</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">hp_wmi_input_dev</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">hp_wmi_platform_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">wifi_rfkill</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">bluetooth_rfkill</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">wwan_rfkill</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">rfkill2_device</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfkill</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rfkill2_count</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill2_device</span> <span class="n">rfkill2</span><span class="p">[</span><span class="n">HPWMI_MAX_RFKILL2_DEVICES</span><span class="p">];</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">hp_wmi_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">resume</span>  <span class="o">=</span> <span class="n">hp_wmi_resume_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span>  <span class="o">=</span> <span class="n">hp_wmi_resume_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">hp_wmi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hp-wmi&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hp_wmi_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">hp_wmi_bios_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">hp_wmi_bios_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * hp_wmi_perform_query</span>
<span class="cm"> *</span>
<span class="cm"> * query:	The commandtype -&gt; What should be queried</span>
<span class="cm"> * write:	The command -&gt; 0 read, 1 write, 3 ODM specific</span>
<span class="cm"> * buffer:	Buffer used as input and/or output</span>
<span class="cm"> * insize:	Size of input buffer</span>
<span class="cm"> * outsize:	Size of output buffer</span>
<span class="cm"> *</span>
<span class="cm"> * returns zero on success</span>
<span class="cm"> *         an HP WMI query specific error code (which is positive)</span>
<span class="cm"> *         -EINVAL if the query was not successful at all</span>
<span class="cm"> *         -EINVAL if the output buffer size exceeds buffersize</span>
<span class="cm"> *</span>
<span class="cm"> * Note: The buffersize must at least be the maximum of the input and output</span>
<span class="cm"> *       size. E.g. Battery info query (0x7) is defined to have 1 byte input</span>
<span class="cm"> *       and 128 byte output. The caller would do:</span>
<span class="cm"> *       buffer = kzalloc(128, GFP_KERNEL);</span>
<span class="cm"> *       ret = hp_wmi_perform_query(0x7, 0, buffer, 1, 128)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_perform_query</span><span class="p">(</span><span class="kt">int</span> <span class="n">query</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">insize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">outsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bios_return</span> <span class="o">*</span><span class="n">bios_return</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actual_outsize</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bios_args</span> <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">signature</span> <span class="o">=</span> <span class="mh">0x55434553</span><span class="p">,</span>
		<span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">write</span> <span class="o">?</span> <span class="mh">0x2</span> <span class="o">:</span> <span class="mh">0x1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">commandtype</span> <span class="o">=</span> <span class="n">query</span><span class="p">,</span>
		<span class="p">.</span><span class="n">datasize</span> <span class="o">=</span> <span class="n">insize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">input</span> <span class="o">=</span> <span class="p">{</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bios_args</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">args</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">output</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">insize</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">data</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">insize</span><span class="p">);</span>

	<span class="n">wmi_evaluate_method</span><span class="p">(</span><span class="n">HPWMI_BIOS_GUID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">output</span><span class="p">);</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bios_return</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bios_return</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">bios_return</span><span class="o">-&gt;</span><span class="n">return_code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">HPWMI_RET_UNKNOWN_CMDTYPE</span><span class="p">)</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;query 0x%x returned error 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">outsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ignore output data */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">actual_outsize</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">outsize</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bios_return</span><span class="p">)));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bios_return</span><span class="p">),</span> <span class="n">actual_outsize</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">actual_outsize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">outsize</span> <span class="o">-</span> <span class="n">actual_outsize</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_display_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_DISPLAY_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_hddtemp_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_HDDTEMP_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_als_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_ALS_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_dock_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_HARDWARE_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_tablet_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_HARDWARE_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_set_block</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">hp_wmi_radio</span> <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">hp_wmi_radio</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">query</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">!</span><span class="n">blocked</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">r</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_WIRELESS_QUERY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">query</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">query</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">hp_wmi_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">hp_wmi_set_block</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hp_wmi_get_sw_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">hp_wmi_radio</span> <span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wireless</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_WIRELESS_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">wireless</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wireless</span><span class="p">),</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">wireless</span><span class="p">));</span>
	<span class="cm">/* TBD: Pass error */</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x200</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wireless</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">hp_wmi_get_hw_state</span><span class="p">(</span><span class="k">enum</span> <span class="n">hp_wmi_radio</span> <span class="n">r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wireless</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_WIRELESS_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">wireless</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wireless</span><span class="p">),</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">wireless</span><span class="p">));</span>
	<span class="cm">/* TBD: Pass error */</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x800</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wireless</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_rfkill2_set_block</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rfkill_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">rfkill_id</span><span class="p">,</span> <span class="o">!</span><span class="n">blocked</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_WIRELESS2_QUERY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				   <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">hp_wmi_rfkill2_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">hp_wmi_rfkill2_set_block</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_rfkill2_refresh</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bios_rfkill2_state</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_WIRELESS2_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
				   <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rfkill2_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">rfkill2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">bios_rfkill2_device_state</span> <span class="o">*</span><span class="n">devstate</span><span class="p">;</span>
		<span class="n">devstate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;=</span> <span class="n">state</span><span class="p">.</span><span class="n">count</span> <span class="o">||</span>
		    <span class="n">devstate</span><span class="o">-&gt;</span><span class="n">rfkill_id</span> <span class="o">!=</span> <span class="n">rfkill2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;power configuration of the wireless devices unexpectedly changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rfkill_set_states</span><span class="p">(</span><span class="n">rfkill2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rfkill</span><span class="p">,</span>
				  <span class="n">IS_SWBLOCKED</span><span class="p">(</span><span class="n">devstate</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">),</span>
				  <span class="n">IS_HWBLOCKED</span><span class="p">(</span><span class="n">devstate</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">hp_wmi_display_state</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_hddtemp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">hp_wmi_hddtemp_state</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_als</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">hp_wmi_als_state</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_dock</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">hp_wmi_dock_state</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_tablet</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">hp_wmi_tablet_state</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_als</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_ALS_QUERY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_display</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">hddtemp</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_hddtemp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">als</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_als</span><span class="p">,</span> <span class="n">set_als</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dock</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_dock</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">tablet</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_tablet</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp_wmi_notify</span><span class="p">(</span><span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acpi_buffer</span> <span class="n">response</span> <span class="o">=</span> <span class="p">{</span> <span class="n">ACPI_ALLOCATE_BUFFER</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
	<span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">event_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">location</span><span class="p">;</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_get_event_data</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">AE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;bad event status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">acpi_object</span> <span class="o">*</span><span class="p">)</span><span class="n">response</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACPI_TYPE_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown response received %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Depending on ACPI version the concatenation of id and event data</span>
<span class="cm">	 * inside _WED function will result in a 8 or 16 byte buffer.</span>
<span class="cm">	 */</span>
	<span class="n">location</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pointer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">location</span><span class="p">;</span>
		<span class="n">event_data</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">location</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">location</span><span class="p">;</span>
		<span class="n">event_data</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">location</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown buffer length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HPWMI_DOCK_EVENT</span>:
		<span class="n">input_report_switch</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">,</span> <span class="n">SW_DOCK</span><span class="p">,</span>
				    <span class="n">hp_wmi_dock_state</span><span class="p">());</span>
		<span class="n">input_report_switch</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">,</span> <span class="n">SW_TABLET_MODE</span><span class="p">,</span>
				    <span class="n">hp_wmi_tablet_state</span><span class="p">());</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPWMI_PARK_HDD</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPWMI_SMART_ADAPTER</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPWMI_BEZEL_BUTTON</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_HOTKEY_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">key_code</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">key_code</span><span class="p">),</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">key_code</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sparse_keymap_report_event</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">,</span>
						<span class="n">key_code</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown key code - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key_code</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPWMI_WIRELESS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rfkill2_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hp_wmi_rfkill2_refresh</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">)</span>
			<span class="n">rfkill_set_states</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">,</span>
					  <span class="n">hp_wmi_get_sw_state</span><span class="p">(</span><span class="n">HPWMI_WIFI</span><span class="p">),</span>
					  <span class="n">hp_wmi_get_hw_state</span><span class="p">(</span><span class="n">HPWMI_WIFI</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">)</span>
			<span class="n">rfkill_set_states</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">,</span>
					  <span class="n">hp_wmi_get_sw_state</span><span class="p">(</span><span class="n">HPWMI_BLUETOOTH</span><span class="p">),</span>
					  <span class="n">hp_wmi_get_hw_state</span><span class="p">(</span><span class="n">HPWMI_BLUETOOTH</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">)</span>
			<span class="n">rfkill_set_states</span><span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">,</span>
					  <span class="n">hp_wmi_get_sw_state</span><span class="p">(</span><span class="n">HPWMI_WWAN</span><span class="p">),</span>
					  <span class="n">hp_wmi_get_hw_state</span><span class="p">(</span><span class="n">HPWMI_WWAN</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPWMI_CPU_BATTERY_THROTTLE</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unimplemented CPU throttle because of 3 Cell battery event detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HPWMI_LOCK_SWITCH</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Unknown event_id - %d - 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event_id</span><span class="p">,</span> <span class="n">event_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp_wmi_input_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">acpi_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hp_wmi_input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp_wmi_input_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">hp_wmi_input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HP WMI hotkeys&quot;</span><span class="p">;</span>
	<span class="n">hp_wmi_input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="s">&quot;wmi/input0&quot;</span><span class="p">;</span>
	<span class="n">hp_wmi_input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">EV_SW</span><span class="p">,</span> <span class="n">hp_wmi_input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">SW_DOCK</span><span class="p">,</span> <span class="n">hp_wmi_input_dev</span><span class="o">-&gt;</span><span class="n">swbit</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">SW_TABLET_MODE</span><span class="p">,</span> <span class="n">hp_wmi_input_dev</span><span class="o">-&gt;</span><span class="n">swbit</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sparse_keymap_setup</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">,</span> <span class="n">hp_wmi_keymap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>

	<span class="cm">/* Set initial hardware state */</span>
	<span class="n">input_report_switch</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">,</span> <span class="n">SW_DOCK</span><span class="p">,</span> <span class="n">hp_wmi_dock_state</span><span class="p">());</span>
	<span class="n">input_report_switch</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">,</span> <span class="n">SW_TABLET_MODE</span><span class="p">,</span>
			    <span class="n">hp_wmi_tablet_state</span><span class="p">());</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">wmi_install_notify_handler</span><span class="p">(</span><span class="n">HPWMI_EVENT_GUID</span><span class="p">,</span> <span class="n">hp_wmi_notify</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ACPI_FAILURE</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_keymap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_uninstall_notifier</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_uninstall_notifier:</span>
	<span class="n">wmi_remove_notify_handler</span><span class="p">(</span><span class="n">HPWMI_EVENT_GUID</span><span class="p">);</span>
 <span class="nl">err_free_keymap:</span>
	<span class="n">sparse_keymap_free</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">);</span>
 <span class="nl">err_free_dev:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hp_wmi_input_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wmi_remove_notify_handler</span><span class="p">(</span><span class="n">HPWMI_EVENT_GUID</span><span class="p">);</span>
	<span class="n">sparse_keymap_free</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cleanup_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_display</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_hddtemp</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_als</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dock</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_tablet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hp_wmi_rfkill_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wireless</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_WIRELESS_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wireless</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">wireless</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wireless</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wireless</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wifi_rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="s">&quot;hp-wifi&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">RFKILL_TYPE_WLAN</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">hp_wmi_rfkill_ops</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">HPWMI_WIFI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wifi_rfkill</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">rfkill_init_sw_state</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">,</span>
				     <span class="n">hp_wmi_get_sw_state</span><span class="p">(</span><span class="n">HPWMI_WIFI</span><span class="p">));</span>
		<span class="n">rfkill_set_hw_state</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">,</span>
				    <span class="n">hp_wmi_get_hw_state</span><span class="p">(</span><span class="n">HPWMI_WIFI</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">register_wifi_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wireless</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bluetooth_rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="s">&quot;hp-bluetooth&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">hp_wmi_rfkill_ops</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">HPWMI_BLUETOOTH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bluetooth_rfkill</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">register_wifi_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rfkill_init_sw_state</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">,</span>
				     <span class="n">hp_wmi_get_sw_state</span><span class="p">(</span><span class="n">HPWMI_BLUETOOTH</span><span class="p">));</span>
		<span class="n">rfkill_set_hw_state</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">,</span>
				    <span class="n">hp_wmi_get_hw_state</span><span class="p">(</span><span class="n">HPWMI_BLUETOOTH</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">register_bluetooth_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wireless</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wwan_rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="s">&quot;hp-wwan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">RFKILL_TYPE_WWAN</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">hp_wmi_rfkill_ops</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">HPWMI_WWAN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wwan_rfkill</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">register_bluetooth_error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rfkill_init_sw_state</span><span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">,</span>
				     <span class="n">hp_wmi_get_sw_state</span><span class="p">(</span><span class="n">HPWMI_WWAN</span><span class="p">));</span>
		<span class="n">rfkill_set_hw_state</span><span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">,</span>
				    <span class="n">hp_wmi_get_hw_state</span><span class="p">(</span><span class="n">HPWMI_WWAN</span><span class="p">));</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">register_wwan_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">register_wwan_err:</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">);</span>
	<span class="n">wwan_rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">)</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
<span class="nl">register_bluetooth_error:</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
	<span class="n">bluetooth_rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">)</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>
<span class="nl">register_wifi_error:</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>
	<span class="n">wifi_rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hp_wmi_rfkill2_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bios_rfkill2_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hp_wmi_perform_query</span><span class="p">(</span><span class="n">HPWMI_WIRELESS2_QUERY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">,</span>
				   <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">HPWMI_MAX_RFKILL2_DEVICES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;unable to parse 0x1b query output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">state</span><span class="p">.</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfkill</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">rfkill_type</span> <span class="n">type</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">radio_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HPWMI_WIFI</span>:
			<span class="n">type</span> <span class="o">=</span> <span class="n">RFKILL_TYPE_WLAN</span><span class="p">;</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hp-wifi&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HPWMI_BLUETOOTH</span>:
			<span class="n">type</span> <span class="o">=</span> <span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">;</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hp-bluetooth&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">HPWMI_WWAN</span>:
			<span class="n">type</span> <span class="o">=</span> <span class="n">RFKILL_TYPE_WWAN</span><span class="p">;</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hp-wwan&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;unknown device type 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">state</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">radio_type</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vendor_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;zero device %d while %d reported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">hp_wmi_rfkill2_ops</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfkill</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rfkill2</span><span class="p">[</span><span class="n">rfkill2_count</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rfkill_id</span><span class="p">;</span>
		<span class="n">rfkill2</span><span class="p">[</span><span class="n">rfkill2_count</span><span class="p">].</span><span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">rfkill2</span><span class="p">[</span><span class="n">rfkill2_count</span><span class="p">].</span><span class="n">rfkill</span> <span class="o">=</span> <span class="n">rfkill</span><span class="p">;</span>

		<span class="n">rfkill_init_sw_state</span><span class="p">(</span><span class="n">rfkill</span><span class="p">,</span>
				     <span class="n">IS_SWBLOCKED</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">power</span><span class="p">));</span>
		<span class="n">rfkill_set_hw_state</span><span class="p">(</span><span class="n">rfkill</span><span class="p">,</span>
				    <span class="n">IS_HWBLOCKED</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">power</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">device</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">power</span> <span class="o">&amp;</span> <span class="n">HPWMI_POWER_BIOS</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;device %s blocked by BIOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfkill</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rfkill2_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">rfkill2_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rfkill2_count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">rfkill2</span><span class="p">[</span><span class="n">rfkill2_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfkill2</span><span class="p">[</span><span class="n">rfkill2_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">hp_wmi_bios_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* clear detected rfkill devices */</span>
	<span class="n">wifi_rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bluetooth_rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wwan_rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rfkill2_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp_wmi_rfkill_setup</span><span class="p">(</span><span class="n">device</span><span class="p">))</span>
		<span class="n">hp_wmi_rfkill2_setup</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_display</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">add_sysfs_error</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_hddtemp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">add_sysfs_error</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_als</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">add_sysfs_error</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_dock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">add_sysfs_error</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_tablet</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">add_sysfs_error</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">add_sysfs_error:</span>
	<span class="n">cleanup_sysfs</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">hp_wmi_bios_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">cleanup_sysfs</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rfkill2_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">rfkill2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfkill2</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">hp_wmi_resume_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Hardware state may have changed while suspended, so trigger</span>
<span class="cm">	 * input events for the current state. As this is a switch,</span>
<span class="cm">	 * the input layer will only actually pass it on if the state</span>
<span class="cm">	 * changed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_switch</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">,</span> <span class="n">SW_DOCK</span><span class="p">,</span>
				    <span class="n">hp_wmi_dock_state</span><span class="p">());</span>
		<span class="n">input_report_switch</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">,</span> <span class="n">SW_TABLET_MODE</span><span class="p">,</span>
				    <span class="n">hp_wmi_tablet_state</span><span class="p">());</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">hp_wmi_input_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfkill2_count</span><span class="p">)</span>
		<span class="n">hp_wmi_rfkill2_refresh</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">)</span>
		<span class="n">rfkill_set_states</span><span class="p">(</span><span class="n">wifi_rfkill</span><span class="p">,</span>
				  <span class="n">hp_wmi_get_sw_state</span><span class="p">(</span><span class="n">HPWMI_WIFI</span><span class="p">),</span>
				  <span class="n">hp_wmi_get_hw_state</span><span class="p">(</span><span class="n">HPWMI_WIFI</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">)</span>
		<span class="n">rfkill_set_states</span><span class="p">(</span><span class="n">bluetooth_rfkill</span><span class="p">,</span>
				  <span class="n">hp_wmi_get_sw_state</span><span class="p">(</span><span class="n">HPWMI_BLUETOOTH</span><span class="p">),</span>
				  <span class="n">hp_wmi_get_hw_state</span><span class="p">(</span><span class="n">HPWMI_BLUETOOTH</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">)</span>
		<span class="n">rfkill_set_states</span><span class="p">(</span><span class="n">wwan_rfkill</span><span class="p">,</span>
				  <span class="n">hp_wmi_get_sw_state</span><span class="p">(</span><span class="n">HPWMI_WWAN</span><span class="p">),</span>
				  <span class="n">hp_wmi_get_hw_state</span><span class="p">(</span><span class="n">HPWMI_WWAN</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">hp_wmi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">event_capable</span> <span class="o">=</span> <span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">HPWMI_EVENT_GUID</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">bios_capable</span> <span class="o">=</span> <span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">HPWMI_BIOS_GUID</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event_capable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hp_wmi_input_setup</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bios_capable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_wmi_driver</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_driver_reg</span><span class="p">;</span>
		<span class="n">hp_wmi_platform_dev</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;hp-wmi&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hp_wmi_platform_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_device_alloc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">hp_wmi_platform_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_device_add</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bios_capable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">event_capable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_device_add:</span>
	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">hp_wmi_platform_dev</span><span class="p">);</span>
<span class="nl">err_device_alloc:</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_wmi_driver</span><span class="p">);</span>
<span class="nl">err_driver_reg:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">event_capable</span><span class="p">)</span>
		<span class="n">hp_wmi_input_destroy</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">hp_wmi_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wmi_has_guid</span><span class="p">(</span><span class="n">HPWMI_EVENT_GUID</span><span class="p">))</span>
		<span class="n">hp_wmi_input_destroy</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hp_wmi_platform_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">hp_wmi_platform_dev</span><span class="p">);</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hp_wmi_driver</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">hp_wmi_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">hp_wmi_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
