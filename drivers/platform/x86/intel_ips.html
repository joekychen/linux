<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › platform › x86 › intel_ips.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>intel_ips.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2009-2010 Intel Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in</span>
<span class="cm"> * the file called &quot;COPYING&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Authors:</span>
<span class="cm"> *	Jesse Barnes &lt;jbarnes@virtuousgeek.org&gt;</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Some Intel Ibex Peak based platforms support so-called &quot;intelligent</span>
<span class="cm"> * power sharing&quot;, which allows the CPU and GPU to cooperate to maximize</span>
<span class="cm"> * performance within a given TDP (thermal design point).  This driver</span>
<span class="cm"> * performs the coordination between the CPU and GPU, monitors thermal and</span>
<span class="cm"> * power statistics in the platform, and initializes power monitoring</span>
<span class="cm"> * hardware.  It also provides a few tunables to control behavior.  Its</span>
<span class="cm"> * primary purpose is to safely allow CPU and GPU turbo modes to be enabled</span>
<span class="cm"> * by tracking power and thermal budget; secondarily it can boost turbo</span>
<span class="cm"> * performance by allocating more power or thermal budget to the CPU or GPU</span>
<span class="cm"> * based on available headroom and activity.</span>
<span class="cm"> *</span>
<span class="cm"> * The basic algorithm is driven by a 5s moving average of tempurature.  If</span>
<span class="cm"> * thermal headroom is available, the CPU and/or GPU power clamps may be</span>
<span class="cm"> * adjusted upwards.  If we hit the thermal ceiling or a thermal trigger,</span>
<span class="cm"> * we scale back the clamp.  Aside from trigger events (when we&#39;re critically</span>
<span class="cm"> * close or over our TDP) we don&#39;t adjust the clamps more than once every</span>
<span class="cm"> * five seconds.</span>
<span class="cm"> *</span>
<span class="cm"> * The thermal device (device 31, function 6) has a set of registers that</span>
<span class="cm"> * are updated by the ME firmware.  The ME should also take the clamp values</span>
<span class="cm"> * written to those registers and write them to the CPU, but we currently</span>
<span class="cm"> * bypass that functionality and write the CPU MSR directly.</span>
<span class="cm"> *</span>
<span class="cm"> * UNSUPPORTED:</span>
<span class="cm"> *   - dual MCP configs</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *   - handle CPU hotplug</span>
<span class="cm"> *   - provide turbo enable/disable api</span>
<span class="cm"> *</span>
<span class="cm"> * Related documents:</span>
<span class="cm"> *   - CDI 403777, 403778 - Auburndale EDS vol 1 &amp; 2</span>
<span class="cm"> *   - CDI 401376 - Ibex Peak EDS</span>
<span class="cm"> *   - ref 26037, 26641 - IPS BIOS spec</span>
<span class="cm"> *   - ref 26489 - Nehalem BIOS writer&#39;s guide</span>
<span class="cm"> *   - ref 26921 - Ibex Peak BIOS Specification</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/tick.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;drm/i915_drm.h&gt;</span>
<span class="cp">#include &lt;asm/msr.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &quot;intel_ips.h&quot;</span>

<span class="cp">#include &lt;asm-generic/io-64-nonatomic-lo-hi.h&gt;</span>

<span class="cp">#define PCI_DEVICE_ID_INTEL_THERMAL_SENSOR 0x3b32</span>

<span class="cm">/*</span>
<span class="cm"> * Package level MSRs for monitor/control</span>
<span class="cm"> */</span>
<span class="cp">#define PLATFORM_INFO	0xce</span>
<span class="cp">#define   PLATFORM_TDP		(1&lt;&lt;29)</span>
<span class="cp">#define   PLATFORM_RATIO	(1&lt;&lt;28)</span>

<span class="cp">#define IA32_MISC_ENABLE	0x1a0</span>
<span class="cp">#define   IA32_MISC_TURBO_EN	(1ULL&lt;&lt;38)</span>

<span class="cp">#define TURBO_POWER_CURRENT_LIMIT	0x1ac</span>
<span class="cp">#define   TURBO_TDC_OVR_EN	(1UL&lt;&lt;31)</span>
<span class="cp">#define   TURBO_TDC_MASK	(0x000000007fff0000UL)</span>
<span class="cp">#define   TURBO_TDC_SHIFT	(16)</span>
<span class="cp">#define   TURBO_TDP_OVR_EN	(1UL&lt;&lt;15)</span>
<span class="cp">#define   TURBO_TDP_MASK	(0x0000000000003fffUL)</span>

<span class="cm">/*</span>
<span class="cm"> * Core/thread MSRs for monitoring</span>
<span class="cm"> */</span>
<span class="cp">#define IA32_PERF_CTL		0x199</span>
<span class="cp">#define   IA32_PERF_TURBO_DIS	(1ULL&lt;&lt;32)</span>

<span class="cm">/*</span>
<span class="cm"> * Thermal PCI device regs</span>
<span class="cm"> */</span>
<span class="cp">#define THM_CFG_TBAR	0x10</span>
<span class="cp">#define THM_CFG_TBAR_HI	0x14</span>

<span class="cp">#define THM_TSIU	0x00</span>
<span class="cp">#define THM_TSE		0x01</span>
<span class="cp">#define   TSE_EN	0xb8</span>
<span class="cp">#define THM_TSS		0x02</span>
<span class="cp">#define THM_TSTR	0x03</span>
<span class="cp">#define THM_TSTTP	0x04</span>
<span class="cp">#define THM_TSCO	0x08</span>
<span class="cp">#define THM_TSES	0x0c</span>
<span class="cp">#define THM_TSGPEN	0x0d</span>
<span class="cp">#define   TSGPEN_HOT_LOHI	(1&lt;&lt;1)</span>
<span class="cp">#define   TSGPEN_CRIT_LOHI	(1&lt;&lt;2)</span>
<span class="cp">#define THM_TSPC	0x0e</span>
<span class="cp">#define THM_PPEC	0x10</span>
<span class="cp">#define THM_CTA		0x12</span>
<span class="cp">#define THM_PTA		0x14</span>
<span class="cp">#define   PTA_SLOPE_MASK	(0xff00)</span>
<span class="cp">#define   PTA_SLOPE_SHIFT	8</span>
<span class="cp">#define   PTA_OFFSET_MASK	(0x00ff)</span>
<span class="cp">#define THM_MGTA	0x16</span>
<span class="cp">#define   MGTA_SLOPE_MASK	(0xff00)</span>
<span class="cp">#define   MGTA_SLOPE_SHIFT	8</span>
<span class="cp">#define   MGTA_OFFSET_MASK	(0x00ff)</span>
<span class="cp">#define THM_TRC		0x1a</span>
<span class="cp">#define   TRC_CORE2_EN	(1&lt;&lt;15)</span>
<span class="cp">#define   TRC_THM_EN	(1&lt;&lt;12)</span>
<span class="cp">#define   TRC_C6_WAR	(1&lt;&lt;8)</span>
<span class="cp">#define   TRC_CORE1_EN	(1&lt;&lt;7)</span>
<span class="cp">#define   TRC_CORE_PWR	(1&lt;&lt;6)</span>
<span class="cp">#define   TRC_PCH_EN	(1&lt;&lt;5)</span>
<span class="cp">#define   TRC_MCH_EN	(1&lt;&lt;4)</span>
<span class="cp">#define   TRC_DIMM4	(1&lt;&lt;3)</span>
<span class="cp">#define   TRC_DIMM3	(1&lt;&lt;2)</span>
<span class="cp">#define   TRC_DIMM2	(1&lt;&lt;1)</span>
<span class="cp">#define   TRC_DIMM1	(1&lt;&lt;0)</span>
<span class="cp">#define THM_TES		0x20</span>
<span class="cp">#define THM_TEN		0x21</span>
<span class="cp">#define   TEN_UPDATE_EN	1</span>
<span class="cp">#define THM_PSC		0x24</span>
<span class="cp">#define   PSC_NTG	(1&lt;&lt;0) </span><span class="cm">/* No GFX turbo support */</span><span class="cp"></span>
<span class="cp">#define   PSC_NTPC	(1&lt;&lt;1) </span><span class="cm">/* No CPU turbo support */</span><span class="cp"></span>
<span class="cp">#define   PSC_PP_DEF	(0&lt;&lt;2) </span><span class="cm">/* Perf policy up to driver */</span><span class="cp"></span>
<span class="cp">#define   PSP_PP_PC	(1&lt;&lt;2) </span><span class="cm">/* BIOS prefers CPU perf */</span><span class="cp"></span>
<span class="cp">#define   PSP_PP_BAL	(2&lt;&lt;2) </span><span class="cm">/* BIOS wants balanced perf */</span><span class="cp"></span>
<span class="cp">#define   PSP_PP_GFX	(3&lt;&lt;2) </span><span class="cm">/* BIOS prefers GFX perf */</span><span class="cp"></span>
<span class="cp">#define   PSP_PBRT	(1&lt;&lt;4) </span><span class="cm">/* BIOS run time support */</span><span class="cp"></span>
<span class="cp">#define THM_CTV1	0x30</span>
<span class="cp">#define   CTV_TEMP_ERROR (1&lt;&lt;15)</span>
<span class="cp">#define   CTV_TEMP_MASK	0x3f</span>
<span class="cp">#define   CTV_</span>
<span class="cp">#define THM_CTV2	0x32</span>
<span class="cp">#define THM_CEC		0x34 </span><span class="cm">/* undocumented power accumulator in joules */</span><span class="cp"></span>
<span class="cp">#define THM_AE		0x3f</span>
<span class="cp">#define THM_HTS		0x50 </span><span class="cm">/* 32 bits */</span><span class="cp"></span>
<span class="cp">#define   HTS_PCPL_MASK	(0x7fe00000)</span>
<span class="cp">#define   HTS_PCPL_SHIFT 21</span>
<span class="cp">#define   HTS_GPL_MASK  (0x001ff000)</span>
<span class="cp">#define   HTS_GPL_SHIFT 12</span>
<span class="cp">#define   HTS_PP_MASK	(0x00000c00)</span>
<span class="cp">#define   HTS_PP_SHIFT  10</span>
<span class="cp">#define   HTS_PP_DEF	0</span>
<span class="cp">#define   HTS_PP_PROC	1</span>
<span class="cp">#define   HTS_PP_BAL	2</span>
<span class="cp">#define   HTS_PP_GFX	3</span>
<span class="cp">#define   HTS_PCTD_DIS	(1&lt;&lt;9)</span>
<span class="cp">#define   HTS_GTD_DIS	(1&lt;&lt;8)</span>
<span class="cp">#define   HTS_PTL_MASK  (0x000000fe)</span>
<span class="cp">#define   HTS_PTL_SHIFT 1</span>
<span class="cp">#define   HTS_NVV	(1&lt;&lt;0)</span>
<span class="cp">#define THM_HTSHI	0x54 </span><span class="cm">/* 16 bits */</span><span class="cp"></span>
<span class="cp">#define   HTS2_PPL_MASK		(0x03ff)</span>
<span class="cp">#define   HTS2_PRST_MASK	(0x3c00)</span>
<span class="cp">#define   HTS2_PRST_SHIFT	10</span>
<span class="cp">#define   HTS2_PRST_UNLOADED	0</span>
<span class="cp">#define   HTS2_PRST_RUNNING	1</span>
<span class="cp">#define   HTS2_PRST_TDISOP	2 </span><span class="cm">/* turbo disabled due to power */</span><span class="cp"></span>
<span class="cp">#define   HTS2_PRST_TDISHT	3 </span><span class="cm">/* turbo disabled due to high temp */</span><span class="cp"></span>
<span class="cp">#define   HTS2_PRST_TDISUSR	4 </span><span class="cm">/* user disabled turbo */</span><span class="cp"></span>
<span class="cp">#define   HTS2_PRST_TDISPLAT	5 </span><span class="cm">/* platform disabled turbo */</span><span class="cp"></span>
<span class="cp">#define   HTS2_PRST_TDISPM	6 </span><span class="cm">/* power management disabled turbo */</span><span class="cp"></span>
<span class="cp">#define   HTS2_PRST_TDISERR	7 </span><span class="cm">/* some kind of error disabled turbo */</span><span class="cp"></span>
<span class="cp">#define THM_PTL		0x56</span>
<span class="cp">#define THM_MGTV	0x58</span>
<span class="cp">#define   TV_MASK	0x000000000000ff00</span>
<span class="cp">#define   TV_SHIFT	8</span>
<span class="cp">#define THM_PTV		0x60</span>
<span class="cp">#define   PTV_MASK	0x00ff</span>
<span class="cp">#define THM_MMGPC	0x64</span>
<span class="cp">#define THM_MPPC	0x66</span>
<span class="cp">#define THM_MPCPC	0x68</span>
<span class="cp">#define THM_TSPIEN	0x82</span>
<span class="cp">#define   TSPIEN_AUX_LOHI	(1&lt;&lt;0)</span>
<span class="cp">#define   TSPIEN_HOT_LOHI	(1&lt;&lt;1)</span>
<span class="cp">#define   TSPIEN_CRIT_LOHI	(1&lt;&lt;2)</span>
<span class="cp">#define   TSPIEN_AUX2_LOHI	(1&lt;&lt;3)</span>
<span class="cp">#define THM_TSLOCK	0x83</span>
<span class="cp">#define THM_ATR		0x84</span>
<span class="cp">#define THM_TOF		0x87</span>
<span class="cp">#define THM_STS		0x98</span>
<span class="cp">#define   STS_PCPL_MASK		(0x7fe00000)</span>
<span class="cp">#define   STS_PCPL_SHIFT	21</span>
<span class="cp">#define   STS_GPL_MASK		(0x001ff000)</span>
<span class="cp">#define   STS_GPL_SHIFT		12</span>
<span class="cp">#define   STS_PP_MASK		(0x00000c00)</span>
<span class="cp">#define   STS_PP_SHIFT		10</span>
<span class="cp">#define   STS_PP_DEF		0</span>
<span class="cp">#define   STS_PP_PROC		1</span>
<span class="cp">#define   STS_PP_BAL		2</span>
<span class="cp">#define   STS_PP_GFX		3</span>
<span class="cp">#define   STS_PCTD_DIS		(1&lt;&lt;9)</span>
<span class="cp">#define   STS_GTD_DIS		(1&lt;&lt;8)</span>
<span class="cp">#define   STS_PTL_MASK		(0x000000fe)</span>
<span class="cp">#define   STS_PTL_SHIFT		1</span>
<span class="cp">#define   STS_NVV		(1&lt;&lt;0)</span>
<span class="cp">#define THM_SEC		0x9c</span>
<span class="cp">#define   SEC_ACK	(1&lt;&lt;0)</span>
<span class="cp">#define THM_TC3		0xa4</span>
<span class="cp">#define THM_TC1		0xa8</span>
<span class="cp">#define   STS_PPL_MASK		(0x0003ff00)</span>
<span class="cp">#define   STS_PPL_SHIFT		16</span>
<span class="cp">#define THM_TC2		0xac</span>
<span class="cp">#define THM_DTV		0xb0</span>
<span class="cp">#define THM_ITV		0xd8</span>
<span class="cp">#define   ITV_ME_SEQNO_MASK 0x00ff0000 </span><span class="cm">/* ME should update every ~200ms */</span><span class="cp"></span>
<span class="cp">#define   ITV_ME_SEQNO_SHIFT (16)</span>
<span class="cp">#define   ITV_MCH_TEMP_MASK 0x0000ff00</span>
<span class="cp">#define   ITV_MCH_TEMP_SHIFT (8)</span>
<span class="cp">#define   ITV_PCH_TEMP_MASK 0x000000ff</span>

<span class="cp">#define thm_readb(off) readb(ips-&gt;regmap + (off))</span>
<span class="cp">#define thm_readw(off) readw(ips-&gt;regmap + (off))</span>
<span class="cp">#define thm_readl(off) readl(ips-&gt;regmap + (off))</span>
<span class="cp">#define thm_readq(off) readq(ips-&gt;regmap + (off))</span>

<span class="cp">#define thm_writeb(off, val) writeb((val), ips-&gt;regmap + (off))</span>
<span class="cp">#define thm_writew(off, val) writew((val), ips-&gt;regmap + (off))</span>
<span class="cp">#define thm_writel(off, val) writel((val), ips-&gt;regmap + (off))</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">IPS_ADJUST_PERIOD</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="cm">/* ms */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">late_i915_load</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="cm">/* For initial average collection */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">IPS_SAMPLE_PERIOD</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span> <span class="cm">/* ms */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">IPS_SAMPLE_WINDOW</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="cm">/* 5s moving window of samples */</span>
<span class="cp">#define IPS_SAMPLE_COUNT (IPS_SAMPLE_WINDOW / IPS_SAMPLE_PERIOD)</span>

<span class="cm">/* Per-SKU limits */</span>
<span class="k">struct</span> <span class="n">ips_mcp_limits</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">cpu_family</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpu_model</span><span class="p">;</span> <span class="cm">/* includes extended model... */</span>
	<span class="kt">int</span> <span class="n">mcp_power_limit</span><span class="p">;</span> <span class="cm">/* mW units */</span>
	<span class="kt">int</span> <span class="n">core_power_limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mch_power_limit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">core_temp_limit</span><span class="p">;</span> <span class="cm">/* degrees C */</span>
	<span class="kt">int</span> <span class="n">mch_temp_limit</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Max temps are -10 degrees C to avoid PROCHOT# */</span>

<span class="k">struct</span> <span class="n">ips_mcp_limits</span> <span class="n">ips_sv_limits</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mcp_power_limit</span> <span class="o">=</span> <span class="mi">35000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_power_limit</span> <span class="o">=</span> <span class="mi">29000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mch_power_limit</span> <span class="o">=</span> <span class="mi">20000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_temp_limit</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mch_temp_limit</span> <span class="o">=</span> <span class="mi">90</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ips_mcp_limits</span> <span class="n">ips_lv_limits</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mcp_power_limit</span> <span class="o">=</span> <span class="mi">25000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_power_limit</span> <span class="o">=</span> <span class="mi">21000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mch_power_limit</span> <span class="o">=</span> <span class="mi">13000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_temp_limit</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mch_temp_limit</span> <span class="o">=</span> <span class="mi">90</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ips_mcp_limits</span> <span class="n">ips_ulv_limits</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">mcp_power_limit</span> <span class="o">=</span> <span class="mi">18000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_power_limit</span> <span class="o">=</span> <span class="mi">14000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mch_power_limit</span> <span class="o">=</span> <span class="mi">11000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">core_temp_limit</span> <span class="o">=</span> <span class="mi">95</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mch_temp_limit</span> <span class="o">=</span> <span class="mi">90</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ips_driver</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">regmap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">monitor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">adjust</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debug_root</span><span class="p">;</span>

	<span class="cm">/* Average CPU core temps (all averages in .01 degrees C for precision) */</span>
	<span class="n">u16</span> <span class="n">ctv1_avg_temp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctv2_avg_temp</span><span class="p">;</span>
	<span class="cm">/* GMCH average */</span>
	<span class="n">u16</span> <span class="n">mch_avg_temp</span><span class="p">;</span>
	<span class="cm">/* Average for the CPU (both cores?) */</span>
	<span class="n">u16</span> <span class="n">mcp_avg_temp</span><span class="p">;</span>
	<span class="cm">/* Average power consumption (in mW) */</span>
	<span class="n">u32</span> <span class="n">cpu_avg_power</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mch_avg_power</span><span class="p">;</span>

	<span class="cm">/* Offset values */</span>
	<span class="n">u16</span> <span class="n">cta_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pta_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mgta_val</span><span class="p">;</span>

	<span class="cm">/* Maximums &amp; prefs, protected by turbo status lock */</span>
	<span class="n">spinlock_t</span> <span class="n">turbo_status_lock</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mcp_temp_limit</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mcp_power_limit</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">core_power_limit</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mch_power_limit</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">cpu_turbo_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">__cpu_turbo_on</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">gpu_turbo_enabled</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">__gpu_turbo_on</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">gpu_preferred</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">poll_turbo_status</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">second_cpu</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">turbo_toggle_allowed</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ips_mcp_limits</span> <span class="o">*</span><span class="n">limits</span><span class="p">;</span>

	<span class="cm">/* Optional MCH interfaces for if i915 is in use */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">(</span><span class="o">*</span><span class="n">read_mch_val</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">gpu_raise</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">gpu_lower</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">gpu_busy</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>
	<span class="n">bool</span> <span class="p">(</span><span class="o">*</span><span class="n">gpu_turbo_disable</span><span class="p">)(</span><span class="kt">void</span><span class="p">);</span>

	<span class="cm">/* For restoration at unload */</span>
	<span class="n">u64</span> <span class="n">orig_turbo_limit</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">orig_turbo_ratios</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="n">ips_gpu_turbo_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * ips_cpu_busy - is CPU busy?</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Check CPU for load to see whether we should increase its thermal budget.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * True if the CPU could use more power, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ips_cpu_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">avenrun</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">FSHIFT</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_cpu_raise - raise CPU power clamp</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Raise the CPU power clamp by %IPS_CPU_STEP, in accordance with TDP for</span>
<span class="cm"> * this platform.</span>
<span class="cm"> *</span>
<span class="cm"> * We do this by adjusting the TURBO_POWER_CURRENT_LIMIT MSR upwards (as</span>
<span class="cm"> * long as we haven&#39;t hit the TDP limit for the SKU).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_cpu_raise</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">turbo_override</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cur_tdp_limit</span><span class="p">,</span> <span class="n">new_tdp_limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_turbo_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_override</span><span class="p">);</span>

	<span class="n">cur_tdp_limit</span> <span class="o">=</span> <span class="n">turbo_override</span> <span class="o">&amp;</span> <span class="n">TURBO_TDP_MASK</span><span class="p">;</span>
	<span class="n">new_tdp_limit</span> <span class="o">=</span> <span class="n">cur_tdp_limit</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 1W increase */</span>

	<span class="cm">/* Clamp to SKU TDP limit */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">new_tdp_limit</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">core_power_limit</span><span class="p">)</span>
		<span class="n">new_tdp_limit</span> <span class="o">=</span> <span class="n">cur_tdp_limit</span><span class="p">;</span>

	<span class="n">thm_writew</span><span class="p">(</span><span class="n">THM_MPCPC</span><span class="p">,</span> <span class="p">(</span><span class="n">new_tdp_limit</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">turbo_override</span> <span class="o">|=</span> <span class="n">TURBO_TDC_OVR_EN</span> <span class="o">|</span> <span class="n">TURBO_TDP_OVR_EN</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_override</span><span class="p">);</span>

	<span class="n">turbo_override</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TURBO_TDP_MASK</span><span class="p">;</span>
	<span class="n">turbo_override</span> <span class="o">|=</span> <span class="n">new_tdp_limit</span><span class="p">;</span>

	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_override</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_cpu_lower - lower CPU power clamp</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Lower CPU power clamp b %IPS_CPU_STEP if possible.</span>
<span class="cm"> *</span>
<span class="cm"> * We do this by adjusting the TURBO_POWER_CURRENT_LIMIT MSR down, going</span>
<span class="cm"> * as low as the platform limits will allow (though we could go lower there</span>
<span class="cm"> * wouldn&#39;t be much point).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_cpu_lower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">turbo_override</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cur_limit</span><span class="p">,</span> <span class="n">new_limit</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_override</span><span class="p">);</span>

	<span class="n">cur_limit</span> <span class="o">=</span> <span class="n">turbo_override</span> <span class="o">&amp;</span> <span class="n">TURBO_TDP_MASK</span><span class="p">;</span>
	<span class="n">new_limit</span> <span class="o">=</span> <span class="n">cur_limit</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* 1W decrease */</span>

	<span class="cm">/* Clamp to SKU TDP limit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_limit</span>  <span class="o">&lt;</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">orig_turbo_limit</span> <span class="o">&amp;</span> <span class="n">TURBO_TDP_MASK</span><span class="p">))</span>
		<span class="n">new_limit</span> <span class="o">=</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">orig_turbo_limit</span> <span class="o">&amp;</span> <span class="n">TURBO_TDP_MASK</span><span class="p">;</span>

	<span class="n">thm_writew</span><span class="p">(</span><span class="n">THM_MPCPC</span><span class="p">,</span> <span class="p">(</span><span class="n">new_limit</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">turbo_override</span> <span class="o">|=</span> <span class="n">TURBO_TDC_OVR_EN</span> <span class="o">|</span> <span class="n">TURBO_TDP_OVR_EN</span><span class="p">;</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_override</span><span class="p">);</span>

	<span class="n">turbo_override</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TURBO_TDP_MASK</span><span class="p">;</span>
	<span class="n">turbo_override</span> <span class="o">|=</span> <span class="n">new_limit</span><span class="p">;</span>

	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_override</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_enable_cpu_turbo - internal turbo enable function</span>
<span class="cm"> * @data: unused</span>
<span class="cm"> *</span>
<span class="cm"> * Internal function for actually updating MSRs.  When we enable/disable</span>
<span class="cm"> * turbo, we need to do it on each CPU; this function is the one called</span>
<span class="cm"> * by on_each_cpu() when needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_enable_cpu_turbo</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">perf_ctl</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">IA32_PERF_CTL</span><span class="p">,</span> <span class="n">perf_ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perf_ctl</span> <span class="o">&amp;</span> <span class="n">IA32_PERF_TURBO_DIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">perf_ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IA32_PERF_TURBO_DIS</span><span class="p">;</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">IA32_PERF_CTL</span><span class="p">,</span> <span class="n">perf_ctl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_enable_cpu_turbo - enable turbo mode on all CPUs</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Enable turbo mode by clearing the disable bit in IA32_PERF_CTL on</span>
<span class="cm"> * all logical threads.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_enable_cpu_turbo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Already on, no need to mess with MSRs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">__cpu_turbo_on</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_toggle_allowed</span><span class="p">)</span>
		<span class="n">on_each_cpu</span><span class="p">(</span><span class="n">do_enable_cpu_turbo</span><span class="p">,</span> <span class="n">ips</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">__cpu_turbo_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * do_disable_cpu_turbo - internal turbo disable function</span>
<span class="cm"> * @data: unused</span>
<span class="cm"> *</span>
<span class="cm"> * Internal function for actually updating MSRs.  When we enable/disable</span>
<span class="cm"> * turbo, we need to do it on each CPU; this function is the one called</span>
<span class="cm"> * by on_each_cpu() when needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_disable_cpu_turbo</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">perf_ctl</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">IA32_PERF_CTL</span><span class="p">,</span> <span class="n">perf_ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">perf_ctl</span> <span class="o">&amp;</span> <span class="n">IA32_PERF_TURBO_DIS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">perf_ctl</span> <span class="o">|=</span> <span class="n">IA32_PERF_TURBO_DIS</span><span class="p">;</span>
		<span class="n">wrmsrl</span><span class="p">(</span><span class="n">IA32_PERF_CTL</span><span class="p">,</span> <span class="n">perf_ctl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_disable_cpu_turbo - disable turbo mode on all CPUs</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Disable turbo mode by setting the disable bit in IA32_PERF_CTL on</span>
<span class="cm"> * all logical threads.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_disable_cpu_turbo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Already off, leave it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">__cpu_turbo_on</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_toggle_allowed</span><span class="p">)</span>
		<span class="n">on_each_cpu</span><span class="p">(</span><span class="n">do_disable_cpu_turbo</span><span class="p">,</span> <span class="n">ips</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">__cpu_turbo_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_gpu_busy - is GPU busy?</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Check GPU for load to see whether we should increase its thermal budget.</span>
<span class="cm"> * We need to call into the i915 driver in this case.</span>
<span class="cm"> *</span>
<span class="cm"> * RETURNS:</span>
<span class="cm"> * True if the GPU could use more power, false otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ips_gpu_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_gpu_turbo_enabled</span><span class="p">(</span><span class="n">ips</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_busy</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_gpu_raise - raise GPU power clamp</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Raise the GPU frequency/power if possible.  We need to call into the</span>
<span class="cm"> * i915 driver in this case.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_gpu_raise</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_gpu_turbo_enabled</span><span class="p">(</span><span class="n">ips</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_raise</span><span class="p">())</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_gpu_lower - lower GPU power clamp</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Lower GPU frequency/power if possible.  Need to call i915.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_gpu_lower</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_gpu_turbo_enabled</span><span class="p">(</span><span class="n">ips</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_lower</span><span class="p">())</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_enable_gpu_turbo - notify the gfx driver turbo is available</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Call into the graphics driver indicating that it can safely use</span>
<span class="cm"> * turbo mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_enable_gpu_turbo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">__gpu_turbo_on</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">__gpu_turbo_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_disable_gpu_turbo - notify the gfx driver to disable turbo mode</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Request that the graphics driver disable turbo mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_disable_gpu_turbo</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Avoid calling i915 if turbo is already disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">__gpu_turbo_on</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_disable</span><span class="p">())</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to disable graphis turbo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">__gpu_turbo_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mcp_exceeded - check whether we&#39;re outside our thermal &amp; power limits</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Check whether the MCP is over its thermal or power budget.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">mcp_exceeded</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp_limit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">avg_power</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">temp_limit</span> <span class="o">=</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_temp_limit</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_avg_temp</span> <span class="o">&gt;</span> <span class="n">temp_limit</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">avg_power</span> <span class="o">=</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_avg_power</span> <span class="o">+</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_power</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avg_power</span> <span class="o">&gt;</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_power_limit</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * cpu_exceeded - check whether a CPU core is outside its limits</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> * @cpu: CPU number to check</span>
<span class="cm"> *</span>
<span class="cm"> * Check a given CPU&#39;s average temp or power is over its limit.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">cpu_exceeded</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">avg</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">avg</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">?</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv2_avg_temp</span> <span class="o">:</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv1_avg_temp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avg</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">core_temp_limit</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_avg_power</span> <span class="o">&gt;</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">core_power_limit</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;CPU power or thermal limit exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * mch_exceeded - check whether the GPU is over budget</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Check the MCH temp &amp; power against their maximums.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">mch_exceeded</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_temp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">mch_temp_limit</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_power</span> <span class="o">&gt;</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_power_limit</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * verify_limits - verify BIOS provided limits</span>
<span class="cm"> * @ips: IPS structure</span>
<span class="cm"> *</span>
<span class="cm"> * BIOS can optionally provide non-default limits for power and temp.  Check</span>
<span class="cm"> * them here and use the defaults if the BIOS values are not provided or</span>
<span class="cm"> * are otherwise unusable.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">verify_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_power_limit</span> <span class="o">&lt;</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">mcp_power_limit</span> <span class="o">||</span>
	    <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_power_limit</span> <span class="o">&gt;</span> <span class="mi">35000</span><span class="p">)</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_power_limit</span> <span class="o">=</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">mcp_power_limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_temp_limit</span> <span class="o">&lt;</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">core_temp_limit</span> <span class="o">||</span>
	    <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_temp_limit</span> <span class="o">&lt;</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">mch_temp_limit</span> <span class="o">||</span>
	    <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_temp_limit</span> <span class="o">&gt;</span> <span class="mi">150</span><span class="p">)</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_temp_limit</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">core_temp_limit</span><span class="p">,</span>
					  <span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">mch_temp_limit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * update_turbo_limits - get various limits &amp; settings from regs</span>
<span class="cm"> * @ips: IPS driver struct</span>
<span class="cm"> *</span>
<span class="cm"> * Update the IPS power &amp; temp limits, along with turbo enable flags,</span>
<span class="cm"> * based on latest register contents.</span>
<span class="cm"> *</span>
<span class="cm"> * Used at init time and for runtime BIOS support, which requires polling</span>
<span class="cm"> * the regs for updates (as a result of AC-&gt;DC transition for example).</span>
<span class="cm"> *</span>
<span class="cm"> * LOCKING:</span>
<span class="cm"> * Caller must hold turbo_status_lock (outside of init)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_turbo_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hts</span> <span class="o">=</span> <span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_HTS</span><span class="p">);</span>

	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_turbo_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">hts</span> <span class="o">&amp;</span> <span class="n">HTS_PCTD_DIS</span><span class="p">);</span>
	<span class="cm">/* </span>
<span class="cm">	 * Disable turbo for now, until we can figure out why the power figures</span>
<span class="cm">	 * are wrong</span>
<span class="cm">	 */</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_turbo_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_busy</span><span class="p">)</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">hts</span> <span class="o">&amp;</span> <span class="n">HTS_GTD_DIS</span><span class="p">);</span>

	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">core_power_limit</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_MPCPC</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_power_limit</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_MMGPC</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_temp_limit</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_PTL</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_power_limit</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_MPPC</span><span class="p">);</span>

	<span class="n">verify_limits</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
	<span class="cm">/* Ignore BIOS CPU vs GPU pref */</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_adjust - adjust power clamp based on thermal state</span>
<span class="cm"> * @data: ips driver structure</span>
<span class="cm"> *</span>
<span class="cm"> * Wake up every 5s or so and check whether we should adjust the power clamp.</span>
<span class="cm"> * Check CPU and GPU load to determine which needs adjustment.  There are</span>
<span class="cm"> * several things to consider here:</span>
<span class="cm"> *   - do we need to adjust up or down?</span>
<span class="cm"> *   - is CPU busy?</span>
<span class="cm"> *   - is GPU busy?</span>
<span class="cm"> *   - is CPU in turbo?</span>
<span class="cm"> *   - is GPU in turbo?</span>
<span class="cm"> *   - is CPU or GPU preferred? (CPU is default)</span>
<span class="cm"> *</span>
<span class="cm"> * So, given the above, we do the following:</span>
<span class="cm"> *   - up (TDP available)</span>
<span class="cm"> *     - CPU not busy, GPU not busy - nothing</span>
<span class="cm"> *     - CPU busy, GPU not busy - adjust CPU up</span>
<span class="cm"> *     - CPU not busy, GPU busy - adjust GPU up</span>
<span class="cm"> *     - CPU busy, GPU busy - adjust preferred unit up, taking headroom from</span>
<span class="cm"> *       non-preferred unit if necessary</span>
<span class="cm"> *   - down (at TDP limit)</span>
<span class="cm"> *     - adjust both CPU and GPU down if possible</span>
<span class="cm"> *</span>
<span class="cm">		cpu+ gpu+	cpu+gpu-	cpu-gpu+	cpu-gpu-</span>
<span class="cm">cpu &lt; gpu &lt;	cpu+gpu+	cpu+		gpu+		nothing</span>
<span class="cm">cpu &lt; gpu &gt;=	cpu+gpu-(mcp&lt;)	cpu+gpu-(mcp&lt;)	gpu-		gpu-</span>
<span class="cm">cpu &gt;= gpu &lt;	cpu-gpu+(mcp&lt;)	cpu-		cpu-gpu+(mcp&lt;)	cpu-</span>
<span class="cm">cpu &gt;= gpu &gt;=	cpu-gpu-	cpu-gpu-	cpu-gpu-	cpu-gpu-</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ips_adjust</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;starting ips-adjust thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Adjust CPU and GPU clamps every 5s if needed.  Doing it more</span>
<span class="cm">	 * often isn&#39;t recommended due to ME interaction.</span>
<span class="cm">	 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">cpu_busy</span> <span class="o">=</span> <span class="n">ips_cpu_busy</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
		<span class="n">bool</span> <span class="n">gpu_busy</span> <span class="o">=</span> <span class="n">ips_gpu_busy</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">poll_turbo_status</span><span class="p">)</span>
			<span class="n">update_turbo_limits</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Update turbo status if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_turbo_enabled</span><span class="p">)</span>
			<span class="n">ips_enable_cpu_turbo</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ips_disable_cpu_turbo</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_enabled</span><span class="p">)</span>
			<span class="n">ips_enable_gpu_turbo</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ips_disable_gpu_turbo</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>

		<span class="cm">/* We&#39;re outside our comfort zone, crank them down */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcp_exceeded</span><span class="p">(</span><span class="n">ips</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ips_cpu_lower</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
			<span class="n">ips_gpu_lower</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">sleep</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cpu_exceeded</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cpu_busy</span><span class="p">)</span>
			<span class="n">ips_cpu_raise</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ips_cpu_lower</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mch_exceeded</span><span class="p">(</span><span class="n">ips</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">gpu_busy</span><span class="p">)</span>
			<span class="n">ips_gpu_raise</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ips_gpu_lower</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>

<span class="nl">sleep:</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">IPS_ADJUST_PERIOD</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">());</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ips-adjust thread stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Helpers for reading out temp/power values and calculating their</span>
<span class="cm"> * averages for the decision making and monitoring functions.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">calc_avg_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">array</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">avg</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">);</span>

	<span class="n">avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">total</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">avg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">read_mgtv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">slope</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">thm_readq</span><span class="p">(</span><span class="n">THM_MGTV</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TV_SHIFT</span><span class="p">;</span>

	<span class="n">slope</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_MGTA</span><span class="p">);</span>
	<span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">slope</span> <span class="o">&amp;</span> <span class="n">MGTA_SLOPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MGTA_SLOPE_SHIFT</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="n">MGTA_OFFSET_MASK</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">*</span> <span class="n">slope</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* MCH temp reporting buggy */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">read_ptv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">slope</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">pta_val</span> <span class="o">&amp;</span> <span class="n">PTA_SLOPE_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PTA_SLOPE_SHIFT</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">pta_val</span> <span class="o">&amp;</span> <span class="n">PTA_OFFSET_MASK</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_PTV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PTV_MASK</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">read_ctv</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">cpu</span> <span class="o">?</span> <span class="n">THM_CTV2</span> <span class="o">:</span> <span class="n">THM_CTV1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">CTV_TEMP_ERROR</span><span class="p">))</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span> <span class="cm">/* discard fractional component */</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_cpu_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">last</span><span class="p">,</span> <span class="kt">int</span> <span class="n">period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * CEC is in joules/65535.  Take difference over time to</span>
<span class="cm">	 * get watts.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_CEC</span><span class="p">);</span>

	<span class="cm">/* period is in ms and we want mW */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(((</span><span class="n">val</span> <span class="o">-</span> <span class="o">*</span><span class="n">last</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">period</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">temp_decay_factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">update_average_temp</span><span class="p">(</span><span class="n">u16</span> <span class="n">avg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Multiply by 100 for extra precision */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">temp_decay_factor</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(((</span><span class="n">temp_decay_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">avg</span><span class="p">)</span> <span class="o">/</span> <span class="n">temp_decay_factor</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">power_decay_factor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">update_average_power</span><span class="p">(</span><span class="n">u32</span> <span class="n">avg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">/</span> <span class="n">power_decay_factor</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(((</span><span class="n">power_decay_factor</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">avg</span><span class="p">)</span> <span class="o">/</span> <span class="n">power_decay_factor</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">calc_avg_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">array</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">avg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">do_div</span><span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">);</span>
	<span class="n">avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">total</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">avg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">monitor_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wake_up_process</span><span class="p">((</span><span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_monitor - temp/power monitoring thread</span>
<span class="cm"> * @data: ips driver structure</span>
<span class="cm"> *</span>
<span class="cm"> * This is the main function for the IPS driver.  It monitors power and</span>
<span class="cm"> * tempurature in the MCP and adjusts CPU and GPU power clams accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * We keep a 5s moving average of power consumption and tempurature.  Using</span>
<span class="cm"> * that data, along with CPU vs GPU preference, we adjust the power clamps</span>
<span class="cm"> * up or down.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ips_monitor</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">seqno_timestamp</span><span class="p">,</span> <span class="n">expire</span><span class="p">,</span> <span class="n">last_msecs</span><span class="p">,</span> <span class="n">last_sample_period</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">cpu_samples</span><span class="p">,</span> <span class="o">*</span><span class="n">mchp_samples</span><span class="p">,</span> <span class="n">old_cpu_power</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">mcp_samples</span><span class="p">,</span> <span class="o">*</span><span class="n">ctv1_samples</span><span class="p">,</span> <span class="o">*</span><span class="n">ctv2_samples</span><span class="p">,</span> <span class="o">*</span><span class="n">mch_samples</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cur_seqno</span><span class="p">,</span> <span class="n">last_seqno</span><span class="p">;</span>

	<span class="n">mcp_samples</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ctv1_samples</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">ctv2_samples</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">mch_samples</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">cpu_samples</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">mchp_samples</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mcp_samples</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctv1_samples</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctv2_samples</span> <span class="o">||</span> <span class="o">!</span><span class="n">mch_samples</span> <span class="o">||</span>
			<span class="o">!</span><span class="n">cpu_samples</span> <span class="o">||</span> <span class="o">!</span><span class="n">mchp_samples</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed to allocate sample array, ips disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mcp_samples</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ctv1_samples</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ctv2_samples</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mch_samples</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cpu_samples</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mchp_samples</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">last_seqno</span> <span class="o">=</span> <span class="p">(</span><span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_ITV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ITV_ME_SEQNO_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">ITV_ME_SEQNO_SHIFT</span><span class="p">;</span>
	<span class="n">seqno_timestamp</span> <span class="o">=</span> <span class="n">get_jiffies_64</span><span class="p">();</span>

	<span class="n">old_cpu_power</span> <span class="o">=</span> <span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_CEC</span><span class="p">);</span>
	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">IPS_SAMPLE_PERIOD</span><span class="p">));</span>

	<span class="cm">/* Collect an initial average */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IPS_SAMPLE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">mchp</span><span class="p">,</span> <span class="n">cpu_power</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">mcp_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_ptv</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">read_ctv</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ctv1_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">read_ctv</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ctv2_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">read_mgtv</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
		<span class="n">mch_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">cpu_power</span> <span class="o">=</span> <span class="n">get_cpu_power</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_cpu_power</span><span class="p">,</span>
					  <span class="n">IPS_SAMPLE_PERIOD</span><span class="p">);</span>
		<span class="n">cpu_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_power</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">read_mch_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mchp</span> <span class="o">=</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">read_mch_val</span><span class="p">();</span>
			<span class="n">mchp_samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mchp</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">IPS_SAMPLE_PERIOD</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_avg_temp</span> <span class="o">=</span> <span class="n">calc_avg_temp</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="n">mcp_samples</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv1_avg_temp</span> <span class="o">=</span> <span class="n">calc_avg_temp</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="n">ctv1_samples</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv2_avg_temp</span> <span class="o">=</span> <span class="n">calc_avg_temp</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="n">ctv2_samples</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_temp</span> <span class="o">=</span> <span class="n">calc_avg_temp</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="n">mch_samples</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_avg_power</span> <span class="o">=</span> <span class="n">calc_avg_power</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="n">cpu_samples</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_power</span> <span class="o">=</span> <span class="n">calc_avg_power</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="n">mchp_samples</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mcp_samples</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctv1_samples</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctv2_samples</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mch_samples</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cpu_samples</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mchp_samples</span><span class="p">);</span>

	<span class="cm">/* Start the adjustment thread now that we have data */</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">adjust</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ok, now we have an initial avg.  From here on out, we track the</span>
<span class="cm">	 * running avg using a decaying average calculation.  This allows</span>
<span class="cm">	 * us to reduce the sample frequency if the CPU and GPU are idle.</span>
<span class="cm">	 */</span>
	<span class="n">old_cpu_power</span> <span class="o">=</span> <span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_CEC</span><span class="p">);</span>
	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">IPS_SAMPLE_PERIOD</span><span class="p">));</span>
	<span class="n">last_sample_period</span> <span class="o">=</span> <span class="n">IPS_SAMPLE_PERIOD</span><span class="p">;</span>

	<span class="n">setup_deferrable_timer_on_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">,</span> <span class="n">monitor_timeout</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">current</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">cpu_val</span><span class="p">,</span> <span class="n">mch_val</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

		<span class="cm">/* MCP itself */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">read_ptv</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_avg_temp</span> <span class="o">=</span> <span class="n">update_average_temp</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_avg_temp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="cm">/* Processor 0 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">read_ctv</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv1_avg_temp</span> <span class="o">=</span>
			<span class="n">update_average_temp</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv1_avg_temp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="cm">/* Power */</span>
		<span class="n">cpu_val</span> <span class="o">=</span> <span class="n">get_cpu_power</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_cpu_power</span><span class="p">,</span>
					<span class="n">last_sample_period</span><span class="p">);</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_avg_power</span> <span class="o">=</span>
			<span class="n">update_average_power</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_avg_power</span><span class="p">,</span> <span class="n">cpu_val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">second_cpu</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Processor 1 */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">read_ctv</span><span class="p">(</span><span class="n">ips</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv2_avg_temp</span> <span class="o">=</span>
				<span class="n">update_average_temp</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv2_avg_temp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* MCH */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">read_mgtv</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_temp</span> <span class="o">=</span> <span class="n">update_average_temp</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_temp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="cm">/* Power */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">read_mch_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mch_val</span> <span class="o">=</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">read_mch_val</span><span class="p">();</span>
			<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_power</span> <span class="o">=</span>
				<span class="n">update_average_power</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_power</span><span class="p">,</span>
						     <span class="n">mch_val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Make sure ME is updating thermal regs.</span>
<span class="cm">		 * Note:</span>
<span class="cm">		 * If it&#39;s been more than a second since the last update,</span>
<span class="cm">		 * the ME is probably hung.</span>
<span class="cm">		 */</span>
		<span class="n">cur_seqno</span> <span class="o">=</span> <span class="p">(</span><span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_ITV</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ITV_ME_SEQNO_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">ITV_ME_SEQNO_SHIFT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cur_seqno</span> <span class="o">==</span> <span class="n">last_seqno</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">seqno_timestamp</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ME failed to update for more than 1s, likely hung</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">seqno_timestamp</span> <span class="o">=</span> <span class="n">get_jiffies_64</span><span class="p">();</span>
			<span class="n">last_seqno</span> <span class="o">=</span> <span class="n">cur_seqno</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">last_msecs</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
		<span class="n">expire</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">IPS_SAMPLE_PERIOD</span><span class="p">);</span>

		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">,</span> <span class="n">expire</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>

		<span class="cm">/* Calculate actual sample period for power averaging */</span>
		<span class="n">last_sample_period</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">)</span> <span class="o">-</span> <span class="n">last_msecs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last_sample_period</span><span class="p">)</span>
			<span class="n">last_sample_period</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">());</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">destroy_timer_on_stack</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ips-monitor thread stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define THM_DUMPW(reg) \</span>
<span class="c">	{ \</span>
<span class="c">	u16 val = thm_readw(reg); \</span>
<span class="c">	dev_dbg(&amp;ips-&gt;dev-&gt;dev, #reg &quot;: 0x%04x\n&quot;, val); \</span>
<span class="c">	}</span>
<span class="c">#define THM_DUMPL(reg) \</span>
<span class="c">	{ \</span>
<span class="c">	u32 val = thm_readl(reg); \</span>
<span class="c">	dev_dbg(&amp;ips-&gt;dev-&gt;dev, #reg &quot;: 0x%08x\n&quot;, val); \</span>
<span class="c">	}</span>
<span class="c">#define THM_DUMPQ(reg) \</span>
<span class="c">	{ \</span>
<span class="c">	u64 val = thm_readq(reg); \</span>
<span class="c">	dev_dbg(&amp;ips-&gt;dev-&gt;dev, #reg &quot;: 0x%016x\n&quot;, val); \</span>
<span class="c">	}</span>

<span class="c">static void dump_thermal_info(struct ips_driver *ips)</span>
<span class="c">{</span>
<span class="c">	u16 ptl;</span>

<span class="c">	ptl = thm_readw(THM_PTL);</span>
<span class="c">	dev_dbg(&amp;ips-&gt;dev-&gt;dev, &quot;Processor temp limit: %d\n&quot;, ptl);</span>

<span class="c">	THM_DUMPW(THM_CTA);</span>
<span class="c">	THM_DUMPW(THM_TRC);</span>
<span class="c">	THM_DUMPW(THM_CTV1);</span>
<span class="c">	THM_DUMPL(THM_STS);</span>
<span class="c">	THM_DUMPW(THM_PTV);</span>
<span class="c">	THM_DUMPQ(THM_MGTV);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * ips_irq_handler - handle temperature triggers and other IPS events</span>
<span class="cm"> * @irq: irq number</span>
<span class="cm"> * @arg: unused</span>
<span class="cm"> *</span>
<span class="cm"> * Handle temperature limit trigger events, generally by lowering the clamps.</span>
<span class="cm"> * If we&#39;re at a critical limit, we clamp back to the lowest possible value</span>
<span class="cm"> * to prevent emergency shutdown.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ips_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tses</span> <span class="o">=</span> <span class="n">thm_readb</span><span class="p">(</span><span class="n">THM_TSES</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">tes</span> <span class="o">=</span> <span class="n">thm_readb</span><span class="p">(</span><span class="n">THM_TES</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tses</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">tes</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TSES: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tses</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TES: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tes</span><span class="p">);</span>

	<span class="cm">/* STS update from EC? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tes</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">sts</span><span class="p">,</span> <span class="n">tc1</span><span class="p">;</span>

		<span class="n">sts</span> <span class="o">=</span> <span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_STS</span><span class="p">);</span>
		<span class="n">tc1</span> <span class="o">=</span> <span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_TC1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_NVV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">);</span>
			<span class="n">ips</span><span class="o">-&gt;</span><span class="n">core_power_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_PCPL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">STS_PCPL_SHIFT</span><span class="p">;</span>
			<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_power_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_GPL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">STS_GPL_SHIFT</span><span class="p">;</span>
			<span class="cm">/* ignore EC CPU vs GPU pref */</span>
			<span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_turbo_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_PCTD_DIS</span><span class="p">);</span>
			<span class="cm">/* </span>
<span class="cm">			 * Disable turbo for now, until we can figure</span>
<span class="cm">			 * out why the power figures are wrong</span>
<span class="cm">			 */</span>
			<span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_turbo_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_busy</span><span class="p">)</span>
				<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_GTD_DIS</span><span class="p">);</span>
			<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_temp_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">sts</span> <span class="o">&amp;</span> <span class="n">STS_PTL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">STS_PTL_SHIFT</span><span class="p">;</span>
			<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_power_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">tc1</span> <span class="o">&amp;</span> <span class="n">STS_PPL_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="n">STS_PPL_SHIFT</span><span class="p">;</span>
			<span class="n">verify_limits</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">);</span>

			<span class="n">thm_writeb</span><span class="p">(</span><span class="n">THM_SEC</span><span class="p">,</span> <span class="n">SEC_ACK</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">thm_writeb</span><span class="p">(</span><span class="n">THM_TES</span><span class="p">,</span> <span class="n">tes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Thermal trip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tses</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;thermal trip occurred, tses: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tses</span><span class="p">);</span>
		<span class="n">thm_writeb</span><span class="p">(</span><span class="n">THM_TSES</span><span class="p">,</span> <span class="n">tses</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_DEBUG_FS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_debugfs_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#else</span>

<span class="cm">/* Expose current state and limits in debugfs if possible */</span>

<span class="k">struct</span> <span class="n">ips_debugfs_node</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">show</span><span class="p">)(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_cpu_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv1_avg_temp</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
		   <span class="n">ips</span><span class="o">-&gt;</span><span class="n">ctv1_avg_temp</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_cpu_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%dmW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_avg_power</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_cpu_clamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">turbo_override</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tdp</span><span class="p">,</span> <span class="n">tdc</span><span class="p">;</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_override</span><span class="p">);</span>

	<span class="n">tdp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">turbo_override</span> <span class="o">&amp;</span> <span class="n">TURBO_TDP_MASK</span><span class="p">);</span>
	<span class="n">tdc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">turbo_override</span> <span class="o">&amp;</span> <span class="n">TURBO_TDC_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">TURBO_TDC_SHIFT</span><span class="p">);</span>

	<span class="cm">/* Convert to .1W/A units */</span>
	<span class="n">tdp</span> <span class="o">=</span> <span class="n">tdp</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tdc</span> <span class="o">=</span> <span class="n">tdc</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Watts Amperes */</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d.%dW %d.%dA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tdp</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tdp</span> <span class="o">%</span> <span class="mi">10</span><span class="p">,</span>
		   <span class="n">tdc</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span> <span class="n">tdc</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_mch_temp</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_temp</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span>
		   <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_temp</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_mch_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%dmW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mch_avg_power</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ips_debugfs_node</span> <span class="n">ips_debug_files</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cpu_temp&quot;</span><span class="p">,</span> <span class="n">show_cpu_temp</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cpu_power&quot;</span><span class="p">,</span> <span class="n">show_cpu_power</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cpu_clamp&quot;</span><span class="p">,</span> <span class="n">show_cpu_clamp</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;mch_temp&quot;</span><span class="p">,</span> <span class="n">show_mch_temp</span> <span class="p">},</span>
	<span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;mch_power&quot;</span><span class="p">,</span> <span class="n">show_mch_power</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ips_debugfs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_debugfs_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">show</span><span class="p">,</span> <span class="n">node</span><span class="o">-&gt;</span><span class="n">ips</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ips_debugfs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ips_debugfs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_debugfs_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">debug_root</span><span class="p">)</span>
		<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">debug_root</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">debug_root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;ips&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">debug_root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed to create debugfs entries: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">debug_root</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ips_debug_files</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ips_debugfs_node</span> <span class="o">*</span><span class="n">node</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ips_debug_files</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">node</span><span class="o">-&gt;</span><span class="n">ips</span> <span class="o">=</span> <span class="n">ips</span><span class="p">;</span>
		<span class="n">ent</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
					  <span class="n">ips</span><span class="o">-&gt;</span><span class="n">debug_root</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">ips_debugfs_ops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;failed to create debug file: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ent</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">err_cleanup</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_cleanup:</span>
	<span class="n">ips_debugfs_cleanup</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_DEBUG_FS */</span><span class="cp"></span>

<span class="cm">/**</span>
<span class="cm"> * ips_detect_cpu - detect whether CPU supports IPS</span>
<span class="cm"> *</span>
<span class="cm"> * Walk our list and see if we&#39;re on a supported CPU.  If we find one,</span>
<span class="cm"> * return the limits for it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ips_mcp_limits</span> <span class="o">*</span><span class="nf">ips_detect_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">turbo_power</span><span class="p">,</span> <span class="n">misc_en</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ips_mcp_limits</span> <span class="o">*</span><span class="n">limits</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tdp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model</span> <span class="o">==</span> <span class="mi">37</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Non-IPS CPU detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">IA32_MISC_ENABLE</span><span class="p">,</span> <span class="n">misc_en</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the turbo enable bit isn&#39;t set, we shouldn&#39;t try to enable/disable</span>
<span class="cm">	 * turbo manually or we&#39;ll get an illegal MSR access, even though</span>
<span class="cm">	 * turbo will still be available.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">misc_en</span> <span class="o">&amp;</span> <span class="n">IA32_MISC_TURBO_EN</span><span class="p">)</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_toggle_allowed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_toggle_allowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model_id</span><span class="p">,</span> <span class="s">&quot;CPU       M&quot;</span><span class="p">))</span>
		<span class="n">limits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ips_sv_limits</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model_id</span><span class="p">,</span> <span class="s">&quot;CPU       L&quot;</span><span class="p">))</span>
		<span class="n">limits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ips_lv_limits</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">boot_cpu_data</span><span class="p">.</span><span class="n">x86_model_id</span><span class="p">,</span> <span class="s">&quot;CPU       U&quot;</span><span class="p">))</span>
		<span class="n">limits</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ips_ulv_limits</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No CPUID match found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_power</span><span class="p">);</span>
	<span class="n">tdp</span> <span class="o">=</span> <span class="n">turbo_power</span> <span class="o">&amp;</span> <span class="n">TURBO_TDP_MASK</span><span class="p">;</span>

	<span class="cm">/* Sanity check TDP against CPU */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">limits</span><span class="o">-&gt;</span><span class="n">core_power_limit</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tdp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CPU TDP doesn&#39;t match expected value (found %d, expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tdp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">,</span> <span class="n">limits</span><span class="o">-&gt;</span><span class="n">core_power_limit</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="n">limits</span><span class="o">-&gt;</span><span class="n">core_power_limit</span> <span class="o">=</span> <span class="p">(</span><span class="n">tdp</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">limits</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * ips_get_i915_syms - try to get GPU control methods from i915 driver</span>
<span class="cm"> * @ips: IPS driver</span>
<span class="cm"> *</span>
<span class="cm"> * The i915 driver exports several interfaces to allow the IPS driver to</span>
<span class="cm"> * monitor and control graphics turbo mode.  If we can find them, we can</span>
<span class="cm"> * enable graphics turbo, otherwise we must disable it to avoid exceeding</span>
<span class="cm"> * thermal and power limits in the MCP.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ips_get_i915_syms</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">read_mch_val</span> <span class="o">=</span> <span class="n">symbol_get</span><span class="p">(</span><span class="n">i915_read_mch_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">read_mch_val</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err</span><span class="p">;</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_raise</span> <span class="o">=</span> <span class="n">symbol_get</span><span class="p">(</span><span class="n">i915_gpu_raise</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_raise</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_mch</span><span class="p">;</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_lower</span> <span class="o">=</span> <span class="n">symbol_get</span><span class="p">(</span><span class="n">i915_gpu_lower</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_lower</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_raise</span><span class="p">;</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_busy</span> <span class="o">=</span> <span class="n">symbol_get</span><span class="p">(</span><span class="n">i915_gpu_busy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_busy</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_lower</span><span class="p">;</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_disable</span> <span class="o">=</span> <span class="n">symbol_get</span><span class="p">(</span><span class="n">i915_gpu_turbo_disable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_disable</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_put_busy</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

<span class="nl">out_put_busy:</span>
	<span class="n">symbol_put</span><span class="p">(</span><span class="n">i915_gpu_busy</span><span class="p">);</span>
<span class="nl">out_put_lower:</span>
	<span class="n">symbol_put</span><span class="p">(</span><span class="n">i915_gpu_lower</span><span class="p">);</span>
<span class="nl">out_put_raise:</span>
	<span class="n">symbol_put</span><span class="p">(</span><span class="n">i915_gpu_raise</span><span class="p">);</span>
<span class="nl">out_put_mch:</span>
	<span class="n">symbol_put</span><span class="p">(</span><span class="n">i915_read_mch_val</span><span class="p">);</span>
<span class="nl">out_err:</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">ips_gpu_turbo_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_busy</span> <span class="o">&amp;&amp;</span> <span class="n">late_i915_load</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ips_get_i915_syms</span><span class="p">(</span><span class="n">ips</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;i915 driver attached, reenabling gpu turbo</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_enabled</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_HTS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HTS_GTD_DIS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_enabled</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">ips_link_to_i915_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We can&#39;t cleanly get at the various ips_driver structs from</span>
<span class="cm">	 * this caller (the i915 driver), so just set a flag saying</span>
<span class="cm">	 * that it&#39;s time to try getting the symbols again.</span>
<span class="cm">	 */</span>
	<span class="n">late_i915_load</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">ips_link_to_i915_driver</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">ips_id_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_INTEL</span><span class="p">,</span>
		     <span class="n">PCI_DEVICE_ID_INTEL_THERMAL_SENSOR</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ips_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ips_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">platform_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">htshi</span><span class="p">,</span> <span class="n">trc</span><span class="p">,</span> <span class="n">trc_required_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tse</span><span class="p">;</span>

	<span class="n">ips</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ips_driver</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ips</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span> <span class="o">=</span> <span class="n">ips_detect_cpu</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IPS not supported on this CPU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">turbo_status_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t enable PCI device, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TBAR not assigned, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ips thermal sensor&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;thermal resource busy, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_free</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">regmap</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			      <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to map thermal regs, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tse</span> <span class="o">=</span> <span class="n">thm_readb</span><span class="p">(</span><span class="n">THM_TSE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tse</span> <span class="o">!=</span> <span class="n">TSE_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;thermal device not enabled (0x%02x), aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tse</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trc</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_TRC</span><span class="p">);</span>
	<span class="n">trc_required_mask</span> <span class="o">=</span> <span class="n">TRC_CORE1_EN</span> <span class="o">|</span> <span class="n">TRC_CORE_PWR</span> <span class="o">|</span> <span class="n">TRC_MCH_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">trc</span> <span class="o">&amp;</span> <span class="n">trc_required_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">trc_required_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;thermal reporting for required devices not enabled, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">trc</span> <span class="o">&amp;</span> <span class="n">TRC_CORE2_EN</span><span class="p">)</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">second_cpu</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">update_turbo_limits</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;max cpu power clamp: %dW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_power_limit</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;max core power clamp: %dW</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">core_power_limit</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>
	<span class="cm">/* BIOS may update limits at runtime */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">thm_readl</span><span class="p">(</span><span class="n">THM_PSC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PSP_PBRT</span><span class="p">)</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">poll_turbo_status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips_get_i915_syms</span><span class="p">(</span><span class="n">ips</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to get i915 symbols, graphics turbo disabled until i915 loads</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;graphics turbo enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check PLATFORM_INFO MSR to make sure this chip is</span>
<span class="cm">	 * turbo capable.</span>
<span class="cm">	 */</span>
	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">PLATFORM_INFO</span><span class="p">,</span> <span class="n">platform_info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">platform_info</span> <span class="o">&amp;</span> <span class="n">PLATFORM_TDP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform indicates TDP override unavailable, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * IRQ handler for ME interaction</span>
<span class="cm">	 * Note: don&#39;t use MSI here as the PCH has bugs.</span>
<span class="cm">	 */</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ips_irq_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;ips&quot;</span><span class="p">,</span>
			  <span class="n">ips</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request irq failed, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Enable aux, hot &amp; critical interrupts */</span>
	<span class="n">thm_writeb</span><span class="p">(</span><span class="n">THM_TSPIEN</span><span class="p">,</span> <span class="n">TSPIEN_AUX2_LOHI</span> <span class="o">|</span> <span class="n">TSPIEN_CRIT_LOHI</span> <span class="o">|</span>
		   <span class="n">TSPIEN_HOT_LOHI</span> <span class="o">|</span> <span class="n">TSPIEN_AUX_LOHI</span><span class="p">);</span>
	<span class="n">thm_writeb</span><span class="p">(</span><span class="n">THM_TEN</span><span class="p">,</span> <span class="n">TEN_UPDATE_EN</span><span class="p">);</span>

	<span class="cm">/* Collect adjustment values */</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">cta_val</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_CTA</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">pta_val</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_PTA</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">mgta_val</span> <span class="o">=</span> <span class="n">thm_readw</span><span class="p">(</span><span class="n">THM_MGTA</span><span class="p">);</span>

	<span class="cm">/* Save turbo limits &amp; ratios */</span>
	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">orig_turbo_limit</span><span class="p">);</span>

	<span class="n">ips_disable_cpu_turbo</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">cpu_turbo_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Create thermal adjust thread */</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">adjust</span> <span class="o">=</span> <span class="n">kthread_create</span><span class="p">(</span><span class="n">ips_adjust</span><span class="p">,</span> <span class="n">ips</span><span class="p">,</span> <span class="s">&quot;ips-adjust&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">adjust</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed to create thermal adjust thread, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_free_irq</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the work queue and monitor thread. The monitor thread</span>
<span class="cm">	 * will wake up ips_adjust thread.</span>
<span class="cm">	 */</span>
	<span class="n">ips</span><span class="o">-&gt;</span><span class="n">monitor</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">ips_monitor</span><span class="p">,</span> <span class="n">ips</span><span class="p">,</span> <span class="s">&quot;ips-monitor&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">monitor</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;failed to create thermal monitor thread, aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_thread_cleanup</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hts</span> <span class="o">=</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">core_power_limit</span> <span class="o">&lt;&lt;</span> <span class="n">HTS_PCPL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_temp_limit</span> <span class="o">&lt;&lt;</span> <span class="n">HTS_PTL_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">HTS_NVV</span><span class="p">;</span>
	<span class="n">htshi</span> <span class="o">=</span> <span class="n">HTS2_PRST_RUNNING</span> <span class="o">&lt;&lt;</span> <span class="n">HTS2_PRST_SHIFT</span><span class="p">;</span>

	<span class="n">thm_writew</span><span class="p">(</span><span class="n">THM_HTSHI</span><span class="p">,</span> <span class="n">htshi</span><span class="p">);</span>
	<span class="n">thm_writel</span><span class="p">(</span><span class="n">THM_HTS</span><span class="p">,</span> <span class="n">hts</span><span class="p">);</span>

	<span class="n">ips_debugfs_init</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IPS driver initialized, MCP temp limit %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ips</span><span class="o">-&gt;</span><span class="n">mcp_temp_limit</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error_thread_cleanup:</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">adjust</span><span class="p">);</span>
<span class="nl">error_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ips</span><span class="p">);</span>
<span class="nl">error_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">);</span>
<span class="nl">error_release:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">error_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ips_driver</span> <span class="o">*</span><span class="n">ips</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u64</span> <span class="n">turbo_override</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ips</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ips_debugfs_cleanup</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>

	<span class="cm">/* Release i915 driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">read_mch_val</span><span class="p">)</span>
		<span class="n">symbol_put</span><span class="p">(</span><span class="n">i915_read_mch_val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_raise</span><span class="p">)</span>
		<span class="n">symbol_put</span><span class="p">(</span><span class="n">i915_gpu_raise</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_lower</span><span class="p">)</span>
		<span class="n">symbol_put</span><span class="p">(</span><span class="n">i915_gpu_lower</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_busy</span><span class="p">)</span>
		<span class="n">symbol_put</span><span class="p">(</span><span class="n">i915_gpu_busy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">gpu_turbo_disable</span><span class="p">)</span>
		<span class="n">symbol_put</span><span class="p">(</span><span class="n">i915_gpu_turbo_disable</span><span class="p">);</span>

	<span class="n">rdmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_override</span><span class="p">);</span>
	<span class="n">turbo_override</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TURBO_TDC_OVR_EN</span> <span class="o">|</span> <span class="n">TURBO_TDP_OVR_EN</span><span class="p">);</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">turbo_override</span><span class="p">);</span>
	<span class="n">wrmsrl</span><span class="p">(</span><span class="n">TURBO_POWER_CURRENT_LIMIT</span><span class="p">,</span> <span class="n">ips</span><span class="o">-&gt;</span><span class="n">orig_turbo_limit</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ips</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">adjust</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">adjust</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">monitor</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">monitor</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ips</span><span class="o">-&gt;</span><span class="n">regmap</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ips</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IPS driver removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ips_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ips_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ips_suspend NULL</span>
<span class="cp">#define ips_resume NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ips_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;intel ips&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ips_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ips_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ips_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ips_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ips_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">shutdown</span> <span class="o">=</span> <span class="n">ips_shutdown</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ips_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_pci_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">ips_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ips_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ips_pci_driver</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ips_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jesse Barnes &lt;jbarnes@virtuousgeek.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intelligent Power Sharing Driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
