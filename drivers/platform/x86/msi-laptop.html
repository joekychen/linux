<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › platform › x86 › msi-laptop.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>msi-laptop.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*-*-linux-c-*-*/</span>

<span class="cm">/*</span>
<span class="cm">  Copyright (C) 2006 Lennart Poettering &lt;mzxreary (at) 0pointer (dot) de&gt;</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful, but</span>
<span class="cm">  WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm">  General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm">  02110-1301, USA.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * msi-laptop.c - MSI S270 laptop support. This laptop is sold under</span>
<span class="cm"> * various brands, including &quot;Cytron/TCM/Medion/Tchibo MD96100&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Driver also supports S271, S420 models.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver exports a few files in /sys/devices/platform/msi-laptop-pf/:</span>
<span class="cm"> *</span>
<span class="cm"> *   lcd_level - Screen brightness: contains a single integer in the</span>
<span class="cm"> *   range 0..8. (rw)</span>
<span class="cm"> *</span>
<span class="cm"> *   auto_brightness - Enable automatic brightness control: contains</span>
<span class="cm"> *   either 0 or 1. If set to 1 the hardware adjusts the screen</span>
<span class="cm"> *   brightness automatically when the power cord is</span>
<span class="cm"> *   plugged/unplugged. (rw)</span>
<span class="cm"> *</span>
<span class="cm"> *   wlan - WLAN subsystem enabled: contains either 0 or 1. (ro)</span>
<span class="cm"> *</span>
<span class="cm"> *   bluetooth - Bluetooth subsystem enabled: contains either 0 or 1</span>
<span class="cm"> *   Please note that this file is constantly 0 if no Bluetooth</span>
<span class="cm"> *   hardware is available. (ro)</span>
<span class="cm"> *</span>
<span class="cm"> * In addition to these platform device attributes the driver</span>
<span class="cm"> * registers itself in the Linux backlight control subsystem and is</span>
<span class="cm"> * available to userspace under /sys/class/backlight/msi-laptop-bl/.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver might work on other laptops produced by MSI. If you</span>
<span class="cm"> * want to try it you can pass force=1 as argument to the module which</span>
<span class="cm"> * will force it to load even when the DMI data doesn&#39;t identify the</span>
<span class="cm"> * laptop as MSI S270. YMMV.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/rfkill.h&gt;</span>
<span class="cp">#include &lt;linux/i8042.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/input/sparse-keymap.h&gt;</span>

<span class="cp">#define MSI_DRIVER_VERSION &quot;0.5&quot;</span>

<span class="cp">#define MSI_LCD_LEVEL_MAX 9</span>

<span class="cp">#define MSI_EC_COMMAND_WIRELESS 0x10</span>
<span class="cp">#define MSI_EC_COMMAND_LCD_LEVEL 0x11</span>

<span class="cp">#define MSI_STANDARD_EC_COMMAND_ADDRESS	0x2e</span>
<span class="cp">#define MSI_STANDARD_EC_BLUETOOTH_MASK	(1 &lt;&lt; 0)</span>
<span class="cp">#define MSI_STANDARD_EC_WEBCAM_MASK	(1 &lt;&lt; 1)</span>
<span class="cp">#define MSI_STANDARD_EC_WLAN_MASK	(1 &lt;&lt; 3)</span>
<span class="cp">#define MSI_STANDARD_EC_3G_MASK		(1 &lt;&lt; 4)</span>

<span class="cm">/* For set SCM load flag to disable BIOS fn key */</span>
<span class="cp">#define MSI_STANDARD_EC_SCM_LOAD_ADDRESS	0x2d</span>
<span class="cp">#define MSI_STANDARD_EC_SCM_LOAD_MASK		(1 &lt;&lt; 0)</span>

<span class="cp">#define MSI_STANDARD_EC_TOUCHPAD_ADDRESS	0xe4</span>
<span class="cp">#define MSI_STANDARD_EC_TOUCHPAD_MASK		(1 &lt;&lt; 4)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">msi_laptop_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">);</span>

<span class="cp">#define MSI_STANDARD_EC_DEVICES_EXISTS_ADDRESS	0x2f</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">force</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="s">&quot;Force driver load, ignore DMI data&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">auto_brightness</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">auto_brightness</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">auto_brightness</span><span class="p">,</span> <span class="s">&quot;Enable automatic brightness control (0: disabled; 1: enabled; 2: don&#39;t touch)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">key_entry</span> <span class="n">msi_laptop_keymap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="n">KEY_TOUCHPAD_ON</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_TOUCHPAD_ON</span><span class="p">}</span> <span class="p">},</span>	<span class="cm">/* Touch Pad On */</span>
	<span class="p">{</span><span class="n">KE_KEY</span><span class="p">,</span> <span class="n">KEY_TOUCHPAD_OFF</span><span class="p">,</span> <span class="p">{</span><span class="n">KEY_TOUCHPAD_OFF</span><span class="p">}</span> <span class="p">},</span><span class="cm">/* Touch Pad On */</span>
	<span class="p">{</span><span class="n">KE_END</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">msi_laptop_input_dev</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">old_ec_model</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wlan_s</span><span class="p">,</span> <span class="n">bluetooth_s</span><span class="p">,</span> <span class="n">threeg_s</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">threeg_exists</span><span class="p">;</span>

<span class="cm">/* Some MSI 3G netbook only have one fn key to control Wlan/Bluetooth/3G,</span>
<span class="cm"> * those netbook will load the SCM (windows app) to disable the original</span>
<span class="cm"> * Wlan/Bluetooth control by BIOS when user press fn key, then control</span>
<span class="cm"> * Wlan/Bluetooth/3G by SCM (software control by OS). Without SCM, user</span>
<span class="cm"> * cann&#39;t on/off 3G module on those 3G netbook.</span>
<span class="cm"> * On Linux, msi-laptop driver will do the same thing to disable the</span>
<span class="cm"> * original BIOS control, then might need use HAL or other userland</span>
<span class="cm"> * application to do the software control that simulate with SCM.</span>
<span class="cm"> * e.g. MSI N034 netbook</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">load_scm_model</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfk_wlan</span><span class="p">,</span> <span class="o">*</span><span class="n">rfk_bluetooth</span><span class="p">,</span> <span class="o">*</span><span class="n">rfk_threeg</span><span class="p">;</span>

<span class="cm">/* Hardware access */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_lcd_level</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">MSI_LCD_LEVEL_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">level</span><span class="o">*</span><span class="mi">31</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ec_transaction</span><span class="p">(</span><span class="n">MSI_EC_COMMAND_LCD_LEVEL</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
			      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_lcd_level</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">wdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_transaction</span><span class="p">(</span><span class="n">MSI_EC_COMMAND_LCD_LEVEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">rdata</span> <span class="o">/</span> <span class="mi">31</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_auto_brightness</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">wdata</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_transaction</span><span class="p">(</span><span class="n">MSI_EC_COMMAND_LCD_LEVEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_auto_brightness</span><span class="p">(</span><span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">wdata</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">wdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_transaction</span><span class="p">(</span><span class="n">MSI_EC_COMMAND_LCD_LEVEL</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">wdata</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
	<span class="n">wdata</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="mh">0xF7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">enable</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ec_transaction</span><span class="p">(</span><span class="n">MSI_EC_COMMAND_LCD_LEVEL</span><span class="p">,</span> <span class="n">wdata</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			      <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_device_state</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">status</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* read current device state */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="n">MSI_STANDARD_EC_COMMAND_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">!=</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reverse device bit */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span>
			<span class="n">wdata</span> <span class="o">=</span> <span class="n">rdata</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wdata</span> <span class="o">=</span> <span class="n">rdata</span> <span class="o">|</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">ec_write</span><span class="p">(</span><span class="n">MSI_STANDARD_EC_COMMAND_ADDRESS</span><span class="p">,</span> <span class="n">wdata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_wireless_state</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">wlan</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">bluetooth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">wdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_transaction</span><span class="p">(</span><span class="n">MSI_EC_COMMAND_WIRELESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlan</span><span class="p">)</span>
		<span class="o">*</span><span class="n">wlan</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bluetooth</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bluetooth</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="mi">128</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_wireless_state_ec_standard</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="n">MSI_STANDARD_EC_COMMAND_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">wlan_s</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="n">MSI_STANDARD_EC_WLAN_MASK</span><span class="p">);</span>

	<span class="n">bluetooth_s</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="n">MSI_STANDARD_EC_BLUETOOTH_MASK</span><span class="p">);</span>

	<span class="n">threeg_s</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="n">MSI_STANDARD_EC_3G_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_threeg_exists</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="n">MSI_STANDARD_EC_DEVICES_EXISTS_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">threeg_exists</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="n">MSI_STANDARD_EC_3G_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Backlight device stuff */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bl_get_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">get_lcd_level</span><span class="p">();</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bl_update_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">set_lcd_level</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">msibl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="n">bl_get_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_status</span>  <span class="o">=</span> <span class="n">bl_update_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">msibl_device</span><span class="p">;</span>

<span class="cm">/* Platform device */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_wlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_ec_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_wireless_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">enabled</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_wireless_state_ec_standard</span><span class="p">();</span>
		<span class="n">enabled</span> <span class="o">=</span> <span class="n">wlan_s</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_wlan</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">set_device_state</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">MSI_STANDARD_EC_WLAN_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_bluetooth</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">enabled</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_ec_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_wireless_state</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enabled</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_wireless_state_ec_standard</span><span class="p">();</span>
		<span class="n">enabled</span> <span class="o">=</span> <span class="n">bluetooth_s</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enabled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_bluetooth</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">set_device_state</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">MSI_STANDARD_EC_BLUETOOTH_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_threeg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* old msi ec not support 3G */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_ec_model</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_wireless_state_ec_standard</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">threeg_s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_threeg</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">set_device_state</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">MSI_STANDARD_EC_3G_MASK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_lcd_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_lcd_level</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_lcd_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">level</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">MSI_LCD_LEVEL_MAX</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_lcd_level</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_auto_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_auto_brightness</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_auto_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">enable</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="p">(</span><span class="n">enable</span> <span class="o">!=</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_auto_brightness</span><span class="p">(</span><span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lcd_level</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_lcd_level</span><span class="p">,</span> <span class="n">store_lcd_level</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">auto_brightness</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">show_auto_brightness</span><span class="p">,</span>
		   <span class="n">store_auto_brightness</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">bluetooth</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_bluetooth</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">wlan</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_wlan</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">threeg</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">show_threeg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">msipf_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lcd_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_auto_brightness</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_bluetooth</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_wlan</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">msipf_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">msipf_attributes</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">msipf_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;msi-laptop-pf&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">msi_laptop_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">msipf_device</span><span class="p">;</span>

<span class="cm">/* Initialization */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dmi_check_cb</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Identified laptop model &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initdata</span> <span class="n">msi_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;MSI S270&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;MICRO-STAR INT&#39;L CO.,LTD&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MS-1013&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_VERSION</span><span class="p">,</span> <span class="s">&quot;0131&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_VENDOR</span><span class="p">,</span>
				  <span class="s">&quot;MICRO-STAR INT&#39;L CO.,LTD&quot;</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;MSI S271&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Micro-Star International&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MS-1058&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_VERSION</span><span class="p">,</span> <span class="s">&quot;0581&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;MS-1058&quot;</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;MSI S420&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;Micro-Star International&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MS-1412&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_VENDOR</span><span class="p">,</span> <span class="s">&quot;MSI&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;MS-1412&quot;</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;Medion MD96100&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;NOTEBOOK&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;SAM2000&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_VERSION</span><span class="p">,</span> <span class="s">&quot;0131&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_VENDOR</span><span class="p">,</span>
				  <span class="s">&quot;MICRO-STAR INT&#39;L CO.,LTD&quot;</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initdata</span> <span class="n">msi_load_scm_models_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;MSI N034&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
				<span class="s">&quot;MICRO-STAR INTERNATIONAL CO., LTD&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MS-N034&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_VENDOR</span><span class="p">,</span>
			<span class="s">&quot;MICRO-STAR INTERNATIONAL CO., LTD&quot;</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;MSI N051&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
				<span class="s">&quot;MICRO-STAR INTERNATIONAL CO., LTD&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MS-N051&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_VENDOR</span><span class="p">,</span>
			<span class="s">&quot;MICRO-STAR INTERNATIONAL CO., LTD&quot;</span><span class="p">)</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;MSI N014&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
				<span class="s">&quot;MICRO-STAR INTERNATIONAL CO., LTD&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;MS-N014&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;MSI CR620&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
				<span class="s">&quot;Micro-Star International&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;CR620&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;MSI U270&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
				<span class="s">&quot;Micro-Star International Co., Ltd.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;U270 series&quot;</span><span class="p">),</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">dmi_check_cb</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rfkill_bluetooth_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Do something with blocked...*/</span>
	<span class="cm">/*</span>
<span class="cm">	 * blocked == false is on</span>
<span class="cm">	 * blocked == true is off</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocked</span><span class="p">)</span>
		<span class="n">set_device_state</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSI_STANDARD_EC_BLUETOOTH_MASK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_device_state</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSI_STANDARD_EC_BLUETOOTH_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rfkill_wlan_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocked</span><span class="p">)</span>
		<span class="n">set_device_state</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSI_STANDARD_EC_WLAN_MASK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_device_state</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSI_STANDARD_EC_WLAN_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rfkill_threeg_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocked</span><span class="p">)</span>
		<span class="n">set_device_state</span><span class="p">(</span><span class="s">&quot;0&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSI_STANDARD_EC_3G_MASK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_device_state</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSI_STANDARD_EC_3G_MASK</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">rfkill_bluetooth_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">rfkill_bluetooth_set</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">rfkill_wlan_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">rfkill_wlan_set</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">rfkill_threeg_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">rfkill_threeg_set</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rfkill_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_threeg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">rfk_threeg</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfk_threeg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_wlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">rfk_wlan</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfk_wlan</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msi_update_rfkill</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">get_wireless_state_ec_standard</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_wlan</span><span class="p">)</span>
		<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">rfk_wlan</span><span class="p">,</span> <span class="o">!</span><span class="n">wlan_s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">)</span>
		<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">,</span> <span class="o">!</span><span class="n">bluetooth_s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_threeg</span><span class="p">)</span>
		<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">rfk_threeg</span><span class="p">,</span> <span class="o">!</span><span class="n">threeg_s</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">msi_rfkill_work</span><span class="p">,</span> <span class="n">msi_update_rfkill</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msi_send_touchpad_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rdata</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="n">MSI_STANDARD_EC_TOUCHPAD_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sparse_keymap_report_event</span><span class="p">(</span><span class="n">msi_laptop_input_dev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">rdata</span> <span class="o">&amp;</span> <span class="n">MSI_STANDARD_EC_TOUCHPAD_MASK</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">KEY_TOUCHPAD_ON</span> <span class="o">:</span> <span class="n">KEY_TOUCHPAD_OFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">msi_touchpad_work</span><span class="p">,</span> <span class="n">msi_send_touchpad_key</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">msi_laptop_i8042_filter</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">str</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">serio</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">bool</span> <span class="n">extended</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">str</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* 0x54 wwan, 0x62 bluetooth, 0x76 wlan, 0xE4 touchpad toggle*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="mh">0xe0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">extended</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">extended</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">extended</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0xE4</span>:
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msi_touchpad_work</span><span class="p">,</span>
				<span class="n">round_jiffies_relative</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x54</span>:
		<span class="k">case</span> <span class="mh">0x62</span>:
		<span class="k">case</span> <span class="mh">0x76</span>:
			<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msi_rfkill_work</span><span class="p">,</span>
				<span class="n">round_jiffies_relative</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msi_init_rfkill</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ignored</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_wlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">rfk_wlan</span><span class="p">,</span> <span class="o">!</span><span class="n">wlan_s</span><span class="p">);</span>
		<span class="n">rfkill_wlan_set</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">!</span><span class="n">wlan_s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">,</span> <span class="o">!</span><span class="n">bluetooth_s</span><span class="p">);</span>
		<span class="n">rfkill_bluetooth_set</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">!</span><span class="n">bluetooth_s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_threeg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">rfk_threeg</span><span class="p">,</span> <span class="o">!</span><span class="n">threeg_s</span><span class="p">);</span>
		<span class="n">rfkill_threeg_set</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">!</span><span class="n">threeg_s</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DECLARE_DELAYED_WORK</span><span class="p">(</span><span class="n">msi_rfkill_init</span><span class="p">,</span> <span class="n">msi_init_rfkill</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rfkill_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* add rfkill */</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* keep the hardware wireless state */</span>
	<span class="n">get_wireless_state_ec_standard</span><span class="p">();</span>

	<span class="n">rfk_bluetooth</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="s">&quot;msi-bluetooth&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rfkill_bluetooth_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfk_bluetooth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_bluetooth</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_bluetooth</span><span class="p">;</span>

	<span class="n">rfk_wlan</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="s">&quot;msi-wlan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RFKILL_TYPE_WLAN</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rfkill_wlan_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfk_wlan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_wlan</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">rfk_wlan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_wlan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">threeg_exists</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfk_threeg</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="s">&quot;msi-threeg&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">RFKILL_TYPE_WWAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfkill_threeg_ops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rfk_threeg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_threeg</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="n">rfk_threeg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_threeg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* schedule to run rfkill state initial */</span>
	<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msi_rfkill_init</span><span class="p">,</span>
				<span class="n">round_jiffies_relative</span><span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_threeg:</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfk_threeg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_wlan</span><span class="p">)</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">rfk_wlan</span><span class="p">);</span>
<span class="nl">err_wlan:</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfk_wlan</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">)</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">);</span>
<span class="nl">err_bluetooth:</span>
	<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">rfk_bluetooth</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msi_laptop_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">load_scm_model</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* set load SCM to disable hardware control by fn key */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="n">MSI_STANDARD_EC_SCM_LOAD_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_write</span><span class="p">(</span><span class="n">MSI_STANDARD_EC_SCM_LOAD_ADDRESS</span><span class="p">,</span>
		<span class="n">data</span> <span class="o">|</span> <span class="n">MSI_STANDARD_EC_SCM_LOAD_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">msi_laptop_input_setup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">msi_laptop_input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msi_laptop_input_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">msi_laptop_input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MSI Laptop hotkeys&quot;</span><span class="p">;</span>
	<span class="n">msi_laptop_input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="s">&quot;msi-laptop/input0&quot;</span><span class="p">;</span>
	<span class="n">msi_laptop_input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sparse_keymap_setup</span><span class="p">(</span><span class="n">msi_laptop_input_dev</span><span class="p">,</span>
		<span class="n">msi_laptop_keymap</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">msi_laptop_input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_keymap</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_keymap:</span>
	<span class="n">sparse_keymap_free</span><span class="p">(</span><span class="n">msi_laptop_input_dev</span><span class="p">);</span>
<span class="nl">err_free_dev:</span>
	<span class="n">input_free_device</span><span class="p">(</span><span class="n">msi_laptop_input_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msi_laptop_input_destroy</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sparse_keymap_free</span><span class="p">(</span><span class="n">msi_laptop_input_dev</span><span class="p">);</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">msi_laptop_input_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">load_scm_model_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* allow userland write sysfs file  */</span>
	<span class="n">dev_attr_bluetooth</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store_bluetooth</span><span class="p">;</span>
	<span class="n">dev_attr_wlan</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store_wlan</span><span class="p">;</span>
	<span class="n">dev_attr_threeg</span><span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store_threeg</span><span class="p">;</span>
	<span class="n">dev_attr_bluetooth</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">S_IWUSR</span><span class="p">;</span>
	<span class="n">dev_attr_wlan</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">S_IWUSR</span><span class="p">;</span>
	<span class="n">dev_attr_threeg</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">mode</span> <span class="o">|=</span> <span class="n">S_IWUSR</span><span class="p">;</span>

	<span class="cm">/* disable hardware control by fn key */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_read</span><span class="p">(</span><span class="n">MSI_STANDARD_EC_SCM_LOAD_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">ec_write</span><span class="p">(</span><span class="n">MSI_STANDARD_EC_SCM_LOAD_ADDRESS</span><span class="p">,</span>
		<span class="n">data</span> <span class="o">|</span> <span class="n">MSI_STANDARD_EC_SCM_LOAD_MASK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* initial rfkill */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">rfkill_init</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_rfkill</span><span class="p">;</span>

	<span class="cm">/* setup input device */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">msi_laptop_input_setup</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_input</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">i8042_install_filter</span><span class="p">(</span><span class="n">msi_laptop_i8042_filter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to install key filter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail_filter</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_filter:</span>
	<span class="n">msi_laptop_input_destroy</span><span class="p">();</span>

<span class="nl">fail_input:</span>
	<span class="n">rfkill_cleanup</span><span class="p">();</span>

<span class="nl">fail_rfkill:</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">msi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">force</span> <span class="o">||</span> <span class="n">dmi_check_system</span><span class="p">(</span><span class="n">msi_dmi_table</span><span class="p">))</span>
		<span class="n">old_ec_model</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_ec_model</span><span class="p">)</span>
		<span class="n">get_threeg_exists</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_ec_model</span> <span class="o">&amp;&amp;</span> <span class="n">dmi_check_system</span><span class="p">(</span><span class="n">msi_load_scm_models_dmi_table</span><span class="p">))</span>
		<span class="n">load_scm_model</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auto_brightness</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">auto_brightness</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Register backlight stuff */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_video_backlight_support</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Brightness ignored, must be controlled by ACPI video driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_properties</span><span class="p">));</span>
		<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_PLATFORM</span><span class="p">;</span>
		<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">MSI_LCD_LEVEL_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">msibl_device</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="s">&quot;msi-laptop-bl&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
							 <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msibl_ops</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">msibl_device</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">msibl_device</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msipf_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_backlight</span><span class="p">;</span>

	<span class="cm">/* Register platform stuff */</span>

	<span class="n">msipf_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;msi-laptop-pf&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msipf_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_platform_driver</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">msipf_device</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_platform_device1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">load_scm_model</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">load_scm_model_init</span><span class="p">(</span><span class="n">msipf_device</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_platform_device1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msipf_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">msipf_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_platform_device2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_ec_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">threeg_exists</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msipf_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dev_attr_threeg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail_platform_device2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable automatic brightness control by default because</span>
<span class="cm">	 * this module was probably loaded to do brightness control in</span>
<span class="cm">	 * software. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">auto_brightness</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">set_auto_brightness</span><span class="p">(</span><span class="n">auto_brightness</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;driver &quot;</span> <span class="n">MSI_DRIVER_VERSION</span> <span class="s">&quot; successfully loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_platform_device2:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">load_scm_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i8042_remove_filter</span><span class="p">(</span><span class="n">msi_laptop_i8042_filter</span><span class="p">);</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msi_rfkill_work</span><span class="p">);</span>
		<span class="n">rfkill_cleanup</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">platform_device_del</span><span class="p">(</span><span class="n">msipf_device</span><span class="p">);</span>

<span class="nl">fail_platform_device1:</span>

	<span class="n">platform_device_put</span><span class="p">(</span><span class="n">msipf_device</span><span class="p">);</span>

<span class="nl">fail_platform_driver:</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msipf_driver</span><span class="p">);</span>

<span class="nl">fail_backlight:</span>

	<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">msibl_device</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">msi_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">load_scm_model</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i8042_remove_filter</span><span class="p">(</span><span class="n">msi_laptop_i8042_filter</span><span class="p">);</span>
		<span class="n">msi_laptop_input_destroy</span><span class="p">();</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msi_rfkill_work</span><span class="p">);</span>
		<span class="n">rfkill_cleanup</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msipf_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msipf_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_ec_model</span> <span class="o">&amp;&amp;</span> <span class="n">threeg_exists</span><span class="p">)</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msipf_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_threeg</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">msipf_device</span><span class="p">);</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msipf_driver</span><span class="p">);</span>
	<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">msibl_device</span><span class="p">);</span>

	<span class="cm">/* Enable automatic brightness control again */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auto_brightness</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">set_auto_brightness</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;driver unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">msi_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">msi_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Lennart Poettering&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;MSI Laptop Support&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">MSI_DRIVER_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnMICRO-STARINT&#39;LCO.,LTD:pnMS-1013:pvr0131*:cvnMICRO-STARINT&#39;LCO.,LTD:ct10:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnMicro-StarInternational:pnMS-1058:pvr0581:rvnMSI:rnMS-1058:*:ct10:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnMicro-StarInternational:pnMS-1412:*:rvnMSI:rnMS-1412:*:cvnMICRO-STARINT&#39;LCO.,LTD:ct10:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnNOTEBOOK:pnSAM2000:pvr0131*:cvnMICRO-STARINT&#39;LCO.,LTD:ct10:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnMICRO-STARINTERNATIONAL*:pnMS-N034:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnMICRO-STARINTERNATIONAL*:pnMS-N051:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnMICRO-STARINTERNATIONAL*:pnMS-N014:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnMicro-StarInternational*:pnCR620:*&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;dmi:*:svnMicro-StarInternational*:pnU270series:*&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
