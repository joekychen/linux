<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › platform › x86 › samsung-laptop.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>samsung-laptop.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Samsung Laptop driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009,2011 Greg Kroah-Hartman (gregkh@suse.de)</span>
<span class="cm"> * Copyright (C) 2009,2011 Novell Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/backlight.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/rfkill.h&gt;</span>
<span class="cp">#include &lt;linux/acpi.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#if (defined CONFIG_ACPI_VIDEO || defined CONFIG_ACPI_VIDEO_MODULE)</span>
<span class="cp">#include &lt;acpi/video.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * This driver is needed because a number of Samsung laptops do not hook</span>
<span class="cm"> * their control settings through ACPI.  So we have to poke around in the</span>
<span class="cm"> * BIOS to do things like brightness values, and &quot;special&quot; key controls.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * We have 0 - 8 as valid brightness levels.  The specs say that level 0 should</span>
<span class="cm"> * be reserved by the BIOS (which really doesn&#39;t make much sense), we tell</span>
<span class="cm"> * userspace that the value is 0 - 7 and then just tell the hardware 1 - 8</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_BRIGHT	0x07</span>


<span class="cp">#define SABI_IFACE_MAIN			0x00</span>
<span class="cp">#define SABI_IFACE_SUB			0x02</span>
<span class="cp">#define SABI_IFACE_COMPLETE		0x04</span>
<span class="cp">#define SABI_IFACE_DATA			0x05</span>

<span class="cp">#define WL_STATUS_WLAN			0x0</span>
<span class="cp">#define WL_STATUS_BT			0x2</span>

<span class="cm">/* Structure get/set data using sabi */</span>
<span class="k">struct</span> <span class="n">sabi_data</span> <span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">d0</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">d1</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">d2</span><span class="p">;</span>
			<span class="n">u8</span>  <span class="n">d3</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="p">};</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sabi_header_offsets</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">re_mem</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iface_func</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">en_mem</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data_segment</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sabi_commands</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Brightness is 0 - 8, as described above.</span>
<span class="cm">	 * Value 0 is for the BIOS to use</span>
<span class="cm">	 */</span>
	<span class="n">u16</span> <span class="n">get_brightness</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set_brightness</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * first byte:</span>
<span class="cm">	 * 0x00 - wireless is off</span>
<span class="cm">	 * 0x01 - wireless is on</span>
<span class="cm">	 * second byte:</span>
<span class="cm">	 * 0x02 - 3G is off</span>
<span class="cm">	 * 0x03 - 3G is on</span>
<span class="cm">	 * TODO, verify 3G is correct, that doesn&#39;t seem right...</span>
<span class="cm">	 */</span>
	<span class="n">u16</span> <span class="n">get_wireless_button</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set_wireless_button</span><span class="p">;</span>

	<span class="cm">/* 0 is off, 1 is on */</span>
	<span class="n">u16</span> <span class="n">get_backlight</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set_backlight</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 0x80 or 0x00 - no action</span>
<span class="cm">	 * 0x81 - recovery key pressed</span>
<span class="cm">	 */</span>
	<span class="n">u16</span> <span class="n">get_recovery_mode</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set_recovery_mode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * on seclinux: 0 is low, 1 is high,</span>
<span class="cm">	 * on swsmi: 0 is normal, 1 is silent, 2 is turbo</span>
<span class="cm">	 */</span>
	<span class="n">u16</span> <span class="n">get_performance_level</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set_performance_level</span><span class="p">;</span>

	<span class="cm">/* 0x80 is off, 0x81 is on */</span>
	<span class="n">u16</span> <span class="n">get_battery_life_extender</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set_battery_life_extender</span><span class="p">;</span>

	<span class="cm">/* 0x80 is off, 0x81 is on */</span>
	<span class="n">u16</span> <span class="n">get_usb_charge</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set_usb_charge</span><span class="p">;</span>

	<span class="cm">/* the first byte is for bluetooth and the third one is for wlan */</span>
	<span class="n">u16</span> <span class="n">get_wireless_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set_wireless_status</span><span class="p">;</span>

	<span class="cm">/* 0x81 to read, (0x82 | level &lt;&lt; 8) to set, 0xaabb to enable */</span>
	<span class="n">u16</span> <span class="n">kbd_backlight</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell the BIOS that Linux is running on this machine.</span>
<span class="cm">	 * 81 is on, 80 is off</span>
<span class="cm">	 */</span>
	<span class="n">u16</span> <span class="n">set_linux</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sabi_performance_level</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sabi_config</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">sabi_version</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">test_string</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">main_function</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_header_offsets</span> <span class="n">header_offsets</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="n">commands</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_performance_level</span> <span class="n">performance_levels</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">min_brightness</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_brightness</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="n">sabi_configs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* I don&#39;t know if it is really 2, but it it is</span>
<span class="cm">		 * less than 3 anyway */</span>
		<span class="p">.</span><span class="n">sabi_version</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>

		<span class="p">.</span><span class="n">test_string</span> <span class="o">=</span> <span class="s">&quot;SECLINUX&quot;</span><span class="p">,</span>

		<span class="p">.</span><span class="n">main_function</span> <span class="o">=</span> <span class="mh">0x4c49</span><span class="p">,</span>

		<span class="p">.</span><span class="n">header_offsets</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
			<span class="p">.</span><span class="n">re_mem</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
			<span class="p">.</span><span class="n">iface_func</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
			<span class="p">.</span><span class="n">en_mem</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
			<span class="p">.</span><span class="n">data_offset</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
			<span class="p">.</span><span class="n">data_segment</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">commands</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_brightness</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_wireless_button</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_wireless_button</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_backlight</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_backlight</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_recovery_mode</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_recovery_mode</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_performance_level</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_performance_level</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_battery_life_extender</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_battery_life_extender</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_usb_charge</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_usb_charge</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_wireless_status</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_wireless_status</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>

			<span class="p">.</span><span class="n">kbd_backlight</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">,</span>

			<span class="p">.</span><span class="n">set_linux</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">performance_levels</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;silent&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;normal&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">{</span> <span class="p">},</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">min_brightness</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">sabi_version</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>

		<span class="p">.</span><span class="n">test_string</span> <span class="o">=</span> <span class="s">&quot;SwSmi@&quot;</span><span class="p">,</span>

		<span class="p">.</span><span class="n">main_function</span> <span class="o">=</span> <span class="mh">0x5843</span><span class="p">,</span>

		<span class="p">.</span><span class="n">header_offsets</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
			<span class="p">.</span><span class="n">re_mem</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>
			<span class="p">.</span><span class="n">iface_func</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
			<span class="p">.</span><span class="n">en_mem</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span>
			<span class="p">.</span><span class="n">data_offset</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">,</span>
			<span class="p">.</span><span class="n">data_segment</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">commands</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">get_brightness</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_brightness</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_wireless_button</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_wireless_button</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_backlight</span> <span class="o">=</span> <span class="mh">0x2d</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_backlight</span> <span class="o">=</span> <span class="mh">0x2e</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_recovery_mode</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_recovery_mode</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_performance_level</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_performance_level</span> <span class="o">=</span> <span class="mh">0x32</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_battery_life_extender</span> <span class="o">=</span> <span class="mh">0x65</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_battery_life_extender</span> <span class="o">=</span> <span class="mh">0x66</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_usb_charge</span> <span class="o">=</span> <span class="mh">0x67</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_usb_charge</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>

			<span class="p">.</span><span class="n">get_wireless_status</span> <span class="o">=</span> <span class="mh">0x69</span><span class="p">,</span>
			<span class="p">.</span><span class="n">set_wireless_status</span> <span class="o">=</span> <span class="mh">0x6a</span><span class="p">,</span>

			<span class="p">.</span><span class="n">kbd_backlight</span> <span class="o">=</span> <span class="mh">0x78</span><span class="p">,</span>

			<span class="p">.</span><span class="n">set_linux</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="p">},</span>

		<span class="p">.</span><span class="n">performance_levels</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;normal&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;silent&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">{</span>
				<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;overclock&quot;</span><span class="p">,</span>
				<span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">{</span> <span class="p">},</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">min_brightness</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * samsung-laptop/    - debugfs root directory</span>
<span class="cm"> *   f0000_segment    - dump f0000 segment</span>
<span class="cm"> *   command          - current command</span>
<span class="cm"> *   data             - current data</span>
<span class="cm"> *   d0, d1, d2, d3   - data fields</span>
<span class="cm"> *   call             - call SABI using command and data</span>
<span class="cm"> *</span>
<span class="cm"> * This allow to call arbitrary sabi commands wihout</span>
<span class="cm"> * modifying the driver at all.</span>
<span class="cm"> * For example, setting the keyboard backlight brightness to 5</span>
<span class="cm"> *</span>
<span class="cm"> *  echo 0x78 &gt; command</span>
<span class="cm"> *  echo 0x0582 &gt; d0</span>
<span class="cm"> *  echo 0 &gt; d1</span>
<span class="cm"> *  echo 0 &gt; d2</span>
<span class="cm"> *  echo 0 &gt; d3</span>
<span class="cm"> *  cat call</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">samsung_laptop_debug</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">command</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">debugfs_blob_wrapper</span> <span class="n">f0000_wrapper</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">debugfs_blob_wrapper</span> <span class="n">data_wrapper</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">debugfs_blob_wrapper</span> <span class="n">sdiag_wrapper</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">samsung_laptop</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">samsung_rfkill</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfkill</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">rfkill_type</span> <span class="n">type</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sabi</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">sabi_iface</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">f0000_segment</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">sabi_mutex</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">platform_device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">backlight_device</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">samsung_rfkill</span> <span class="n">wlan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">samsung_rfkill</span> <span class="n">bluetooth</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">led_classdev</span> <span class="n">kbd_led</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kbd_led_wk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">led_workqueue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">kbd_led_work</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">samsung_laptop_debug</span> <span class="n">debug</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">samsung_quirks</span> <span class="o">*</span><span class="n">quirks</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">handle_backlight</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">has_stepping_quirk</span><span class="p">;</span>

	<span class="kt">char</span> <span class="n">sdiag</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">samsung_quirks</span> <span class="p">{</span>
	<span class="n">bool</span> <span class="n">broken_acpi_video</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">samsung_quirks</span> <span class="n">samsung_unknown</span> <span class="o">=</span> <span class="p">{};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">samsung_quirks</span> <span class="n">samsung_broken_acpi_video</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">broken_acpi_video</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">force</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">force</span><span class="p">,</span>
		<span class="s">&quot;Disable the DMI check and forces the driver to be loaded&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug enabled or not&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sabi_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">,</span> <span class="n">u16</span> <span class="n">command</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sabi_data</span> <span class="o">*</span><span class="n">in</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sabi_data</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">port</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">port</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">complete</span><span class="p">,</span> <span class="n">iface_data</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SABI command:0x%04x &quot;</span>
				<span class="s">&quot;data:{0x%08x, 0x%08x, 0x%04x, 0x%02x}&quot;</span><span class="p">,</span>
				<span class="n">command</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">d0</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">d1</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">d2</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">d3</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SABI command:0x%04x&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* enable memory to be able to write to it */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">en_mem</span><span class="p">),</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/* write out the command */</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">main_function</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_MAIN</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_SUB</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_COMPLETE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">d0</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_DATA</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">d1</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_DATA</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">writew</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">d2</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_DATA</span> <span class="o">+</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">d3</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_DATA</span> <span class="o">+</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">iface_func</span><span class="p">),</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/* write protect memory to make it safe */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">re_mem</span><span class="p">),</span> <span class="n">port</span><span class="p">);</span>

	<span class="cm">/* see if the command actually succeeded */</span>
	<span class="n">complete</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_COMPLETE</span><span class="p">);</span>
	<span class="n">iface_data</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_DATA</span><span class="p">);</span>

	<span class="cm">/* iface_data = 0xFF happens when a command is not known</span>
<span class="cm">	 * so we only add a warning in debug mode since we will</span>
<span class="cm">	 * probably issue some unknown command at startup to find</span>
<span class="cm">	 * out which features are supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span> <span class="o">!=</span> <span class="mh">0xaa</span> <span class="o">||</span> <span class="p">(</span><span class="n">iface_data</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">debug</span><span class="p">))</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;SABI command 0x%04x failed with&quot;</span>
			<span class="s">&quot; completion flag 0x%02x and interface data 0x%02x&quot;</span><span class="p">,</span>
			<span class="n">command</span><span class="p">,</span> <span class="n">complete</span><span class="p">,</span> <span class="n">iface_data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">complete</span> <span class="o">!=</span> <span class="mh">0xaa</span> <span class="o">||</span> <span class="n">iface_data</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">d0</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_DATA</span><span class="p">);</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">d1</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_DATA</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">d2</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_DATA</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">out</span><span class="o">-&gt;</span><span class="n">d3</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">+</span> <span class="n">SABI_IFACE_DATA</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;SABI return data:{0x%08x, 0x%08x, 0x%04x, 0x%02x}&quot;</span><span class="p">,</span>
			<span class="n">out</span><span class="o">-&gt;</span><span class="n">d0</span><span class="p">,</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">d1</span><span class="p">,</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">d2</span><span class="p">,</span> <span class="n">out</span><span class="o">-&gt;</span><span class="n">d3</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* simple wrappers usable with most commands */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sabi_set_commandb</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">command</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">in</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="p">{</span> <span class="p">.</span><span class="n">d0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">d1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">d2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">d3</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">}</span> <span class="p">};</span>

	<span class="n">in</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">sretval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">user_brightness</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">get_brightness</span><span class="p">,</span>
			      <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sretval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">user_brightness</span> <span class="o">=</span> <span class="n">sretval</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">user_brightness</span> <span class="o">&gt;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">min_brightness</span><span class="p">)</span>
		<span class="n">user_brightness</span> <span class="o">-=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">min_brightness</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">user_brightness</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">user_brightness</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">,</span> <span class="n">u8</span> <span class="n">user_brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">user_level</span> <span class="o">=</span> <span class="n">user_brightness</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">min_brightness</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">has_stepping_quirk</span> <span class="o">&amp;&amp;</span> <span class="n">user_level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * short circuit if the specified level is what&#39;s already set</span>
<span class="cm">		 * to prevent the screen from flickering needlessly</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">user_brightness</span> <span class="o">==</span> <span class="n">read_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">sabi_set_commandb</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_brightness</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sabi_set_commandb</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_brightness</span><span class="p">,</span> <span class="n">user_level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">bl_get_data</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">read_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_for_stepping_quirk</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">initial_level</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">check_level</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">orig_level</span> <span class="o">=</span> <span class="n">read_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some laptops exhibit the strange behaviour of stepping toward</span>
<span class="cm">	 * (rather than setting) the brightness except when changing to/from</span>
<span class="cm">	 * brightness level 0. This behaviour is checked for here and worked</span>
<span class="cm">	 * around in set_brightness.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">orig_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">set_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">initial_level</span> <span class="o">=</span> <span class="n">read_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initial_level</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">check_level</span> <span class="o">=</span> <span class="n">initial_level</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">check_level</span> <span class="o">=</span> <span class="n">initial_level</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">has_stepping_quirk</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">set_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">check_level</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">)</span> <span class="o">!=</span> <span class="n">check_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">has_stepping_quirk</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;enabled workaround for brightness stepping quirk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">orig_level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">update_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">bl_get_data</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>

	<span class="n">set_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bd</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">==</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">)</span>
		<span class="n">sabi_set_commandb</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_backlight</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sabi_set_commandb</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_backlight</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">backlight_ops</span> <span class="n">backlight_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_brightness</span>	<span class="o">=</span> <span class="n">get_brightness</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_status</span>	<span class="o">=</span> <span class="n">update_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">seclinux_rfkill_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_rfkill</span> <span class="o">*</span><span class="n">srfkill</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">srfkill</span><span class="o">-&gt;</span><span class="n">samsung</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sabi_set_commandb</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_wireless_button</span><span class="p">,</span>
				 <span class="o">!</span><span class="n">blocked</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">seclinux_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">seclinux_rfkill_set</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">swsmi_wireless_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sabi_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">get_wireless_status</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">swsmi_rfkill_set</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_rfkill</span> <span class="o">*</span><span class="n">srfkill</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">srfkill</span><span class="o">-&gt;</span><span class="n">samsung</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">swsmi_wireless_status</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t set the state for non-present devices */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srfkill</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">RFKILL_TYPE_WLAN</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">WL_STATUS_WLAN</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="n">blocked</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srfkill</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">)</span>
		<span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">WL_STATUS_BT</span><span class="p">]</span> <span class="o">=</span> <span class="o">!</span><span class="n">blocked</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_wireless_status</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">swsmi_rfkill_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">rfkill</span> <span class="o">*</span><span class="n">rfkill</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_rfkill</span> <span class="o">*</span><span class="n">srfkill</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">srfkill</span><span class="o">-&gt;</span><span class="n">samsung</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">swsmi_wireless_status</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srfkill</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">RFKILL_TYPE_WLAN</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">WL_STATUS_WLAN</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srfkill</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">WL_STATUS_BT</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">rfkill_set_sw_state</span><span class="p">(</span><span class="n">rfkill</span><span class="p">,</span> <span class="o">!</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="n">swsmi_rfkill_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set_block</span> <span class="o">=</span> <span class="n">swsmi_rfkill_set</span><span class="p">,</span>
	<span class="p">.</span><span class="n">query</span> <span class="o">=</span> <span class="n">swsmi_rfkill_query</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">get_performance_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">sretval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Read the state */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">get_performance_level</span><span class="p">,</span>
			      <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sretval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* The logic is backwards, yeah, lots of fun... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">performance_levels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sretval</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">performance_levels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">performance_levels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="s">&quot;unknown&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_performance_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">performance_levels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_performance_level</span> <span class="o">*</span><span class="n">level</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">performance_levels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">level</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">level</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">sabi_set_commandb</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span>
					  <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_performance_level</span><span class="p">,</span>
					  <span class="n">level</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">performance_levels</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">performance_level</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">get_performance_level</span><span class="p">,</span> <span class="n">set_performance_level</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_battery_life_extender</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">commands</span><span class="o">-&gt;</span><span class="n">get_battery_life_extender</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">get_battery_life_extender</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_battery_life_extender</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_battery_life_extender</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">get_battery_life_extender</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_battery_life_extender</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_battery_life_extender</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">||</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_battery_life_extender</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="o">!!</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">battery_life_extender</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">get_battery_life_extender</span><span class="p">,</span> <span class="n">set_battery_life_extender</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_usb_charge</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">commands</span><span class="o">-&gt;</span><span class="n">get_usb_charge</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">get_usb_charge</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_usb_charge</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">enabled</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="n">enabled</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_usb_charge</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">get_usb_charge</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">read_usb_charge</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">set_usb_charge</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span> <span class="o">||</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">write_usb_charge</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="o">!!</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">usb_charge</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">get_usb_charge</span><span class="p">,</span> <span class="n">set_usb_charge</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">platform_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_performance_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_battery_life_extender</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_usb_charge</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_signature</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">memcheck</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">testStr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loca</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loca</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loca</span> <span class="o">&lt;</span> <span class="mh">0xffff</span><span class="p">;</span> <span class="n">loca</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">memcheck</span> <span class="o">+</span> <span class="n">loca</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">==</span> <span class="n">testStr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">strlen</span><span class="p">(</span><span class="n">testStr</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">++</span><span class="n">i</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">loca</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">samsung_rfkill_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">wlan</span><span class="p">.</span><span class="n">rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">wlan</span><span class="p">.</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">wlan</span><span class="p">.</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">wlan</span><span class="p">.</span><span class="n">rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">bluetooth</span><span class="p">.</span><span class="n">rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_unregister</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">bluetooth</span><span class="p">.</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">bluetooth</span><span class="p">.</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">bluetooth</span><span class="p">.</span><span class="n">rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">samsung_new_rfkill</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">samsung_rfkill</span> <span class="o">*</span><span class="n">arfkill</span><span class="p">,</span>
			      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rfkill_type</span> <span class="n">type</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">rfkill_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rfkill</span> <span class="o">**</span><span class="n">rfkill</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arfkill</span><span class="o">-&gt;</span><span class="n">rfkill</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">arfkill</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">arfkill</span><span class="o">-&gt;</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">samsung</span><span class="p">;</span>

	<span class="o">*</span><span class="n">rfkill</span> <span class="o">=</span> <span class="n">rfkill_alloc</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">type</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">arfkill</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">rfkill</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocked</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">rfkill_init_sw_state</span><span class="p">(</span><span class="o">*</span><span class="n">rfkill</span><span class="p">,</span> <span class="n">blocked</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rfkill_register</span><span class="p">(</span><span class="o">*</span><span class="n">rfkill</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rfkill_destroy</span><span class="p">(</span><span class="o">*</span><span class="n">rfkill</span><span class="p">);</span>
		<span class="o">*</span><span class="n">rfkill</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_rfkill_init_seclinux</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">samsung_new_rfkill</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">wlan</span><span class="p">,</span> <span class="s">&quot;samsung-wlan&quot;</span><span class="p">,</span>
				  <span class="n">RFKILL_TYPE_WLAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">seclinux_rfkill_ops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_rfkill_init_swsmi</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">swsmi_wireless_status</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Some swsmi laptops use the old seclinux way to control</span>
<span class="cm">		 * wireless devices */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_rfkill_init_seclinux</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 0x02 seems to mean that the device is no present/available */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">WL_STATUS_WLAN</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_new_rfkill</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">wlan</span><span class="p">,</span>
					 <span class="s">&quot;samsung-wlan&quot;</span><span class="p">,</span>
					 <span class="n">RFKILL_TYPE_WLAN</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">swsmi_rfkill_ops</span><span class="p">,</span>
					 <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">WL_STATUS_WLAN</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">WL_STATUS_BT</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x02</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_new_rfkill</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">bluetooth</span><span class="p">,</span>
					 <span class="s">&quot;samsung-bluetooth&quot;</span><span class="p">,</span>
					 <span class="n">RFKILL_TYPE_BLUETOOTH</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">swsmi_rfkill_ops</span><span class="p">,</span>
					 <span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">WL_STATUS_BT</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">samsung_rfkill_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_rfkill_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">sabi_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">samsung_rfkill_init_seclinux</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">sabi_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">samsung_rfkill_init_swsmi</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kbd_backlight_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">commands</span><span class="o">-&gt;</span><span class="n">kbd_backlight</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">data</span><span class="p">.</span><span class="n">d0</span> <span class="o">=</span> <span class="mh">0xaabb</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">kbd_backlight</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">d0</span> <span class="o">!=</span> <span class="mh">0xccdd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kbd_backlight_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x81</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">kbd_backlight</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kbd_backlight_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">,</span> <span class="kt">int</span> <span class="n">brightness</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
	<span class="n">data</span><span class="p">.</span><span class="n">d0</span> <span class="o">=</span> <span class="mh">0x82</span> <span class="o">|</span> <span class="p">((</span><span class="n">brightness</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">commands</span><span class="o">-&gt;</span><span class="n">kbd_backlight</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kbd_led_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">;</span>

	<span class="n">samsung</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">samsung_laptop</span><span class="p">,</span> <span class="n">kbd_led_work</span><span class="p">);</span>
	<span class="n">kbd_backlight_write</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led_wk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kbd_led_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">led_brightness</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">;</span>

	<span class="n">samsung</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">samsung_laptop</span><span class="p">,</span> <span class="n">kbd_led</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led</span><span class="p">.</span><span class="n">max_brightness</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led</span><span class="p">.</span><span class="n">max_brightness</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led_wk</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">led_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">led_brightness</span> <span class="nf">kbd_led_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">led_classdev</span> <span class="o">*</span><span class="n">led_cdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">;</span>

	<span class="n">samsung</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">led_cdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">samsung_laptop</span><span class="p">,</span> <span class="n">kbd_led</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">kbd_backlight_read</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">samsung_leds_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led</span><span class="p">.</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">led_classdev_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">led_workqueue</span><span class="p">)</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">led_workqueue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_leds_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">led_workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;led_workqueue&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">led_workqueue</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kbd_backlight_enable</span><span class="p">(</span><span class="n">samsung</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led_work</span><span class="p">,</span> <span class="n">kbd_led_update</span><span class="p">);</span>

		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;samsung::kbd_backlight&quot;</span><span class="p">;</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led</span><span class="p">.</span><span class="n">brightness_set</span> <span class="o">=</span> <span class="n">kbd_led_set</span><span class="p">;</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led</span><span class="p">.</span><span class="n">brightness_get</span> <span class="o">=</span> <span class="n">kbd_led_get</span><span class="p">;</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">led_classdev_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">kbd_led</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">samsung_leds_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">samsung_backlight_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">backlight_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">backlight_device_unregister</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">backlight_device</span><span class="p">);</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">backlight_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_backlight_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">backlight_device</span> <span class="o">*</span><span class="n">bd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">backlight_properties</span> <span class="n">props</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">handle_backlight</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">props</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">backlight_properties</span><span class="p">));</span>
	<span class="n">props</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">BACKLIGHT_PLATFORM</span><span class="p">;</span>
	<span class="n">props</span><span class="p">.</span><span class="n">max_brightness</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">max_brightness</span> <span class="o">-</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">min_brightness</span><span class="p">;</span>

	<span class="n">bd</span> <span class="o">=</span> <span class="n">backlight_device_register</span><span class="p">(</span><span class="s">&quot;samsung&quot;</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">samsung</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">backlight_ops</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">props</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">bd</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">bd</span><span class="p">);</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">backlight_device</span> <span class="o">=</span> <span class="n">bd</span><span class="p">;</span>
	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">backlight_device</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">brightness</span> <span class="o">=</span> <span class="n">read_brightness</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">backlight_device</span><span class="o">-&gt;</span><span class="n">props</span><span class="p">.</span><span class="n">power</span> <span class="o">=</span> <span class="n">FB_BLANK_UNBLANK</span><span class="p">;</span>
	<span class="n">backlight_update_status</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">backlight_device</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">umode_t</span> <span class="nf">samsung_sysfs_is_visible</span><span class="p">(</span><span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">ok</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_performance_level</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="o">!!</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">performance_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_battery_life_extender</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">read_battery_life_extender</span><span class="p">(</span><span class="n">samsung</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">dev_attr_usb_charge</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span>
		<span class="n">ok</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">read_usb_charge</span><span class="p">(</span><span class="n">samsung</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ok</span> <span class="o">?</span> <span class="n">attr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">platform_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">is_visible</span> <span class="o">=</span> <span class="n">samsung_sysfs_is_visible</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">platform_attributes</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">samsung_sysfs_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">;</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_attribute_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_sysfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_attribute_group</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sabi_data</span> <span class="o">*</span><span class="n">sdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;SABI 0x%04x {0x%08x, 0x%08x, 0x%04x, 0x%02x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">command</span><span class="p">,</span>
		   <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">d0</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">d1</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">d2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">d3</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sabi_command</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">command</span><span class="p">,</span> <span class="n">sdata</span><span class="p">,</span> <span class="n">sdata</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;SABI command 0x%04x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;SABI {0x%08x, 0x%08x, 0x%04x, 0x%02x}</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">d0</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">d1</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">d2</span><span class="p">,</span> <span class="n">sdata</span><span class="o">-&gt;</span><span class="n">d3</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">samsung_debugfs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">show_call</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">samsung_laptop_call_io_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">samsung_debugfs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">samsung_debugfs_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">samsung_debugfs_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dent</span><span class="p">;</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;samsung-laptop&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to create debugfs directory&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">f0000_wrapper</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span><span class="p">;</span>
	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">f0000_wrapper</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data_wrapper</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data_wrapper</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">sdiag_wrapper</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sdiag</span><span class="p">;</span>
	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">sdiag_wrapper</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sdiag</span><span class="p">);</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_u16</span><span class="p">(</span><span class="s">&quot;command&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
				  <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;d0&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">d0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_u32</span><span class="p">(</span><span class="s">&quot;d1&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">d1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_u16</span><span class="p">(</span><span class="s">&quot;d2&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">d2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_u8</span><span class="p">(</span><span class="s">&quot;d3&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">d3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_blob</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
				   <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">data_wrapper</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_blob</span><span class="p">(</span><span class="s">&quot;f0000_segment&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
				   <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">f0000_wrapper</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;call&quot;</span><span class="p">,</span> <span class="n">S_IFREG</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				   <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span> <span class="n">samsung</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">samsung_laptop_call_io_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="n">dent</span> <span class="o">=</span> <span class="n">debugfs_create_blob</span><span class="p">(</span><span class="s">&quot;sdiag&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
				   <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">root</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">sdiag_wrapper</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dent</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_debugfs:</span>
	<span class="n">samsung_debugfs_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">samsung_sabi_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="cm">/* Turn off &quot;Linux&quot; mode in the BIOS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;&amp;</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">.</span><span class="n">set_linux</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">sabi_set_commandb</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">.</span><span class="n">set_linux</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span><span class="p">);</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span><span class="p">);</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">void</span> <span class="nf">samsung_sabi_infos</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loca</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ifaceP</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;This computer supports SABI==%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">loca</span> <span class="o">+</span> <span class="mh">0xf0000</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SABI header:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SMI Port Number = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readw</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">port</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SMI Interface Function = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">iface_func</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SMI enable memory buffer = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">en_mem</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SMI restore memory buffer = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">re_mem</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SABI data offset = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readw</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">data_offset</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SABI data segment = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">readw</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">data_segment</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot; SABI pointer = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifaceP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">samsung_sabi_diag</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">loca</span> <span class="o">=</span> <span class="n">find_signature</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span><span class="p">,</span> <span class="s">&quot;SDiaG@&quot;</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loca</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="cm">/* Example:</span>
<span class="cm">	 * Ident: @SDiaG@686XX-N90X3A/966-SEC-07HL-S90X3A</span>
<span class="cm">	 *</span>
<span class="cm">	 * Product name: 90X3A</span>
<span class="cm">	 * BIOS Version: 07HL</span>
<span class="cm">	 */</span>
	<span class="n">loca</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loca</span> <span class="o">&lt;</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sdiag</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">loca</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span> <span class="o">+</span> <span class="n">loca</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isalnum</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">||</span> <span class="n">temp</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="o">||</span> <span class="n">temp</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>
			<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sdiag</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sdiag</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;sdiag: %s&quot;</span><span class="p">,</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sdiag</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_sabi_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">sabi_commands</span> <span class="o">*</span><span class="n">commands</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ifaceP</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loca</span><span class="p">;</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="mh">0xf0000</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">||</span> <span class="n">force</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t map the segment at 0xf0000</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">samsung_sabi_diag</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>

	<span class="cm">/* Try to find one of the signatures in memory to find the header */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sabi_configs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">test_string</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sabi_configs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">loca</span> <span class="o">=</span> <span class="n">find_signature</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span><span class="p">,</span>
				      <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">test_string</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loca</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loca</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">||</span> <span class="n">force</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;This computer does not support SABI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="n">commands</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">commands</span><span class="p">;</span>

	<span class="cm">/* point to the SMI port Number */</span>
	<span class="n">loca</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">=</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">f0000_segment</span> <span class="o">+</span> <span class="n">loca</span><span class="p">);</span>

	<span class="cm">/* Get a pointer to the SABI Interface */</span>
	<span class="n">ifaceP</span> <span class="o">=</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">data_segment</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0ffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ifaceP</span> <span class="o">+=</span> <span class="n">readw</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi</span> <span class="o">+</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">header_offsets</span><span class="p">.</span><span class="n">data_offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0ffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">samsung_sabi_infos</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span> <span class="n">loca</span><span class="p">,</span> <span class="n">ifaceP</span><span class="p">);</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">ifaceP</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_iface</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Can&#39;t remap %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifaceP</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Turn on &quot;Linux&quot; mode in the BIOS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_linux</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">sabi_set_commandb</span><span class="p">(</span><span class="n">samsung</span><span class="p">,</span>
					       <span class="n">commands</span><span class="o">-&gt;</span><span class="n">set_linux</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Linux mode was not set!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check for stepping quirk */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">handle_backlight</span><span class="p">)</span>
		<span class="n">check_for_stepping_quirk</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;detected SABI interface: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">test_string</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">samsung_sabi_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">samsung_platform_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">);</span>
		<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_platform_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="s">&quot;samsung&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">,</span> <span class="n">samsung</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">samsung_quirks</span> <span class="o">*</span><span class="n">quirks</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_dmi_matched</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="o">*</span><span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">quirks</span> <span class="o">=</span> <span class="n">d</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dmi_system_id</span> <span class="n">__initdata</span> <span class="n">samsung_dmi_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
					<span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_TYPE</span><span class="p">,</span> <span class="s">&quot;8&quot;</span><span class="p">),</span> <span class="cm">/* Portable */</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
					<span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_TYPE</span><span class="p">,</span> <span class="s">&quot;9&quot;</span><span class="p">),</span> <span class="cm">/* Laptop */</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
					<span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_TYPE</span><span class="p">,</span> <span class="s">&quot;10&quot;</span><span class="p">),</span> <span class="cm">/* Notebook */</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span>
					<span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
			<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_CHASSIS_TYPE</span><span class="p">,</span> <span class="s">&quot;14&quot;</span><span class="p">),</span> <span class="cm">/* Sub-Notebook */</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="cm">/* Specific DMI ids for laptop with quirks */</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">samsung_dmi_matched</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;N150P&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;N150P&quot;</span><span class="p">),</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;N150P&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung_broken_acpi_video</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">samsung_dmi_matched</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;N145P/N250P/N260P&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;N145P/N250P/N260P&quot;</span><span class="p">),</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;N145P/N250P/N260P&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung_broken_acpi_video</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">samsung_dmi_matched</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;N150/N210/N220&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;N150/N210/N220&quot;</span><span class="p">),</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;N150/N210/N220&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung_broken_acpi_video</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="n">samsung_dmi_matched</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">ident</span> <span class="o">=</span> <span class="s">&quot;NF110/NF210/NF310&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">matches</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_SYS_VENDOR</span><span class="p">,</span> <span class="s">&quot;SAMSUNG ELECTRONICS CO., LTD.&quot;</span><span class="p">),</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_PRODUCT_NAME</span><span class="p">,</span> <span class="s">&quot;NF110/NF210/NF310&quot;</span><span class="p">),</span>
		<span class="n">DMI_MATCH</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">,</span> <span class="s">&quot;NF110/NF210/NF310&quot;</span><span class="p">),</span>
		<span class="p">},</span>
	 <span class="p">.</span><span class="n">driver_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung_broken_acpi_video</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">dmi</span><span class="p">,</span> <span class="n">samsung_dmi_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">samsung_platform_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">samsung_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">quirks</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">samsung_unknown</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dmi_check_system</span><span class="p">(</span><span class="n">samsung_dmi_table</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">samsung</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">samsung</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">samsung</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">sabi_mutex</span><span class="p">);</span>
	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">handle_backlight</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">=</span> <span class="n">quirks</span><span class="p">;</span>


<span class="cp">#if (defined CONFIG_ACPI_VIDEO || defined CONFIG_ACPI_VIDEO_MODULE)</span>
	<span class="cm">/* Don&#39;t handle backlight here if the acpi video already handle it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_video_backlight_support</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">broken_acpi_video</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Disabling ACPI video driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">acpi_video_unregister</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">samsung</span><span class="o">-&gt;</span><span class="n">handle_backlight</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_platform_init</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_platform</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_sabi_init</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_sabi</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ACPI</span>
	<span class="cm">/* Only log that if we are really on a sabi platform */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">acpi_video_backlight_support</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">samsung</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="o">-&gt;</span><span class="n">broken_acpi_video</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Backlight controlled by ACPI video driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_sysfs_init</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_sysfs</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_backlight_init</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_backlight</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_rfkill_init</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_rfkill</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_leds_init</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_leds</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">samsung_debugfs_init</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_debugfs</span><span class="p">;</span>

	<span class="n">samsung_platform_device</span> <span class="o">=</span> <span class="n">samsung</span><span class="o">-&gt;</span><span class="n">platform_device</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error_debugfs:</span>
	<span class="n">samsung_leds_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
<span class="nl">error_leds:</span>
	<span class="n">samsung_rfkill_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
<span class="nl">error_rfkill:</span>
	<span class="n">samsung_backlight_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
<span class="nl">error_backlight:</span>
	<span class="n">samsung_sysfs_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
<span class="nl">error_sysfs:</span>
	<span class="n">samsung_sabi_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
<span class="nl">error_sabi:</span>
	<span class="n">samsung_platform_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
<span class="nl">error_platform:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">samsung_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">samsung_laptop</span> <span class="o">*</span><span class="n">samsung</span><span class="p">;</span>

	<span class="n">samsung</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">samsung_platform_device</span><span class="p">);</span>

	<span class="n">samsung_debugfs_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="n">samsung_leds_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="n">samsung_rfkill_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="n">samsung_backlight_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="n">samsung_sysfs_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="n">samsung_sabi_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="n">samsung_platform_exit</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">samsung</span><span class="p">);</span>
	<span class="n">samsung_platform_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">samsung_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">samsung_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Greg Kroah-Hartman &lt;gregkh@suse.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Samsung Backlight driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
