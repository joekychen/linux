<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › atm › he.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>he.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">  he.c</span>

<span class="cm">  ForeRunnerHE ATM Adapter driver for ATM on Linux</span>
<span class="cm">  Copyright (C) 1999-2001  Naval Research Laboratory</span>

<span class="cm">  This library is free software; you can redistribute it and/or</span>
<span class="cm">  modify it under the terms of the GNU Lesser General Public</span>
<span class="cm">  License as published by the Free Software Foundation; either</span>
<span class="cm">  version 2.1 of the License, or (at your option) any later version.</span>

<span class="cm">  This library is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm">  Lesser General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU Lesser General Public</span>
<span class="cm">  License along with this library; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm">*/</span>

<span class="cm">/*</span>

<span class="cm">  he.c</span>

<span class="cm">  ForeRunnerHE ATM Adapter driver for ATM on Linux</span>
<span class="cm">  Copyright (C) 1999-2001  Naval Research Laboratory</span>

<span class="cm">  Permission to use, copy, modify and distribute this software and its</span>
<span class="cm">  documentation is hereby granted, provided that both the copyright</span>
<span class="cm">  notice and this permission notice appear in all copies of the software,</span>
<span class="cm">  derivative works or modified versions, and any portions thereof, and</span>
<span class="cm">  that both notices appear in supporting documentation.</span>

<span class="cm">  NRL ALLOWS FREE USE OF THIS SOFTWARE IN ITS &quot;AS IS&quot; CONDITION AND</span>
<span class="cm">  DISCLAIMS ANY LIABILITY OF ANY KIND FOR ANY DAMAGES WHATSOEVER</span>
<span class="cm">  RESULTING FROM THE USE OF THIS SOFTWARE.</span>

<span class="cm">  This driver was written using the &quot;Programmer&#39;s Reference Manual for</span>
<span class="cm">  ForeRunnerHE(tm)&quot;, MANU0361-01 - Rev. A, 08/21/98.</span>

<span class="cm">  AUTHORS:</span>
<span class="cm">	chas williams &lt;chas@cmf.nrl.navy.mil&gt;</span>
<span class="cm">	eric kinzie &lt;ekinzie@cmf.nrl.navy.mil&gt;</span>

<span class="cm">  NOTES:</span>
<span class="cm">	4096 supported &#39;connections&#39;</span>
<span class="cm">	group 0 is used for all traffic</span>
<span class="cm">	interrupt queue 0 is used for all interrupts</span>
<span class="cm">	aal0 support (based on work from ulrich.u.muller@nokia.com)</span>

<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/bitmap.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;linux/atm.h&gt;</span>
<span class="cp">#include &lt;linux/sonet.h&gt;</span>

<span class="cp">#undef USE_SCATTERGATHER</span>
<span class="cp">#undef USE_CHECKSUM_HW			</span><span class="cm">/* still confused about this */</span><span class="cp"></span>
<span class="cm">/* #undef HE_DEBUG */</span>

<span class="cp">#include &quot;he.h&quot;</span>
<span class="cp">#include &quot;suni.h&quot;</span>
<span class="cp">#include &lt;linux/atm_he.h&gt;</span>

<span class="cp">#define hprintk(fmt,args...)	printk(KERN_ERR DEV_LABEL &quot;%d: &quot; fmt, he_dev-&gt;number , ##args)</span>

<span class="cp">#ifdef HE_DEBUG</span>
<span class="cp">#define HPRINTK(fmt,args...)	printk(KERN_DEBUG DEV_LABEL &quot;%d: &quot; fmt, he_dev-&gt;number , ##args)</span>
<span class="cp">#else </span><span class="cm">/* !HE_DEBUG */</span><span class="cp"></span>
<span class="cp">#define HPRINTK(fmt,args...)	do { } while (0)</span>
<span class="cp">#endif </span><span class="cm">/* HE_DEBUG */</span><span class="cp"></span>

<span class="cm">/* declarations */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">he_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">he_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">he_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">he_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">he_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">he_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">he_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">he_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">he_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">he_phy_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">he_phy_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">read_prom_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">);</span>

<span class="cm">/* globals */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_devs</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">disable64</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">short</span> <span class="n">nvpibits</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">short</span> <span class="n">nvcibits</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">short</span> <span class="n">rx_skb_reserve</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">irq_coalesce</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">sdh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Read from EEPROM = 0000 0011b */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">readtab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CS_HIGH</span> <span class="o">|</span> <span class="n">CLK_HIGH</span><span class="p">,</span>
	<span class="n">CS_LOW</span> <span class="o">|</span> <span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>               <span class="cm">/* 0 */</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>               <span class="cm">/* 0 */</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>               <span class="cm">/* 0 */</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>               <span class="cm">/* 0 */</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>               <span class="cm">/* 0 */</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>               <span class="cm">/* 0 */</span>
	<span class="n">CLK_LOW</span> <span class="o">|</span> <span class="n">SI_HIGH</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span> <span class="o">|</span> <span class="n">SI_HIGH</span><span class="p">,</span>     <span class="cm">/* 1 */</span>
	<span class="n">CLK_LOW</span> <span class="o">|</span> <span class="n">SI_HIGH</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span> <span class="o">|</span> <span class="n">SI_HIGH</span>      <span class="cm">/* 1 */</span>
<span class="p">};</span>     
 
<span class="cm">/* Clock to read from/write to the EEPROM */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">clocktab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>
	<span class="n">CLK_LOW</span><span class="p">,</span>
	<span class="n">CLK_HIGH</span><span class="p">,</span>
	<span class="n">CLK_LOW</span>
<span class="p">};</span>     

<span class="k">static</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">he_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">he_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>	<span class="n">he_close</span><span class="p">,</span>	
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>	<span class="n">he_ioctl</span><span class="p">,</span>	
	<span class="p">.</span><span class="n">send</span> <span class="o">=</span>		<span class="n">he_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_put</span> <span class="o">=</span>	<span class="n">he_phy_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_get</span> <span class="o">=</span>	<span class="n">he_phy_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_read</span> <span class="o">=</span>	<span class="n">he_proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span>
<span class="p">};</span>

<span class="cp">#define he_writel(dev, val, reg)	do { writel(val, (dev)-&gt;membase + (reg)); wmb(); } while (0)</span>
<span class="cp">#define he_readl(dev, reg)		readl((dev)-&gt;membase + (reg))</span>

<span class="cm">/* section 2.12 connection memory access */</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span>
<span class="nf">he_writel_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">addr</span><span class="p">,</span>
								<span class="kt">unsigned</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">CON_DAT</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CON_DAT</span><span class="p">);</span>		<span class="cm">/* flush posted writes */</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">CON_CTL_WRITE</span> <span class="o">|</span> <span class="n">CON_CTL_ADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">CON_CTL</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CON_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CON_CTL_BUSY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define he_writel_rcm(dev, val, reg) 				\</span>
<span class="cp">			he_writel_internal(dev, val, reg, CON_CTL_RCM)</span>

<span class="cp">#define he_writel_tcm(dev, val, reg) 				\</span>
<span class="cp">			he_writel_internal(dev, val, reg, CON_CTL_TCM)</span>

<span class="cp">#define he_writel_mbox(dev, val, reg) 				\</span>
<span class="cp">			he_writel_internal(dev, val, reg, CON_CTL_MBOX)</span>

<span class="k">static</span> <span class="kt">unsigned</span>
<span class="nf">he_readl_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">CON_CTL_READ</span> <span class="o">|</span> <span class="n">CON_CTL_ADDR</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">CON_CTL</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CON_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CON_CTL_BUSY</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CON_DAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define he_readl_rcm(dev, reg) \</span>
<span class="cp">			he_readl_internal(dev, reg, CON_CTL_RCM)</span>

<span class="cp">#define he_readl_tcm(dev, reg) \</span>
<span class="cp">			he_readl_internal(dev, reg, CON_CTL_TCM)</span>

<span class="cp">#define he_readl_mbox(dev, reg) \</span>
<span class="cp">			he_readl_internal(dev, reg, CON_CTL_MBOX)</span>


<span class="cm">/* figure 2.2 connection id */</span>

<span class="cp">#define he_mkcid(dev, vpi, vci)		(((vpi &lt;&lt; (dev)-&gt;vcibits) | vci) &amp; 0x1fff)</span>

<span class="cm">/* 2.5.1 per connection transmit state registers */</span>

<span class="cp">#define he_writel_tsr0(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRA | (cid &lt;&lt; 3) | 0)</span>
<span class="cp">#define he_readl_tsr0(dev, cid) \</span>
<span class="cp">		he_readl_tcm(dev, CONFIG_TSRA | (cid &lt;&lt; 3) | 0)</span>

<span class="cp">#define he_writel_tsr1(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRA | (cid &lt;&lt; 3) | 1)</span>

<span class="cp">#define he_writel_tsr2(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRA | (cid &lt;&lt; 3) | 2)</span>

<span class="cp">#define he_writel_tsr3(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRA | (cid &lt;&lt; 3) | 3)</span>

<span class="cp">#define he_writel_tsr4(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRA | (cid &lt;&lt; 3) | 4)</span>

	<span class="cm">/* from page 2-20</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE While the transmit connection is active, bits 23 through 0</span>
<span class="cm">	 *      of this register must not be written by the host.  Byte</span>
<span class="cm">	 *      enables should be used during normal operation when writing</span>
<span class="cm">	 *      the most significant byte.</span>
<span class="cm">	 */</span>

<span class="cp">#define he_writel_tsr4_upper(dev, val, cid) \</span>
<span class="cp">		he_writel_internal(dev, val, CONFIG_TSRA | (cid &lt;&lt; 3) | 4, \</span>
<span class="cp">							CON_CTL_TCM \</span>
<span class="cp">							| CON_BYTE_DISABLE_2 \</span>
<span class="cp">							| CON_BYTE_DISABLE_1 \</span>
<span class="cp">							| CON_BYTE_DISABLE_0)</span>

<span class="cp">#define he_readl_tsr4(dev, cid) \</span>
<span class="cp">		he_readl_tcm(dev, CONFIG_TSRA | (cid &lt;&lt; 3) | 4)</span>

<span class="cp">#define he_writel_tsr5(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRA | (cid &lt;&lt; 3) | 5)</span>

<span class="cp">#define he_writel_tsr6(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRA | (cid &lt;&lt; 3) | 6)</span>

<span class="cp">#define he_writel_tsr7(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRA | (cid &lt;&lt; 3) | 7)</span>


<span class="cp">#define he_writel_tsr8(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRB | (cid &lt;&lt; 2) | 0)</span>

<span class="cp">#define he_writel_tsr9(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRB | (cid &lt;&lt; 2) | 1)</span>

<span class="cp">#define he_writel_tsr10(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRB | (cid &lt;&lt; 2) | 2)</span>

<span class="cp">#define he_writel_tsr11(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRB | (cid &lt;&lt; 2) | 3)</span>


<span class="cp">#define he_writel_tsr12(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRC | (cid &lt;&lt; 1) | 0)</span>

<span class="cp">#define he_writel_tsr13(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRC | (cid &lt;&lt; 1) | 1)</span>


<span class="cp">#define he_writel_tsr14(dev, val, cid) \</span>
<span class="cp">		he_writel_tcm(dev, val, CONFIG_TSRD | cid)</span>

<span class="cp">#define he_writel_tsr14_upper(dev, val, cid) \</span>
<span class="cp">		he_writel_internal(dev, val, CONFIG_TSRD | cid, \</span>
<span class="cp">							CON_CTL_TCM \</span>
<span class="cp">							| CON_BYTE_DISABLE_2 \</span>
<span class="cp">							| CON_BYTE_DISABLE_1 \</span>
<span class="cp">							| CON_BYTE_DISABLE_0)</span>

<span class="cm">/* 2.7.1 per connection receive state registers */</span>

<span class="cp">#define he_writel_rsr0(dev, val, cid) \</span>
<span class="cp">		he_writel_rcm(dev, val, 0x00000 | (cid &lt;&lt; 3) | 0)</span>
<span class="cp">#define he_readl_rsr0(dev, cid) \</span>
<span class="cp">		he_readl_rcm(dev, 0x00000 | (cid &lt;&lt; 3) | 0)</span>

<span class="cp">#define he_writel_rsr1(dev, val, cid) \</span>
<span class="cp">		he_writel_rcm(dev, val, 0x00000 | (cid &lt;&lt; 3) | 1)</span>

<span class="cp">#define he_writel_rsr2(dev, val, cid) \</span>
<span class="cp">		he_writel_rcm(dev, val, 0x00000 | (cid &lt;&lt; 3) | 2)</span>

<span class="cp">#define he_writel_rsr3(dev, val, cid) \</span>
<span class="cp">		he_writel_rcm(dev, val, 0x00000 | (cid &lt;&lt; 3) | 3)</span>

<span class="cp">#define he_writel_rsr4(dev, val, cid) \</span>
<span class="cp">		he_writel_rcm(dev, val, 0x00000 | (cid &lt;&lt; 3) | 4)</span>

<span class="cp">#define he_writel_rsr5(dev, val, cid) \</span>
<span class="cp">		he_writel_rcm(dev, val, 0x00000 | (cid &lt;&lt; 3) | 5)</span>

<span class="cp">#define he_writel_rsr6(dev, val, cid) \</span>
<span class="cp">		he_writel_rcm(dev, val, 0x00000 | (cid &lt;&lt; 3) | 6)</span>

<span class="cp">#define he_writel_rsr7(dev, val, cid) \</span>
<span class="cp">		he_writel_rcm(dev, val, 0x00000 | (cid &lt;&lt; 3) | 7)</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span>
<span class="nf">__find_vcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">vpi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vci</span><span class="p">;</span>

	<span class="n">vpi</span> <span class="o">=</span> <span class="n">cid</span> <span class="o">&gt;&gt;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">;</span>
	<span class="n">vci</span> <span class="o">=</span> <span class="n">cid</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcc_hash</span><span class="p">[</span><span class="n">vci</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">VCC_HTABLE_SIZE</span> <span class="o">-</span><span class="mi">1</span><span class="p">)];</span>

	<span class="n">sk_for_each</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcc</span> <span class="o">=</span> <span class="n">atm_sk</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">==</span> <span class="n">vci</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">==</span> <span class="n">vpi</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">vcc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">he_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ATM he driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;he: no suitable dma available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_one_failure</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atm_dev</span> <span class="o">=</span> <span class="n">atm_dev_register</span><span class="p">(</span><span class="n">DEV_LABEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_ops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_one_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">atm_dev</span><span class="p">);</span>

	<span class="n">he_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span><span class="p">),</span>
							<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">he_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_one_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span> <span class="o">=</span> <span class="n">atm_dev</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">he_dev</span><span class="p">;</span>
	<span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">he_dev</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">he_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">he_dev</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_start</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">he_stop</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init_one_failure</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_devs</span><span class="p">)</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">he_devs</span><span class="p">;</span>
	<span class="n">he_devs</span> <span class="o">=</span> <span class="n">he_dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">init_one_failure:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atm_dev</span><span class="p">)</span>
		<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">he_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">;</span>

	<span class="n">atm_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">he_dev</span> <span class="o">=</span> <span class="n">HE_DEV</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">);</span>

	<span class="cm">/* need to remove from he_devs */</span>

	<span class="n">he_stop</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>
	<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span>
<span class="nf">rate_to_atmf</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">rate</span><span class="p">)</span>		<span class="cm">/* cps to atm forum format */</span>
<span class="p">{</span>
<span class="cp">#define NONZERO (1 &lt;&lt; 14)</span>

	<span class="kt">unsigned</span> <span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">&lt;&lt;=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mh">0x3ff</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">exp</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">NONZERO</span> <span class="o">|</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">he_init_rx_lbfp0</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">lbm_offset</span><span class="p">,</span> <span class="n">lbufd_index</span><span class="p">,</span> <span class="n">lbuf_addr</span><span class="p">,</span> <span class="n">lbuf_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lbufs_per_row</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_row</span> <span class="o">/</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lbuf_bufsize</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span> <span class="o">*</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">row_offset</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_startrow</span> <span class="o">*</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">bytes_per_row</span><span class="p">;</span>
	
	<span class="n">lbufd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lbm_offset</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RCMLBM_BA</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbufd_index</span><span class="p">,</span> <span class="n">RLBF0_H</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lbuf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_numbuffs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbufd_index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">lbuf_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">row_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">lbuf_count</span> <span class="o">*</span> <span class="n">lbuf_bufsize</span><span class="p">))</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbuf_addr</span><span class="p">,</span> <span class="n">lbm_offset</span><span class="p">);</span>
		<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbufd_index</span><span class="p">,</span> <span class="n">lbm_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lbuf_count</span> <span class="o">==</span> <span class="n">lbufs_per_row</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lbuf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">row_offset</span> <span class="o">+=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">bytes_per_row</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lbm_offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbufd_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">RLBF0_T</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_numbuffs</span><span class="p">,</span> <span class="n">RLBF0_C</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">he_init_rx_lbfp1</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">lbm_offset</span><span class="p">,</span> <span class="n">lbufd_index</span><span class="p">,</span> <span class="n">lbuf_addr</span><span class="p">,</span> <span class="n">lbuf_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lbufs_per_row</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_row</span> <span class="o">/</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lbuf_bufsize</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span> <span class="o">*</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">row_offset</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_startrow</span> <span class="o">*</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">bytes_per_row</span><span class="p">;</span>
	
	<span class="n">lbufd_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lbm_offset</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RCMLBM_BA</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lbufd_index</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbufd_index</span><span class="p">,</span> <span class="n">RLBF1_H</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lbuf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_numbuffs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbufd_index</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">lbuf_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">row_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">lbuf_count</span> <span class="o">*</span> <span class="n">lbuf_bufsize</span><span class="p">))</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbuf_addr</span><span class="p">,</span> <span class="n">lbm_offset</span><span class="p">);</span>
		<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbufd_index</span><span class="p">,</span> <span class="n">lbm_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lbuf_count</span> <span class="o">==</span> <span class="n">lbufs_per_row</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lbuf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">row_offset</span> <span class="o">+=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">bytes_per_row</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lbm_offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbufd_index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">RLBF1_T</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_numbuffs</span><span class="p">,</span> <span class="n">RLBF1_C</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">he_init_tx_lbfp</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">lbm_offset</span><span class="p">,</span> <span class="n">lbufd_index</span><span class="p">,</span> <span class="n">lbuf_addr</span><span class="p">,</span> <span class="n">lbuf_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lbufs_per_row</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_row</span> <span class="o">/</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">lbuf_bufsize</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span> <span class="o">*</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">row_offset</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_startrow</span> <span class="o">*</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">bytes_per_row</span><span class="p">;</span>
	
	<span class="n">lbufd_index</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_numbuffs</span> <span class="o">+</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_numbuffs</span><span class="p">;</span>
	<span class="n">lbm_offset</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RCMLBM_BA</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">lbufd_index</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbufd_index</span><span class="p">,</span> <span class="n">TLBF_H</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lbuf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_numbuffs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbufd_index</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">lbuf_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">row_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">lbuf_count</span> <span class="o">*</span> <span class="n">lbuf_bufsize</span><span class="p">))</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbuf_addr</span><span class="p">,</span> <span class="n">lbm_offset</span><span class="p">);</span>
		<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbufd_index</span><span class="p">,</span> <span class="n">lbm_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">lbuf_count</span> <span class="o">==</span> <span class="n">lbufs_per_row</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lbuf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">row_offset</span> <span class="o">+=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">bytes_per_row</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lbm_offset</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
		
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lbufd_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TLBF_T</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">he_init_tpdrq</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_base</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="n">CONFIG_TPDRQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_tpdrq</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;failed to alloc tpdrq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">CONFIG_TPDRQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_tpdrq</span><span class="p">));</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_tail</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_base</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_head</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_base</span><span class="p">;</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_phys</span><span class="p">,</span> <span class="n">TPDRQ_B_H</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TPDRQ_T</span><span class="p">);</span>	
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CONFIG_TPDRQ_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">TPDRQ_S</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">he_init_cs_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">clock</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* 5.1.7 cs block initialization */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">;</span> <span class="o">++</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">CS_STTIM0</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* rate grid timer reload values */</span>

	<span class="n">clock</span> <span class="o">=</span> <span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="mi">66667000</span> <span class="o">:</span> <span class="mi">50000000</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">link_rate</span><span class="p">;</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">16</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">;</span> <span class="o">++</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 2.4 internal transmit function</span>
<span class="cm">		 *</span>
<span class="cm">	 	 * we initialize the first row in the rate grid.</span>
<span class="cm">		 * values are period (in clock cycles) of timer</span>
<span class="cm">		 */</span>
		<span class="kt">unsigned</span> <span class="n">period</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">/</span> <span class="n">rate</span><span class="p">;</span>

		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">CS_TGRLD0</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">rate</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* table 5.2 (4 cells per lbuf) */</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000800fa</span><span class="p">,</span> <span class="n">CS_ERTHR0</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000c33cb</span><span class="p">,</span> <span class="n">CS_ERTHR1</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0010101b</span><span class="p">,</span> <span class="n">CS_ERTHR2</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x00181dac</span><span class="p">,</span> <span class="n">CS_ERTHR3</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x00280600</span><span class="p">,</span> <span class="n">CS_ERTHR4</span><span class="p">);</span>

		<span class="cm">/* table 5.3, 5.4, 5.5, 5.6, 5.7 */</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x023de8b3</span><span class="p">,</span> <span class="n">CS_ERCTL0</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x1801</span><span class="p">,</span> <span class="n">CS_ERCTL1</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x68b3</span><span class="p">,</span> <span class="n">CS_ERCTL2</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x1280</span><span class="p">,</span> <span class="n">CS_ERSTAT0</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x68b3</span><span class="p">,</span> <span class="n">CS_ERSTAT1</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x14585</span><span class="p">,</span> <span class="n">CS_RTFWR</span><span class="p">);</span>

		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x4680</span><span class="p">,</span> <span class="n">CS_RTATR</span><span class="p">);</span>

		<span class="cm">/* table 5.8 */</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x00159ece</span><span class="p">,</span> <span class="n">CS_TFBSET</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x68b3</span><span class="p">,</span> <span class="n">CS_WCRMAX</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x5eb3</span><span class="p">,</span> <span class="n">CS_WCRMIN</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0xe8b3</span><span class="p">,</span> <span class="n">CS_WCRINC</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0xdeb3</span><span class="p">,</span> <span class="n">CS_WCRDEC</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x68b3</span><span class="p">,</span> <span class="n">CS_WCRCEIL</span><span class="p">);</span>

		<span class="cm">/* table 5.9 */</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="n">CS_OTPPER</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="n">CS_OTWPER</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* table 5.1 (4 cells per lbuf) */</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000400ea</span><span class="p">,</span> <span class="n">CS_ERTHR0</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x00063388</span><span class="p">,</span> <span class="n">CS_ERTHR1</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x00081018</span><span class="p">,</span> <span class="n">CS_ERTHR2</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000c1dac</span><span class="p">,</span> <span class="n">CS_ERTHR3</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0014051a</span><span class="p">,</span> <span class="n">CS_ERTHR4</span><span class="p">);</span>

		<span class="cm">/* table 5.3, 5.4, 5.5, 5.6, 5.7 */</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0235e4b1</span><span class="p">,</span> <span class="n">CS_ERCTL0</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x4701</span><span class="p">,</span> <span class="n">CS_ERCTL1</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x64b1</span><span class="p">,</span> <span class="n">CS_ERCTL2</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x1280</span><span class="p">,</span> <span class="n">CS_ERSTAT0</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x64b1</span><span class="p">,</span> <span class="n">CS_ERSTAT1</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0xf424</span><span class="p">,</span> <span class="n">CS_RTFWR</span><span class="p">);</span>

		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x4680</span><span class="p">,</span> <span class="n">CS_RTATR</span><span class="p">);</span>

		<span class="cm">/* table 5.8 */</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000563b7</span><span class="p">,</span> <span class="n">CS_TFBSET</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x64b1</span><span class="p">,</span> <span class="n">CS_WCRMAX</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x5ab1</span><span class="p">,</span> <span class="n">CS_WCRMIN</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0xe4b1</span><span class="p">,</span> <span class="n">CS_WCRINC</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0xdab1</span><span class="p">,</span> <span class="n">CS_WCRDEC</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x64b1</span><span class="p">,</span> <span class="n">CS_WCRCEIL</span><span class="p">);</span>

		<span class="cm">/* table 5.9 */</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="n">CS_OTPPER</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="n">CS_OTWPER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="n">CS_OTTLIM</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x8</span><span class="p">;</span> <span class="o">++</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">CS_HGRRT0</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">he_init_cs_block_rcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="p">(</span><span class="o">*</span><span class="n">rategrid</span><span class="p">)[</span><span class="mi">16</span><span class="p">][</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">rate</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="n">rate_atmf</span><span class="p">,</span> <span class="n">exp</span><span class="p">,</span> <span class="n">man</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">rate_cps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mult</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_limit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">rategrid</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rategrid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* initialize rate grid group table */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="o">++</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">CONFIG_RCMABR</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* initialize rate controller groups */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x1ff</span><span class="p">;</span> <span class="o">++</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">CONFIG_RCMABR</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	
	<span class="cm">/* initialize tNrm lookup table */</span>

	<span class="cm">/* the manual makes reference to a routine in a sample driver</span>
<span class="cm">	   for proper configuration; fortunately, we only need this</span>
<span class="cm">	   in order to support abr connection */</span>
	
	<span class="cm">/* initialize rate to group table */</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">link_rate</span><span class="p">;</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 2.4 transmit internal functions</span>
<span class="cm">	 * </span>
<span class="cm">	 * we construct a copy of the rate grid used by the scheduler</span>
<span class="cm">	 * in order to construct the rate to group table below</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">rategrid</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">rate</span> <span class="o">-=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">rategrid</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">rategrid</span><span class="p">)[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="p">(</span><span class="o">*</span><span class="n">rategrid</span><span class="p">)[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">rategrid</span><span class="p">)[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * 2.4 transmit internal function</span>
<span class="cm">	 *</span>
<span class="cm">	 * this table maps the upper 5 bits of exponent and mantissa</span>
<span class="cm">	 * of the atm forum representation of the rate into an index</span>
<span class="cm">	 * on rate grid  </span>
<span class="cm">	 */</span>

	<span class="n">rate_atmf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rate_atmf</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate_atmf</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">exp</span> <span class="o">=</span> <span class="n">rate_atmf</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>

		<span class="cm">/* </span>
<span class="cm">			instead of &#39;/ 512&#39;, use &#39;&gt;&gt; 9&#39; to prevent a call</span>
<span class="cm">			to divdu3 on x86 platforms</span>
<span class="cm">		*/</span>
		<span class="n">rate_cps</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">exp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">man</span> <span class="o">+</span> <span class="mi">512</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rate_cps</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">rate_cps</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* 2.2.1 minimum payload rate is 10 cps */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">rategrid</span><span class="p">)[</span><span class="n">i</span><span class="o">/</span><span class="mi">16</span><span class="p">][</span><span class="n">i</span><span class="o">%</span><span class="mi">16</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">rate_cps</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>	 <span class="cm">/* pick nearest rate instead? */</span>

		<span class="cm">/*</span>
<span class="cm">		 * each table entry is 16 bits: (rate grid index (8 bits)</span>
<span class="cm">		 * and a buffer limit (8 bits)</span>
<span class="cm">		 * there are two table entries in each 32-bit register</span>
<span class="cm">		 */</span>

<span class="cp">#ifdef notdef</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">rate_cps</span> <span class="o">*</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_numbuffs</span> <span class="o">/</span>
				<span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="cm">/* this is pretty, but avoids _divdu3 and is mostly correct */</span>
		<span class="n">mult</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">/</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_cps</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">272</span> <span class="o">*</span> <span class="n">mult</span><span class="p">))</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate_cps</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">204</span> <span class="o">*</span> <span class="n">mult</span><span class="p">))</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate_cps</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">136</span> <span class="o">*</span> <span class="n">mult</span><span class="p">))</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate_cps</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">68</span> <span class="o">*</span> <span class="n">mult</span><span class="p">))</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&gt;</span> <span class="n">buf_limit</span><span class="p">)</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">buf_limit</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">);</span>

<span class="cp">#define RTGTBL_OFFSET 0x400</span>
	  
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_atmf</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
				<span class="n">CONFIG_RCMABR</span> <span class="o">+</span> <span class="n">RTGTBL_OFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">rate_atmf</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">));</span>

		<span class="o">++</span><span class="n">rate_atmf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">rategrid</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">he_init_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">he_buff</span> <span class="o">*</span><span class="n">heb</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBPS_S</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBPS_T</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBPS_QI</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RBP_THRESH</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span> <span class="n">RBP_QSIZE</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span>
		  <span class="n">G0_RBPS_BS</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>

	<span class="cm">/* bitmap table */</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span><span class="n">RBPL_TABLE_SIZE</span><span class="p">)</span>
				     <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;unable to allocate rbpl bitmap table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">,</span> <span class="n">RBPL_TABLE_SIZE</span><span class="p">);</span>

	<span class="cm">/* rbpl_virt 64-bit pointers */</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_virt</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">RBPL_TABLE_SIZE</span>
				    <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_buff</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_virt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;unable to allocate rbpl virt table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_rbpl_table</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* large buffer pool */</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;rbpl&quot;</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					    <span class="n">CONFIG_RBPL_BUFSIZE</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;unable to create rbpl pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_rbpl_virt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="n">CONFIG_RBPL_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;failed to alloc rbpl_base</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_destroy_rbpl_pool</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CONFIG_RBPL_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbp</span><span class="p">));</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_outstanding</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONFIG_RBPL_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">heb</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">heb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free_rbpl</span><span class="p">;</span>
		<span class="n">heb</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">heb</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_outstanding</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">);</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_virt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">heb</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_hint</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span>  <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">RBP_IDX_OFFSET</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">phys</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_buff</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_tail</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span><span class="p">[</span><span class="n">CONFIG_RBPL_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_phys</span><span class="p">,</span> <span class="n">G0_RBPL_S</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RBPL_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_tail</span><span class="p">),</span>
						<span class="n">G0_RBPL_T</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="p">(</span><span class="n">CONFIG_RBPL_BUFSIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_buff</span><span class="p">))</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span>
						<span class="n">G0_RBPL_BS</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span>
			<span class="n">RBP_THRESH</span><span class="p">(</span><span class="n">CONFIG_RBPL_THRESH</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">RBP_QSIZE</span><span class="p">(</span><span class="n">CONFIG_RBPL_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">RBP_INT_ENB</span><span class="p">,</span>
						<span class="n">G0_RBPL_QI</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>

	<span class="cm">/* rx buffer ready queue */</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_base</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="n">CONFIG_RBRQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbrq</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;failed to allocate rbrq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_rbpl</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CONFIG_RBRQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbrq</span><span class="p">));</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_base</span><span class="p">;</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_phys</span><span class="p">,</span> <span class="n">G0_RBRQ_ST</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">G0_RBRQ_H</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span>
		<span class="n">RBRQ_THRESH</span><span class="p">(</span><span class="n">CONFIG_RBRQ_THRESH</span><span class="p">)</span> <span class="o">|</span> <span class="n">RBRQ_SIZE</span><span class="p">(</span><span class="n">CONFIG_RBRQ_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
						<span class="n">G0_RBRQ_Q</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_coalesce</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;coalescing interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RBRQ_TIME</span><span class="p">(</span><span class="mi">768</span><span class="p">)</span> <span class="o">|</span> <span class="n">RBRQ_COUNT</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span>
						<span class="n">G0_RBRQ_I</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RBRQ_TIME</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">RBRQ_COUNT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
						<span class="n">G0_RBRQ_I</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* tx buffer ready queue */</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_base</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="n">CONFIG_TBRQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_tbrq</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;failed to allocate tbrq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_rbpq_base</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CONFIG_TBRQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_tbrq</span><span class="p">));</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_base</span><span class="p">;</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_phys</span><span class="p">,</span> <span class="n">G0_TBRQ_B_T</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">G0_TBRQ_H</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CONFIG_TBRQ_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">G0_TBRQ_S</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CONFIG_TBRQ_THRESH</span><span class="p">,</span> <span class="n">G0_TBRQ_THRESH</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_free_rbpq_base:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">CONFIG_RBRQ_SIZE</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbrq</span><span class="p">),</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_base</span><span class="p">,</span>
			<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_phys</span><span class="p">);</span>
<span class="nl">out_free_rbpl:</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">heb</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_outstanding</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
		<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span><span class="p">,</span> <span class="n">heb</span><span class="p">,</span> <span class="n">heb</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">);</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">CONFIG_RBPL_SIZE</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbp</span><span class="p">),</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span><span class="p">,</span>
			<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_phys</span><span class="p">);</span>
<span class="nl">out_destroy_rbpl_pool:</span>
	<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span><span class="p">);</span>
<span class="nl">out_free_rbpl_virt:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_virt</span><span class="p">);</span>
<span class="nl">out_free_rbpl_table:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">he_init_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* 2.9.3.5  tail offset for each interrupt queue is located after the</span>
<span class="cm">		    end of the interrupt queue */</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="p">(</span><span class="n">CONFIG_IRQ_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_irq</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;failed to allocate irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tailoffset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="o">*</span><span class="p">)</span>
					<span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">[</span><span class="n">CONFIG_IRQ_SIZE</span><span class="p">];</span>
	<span class="o">*</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tailoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tail</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONFIG_IRQ_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isw</span> <span class="o">=</span> <span class="n">ITYPE_INVALID</span><span class="p">;</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_phys</span><span class="p">,</span> <span class="n">IRQ0_BASE</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span>
		<span class="n">IRQ_SIZE</span><span class="p">(</span><span class="n">CONFIG_IRQ_SIZE</span><span class="p">)</span> <span class="o">|</span> <span class="n">IRQ_THRESH</span><span class="p">(</span><span class="n">CONFIG_IRQ_THRESH</span><span class="p">),</span>
								<span class="n">IRQ0_HEAD</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">IRQ_INT_A</span> <span class="o">|</span> <span class="n">IRQ_TYPE_LINE</span><span class="p">,</span> <span class="n">IRQ0_CNTL</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ0_DATA</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ1_BASE</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ1_HEAD</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ1_CNTL</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ1_DATA</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ2_BASE</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ2_HEAD</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ2_CNTL</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ2_DATA</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ3_BASE</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ3_HEAD</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ3_CNTL</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">IRQ3_DATA</span><span class="p">);</span>

	<span class="cm">/* 2.9.3.2 interrupt queue mapping registers */</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">GRP_10_MAP</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">GRP_32_MAP</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">GRP_54_MAP</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">GRP_76_MAP</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			<span class="n">he_irq_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DEV_LABEL</span><span class="p">,</span> <span class="n">he_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;irq %d already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>   

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">he_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">membase</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gen_cntl_0</span><span class="p">,</span> <span class="n">host_cntl</span><span class="p">,</span> <span class="n">lb_swap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cache_size</span><span class="p">,</span> <span class="n">timer</span><span class="p">;</span>
	
	<span class="kt">unsigned</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span><span class="p">;</span>

	<span class="n">he_dev</span> <span class="o">=</span> <span class="n">HE_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">membase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;membase = 0x%lx  irq = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">membase</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * pci bus controller initialization </span>
<span class="cm">	 */</span>

	<span class="cm">/* 4.3 pci bus controller-specific initialization */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">GEN_CNTL_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gen_cntl_0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;can&#39;t read GEN_CNTL_0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gen_cntl_0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MRL_ENB</span> <span class="o">|</span> <span class="n">MRM_ENB</span> <span class="o">|</span> <span class="n">IGNORE_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">GEN_CNTL_0</span><span class="p">,</span> <span class="n">gen_cntl_0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;can&#39;t write GEN_CNTL_0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;can&#39;t read PCI_COMMAND.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">command</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span> <span class="o">|</span> <span class="n">PCI_COMMAND_INVALIDATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;can&#39;t enable memory.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cache_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;can&#39;t read cache line size?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache_size</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cache_size</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_CACHE_LINE_SIZE</span><span class="p">,</span> <span class="n">cache_size</span><span class="p">))</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;can&#39;t set cache line size to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cache_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timer</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;can&#39;t read latency timer?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* from table 3.9</span>
<span class="cm">	 *</span>
<span class="cm">	 * LAT_TIMER = 1 + AVG_LAT + BURST_SIZE/BUS_SIZE</span>
<span class="cm">	 * </span>
<span class="cm">	 * AVG_LAT: The average first data read/write latency [maximum 16 clock cycles]</span>
<span class="cm">	 * BURST_SIZE: 1536 bytes (read) for 622, 768 bytes (read) for 155 [192 clock cycles]</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span> 
<span class="cp">#define LAT_TIMER 209</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer</span> <span class="o">&lt;</span> <span class="n">LAT_TIMER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;latency timer was %d, setting to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timer</span><span class="p">,</span> <span class="n">LAT_TIMER</span><span class="p">);</span>
		<span class="n">timer</span> <span class="o">=</span> <span class="n">LAT_TIMER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">timer</span><span class="p">))</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;can&#39;t set latency timer to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">membase</span><span class="p">,</span> <span class="n">HE_REGMAP_SIZE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;can&#39;t set up page mapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 4.4 card reset */</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">RESET_CNTL</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">RESET_CNTL</span><span class="p">);</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>	<span class="cm">/* 16 ms */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RESET_CNTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BOARD_RST_STATUS</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 4.5 set bus width */</span>
	<span class="n">host_cntl</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">host_cntl</span> <span class="o">&amp;</span> <span class="n">PCI_BUS_SIZE64</span><span class="p">)</span>
		<span class="n">gen_cntl_0</span> <span class="o">|=</span> <span class="n">ENBL_64</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gen_cntl_0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENBL_64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable64</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;disabling 64-bit pci bus transfers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">gen_cntl_0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENBL_64</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gen_cntl_0</span> <span class="o">&amp;</span> <span class="n">ENBL_64</span><span class="p">)</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;64-bit transfers enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">GEN_CNTL_0</span><span class="p">,</span> <span class="n">gen_cntl_0</span><span class="p">);</span>

	<span class="cm">/* 4.7 read prom contents */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PROD_ID_LEN</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_prom_byte</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">PROD_ID</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">=</span> <span class="n">read_prom_byte</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">MEDIA</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">read_prom_byte</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">MAC_ADDR</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;%s%s, %x:%x:%x:%x:%x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">,</span>
					<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">&amp;</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="s">&quot;SM&quot;</span> <span class="o">:</span> <span class="s">&quot;MM&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">=</span> <span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">ATM_OC12_PCR</span> <span class="o">:</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>

	<span class="cm">/* 4.6 set host endianess */</span>
	<span class="n">lb_swap</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">LB_SWAP</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">))</span>
		<span class="n">lb_swap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XFER_SIZE</span><span class="p">;</span>		<span class="cm">/* 4 cells */</span>
	<span class="k">else</span>
		<span class="n">lb_swap</span> <span class="o">|=</span> <span class="n">XFER_SIZE</span><span class="p">;</span>		<span class="cm">/* 8 cells */</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="n">lb_swap</span> <span class="o">|=</span> <span class="n">DESC_WR_SWAP</span> <span class="o">|</span> <span class="n">INTR_SWAP</span> <span class="o">|</span> <span class="n">BIG_ENDIAN_HOST</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">lb_swap</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">DESC_WR_SWAP</span> <span class="o">|</span> <span class="n">INTR_SWAP</span> <span class="o">|</span> <span class="n">BIG_ENDIAN_HOST</span> <span class="o">|</span>
			<span class="n">DATA_WR_SWAP</span> <span class="o">|</span> <span class="n">DATA_RD_SWAP</span> <span class="o">|</span> <span class="n">DESC_RD_SWAP</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* __BIG_ENDIAN */</span><span class="cp"></span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lb_swap</span><span class="p">,</span> <span class="n">LB_SWAP</span><span class="p">);</span>

	<span class="cm">/* 4.8 sdram controller initialization */</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">LB_64_ENB</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">SDRAM_CTL</span><span class="p">);</span>

	<span class="cm">/* 4.9 initialize rnum value */</span>
	<span class="n">lb_swap</span> <span class="o">|=</span> <span class="n">SWAP_RNUM_MAX</span><span class="p">(</span><span class="mh">0xf</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">lb_swap</span><span class="p">,</span> <span class="n">LB_SWAP</span><span class="p">);</span>

	<span class="cm">/* 4.10 initialize the interrupt queues */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">he_init_irq</span><span class="p">(</span><span class="n">he_dev</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* 4.11 enable pci bus controller state machines */</span>
	<span class="n">host_cntl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">OUTFF_ENB</span> <span class="o">|</span> <span class="n">CMDFF_ENB</span> <span class="o">|</span>
				<span class="n">QUICK_RD_RETRY</span> <span class="o">|</span> <span class="n">QUICK_WR_RETRY</span> <span class="o">|</span> <span class="n">PERR_INT_ENB</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">host_cntl</span><span class="p">,</span> <span class="n">HOST_CNTL</span><span class="p">);</span>

	<span class="n">gen_cntl_0</span> <span class="o">|=</span> <span class="n">INT_PROC_ENBL</span><span class="o">|</span><span class="n">INIT_ENB</span><span class="p">;</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">GEN_CNTL_0</span><span class="p">,</span> <span class="n">gen_cntl_0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * atm network controller initialization</span>
<span class="cm">	 */</span>

	<span class="cm">/* 5.1.1 generic configuration state */</span>

	<span class="cm">/*</span>
<span class="cm">	 *		local (cell) buffer memory map</span>
<span class="cm">	 *                    </span>
<span class="cm">	 *             HE155                          HE622</span>
<span class="cm">	 *                                                      </span>
<span class="cm">	 *        0 ____________1023 bytes  0 _______________________2047 bytes</span>
<span class="cm">	 *         |            |            |                   |   |</span>
<span class="cm">	 *         |  utility   |            |        rx0        |   |</span>
<span class="cm">	 *        5|____________|         255|___________________| u |</span>
<span class="cm">	 *        6|            |         256|                   | t |</span>
<span class="cm">	 *         |            |            |                   | i |</span>
<span class="cm">	 *         |    rx0     |     row    |        tx         | l |</span>
<span class="cm">	 *         |            |            |                   | i |</span>
<span class="cm">	 *         |            |         767|___________________| t |</span>
<span class="cm">	 *      517|____________|         768|                   | y |</span>
<span class="cm">	 * row  518|            |            |        rx1        |   |</span>
<span class="cm">	 *         |            |        1023|___________________|___|</span>
<span class="cm">	 *         |            |</span>
<span class="cm">	 *         |    tx      |</span>
<span class="cm">	 *         |            |</span>
<span class="cm">	 *         |            |</span>
<span class="cm">	 *     1535|____________|</span>
<span class="cm">	 *     1536|            |</span>
<span class="cm">	 *         |    rx1     |</span>
<span class="cm">	 *     2047|____________|</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="cm">/* total 4096 connections */</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">=</span> <span class="n">CONFIG_DEFAULT_VCIBITS</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vpibits</span> <span class="o">=</span> <span class="n">CONFIG_DEFAULT_VPIBITS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nvpibits</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">nvcibits</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">nvpibits</span><span class="o">+</span><span class="n">nvcibits</span> <span class="o">!=</span> <span class="n">HE_MAXCIDBITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;nvpibits + nvcibits != %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HE_MAXCIDBITS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nvpibits</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vpibits</span> <span class="o">=</span> <span class="n">nvpibits</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">=</span> <span class="n">HE_MAXCIDBITS</span> <span class="o">-</span> <span class="n">nvpibits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nvcibits</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">=</span> <span class="n">nvcibits</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vpibits</span> <span class="o">=</span> <span class="n">HE_MAXCIDBITS</span> <span class="o">-</span> <span class="n">nvcibits</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_row</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">bytes_per_row</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_numrows</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_numrows</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_numrows</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_startrow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_startrow</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_startrow</span> <span class="o">=</span> <span class="mi">768</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_row</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">bytes_per_row</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_numrows</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_numrows</span> <span class="o">=</span> <span class="mi">1018</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_numrows</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_startrow</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_startrow</span> <span class="o">=</span> <span class="mi">518</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_startrow</span> <span class="o">=</span> <span class="mi">1536</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">buffer_limit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_numbuffs</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_numrows</span> <span class="o">*</span>
				<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_row</span> <span class="o">/</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_numbuffs</span> <span class="o">&gt;</span> <span class="mi">2560</span><span class="p">)</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r0_numbuffs</span> <span class="o">=</span> <span class="mi">2560</span><span class="p">;</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_numbuffs</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_numrows</span> <span class="o">*</span>
				<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_row</span> <span class="o">/</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_numbuffs</span> <span class="o">&gt;</span> <span class="mi">2560</span><span class="p">)</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">r1_numbuffs</span> <span class="o">=</span> <span class="mi">2560</span><span class="p">;</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_numbuffs</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_numrows</span> <span class="o">*</span>
				<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_row</span> <span class="o">/</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_numbuffs</span> <span class="o">&gt;</span> <span class="mi">5120</span><span class="p">)</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_numbuffs</span> <span class="o">=</span> <span class="mi">5120</span><span class="p">;</span>

	<span class="cm">/* 5.1.2 configure hardware dependent registers */</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> 
		<span class="n">SLICE_X</span><span class="p">(</span><span class="mh">0x2</span><span class="p">)</span> <span class="o">|</span> <span class="n">ARB_RNUM_MAX</span><span class="p">(</span><span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span> <span class="n">TH_PRTY</span><span class="p">(</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RH_PRTY</span><span class="p">(</span><span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span> <span class="n">TL_PRTY</span><span class="p">(</span><span class="mh">0x2</span><span class="p">)</span> <span class="o">|</span> <span class="n">RL_PRTY</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">BUS_MULTI</span><span class="p">(</span><span class="mh">0x28</span><span class="p">)</span> <span class="o">:</span> <span class="n">BUS_MULTI</span><span class="p">(</span><span class="mh">0x46</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">NET_PREF</span><span class="p">(</span><span class="mh">0x50</span><span class="p">)</span> <span class="o">:</span> <span class="n">NET_PREF</span><span class="p">(</span><span class="mh">0x8c</span><span class="p">)),</span>
								<span class="n">LBARB</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">BANK_ON</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">REF_RATE</span><span class="p">(</span><span class="mh">0x384</span><span class="p">)</span> <span class="o">|</span> <span class="n">WIDE_DATA</span><span class="p">)</span> <span class="o">:</span> <span class="n">REF_RATE</span><span class="p">(</span><span class="mh">0x150</span><span class="p">)),</span>
								<span class="n">SDRAMCON</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">RM_BANK_WAIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">RM_BANK_WAIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">|</span>
						<span class="n">RM_RW_WAIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">RCMCONFIG</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span>
		<span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">TM_BANK_WAIT</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">:</span> <span class="n">TM_BANK_WAIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
						<span class="n">TM_RW_WAIT</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">TCMCONFIG</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cells_per_lbuf</span> <span class="o">*</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">,</span> <span class="n">LB_CONFIG</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> 
		<span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">UT_RD_DELAY</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">:</span> <span class="n">UT_RD_DELAY</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">RC_UT_MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">RC_UT_MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
		<span class="n">RX_VALVP</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">RX_VALVC</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">),</span>			 <span class="n">RC_CONFIG</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">DRF_THRESH</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">TX_UT_MODE</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">TX_UT_MODE</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">|</span>
		<span class="n">TX_VCI_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">LBFREE_CNT</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tx_numbuffs</span><span class="p">),</span> 		<span class="n">TX_CONFIG</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">TXAAL5_PROTO</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">PHY_INT_ENB</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">PTMR_PRE</span><span class="p">(</span><span class="mi">67</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">PTMR_PRE</span><span class="p">(</span><span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span>
								<span class="n">RH_CONFIG</span><span class="p">);</span>

	<span class="cm">/* 5.1.3 initialize connection memory */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TCM_MEM_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">he_writel_tcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RCM_MEM_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">he_writel_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *	transmit connection memory map</span>
<span class="cm">	 *</span>
<span class="cm">	 *                  tx memory</span>
<span class="cm">	 *          0x0 ___________________</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |       TSRa        |</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *       0x8000|___________________|</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |       TSRb        |</span>
<span class="cm">	 *       0xc000|___________________|</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |       TSRc        |</span>
<span class="cm">	 *       0xe000|___________________|</span>
<span class="cm">	 *             |       TSRd        |</span>
<span class="cm">	 *       0xf000|___________________|</span>
<span class="cm">	 *             |       tmABR       |</span>
<span class="cm">	 *      0x10000|___________________|</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |       tmTPD       |</span>
<span class="cm">	 *             |___________________|</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *                      ....</span>
<span class="cm">	 *      0x1ffff|___________________|</span>
<span class="cm">	 *</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CONFIG_TSRB</span><span class="p">,</span> <span class="n">TSRB_BA</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CONFIG_TSRC</span><span class="p">,</span> <span class="n">TSRC_BA</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CONFIG_TSRD</span><span class="p">,</span> <span class="n">TSRD_BA</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CONFIG_TMABR</span><span class="p">,</span> <span class="n">TMABR_BA</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CONFIG_TPDBA</span><span class="p">,</span> <span class="n">TPD_BA</span><span class="p">);</span>


	<span class="cm">/*</span>
<span class="cm">	 *	receive connection memory map</span>
<span class="cm">	 *</span>
<span class="cm">	 *          0x0 ___________________</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |       RSRa        |</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *       0x8000|___________________|</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |             rx0/1 |</span>
<span class="cm">	 *             |       LBM         |   link lists of local</span>
<span class="cm">	 *             |             tx    |   buffer memory </span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *       0xd000|___________________|</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |      rmABR        |</span>
<span class="cm">	 *       0xe000|___________________|</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *             |       RSRb        |</span>
<span class="cm">	 *             |___________________|</span>
<span class="cm">	 *             |                   |</span>
<span class="cm">	 *                      ....</span>
<span class="cm">	 *       0xffff|___________________|</span>
<span class="cm">	 */</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x08000</span><span class="p">,</span> <span class="n">RCMLBM_BA</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0e000</span><span class="p">,</span> <span class="n">RCMRSRB_BA</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0d800</span><span class="p">,</span> <span class="n">RCMABR_BA</span><span class="p">);</span>

	<span class="cm">/* 5.1.4 initialize local buffer free pools linked lists */</span>

	<span class="n">he_init_rx_lbfp0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>
	<span class="n">he_init_rx_lbfp1</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">RLBC_H</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">RLBC_T</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">RLBC_H2</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="n">RXTHRSH</span><span class="p">);</span>	<span class="cm">/* 10% of r0+r1 buffers */</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">LITHRSH</span><span class="p">);</span> 	<span class="cm">/* 5% of r0+r1 buffers */</span>

	<span class="n">he_init_tx_lbfp</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x104780</span> <span class="o">:</span> <span class="mh">0x800</span><span class="p">,</span> <span class="n">UBUFF_BA</span><span class="p">);</span>

	<span class="cm">/* 5.1.5 initialize intermediate receive queues */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">,</span> <span class="n">G0_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x200f</span><span class="p">,</span> <span class="n">G0_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x001f</span><span class="p">,</span> <span class="n">G1_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x201f</span><span class="p">,</span> <span class="n">G1_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x002f</span><span class="p">,</span> <span class="n">G2_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x202f</span><span class="p">,</span> <span class="n">G2_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x003f</span><span class="p">,</span> <span class="n">G3_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x203f</span><span class="p">,</span> <span class="n">G3_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x004f</span><span class="p">,</span> <span class="n">G4_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x204f</span><span class="p">,</span> <span class="n">G4_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x005f</span><span class="p">,</span> <span class="n">G5_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x205f</span><span class="p">,</span> <span class="n">G5_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x006f</span><span class="p">,</span> <span class="n">G6_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x206f</span><span class="p">,</span> <span class="n">G6_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x007f</span><span class="p">,</span> <span class="n">G7_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x207f</span><span class="p">,</span> <span class="n">G7_INMQ_L</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">G0_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">G0_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">G1_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="n">G1_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">G2_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="n">G2_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">G3_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">,</span> <span class="n">G3_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="n">G4_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="n">G4_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="n">G5_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="n">G5_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="n">G6_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="n">G6_INMQ_L</span><span class="p">);</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="n">G7_INMQ_S</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">,</span> <span class="n">G7_INMQ_L</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* 5.1.6 application tunable parameters */</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">MCC</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">OEC</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">DCC</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">CEC</span><span class="p">);</span>
	
	<span class="cm">/* 5.1.7 cs block initialization */</span>

	<span class="n">he_init_cs_block</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>

	<span class="cm">/* 5.1.8 cs block connection memory initialization */</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">he_init_cs_block_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* 5.1.10 initialize host structures */</span>

	<span class="n">he_init_tpdrq</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpd_pool</span> <span class="o">=</span> <span class="n">pci_pool_create</span><span class="p">(</span><span class="s">&quot;tpd&quot;</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_tpd</span><span class="p">),</span> <span class="n">TPD_ALIGNMENT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpd_pool</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;unable to create tpd pci_pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>         
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">outstanding_tpds</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_init_group</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">group</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">group</span> <span class="o">&lt;</span> <span class="n">HE_NUM_GROUPS</span><span class="p">;</span> <span class="o">++</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBPS_S</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBPS_T</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBPS_QI</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RBP_THRESH</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span> <span class="n">RBP_QSIZE</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span>
						<span class="n">G0_RBPS_BS</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBPL_S</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBPL_T</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RBP_THRESH</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span> <span class="n">RBP_QSIZE</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span>
						<span class="n">G0_RBPL_QI</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBPL_BS</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">32</span><span class="p">));</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBRQ_ST</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBRQ_H</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RBRQ_THRESH</span><span class="p">(</span><span class="mh">0x1</span><span class="p">)</span> <span class="o">|</span> <span class="n">RBRQ_SIZE</span><span class="p">(</span><span class="mh">0x0</span><span class="p">),</span>
						<span class="n">G0_RBRQ_Q</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_RBRQ_I</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_TBRQ_B_T</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_TBRQ_H</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TBRQ_THRESH</span><span class="p">(</span><span class="mh">0x1</span><span class="p">),</span>
						<span class="n">G0_TBRQ_THRESH</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">G0_TBRQ_S</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* host status page */</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_hsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp_phys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;failed to allocate host status page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_hsp</span><span class="p">));</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp_phys</span><span class="p">,</span> <span class="n">HSP_BA</span><span class="p">);</span>

	<span class="cm">/* initialize framer */</span>

<span class="cp">#ifdef CONFIG_ATM_HE_USE_SUNI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_isMM</span><span class="p">(</span><span class="n">he_dev</span><span class="p">))</span>
		<span class="n">suni_init</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_HE_USE_SUNI */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdh</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this really should be in suni.c but for now... */</span>
		<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">he_phy_get</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">SUNI_TPOP_APM</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SUNI_TPOP_APM_S</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">SUNI_TPOP_S_SDH</span> <span class="o">&lt;&lt;</span> <span class="n">SUNI_TPOP_APM_S_SHIFT</span><span class="p">);</span>
		<span class="n">he_phy_put</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">SUNI_TPOP_APM</span><span class="p">);</span>
		<span class="n">he_phy_put</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">SUNI_TACP_IUCHP_CLP</span><span class="p">,</span> <span class="n">SUNI_TACP_IUCHP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* 5.1.12 enable transmit and receive */</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">he_readl_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CS_ERCTL0</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">TX_ENABLE</span><span class="o">|</span><span class="n">ER_ENABLE</span><span class="p">;</span>
	<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">CS_ERCTL0</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RC_CONFIG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">RX_ENABLE</span><span class="p">;</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">RC_CONFIG</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HE_NUM_CS_STPER</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">inuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pcr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">total_bw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="cm">/* atm linux initialization */</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">;</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_peak</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_peak</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_peak</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_peak</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;hell bent for leather!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">he_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">he_buff</span> <span class="o">*</span><span class="n">heb</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gen_cntl_0</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">command</span><span class="p">;</span>

	<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="cm">/* disable interrupts */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">GEN_CNTL_0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gen_cntl_0</span><span class="p">);</span>
		<span class="n">gen_cntl_0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">INT_PROC_ENBL</span> <span class="o">|</span> <span class="n">INIT_ENB</span><span class="p">);</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">GEN_CNTL_0</span><span class="p">,</span> <span class="n">gen_cntl_0</span><span class="p">);</span>

		<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

		<span class="cm">/* disable recv and transmit */</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">he_readl_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CS_ERCTL0</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TX_ENABLE</span><span class="o">|</span><span class="n">ER_ENABLE</span><span class="p">);</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">CS_ERCTL0</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RC_CONFIG</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">RX_ENABLE</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">RC_CONFIG</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ATM_HE_USE_SUNI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_HE_USE_SUNI */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">he_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="p">(</span><span class="n">CONFIG_IRQ_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
			<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_irq</span><span class="p">),</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_hsp</span><span class="p">),</span>
						<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp_phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">heb</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_outstanding</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
			<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span><span class="p">,</span> <span class="n">heb</span><span class="p">,</span> <span class="n">heb</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">);</span>

		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">CONFIG_RBPL_SIZE</span>
			<span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbp</span><span class="p">),</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_phys</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_virt</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span><span class="p">)</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_base</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">CONFIG_RBRQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbrq</span><span class="p">),</span>
							<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_base</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_base</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">CONFIG_TBRQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_tbrq</span><span class="p">),</span>
							<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_base</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_base</span><span class="p">)</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">CONFIG_TBRQ_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_tbrq</span><span class="p">),</span>
							<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_base</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_phys</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpd_pool</span><span class="p">)</span>
		<span class="n">pci_pool_destroy</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpd_pool</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">);</span>
		<span class="n">command</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">);</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">he_tpd</span> <span class="o">*</span>
<span class="nf">__alloc_tpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">he_tpd</span> <span class="o">*</span><span class="n">tpd</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>

	<span class="n">tpd</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpd_pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
			
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">TPD_ADDR</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tpd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AAL5_LEN(buf,len) 						\</span>
<span class="cp">			((((unsigned char *)(buf))[(len)-6] &lt;&lt; 8) |	\</span>
<span class="cp">				(((unsigned char *)(buf))[(len)-5]))</span>

<span class="cm">/* 2.10.1.2 receive</span>
<span class="cm"> *</span>
<span class="cm"> * aal5 packets can optionally return the tcp checksum in the lower</span>
<span class="cm"> * 16 bits of the crc (RSR0_TCP_CKSUM)</span>
<span class="cm"> */</span>

<span class="cp">#define TCP_CKSUM(buf,len) 						\</span>
<span class="cp">			((((unsigned char *)(buf))[(len)-2] &lt;&lt; 8) |	\</span>
<span class="cp">				(((unsigned char *)(buf))[(len-1)]))</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">he_service_rbrq</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">he_rbrq</span> <span class="o">*</span><span class="n">rbrq_tail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_rbrq</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_base</span> <span class="o">|</span>
					<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="p">].</span><span class="n">rbrq_tail</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">cid</span><span class="p">,</span> <span class="n">lastcid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_vcc</span> <span class="o">*</span><span class="n">he_vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_buff</span> <span class="o">*</span><span class="n">heb</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pdus_assembled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span> <span class="o">!=</span> <span class="n">rbrq_tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">updated</span><span class="p">;</span>

		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;%p rbrq%d 0x%x len=%d cid=0x%x %s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span>
			<span class="n">RBRQ_ADDR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">),</span>
			<span class="n">RBRQ_BUFLEN</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">),</span>
			<span class="n">RBRQ_CID</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">),</span>
			<span class="n">RBRQ_CRC_ERR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CRC_ERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">RBRQ_LEN_ERR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; LEN_ERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">RBRQ_END_PDU</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; END_PDU&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">RBRQ_AAL5_PROT</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; AAL5_PROT&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">RBRQ_CON_CLOSED</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; CON_CLOSED&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">RBRQ_HBUF_ERR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; HBUF_ERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">RBRQ_ADDR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">RBP_IDX_OFFSET</span><span class="p">;</span>
		<span class="n">heb</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_virt</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">cid</span> <span class="o">=</span> <span class="n">RBRQ_CID</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cid</span> <span class="o">!=</span> <span class="n">lastcid</span><span class="p">)</span>
			<span class="n">vcc</span> <span class="o">=</span> <span class="n">__find_vcc</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">lastcid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">he_vcc</span> <span class="o">=</span> <span class="n">HE_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;vcc/he_vcc == NULL  (cid 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RBRQ_HBUF_ERR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">);</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">heb</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
				<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span><span class="p">,</span> <span class="n">heb</span><span class="p">,</span> <span class="n">heb</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">);</span>
			<span class="p">}</span>
					
			<span class="k">goto</span> <span class="n">next_rbrq_entry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RBRQ_HBUF_ERR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;HBUF_ERR!  (cid 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">return_host_buffers</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">heb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">RBRQ_BUFLEN</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">heb</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
		<span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">pdu_len</span> <span class="o">+=</span> <span class="n">heb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RBRQ_CON_CLOSED</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lastcid</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;wake_up rx_waitq  (cid 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">rx_waitq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">return_host_buffers</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RBRQ_END_PDU</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">next_rbrq_entry</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">RBRQ_LEN_ERR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span>
				<span class="o">||</span> <span class="n">RBRQ_CRC_ERR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;%s%s (%d.%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">RBRQ_CRC_ERR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span>
							<span class="o">?</span> <span class="s">&quot;CRC_ERR &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">RBRQ_LEN_ERR</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">)</span>
							<span class="o">?</span> <span class="s">&quot;LEN_ERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
							<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">return_host_buffers</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">atm_alloc_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">pdu_len</span> <span class="o">+</span> <span class="n">rx_skb_reserve</span><span class="p">,</span>
							<span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;charge failed (%d.%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">return_host_buffers</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rx_skb_reserve</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_skb_reserve</span><span class="p">);</span>

		<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">heb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">heb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">heb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">heb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ATM_AAL0</span>:
				<span class="cm">/* 2.10.1.5 raw cell receive */</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ATM_AAL0_SDU</span><span class="p">;</span>
				<span class="n">skb_set_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ATM_AAL5</span>:
				<span class="cm">/* 2.10.1.2 aal5 receive */</span>

				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">AAL5_LEN</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">pdu_len</span><span class="p">);</span>
				<span class="n">skb_set_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="cp">#ifdef USE_CHECKSUM_HW</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&gt;=</span> <span class="n">ATM_NOT_RSV_VCI</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_COMPLETE</span><span class="p">;</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">csum</span> <span class="o">=</span> <span class="n">TCP_CKSUM</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							<span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">pdu_len</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#endif</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef should_never_happen</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">)</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;pdu_len (%d) &gt; vcc-&gt;qos.rxtp.max_sdu (%d)!  cid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef notdef</span>
		<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">);</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">);</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

<span class="nl">return_host_buffers:</span>
		<span class="o">++</span><span class="n">pdus_assembled</span><span class="p">;</span>

		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">heb</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span>
			<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span><span class="p">,</span> <span class="n">heb</span><span class="p">,</span> <span class="n">heb</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">);</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
		<span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">pdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">next_rbrq_entry:</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_rbrq</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_base</span> <span class="o">|</span>
					<span class="n">RBRQ_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span> <span class="o">&gt;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_peak</span><span class="p">)</span>
			<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_peak</span> <span class="o">=</span> <span class="n">updated</span><span class="p">;</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RBRQ_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_head</span><span class="p">),</span>
						<span class="n">G0_RBRQ_H</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pdus_assembled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">he_service_tbrq</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">he_tbrq</span> <span class="o">*</span><span class="n">tbrq_tail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_tbrq</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_base</span> <span class="o">|</span>
					<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">hsp</span><span class="o">-&gt;</span><span class="n">group</span><span class="p">[</span><span class="n">group</span><span class="p">].</span><span class="n">tbrq_tail</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">he_tpd</span> <span class="o">*</span><span class="n">tpd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_tpd</span> <span class="o">*</span><span class="n">__tpd</span><span class="p">;</span>

	<span class="cm">/* 2.1.6 transmit buffer return queue */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span> <span class="o">!=</span> <span class="n">tbrq_tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">updated</span><span class="p">;</span>

		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;tbrq%d 0x%x%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">group</span><span class="p">,</span>
			<span class="n">TBRQ_TPD</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span><span class="p">),</span> 
			<span class="n">TBRQ_EOS</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; EOS&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">TBRQ_MULTIPLE</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; MULTIPLE&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">tpd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">__tpd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">outstanding_tpds</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">TPD_ADDR</span><span class="p">(</span><span class="n">__tpd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">==</span> <span class="n">TBRQ_TPD</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tpd</span> <span class="o">=</span> <span class="n">__tpd</span><span class="p">;</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__tpd</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;unable to locate tpd for dma buffer %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">TBRQ_TPD</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">next_tbrq_entry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">TBRQ_EOS</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;wake_up(tx_waitq) cid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">he_mkcid</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">)</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HE_VCC</span><span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx_waitq</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">next_tbrq_entry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">TPD_MAXIOV</span><span class="p">;</span> <span class="o">++</span><span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
					<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
					<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">TPD_LEN_MASK</span><span class="p">,</span>
							<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">TPD_LST</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
				
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* &amp;&amp; !TBRQ_MULTIPLE(he_dev-&gt;tbrq_head) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">&amp;&amp;</span> <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
				<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">,</span> <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>

<span class="nl">next_tbrq_entry:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span><span class="p">)</span>
			<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpd_pool</span><span class="p">,</span> <span class="n">tpd</span><span class="p">,</span> <span class="n">TPD_ADDR</span><span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_tbrq</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_base</span> <span class="o">|</span>
					<span class="n">TBRQ_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span> <span class="o">&gt;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_peak</span><span class="p">)</span>
			<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_peak</span> <span class="o">=</span> <span class="n">updated</span><span class="p">;</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TBRQ_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_head</span><span class="p">),</span>
						<span class="n">G0_TBRQ_H</span> <span class="o">+</span> <span class="p">(</span><span class="n">group</span> <span class="o">*</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">he_service_rbpl</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">group</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">he_rbp</span> <span class="o">*</span><span class="n">new_tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_rbp</span> <span class="o">*</span><span class="n">rbpl_head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_buff</span> <span class="o">*</span><span class="n">heb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">mapping</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">moved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rbpl_head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_rbp</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span> <span class="o">|</span>
					<span class="n">RBPL_MASK</span><span class="p">(</span><span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">G0_RBPL_S</span><span class="p">)));</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">new_tail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_rbp</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_base</span> <span class="o">|</span>
						<span class="n">RBPL_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_tail</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>

		<span class="cm">/* table 3.42 -- rbpl_tail should never be set to rbpl_head */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_tail</span> <span class="o">==</span> <span class="n">rbpl_head</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">find_next_zero_bit</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">,</span> <span class="n">RBPL_TABLE_SIZE</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_hint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">RBPL_TABLE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">,</span> <span class="n">RBPL_TABLE_SIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">RBPL_TABLE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_hint</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">heb</span> <span class="o">=</span> <span class="n">pci_pool_alloc</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">heb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">heb</span><span class="o">-&gt;</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">mapping</span><span class="p">;</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">heb</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_outstanding</span><span class="p">);</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_virt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">heb</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_table</span><span class="p">);</span>
		<span class="n">new_tail</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">RBP_IDX_OFFSET</span><span class="p">;</span>
		<span class="n">new_tail</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">mapping</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_buff</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_tail</span> <span class="o">=</span> <span class="n">new_tail</span><span class="p">;</span>
		<span class="o">++</span><span class="n">moved</span><span class="p">;</span>
	<span class="p">}</span> 

	<span class="k">if</span> <span class="p">(</span><span class="n">moved</span><span class="p">)</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RBPL_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbpl_tail</span><span class="p">),</span> <span class="n">G0_RBPL_T</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">he_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">group</span><span class="p">,</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;tasklet (0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span> <span class="o">!=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">updated</span><span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">ITYPE_TYPE</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span><span class="o">-&gt;</span><span class="n">isw</span><span class="p">);</span>
		<span class="n">group</span> <span class="o">=</span> <span class="n">ITYPE_GROUP</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span><span class="o">-&gt;</span><span class="n">isw</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ITYPE_RBRQ_THRESH</span>:
				<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;rbrq%d threshold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
				<span class="cm">/* fall through */</span>
			<span class="k">case</span> <span class="n">ITYPE_RBRQ_TIMER</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">he_service_rbrq</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">group</span><span class="p">))</span>
					<span class="n">he_service_rbpl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ITYPE_TBRQ_THRESH</span>:
				<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;tbrq%d threshold</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
				<span class="cm">/* fall through */</span>
			<span class="k">case</span> <span class="n">ITYPE_TPD_COMPLETE</span>:
				<span class="n">he_service_tbrq</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ITYPE_RBPL_THRESH</span>:
				<span class="n">he_service_rbpl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">group</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ITYPE_RBPS_THRESH</span>:
				<span class="cm">/* shouldn&#39;t happen unless small buffers enabled */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ITYPE_PHY</span>:
				<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;phy interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ATM_HE_USE_SUNI</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span>
					<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ITYPE_OTHER</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="o">|</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">ITYPE_PARITY</span>:
						<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;parity error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">ITYPE_ABORT</span>:
						<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;abort 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">ABORT_ADDR</span><span class="p">));</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ITYPE_TYPE</span><span class="p">(</span><span class="n">ITYPE_INVALID</span><span class="p">)</span>:
				<span class="cm">/* see 8.1.1 -- check all queues */</span>

				<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;isw not updated 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span><span class="o">-&gt;</span><span class="n">isw</span><span class="p">);</span>

				<span class="n">he_service_rbrq</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">he_service_rbpl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">he_service_tbrq</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;bad isw 0x%x?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span><span class="o">-&gt;</span><span class="n">isw</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span><span class="o">-&gt;</span><span class="n">isw</span> <span class="o">=</span> <span class="n">ITYPE_INVALID</span><span class="p">;</span>

		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_irq</span> <span class="o">*</span><span class="p">)</span> <span class="n">NEXT_ENTRY</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span><span class="p">,</span> <span class="n">IRQ_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">updated</span> <span class="o">&gt;</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_peak</span><span class="p">)</span>
			<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_peak</span> <span class="o">=</span> <span class="n">updated</span><span class="p">;</span>

		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span>
			<span class="n">IRQ_SIZE</span><span class="p">(</span><span class="n">CONFIG_IRQ_SIZE</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">IRQ_THRESH</span><span class="p">(</span><span class="n">CONFIG_IRQ_THRESH</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">IRQ_TAIL</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tail</span><span class="p">),</span> <span class="n">IRQ0_HEAD</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">INT_FIFO</span><span class="p">);</span> <span class="cm">/* 8.1.2 controller errata; flush posted writes */</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">he_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span> <span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_irq</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">(</span><span class="o">*</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tailoffset</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tail</span> <span class="o">==</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;tailoffset not updated?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_irq</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_base</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">IRQ0_BASE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IRQ_MASK</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">INT_FIFO</span><span class="p">);</span>	<span class="cm">/* 8.1.2 controller errata */</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span> <span class="o">==</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tail</span> <span class="cm">/* &amp;&amp; !IRQ_PENDING */</span><span class="p">)</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;spurious (or shared) interrupt?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_head</span> <span class="o">!=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">INT_CLEAR_A</span><span class="p">,</span> <span class="n">INT_FIFO</span><span class="p">);</span>	<span class="cm">/* clear interrupt */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">INT_FIFO</span><span class="p">);</span>		<span class="cm">/* flush posted writes */</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">void</span>
<span class="nf">__enqueue_tpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">he_tpd</span> <span class="o">*</span><span class="n">tpd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">he_tpdrq</span> <span class="o">*</span><span class="n">new_tail</span><span class="p">;</span>

	<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;tpdrq %p cid 0x%x -&gt; tpdrq_tail %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">tpd</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_tail</span><span class="p">);</span>

	<span class="cm">/* new_tail = he_dev-&gt;tpdrq_tail; */</span>
	<span class="n">new_tail</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_tpdrq</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_base</span> <span class="o">|</span>
					<span class="n">TPDRQ_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_tail</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * check to see if we are about to set the tail == head</span>
<span class="cm">	 * if true, update the head pointer from the adapter</span>
<span class="cm">	 * to see if this is really the case (reading the queue</span>
<span class="cm">	 * head for every enqueue would be unnecessarily slow)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_tail</span> <span class="o">==</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">he_tpdrq</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_base</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">TPDRQ_MASK</span><span class="p">(</span><span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TPDRQ_B_H</span><span class="p">)));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">new_tail</span> <span class="o">==</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_head</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">slot</span><span class="p">;</span>

			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;tpdrq full (cid 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME</span>
<span class="cm">			 * push tpd onto a transmit backlog queue</span>
<span class="cm">			 * after service_tbrq, service the backlog</span>
<span class="cm">			 * for now, we just drop the pdu</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">slot</span> <span class="o">&lt;</span> <span class="n">TPD_MAXIOV</span><span class="p">;</span> <span class="o">++</span><span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span><span class="p">)</span>
					<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
						<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span><span class="p">,</span>
						<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">TPD_LEN_MASK</span><span class="p">,</span>
								<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
					<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">,</span> <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pci_pool_free</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpd_pool</span><span class="p">,</span> <span class="n">tpd</span><span class="p">,</span> <span class="n">TPD_ADDR</span><span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* 2.1.5 transmit packet descriptor ready queue */</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">outstanding_tpds</span><span class="p">);</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_tail</span><span class="o">-&gt;</span><span class="n">tpd</span> <span class="o">=</span> <span class="n">TPD_ADDR</span><span class="p">(</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_tail</span><span class="o">-&gt;</span><span class="n">cid</span> <span class="o">=</span> <span class="n">cid</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>

	<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_tail</span> <span class="o">=</span> <span class="n">new_tail</span><span class="p">;</span>

	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TPDRQ_MASK</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tpdrq_tail</span><span class="p">),</span> <span class="n">TPDRQ_T</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TPDRQ_T</span><span class="p">);</span>		<span class="cm">/* flush posted writes */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">he_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="n">HE_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">he_vcc</span> <span class="o">*</span><span class="n">he_vcc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cid</span><span class="p">,</span> <span class="n">rsr0</span><span class="p">,</span> <span class="n">rsr1</span><span class="p">,</span> <span class="n">rsr4</span><span class="p">,</span> <span class="n">tsr0</span><span class="p">,</span> <span class="n">tsr0_aal</span><span class="p">,</span> <span class="n">tsr4</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clock</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">vpi</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vci</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vci</span> <span class="o">==</span> <span class="n">ATM_VCI_UNSPEC</span> <span class="o">||</span> <span class="n">vpi</span> <span class="o">==</span> <span class="n">ATM_VPI_UNSPEC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;open vcc %p %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">cid</span> <span class="o">=</span> <span class="n">he_mkcid</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>

	<span class="n">he_vcc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_vcc</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">he_vcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;unable to allocate he_vcc during open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
	<span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">pdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">rc_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">rx_waitq</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">tx_waitq</span><span class="p">);</span>

	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">he_vcc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">pcr_goal</span><span class="p">;</span>

		<span class="n">pcr_goal</span> <span class="o">=</span> <span class="n">atm_pcr_goal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcr_goal</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pcr_goal</span> <span class="o">=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">link_rate</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcr_goal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>	<span class="cm">/* means round down, technically */</span>
			<span class="n">pcr_goal</span> <span class="o">=</span> <span class="o">-</span><span class="n">pcr_goal</span><span class="p">;</span>

		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;open tx cid 0x%x pcr_goal %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">pcr_goal</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ATM_AAL5</span>:
				<span class="n">tsr0_aal</span> <span class="o">=</span> <span class="n">TSR0_AAL5</span><span class="p">;</span>
				<span class="n">tsr4</span> <span class="o">=</span> <span class="n">TSR4_AAL5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ATM_AAL0</span>:
				<span class="n">tsr0_aal</span> <span class="o">=</span> <span class="n">TSR0_AAL0_SDU</span><span class="p">;</span>
				<span class="n">tsr4</span> <span class="o">=</span> <span class="n">TSR4_AAL0_SDU</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">open_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">tsr0</span> <span class="o">=</span> <span class="n">he_readl_tsr0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">TSR0_CONN_STATE</span><span class="p">(</span><span class="n">tsr0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;cid 0x%x not idle (tsr0 = 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">tsr0</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">open_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ATM_UBR</span>:
				<span class="cm">/* 2.3.3.1 open connection ubr */</span>

				<span class="n">tsr0</span> <span class="o">=</span> <span class="n">TSR0_UBR</span> <span class="o">|</span> <span class="n">TSR0_GROUP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">tsr0_aal</span> <span class="o">|</span>
					<span class="n">TSR0_USE_WMIN</span> <span class="o">|</span> <span class="n">TSR0_UPDATE_GER</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">ATM_CBR</span>:
				<span class="cm">/* 2.3.3.2 open connection cbr */</span>

				<span class="cm">/* 8.2.3 cbr scheduler wrap problem -- limit to 90% total link rate */</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">total_bw</span> <span class="o">+</span> <span class="n">pcr_goal</span><span class="p">)</span>
					<span class="o">&gt;</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">10</span><span class="p">))</span>
				<span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">open_failed</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>			<span class="cm">/* also protects he_dev-&gt;cs_stper[] */</span>

				<span class="cm">/* find an unused cs_stper register */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="n">HE_NUM_CS_STPER</span><span class="p">;</span> <span class="o">++</span><span class="n">reg</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">inuse</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> 
					    <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">pcr</span> <span class="o">==</span> <span class="n">pcr_goal</span><span class="p">)</span>
							<span class="k">break</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">HE_NUM_CS_STPER</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">open_failed</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">total_bw</span> <span class="o">+=</span> <span class="n">pcr_goal</span><span class="p">;</span>

				<span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">rc_index</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
				<span class="o">++</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">inuse</span><span class="p">;</span>
				<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">pcr_goal</span><span class="p">;</span>

				<span class="n">clock</span> <span class="o">=</span> <span class="n">he_is622</span><span class="p">(</span><span class="n">he_dev</span><span class="p">)</span> <span class="o">?</span> <span class="mi">66667000</span> <span class="o">:</span> <span class="mi">50000000</span><span class="p">;</span>
				<span class="n">period</span> <span class="o">=</span> <span class="n">clock</span> <span class="o">/</span> <span class="n">pcr_goal</span><span class="p">;</span>
				
				<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;rc_index = %d period = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
								<span class="n">reg</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>

				<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">rate_to_atmf</span><span class="p">(</span><span class="n">period</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
							<span class="n">CS_STPER0</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

				<span class="n">tsr0</span> <span class="o">=</span> <span class="n">TSR0_CBR</span> <span class="o">|</span> <span class="n">TSR0_GROUP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">tsr0_aal</span> <span class="o">|</span>
							<span class="n">TSR0_RC_INDEX</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">open_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">he_writel_tsr0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">tsr0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr4</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">tsr4</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr1</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TSR1_MCR</span><span class="p">(</span><span class="n">rate_to_atmf</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">|</span>
					<span class="n">TSR1_PCR</span><span class="p">(</span><span class="n">rate_to_atmf</span><span class="p">(</span><span class="n">pcr_goal</span><span class="p">)),</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr2</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TSR2_ACR</span><span class="p">(</span><span class="n">rate_to_atmf</span><span class="p">(</span><span class="n">pcr_goal</span><span class="p">)),</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr9</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TSR9_OPEN_CONN</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>

		<span class="n">he_writel_tsr3</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr5</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr6</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr7</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr8</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr10</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr11</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr12</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr13</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_tsr14</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl_tsr0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>		<span class="cm">/* flush posted writes */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">aal</span><span class="p">;</span>

		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;open rx cid 0x%x (rx_waitq %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span>
		 				<span class="o">&amp;</span><span class="n">HE_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_waitq</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ATM_AAL5</span>:
				<span class="n">aal</span> <span class="o">=</span> <span class="n">RSR0_AAL5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ATM_AAL0</span>:
				<span class="n">aal</span> <span class="o">=</span> <span class="n">RSR0_RAWCELL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">open_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">rsr0</span> <span class="o">=</span> <span class="n">he_readl_rsr0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsr0</span> <span class="o">&amp;</span> <span class="n">RSR0_OPEN_CONN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;cid 0x%x not idle (rsr0 = 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">rsr0</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">open_failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rsr1</span> <span class="o">=</span> <span class="n">RSR1_GROUP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">RSR1_RBPL_ONLY</span><span class="p">;</span>
		<span class="n">rsr4</span> <span class="o">=</span> <span class="n">RSR4_GROUP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">RSR4_RBPL_ONLY</span><span class="p">;</span>
		<span class="n">rsr0</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_UBR</span> <span class="o">?</span> 
				<span class="p">(</span><span class="n">RSR0_EPD_ENABLE</span><span class="o">|</span><span class="n">RSR0_PPD_ENABLE</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef USE_CHECKSUM_HW</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vci</span> <span class="o">&gt;=</span> <span class="n">ATM_NOT_RSV_VCI</span><span class="p">)</span>
			<span class="n">rsr0</span> <span class="o">|=</span> <span class="n">RSR0_TCP_CKSUM</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">he_writel_rsr4</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">rsr4</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">he_writel_rsr1</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">rsr1</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="cm">/* 5.1.11 last parameter initialized should be</span>
<span class="cm">			  the open/closed indication in rsr0 */</span>
		<span class="n">he_writel_rsr0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span>
			<span class="n">rsr0</span> <span class="o">|</span> <span class="n">RSR0_START_PDU</span> <span class="o">|</span> <span class="n">RSR0_OPEN_CONN</span> <span class="o">|</span> <span class="n">aal</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl_rsr0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>		<span class="cm">/* flush posted writes */</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">open_failed:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">he_vcc</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">he_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="n">HE_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">he_tpd</span> <span class="o">*</span><span class="n">tpd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">cid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_vcc</span> <span class="o">*</span><span class="n">he_vcc</span> <span class="o">=</span> <span class="n">HE_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
<span class="cp">#define MAX_RETRY 30</span>
	<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tx_inuse</span><span class="p">;</span>

	<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;close vcc %p %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cid</span> <span class="o">=</span> <span class="n">he_mkcid</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;close rx cid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>

		<span class="cm">/* 2.7.2.2 close receive operation */</span>

		<span class="cm">/* wait for previous close (if any) to finish */</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RCC_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RCC_BUSY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;close cid 0x%x RCC_BUSY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">rx_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

		<span class="n">he_writel_rsr0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">RSR0_CLOSE_CONN</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl_rsr0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>		<span class="cm">/* flush posted writes */</span>
		<span class="n">he_writel_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">RXCON_CLOSE</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">rx_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;close rx timeout cid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>

		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;close rx cid 0x%x complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="n">tsr4</span><span class="p">,</span> <span class="n">tsr0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">timeout</span><span class="p">;</span>

		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;close tx cid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		
		<span class="cm">/* 2.1.2</span>
<span class="cm">		 *</span>
<span class="cm">		 * ... the host must first stop queueing packets to the TPDRQ</span>
<span class="cm">		 * on the connection to be closed, then wait for all outstanding</span>
<span class="cm">		 * packets to be transmitted and their buffers returned to the</span>
<span class="cm">		 * TBRQ. When the last packet on the connection arrives in the</span>
<span class="cm">		 * TBRQ, the host issues the close command to the adapter.</span>
<span class="cm">		 */</span>

		<span class="k">while</span> <span class="p">(((</span><span class="n">tx_inuse</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;</span> <span class="n">MAX_RETRY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">sleep</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sleep</span> <span class="o">&lt;</span> <span class="mi">250</span><span class="p">)</span>
				<span class="n">sleep</span> <span class="o">=</span> <span class="n">sleep</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

			<span class="o">++</span><span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tx_inuse</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;close tx cid 0x%x tx_inuse = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">tx_inuse</span><span class="p">);</span>

		<span class="cm">/* 2.3.1.1 generic close operations with flush */</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">he_writel_tsr4_upper</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TSR4_FLUSH_CONN</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
					<span class="cm">/* also clears TSR4_SESSION_ENDED */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ATM_UBR</span>:
				<span class="n">he_writel_tsr1</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> 
					<span class="n">TSR1_MCR</span><span class="p">(</span><span class="n">rate_to_atmf</span><span class="p">(</span><span class="mi">200000</span><span class="p">))</span>
					<span class="o">|</span> <span class="n">TSR1_PCR</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">cid</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">ATM_CBR</span>:
				<span class="n">he_writel_tsr14_upper</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">TSR14_DELETE</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl_tsr4</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>		<span class="cm">/* flush posted writes */</span>

		<span class="n">tpd</span> <span class="o">=</span> <span class="n">__alloc_tpd</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;close tx he_alloc_tpd failed cid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">close_tx_incomplete</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TPD_EOS</span> <span class="o">|</span> <span class="n">TPD_INT</span><span class="p">;</span>
		<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
		<span class="n">wmb</span><span class="p">();</span>

		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">tx_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">__enqueue_tpd</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">tpd</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>

		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">tx_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;close tx timeout cid 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">close_tx_incomplete</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">tsr4</span> <span class="o">=</span> <span class="n">he_readl_tsr4</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">TSR4_SESSION_ENDED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;close tx cid 0x%x !TSR4_SESSION_ENDED (tsr4 = 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">tsr4</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">TSR0_CONN_STATE</span><span class="p">(</span><span class="n">tsr0</span> <span class="o">=</span> <span class="n">he_readl_tsr0</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">cid</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;close tx cid 0x%x TSR0_CONN_STATE != 0 (tsr0 = 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">,</span> <span class="n">tsr0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
		<span class="p">}</span>

<span class="nl">close_tx_incomplete:</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">he_vcc</span><span class="o">-&gt;</span><span class="n">rc_index</span><span class="p">;</span>

			<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;cs_stper reg = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">inuse</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;cs_stper[%d].inuse = 0!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="o">--</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">inuse</span><span class="p">;</span>

			<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">total_bw</span> <span class="o">-=</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">reg</span><span class="p">].</span><span class="n">pcr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;close tx cid 0x%x complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">he_vcc</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">he_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="n">HE_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">cid</span> <span class="o">=</span> <span class="n">he_mkcid</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">he_tpd</span> <span class="o">*</span><span class="n">tpd</span><span class="p">;</span>
<span class="cp">#ifdef USE_SCATTERGATHER</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define HE_TPD_BUFSIZE 0xffff</span>

	<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;send %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">HE_TPD_BUFSIZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">ATM_AAL0_SDU</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;buffer too large (or small) -- %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef USE_SCATTERGATHER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hprintk</span><span class="p">(</span><span class="s">&quot;no scatter/gather support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tpd</span> <span class="o">=</span> <span class="n">__alloc_tpd</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL5</span><span class="p">)</span>
		<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TPD_CELLTYPE</span><span class="p">(</span><span class="n">TPD_USERCELL</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">pti_clp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">clp</span><span class="p">,</span> <span class="n">pti</span><span class="p">;</span>

		<span class="n">pti</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pti_clp</span> <span class="o">&amp;</span> <span class="n">ATM_HDR_PTI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ATM_HDR_PTI_SHIFT</span><span class="p">;</span> 
		<span class="n">clp</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pti_clp</span> <span class="o">&amp;</span> <span class="n">ATM_HDR_CLP</span><span class="p">);</span>
		<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TPD_CELLTYPE</span><span class="p">(</span><span class="n">pti</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clp</span><span class="p">)</span>
			<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TPD_CLP</span><span class="p">;</span>

		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ATM_AAL0_SDU</span> <span class="o">-</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef USE_SCATTERGATHER</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				<span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="o">++</span><span class="n">slot</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_frag_t</span> <span class="o">*</span><span class="n">frag</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">slot</span> <span class="o">==</span> <span class="n">TPD_MAXIOV</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* queue tpd; start new tpd */</span>
			<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* not the last fragment</span>
<span class="cm">						   so dont -&gt;push() yet */</span>
			<span class="n">wmb</span><span class="p">();</span>

			<span class="n">__enqueue_tpd</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">tpd</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
			<span class="n">tpd</span> <span class="o">=</span> <span class="n">__alloc_tpd</span><span class="p">(</span><span class="n">he_dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tpd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
					<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TPD_USERCELL</span><span class="p">;</span>
			<span class="n">slot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">page_address</span><span class="p">(</span><span class="n">frag</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span> <span class="o">+</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">page_offset</span><span class="p">,</span>
				<span class="n">frag</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">frag</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="o">++</span><span class="n">slot</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">iovec</span><span class="p">[</span><span class="n">slot</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">|=</span> <span class="n">TPD_LST</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">address0</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">length0</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">|</span> <span class="n">TPD_LST</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">TPD_INT</span><span class="p">;</span>

	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>

	<span class="n">__enqueue_tpd</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">tpd</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">he_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="n">HE_DEV</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">he_ioctl_reg</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HE_GET_REG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_ioctl_reg</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">HE_REGTYPE_PCI</span>:
					<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">.</span><span class="n">addr</span> <span class="o">&gt;=</span> <span class="n">HE_REGMAP_SIZE</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>

					<span class="n">reg</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">HE_REGTYPE_RCM</span>:
					<span class="n">reg</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span>
						<span class="n">he_readl_rcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">HE_REGTYPE_TCM</span>:
					<span class="n">reg</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span>
						<span class="n">he_readl_tcm</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">HE_REGTYPE_MBOX</span>:
					<span class="n">reg</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span>
						<span class="n">he_readl_mbox</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_ioctl_reg</span><span class="p">)))</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
<span class="cp">#ifdef CONFIG_ATM_HE_USE_SUNI</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* CONFIG_ATM_HE_USE_SUNI */</span><span class="cp"></span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_HE_USE_SUNI */</span><span class="cp"></span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">he_phy_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="n">HE_DEV</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">);</span>

	<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;phy_put(val 0x%x, addr 0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">FRAMER</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">FRAMER</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>		<span class="cm">/* flush posted writes */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
 
	
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">he_phy_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span> 
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="n">HE_DEV</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">FRAMER</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">HPRINTK</span><span class="p">(</span><span class="s">&quot;phy_get(addr 0x%lx) =0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">he_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span> <span class="o">=</span> <span class="n">HE_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef notdef</span>
	<span class="k">struct</span> <span class="n">he_rbrq</span> <span class="o">*</span><span class="n">rbrq_tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">he_tpdrq</span> <span class="o">*</span><span class="n">tpdrq_head</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rbpl_head</span><span class="p">,</span> <span class="n">rbpl_tail</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">static</span> <span class="kt">long</span> <span class="n">mcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;ATM he driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%s%s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">media</span> <span class="o">&amp;</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="s">&quot;SM&quot;</span> <span class="o">:</span> <span class="s">&quot;MM&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Mismatched Cells  VPI/VCI Not Open  Dropped Cells  RCM Dropped Cells</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mcc</span> <span class="o">+=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">MCC</span><span class="p">);</span>
	<span class="n">oec</span> <span class="o">+=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">OEC</span><span class="p">);</span>
	<span class="n">dcc</span> <span class="o">+=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">DCC</span><span class="p">);</span>
	<span class="n">cec</span> <span class="o">+=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">CEC</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">global_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;%16ld  %16ld  %13ld  %17ld</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> 
							<span class="n">mcc</span><span class="p">,</span> <span class="n">oec</span><span class="p">,</span> <span class="n">dcc</span><span class="p">,</span> <span class="n">cec</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;irq_size = %d  inuse = ?  peak = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CONFIG_IRQ_SIZE</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">irq_peak</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;tpdrq_size = %d  inuse = ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">CONFIG_TPDRQ_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;rbrq_size = %d  inuse = ?  peak = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">CONFIG_RBRQ_SIZE</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">rbrq_peak</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;tbrq_size = %d  peak = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">CONFIG_TBRQ_SIZE</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">tbrq_peak</span><span class="p">);</span>


<span class="cp">#ifdef notdef</span>
	<span class="n">rbpl_head</span> <span class="o">=</span> <span class="n">RBPL_MASK</span><span class="p">(</span><span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">G0_RBPL_S</span><span class="p">));</span>
	<span class="n">rbpl_tail</span> <span class="o">=</span> <span class="n">RBPL_MASK</span><span class="p">(</span><span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">G0_RBPL_T</span><span class="p">));</span>

	<span class="n">inuse</span> <span class="o">=</span> <span class="n">rbpl_head</span> <span class="o">-</span> <span class="n">rbpl_tail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inuse</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">inuse</span> <span class="o">+=</span> <span class="n">CONFIG_RBPL_SIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbp</span><span class="p">);</span>
	<span class="n">inuse</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_rbp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;rbpl_size = %d  inuse = %d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">CONFIG_RBPL_SIZE</span><span class="p">,</span> <span class="n">inuse</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;rate controller periods (cbr)</span><span class="se">\n</span><span class="s">                 pcr  #vc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HE_NUM_CS_STPER</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;cs_stper%-2d  %8ld  %3d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
						<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pcr</span><span class="p">,</span>
						<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">cs_stper</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">inuse</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;total bw (cbr): %d  (limit %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">total_bw</span><span class="p">,</span> <span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">/</span> <span class="mi">9</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* eeprom routines  -- see 4.7 */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">read_prom_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">he_dev</span> <span class="o">*</span><span class="n">he_dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">byte_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">he_dev</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFE0FF</span><span class="p">;</span>
       
	<span class="cm">/* Turn on write enable */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x800</span><span class="p">;</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
       
	<span class="cm">/* Send READ instruction */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">readtab</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">readtab</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">EEPROM_DELAY</span><span class="p">);</span>
	<span class="p">}</span>
       
	<span class="cm">/* Next, we need to send the byte address to read from */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">clocktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">|</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">),</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">EEPROM_DELAY</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">clocktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">|</span> <span class="p">(((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">),</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">EEPROM_DELAY</span><span class="p">);</span>
	<span class="p">}</span>
       
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFF7FF</span><span class="p">;</span>      <span class="cm">/* Turn off write enable */</span>
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
       
	<span class="cm">/* Now, we can read data from the EEPROM by clocking it in */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">clocktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">],</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">EEPROM_DELAY</span><span class="p">);</span>
		<span class="n">tmp_read</span> <span class="o">=</span> <span class="n">he_readl</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
		<span class="n">byte_read</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span>
			   <span class="p">((</span><span class="n">tmp_read</span> <span class="o">&amp;</span> <span class="n">ID_DOUT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ID_DOFFSET</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">clocktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">],</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">EEPROM_DELAY</span><span class="p">);</span>
	<span class="p">}</span>
       
	<span class="n">he_writel</span><span class="p">(</span><span class="n">he_dev</span><span class="p">,</span> <span class="n">val</span> <span class="o">|</span> <span class="n">ID_CS</span><span class="p">,</span> <span class="n">HOST_CNTL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">EEPROM_DELAY</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">byte_read</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;chas williams &lt;chas@cmf.nrl.navy.mil&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ForeRunnerHE ATM Adapter driver&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable64</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable64</span><span class="p">,</span> <span class="s">&quot;disable 64-bit pci bus transfers&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nvpibits</span><span class="p">,</span> <span class="kt">short</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nvpibits</span><span class="p">,</span> <span class="s">&quot;numbers of bits for vpi (default 0)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">nvcibits</span><span class="p">,</span> <span class="kt">short</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nvcibits</span><span class="p">,</span> <span class="s">&quot;numbers of bits for vci (default 12)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_skb_reserve</span><span class="p">,</span> <span class="kt">short</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_skb_reserve</span><span class="p">,</span> <span class="s">&quot;padding for receive skb (default 16)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq_coalesce</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq_coalesce</span><span class="p">,</span> <span class="s">&quot;use interrupt coalescing (default 1)&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sdh</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">sdh</span><span class="p">,</span> <span class="s">&quot;use SDH framing (default 0)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">he_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">FORE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FORE_HE</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">he_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">he_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;he&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">he_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">__devexit_p</span><span class="p">(</span><span class="n">he_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">he_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">he_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">he_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">he_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">he_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">he_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
