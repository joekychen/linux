<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › atm › idt77252.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>idt77252.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************* </span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000 ATecoM GmbH </span>
<span class="cm"> *</span>
<span class="cm"> * The author may be reached at ecd@atecom.com.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute  it and/or modify it</span>
<span class="cm"> * under  the terms of  the GNU General  Public License as published by the</span>
<span class="cm"> * Free Software Foundation;  either version 2 of the  License, or (at your</span>
<span class="cm"> * option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS  SOFTWARE  IS PROVIDED   ``AS  IS&#39;&#39; AND   ANY  EXPRESS OR   IMPLIED</span>
<span class="cm"> * WARRANTIES,   INCLUDING, BUT NOT  LIMITED  TO, THE IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.  IN</span>
<span class="cm"> * NO  EVENT  SHALL   THE AUTHOR  BE    LIABLE FOR ANY   DIRECT,  INDIRECT,</span>
<span class="cm"> * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT</span>
<span class="cm"> * NOT LIMITED   TO, PROCUREMENT OF  SUBSTITUTE GOODS  OR SERVICES; LOSS OF</span>
<span class="cm"> * USE, DATA,  OR PROFITS; OR  BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON</span>
<span class="cm"> * ANY THEORY OF LIABILITY, WHETHER IN  CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF</span>
<span class="cm"> * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the  GNU General Public License along</span>
<span class="cm"> * with this program; if not, write  to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *******************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/poison.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;linux/atm.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#ifdef CONFIG_ATM_IDT77252_USE_SUNI</span>
<span class="cp">#include &quot;suni.h&quot;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_IDT77252_USE_SUNI */</span><span class="cp"></span>


<span class="cp">#include &quot;idt77252.h&quot;</span>
<span class="cp">#include &quot;idt77252_tables.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vpibits</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>


<span class="cp">#define ATM_IDT77252_SEND_IDLE 1</span>


<span class="cm">/*</span>
<span class="cm"> * Debug HACKs.</span>
<span class="cm"> */</span>
<span class="cp">#define DEBUG_MODULE 1</span>
<span class="cp">#undef HAVE_EEPROM	</span><span class="cm">/* does not work, yet. */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ATM_IDT77252_DEBUG</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">DBG_GENERAL</span><span class="p">;</span>
<span class="cp">#endif</span>


<span class="cp">#define SAR_RX_DELAY	(SAR_CFG_RXINT_NODELAY)</span>


<span class="cm">/*</span>
<span class="cm"> * SCQ Handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span><span class="n">alloc_scq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_scq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">queue_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oam</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">drain_scq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">get_free_scd</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fill_scd</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * FBQ Handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">push_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">recycle_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_rx_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_pool</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">recycle_rx_pool_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">rx_pool</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">add_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * RSQ Handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">init_rsq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">deinit_rsq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">idt77252_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * TSQ handling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">init_tsq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">deinit_tsq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">idt77252_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * ATM Interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">idt77252_dev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">idt77252_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">idt77252_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">idt77252_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">idt77252_send_oam</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cell</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">idt77252_phy_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">idt77252_phy_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">idt77252_change_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">idt77252_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">pos</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">idt77252_softint</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">idt77252_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">dev_close</span>	<span class="o">=</span> <span class="n">idt77252_dev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">idt77252_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">idt77252_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send</span>		<span class="o">=</span> <span class="n">idt77252_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_oam</span>	<span class="o">=</span> <span class="n">idt77252_send_oam</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_put</span>	<span class="o">=</span> <span class="n">idt77252_phy_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_get</span>	<span class="o">=</span> <span class="n">idt77252_phy_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_qos</span>	<span class="o">=</span> <span class="n">idt77252_change_qos</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_read</span>	<span class="o">=</span> <span class="n">idt77252_proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">idt77252_chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idt77252_sram_write_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* I/O and Utility Bus                                                       */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">waitfor_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_STAT</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_CMDBZ</span><span class="p">)</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_STAT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">read_sram</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_READ_SRAM</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">SAR_REG_CMD</span><span class="p">);</span>
	<span class="n">waitfor_idle</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_DR0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_sram</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">idt77252_sram_write_errors</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(((</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span><span class="p">))</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ERROR: TST JMP section at %08lx written: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SAR_REG_DR0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_WRITE_SRAM</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">SAR_REG_CMD</span><span class="p">);</span>
	<span class="n">waitfor_idle</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">read_utility</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ubus_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error: No such device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_READ_UTILITY</span> <span class="o">+</span> <span class="n">ubus_addr</span><span class="p">,</span> <span class="n">SAR_REG_CMD</span><span class="p">);</span>
	<span class="n">waitfor_idle</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_DR0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">write_utility</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ubus_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error: No such device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">value</span><span class="p">,</span> <span class="n">SAR_REG_DR0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_WRITE_UTILITY</span> <span class="o">+</span> <span class="n">ubus_addr</span><span class="p">,</span> <span class="n">SAR_REG_CMD</span><span class="p">);</span>
	<span class="n">waitfor_idle</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef HAVE_EEPROM</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">rdsrtab</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">SAR_GP_EECS</span> <span class="o">|</span> <span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="n">SAR_GP_EEDO</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span> <span class="o">|</span> <span class="n">SAR_GP_EEDO</span><span class="p">,</span>	<span class="cm">/* 1 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="n">SAR_GP_EEDO</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span> <span class="o">|</span> <span class="n">SAR_GP_EEDO</span>	<span class="cm">/* 1 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">wrentab</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">SAR_GP_EECS</span> <span class="o">|</span> <span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="n">SAR_GP_EEDO</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span> <span class="o">|</span> <span class="n">SAR_GP_EEDO</span><span class="p">,</span>	<span class="cm">/* 1 */</span>
	<span class="n">SAR_GP_EEDO</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span> <span class="o">|</span> <span class="n">SAR_GP_EEDO</span><span class="p">,</span>	<span class="cm">/* 1 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span>			<span class="cm">/* 0 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">rdtab</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">SAR_GP_EECS</span> <span class="o">|</span> <span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="n">SAR_GP_EEDO</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span> <span class="o">|</span> <span class="n">SAR_GP_EEDO</span><span class="p">,</span>	<span class="cm">/* 1 */</span>
	<span class="n">SAR_GP_EEDO</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span> <span class="o">|</span> <span class="n">SAR_GP_EEDO</span>	<span class="cm">/* 1 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">wrtab</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">SAR_GP_EECS</span> <span class="o">|</span> <span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>			<span class="cm">/* 0 */</span>
	<span class="n">SAR_GP_EEDO</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span> <span class="o">|</span> <span class="n">SAR_GP_EEDO</span><span class="p">,</span>	<span class="cm">/* 1 */</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span>			<span class="cm">/* 0 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">clktab</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="n">SAR_GP_EESCLK</span><span class="p">,</span>
	<span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">idt77252_read_gp</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gp</span><span class="p">;</span>

	<span class="n">gp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_GP</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(&quot;RD: %s\n&quot;, gp &amp; SAR_GP_EEDI ? &quot;1&quot; : &quot;0&quot;);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">gp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_write_gp</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk(&quot;WR: %s %s %s\n&quot;, value &amp; SAR_GP_EECS ? &quot;   &quot; : &quot;/CS&quot;,</span>
<span class="c">	       value &amp; SAR_GP_EESCLK ? &quot;HIGH&quot; : &quot;LOW &quot;,</span>
<span class="c">	       value &amp; SAR_GP_EEDO   ? &quot;1&quot; : &quot;0&quot;);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">waitfor_idle</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SAR_REG_GP</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">idt77252_eeprom_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">gp</span> <span class="o">=</span> <span class="n">idt77252_read_gp</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SAR_GP_EESCLK</span><span class="o">|</span><span class="n">SAR_GP_EECS</span><span class="o">|</span><span class="n">SAR_GP_EEDO</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rdsrtab</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">rdsrtab</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">byte</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">byte</span> <span class="o">|=</span> <span class="n">idt77252_read_gp</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAR_GP_EEDI</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">byte</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">idt77252_eeprom_read_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">byte</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">gp</span> <span class="o">=</span> <span class="n">idt77252_read_gp</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SAR_GP_EESCLK</span><span class="o">|</span><span class="n">SAR_GP_EECS</span><span class="o">|</span><span class="n">SAR_GP_EEDO</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rdtab</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">rdtab</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SAR_GP_EEDO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SAR_GP_EEDO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">byte</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">byte</span> <span class="o">|=</span> <span class="n">idt77252_read_gp</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAR_GP_EEDI</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">byte</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_eeprom_write_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">gp</span> <span class="o">=</span> <span class="n">idt77252_read_gp</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SAR_GP_EESCLK</span><span class="o">|</span><span class="n">SAR_GP_EECS</span><span class="o">|</span><span class="n">SAR_GP_EEDO</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wrentab</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">wrentab</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wrtab</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">wrtab</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SAR_GP_EEDO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SAR_GP_EEDO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SAR_GP_EEDO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">clktab</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">SAR_GP_EEDO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

		<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_eeprom_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">gp</span><span class="p">;</span>

	<span class="n">gp</span> <span class="o">=</span> <span class="n">idt77252_read_gp</span><span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SAR_GP_EESCLK</span><span class="o">|</span><span class="n">SAR_GP_EECS</span><span class="o">|</span><span class="n">SAR_GP_EEDO</span><span class="p">);</span>

	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span> <span class="o">|</span> <span class="n">SAR_GP_EESCLK</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span> <span class="o">|</span> <span class="n">SAR_GP_EESCLK</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="n">idt77252_write_gp</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">gp</span> <span class="o">|</span> <span class="n">SAR_GP_EECS</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* HAVE_EEPROM */</span><span class="cp"></span>


<span class="cp">#ifdef CONFIG_ATM_IDT77252_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dump_tct</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tct</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">tct</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TCT %x:&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %08x&quot;</span><span class="p">,</span> <span class="n">read_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_tx_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_vcc</span><span class="p">)</span>
			<span class="n">vcc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_vcc</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span><span class="p">)</span>
			<span class="n">vcc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Connection %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">dump_tct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* SCQ Handling                                                              */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb_pool_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sb_pool</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">[</span><span class="n">queue</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FBQ_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pool</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">IDT77252_PRV_POOL</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">POOL_HANDLE</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">pool</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FBQ_MASK</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sb_pool_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">handle</span><span class="p">;</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">IDT77252_PRV_POOL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">POOL_QUEUE</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">POOL_INDEX</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">FBQ_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">skb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">sb_pool_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">POOL_QUEUE</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">POOL_INDEX</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">FBQ_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">skb</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span>
<span class="nf">alloc_scq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">;</span>

	<span class="n">scq</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">scq_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">SCQ_SIZE</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scq</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SCQ_SIZE</span><span class="p">);</span>

	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">SCQ_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skblock</span><span class="p">);</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">transmit</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>

	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;idt77252: SCQ: base 0x%p, next 0x%p, last 0x%p, paddr %08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">scq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">free_scq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">SCQ_SIZE</span><span class="p">,</span>
			    <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">transmit</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">scq</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">push_on_scq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scqe</span> <span class="o">*</span><span class="n">tbd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>

	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: SCQ: next 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
	<span class="n">entries</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">SCQ_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">transmit</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>

		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="o">-&gt;</span><span class="n">cells</span> <span class="o">+=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">47</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">)</span> <span class="o">&gt;</span>
		    <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">cps</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="o">-&gt;</span><span class="n">maxcps</span><span class="p">;</span>

			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="o">-&gt;</span><span class="n">cps</span> <span class="o">=</span> <span class="n">cps</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="o">-&gt;</span><span class="n">avcps</span> <span class="o">=</span> <span class="n">cps</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lacr</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">init_er</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vc</span><span class="o">-&gt;</span><span class="n">lacr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">init_er</span><span class="p">;</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">TCMDQ_LACR</span> <span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lacr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				       <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">SAR_REG_TCMDQ</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">IDT77252_PRV_TBD</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">word_1</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_1</span> <span class="o">|</span>
					<span class="n">SAR_TBD_TSIF</span> <span class="o">|</span> <span class="n">SAR_TBD_GTSI</span><span class="p">);</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_2</span><span class="p">);</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">word_3</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_3</span><span class="p">);</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">word_4</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span>
		<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>

	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span><span class="p">,</span>
		   <span class="n">scq</span><span class="o">-&gt;</span><span class="n">paddr</span> <span class="o">+</span>
		   <span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">VCF_IDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TCMDQ_START_LACR</span> <span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lacr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
		       <span class="n">SAR_REG_TCMDQ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;%d entries in SCQ used (push).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">));</span>

	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;%s: SCQ (after push %2d) head = 0x%x, next = 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">),</span>
		<span class="n">read_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Error pushing TBD for %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ATM_IDT77252_DEBUG</span>
		<span class="n">idt77252_tx_dump</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">scq</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">drain_scq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>

	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: SCQ (before drain %2d) next = 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">),</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">transmit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: freeing skb at %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

		<span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skblock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">push_on_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skblock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">queue_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span>
	  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scqe</span> <span class="o">*</span><span class="n">tbd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: invalid skb-&gt;len (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Sending %d bytes of data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">tbd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">IDT77252_PRV_TBD</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>

	<span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oam</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">52</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_1</span> <span class="o">=</span> <span class="n">SAR_TBD_OAM</span> <span class="o">|</span> <span class="n">ATM_CELL_PAYLOAD</span> <span class="o">|</span> <span class="n">SAR_TBD_EPDU</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_3</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_RSV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_RSV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Trying to transmit on reserved VC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aal</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATM_AAL0</span>:
	<span class="k">case</span> <span class="n">ATM_AAL34</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">52</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span>
			<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_1</span> <span class="o">=</span> <span class="n">SAR_TBD_EPDU</span> <span class="o">|</span> <span class="n">SAR_TBD_AAL0</span> <span class="o">|</span>
				      <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_1</span> <span class="o">=</span> <span class="n">SAR_TBD_EPDU</span> <span class="o">|</span> <span class="n">SAR_TBD_AAL34</span> <span class="o">|</span>
				      <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>

		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_3</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATM_AAL5</span>:
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_1</span> <span class="o">=</span> <span class="n">SAR_TBD_EPDU</span> <span class="o">|</span> <span class="n">SAR_TBD_AAL5</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_3</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_4</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="n">SAR_TBD_VPI_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			      <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="n">SAR_TBD_VCI_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATM_AAL1</span>:
	<span class="k">case</span> <span class="n">ATM_AAL2</span>:
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Traffic type not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">errout</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skblock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">push_on_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skblock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">errout:</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
			 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">get_free_scd</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">scd_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_SCD_SIZE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fill_scd</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">clear_scd</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* RSQ Handling                                                              */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_rsq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rsq_entry</span> <span class="o">*</span><span class="n">rsqe</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">RSQSIZE</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t allocate RSQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RSQSIZE</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">RSQ_NUM_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">last</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">rsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span> <span class="n">rsqe</span> <span class="o">&lt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">last</span><span class="p">;</span> <span class="n">rsqe</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">last</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
	       <span class="n">SAR_REG_RSQH</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">paddr</span><span class="p">,</span> <span class="n">SAR_REG_RSQB</span><span class="p">);</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: RSQ base at 0x%lx (0x%x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_RSQB</span><span class="p">));</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: RSQ head = 0x%x, base = 0x%x, tail = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_RSQH</span><span class="p">),</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_RSQB</span><span class="p">),</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_RSQT</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">deinit_rsq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">RSQSIZE</span><span class="p">,</span>
			    <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dequeue_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rsq_entry</span> <span class="o">*</span><span class="n">rsqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_pool</span> <span class="o">*</span><span class="n">rpp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">header</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_RSQE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: message about inactive connection.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">sb_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: NULL skb in %s, rsqe: %08x %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_2</span><span class="p">),</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_3</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_4</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">header</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">);</span>
	<span class="n">vpi</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
	<span class="n">vci</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: SDU for %d.%d received in buffer 0x%p (data 0x%p).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vpi</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">vci</span> <span class="o">!=</span> <span class="p">(</span><span class="n">vci</span> <span class="o">&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcimask</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SDU received for out-of-range vc %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="n">recycle_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">VPCI2VC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SDU received on non RX vc %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="n">recycle_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vcc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_vcc</span><span class="p">;</span>

	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				    <span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL34</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">aal0</span><span class="p">;</span>

		<span class="n">cell</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_RSQE_CELLCNT</span><span class="p">);</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Can&#39;t allocate buffers for aal0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">atomic_add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: atm_charge() dropped aal0 packets.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">atomic_add</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">aal0</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="n">ATM_HDR_VPI_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			       <span class="p">(</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="n">ATM_HDR_VCI_SHIFT</span><span class="p">);</span>
			<span class="n">aal0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_RSQE_EPDU</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00000002</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">aal0</span> <span class="o">|=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_RSQE_CLP</span><span class="p">)</span>  <span class="o">?</span> <span class="mh">0x00000001</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

			<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="n">aal0</span><span class="p">;</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">),</span>
			       <span class="n">cell</span><span class="p">,</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">);</span>

			<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

			<span class="n">cell</span> <span class="o">+=</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">recycle_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Unexpected AAL type in dequeue_rx(): %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">);</span>
		<span class="n">recycle_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_RSQE_CELLCNT</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>

	<span class="n">rpp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rcv</span><span class="p">.</span><span class="n">rx_pool</span><span class="p">;</span>

	<span class="n">__skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpp</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">rpp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_RSQE_EPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">l1l2</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">l1l2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1l2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">l1l2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="mh">0x10000</span><span class="p">;</span>

		<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: PDU has %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">rpp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="p">(</span><span class="mi">47</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">rpp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: AAL5 PDU size mismatch: %d != %d. &quot;</span>
			         <span class="s">&quot;(CDC: %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			         <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rpp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_CDC</span><span class="p">));</span>
			<span class="n">recycle_rx_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rpp</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_RSQE_CRC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: AAL5 CRC error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">recycle_rx_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rpp</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpp</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">rpp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Can&#39;t alloc RX skb.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">recycle_rx_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rpp</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">recycle_rx_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rpp</span><span class="p">);</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpp</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">sb</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
				       <span class="n">sb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

			<span class="n">recycle_rx_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rpp</span><span class="p">);</span>

			<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">flush_rx_pool</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rpp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">recycle_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				 <span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">sb_pool_remove</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
		<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">&gt;</span> <span class="n">SAR_FB_SIZE_3</span><span class="p">)</span>
			<span class="n">add_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_3</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">&gt;</span> <span class="n">SAR_FB_SIZE_2</span><span class="p">)</span>
			<span class="n">add_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span> <span class="o">&gt;</span> <span class="n">SAR_FB_SIZE_1</span><span class="p">)</span>
			<span class="n">add_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">add_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rsq_entry</span> <span class="o">*</span><span class="n">rsqe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
		<span class="n">rsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAR_RSQE_VALID</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: no entry in RSQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dequeue_rx</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rsqe</span><span class="p">);</span>
		<span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">rsqe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
			<span class="n">rsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAR_RSQE_VALID</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
	       <span class="n">SAR_REG_RSQH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_rx_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">u32</span>		<span class="n">head</span><span class="p">,</span> <span class="n">tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span>	<span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span>	<span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">sb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_hnd</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_head</span> <span class="o">=</span> <span class="n">sb_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_head</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_RAWCT</span><span class="p">);</span>

	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
				    <span class="n">skb_end_offset</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">-</span> <span class="mi">16</span><span class="p">,</span>
				    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">head</span> <span class="o">!=</span> <span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">header</span><span class="p">;</span>

		<span class="n">header</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">vpi</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span> <span class="o">&amp;</span> <span class="n">ATM_HDR_VPI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ATM_HDR_VPI_SHIFT</span><span class="p">;</span>
		<span class="n">vci</span> <span class="o">=</span> <span class="p">(</span><span class="n">header</span> <span class="o">&amp;</span> <span class="n">ATM_HDR_VCI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ATM_HDR_VCI_SHIFT</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ATM_IDT77252_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_RAW_CELL</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: raw cell %x.%02x.%04x.%x.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span>  <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span>  <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0007</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">header</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">)</span> <span class="o">||</span> <span class="n">vci</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RPRINTK</span><span class="p">(</span><span class="s">&quot;%s: SDU received for out-of-range vc %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">VPCI2VC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">)];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span> <span class="o">||</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RPRINTK</span><span class="p">(</span><span class="s">&quot;%s: SDU received on non RX vc %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vcc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_vcc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RPRINTK</span><span class="p">(</span><span class="s">&quot;%s: raw cell for non AAL0 vc %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>
	
		<span class="k">if</span> <span class="p">((</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="mi">64</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Can&#39;t allocate buffers for AAL0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: atm_charge() dropped AAL0 packets.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="n">header</span><span class="p">;</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">]),</span>
		       <span class="n">ATM_CELL_PAYLOAD</span><span class="p">);</span>

		<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
		<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

<span class="nl">drop:</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">queue</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

		<span class="n">head</span> <span class="o">=</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
					<span class="o">+</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">handle</span><span class="p">;</span>

			<span class="n">head</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">handle</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

			<span class="n">next</span> <span class="o">=</span> <span class="n">sb_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
			<span class="n">recycle_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_head</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
				<span class="n">queue</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_head</span><span class="p">;</span>
				<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
							    <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
							    <span class="p">(</span><span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">-</span>
							     <span class="n">queue</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
							    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: raw cell queue overrun</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* TSQ Handling                                                              */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">init_tsq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsq_entry</span> <span class="o">*</span><span class="n">tsqe</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">RSQSIZE</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t allocate TSQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TSQSIZE</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">TSQ_NUM_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span> <span class="n">tsqe</span> <span class="o">&lt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">;</span> <span class="n">tsqe</span><span class="o">++</span><span class="p">)</span>
		<span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SAR_TSQE_INVALID</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">paddr</span><span class="p">,</span> <span class="n">SAR_REG_TSQB</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
	       <span class="n">SAR_REG_TSQH</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">deinit_tsq</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">TSQSIZE</span><span class="p">,</span>
			    <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">paddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tsq_entry</span> <span class="o">*</span><span class="n">tsqe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">conn</span><span class="p">,</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
		<span class="n">tsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;idt77252_tx: tsq  %p: base %p, next %p, last %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsqe</span><span class="p">,</span>
		 <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;idt77252_tx: tsqb %08x, tsqt %08x, tsqh %08x, </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_TSQB</span><span class="p">),</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_TSQT</span><span class="p">),</span>
		 <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_TSQH</span><span class="p">));</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_TSQE_INVALID</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;tsqe: 0x%p [0x%08x 0x%08x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsqe</span><span class="p">,</span>
			 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">),</span>
			 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_2</span><span class="p">));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_TSQE_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SAR_TSQE_TYPE_TIMER</span>:
			<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Timer RollOver detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SAR_TSQE_TYPE_IDLE</span>:

			<span class="n">conn</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">SAR_TSQE_TAG</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef	NOTDEF</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Connection %d halted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: could not find VC from conn %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">conn</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Connection %d IDLE.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">VCF_IDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SAR_TSQE_TYPE_TSR</span>:

			<span class="n">conn</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">);</span>

			<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">conn</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: no VC at index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">drain_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SAR_TSQE_TYPE_TBD_COMP</span>:

			<span class="n">conn</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">);</span>

			<span class="n">vpi</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&gt;&gt;</span> <span class="n">SAR_TBD_VPI_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">;</span>
			<span class="n">vci</span> <span class="o">=</span> <span class="p">(</span><span class="n">conn</span> <span class="o">&gt;&gt;</span> <span class="n">SAR_TBD_VCI_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">vci</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TBD complete: &quot;</span>
				       <span class="s">&quot;out of range VPI.VCI %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">VPCI2VC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">)];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TBD complete: &quot;</span>
				       <span class="s">&quot;no VC at VPI.VCI %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">drain_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">SAR_TSQE_INVALID</span><span class="p">);</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">tsqe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
			<span class="n">tsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tsqe</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;tsqe: %p: base %p, next %p, last %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsqe</span><span class="p">,</span>
			 <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>

		<span class="n">stat</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsqe</span><span class="o">-&gt;</span><span class="n">word_2</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_TSQE_INVALID</span><span class="p">));</span>

	<span class="n">writel</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span>
	       <span class="n">SAR_REG_TSQH</span><span class="p">);</span>

	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;idt77252_tx-after writel%d: TSQ head = 0x%x, tail = 0x%x, next = 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_TSQH</span><span class="p">),</span>
		<span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_TSQT</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tst_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span> <span class="n">idle</span><span class="p">,</span> <span class="n">jump</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">e</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_index</span><span class="p">];</span>
	<span class="n">idle</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_index</span> <span class="o">^</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">TST_SWITCH_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">jump</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">pc</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_NOW</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">^</span> <span class="n">idle</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clear_bit</span><span class="p">(</span><span class="n">TST_SWITCH_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_state</span><span class="p">);</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_index</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">TSTE_OPC_JMP</span> <span class="o">|</span> <span class="p">(</span><span class="n">base</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>

		<span class="n">base</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_index</span><span class="p">];</span>
		<span class="n">idle</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_index</span> <span class="o">^</span> <span class="mi">1</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">e</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">&amp;</span> <span class="n">TSTE_PUSH_IDLE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">idle</span> <span class="o">+</span> <span class="n">e</span><span class="p">,</span>
					   <span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">&amp;</span> <span class="n">TSTE_MASK</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSTE_PUSH_IDLE</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">TST_SWITCH_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_state</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">e</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">&amp;</span> <span class="n">TSTE_PUSH_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">idle</span> <span class="o">+</span> <span class="n">e</span><span class="p">,</span>
					   <span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">&amp;</span> <span class="n">TSTE_MASK</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TSTE_PUSH_ACTIVE</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">|=</span> <span class="n">TSTE_PUSH_IDLE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">jump</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">jump</span><span class="p">,</span> <span class="n">TSTE_OPC_NULL</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">TST_SWITCH_WAIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_state</span><span class="p">);</span>

		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__fill_tst</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span>
	   <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cl</span><span class="p">,</span> <span class="n">avail</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">avail</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">avail</span><span class="p">;</span> <span class="n">e</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">vc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&gt;=</span> <span class="n">avail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: No free TST entries found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">NPRINTK</span><span class="p">(</span><span class="s">&quot;%s: conn %d: first TST entry at %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vc</span> <span class="o">?</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">cl</span> <span class="o">=</span> <span class="n">avail</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">opc</span> <span class="o">&amp;</span> <span class="n">TSTE_OPC_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">opc</span> <span class="o">!=</span> <span class="n">TSTE_OPC_NULL</span><span class="p">))</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">opc</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">idle</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_index</span> <span class="o">^</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fill Soft TST.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cl</span> <span class="o">&gt;=</span> <span class="n">avail</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">vc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">vc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">))</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">|=</span> <span class="n">TSTE_PUSH_ACTIVE</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">idle</span> <span class="o">+</span> <span class="n">e</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">|=</span> <span class="n">TSTE_PUSH_IDLE</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">cl</span> <span class="o">-=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span><span class="p">;</span>
			<span class="n">r</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">e</span> <span class="o">==</span> <span class="n">avail</span><span class="p">)</span>
			<span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cl</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fill_tst</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">__fill_tst</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TST_SWITCH_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__clear_tst</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">e</span><span class="p">;</span>

	<span class="n">idle</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_index</span> <span class="o">^</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">e</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">vc</span> <span class="o">==</span> <span class="n">vc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">vc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">=</span> <span class="n">TSTE_OPC_VAR</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">))</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">|=</span> <span class="n">TSTE_PUSH_ACTIVE</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">idle</span> <span class="o">+</span> <span class="n">e</span><span class="p">,</span> <span class="n">TSTE_OPC_VAR</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">e</span><span class="p">].</span><span class="n">tste</span> <span class="o">|=</span> <span class="n">TSTE_PUSH_IDLE</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">clear_tst</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">__clear_tst</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TST_SWITCH_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">change_tst</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span>
	   <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">opc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">__clear_tst</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">__fill_tst</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">opc</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">TST_SWITCH_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_tct</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tct</span><span class="p">;</span>

	<span class="n">tct</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SCHED_CBR</span>:
		<span class="n">OPRINTK</span><span class="p">(</span><span class="s">&quot;%s: writing TCT at 0x%lx, SCD 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		        <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tct</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span><span class="p">);</span>

		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TCT_CBR</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCHED_UBR</span>:
		<span class="n">OPRINTK</span><span class="p">(</span><span class="s">&quot;%s: writing TCT at 0x%lx, SCD 0x%lx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		        <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tct</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span><span class="p">);</span>

		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TCT_UBR</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">TCT_TSIF</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">TCT_HALT</span> <span class="o">|</span> <span class="n">TCT_IDLE</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">init_er</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">TCT_FLAG_UBR</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SCHED_VBR</span>:
	<span class="k">case</span> <span class="n">SCHED_ABR</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* FBQ Handling                                                              */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span>
<span class="nf">idt77252_fbq_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_STAT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">int</span>
<span class="nf">idt77252_fbq_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_STAT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">+</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">==</span> <span class="mh">0x0f</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">push_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">handle</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idt77252_fbq_full</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">))</span> <span class="o">-</span> <span class="mi">64</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">IDT77252_PRV_POOL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">fbq</span><span class="p">[</span><span class="n">queue</span><span class="p">]);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">fbq</span><span class="p">[</span><span class="n">queue</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">add_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span>
	   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">handle</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sb_pool_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SB POOL full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">outfree</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">paddr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">push_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: FB QUEUE full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">outunmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">outunmap:</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
			 <span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">handle</span> <span class="o">=</span> <span class="n">IDT77252_PRV_POOL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">[</span><span class="n">POOL_QUEUE</span><span class="p">(</span><span class="n">handle</span><span class="p">)].</span><span class="n">skb</span><span class="p">[</span><span class="n">POOL_INDEX</span><span class="p">(</span><span class="n">handle</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">outfree:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">recycle_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">IDT77252_PRV_POOL</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				       <span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">push_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">POOL_QUEUE</span><span class="p">(</span><span class="n">handle</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				 <span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">sb_pool_remove</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">flush_rx_pool</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_pool</span> <span class="o">*</span><span class="n">rpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpp</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">rpp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">recycle_rx_pool_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rx_pool</span> <span class="o">*</span><span class="n">rpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">skb_queue_walk_safe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rpp</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
		<span class="n">recycle_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">flush_rx_pool</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rpp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* ATM Interface                                                             */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_phy_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_utility</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">,</span> <span class="mh">0x100</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">idt77252_phy_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">read_utility</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">,</span> <span class="mh">0x100</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">idt77252_send_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">oam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: NULL connection in send().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Trying to transmit on a non-tx VC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATM_AAL0</span>:
	<span class="k">case</span> <span class="n">ATM_AAL1</span>:
	<span class="k">case</span> <span class="n">ATM_AAL5</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Unsupported AAL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: No scatter-gather yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">queue_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">oam</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">idt77252_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">idt77252_send_skb</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">idt77252_send_oam</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">cell</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Out of memory in send_oam().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_add</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">52</span><span class="p">),</span> <span class="n">cell</span><span class="p">,</span> <span class="mi">52</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">idt77252_send_skb</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__inline__</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">idt77252_fls</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span>
<span class="nf">idt77252_int_to_atmfp</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">m</span><span class="p">,</span> <span class="n">e</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">idt77252_fls</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">9</span> <span class="o">-</span> <span class="n">e</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span>
		<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">));</span>
	<span class="k">else</span> <span class="cm">/* e &gt; 9 */</span>
		<span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">e</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">return</span> <span class="mh">0x4000</span> <span class="o">|</span> <span class="p">(</span><span class="n">e</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">idt77252_rate_logindex</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">afp</span><span class="p">;</span>

	<span class="n">afp</span> <span class="o">=</span> <span class="n">idt77252_int_to_atmfp</span><span class="p">(</span><span class="n">pcr</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="n">pcr</span> <span class="o">:</span> <span class="n">pcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rate_to_log</span><span class="p">[(</span><span class="n">afp</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">rate_to_log</span><span class="p">[((</span><span class="n">afp</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ff</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_est_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rate_estimator</span> <span class="o">*</span><span class="n">est</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">,</span> <span class="n">cps</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">ncells</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lacr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">est</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">est</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ncells</span> <span class="o">=</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">cells</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)(</span><span class="n">ncells</span> <span class="o">-</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">last_cells</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>
	<span class="n">est</span><span class="o">-&gt;</span><span class="n">last_cells</span> <span class="o">=</span> <span class="n">ncells</span><span class="p">;</span>
	<span class="n">est</span><span class="o">-&gt;</span><span class="n">avcps</span> <span class="o">+=</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">rate</span> <span class="o">-</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">avcps</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">ewma_log</span><span class="p">;</span>
	<span class="n">est</span><span class="o">-&gt;</span><span class="n">cps</span> <span class="o">=</span> <span class="p">(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">avcps</span> <span class="o">+</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">cps</span> <span class="o">=</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">cps</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cps</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">maxcps</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">cps</span> <span class="o">=</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">maxcps</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">lacr</span> <span class="o">=</span> <span class="n">idt77252_rate_logindex</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">cps</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lacr</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">max_er</span><span class="p">)</span>
		<span class="n">lacr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">max_er</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lacr</span> <span class="o">!=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">lacr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">lacr</span> <span class="o">=</span> <span class="n">lacr</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">TCMDQ_LACR</span><span class="o">|</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lacr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">|</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">SAR_REG_TCMDQ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">est</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rate_estimator</span> <span class="o">*</span>
<span class="nf">idt77252_init_est</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pcr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rate_estimator</span> <span class="o">*</span><span class="n">est</span><span class="p">;</span>

	<span class="n">est</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rate_estimator</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">est</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">est</span><span class="o">-&gt;</span><span class="n">maxcps</span> <span class="o">=</span> <span class="n">pcr</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="n">pcr</span> <span class="o">:</span> <span class="n">pcr</span><span class="p">;</span>
	<span class="n">est</span><span class="o">-&gt;</span><span class="n">cps</span> <span class="o">=</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">maxcps</span><span class="p">;</span>
	<span class="n">est</span><span class="o">-&gt;</span><span class="n">avcps</span> <span class="o">=</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">cps</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">est</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* XXX: make this configurable */</span>
	<span class="n">est</span><span class="o">-&gt;</span><span class="n">ewma_log</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* XXX: make this configurable */</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">est</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vc</span><span class="p">;</span>
	<span class="n">est</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">idt77252_est_timer</span><span class="p">;</span>

	<span class="n">est</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">((</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">est</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">est</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">est</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">idt77252_init_cbr</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tst_free</span><span class="p">,</span> <span class="n">tst_used</span><span class="p">,</span> <span class="n">tst_entries</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpl</span><span class="p">,</span> <span class="n">modl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tcr</span><span class="p">,</span> <span class="n">tcra</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: trying to open a CBR VC with cell rate = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tst_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tst_free</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">tst_used</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">ntste</span><span class="p">;</span>
	<span class="n">tst_free</span> <span class="o">+=</span> <span class="n">tst_used</span><span class="p">;</span>

	<span class="n">tcr</span> <span class="o">=</span> <span class="n">atm_pcr_goal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">);</span>
	<span class="n">tcra</span> <span class="o">=</span> <span class="n">tcr</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">tcr</span> <span class="o">:</span> <span class="o">-</span><span class="n">tcr</span><span class="p">;</span>

	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;%s: CBR target cell rate = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tcra</span><span class="p">);</span>

	<span class="n">tmpl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">tcra</span> <span class="o">*</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">modl</span> <span class="o">=</span> <span class="n">tmpl</span> <span class="o">%</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">utopia_pcr</span><span class="p">;</span>

	<span class="n">tst_entries</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">tmpl</span> <span class="o">/</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">utopia_pcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">modl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tst_entries</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tst_entries</span> <span class="o">=</span> <span class="n">tst_free</span> <span class="o">-</span> <span class="n">SAR_TST_RESERVED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tst_entries</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: no CBR bandwidth free.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSR</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tst_entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: selected CBR bandwidth &lt; granularity.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tst_entries</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">tst_free</span> <span class="o">-</span> <span class="n">SAR_TST_RESERVED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: not enough CBR bandwidth free.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">ntste</span> <span class="o">=</span> <span class="n">tst_entries</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free</span> <span class="o">=</span> <span class="n">tst_free</span> <span class="o">-</span> <span class="n">tst_entries</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tst_used</span> <span class="o">==</span> <span class="n">tst_entries</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">OPRINTK</span><span class="p">(</span><span class="s">&quot;%s: modify %d -&gt; %d entries in TST.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tst_used</span><span class="p">,</span> <span class="n">tst_entries</span><span class="p">);</span>
		<span class="n">change_tst</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">tst_entries</span><span class="p">,</span> <span class="n">TSTE_OPC_CBR</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">OPRINTK</span><span class="p">(</span><span class="s">&quot;%s: setting %d entries in TST.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tst_entries</span><span class="p">);</span>
	<span class="n">fill_tst</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">tst_entries</span><span class="p">,</span> <span class="n">TSTE_OPC_CBR</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">idt77252_init_ubr</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tcr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tcr</span> <span class="o">=</span> <span class="n">atm_pcr_goal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tcr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">link_pcr</span><span class="p">;</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span> <span class="o">=</span> <span class="n">idt77252_init_est</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">tcr</span><span class="p">);</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">SCHED_UBR</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">init_er</span> <span class="o">=</span> <span class="n">idt77252_rate_logindex</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tcr</span><span class="p">);</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">lacr</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">init_er</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tcr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">max_er</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">init_er</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">max_er</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">idt77252_init_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATM_CBR</span>:
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">SCHED_CBR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ATM_UBR</span>:
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">SCHED_UBR</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ATM_VBR</span>:
		<span class="k">case</span> <span class="n">ATM_ABR</span>:
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span> <span class="o">=</span> <span class="n">alloc_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get SCQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span> <span class="o">=</span> <span class="n">get_free_scd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: no SCD available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">free_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fill_scd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_tct</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: class %d not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span><span class="p">);</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scd_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">free_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SCHED_CBR</span>:
			<span class="n">error</span> <span class="o">=</span> <span class="n">idt77252_init_cbr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">qos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scd_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">free_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">clear_bit</span><span class="p">(</span><span class="n">VCF_IDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">TCMDQ_START</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">SAR_REG_TCMDQ</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SCHED_UBR</span>:
			<span class="n">error</span> <span class="o">=</span> <span class="n">idt77252_init_ubr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">qos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scd_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">free_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">set_bit</span><span class="p">(</span><span class="n">VCF_IDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">VCF_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">idt77252_init_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">VCF_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">flush_rx_pool</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rcv</span><span class="p">.</span><span class="n">rx_pool</span><span class="p">);</span>

	<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_CONNECTOPEN</span><span class="p">;</span>
	<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_RAWCELLINTEN</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATM_AAL0</span>:
			<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_RCQ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATM_AAL1</span>:
			<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_OAM</span><span class="p">;</span> <span class="cm">/* Let SAR drop Video */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATM_AAL34</span>:
			<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_AAL34</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATM_AAL5</span>:
			<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_AAL5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_RCQ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span><span class="p">)</span>
		<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_FBP_1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">&gt;</span> <span class="n">SAR_FB_SIZE_2</span><span class="p">)</span>
		<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_FBP_3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">&gt;</span> <span class="n">SAR_FB_SIZE_1</span><span class="p">)</span>
		<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_FBP_2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">&gt;</span> <span class="n">SAR_FB_SIZE_0</span><span class="p">)</span>
		<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_FBP_1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rcte</span> <span class="o">|=</span> <span class="n">SAR_RCTE_FBP_01</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">OPRINTK</span><span class="p">(</span><span class="s">&quot;%s: writing RCT at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">rcte</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_OPEN_CONNECTION</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">SAR_REG_CMD</span><span class="p">);</span>
	<span class="n">waitfor_idle</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">idt77252_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inuse</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vci</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">vpi</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">==</span> <span class="n">ATM_VPI_UNSPEC</span> <span class="o">||</span> <span class="n">vci</span> <span class="o">==</span> <span class="n">ATM_VCI_UNSPEC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unsupported VPI: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vci</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: unsupported VCI: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">OPRINTK</span><span class="p">(</span><span class="s">&quot;%s: opening vpi.vci: %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATM_AAL0</span>:
	<span class="k">case</span> <span class="n">ATM_AAL1</span>:
	<span class="k">case</span> <span class="n">ATM_AAL5</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Unsupported AAL: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROTONOSUPPORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">VPCI2VC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_map</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t alloc vc in open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: idt77252_open: vc = %d (%d.%d) %s/%s (max RX SDU: %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span>
	        <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span> <span class="o">?</span> <span class="s">&quot;rx&quot;</span> <span class="o">:</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
	        <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span> <span class="o">?</span> <span class="s">&quot;tx&quot;</span> <span class="o">:</span> <span class="s">&quot;--&quot;</span><span class="p">,</span>
	        <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">);</span>

	<span class="n">inuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">inuse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">inuse</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: %s vci already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">inuse</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;tx&quot;</span> <span class="o">:</span> <span class="n">inuse</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="s">&quot;rx&quot;</span> <span class="o">:</span> <span class="s">&quot;tx and rx&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">idt77252_init_tx</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">idt77252_init_rx</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: idt77252_close: vc = %d (%d.%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">VCF_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">SAR_SRAM_RCT_SIZE</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_CLOSE_CONNECTION</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">SAR_REG_CMD</span><span class="p">);</span>
		<span class="n">waitfor_idle</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rcv</span><span class="p">.</span><span class="n">rx_pool</span><span class="p">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%s: closing a VC with pending rx buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

			<span class="n">recycle_rx_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rcv</span><span class="p">.</span><span class="n">rx_pool</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">VCF_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">VCF_IDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">VCF_RSV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span><span class="p">);</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">estimator</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SCQ drain timeout: %u used</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">));</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">TCMDQ_HALT</span> <span class="o">|</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">SAR_REG_TCMDQ</span><span class="p">);</span>
		<span class="n">clear_scd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">==</span> <span class="n">SCHED_CBR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_tst</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free</span> <span class="o">+=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">ntste</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">ntste</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scd_index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">free_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">idt77252_change_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
	    	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_TX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">idt77252_init_tx</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">qos</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ATM_CBR</span>:
				<span class="n">error</span> <span class="o">=</span> <span class="n">idt77252_init_cbr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">qos</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">ATM_UBR</span>:
				<span class="n">error</span> <span class="o">=</span> <span class="n">idt77252_init_ubr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">qos</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_IDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">writel</span><span class="p">(</span><span class="n">TCMDQ_LACR</span> <span class="o">|</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">lacr</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					       <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">SAR_REG_TCMDQ</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">ATM_VBR</span>:
			<span class="k">case</span> <span class="n">ATM_ABR</span>:
				<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">VCF_RX</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">idt77252_init_rx</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">qos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="n">qos</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_qos</span><span class="p">));</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_HASQOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">idt77252_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>

	<span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;IDT77252 Interrupts:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;TSIF:  %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;TXICP: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;TSQF:  %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;TMROF: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;PHYI:  %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;FBQ3A: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;FBQ2A: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;RSQF:  %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;EPDU:  %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;RAWCF: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;FBQ1A: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;FBQ0A: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;RSQAF: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;IDT77252 Transmit Connection Table:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tct</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

		<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span><span class="p">)</span>
			<span class="n">vcc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;  %4u: %u.%u: &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
		<span class="n">tct</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot; %08x&quot;</span><span class="p">,</span> <span class="n">read_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">tct</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* Interrupt handler                                                         */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_collect_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_CDC</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_VPEC</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_ICC</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">idt77252_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span>	<span class="cm">/* no interrupt for us */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">IDT77252_BIT_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Re-entering irq_handler()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span> <span class="n">SAR_REG_STAT</span><span class="p">);</span>	<span class="cm">/* reset interrupt */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_TSIF</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* entry written to TSQ  */</span>
		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: TSIF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idt77252_tx</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_TXICP</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Incomplete CS-PDU has  */</span>
		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: TXICP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_ATM_IDT77252_DEBUG</span>
		<span class="n">idt77252_tx_dump</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_TSQF</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* TSQ 7/8 full           */</span>
		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: TSQF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idt77252_tx</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_TMROF</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Timer overflow         */</span>
		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: TMROF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idt77252_collect_stat</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_EPDU</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Got complete CS-PDU    */</span>
		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: EPDU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idt77252_rx</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_RSQAF</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* RSQ is 7/8 full        */</span>
		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: RSQAF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idt77252_rx</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_RSQF</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* RSQ is full            */</span>
		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: RSQF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idt77252_rx</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_RAWCF</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Raw cell received      */</span>
		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: RAWCF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="n">idt77252_rx_raw</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_PHYI</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* PHY device interrupt   */</span>
		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: PHYI&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SAR_STAT_FBQ0A</span> <span class="o">|</span> <span class="n">SAR_STAT_FBQ1A</span> <span class="o">|</span>
		    <span class="n">SAR_STAT_FBQ2A</span> <span class="o">|</span> <span class="n">SAR_STAT_FBQ3A</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SAR_CFG_FBIE</span><span class="p">),</span> <span class="n">SAR_REG_CFG</span><span class="p">);</span>

		<span class="n">INTPRINTK</span><span class="p">(</span><span class="s">&quot;%s: FBQA: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_FBQ0A</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_FBQ1A</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_FBQ2A</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_FBQ3A</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">irqstat</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IDT77252_BIT_INTERRUPT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">idt77252_softint</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">idt77252_dev</span><span class="p">,</span> <span class="n">tqueue</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">;</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_STAT</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SAR_FBQ0_HIGH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">add_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_0</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">stat</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SAR_FBQ1_HIGH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">add_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_1</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">stat</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SAR_FBQ2_HIGH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">add_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_2</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">stat</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">SAR_FBQ3_HIGH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">add_rx_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">SAR_FB_SIZE_3</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_CFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">SAR_CFG_FBIE</span><span class="p">,</span> <span class="n">SAR_REG_CFG</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_card_oam</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcte</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpi</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">);</span> <span class="n">vpi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">vci</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">vci</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">vci</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">VPCI2VC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>

			<span class="n">vc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_map</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t alloc vc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>

			<span class="n">flush_rx_pool</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rcv</span><span class="p">.</span><span class="n">rx_pool</span><span class="p">);</span>

			<span class="n">rcte</span> <span class="o">=</span> <span class="n">SAR_RCTE_CONNECTOPEN</span> <span class="o">|</span>
			       <span class="n">SAR_RCTE_RAWCELLINTEN</span> <span class="o">|</span>
			       <span class="n">SAR_RCTE_RCQ</span> <span class="o">|</span>
			       <span class="n">SAR_RCTE_FBP_1</span><span class="p">;</span>

			<span class="n">addr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">rcte</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_OPEN_CONNECTION</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			       <span class="n">SAR_REG_CMD</span><span class="p">);</span>
			<span class="n">waitfor_idle</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">close_card_oam</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">vpi</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">);</span> <span class="n">vpi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">vci</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">vci</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">vci</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">VPCI2VC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
			<span class="n">vc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>

			<span class="n">addr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">SAR_SRAM_RCT_SIZE</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_CLOSE_CONNECTION</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
			       <span class="n">SAR_REG_CMD</span><span class="p">);</span>
			<span class="n">waitfor_idle</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rcv</span><span class="p">.</span><span class="n">rx_pool</span><span class="p">.</span><span class="n">queue</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%s: closing a VC &quot;</span>
					<span class="s">&quot;with pending rx buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

				<span class="n">recycle_rx_pool_skb</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rcv</span><span class="p">.</span><span class="n">rx_pool</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">open_card_ubr0</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>

	<span class="n">vc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_map</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t alloc vc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">=</span> <span class="n">SCHED_UBR0</span><span class="p">;</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span> <span class="o">=</span> <span class="n">alloc_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t get SCQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">scd_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_base</span><span class="p">;</span>

	<span class="n">fill_scd</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">class</span><span class="p">);</span>

	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TCT_UBR</span> <span class="o">|</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_base</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="n">TCT_FLAG_UBR</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">VCF_IDLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">TCMDQ_START</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAR_REG_TCMDQ</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">idt77252_dev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IDT77252_BIT_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SAR not yet initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="n">SAR_CFG_RXPTH</span><span class="o">|</span>	<span class="cm">/* enable receive path                  */</span>
	    <span class="n">SAR_RX_DELAY</span> <span class="o">|</span>	<span class="cm">/* interrupt on complete PDU		*/</span>
	    <span class="n">SAR_CFG_RAWIE</span> <span class="o">|</span>	<span class="cm">/* interrupt enable on raw cells        */</span>
	    <span class="n">SAR_CFG_RQFIE</span> <span class="o">|</span>	<span class="cm">/* interrupt on RSQ almost full         */</span>
	    <span class="n">SAR_CFG_TMOIE</span> <span class="o">|</span>	<span class="cm">/* interrupt on timer overflow          */</span>
	    <span class="n">SAR_CFG_FBIE</span> <span class="o">|</span>	<span class="cm">/* interrupt on low free buffers        */</span>
	    <span class="n">SAR_CFG_TXEN</span> <span class="o">|</span>	<span class="cm">/* transmit operation enable            */</span>
	    <span class="n">SAR_CFG_TXINT</span> <span class="o">|</span>	<span class="cm">/* interrupt on transmit status         */</span>
	    <span class="n">SAR_CFG_TXUIE</span> <span class="o">|</span>	<span class="cm">/* interrupt on transmit underrun       */</span>
	    <span class="n">SAR_CFG_TXSFI</span> <span class="o">|</span>	<span class="cm">/* interrupt on TSQ almost full         */</span>
	    <span class="n">SAR_CFG_PHYIE</span>	<span class="cm">/* enable PHY interrupts		*/</span>
	    <span class="p">;</span>

<span class="cp">#ifdef CONFIG_ATM_IDT77252_RCV_ALL</span>
	<span class="cm">/* Test RAW cell receive. */</span>
	<span class="n">conf</span> <span class="o">|=</span> <span class="n">SAR_CFG_VPECA</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_CFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">conf</span><span class="p">,</span> <span class="n">SAR_REG_CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">open_card_oam</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Error initializing OAM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">open_card_ubr0</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Error initializing UBR0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: opened IDT77252 ABR SAR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">idt77252_dev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">conf</span><span class="p">;</span>

	<span class="n">close_card_oam</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="n">SAR_CFG_RXPTH</span> <span class="o">|</span>	<span class="cm">/* enable receive path           */</span>
	    <span class="n">SAR_RX_DELAY</span> <span class="o">|</span>	<span class="cm">/* interrupt on complete PDU     */</span>
	    <span class="n">SAR_CFG_RAWIE</span> <span class="o">|</span>	<span class="cm">/* interrupt enable on raw cells */</span>
	    <span class="n">SAR_CFG_RQFIE</span> <span class="o">|</span>	<span class="cm">/* interrupt on RSQ almost full  */</span>
	    <span class="n">SAR_CFG_TMOIE</span> <span class="o">|</span>	<span class="cm">/* interrupt on timer overflow   */</span>
	    <span class="n">SAR_CFG_FBIE</span> <span class="o">|</span>	<span class="cm">/* interrupt on low free buffers */</span>
	    <span class="n">SAR_CFG_TXEN</span> <span class="o">|</span>	<span class="cm">/* transmit operation enable     */</span>
	    <span class="n">SAR_CFG_TXINT</span> <span class="o">|</span>	<span class="cm">/* interrupt on transmit status  */</span>
	    <span class="n">SAR_CFG_TXUIE</span> <span class="o">|</span>	<span class="cm">/* interrupt on xmit underrun    */</span>
	    <span class="n">SAR_CFG_TXSFI</span>	<span class="cm">/* interrupt on TSQ almost full  */</span>
	    <span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_CFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">conf</span><span class="p">),</span> <span class="n">SAR_REG_CFG</span><span class="p">);</span>

	<span class="n">DIPRINTK</span><span class="p">(</span><span class="s">&quot;%s: closed IDT77252 ABR SAR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* Initialisation and Deinitialization of IDT77252                           */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">deinit_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IDT77252_BIT_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SAR not yet initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DIPRINTK</span><span class="p">(</span><span class="s">&quot;idt77252: deinitialize card %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SAR_REG_CFG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">)</span>
		<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">FBQ_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						 <span class="n">IDT77252_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
						 <span class="p">(</span><span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">-</span>
						  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
						 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_hnd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				    <span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_hnd</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_paddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DIPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Release RSQ ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_rsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DIPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Release TSQ ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_tsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DIPRINTK</span><span class="p">(</span><span class="s">&quot;idt77252: Release IRQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fbq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fbq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IDT77252_BIT_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">DIPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Card deinitialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">init_sram</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sramsize</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* set SRAM layout for THIS card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sramsize</span> <span class="o">==</span> <span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_TCT_128_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAR_SRAM_TCT_128_TOP</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="o">/</span> <span class="n">SAR_SRAM_TCT_SIZE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_RCT_128_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAR_SRAM_RCT_128_TOP</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="o">/</span> <span class="n">SAR_SRAM_RCT_SIZE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rt_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_RT_128_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_SCD_128_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAR_SRAM_SCD_128_TOP</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="o">/</span> <span class="n">SAR_SRAM_SCD_SIZE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAR_SRAM_TST1_128_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAR_SRAM_TST2_128_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">=</span> <span class="n">SAR_SRAM_TST1_128_TOP</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">abrst_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_ABRSTD_128_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">abrst_size</span> <span class="o">=</span> <span class="n">SAR_ABRSTD_SIZE_8K</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fifo_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_FIFO_128_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">SAR_RXFD_SIZE_32K</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_TCT_32_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAR_SRAM_TCT_32_TOP</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="o">/</span> <span class="n">SAR_SRAM_TCT_SIZE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_RCT_32_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAR_SRAM_RCT_32_TOP</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="o">/</span> <span class="n">SAR_SRAM_RCT_SIZE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rt_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_RT_32_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_SCD_32_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAR_SRAM_SCD_32_TOP</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_base</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		    <span class="o">/</span> <span class="n">SAR_SRAM_SCD_SIZE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAR_SRAM_TST1_32_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAR_SRAM_TST2_32_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">SAR_SRAM_TST1_32_TOP</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">abrst_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_ABRSTD_32_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">abrst_size</span> <span class="o">=</span> <span class="n">SAR_ABRSTD_SIZE_1K</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fifo_base</span> <span class="o">=</span> <span class="n">SAR_SRAM_FIFO_32_BASE</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">=</span> <span class="n">SAR_RXFD_SIZE_4K</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize TCT */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_TCT_SIZE</span> <span class="o">+</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize RCT */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_RCT_SIZE</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">SAR_RCTE_RAWCELLINTEN</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_RCT_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_RCT_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">SAR_SRAM_RCT_SIZE</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">((</span><span class="n">SAR_FBQ0_LOW</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="mh">0x00000000</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">SAR_FB_SIZE_0</span> <span class="o">/</span> <span class="mi">48</span><span class="p">),</span> <span class="n">SAR_REG_FBQS0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">SAR_FBQ1_LOW</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="mh">0x00000000</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">SAR_FB_SIZE_1</span> <span class="o">/</span> <span class="mi">48</span><span class="p">),</span> <span class="n">SAR_REG_FBQS1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">SAR_FBQ2_LOW</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="mh">0x00000000</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">SAR_FB_SIZE_2</span> <span class="o">/</span> <span class="mi">48</span><span class="p">),</span> <span class="n">SAR_REG_FBQS2</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">SAR_FBQ3_LOW</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x00000000</span> <span class="o">|</span> <span class="mh">0x00000000</span> <span class="o">|</span>
	       <span class="p">(</span><span class="n">SAR_FB_SIZE_3</span> <span class="o">/</span> <span class="mi">48</span><span class="p">),</span> <span class="n">SAR_REG_FBQS3</span><span class="p">);</span>

	<span class="cm">/* Initialize rate table  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rt_base</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">log_to_rate</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">tmp</span>  <span class="o">=</span> <span class="n">rate_to_log</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">rate_to_log</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">rate_to_log</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">rate_to_log</span><span class="p">[(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rt_base</span> <span class="o">+</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* Fill RDF and AIR tables. */</span>
<span class="c">	for (i = 0; i &lt; 128; i++) {</span>
<span class="c">		unsigned int tmp;</span>

<span class="c">		tmp = RDF[0][(i &lt;&lt; 1) + 0] &lt;&lt; 16;</span>
<span class="c">		tmp |= RDF[0][(i &lt;&lt; 1) + 1] &lt;&lt; 0;</span>
<span class="c">		write_sram(card, card-&gt;rt_base + 512 + i, tmp);</span>
<span class="c">	}</span>

<span class="c">	for (i = 0; i &lt; 128; i++) {</span>
<span class="c">		unsigned int tmp;</span>

<span class="c">		tmp = AIR[0][(i &lt;&lt; 1) + 0] &lt;&lt; 16;</span>
<span class="c">		tmp |= AIR[0][(i &lt;&lt; 1) + 1] &lt;&lt; 0;</span>
<span class="c">		write_sram(card, card-&gt;rt_base + 640 + i, tmp);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: initialize rate table ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rt_base</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAR_REG_RTBL</span><span class="p">);</span>

	<span class="cm">/* Initialize TSTs */</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: initialize TST ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* last two are jumps */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">TSTE_OPC_VAR</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">TSTE_OPC_JMP</span> <span class="o">|</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">idt77252_sram_write_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">TSTE_OPC_JMP</span> <span class="o">|</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">idt77252_sram_write_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">TSTE_OPC_VAR</span><span class="p">);</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">TSTE_OPC_JMP</span> <span class="o">|</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">idt77252_sram_write_errors</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">TSTE_OPC_JMP</span> <span class="o">|</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="n">idt77252_sram_write_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SAR_REG_TSTB</span><span class="p">);</span>

	<span class="cm">/* Initialize ABRSTD and Receive FIFO */</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: initialize ABRSTD ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">abrst_size</span> <span class="o">|</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">abrst_base</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	       <span class="n">SAR_REG_ABRSTD</span><span class="p">);</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: initialize receive fifo ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fifo_size</span> <span class="o">|</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fifo_base</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span>
	       <span class="n">SAR_REG_RXFD</span><span class="p">);</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: SRAM initialization complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpl</span><span class="p">,</span> <span class="n">modl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">linkrate</span><span class="p">,</span> <span class="n">rsvdcr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tst_entries</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tname</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>

	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">pci_byte</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IDT77252_BIT_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Error: SAR already initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*****************************************************************/</span>
<span class="cm">/*   P C I   C O N F I G U R A T I O N                           */</span>
<span class="cm">/*****************************************************************/</span>

	<span class="cm">/* Set PCI Retry-Timeout and TRDY timeout */</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Checking PCI retries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_byte</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t read PCI retry timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_byte</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: PCI retry timeout: %d, set to 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t set PCI retry timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Checking PCI TRDY.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_byte</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t read PCI TRDY timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_byte</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: PCI TRDY timeout: %d, set to 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		        <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_byte</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t set PCI TRDY timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Reset Timer register */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAR_STAT_TMROF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: resetting timer overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">SAR_STAT_TMROF</span><span class="p">,</span> <span class="n">SAR_REG_STAT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Request IRQ ... &quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">idt77252_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">card</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t allocate IRQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;got %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

<span class="cm">/*****************************************************************/</span>
<span class="cm">/*   C H E C K   A N D   I N I T   S R A M                       */</span>
<span class="cm">/*****************************************************************/</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Initializing SRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* preset size of connecton table, so that init_sram() knows about it */</span>
	<span class="n">conf</span> <span class="o">=</span>	<span class="n">SAR_CFG_TX_FIFO_SIZE_9</span> <span class="o">|</span>	<span class="cm">/* Use maximum fifo size */</span>
		<span class="n">SAR_CFG_RXSTQ_SIZE_8k</span> <span class="o">|</span>		<span class="cm">/* Receive Status Queue is 8k */</span>
		<span class="n">SAR_CFG_IDLE_CLP</span> <span class="o">|</span>		<span class="cm">/* Set CLP on idle cells */</span>
<span class="cp">#ifndef ATM_IDT77252_SEND_IDLE</span>
		<span class="n">SAR_CFG_NO_IDLE</span> <span class="o">|</span>		<span class="cm">/* Do not send idle cells */</span>
<span class="cp">#endif</span>
		<span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sramsize</span> <span class="o">==</span> <span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="n">SAR_CFG_CNTBL_1k</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">conf</span> <span class="o">|=</span> <span class="n">SAR_CFG_CNTBL_512</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vpibits</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">conf</span> <span class="o">|=</span> <span class="n">SAR_CFG_VPVCS_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">conf</span> <span class="o">|=</span> <span class="n">SAR_CFG_VPVCS_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">conf</span> <span class="o">|=</span> <span class="n">SAR_CFG_VPVCS_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">conf</span> <span class="o">|=</span> <span class="n">SAR_CFG_VPVCS_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_CFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">conf</span><span class="p">,</span> <span class="n">SAR_REG_CFG</span><span class="p">);</span>

	<span class="n">init_sram</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

<span class="cm">/********************************************************************/</span>
<span class="cm">/*  A L L O C   R A M   A N D   S E T   V A R I O U S   T H I N G S */</span>
<span class="cm">/********************************************************************/</span>
	<span class="cm">/* Initialize TSQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">init_tsq</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Initialize RSQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">init_rsq</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span> <span class="o">=</span> <span class="n">vpibits</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sramsize</span> <span class="o">==</span> <span class="p">(</span><span class="mi">512</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">=</span> <span class="mi">9</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcimask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcimask</span> <span class="o">|=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Setting VPI/VCI mask to zero.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SAR_REG_VPM</span><span class="p">);</span>

	<span class="cm">/* Little Endian Order   */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SAR_REG_GP</span><span class="p">);</span>

	<span class="cm">/* Initialize RAW Cell Handle Register  */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_hnd</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
						  <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_paddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_hnd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: memory allocation failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_hnd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_paddr</span><span class="p">,</span> <span class="n">SAR_REG_RAWHND</span><span class="p">);</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: raw cell handle is at 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">raw_cell_hnd</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tct_size</span><span class="p">;</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: allocate %d byte for VC map.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vcs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: memory allocation failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_map</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd_size</span><span class="p">;</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: allocate %d byte for SCD to VC mapping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: memory allocation failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tst_info</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: allocate %d byte for TST to VC mapping.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: memory allocation failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tste</span> <span class="o">=</span> <span class="n">TSTE_OPC_VAR</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">soft_tst</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: No LT device defined.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ioctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: LT had no IOCTL function defined.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef	CONFIG_ATM_IDT77252_USE_SUNI</span>
	<span class="cm">/*</span>
<span class="cm">	 * this is a jhs hack to get around special functionality in the</span>
<span class="cm">	 * phy driver for the atecom hardware; the functionality doesn&#39;t</span>
<span class="cm">	 * exist in the linux atm suni driver</span>
<span class="cm">	 *</span>
<span class="cm">	 * it isn&#39;t the right way to do things, but as the guy from NIST</span>
<span class="cm">	 * said, talking about their measurement of the fine structure</span>
<span class="cm">	 * constant, &quot;it&#39;s good enough for government work.&quot;</span>
<span class="cm">	 */</span>
	<span class="n">linkrate</span> <span class="o">=</span> <span class="mi">149760000</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">link_pcr</span> <span class="o">=</span> <span class="p">(</span><span class="n">linkrate</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">53</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Linkrate on ATM line : %u bit/s, %u cell/s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">linkrate</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">link_pcr</span><span class="p">);</span>

<span class="cp">#ifdef ATM_IDT77252_SEND_IDLE</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">utopia_pcr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">link_pcr</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">utopia_pcr</span> <span class="o">=</span> <span class="p">(</span><span class="mi">160000000</span> <span class="o">/</span> <span class="mi">8</span> <span class="o">/</span> <span class="mi">54</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">rsvdcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">utopia_pcr</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">link_pcr</span><span class="p">)</span>
		<span class="n">rsvdcr</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">utopia_pcr</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">link_pcr</span><span class="p">;</span>

	<span class="n">tmpl</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">rsvdcr</span> <span class="o">*</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">modl</span> <span class="o">=</span> <span class="n">tmpl</span> <span class="o">%</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">utopia_pcr</span><span class="p">;</span>
	<span class="n">tst_entries</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">tmpl</span> <span class="o">/</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">utopia_pcr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modl</span><span class="p">)</span>
		<span class="n">tst_entries</span><span class="o">++</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free</span> <span class="o">-=</span> <span class="n">tst_entries</span><span class="p">;</span>
	<span class="n">fill_tst</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">tst_entries</span><span class="p">,</span> <span class="n">TSTE_OPC_NULL</span><span class="p">);</span>

<span class="cp">#ifdef HAVE_EEPROM</span>
	<span class="n">idt77252_eeprom_init</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: EEPROM: %02x:&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">idt77252_eeprom_read_status</span><span class="p">(</span><span class="n">card</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> 
		<span class="n">idt77252_eeprom_read_byte</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
		<span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* HAVE_EEPROM */</span><span class="cp"></span>

	<span class="cm">/*</span>
<span class="cm">	 * XXX: &lt;hack&gt;</span>
<span class="cm">	 */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">tname</span><span class="p">);</span>	<span class="cm">/* jhs: was &quot;tmp = dev_get(tname);&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">,</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ESI %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX: &lt;/hack&gt;</span>
<span class="cm">	 */</span>

	<span class="cm">/* Set Maximum Deficit Count for now. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">SAR_REG_MDFCT</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">IDT77252_BIT_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;%s: IDT77252 ABR SAR initialization complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*****************************************************************************/</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/* Probing of IDT77252 ABR SAR                                               */</span>
<span class="cm">/*                                                                           */</span>
<span class="cm">/*****************************************************************************/</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">idt77252_preset</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pci_command</span><span class="p">;</span>

<span class="cm">/*****************************************************************/</span>
<span class="cm">/*   P C I   C O N F I G U R A T I O N                           */</span>
<span class="cm">/*****************************************************************/</span>

	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Enable PCI master and memory access for SAR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_command</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t read PCI_COMMAND.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pci_command</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_IO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: PCI_COMMAND: %04x (???)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pci_command</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_command</span> <span class="o">|=</span> <span class="p">(</span><span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">pci_command</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t write PCI_COMMAND.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cm">/*****************************************************************/</span>
<span class="cm">/*   G E N E R I C   R E S E T                                   */</span>
<span class="cm">/*****************************************************************/</span>

	<span class="cm">/* Software reset */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CFG_SWRST</span><span class="p">,</span> <span class="n">SAR_REG_CFG</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SAR_REG_CFG</span><span class="p">);</span>

	<span class="n">IPRINTK</span><span class="p">(</span><span class="s">&quot;%s: Software resetted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">__devinit</span>
<span class="nf">probe_sram</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SAR_REG_DR0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_WRITE_SRAM</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">SAR_REG_CMD</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span> <span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0x80000</span><span class="p">;</span> <span class="n">addr</span> <span class="o">+=</span> <span class="mh">0x4000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">ATM_POISON</span><span class="p">,</span> <span class="n">SAR_REG_DR0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_WRITE_SRAM</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">SAR_REG_CMD</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">SAR_CMD_READ_SRAM</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">),</span> <span class="n">SAR_REG_CMD</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">SAR_REG_DR0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">addr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">idt77252_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">**</span><span class="n">last</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idt77252_chain</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">membase</span><span class="p">,</span> <span class="n">srambase</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;idt77252: can&#39;t enable PCI device at %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">pcidev</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;idt77252-%d: can&#39;t allocate private data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pdev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;idt77252-%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tqueue</span><span class="p">,</span> <span class="n">idt77252_softint</span><span class="p">);</span>

	<span class="n">membase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">srambase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cmd_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_lock</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">card</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">tst_timer</span><span class="p">;</span>

	<span class="cm">/* Do the I/O remapping... */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">membase</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t ioremap() membase</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_card</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idt77252_preset</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: preset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">atm_dev_register</span><span class="p">(</span><span class="s">&quot;idt77252&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idt77252_ops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			       <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t register atm device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

<span class="cp">#ifdef	CONFIG_ATM_IDT77252_USE_SUNI</span>
	<span class="n">suni_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t init SUNI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_deinit_card</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_ATM_IDT77252_USE_SUNI */</span><span class="cp"></span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sramsize</span> <span class="o">=</span> <span class="n">probe_sram</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">fbq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">srambase</span> <span class="o">|</span> <span class="mh">0x200000</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">18</span><span class="p">),</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">fbq</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t ioremap() FBQ%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_deinit_card</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ABR SAR (Rev %c): MEM %08lx SRAM %08lx [%u KB]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">))</span> <span class="o">?</span>
	       <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">:</span> <span class="sc">&#39;?&#39;</span><span class="p">,</span> <span class="n">membase</span><span class="p">,</span> <span class="n">srambase</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">sramsize</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init_card</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: init_card failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_deinit_card</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">link_pcr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idt77252_dev_open</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: dev_open failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_stop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">index</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_stop:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">err_out_deinit_card:</span>
	<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

<span class="nl">err_out_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>

<span class="nl">err_out_free_card:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

<span class="nl">err_out_disable_pdev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">idt77252_pci_tbl</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">IDT</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IDT_IDT77252</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">idt77252_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">idt77252_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;idt77252&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">idt77252_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">idt77252_init_one</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">idt77252_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">idt77252_init</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_skb_data</span><span class="p">)</span> <span class="o">+</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_skb_prv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: skb-&gt;cb is too small (%lu &lt; %lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_skb_data</span><span class="p">)</span> <span class="o">+</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">idt77252_skb_prv</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idt77252_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">idt77252_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">idt77252_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idt77252_driver</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">idt77252_chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">idt77252_chain</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">;</span>
		<span class="n">idt77252_chain</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">deinit_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DIPRINTK</span><span class="p">(</span><span class="s">&quot;idt77252: finished cleanup-module().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">idt77252_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">idt77252_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">vpibits</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vpibits</span><span class="p">,</span> <span class="s">&quot;number of VPI bits supported (0, 1, or 2)&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_ATM_IDT77252_DEBUG</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>   <span class="s">&quot;debug bitmap, see drivers/atm/idt77252.h&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Eddie C. Dost &lt;ecd@atecom.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;IDT77252 ABR SAR Driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
