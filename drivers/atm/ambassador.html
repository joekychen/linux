<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › atm › ambassador.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ambassador.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">  Madge Ambassador ATM Adapter driver.</span>
<span class="cm">  Copyright (C) 1995-1999  Madge Networks Ltd.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm">  The GNU GPL is contained in /usr/doc/copyright/GPL on a Debian</span>
<span class="cm">  system and in the file COPYING in the Linux kernel source.</span>
<span class="cm">*/</span>

<span class="cm">/* * dedicated to the memory of Graham Gordon 1971-1998 * */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/poison.h&gt;</span>
<span class="cp">#include &lt;linux/bitrev.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/ihex.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &quot;ambassador.h&quot;</span>

<span class="cp">#define maintainer_string &quot;Giuliano Procida at Madge Networks &lt;gprocida@madge.com&gt;&quot;</span>
<span class="cp">#define description_string &quot;Madge ATM Ambassador driver&quot;</span>
<span class="cp">#define version_string &quot;1.2.4&quot;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">show_version</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%s version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">description_string</span><span class="p">,</span> <span class="n">version_string</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  </span>
<span class="cm">  Theory of Operation</span>
<span class="cm">  </span>
<span class="cm">  I Hardware, detection, initialisation and shutdown.</span>
<span class="cm">  </span>
<span class="cm">  1. Supported Hardware</span>
<span class="cm">  </span>
<span class="cm">  This driver is for the PCI ATMizer-based Ambassador card (except</span>
<span class="cm">  very early versions). It is not suitable for the similar EISA &quot;TR7&quot;</span>
<span class="cm">  card. Commercially, both cards are known as Collage Server ATM</span>
<span class="cm">  adapters.</span>
<span class="cm">  </span>
<span class="cm">  The loader supports image transfer to the card, image start and few</span>
<span class="cm">  other miscellaneous commands.</span>
<span class="cm">  </span>
<span class="cm">  Only AAL5 is supported with vpi = 0 and vci in the range 0 to 1023.</span>
<span class="cm">  </span>
<span class="cm">  The cards are big-endian.</span>
<span class="cm">  </span>
<span class="cm">  2. Detection</span>
<span class="cm">  </span>
<span class="cm">  Standard PCI stuff, the early cards are detected and rejected.</span>
<span class="cm">  </span>
<span class="cm">  3. Initialisation</span>
<span class="cm">  </span>
<span class="cm">  The cards are reset and the self-test results are checked. The</span>
<span class="cm">  microcode image is then transferred and started. This waits for a</span>
<span class="cm">  pointer to a descriptor containing details of the host-based queues</span>
<span class="cm">  and buffers and various parameters etc. Once they are processed</span>
<span class="cm">  normal operations may begin. The BIA is read using a microcode</span>
<span class="cm">  command.</span>
<span class="cm">  </span>
<span class="cm">  4. Shutdown</span>
<span class="cm">  </span>
<span class="cm">  This may be accomplished either by a card reset or via the microcode</span>
<span class="cm">  shutdown command. Further investigation required.</span>
<span class="cm">  </span>
<span class="cm">  5. Persistent state</span>
<span class="cm">  </span>
<span class="cm">  The card reset does not affect PCI configuration (good) or the</span>
<span class="cm">  contents of several other &quot;shared run-time registers&quot; (bad) which</span>
<span class="cm">  include doorbell and interrupt control as well as EEPROM and PCI</span>
<span class="cm">  control. The driver must be careful when modifying these registers</span>
<span class="cm">  not to touch bits it does not use and to undo any changes at exit.</span>
<span class="cm">  </span>
<span class="cm">  II Driver software</span>
<span class="cm">  </span>
<span class="cm">  0. Generalities</span>
<span class="cm">  </span>
<span class="cm">  The adapter is quite intelligent (fast) and has a simple interface</span>
<span class="cm">  (few features). VPI is always zero, 1024 VCIs are supported. There</span>
<span class="cm">  is limited cell rate support. UBR channels can be capped and ABR</span>
<span class="cm">  (explicit rate, but not EFCI) is supported. There is no CBR or VBR</span>
<span class="cm">  support.</span>
<span class="cm">  </span>
<span class="cm">  1. Driver &lt;-&gt; Adapter Communication</span>
<span class="cm">  </span>
<span class="cm">  Apart from the basic loader commands, the driver communicates</span>
<span class="cm">  through three entities: the command queue (CQ), the transmit queue</span>
<span class="cm">  pair (TXQ) and the receive queue pairs (RXQ). These three entities</span>
<span class="cm">  are set up by the host and passed to the microcode just after it has</span>
<span class="cm">  been started.</span>
<span class="cm">  </span>
<span class="cm">  All queues are host-based circular queues. They are contiguous and</span>
<span class="cm">  (due to hardware limitations) have some restrictions as to their</span>
<span class="cm">  locations in (bus) memory. They are of the &quot;full means the same as</span>
<span class="cm">  empty so don&#39;t do that&quot; variety since the adapter uses pointers</span>
<span class="cm">  internally.</span>
<span class="cm">  </span>
<span class="cm">  The queue pairs work as follows: one queue is for supply to the</span>
<span class="cm">  adapter, items in it are pending and are owned by the adapter; the</span>
<span class="cm">  other is the queue for return from the adapter, items in it have</span>
<span class="cm">  been dealt with by the adapter. The host adds items to the supply</span>
<span class="cm">  (TX descriptors and free RX buffer descriptors) and removes items</span>
<span class="cm">  from the return (TX and RX completions). The adapter deals with out</span>
<span class="cm">  of order completions.</span>
<span class="cm">  </span>
<span class="cm">  Interrupts (card to host) and the doorbell (host to card) are used</span>
<span class="cm">  for signalling.</span>
<span class="cm">  </span>
<span class="cm">  1. CQ</span>
<span class="cm">  </span>
<span class="cm">  This is to communicate &quot;open VC&quot;, &quot;close VC&quot;, &quot;get stats&quot; etc. to</span>
<span class="cm">  the adapter. At most one command is retired every millisecond by the</span>
<span class="cm">  card. There is no out of order completion or notification. The</span>
<span class="cm">  driver needs to check the return code of the command, waiting as</span>
<span class="cm">  appropriate.</span>
<span class="cm">  </span>
<span class="cm">  2. TXQ</span>
<span class="cm">  </span>
<span class="cm">  TX supply items are of variable length (scatter gather support) and</span>
<span class="cm">  so the queue items are (more or less) pointers to the real thing.</span>
<span class="cm">  Each TX supply item contains a unique, host-supplied handle (the skb</span>
<span class="cm">  bus address seems most sensible as this works for Alphas as well,</span>
<span class="cm">  there is no need to do any endian conversions on the handles).</span>
<span class="cm">  </span>
<span class="cm">  TX return items consist of just the handles above.</span>
<span class="cm">  </span>
<span class="cm">  3. RXQ (up to 4 of these with different lengths and buffer sizes)</span>
<span class="cm">  </span>
<span class="cm">  RX supply items consist of a unique, host-supplied handle (the skb</span>
<span class="cm">  bus address again) and a pointer to the buffer data area.</span>
<span class="cm">  </span>
<span class="cm">  RX return items consist of the handle above, the VC, length and a</span>
<span class="cm">  status word. This just screams &quot;oh so easy&quot; doesn&#39;t it?</span>

<span class="cm">  Note on RX pool sizes:</span>
<span class="cm">   </span>
<span class="cm">  Each pool should have enough buffers to handle a back-to-back stream</span>
<span class="cm">  of minimum sized frames on a single VC. For example:</span>
<span class="cm">  </span>
<span class="cm">    frame spacing = 3us (about right)</span>
<span class="cm">    </span>
<span class="cm">    delay = IRQ lat + RX handling + RX buffer replenish = 20 (us)  (a guess)</span>
<span class="cm">    </span>
<span class="cm">    min number of buffers for one VC = 1 + delay/spacing (buffers)</span>

<span class="cm">    delay/spacing = latency = (20+2)/3 = 7 (buffers)  (rounding up)</span>
<span class="cm">    </span>
<span class="cm">  The 20us delay assumes that there is no need to sleep; if we need to</span>
<span class="cm">  sleep to get buffers we are going to drop frames anyway.</span>
<span class="cm">  </span>
<span class="cm">  In fact, each pool should have enough buffers to support the</span>
<span class="cm">  simultaneous reassembly of a separate frame on each VC and cope with</span>
<span class="cm">  the case in which frames complete in round robin cell fashion on</span>
<span class="cm">  each VC.</span>
<span class="cm">  </span>
<span class="cm">  Only one frame can complete at each cell arrival, so if &quot;n&quot; VCs are</span>
<span class="cm">  open, the worst case is to have them all complete frames together</span>
<span class="cm">  followed by all starting new frames together.</span>
<span class="cm">  </span>
<span class="cm">    desired number of buffers = n + delay/spacing</span>
<span class="cm">    </span>
<span class="cm">  These are the extreme requirements, however, they are &quot;n+k&quot; for some</span>
<span class="cm">  &quot;k&quot; so we have only the constant to choose. This is the argument</span>
<span class="cm">  rx_lats which current defaults to 7.</span>
<span class="cm">  </span>
<span class="cm">  Actually, &quot;n ? n+k : 0&quot; is better and this is what is implemented,</span>
<span class="cm">  subject to the limit given by the pool size.</span>
<span class="cm">  </span>
<span class="cm">  4. Driver locking</span>
<span class="cm">  </span>
<span class="cm">  Simple spinlocks are used around the TX and RX queue mechanisms.</span>
<span class="cm">  Anyone with a faster, working method is welcome to implement it.</span>
<span class="cm">  </span>
<span class="cm">  The adapter command queue is protected with a spinlock. We always</span>
<span class="cm">  wait for commands to complete.</span>
<span class="cm">  </span>
<span class="cm">  A more complex form of locking is used around parts of the VC open</span>
<span class="cm">  and close functions. There are three reasons for a lock: 1. we need</span>
<span class="cm">  to do atomic rate reservation and release (not used yet), 2. Opening</span>
<span class="cm">  sometimes involves two adapter commands which must not be separated</span>
<span class="cm">  by another command on the same VC, 3. the changes to RX pool size</span>
<span class="cm">  must be atomic. The lock needs to work over context switches, so we</span>
<span class="cm">  use a semaphore.</span>
<span class="cm">  </span>
<span class="cm">  III Hardware Features and Microcode Bugs</span>
<span class="cm">  </span>
<span class="cm">  1. Byte Ordering</span>
<span class="cm">  </span>
<span class="cm">  *%^&quot;$&amp;%^$*&amp;^&quot;$(%^$#&amp;^%$(&amp;#%$*(&amp;^#%!&quot;!&quot;!*!</span>
<span class="cm">  </span>
<span class="cm">  2. Memory access</span>
<span class="cm">  </span>
<span class="cm">  All structures that are not accessed using DMA must be 4-byte</span>
<span class="cm">  aligned (not a problem) and must not cross 4MB boundaries.</span>
<span class="cm">  </span>
<span class="cm">  There is a DMA memory hole at E0000000-E00000FF (groan).</span>
<span class="cm">  </span>
<span class="cm">  TX fragments (DMA read) must not cross 4MB boundaries (would be 16MB</span>
<span class="cm">  but for a hardware bug).</span>
<span class="cm">  </span>
<span class="cm">  RX buffers (DMA write) must not cross 16MB boundaries and must</span>
<span class="cm">  include spare trailing bytes up to the next 4-byte boundary; they</span>
<span class="cm">  will be written with rubbish.</span>
<span class="cm">  </span>
<span class="cm">  The PLX likes to prefetch; if reading up to 4 u32 past the end of</span>
<span class="cm">  each TX fragment is not a problem, then TX can be made to go a</span>
<span class="cm">  little faster by passing a flag at init that disables a prefetch</span>
<span class="cm">  workaround. We do not pass this flag. (new microcode only)</span>
<span class="cm">  </span>
<span class="cm">  Now we:</span>
<span class="cm">  . Note that alloc_skb rounds up size to a 16byte boundary.  </span>
<span class="cm">  . Ensure all areas do not traverse 4MB boundaries.</span>
<span class="cm">  . Ensure all areas do not start at a E00000xx bus address.</span>
<span class="cm">  (I cannot be certain, but this may always hold with Linux)</span>
<span class="cm">  . Make all failures cause a loud message.</span>
<span class="cm">  . Discard non-conforming SKBs (causes TX failure or RX fill delay).</span>
<span class="cm">  . Discard non-conforming TX fragment descriptors (the TX fails).</span>
<span class="cm">  In the future we could:</span>
<span class="cm">  . Allow RX areas that traverse 4MB (but not 16MB) boundaries.</span>
<span class="cm">  . Segment TX areas into some/more fragments, when necessary.</span>
<span class="cm">  . Relax checks for non-DMA items (ignore hole).</span>
<span class="cm">  . Give scatter-gather (iovec) requirements using ???. (?)</span>
<span class="cm">  </span>
<span class="cm">  3. VC close is broken (only for new microcode)</span>
<span class="cm">  </span>
<span class="cm">  The VC close adapter microcode command fails to do anything if any</span>
<span class="cm">  frames have been received on the VC but none have been transmitted.</span>
<span class="cm">  Frames continue to be reassembled and passed (with IRQ) to the</span>
<span class="cm">  driver.</span>
<span class="cm">  </span>
<span class="cm">  IV To Do List</span>
<span class="cm">  </span>
<span class="cm">  . Fix bugs!</span>
<span class="cm">  </span>
<span class="cm">  . Timer code may be broken.</span>
<span class="cm">  </span>
<span class="cm">  . Deal with buggy VC close (somehow) in microcode 12.</span>
<span class="cm">  </span>
<span class="cm">  . Handle interrupted and/or non-blocking writes - is this a job for</span>
<span class="cm">    the protocol layer?</span>
<span class="cm">  </span>
<span class="cm">  . Add code to break up TX fragments when they span 4MB boundaries.</span>
<span class="cm">  </span>
<span class="cm">  . Add SUNI phy layer (need to know where SUNI lives on card).</span>
<span class="cm">  </span>
<span class="cm">  . Implement a tx_alloc fn to (a) satisfy TX alignment etc. and (b)</span>
<span class="cm">    leave extra headroom space for Ambassador TX descriptors.</span>
<span class="cm">  </span>
<span class="cm">  . Understand these elements of struct atm_vcc: recvq (proto?),</span>
<span class="cm">    sleep, callback, listenq, backlog_quota, reply and user_back.</span>
<span class="cm">  </span>
<span class="cm">  . Adjust TX/RX skb allocation to favour IP with LANE/CLIP (configurable).</span>
<span class="cm">  </span>
<span class="cm">  . Impose a TX-pending limit (2?) on each VC, help avoid TX q overflow.</span>
<span class="cm">  </span>
<span class="cm">  . Decide whether RX buffer recycling is or can be made completely safe;</span>
<span class="cm">    turn it back on. It looks like Werner is going to axe this.</span>
<span class="cm">  </span>
<span class="cm">  . Implement QoS changes on open VCs (involves extracting parts of VC open</span>
<span class="cm">    and close into separate functions and using them to make changes).</span>
<span class="cm">  </span>
<span class="cm">  . Hack on command queue so that someone can issue multiple commands and wait</span>
<span class="cm">    on the last one (OR only &quot;no-op&quot; or &quot;wait&quot; commands are waited for).</span>
<span class="cm">  </span>
<span class="cm">  . Eliminate need for while-schedule around do_command.</span>
<span class="cm">  </span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">do_housekeeping</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="cm">/********** globals **********/</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmds</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txs</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxs</span><span class="p">[</span><span class="n">NUM_RX_POOLS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rxs_bs</span><span class="p">[</span><span class="n">NUM_RX_POOLS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4080</span><span class="p">,</span> <span class="mi">12240</span><span class="p">,</span> <span class="mi">36720</span><span class="p">,</span> <span class="mi">65535</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_lats</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pci_lat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">onegigmask</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">;</span>

<span class="cm">/********** access to adapter **********/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wr_plain</span> <span class="p">(</span><span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_REGS</span><span class="p">,</span> <span class="s">&quot;wr: %08zx &lt;- %08x&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="cp">#ifdef AMB_MMIO</span>
  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">[</span><span class="n">addr</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
<span class="cp">#else</span>
  <span class="n">outl</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rd_plain</span> <span class="p">(</span><span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef AMB_MMIO</span>
  <span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">[</span><span class="n">addr</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)];</span>
<span class="cp">#else</span>
  <span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="n">inl</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_REGS</span><span class="p">,</span> <span class="s">&quot;rd: %08zx -&gt; %08x&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wr_mem</span> <span class="p">(</span><span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">__be32</span> <span class="n">be</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">data</span><span class="p">);</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_REGS</span><span class="p">,</span> <span class="s">&quot;wr: %08zx &lt;- %08x b[%08x]&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">be</span><span class="p">);</span>
<span class="cp">#ifdef AMB_MMIO</span>
  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">[</span><span class="n">addr</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)]</span> <span class="o">=</span> <span class="n">be</span><span class="p">;</span>
<span class="cp">#else</span>
  <span class="n">outl</span> <span class="p">(</span><span class="n">be</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">rd_mem</span> <span class="p">(</span><span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef AMB_MMIO</span>
  <span class="n">__be32</span> <span class="n">be</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">[</span><span class="n">addr</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)];</span>
<span class="cp">#else</span>
  <span class="n">__be32</span> <span class="n">be</span> <span class="o">=</span> <span class="n">inl</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">be</span><span class="p">);</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_REGS</span><span class="p">,</span> <span class="s">&quot;rd: %08zx -&gt; %08x b[%08x]&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">be</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** dump routines **********/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_registers</span> <span class="p">(</span><span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_AMBASSADOR</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;</span> <span class="n">DBG_REGS</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_REGS</span><span class="p">,</span> <span class="s">&quot;reading PLX control: &quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x30</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
      <span class="n">rd_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_REGS</span><span class="p">,</span> <span class="s">&quot;reading mailboxes: &quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x60</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
      <span class="n">rd_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_REGS</span><span class="p">,</span> <span class="s">&quot;reading doorb irqev irqen reset:&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x70</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
      <span class="n">rd_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
  <span class="p">}</span>
<span class="cp">#else</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_loader_block</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">loader_block</span> <span class="o">*</span> <span class="n">lb</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_AMBASSADOR</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">PRINTDB</span> <span class="p">(</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;lb @ %p; res: %d, cmd: %d, pay:&quot;</span><span class="p">,</span>
	   <span class="n">lb</span><span class="p">,</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">),</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_COMMAND_DATA</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">PRINTDM</span> <span class="p">(</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot; %08x&quot;</span><span class="p">,</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
  <span class="n">PRINTDE</span> <span class="p">(</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;, vld: %08x&quot;</span><span class="p">,</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">));</span>
<span class="cp">#else</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">lb</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_command</span> <span class="p">(</span><span class="n">command</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_AMBASSADOR</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">PRINTDB</span> <span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd @ %p, req: %08x, pars:&quot;</span><span class="p">,</span>
	   <span class="n">cmd</span><span class="p">,</span> <span class="cm">/*be32_to_cpu*/</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
    <span class="n">PRINTDM</span> <span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot; %08x&quot;</span><span class="p">,</span> <span class="cm">/*be32_to_cpu*/</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">.</span><span class="n">par</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
  <span class="n">PRINTDE</span> <span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">cmd</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dump_skb</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span> <span class="n">prefix</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_AMBASSADOR</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
  <span class="n">PRINTDB</span> <span class="p">(</span><span class="n">DBG_DATA</span><span class="p">,</span> <span class="s">&quot;%s(%u) &quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">PRINTDM</span> <span class="p">(</span><span class="n">DBG_DATA</span><span class="p">,</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="n">PRINTDE</span> <span class="p">(</span><span class="n">DBG_DATA</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">prefix</span><span class="p">;</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">vc</span><span class="p">;</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">skb</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** check memory areas for use by Ambassador **********/</span>

<span class="cm">/* see limitations under Hardware Features */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_area</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">start</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>assumes length > 0</p></td><td class="code"><div class="highlight"><pre>  <span class="k">const</span> <span class="n">u32</span> <span class="n">fourmegmask</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">u32</span> <span class="n">twofivesixmask</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">u32</span> <span class="n">starthole</span> <span class="o">=</span> <span class="mh">0xE0000000</span><span class="p">;</span>
  <span class="n">u32</span> <span class="n">startaddress</span> <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">start</span><span class="p">);</span>
  <span class="n">u32</span> <span class="n">lastaddress</span> <span class="o">=</span> <span class="n">startaddress</span><span class="o">+</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">((</span><span class="n">startaddress</span> <span class="o">^</span> <span class="n">lastaddress</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">fourmegmask</span> <span class="o">||</span>
      <span class="p">(</span><span class="n">startaddress</span> <span class="o">&amp;</span> <span class="n">twofivesixmask</span><span class="p">)</span> <span class="o">==</span> <span class="n">starthole</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;check_area failure: [%x,%x] - mail maintainer!&quot;</span><span class="p">,</span>
	    <span class="n">startaddress</span><span class="p">,</span> <span class="n">lastaddress</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/********** free an skb (as per ATM device driver documentation) **********/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amb_kfree_skb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span> <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">dev_kfree_skb_any</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/********** TX completion **********/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_complete</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">tx_out</span> <span class="o">*</span> <span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tx_simple</span> <span class="o">*</span> <span class="n">tx_descr</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span> <span class="o">=</span> <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;tx_complete %p %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>VC layer stats</p></td><td class="code"><div class="highlight"><pre>  <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>free the descriptor</p></td><td class="code"><div class="highlight"><pre>  <span class="n">kfree</span> <span class="p">(</span><span class="n">tx_descr</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>free the skb</p></td><td class="code"><div class="highlight"><pre>  <span class="n">amb_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
  
  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_ok</span><span class="o">++</span><span class="p">;</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** RX completion **********/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_complete</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">rx_out</span> <span class="o">*</span> <span class="n">rx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
  <span class="n">u16</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">be16_to_cpu</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>unused: u16 lec<em>id = be16</em>to<em>cpu (rx->lec</em>id);</p></td><td class="code"><div class="highlight"><pre>  <span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">be16_to_cpu</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
  <span class="n">u16</span> <span class="n">rx_len</span> <span class="o">=</span> <span class="n">be16_to_cpu</span> <span class="p">(</span><span class="n">rx</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;rx_complete %p %p (len=%hu)&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>XXX move this in and add to VC stats ???</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span> <span class="n">atm_vcc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxer</span><span class="p">[</span><span class="n">vc</span><span class="p">];</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">ok</span><span class="o">++</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">)</span> <span class="p">{</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">rx_len</span> <span class="o">&lt;=</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">atm_charge</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
	  </pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>prepare socket buffer</p></td><td class="code"><div class="highlight"><pre>	  <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="p">;</span>
	  <span class="n">skb_put</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>
	  
	  <span class="n">dump_skb</span> <span class="p">(</span><span class="s">&quot;&lt;&lt;&lt;&quot;</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	  </pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>VC layer stats</p></td><td class="code"><div class="highlight"><pre>	  <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
	  <span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>end of our responsibility</p></td><td class="code"><div class="highlight"><pre>	  <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">push</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	  <span class="k">return</span><span class="p">;</span>
	  
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>someone fix this (message), please!</p></td><td class="code"><div class="highlight"><pre>	  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_INFO</span><span class="o">|</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;dropped thanks to atm_charge (vc %hu, truesize %u)&quot;</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>drop stats incremented in atm_charge</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      	<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;dropped over-size frame&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>should we count this?</p></td><td class="code"><div class="highlight"><pre>	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
      <span class="p">}</span>
      
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_WARN</span><span class="o">|</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;got frame but RX closed for channel %hu&quot;</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>this is an adapter bug, only in new version of microcode</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span>
    
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">error</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CRC_ERR</span><span class="p">)</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">badcrc</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">LEN_ERR</span><span class="p">)</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">toolong</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ABORT_ERR</span><span class="p">)</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">aborted</span><span class="o">++</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">UNUSED_ERR</span><span class="p">)</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">unused</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">dev_kfree_skb_any</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">  </span>
<span class="cm">  Note on queue handling.</span>
<span class="cm">  </span>
<span class="cm">  Here &quot;give&quot; and &quot;take&quot; refer to queue entries and a queue (pair)</span>
<span class="cm">  rather than frames to or from the host or adapter. Empty frame</span>
<span class="cm">  buffers are given to the RX queue pair and returned unused or</span>
<span class="cm">  containing RX frames. TX frames (well, pointers to TX fragment</span>
<span class="cm">  lists) are given to the TX queue pair, completions are returned.</span>
<span class="cm">  </span>
<span class="cm">*/</span>

<span class="cm">/********** command queue **********/</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>I really don't like this, but it's the best I can do at the moment</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>also, the callers are responsible for byte order as the microcode
sometimes does 16-bit accesses (yuk yuk yuk)</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">int</span> <span class="nf">command_do</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">command</span> <span class="o">*</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_cq</span> <span class="o">*</span> <span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
  <span class="k">volatile</span> <span class="n">amb_cq_ptrs</span> <span class="o">*</span> <span class="n">ptrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">ptrs</span><span class="p">;</span>
  <span class="n">command</span> <span class="o">*</span> <span class="n">my_slot</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;command_do %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span> <span class="p">(</span><span class="n">dead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>if not full...</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&lt;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>remember my slot for later</p></td><td class="code"><div class="highlight"><pre>    <span class="n">my_slot</span> <span class="o">=</span> <span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">;</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;command in slot %p&quot;</span><span class="p">,</span> <span class="n">my_slot</span><span class="p">);</span>
    
    <span class="n">dump_command</span> <span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
    </pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>copy command in</p></td><td class="code"><div class="highlight"><pre>    <span class="o">*</span><span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">in</span> <span class="o">=</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">++</span><span class="p">;</span>
    <span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">in</span> <span class="o">=</span> <span class="n">NEXTQ</span> <span class="p">(</span><span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">);</span>
    </pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>mail the command</p></td><td class="code"><div class="highlight"><pre>    <span class="n">wr_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">mb</span><span class="p">.</span><span class="n">adapter</span><span class="p">.</span><span class="n">cmd_address</span><span class="p">),</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&gt;</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">)</span>
      <span class="n">cq</span><span class="o">-&gt;</span><span class="n">high</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">;</span>
    <span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    </pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>these comments were in a while-loop before, msleep removes the loop
go to sleep
PRINTD (DBG_CMD, "wait: sleeping %lu for command", timeout);</p></td><td class="code"><div class="highlight"><pre>    <span class="n">msleep</span><span class="p">(</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">);</span>
    </pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>wait for my slot to be reached (all waiters are here or above, until...)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">!=</span> <span class="n">my_slot</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;wait: command slot (now at %p)&quot;</span><span class="p">,</span> <span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
      <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
      <span class="n">schedule</span><span class="p">();</span>
    <span class="p">}</span>
    </pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>wait on my slot (... one gets to its slot, and... )</p></td><td class="code"><div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">out</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">!=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;wait: command slot completion&quot;</span><span class="p">);</span>
      <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
      <span class="n">schedule</span><span class="p">();</span>
    <span class="p">}</span>
    
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;command complete&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>update queue (... moves the queue along to the next slot)</p></td><td class="code"><div class="highlight"><pre>    <span class="n">spin_lock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">--</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>copy command out</p></td><td class="code"><div class="highlight"><pre>    <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">;</span>
    <span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">NEXTQ</span> <span class="p">(</span><span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">ptrs</span><span class="o">-&gt;</span><span class="n">limit</span><span class="p">);</span>
    <span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">filled</span><span class="o">++</span><span class="p">;</span>
    <span class="n">spin_unlock</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">cq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
  <span class="p">}</span>
  
<span class="p">}</span>

<span class="cm">/********** TX queue pair **********/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_give</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">tx_in</span> <span class="o">*</span> <span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_txq</span> <span class="o">*</span> <span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;tx_give %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span> <span class="p">(</span><span class="n">dead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&lt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;TX in slot %p&quot;</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

    <span class="o">*</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">++</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">NEXTQ</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>hand over the TX and ring the bell</p></td><td class="code"><div class="highlight"><pre>    <span class="n">wr_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">mb</span><span class="p">.</span><span class="n">adapter</span><span class="p">.</span><span class="n">tx_address</span><span class="p">),</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span><span class="p">));</span>
    <span class="n">wr_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">),</span> <span class="n">TX_FRAME</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&gt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">)</span>
      <span class="n">txq</span><span class="o">-&gt;</span><span class="n">high</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">;</span>
    <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">filled</span><span class="o">++</span><span class="p">;</span>
    <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_take</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_txq</span> <span class="o">*</span> <span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;tx_take %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
  
  <span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>deal with TX completion</p></td><td class="code"><div class="highlight"><pre>    <span class="n">tx_complete</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>mark unused again</p></td><td class="code"><div class="highlight"><pre>    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>remove item</p></td><td class="code"><div class="highlight"><pre>    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">--</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">NEXTQ</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
    
    <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    
    <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/********** RX queue pairs **********/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_give</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">rx_in</span> <span class="o">*</span> <span class="n">rx</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_rxq</span> <span class="o">*</span> <span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;rx_give %p[%hu]&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
  
  <span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;RX in slot %p&quot;</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

    <span class="o">*</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">rx</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">++</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">NEXTQ</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>hand over the RX buffer</p></td><td class="code"><div class="highlight"><pre>    <span class="n">wr_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">mb</span><span class="p">.</span><span class="n">adapter</span><span class="p">.</span><span class="n">rx_address</span><span class="p">[</span><span class="n">pool</span><span class="p">]),</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span><span class="p">));</span>
    
    <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_take</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_rxq</span> <span class="o">*</span> <span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;rx_take %p[%hu]&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
  
  <span class="n">spin_lock_irqsave</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">||</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>deal with RX completion</p></td><td class="code"><div class="highlight"><pre>    <span class="n">rx_complete</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>mark unused again</p></td><td class="code"><div class="highlight"><pre>    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>remove item</p></td><td class="code"><div class="highlight"><pre>    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="o">--</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">NEXTQ</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">)</span>
      <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">low</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">;</span>
    <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&amp;&amp;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buffers_wanted</span><span class="p">)</span>
      <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">emptied</span><span class="o">++</span><span class="p">;</span>
    <span class="n">spin_unlock_irqrestore</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/********** RX Pool handling **********/</span>

<span class="cm">/* pre: buffers_wanted = 0, post: pending = 0 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">drain_rx_pool</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_rxq</span> <span class="o">*</span> <span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_POOL</span><span class="p">,</span> <span class="s">&quot;drain_rx_pool %p %hu&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span> <span class="p">(</span><span class="n">dead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>
  
  <span class="cm">/* we are not quite like the fill pool routines as we cannot just</span>
<span class="cm">     remove one buffer, we have to remove all of them, but we might as</span>
<span class="cm">     well pretend... */</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&gt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buffers_wanted</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">command</span> <span class="n">cmd</span><span class="p">;</span>
    <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_FLUSH_BUFFER_Q</span><span class="p">);</span>
    <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">flush</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">pool</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_POOL_SHIFT</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">command_do</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span>
      <span class="n">schedule</span><span class="p">();</span>
    <span class="cm">/* the pool may also be emptied via the interrupt handler */</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&gt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buffers_wanted</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">rx_take</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">))</span>
	<span class="n">schedule</span><span class="p">();</span>
  <span class="p">}</span>
  
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drain_rx_pools</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_POOL</span><span class="p">,</span> <span class="s">&quot;drain_rx_pools %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span>
    <span class="n">drain_rx_pool</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_rx_pool</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">,</span>
                                 <span class="n">gfp_t</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">rx_in</span> <span class="n">rx</span><span class="p">;</span>
  <span class="n">amb_rxq</span> <span class="o">*</span> <span class="n">rxq</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_POOL</span><span class="p">,</span> <span class="s">&quot;fill_rx_pool %p %hu %x&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span> <span class="p">(</span><span class="n">dead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
    <span class="k">return</span><span class="p">;</span>
  
  <span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">&amp;&amp;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">&lt;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buffers_wanted</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">priority</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_SKB</span><span class="o">|</span><span class="n">DBG_POOL</span><span class="p">,</span> <span class="s">&quot;failed to allocate skb for RX pool %hu&quot;</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">check_area</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">dev_kfree_skb_any</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>cast needed as there is no %? for pointer differences</p></td><td class="code"><div class="highlight"><pre>    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_SKB</span><span class="p">,</span> <span class="s">&quot;allocated skb at %p, head %p, area %li&quot;</span><span class="p">,</span>
	    <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">skb_end_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
    <span class="n">rx</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
    <span class="n">rx</span><span class="p">.</span><span class="n">host_address</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rx_give</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx</span><span class="p">,</span> <span class="n">pool</span><span class="p">))</span>
      <span class="n">dev_kfree_skb_any</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
    
  <span class="p">}</span>
  
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>top up all RX pools</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_rx_pools</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_POOL</span><span class="p">,</span> <span class="s">&quot;fill_rx_pools %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span>
    <span class="n">fill_rx_pool</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
  
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** enable host interrupts **********/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">interrupts_on</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">wr_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">interrupt_control</span><span class="p">),</span>
	    <span class="n">rd_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">interrupt_control</span><span class="p">))</span>
	    <span class="o">|</span> <span class="n">AMB_INTERRUPT_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********** disable host interrupts **********/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">interrupts_off</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">wr_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">interrupt_control</span><span class="p">),</span>
	    <span class="n">rd_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">interrupt_control</span><span class="p">))</span>
	    <span class="o">&amp;~</span> <span class="n">AMB_INTERRUPT_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********** interrupt handling **********/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_IRQ</span><span class="o">|</span><span class="n">DBG_FLOW</span><span class="p">,</span> <span class="s">&quot;interrupt_handler: %p&quot;</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>
  
  <span class="p">{</span>
    <span class="n">u32</span> <span class="n">interrupt</span> <span class="o">=</span> <span class="n">rd_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">));</span>
  </pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>for us or someone else sharing the same interrupt</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interrupt</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;irq not for me: %d&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
    <span class="p">}</span>
    </pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>definitely for us</p></td><td class="code"><div class="highlight"><pre>    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;FYI: interrupt was %08x&quot;</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">);</span>
    <span class="n">wr_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_work</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_take</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">))</span>
	<span class="o">++</span><span class="n">irq_work</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_take</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span>
      <span class="o">++</span><span class="n">irq_work</span><span class="p">;</span>
  
    <span class="k">if</span> <span class="p">(</span><span class="n">irq_work</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fill_rx_pools</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;work done: %u&quot;</span><span class="p">,</span> <span class="n">irq_work</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_IRQ</span><span class="o">|</span><span class="n">DBG_WARN</span><span class="p">,</span> <span class="s">&quot;no work done&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_IRQ</span><span class="o">|</span><span class="n">DBG_FLOW</span><span class="p">,</span> <span class="s">&quot;interrupt_handler done: %p&quot;</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** make rate (not quite as much fun as Horizon) **********/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">make_rate</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="n">rounding</span> <span class="n">r</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="o">*</span> <span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">actual</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">exp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// hush gcc</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">man</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">// hush gcc</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_QOS</span><span class="p">,</span> <span class="s">&quot;make_rate %u&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>rates in cells per second, ITU format (nasty 16-bit floating-point)
given 5-bit e and 9-bit m:
rate = EITHER (1+m/2^9)<em>2^e    OR 0
bits = EITHER 1&lt;&lt;14 | e&lt;&lt;9 | m OR 0
(bit 15 is "reserved", bit 14 "non-zero")
smallest rate is 0 (special representation)
largest rate is (1+511/512)</em>2^31 = 4290772992 (&lt; 2^32-1)
smallest non-zero rate is (1+0/512)*2^0 = 1 (> 0)
simple algorithm:
find position of top bit, this gives e
remove top bit and shift (rounding if feeling clever) by 9-e</p></td><td class="code"><div class="highlight"><pre>  </pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>ucode bug: please don't set bit 14! so 0 rate not representable</p></td><td class="code"><div class="highlight"><pre>  
  <span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mh">0xffc00000U</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>larger than largest representable rate</p></td><td class="code"><div class="highlight"><pre>    
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">round_up</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">exp</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
      <span class="n">man</span> <span class="o">=</span> <span class="mi">511</span><span class="p">;</span>
    <span class="p">}</span>
    
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>representable rate</p></td><td class="code"><div class="highlight"><pre>    
    <span class="n">exp</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
    <span class="n">man</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
    </pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>invariant: rate = man*2^(exp-31)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">man</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">)))</span> <span class="p">{</span>
      <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">man</span> <span class="o">=</span> <span class="n">man</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    </pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>man has top bit set
rate = (2^31+(man-2^31))<em>2^(exp-31)
rate = (1+(man-2^31)/2^31)</em>2^exp</p></td><td class="code"><div class="highlight"><pre>    <span class="n">man</span> <span class="o">=</span> <span class="n">man</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">man</span> <span class="o">&amp;=</span> <span class="mh">0xffffffffU</span><span class="p">;</span> <span class="c1">// a nop on 32-bit systems</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>rate = (1+man/2^32)*2^exp</p></td><td class="code"><div class="highlight"><pre>    </pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>exp is in the range 0 to 31, man is in the range 0 to 2^32-1
time to lose significance... we want m in the range 0 to 2^9-1
rounding presents a minor problem... we first decide which way
we are rounding (based on given rounding direction and possibly
the bits of the mantissa that are to be discarded).</p></td><td class="code"><div class="highlight"><pre>    
    <span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">round_down</span>: <span class="p">{</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>just truncate</p></td><td class="code"><div class="highlight"><pre>	<span class="n">man</span> <span class="o">=</span> <span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">round_up</span>: <span class="p">{</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>check all bits that we are discarding</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">man</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">0U</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">man</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>no need to check for round up outside of range</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">man</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">exp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	  <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  <span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="n">round_nearest</span>: <span class="p">{</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>check msb that we are discarding</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">man</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
	  <span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">man</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>no need to check for round up outside of range</p></td><td class="code"><div class="highlight"><pre>	    <span class="n">man</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="n">exp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	  <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  <span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>zero rate - not representable</p></td><td class="code"><div class="highlight"><pre>    
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">round_down</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">man</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
  <span class="p">}</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_QOS</span><span class="p">,</span> <span class="s">&quot;rate: man=%u, exp=%hu&quot;</span><span class="p">,</span> <span class="n">man</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">bits</span><span class="p">)</span>
    <span class="o">*</span><span class="n">bits</span> <span class="o">=</span> <span class="cm">/* (1&lt;&lt;14) | */</span> <span class="p">(</span><span class="n">exp</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">man</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">actual</span><span class="p">)</span>
    <span class="o">*</span><span class="n">actual</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span>
      <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">exp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">man</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">exp</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span>
      <span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">exp</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">man</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="n">exp</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="n">exp</span><span class="p">));</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** Linux ATM Operations **********/</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>some are not yet implemented while others do not make sense for
this device</p></td><td class="code"><div class="highlight"><pre><span class="cm">/********** Open a VC **********/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amb_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span> <span class="n">atm_vcc</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
  
  <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span> <span class="n">qos</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">atm_trafprm</span> <span class="o">*</span> <span class="n">txtp</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">atm_trafprm</span> <span class="o">*</span> <span class="n">rxtp</span><span class="p">;</span>
  <span class="n">u16</span> <span class="n">tx_rate_bits</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// hush gcc</span>
  <span class="n">u16</span> <span class="n">tx_vc_bits</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// hush gcc</span>
  <span class="n">u16</span> <span class="n">tx_frame_bits</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// hush gcc</span>
  
  <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">AMB_DEV</span><span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
  <span class="n">amb_vcc</span> <span class="o">*</span> <span class="n">vcc</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">// hush gcc</span>
  <span class="kt">short</span> <span class="n">vpi</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">vci</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_VCC</span><span class="p">,</span> <span class="s">&quot;amb_open %x %x&quot;</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
  
<span class="cp">#ifdef ATM_VPI_UNSPEC</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>UNSPEC is deprecated, remove this code eventually</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">==</span> <span class="n">ATM_VPI_UNSPEC</span> <span class="o">||</span> <span class="n">vci</span> <span class="o">==</span> <span class="n">ATM_VCI_UNSPEC</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_WARNING</span><span class="p">,</span> <span class="s">&quot;rejecting open with unspecified VPI/VCI (deprecated)&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  <span class="p">}</span>
<span class="cp">#endif</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">vpi</span> <span class="o">&amp;&amp;</span> <span class="n">vpi</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">NUM_VPI_BITS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	<span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">vci</span> <span class="o">&amp;&amp;</span> <span class="n">vci</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">NUM_VCI_BITS</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_WARN</span><span class="o">|</span><span class="n">DBG_VCC</span><span class="p">,</span> <span class="s">&quot;VPI/VCI out of range: %hd/%d&quot;</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">qos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_QOS</span><span class="p">,</span> <span class="s">&quot;AAL not supported&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  <span class="p">}</span>
  </pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>traffic parameters</p></td><td class="code"><div class="highlight"><pre>  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_QOS</span><span class="p">,</span> <span class="s">&quot;TX:&quot;</span><span class="p">);</span>
  <span class="n">txtp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">txtp</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">txtp</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">ATM_UBR</span>: <span class="p">{</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>we take "the PCR" as a rate-cap</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span> <span class="n">pcr</span> <span class="o">=</span> <span class="n">atm_pcr_goal</span> <span class="p">(</span><span class="n">txtp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcr</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>no rate cap</p></td><td class="code"><div class="highlight"><pre>	  <span class="n">tx_rate_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	  <span class="n">tx_vc_bits</span> <span class="o">=</span> <span class="n">TX_UBR</span><span class="p">;</span>
	  <span class="n">tx_frame_bits</span> <span class="o">=</span> <span class="n">TX_FRAME_NOTCAP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  <span class="n">rounding</span> <span class="n">r</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">pcr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">r</span> <span class="o">=</span> <span class="n">round_down</span><span class="p">;</span>
	    <span class="n">pcr</span> <span class="o">=</span> <span class="o">-</span><span class="n">pcr</span><span class="p">;</span>
	  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">r</span> <span class="o">=</span> <span class="n">round_up</span><span class="p">;</span>
	  <span class="p">}</span>
	  <span class="n">error</span> <span class="o">=</span> <span class="n">make_rate</span> <span class="p">(</span><span class="n">pcr</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_rate_bits</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
	    <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	  <span class="n">tx_vc_bits</span> <span class="o">=</span> <span class="n">TX_UBR_CAPPED</span><span class="p">;</span>
	  <span class="n">tx_frame_bits</span> <span class="o">=</span> <span class="n">TX_FRAME_CAPPED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">      case ATM_ABR: {</span>
<span class="c">	pcr = atm_pcr_goal (txtp);</span>
<span class="c">	PRINTD (DBG_QOS, &quot;pcr goal = %d&quot;, pcr);</span>
<span class="c">	break;</span>
<span class="c">      }</span>
<span class="cp">#endif</span>
      <span class="nl">default:</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>PRINTD (DBG_QOS, "request for non-UBR/ABR denied");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_QOS</span><span class="p">,</span> <span class="s">&quot;request for non-UBR denied&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_QOS</span><span class="p">,</span> <span class="s">&quot;tx_rate_bits=%hx, tx_vc_bits=%hx&quot;</span><span class="p">,</span>
	    <span class="n">tx_rate_bits</span><span class="p">,</span> <span class="n">tx_vc_bits</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_QOS</span><span class="p">,</span> <span class="s">&quot;RX:&quot;</span><span class="p">);</span>
  <span class="n">rxtp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rxtp</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>do nothing</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>choose an RX pool (arranged in increasing size)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">rxtp</span><span class="o">-&gt;</span><span class="n">max_sdu</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffer_size</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_VCC</span><span class="o">|</span><span class="n">DBG_QOS</span><span class="o">|</span><span class="n">DBG_POOL</span><span class="p">,</span> <span class="s">&quot;chose pool %hu (max_sdu %u &lt;= %u)&quot;</span><span class="p">,</span>
		<span class="n">pool</span><span class="p">,</span> <span class="n">rxtp</span><span class="o">-&gt;</span><span class="n">max_sdu</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffer_size</span><span class="p">);</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pool</span> <span class="o">==</span> <span class="n">NUM_RX_POOLS</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_WARN</span><span class="o">|</span><span class="n">DBG_VCC</span><span class="o">|</span><span class="n">DBG_QOS</span><span class="o">|</span><span class="n">DBG_POOL</span><span class="p">,</span>
	      <span class="s">&quot;no pool suitable for VC (RX max_sdu %d is too large)&quot;</span><span class="p">,</span>
	      <span class="n">rxtp</span><span class="o">-&gt;</span><span class="n">max_sdu</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">switch</span> <span class="p">(</span><span class="n">rxtp</span><span class="o">-&gt;</span><span class="n">traffic_class</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">ATM_UBR</span>: <span class="p">{</span>
	<span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">      case ATM_ABR: {</span>
<span class="c">	pcr = atm_pcr_goal (rxtp);</span>
<span class="c">	PRINTD (DBG_QOS, &quot;pcr goal = %d&quot;, pcr);</span>
<span class="c">	break;</span>
<span class="c">      }</span>
<span class="cp">#endif</span>
      <span class="nl">default:</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>PRINTD (DBG_QOS, "request for non-UBR/ABR denied");</p></td><td class="code"><div class="highlight"><pre>	<span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_QOS</span><span class="p">,</span> <span class="s">&quot;request for non-UBR denied&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  </pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>get space for our vcc stuff</p></td><td class="code"><div class="highlight"><pre>  <span class="n">vcc</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">amb_vcc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;out of memory!&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">vcc</span><span class="p">;</span>
  </pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>no failures beyond this point</p></td><td class="code"><div class="highlight"><pre>  </pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>we are not really "immediately before allocating the connection
identifier in hardware", but it will just have to do!</p></td><td class="code"><div class="highlight"><pre>  <span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">txtp</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">command</span> <span class="n">cmd</span><span class="p">;</span>
    
    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">tx_frame_bits</span> <span class="o">=</span> <span class="n">tx_frame_bits</span><span class="p">;</span>
    
    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vcc_sf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxer</span><span class="p">[</span><span class="n">vci</span><span class="p">])</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>RXer on the channel already, just modify rate...</p></td><td class="code"><div class="highlight"><pre>      <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_MODIFY_VC_RATE</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_rate</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span>  <span class="c1">// vpi 0</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_rate</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">tx_rate_bits</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_RATE_SHIFT</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">command_do</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span>
	<span class="n">schedule</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>... and TX flags, preserving the RX pool</p></td><td class="code"><div class="highlight"><pre>      <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_MODIFY_VC_FLAGS</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_flags</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span>  <span class="c1">// vpi 0</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_flags</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span>
	<span class="p">(</span> <span class="p">(</span><span class="n">AMB_VCC</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxer</span><span class="p">[</span><span class="n">vci</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">pool</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_POOL_SHIFT</span><span class="p">)</span>
	  <span class="o">|</span> <span class="p">(</span><span class="n">tx_vc_bits</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_FLAGS_SHIFT</span><span class="p">)</span> <span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">command_do</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span>
	<span class="n">schedule</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>no RXer on the channel, just open (with pool zero)</p></td><td class="code"><div class="highlight"><pre>      <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_OPEN_VC</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">open</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span>  <span class="c1">// vpi 0</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">open</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">tx_vc_bits</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_FLAGS_SHIFT</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">open</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">tx_rate_bits</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_RATE_SHIFT</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">command_do</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span>
	<span class="n">schedule</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">txer</span><span class="p">[</span><span class="n">vci</span><span class="p">].</span><span class="n">tx_present</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vcc_sf</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">rxtp</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">command</span> <span class="n">cmd</span><span class="p">;</span>
    
    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>
    
    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vcc_sf</span><span class="p">);</span>
    <span class="cm">/* grow RX buffer pool */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffers_wanted</span><span class="p">)</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffers_wanted</span> <span class="o">=</span> <span class="n">rx_lats</span><span class="p">;</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffers_wanted</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fill_rx_pool</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txer</span><span class="p">[</span><span class="n">vci</span><span class="p">].</span><span class="n">tx_present</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>TXer on the channel already
switch (from pool zero) to this pool, preserving the TX bits</p></td><td class="code"><div class="highlight"><pre>      <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_MODIFY_VC_FLAGS</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_flags</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span>  <span class="c1">// vpi 0</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_flags</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span>
	<span class="p">(</span> <span class="p">(</span><span class="n">pool</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_POOL_SHIFT</span><span class="p">)</span>
	  <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txer</span><span class="p">[</span><span class="n">vci</span><span class="p">].</span><span class="n">tx_vc_bits</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_FLAGS_SHIFT</span><span class="p">)</span> <span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>no TXer on the channel, open the VC (with no rate info)</p></td><td class="code"><div class="highlight"><pre>      <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_OPEN_VC</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">open</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span>  <span class="c1">// vpi 0</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">open</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">pool</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_POOL_SHIFT</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">open</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">command_do</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span>
      <span class="n">schedule</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>this link allows RX frames through</p></td><td class="code"><div class="highlight"><pre>    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxer</span><span class="p">[</span><span class="n">vci</span><span class="p">]</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="p">;</span>
    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vcc_sf</span><span class="p">);</span>
  <span class="p">}</span>
  </pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>indicate readiness</p></td><td class="code"><div class="highlight"><pre>  <span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** Close a VC **********/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">amb_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span> <span class="n">atm_vcc</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">AMB_DEV</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
  <span class="n">amb_vcc</span> <span class="o">*</span> <span class="n">vcc</span> <span class="o">=</span> <span class="n">AMB_VCC</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">);</span>
  <span class="n">u16</span> <span class="n">vci</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_VCC</span><span class="o">|</span><span class="n">DBG_FLOW</span><span class="p">,</span> <span class="s">&quot;amb_close&quot;</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>indicate unreadiness</p></td><td class="code"><div class="highlight"><pre>  <span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>disable TXing</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">command</span> <span class="n">cmd</span><span class="p">;</span>
    
    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vcc_sf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxer</span><span class="p">[</span><span class="n">vci</span><span class="p">])</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>RXer still on the channel, just modify rate... XXX not really needed</p></td><td class="code"><div class="highlight"><pre>      <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_MODIFY_VC_RATE</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_rate</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span>  <span class="c1">// vpi 0</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_rate</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>... and clear TX rate flags (XXX to stop RM cell output?), preserving RX pool</p></td><td class="code"><div class="highlight"><pre>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>no RXer on the channel, close channel</p></td><td class="code"><div class="highlight"><pre>      <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_CLOSE_VC</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">close</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span> <span class="c1">// vpi 0</span>
    <span class="p">}</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">txer</span><span class="p">[</span><span class="n">vci</span><span class="p">].</span><span class="n">tx_present</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">command_do</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span>
      <span class="n">schedule</span><span class="p">();</span>
    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vcc_sf</span><span class="p">);</span>
  <span class="p">}</span>
  </pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>disable RXing</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">command</span> <span class="n">cmd</span><span class="p">;</span>
    </pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>this is (the?) one reason why we need the amb_vcc struct</p></td><td class="code"><div class="highlight"><pre>    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">rx_info</span><span class="p">.</span><span class="n">pool</span><span class="p">;</span>
    
    <span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vcc_sf</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txer</span><span class="p">[</span><span class="n">vci</span><span class="p">].</span><span class="n">tx_present</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>TXer still on the channel, just go to pool zero XXX not really needed</p></td><td class="code"><div class="highlight"><pre>      <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_MODIFY_VC_FLAGS</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_flags</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span>  <span class="c1">// vpi 0</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">modify_flags</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_be32</span>
	<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txer</span><span class="p">[</span><span class="n">vci</span><span class="p">].</span><span class="n">tx_vc_bits</span> <span class="o">&lt;&lt;</span> <span class="n">SRB_FLAGS_SHIFT</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>no TXer on the channel, close the VC</p></td><td class="code"><div class="highlight"><pre>      <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_CLOSE_VC</span><span class="p">);</span>
      <span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">close</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span> <span class="c1">// vpi 0</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>forget the rxer - no more skbs will be pushed</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">atm_vcc</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxer</span><span class="p">[</span><span class="n">vci</span><span class="p">])</span>
      <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;%s vcc=%p rxer[vci]=%p&quot;</span><span class="p">,</span>
	      <span class="s">&quot;arghhh! we&#39;re going to die!&quot;</span><span class="p">,</span>
	      <span class="n">vcc</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxer</span><span class="p">[</span><span class="n">vci</span><span class="p">]);</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxer</span><span class="p">[</span><span class="n">vci</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">command_do</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span>
      <span class="n">schedule</span><span class="p">();</span>
    
    <span class="cm">/* shrink RX buffer pool */</span>
    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffers_wanted</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffers_wanted</span> <span class="o">==</span> <span class="n">rx_lats</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffers_wanted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">drain_rx_pool</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pool</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vcc_sf</span><span class="p">);</span>
  <span class="p">}</span>
  </pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>free our structure</p></td><td class="code"><div class="highlight"><pre>  <span class="n">kfree</span> <span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>say the VPI/VCI is free again</p></td><td class="code"><div class="highlight"><pre>  <span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** Send **********/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amb_send</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span> <span class="n">atm_vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">AMB_DEV</span><span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
  <span class="n">amb_vcc</span> <span class="o">*</span> <span class="n">vcc</span> <span class="o">=</span> <span class="n">AMB_VCC</span><span class="p">(</span><span class="n">atm_vcc</span><span class="p">);</span>
  <span class="n">u16</span> <span class="n">vc</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">tx_data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
  <span class="n">tx_simple</span> <span class="o">*</span> <span class="n">tx_descr</span><span class="p">;</span>
  <span class="n">tx_in</span> <span class="n">tx</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span> <span class="p">(</span><span class="n">dead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;amb_send vc %x data %p len %u&quot;</span><span class="p">,</span>
	  <span class="n">vc</span><span class="p">,</span> <span class="n">tx_data</span><span class="p">,</span> <span class="n">tx_len</span><span class="p">);</span>
  
  <span class="n">dump_skb</span> <span class="p">(</span><span class="s">&quot;&gt;&gt;&gt;&quot;</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txer</span><span class="p">[</span><span class="n">vc</span><span class="p">].</span><span class="n">tx_present</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;attempt to send on RX-only VC %x&quot;</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EBADFD</span><span class="p">;</span>
  <span class="p">}</span>
  </pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>this is a driver private field so we have to set it ourselves,
despite the fact that we are <em>required</em> to use it to check for a
pop function</p></td><td class="code"><div class="highlight"><pre>  <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;sk_buff length greater than agreed max_sdu, dropping...&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">check_area</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span> <span class="c1">// ?</span>
  <span class="p">}</span>
  </pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>allocate memory for fragments</p></td><td class="code"><div class="highlight"><pre>  <span class="n">tx_descr</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_simple</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_descr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;could not allocate TX descriptor&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">check_area</span> <span class="p">(</span><span class="n">tx_descr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_simple</span><span class="p">)))</span> <span class="p">{</span>
    <span class="n">kfree</span> <span class="p">(</span><span class="n">tx_descr</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;fragment list allocated at %p&quot;</span><span class="p">,</span> <span class="n">tx_descr</span><span class="p">);</span>
  
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
  
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag</span><span class="p">.</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">tx_len</span><span class="p">);</span>
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">tx_data</span><span class="p">));</span>
  
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag_end</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">tx_descr</span><span class="p">);</span>
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag_end</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag_end</span><span class="p">.</span><span class="n">next_descriptor_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag_end</span><span class="p">.</span><span class="n">next_descriptor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef AMB_NEW_MICROCODE</span>
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag_end</span><span class="p">.</span><span class="n">cpcs_uu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag_end</span><span class="p">.</span><span class="n">cpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag_end</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
  
  <span class="n">tx</span><span class="p">.</span><span class="n">vc</span> <span class="o">=</span> <span class="n">cpu_to_be16</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">tx_frame_bits</span> <span class="o">|</span> <span class="n">vc</span><span class="p">);</span>
  <span class="n">tx</span><span class="p">.</span><span class="n">tx_descr_length</span> <span class="o">=</span> <span class="n">cpu_to_be16</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_frag</span><span class="p">)</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_frag_end</span><span class="p">));</span>
  <span class="n">tx</span><span class="p">.</span><span class="n">tx_descr_addr</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">virt_to_bus</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tx_descr</span><span class="o">-&gt;</span><span class="n">tx_frag</span><span class="p">));</span>
  
  <span class="k">while</span> <span class="p">(</span><span class="n">tx_give</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx</span><span class="p">))</span>
    <span class="n">schedule</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** Change QoS on a VC **********/</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>int amb<em>change</em>qos (struct atm<em>vcc * atm</em>vcc, struct atm_qos * qos, int flags);</p></td><td class="code"><div class="highlight"><pre><span class="cm">/********** Free RX Socket Buffer **********/</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void amb_free_rx_skb (struct atm_vcc * atm_vcc, struct sk_buff * skb) {</span>
<span class="c">  amb_dev * dev = AMB_DEV (atm_vcc-&gt;dev);</span>
<span class="c">  amb_vcc * vcc = AMB_VCC (atm_vcc);</span>
<span class="c">  unsigned char pool = vcc-&gt;rx_info.pool;</span>
<span class="c">  rx_in rx;</span>
<span class="c">  </span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>This may be unsafe for various reasons that I cannot really guess
at. However, I note that the ATM layer calls kfree<em>skb rather
than dev</em>kfree_skb at this point so we are least covered as far
as buffer locking goes. There may be bugs if pcap clones RX skbs.</p></td><td class="code"><div class="highlight"><pre><span class="c">  PRINTD (DBG_FLOW|DBG_SKB, &quot;amb_rx_free skb %p (atm_vcc %p, vcc %p)&quot;,</span>
<span class="c">	  skb, atm_vcc, vcc);</span>
<span class="c">  </span>
<span class="c">  rx.handle = virt_to_bus (skb);</span>
<span class="c">  rx.host_address = cpu_to_be32 (virt_to_bus (skb-&gt;data));</span>
<span class="c">  </span>
<span class="c">  skb-&gt;data = skb-&gt;head;</span>
<span class="c">  skb-&gt;tail = skb-&gt;head;</span>
<span class="c">  skb-&gt;len = 0;</span>
<span class="c">  </span>
<span class="c">  if (!rx_give (dev, &amp;rx, pool)) {</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>success</p></td><td class="code"><div class="highlight"><pre><span class="c">    PRINTD (DBG_SKB|DBG_POOL, &quot;recycled skb for pool %hu&quot;, pool);</span>
<span class="c">    return;</span>
<span class="c">  }</span>
<span class="c">  </span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>just do what the ATM layer would have done</p></td><td class="code"><div class="highlight"><pre><span class="c">  dev_kfree_skb_any (skb);</span>
<span class="c">  </span>
<span class="c">  return;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/********** Proc File Output **********/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amb_proc_read</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span> <span class="n">atm_dev</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">page</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">AMB_DEV</span> <span class="p">(</span><span class="n">atm_dev</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="p">,</span> <span class="s">&quot;amb_proc_read&quot;</span><span class="p">);</span>
  
  <span class="cm">/* more diagnostics here? */</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">amb_stats</span> <span class="o">*</span> <span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span>
		    <span class="s">&quot;frames: TX OK %lu, RX OK %lu, RX bad %lu &quot;</span>
		    <span class="s">&quot;(CRC %lu, long %lu, aborted %lu, unused %lu).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">tx_ok</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">ok</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">error</span><span class="p">,</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">badcrc</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">toolong</span><span class="p">,</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">aborted</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">unused</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">amb_cq</span> <span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;cmd queue [cur/hi/max]: %u/%u/%u. &quot;</span><span class="p">,</span>
		    <span class="n">c</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">amb_txq</span> <span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;TX queue [cur/max high full]: %u/%u %u %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">t</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">high</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">filled</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;RX queues [cur/max/req low empty]:&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">amb_rxq</span> <span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
      <span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">count</span><span class="p">,</span> <span class="s">&quot; %u/%u/%u %u %u&quot;</span><span class="p">,</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">buffers_wanted</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">low</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">emptied</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">count</span><span class="p">,</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;RX buffer sizes:&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">amb_rxq</span> <span class="o">*</span> <span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
      <span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">count</span><span class="p">,</span> <span class="s">&quot; %u&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="n">sprintf</span> <span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">count</span><span class="p">,</span> <span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
  <span class="p">}</span>
  
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">  if (!left--) {</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>suni block etc?</p></td><td class="code"><div class="highlight"><pre><span class="c">  }</span>
<span class="cp">#endif</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** Operation Structure **********/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">amb_ops</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">.</span><span class="n">open</span>         <span class="o">=</span> <span class="n">amb_open</span><span class="p">,</span>
  <span class="p">.</span><span class="n">close</span>	<span class="o">=</span> <span class="n">amb_close</span><span class="p">,</span>
  <span class="p">.</span><span class="n">send</span>         <span class="o">=</span> <span class="n">amb_send</span><span class="p">,</span>
  <span class="p">.</span><span class="n">proc_read</span>	<span class="o">=</span> <span class="n">amb_proc_read</span><span class="p">,</span>
  <span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/********** housekeeping **********/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_housekeeping</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
  </pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>could collect device-specific (not driver/atm-linux) stats here</p></td><td class="code"><div class="highlight"><pre>      </pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>last resort refill once every ten seconds</p></td><td class="code"><div class="highlight"><pre>  <span class="n">fill_rx_pools</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
  <span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
  
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** creation of communication queues **********/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">create_queues</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmds</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">txs</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">rxs</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">rx_buffer_sizes</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span> <span class="n">memory</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span> <span class="n">limit</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="p">,</span> <span class="s">&quot;create_queues %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
  
  <span class="n">total</span> <span class="o">+=</span> <span class="n">cmds</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
  
  <span class="n">total</span> <span class="o">+=</span> <span class="n">txs</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">tx_in</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_out</span><span class="p">));</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">rxs</span><span class="p">[</span><span class="n">pool</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rx_in</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_out</span><span class="p">));</span>
  
  <span class="n">memory</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">total</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memory</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;could not allocate queues&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">check_area</span> <span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">total</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;queues allocated in nasty area&quot;</span><span class="p">);</span>
    <span class="n">kfree</span> <span class="p">(</span><span class="n">memory</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">limit</span> <span class="o">=</span> <span class="n">memory</span> <span class="o">+</span> <span class="n">total</span><span class="p">;</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot;queues from %p to %p&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;command queue at %p&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="p">);</span>
  
  <span class="p">{</span>
    <span class="n">command</span> <span class="o">*</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">memory</span><span class="p">;</span>
    <span class="n">amb_cq</span> <span class="o">*</span> <span class="n">cq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">;</span>
    
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">cmds</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ptrs</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ptrs</span><span class="p">.</span><span class="n">in</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ptrs</span><span class="p">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
    <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ptrs</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">+</span> <span class="n">cmds</span><span class="p">;</span>
    
    <span class="n">memory</span> <span class="o">=</span> <span class="n">cq</span><span class="o">-&gt;</span><span class="n">ptrs</span><span class="p">.</span><span class="n">limit</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;TX queue pair at %p&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="p">);</span>
  
  <span class="p">{</span>
    <span class="n">tx_in</span> <span class="o">*</span> <span class="n">in</span> <span class="o">=</span> <span class="n">memory</span><span class="p">;</span>
    <span class="n">tx_out</span> <span class="o">*</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">amb_txq</span> <span class="o">*</span> <span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">;</span>
    
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">txs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">in</span> <span class="o">+</span> <span class="n">txs</span><span class="p">;</span>
    
    <span class="n">memory</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">limit</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">memory</span><span class="p">;</span>
    
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">txs</span><span class="p">;</span>
    
    <span class="n">memory</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">limit</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;RX queue pairs at %p&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rx_in</span> <span class="o">*</span> <span class="n">in</span> <span class="o">=</span> <span class="n">memory</span><span class="p">;</span>
    <span class="n">rx_out</span> <span class="o">*</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">amb_rxq</span> <span class="o">*</span> <span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
    
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">rx_buffer_sizes</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">buffers_wanted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">low</span> <span class="o">=</span> <span class="n">rxs</span><span class="p">[</span><span class="n">pool</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">emptied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">rxs</span><span class="p">[</span><span class="n">pool</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">in</span> <span class="o">+</span> <span class="n">rxs</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
    
    <span class="n">memory</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">.</span><span class="n">limit</span><span class="p">;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">memory</span><span class="p">;</span>
    
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">out</span><span class="p">;</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">rxs</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
    
    <span class="n">memory</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">.</span><span class="n">limit</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">memory</span> <span class="o">==</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;bad queue alloc %p != %p (tell maintainer)&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
    <span class="n">kfree</span> <span class="p">(</span><span class="n">limit</span> <span class="o">-</span> <span class="n">total</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
  <span class="p">}</span>
  
<span class="p">}</span>

<span class="cm">/********** destruction of communication queues **********/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">destroy_queues</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>all queues assumed empty</p></td><td class="code"><div class="highlight"><pre>  <span class="kt">void</span> <span class="o">*</span> <span class="n">memory</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">ptrs</span><span class="p">.</span><span class="n">start</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>includes txq.in, txq.out, rxq[].in and rxq[].out</p></td><td class="code"><div class="highlight"><pre>  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="p">,</span> <span class="s">&quot;destroy_queues %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot;freeing queues at %p&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="p">);</span>
  <span class="n">kfree</span> <span class="p">(</span><span class="n">memory</span><span class="p">);</span>
  
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** basic loader commands and error handling **********/</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>centisecond timeouts - guessing away here</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command_timeouts</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">host_memory_test</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
	<span class="p">[</span><span class="n">read_adapter_memory</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">write_adapter_memory</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adapter_start</span><span class="p">]</span>        <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
	<span class="p">[</span><span class="n">get_version_number</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">[</span><span class="n">interrupt_host</span><span class="p">]</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">flash_erase_sector</span><span class="p">]</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adap_download_block</span><span class="p">]</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adap_erase_flash</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adap_run_in_iram</span><span class="p">]</span>     <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adap_end_download</span><span class="p">]</span>    <span class="o">=</span> <span class="mi">1</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">command_successes</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">host_memory_test</span><span class="p">]</span>     <span class="o">=</span> <span class="n">COMMAND_PASSED_TEST</span><span class="p">,</span>
	<span class="p">[</span><span class="n">read_adapter_memory</span><span class="p">]</span>  <span class="o">=</span> <span class="n">COMMAND_READ_DATA_OK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">write_adapter_memory</span><span class="p">]</span> <span class="o">=</span> <span class="n">COMMAND_WRITE_DATA_OK</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adapter_start</span><span class="p">]</span>        <span class="o">=</span> <span class="n">COMMAND_COMPLETE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">get_version_number</span><span class="p">]</span>   <span class="o">=</span> <span class="n">COMMAND_COMPLETE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">interrupt_host</span><span class="p">]</span>       <span class="o">=</span> <span class="n">COMMAND_COMPLETE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">flash_erase_sector</span><span class="p">]</span>   <span class="o">=</span> <span class="n">COMMAND_COMPLETE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adap_download_block</span><span class="p">]</span>  <span class="o">=</span> <span class="n">COMMAND_COMPLETE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adap_erase_flash</span><span class="p">]</span>     <span class="o">=</span> <span class="n">COMMAND_COMPLETE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adap_run_in_iram</span><span class="p">]</span>     <span class="o">=</span> <span class="n">COMMAND_COMPLETE</span><span class="p">,</span>
	<span class="p">[</span><span class="n">adap_end_download</span><span class="p">]</span>    <span class="o">=</span> <span class="n">COMMAND_COMPLETE</span>
<span class="p">};</span>
  
<span class="k">static</span>  <span class="kt">int</span> <span class="nf">decode_loader_result</span> <span class="p">(</span><span class="n">loader_command</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">command_successes</span><span class="p">[</span><span class="n">cmd</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BAD_COMMAND</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;bad command&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_IN_PROGRESS</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command in progress&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_PASSED_TEST</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command passed test&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_FAILED_TEST</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command failed test&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_READ_DATA_OK</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command read data ok&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_READ_BAD_ADDRESS</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command read bad address&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_WRITE_DATA_OK</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command write data ok&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_WRITE_BAD_ADDRESS</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command write bad address&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_WRITE_FLASH_FAILURE</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command write flash failure&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_COMPLETE</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command complete&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_FLASH_ERASE_FAILURE</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command flash erase failure&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">COMMAND_WRITE_BAD_DATA</span>:
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;command write bad data&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;unknown error&quot;</span><span class="p">;</span>
			<span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_LOAD</span><span class="o">|</span><span class="n">DBG_ERR</span><span class="p">,</span>
				<span class="s">&quot;decode_loader_result got %d=%x !&quot;</span><span class="p">,</span>
				<span class="n">result</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">do_loader_command</span> <span class="p">(</span><span class="k">volatile</span> <span class="n">loader_block</span> <span class="o">*</span> <span class="n">lb</span><span class="p">,</span>
				     <span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">loader_command</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
  
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;do_loader_command&quot;</span><span class="p">);</span>
  
  <span class="cm">/* do a command</span>
<span class="cm">     </span>
<span class="cm">     Set the return value to zero, set the command type and set the</span>
<span class="cm">     valid entry to the right magic value. The payload is already</span>
<span class="cm">     correctly byte-ordered so we leave it alone. Hit the doorbell</span>
<span class="cm">     with the bus address of this structure.</span>
<span class="cm">     </span>
<span class="cm">  */</span>
  
  <span class="n">lb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">lb</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
  <span class="n">lb</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">DMA_VALID</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>dump<em>registers (dev);
dump</em>loader_block (lb);</p></td><td class="code"><div class="highlight"><pre>  <span class="n">wr_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">),</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">lb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">onegigmask</span><span class="p">);</span>
  
  <span class="n">timeout</span> <span class="o">=</span> <span class="n">command_timeouts</span><span class="p">[</span><span class="n">cmd</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
  
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">||</span> <span class="n">lb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">==</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">COMMAND_IN_PROGRESS</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">timeout</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_LOAD</span><span class="o">|</span><span class="n">DBG_ERR</span><span class="p">,</span> <span class="s">&quot;command %d timed out&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
      <span class="n">dump_registers</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
      <span class="n">dump_loader_block</span> <span class="p">(</span><span class="n">lb</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
    <span class="p">}</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">adapter_start</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>wait for start command to acknowledge...</p></td><td class="code"><div class="highlight"><pre>    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">rd_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">)))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_LOAD</span><span class="o">|</span><span class="n">DBG_ERR</span><span class="p">,</span> <span class="s">&quot;start command did not clear doorbell, res=%08x&quot;</span><span class="p">,</span>
		<span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">));</span>
	<span class="n">dump_registers</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">decode_loader_result</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">));</span>
  <span class="p">}</span>
  
<span class="p">}</span>

<span class="cm">/* loader: determine loader version */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">get_loader_version</span> <span class="p">(</span><span class="n">loader_block</span> <span class="o">*</span> <span class="n">lb</span><span class="p">,</span>
				      <span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">version</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;get_loader_version&quot;</span><span class="p">);</span>
  
  <span class="n">res</span> <span class="o">=</span> <span class="n">do_loader_command</span> <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">get_version_number</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">version</span><span class="p">)</span>
    <span class="o">*</span><span class="n">version</span> <span class="o">=</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* loader: write memory data blocks */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">loader_write</span> <span class="p">(</span><span class="n">loader_block</span><span class="o">*</span> <span class="n">lb</span><span class="p">,</span>
				   <span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">ihex_binrec</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">transfer_block</span> <span class="o">*</span> <span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">transfer</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;loader_write&quot;</span><span class="p">);</span>

  <span class="n">tb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
  <span class="n">tb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">do_loader_command</span> <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">write_adapter_memory</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* loader: verify memory data blocks */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">loader_verify</span> <span class="p">(</span><span class="n">loader_block</span> <span class="o">*</span> <span class="n">lb</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">ihex_binrec</span> <span class="o">*</span><span class="n">rec</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">transfer_block</span> <span class="o">*</span> <span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lb</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">transfer</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;loader_verify&quot;</span><span class="p">);</span>
  
  <span class="n">tb</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
  <span class="n">tb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">res</span> <span class="o">=</span> <span class="n">do_loader_command</span> <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">read_adapter_memory</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* loader: start microcode */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">loader_start</span> <span class="p">(</span><span class="n">loader_block</span> <span class="o">*</span> <span class="n">lb</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;loader_start&quot;</span><span class="p">);</span>
  
  <span class="n">lb</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">address</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">do_loader_command</span> <span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">adapter_start</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********** reset card **********/</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sf</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;self-test failed: %s&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">amb_reset</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">diags</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">u32</span> <span class="n">word</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;amb_reset&quot;</span><span class="p">);</span>
  
  <span class="n">word</span> <span class="o">=</span> <span class="n">rd_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">reset_control</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>put card into reset state</p></td><td class="code"><div class="highlight"><pre>  <span class="n">wr_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">reset_control</span><span class="p">),</span> <span class="n">word</span> <span class="o">|</span> <span class="n">AMB_RESET_BITS</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>wait a short while</p></td><td class="code"><div class="highlight"><pre>  <span class="n">udelay</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="cp">#if 1</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>put card into known good state</p></td><td class="code"><div class="highlight"><pre>  <span class="n">wr_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">interrupt_control</span><span class="p">),</span> <span class="n">AMB_DOORBELL_BITS</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>clear all interrupts just in case</p></td><td class="code"><div class="highlight"><pre>  <span class="n">wr_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>clear self-test done flag</p></td><td class="code"><div class="highlight"><pre>  <span class="n">wr_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">mb</span><span class="p">.</span><span class="n">loader</span><span class="p">.</span><span class="n">ready</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>take card out of reset state</p></td><td class="code"><div class="highlight"><pre>  <span class="n">wr_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">reset_control</span><span class="p">),</span> <span class="n">word</span> <span class="o">&amp;~</span> <span class="n">AMB_RESET_BITS</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">diags</span><span class="p">)</span> <span class="p">{</span> 
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>4.2 second wait</p></td><td class="code"><div class="highlight"><pre>    <span class="n">msleep</span><span class="p">(</span><span class="mi">4200</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>half second time-out</p></td><td class="code"><div class="highlight"><pre>    <span class="n">timeout</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">rd_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">mb</span><span class="p">.</span><span class="n">loader</span><span class="p">.</span><span class="n">ready</span><span class="p">)))</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_LOAD</span><span class="o">|</span><span class="n">DBG_ERR</span><span class="p">,</span> <span class="s">&quot;reset timed out&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
      <span class="p">}</span>
    </pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>get results of self-test
XXX double check byte-order</p></td><td class="code"><div class="highlight"><pre>    <span class="n">word</span> <span class="o">=</span> <span class="n">rd_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">mb</span><span class="p">.</span><span class="n">loader</span><span class="p">.</span><span class="n">result</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">SELF_TEST_FAILURE</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">GPINT_TST_FAILURE</span><span class="p">)</span>
	<span class="n">sf</span> <span class="p">(</span><span class="s">&quot;interrupt&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">SUNI_DATA_PATTERN_FAILURE</span><span class="p">)</span>
	<span class="n">sf</span> <span class="p">(</span><span class="s">&quot;SUNI data pattern&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">SUNI_DATA_BITS_FAILURE</span><span class="p">)</span>
	<span class="n">sf</span> <span class="p">(</span><span class="s">&quot;SUNI data bits&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">SUNI_UTOPIA_FAILURE</span><span class="p">)</span>
	<span class="n">sf</span> <span class="p">(</span><span class="s">&quot;SUNI UTOPIA interface&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">SUNI_FIFO_FAILURE</span><span class="p">)</span>
	<span class="n">sf</span> <span class="p">(</span><span class="s">&quot;SUNI cell buffer FIFO&quot;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">word</span> <span class="o">&amp;</span> <span class="n">SRAM_FAILURE</span><span class="p">)</span>
	<span class="n">sf</span> <span class="p">(</span><span class="s">&quot;bad SRAM&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>better return value?</p></td><td class="code"><div class="highlight"><pre>      <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>
    
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** transfer and start the microcode **********/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ucode_init</span> <span class="p">(</span><span class="n">loader_block</span> <span class="o">*</span> <span class="n">lb</span><span class="p">,</span> <span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_address</span><span class="p">;</span>
  <span class="k">const</span> <span class="k">struct</span> <span class="n">ihex_binrec</span> <span class="o">*</span><span class="n">rec</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errmsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

  <span class="n">res</span> <span class="o">=</span> <span class="n">request_ihex_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="s">&quot;atmsar11.fw&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Cannot load microcode data&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/* First record contains just the start address */</span>
  <span class="n">rec</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ihex_binrec</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">)</span> <span class="o">||</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;no start record&quot;</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">start_address</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

  <span class="n">rec</span> <span class="o">=</span> <span class="n">ihex_next_binrec</span><span class="p">(</span><span class="n">rec</span><span class="p">);</span>

  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;ucode_init&quot;</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;starting region (%x, %u)&quot;</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">),</span>
	    <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">MAX_TRANSFER_DATA</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;record too long&quot;</span><span class="p">;</span>
	    <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;odd number of bytes&quot;</span><span class="p">;</span>
	    <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">loader_write</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">rec</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>

    <span class="n">res</span> <span class="o">=</span> <span class="n">loader_verify</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">rec</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">loader_start</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">start_address</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="nl">fail:</span>
  <span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
  <span class="n">PRINTK</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Bad microcode data (%s)&quot;</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** give adapter parameters **********/</span>
  
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__be32</span> <span class="nf">bus_addr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">amb_talk</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">adap_talk_block</span> <span class="n">a</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
  
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="p">,</span> <span class="s">&quot;amb_talk %p&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
  
  <span class="n">a</span><span class="p">.</span><span class="n">command_start</span> <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">ptrs</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
  <span class="n">a</span><span class="p">.</span><span class="n">command_end</span>   <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">ptrs</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
  <span class="n">a</span><span class="p">.</span><span class="n">tx_start</span>      <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
  <span class="n">a</span><span class="p">.</span><span class="n">tx_end</span>        <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
  <span class="n">a</span><span class="p">.</span><span class="n">txcom_start</span>   <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
  <span class="n">a</span><span class="p">.</span><span class="n">txcom_end</span>     <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>the other "a" items are set up by the adapter</p></td><td class="code"><div class="highlight"><pre>    <span class="n">a</span><span class="p">.</span><span class="n">rec_struct</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffer_start</span> <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">in</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
    <span class="n">a</span><span class="p">.</span><span class="n">rec_struct</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffer_end</span>   <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">in</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
    <span class="n">a</span><span class="p">.</span><span class="n">rec_struct</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">rx_start</span>     <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">out</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
    <span class="n">a</span><span class="p">.</span><span class="n">rec_struct</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">rx_end</span>       <span class="o">=</span> <span class="n">bus_addr</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">out</span><span class="p">.</span><span class="n">limit</span><span class="p">);</span>
    <span class="n">a</span><span class="p">.</span><span class="n">rec_struct</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffer_size</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">buffer_size</span><span class="p">);</span>
  <span class="p">}</span>
  
<span class="cp">#ifdef AMB_NEW_MICROCODE</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>disable fast PLX prefetching</p></td><td class="code"><div class="highlight"><pre>  <span class="n">a</span><span class="p">.</span><span class="n">init_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
  </pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>pass the structure</p></td><td class="code"><div class="highlight"><pre>  <span class="n">wr_mem</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">),</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">));</span>
  </pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>2.2 second wait (must not touch doorbell during 2 second DMA test)</p></td><td class="code"><div class="highlight"><pre>  <span class="n">msleep</span><span class="p">(</span><span class="mi">2200</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>give the adapter another half second?</p></td><td class="code"><div class="highlight"><pre>  <span class="n">timeout</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">rd_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">doorbell</span><span class="p">)))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">timeout</span> <span class="o">=</span> <span class="n">msleep_interruptible</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_INIT</span><span class="o">|</span><span class="n">DBG_ERR</span><span class="p">,</span> <span class="s">&quot;adapter init timed out&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
    <span class="p">}</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>get microcode version</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">amb_ucode_version</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">u32</span> <span class="n">major</span><span class="p">;</span>
  <span class="n">u32</span> <span class="n">minor</span><span class="p">;</span>
  <span class="n">command</span> <span class="n">cmd</span><span class="p">;</span>
  <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_GET_VERSION</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">command_do</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
    <span class="n">schedule</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">major</span> <span class="o">=</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">major</span><span class="p">);</span>
  <span class="n">minor</span> <span class="o">=</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">version</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>
  <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;microcode version is %u.%u&quot;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">);</span>
<span class="p">}</span>
  </pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>get end station address</p></td><td class="code"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">amb_esi</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">esi</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">u32</span> <span class="n">lower4</span><span class="p">;</span>
  <span class="n">u16</span> <span class="n">upper2</span><span class="p">;</span>
  <span class="n">command</span> <span class="n">cmd</span><span class="p">;</span>
  
  <span class="n">cmd</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">cpu_to_be32</span> <span class="p">(</span><span class="n">SRB_GET_BIA</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">command_do</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
    <span class="n">schedule</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">lower4</span> <span class="o">=</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">bia</span><span class="p">.</span><span class="n">lower4</span><span class="p">);</span>
  <span class="n">upper2</span> <span class="o">=</span> <span class="n">be32_to_cpu</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">bia</span><span class="p">.</span><span class="n">upper2</span><span class="p">);</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_LOAD</span><span class="p">,</span> <span class="s">&quot;BIA: lower4: %08x, upper2 %04x&quot;</span><span class="p">,</span> <span class="n">lower4</span><span class="p">,</span> <span class="n">upper2</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">esi</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    
    <span class="n">PRINTDB</span> <span class="p">(</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot;ESI:&quot;</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESI_LEN</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
	  <span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">lower4</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">i</span><span class="p">));</span>
      <span class="k">else</span>
	  <span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="n">upper2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">4</span><span class="p">)));</span>
      <span class="n">PRINTDM</span> <span class="p">(</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
    
    <span class="n">PRINTDE</span> <span class="p">(</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
  <span class="p">}</span>
  
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
  
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fixup_plx_window</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">loader_block</span> <span class="o">*</span><span class="n">lb</span><span class="p">)</span>
<span class="p">{</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>fix up the PLX-mapped window base address to match the block</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">blb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mapreg</span><span class="p">;</span>
	<span class="n">blb</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">lb</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>the kernel stack had better not ever cross a 1Gb boundary!</p></td><td class="code"><div class="highlight"><pre>	<span class="n">mapreg</span> <span class="o">=</span> <span class="n">rd_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">stuff</span><span class="p">[</span><span class="mi">10</span><span class="p">]));</span>
	<span class="n">mapreg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">onegigmask</span><span class="p">;</span>
	<span class="n">mapreg</span> <span class="o">|=</span> <span class="n">blb</span> <span class="o">&amp;</span> <span class="n">onegigmask</span><span class="p">;</span>
	<span class="n">wr_plain</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">,</span> <span class="n">stuff</span><span class="p">[</span><span class="mi">10</span><span class="p">]),</span> <span class="n">mapreg</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">amb_init</span> <span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">loader_block</span> <span class="n">lb</span><span class="p">;</span>
  
  <span class="n">u32</span> <span class="n">version</span><span class="p">;</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">amb_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;card reset failed!&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">fixup_plx_window</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lb</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">get_loader_version</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">version</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;failed to get loader version&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;loader version is %08x&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
      
      <span class="k">if</span> <span class="p">(</span><span class="n">ucode_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">lb</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;microcode failure&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">create_queues</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmds</span><span class="p">,</span> <span class="n">txs</span><span class="p">,</span> <span class="n">rxs</span><span class="p">,</span> <span class="n">rxs_bs</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;failed to get memory for queues&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">amb_talk</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
	  <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;adapter did not accept queues&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	  
	  <span class="n">amb_ucode_version</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	  
	<span class="p">}</span> <span class="cm">/* amb_talk */</span>
	
	<span class="n">destroy_queues</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
      <span class="p">}</span> <span class="cm">/* create_queues, ucode_init */</span>
      
      <span class="n">amb_reset</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="cm">/* get_loader_version */</span>
    
  <span class="p">}</span> <span class="cm">/* amb_reset */</span>
  
  <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_dev</span><span class="p">(</span><span class="n">amb_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span> 
<span class="p">{</span>
      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">;</span>
      </pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>set up known dev items straight away</p></td><td class="code"><div class="highlight"><pre>      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span> 
      <span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
      
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span> <span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span> 
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">bus_to_virt</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
      </pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>flags (currently only dead)</p></td><td class="code"><div class="highlight"><pre>      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      </pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>Allocate cell rates (fibre)
ATM<em>OC3</em>PCR = 1555200000/8/270*260/53 - 29/53
to be really pedantic, this should be ATM<em>OC3c</em>PCR</p></td><td class="code"><div class="highlight"><pre>      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_avail</span> <span class="o">=</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>
      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_avail</span> <span class="o">=</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>
      </pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>semaphore for txer/rxer modifications - we cannot use a
spinlock as the critical region needs to switch processes</p></td><td class="code"><div class="highlight"><pre>      <span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vcc_sf</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>queue manipulation spinlocks; we want atomic reads and
writes to the queue descriptors (handles IRQ and SMP)
consider replacing "int pending" -> "atomic_t available"
=> problem related to who gets to move queue pointers</p></td><td class="code"><div class="highlight"><pre>      <span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cq</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
      <span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span>
	<span class="n">spin_lock_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">[</span><span class="n">pool</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_pci_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lat</span><span class="p">;</span>
      </pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>enable bus master accesses</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>frobnicate latency (upwards, usually)</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pci_read_config_byte</span> <span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_lat</span><span class="p">)</span>
		<span class="n">pci_lat</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat</span> <span class="o">&lt;</span> <span class="n">MIN_PCI_LATENCY</span><span class="p">)</span> <span class="o">?</span> <span class="n">MIN_PCI_LATENCY</span> <span class="o">:</span> <span class="n">lat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lat</span> <span class="o">!=</span> <span class="n">pci_lat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Changing PCI latency timer from %hu to %hu&quot;</span><span class="p">,</span>
			<span class="n">lat</span><span class="p">,</span> <span class="n">pci_lat</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">pci_lat</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">amb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">amb_dev</span> <span class="o">*</span> <span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>
      
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;skipped broken (PLX rev 2) card&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>read resources from PCI configuration space</p></td><td class="code"><div class="highlight"><pre>	<span class="n">irq</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_MADGE_AMBASSADOR_BAD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;skipped broken (PLX rev 2) card&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_INFO</span><span class="p">,</span> <span class="s">&quot;found Madge ATM adapter (amb) at&quot;</span>
		<span class="s">&quot; IO %llx, IRQ %u, MEM %p&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		<span class="n">irq</span><span class="p">,</span> <span class="n">bus_to_virt</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>check IO region</p></td><td class="code"><div class="highlight"><pre>	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEV_LABEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;IO range already in use!&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">amb_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;out of memory!&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">amb_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;adapter initialisation failure&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup_pci_dev</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>grab (but share) IRQ and install handler</p></td><td class="code"><div class="highlight"><pre>	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">interrupt_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DEV_LABEL</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;request IRQ failed!&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_reset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span> <span class="o">=</span> <span class="n">atm_dev_register</span> <span class="p">(</span><span class="n">DEV_LABEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amb_ops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
					 <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_ERR</span><span class="p">,</span> <span class="s">&quot;failed to register Madge ATM adapter&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_INFO</span><span class="p">,</span> <span class="s">&quot;registered Madge ATM adapter (no. %d) (%p) at %p&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>register our address</p></td><td class="code"><div class="highlight"><pre>	<span class="n">amb_esi</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>0 bits for vpi, 10 bits for vci</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="n">NUM_VPI_BITS</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="n">NUM_VCI_BITS</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">do_housekeeping</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>enable host interrupts</p></td><td class="code"><div class="highlight"><pre>	<span class="n">interrupts_on</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">out_reset:</span>
	<span class="n">amb_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out_release:</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">out_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">amb_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amb_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">PRINTD</span><span class="p">(</span><span class="n">DBG_INFO</span><span class="o">|</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot;closing %p (atm_dev = %p)&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div><p>the drain should not be necessary</p></td><td class="code"><div class="highlight"><pre>	<span class="n">drain_rx_pools</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">interrupts_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">amb_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">destroy_queues</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">amb_check_args</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pool</span><span class="p">;</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_rx_size</span><span class="p">;</span>
  
<span class="cp">#ifdef DEBUG_AMBASSADOR</span>
  <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;debug bitmap is %hx&quot;</span><span class="p">,</span> <span class="n">debug</span> <span class="o">&amp;=</span> <span class="n">DBG_MASK</span><span class="p">);</span>
<span class="cp">#else</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;no debugging support&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">cmds</span> <span class="o">&lt;</span> <span class="n">MIN_QUEUE_SIZE</span><span class="p">)</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;cmds has been raised to %u&quot;</span><span class="p">,</span>
	    <span class="n">cmds</span> <span class="o">=</span> <span class="n">MIN_QUEUE_SIZE</span><span class="p">);</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">txs</span> <span class="o">&lt;</span> <span class="n">MIN_QUEUE_SIZE</span><span class="p">)</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;txs has been raised to %u&quot;</span><span class="p">,</span>
	    <span class="n">txs</span> <span class="o">=</span> <span class="n">MIN_QUEUE_SIZE</span><span class="p">);</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rxs</span><span class="p">[</span><span class="n">pool</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MIN_QUEUE_SIZE</span><span class="p">)</span>
      <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;rxs[%hu] has been raised to %u&quot;</span><span class="p">,</span>
	      <span class="n">pool</span><span class="p">,</span> <span class="n">rxs</span><span class="p">[</span><span class="n">pool</span><span class="p">]</span> <span class="o">=</span> <span class="n">MIN_QUEUE_SIZE</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>buffers sizes should be greater than zero and strictly increasing</p></td><td class="code"><div class="highlight"><pre>  <span class="n">max_rx_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">pool</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pool</span> <span class="o">&lt;</span> <span class="n">NUM_RX_POOLS</span><span class="p">;</span> <span class="o">++</span><span class="n">pool</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rxs_bs</span><span class="p">[</span><span class="n">pool</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_rx_size</span><span class="p">)</span>
      <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;useless pool (rxs_bs[%hu] = %u)&quot;</span><span class="p">,</span>
	      <span class="n">pool</span><span class="p">,</span> <span class="n">rxs_bs</span><span class="p">[</span><span class="n">pool</span><span class="p">]);</span>
    <span class="k">else</span>
      <span class="n">max_rx_size</span> <span class="o">=</span> <span class="n">rxs_bs</span><span class="p">[</span><span class="n">pool</span><span class="p">];</span>
  
  <span class="k">if</span> <span class="p">(</span><span class="n">rx_lats</span> <span class="o">&lt;</span> <span class="n">MIN_RX_BUFFERS</span><span class="p">)</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="s">&quot;rx_lats has been raised to %u&quot;</span><span class="p">,</span>
	    <span class="n">rx_lats</span> <span class="o">=</span> <span class="n">MIN_RX_BUFFERS</span><span class="p">);</span>
  
  <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/********** module stuff **********/</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">maintainer_string</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">description_string</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmsar11.fw&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>   <span class="n">ushort</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span>    <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">txs</span><span class="p">,</span>     <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">rxs</span><span class="p">,</span>     <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">rxs_bs</span><span class="p">,</span>  <span class="n">uint</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rx_lats</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pci_lat</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>   <span class="s">&quot;debug bitmap, see .h file&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">cmds</span><span class="p">,</span>    <span class="s">&quot;number of command queue entries&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">txs</span><span class="p">,</span>     <span class="s">&quot;number of TX queue entries&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rxs</span><span class="p">,</span>     <span class="s">&quot;number of RX queue entries [&quot;</span> <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">NUM_RX_POOLS</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rxs_bs</span><span class="p">,</span>  <span class="s">&quot;size of RX buffers [&quot;</span> <span class="n">__MODULE_STRING</span><span class="p">(</span><span class="n">NUM_RX_POOLS</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">rx_lats</span><span class="p">,</span> <span class="s">&quot;number of extra buffers to cope with RX latencies&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pci_lat</span><span class="p">,</span> <span class="s">&quot;PCI latency in bus cycles&quot;</span><span class="p">);</span>

<span class="cm">/********** module entry **********/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">amb_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MADGE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MADGE_AMBASSADOR</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">MADGE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_MADGE_AMBASSADOR_BAD</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">amb_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">amb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;amb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">amb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>	<span class="n">__devexit_p</span><span class="p">(</span><span class="n">amb_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">amb_pci_tbl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">amb_module_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot;init_module&quot;</span><span class="p">);</span>
  </pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>sanity check - cast needed as printk does not support %Zu</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">16</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">PRINTK</span> <span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Fix amb_mem (is %lu words).&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">amb_mem</span><span class="p">));</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="n">show_version</span><span class="p">();</span>
  
  <span class="n">amb_check_args</span><span class="p">();</span>
  </pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>get the juice</p></td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/********** module exit **********/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">amb_module_exit</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">PRINTD</span> <span class="p">(</span><span class="n">DBG_FLOW</span><span class="o">|</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot;cleanup_module&quot;</span><span class="p">);</span>

  <span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">amb_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">amb_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
