<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › atm › fore200e.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>fore200e.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">  A FORE Systems 200E-series driver for ATM on Linux.</span>
<span class="cm">  Christophe Lizzi (lizzi@cnam.fr), October 1999-March 2003.</span>

<span class="cm">  Based on the PCA-200E driver from Uwe Dannowski (Uwe.Dannowski@inf.tu-dresden.de).</span>

<span class="cm">  This driver simultaneously supports PCA-200E and SBA-200E adapters</span>
<span class="cm">  on i386, alpha (untested), powerpc, sparc and sparc64 architectures.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>


<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;linux/sonet.h&gt;</span>
<span class="cp">#include &lt;linux/atm_suni.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/string.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="cp">#include &lt;linux/of.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;asm/idprom.h&gt;</span>
<span class="cp">#include &lt;asm/openprom.h&gt;</span>
<span class="cp">#include &lt;asm/oplib.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_ATM_FORE200E_USE_TASKLET) </span><span class="cm">/* defer interrupt work to a tasklet */</span><span class="cp"></span>
<span class="cp">#define FORE200E_USE_TASKLET</span>
<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"> /* enable the debugging code of the buffer supply queues */</span>
<span class="c">#define FORE200E_BSQ_DEBUG</span>
<span class="cp">#endif</span>

<span class="cp">#if 1 </span><span class="cm">/* ensure correct handling of 52-byte AAL0 SDUs expected by atmdump-like apps */</span><span class="cp"></span>
<span class="cp">#define FORE200E_52BYTE_AAL0_SDU</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;fore200e.h&quot;</span>
<span class="cp">#include &quot;suni.h&quot;</span>

<span class="cp">#define FORE200E_VERSION &quot;0.3e&quot;</span>

<span class="cp">#define FORE200E         &quot;fore200e: &quot;</span>

<span class="cp">#if 0</span><span class="c"> /* override .config */</span>
<span class="c">#define CONFIG_ATM_FORE200E_DEBUG 1</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_ATM_FORE200E_DEBUG) &amp;&amp; (CONFIG_ATM_FORE200E_DEBUG &gt; 0)</span>
<span class="cp">#define DPRINTK(level, format, args...)  do { if (CONFIG_ATM_FORE200E_DEBUG &gt;= (level)) \</span>
<span class="cp">                                                  printk(FORE200E format, ##args); } while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(level, format, args...)  do {} while (0)</span>
<span class="cp">#endif</span>


<span class="cp">#define FORE200E_ALIGN(addr, alignment) \</span>
<span class="cp">        ((((unsigned long)(addr) + (alignment - 1)) &amp; ~(alignment - 1)) - (unsigned long)(addr))</span>

<span class="cp">#define FORE200E_DMA_INDEX(dma_addr, type, index)  ((dma_addr) + (index) * sizeof(type))</span>

<span class="cp">#define FORE200E_INDEX(virt_addr, type, index)     (&amp;((type *)(virt_addr))[ index ])</span>

<span class="cp">#define FORE200E_NEXT_ENTRY(index, modulo)         (index = ((index) + 1) % (modulo))</span>

<span class="cp">#if 1</span>
<span class="cp">#define ASSERT(expr)     if (!(expr)) { \</span>
<span class="cp">			     printk(FORE200E &quot;assertion failed! %s[%d]: %s\n&quot;, \</span>
<span class="cp">				    __func__, __LINE__, #expr); \</span>
<span class="cp">			     panic(FORE200E &quot;%s&quot;, __func__); \</span>
<span class="cp">			 }</span>
<span class="cp">#else</span>
<span class="cp">#define ASSERT(expr)     do {} while (0)</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atmdev_ops</span>   <span class="n">fore200e_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fore200e_bus</span> <span class="n">fore200e_bus</span><span class="p">[];</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">fore200e_boards</span><span class="p">);</span>


<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Christophe Lizzi - credits to Uwe Dannowski and Heikki Vatiainen&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FORE Systems 200E-series ATM driver - version &quot;</span> <span class="n">FORE200E_VERSION</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;PCA-200E, SBA-200E&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">fore200e_rx_buf_nbr</span><span class="p">[</span> <span class="n">BUFFER_SCHEME_NBR</span> <span class="p">][</span> <span class="n">BUFFER_MAGN_NBR</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">BUFFER_S1_NBR</span><span class="p">,</span> <span class="n">BUFFER_L1_NBR</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">BUFFER_S2_NBR</span><span class="p">,</span> <span class="n">BUFFER_L2_NBR</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">fore200e_rx_buf_size</span><span class="p">[</span> <span class="n">BUFFER_SCHEME_NBR</span> <span class="p">][</span> <span class="n">BUFFER_MAGN_NBR</span> <span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">BUFFER_S1_SIZE</span><span class="p">,</span> <span class="n">BUFFER_L1_SIZE</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">BUFFER_S2_SIZE</span><span class="p">,</span> <span class="n">BUFFER_L2_SIZE</span> <span class="p">}</span>
<span class="p">};</span>


<span class="cp">#if defined(CONFIG_ATM_FORE200E_DEBUG) &amp;&amp; (CONFIG_ATM_FORE200E_DEBUG &gt; 0)</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">fore200e_traffic_class</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;NONE&quot;</span><span class="p">,</span> <span class="s">&quot;UBR&quot;</span><span class="p">,</span> <span class="s">&quot;CBR&quot;</span><span class="p">,</span> <span class="s">&quot;VBR&quot;</span><span class="p">,</span> <span class="s">&quot;ABR&quot;</span><span class="p">,</span> <span class="s">&quot;ANY&quot;</span> <span class="p">};</span>
<span class="cp">#endif</span>


<span class="cp">#if 0</span><span class="c"> /* currently unused */</span>
<span class="c">static int </span>
<span class="c">fore200e_fore2atm_aal(enum fore200e_aal aal)</span>
<span class="c">{</span>
<span class="c">    switch(aal) {</span>
<span class="c">    case FORE200E_AAL0:  return ATM_AAL0;</span>
<span class="c">    case FORE200E_AAL34: return ATM_AAL34;</span>
<span class="c">    case FORE200E_AAL5:  return ATM_AAL5;</span>
<span class="c">    }</span>

<span class="c">    return -EINVAL;</span>
<span class="c">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="k">enum</span> <span class="n">fore200e_aal</span>
<span class="nf">fore200e_atm2fore_aal</span><span class="p">(</span><span class="kt">int</span> <span class="n">aal</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ATM_AAL0</span>:  <span class="k">return</span> <span class="n">FORE200E_AAL0</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ATM_AAL34</span>: <span class="k">return</span> <span class="n">FORE200E_AAL34</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">ATM_AAL1</span>:
    <span class="k">case</span> <span class="n">ATM_AAL2</span>:
    <span class="k">case</span> <span class="n">ATM_AAL5</span>:  <span class="k">return</span> <span class="n">FORE200E_AAL5</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">char</span><span class="o">*</span>
<span class="nf">fore200e_irq_itoa</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="kt">char</span> <span class="n">str</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* allocate and align a chunk of memory intended to hold the data behing exchanged</span>
<span class="cm">   between the driver and the adapter (using streaming DVMA) */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_chunk_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chunk</span><span class="o">*</span> <span class="n">chunk</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alignment</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">alignment</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
	<span class="n">alignment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="n">alignment</span><span class="p">;</span>
    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">align_size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">direction</span>  <span class="o">=</span> <span class="n">direction</span><span class="p">;</span>

    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">alignment</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">FORE200E_ALIGN</span><span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span><span class="p">,</span> <span class="n">alignment</span><span class="p">);</span> 
    
    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">align_addr</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_map</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">align_addr</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">align_size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* free a chunk of memory */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_chunk_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chunk</span><span class="o">*</span> <span class="n">chunk</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_unmap</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">dma_size</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">direction</span><span class="p">);</span>

    <span class="n">kfree</span><span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_spin</span><span class="p">(</span><span class="kt">int</span> <span class="n">msecs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">msecs</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">volatile</span> <span class="n">u32</span><span class="o">*</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msecs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">msecs</span><span class="p">);</span>
    <span class="kt">int</span>           <span class="n">ok</span><span class="p">;</span>

    <span class="n">mb</span><span class="p">();</span>
    <span class="k">do</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">addr</span> <span class="o">==</span> <span class="n">val</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">STATUS_ERROR</span><span class="p">))</span>
	    <span class="k">break</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>

<span class="cp">#if 1</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;cmd polling failed, got status 0x%08x, expected 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_io_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msecs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">msecs</span><span class="p">);</span>
    <span class="kt">int</span>           <span class="n">ok</span><span class="p">;</span>

    <span class="k">do</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ok</span> <span class="o">=</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">==</span> <span class="n">val</span><span class="p">)))</span>
	    <span class="k">break</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>

<span class="cp">#if 1</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;I/O polling failed, got status 0x%08x, expected 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="n">ok</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_free_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">nbr</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">buffer</span><span class="o">*</span> <span class="n">buffer</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scheme</span> <span class="o">&lt;</span> <span class="n">BUFFER_SCHEME_NBR</span><span class="p">;</span> <span class="n">scheme</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">magn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">magn</span> <span class="o">&lt;</span> <span class="n">BUFFER_MAGN_NBR</span><span class="p">;</span> <span class="n">magn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	    <span class="k">if</span> <span class="p">((</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">].</span><span class="n">buffer</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">nbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nbr</span> <span class="o">&lt;</span> <span class="n">fore200e_rx_buf_nbr</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">];</span> <span class="n">nbr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		    <span class="k">struct</span> <span class="n">chunk</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span> <span class="n">nbr</span> <span class="p">].</span><span class="n">data</span><span class="p">;</span>

		    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">alloc_addr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">fore200e_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_uninit_bs_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">;</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scheme</span> <span class="o">&lt;</span> <span class="n">BUFFER_SCHEME_NBR</span><span class="p">;</span> <span class="n">scheme</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">magn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">magn</span> <span class="o">&lt;</span> <span class="n">BUFFER_MAGN_NBR</span><span class="p">;</span> <span class="n">magn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	    <span class="k">struct</span> <span class="n">chunk</span><span class="o">*</span> <span class="n">status</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">].</span><span class="n">status</span><span class="p">;</span>
	    <span class="k">struct</span> <span class="n">chunk</span><span class="o">*</span> <span class="n">rbd_block</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">].</span><span class="n">rbd_block</span><span class="p">;</span>
	    
	    <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">alloc_addr</span><span class="p">)</span>
		<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	    
	    <span class="k">if</span> <span class="p">(</span><span class="n">rbd_block</span><span class="o">-&gt;</span><span class="n">alloc_addr</span><span class="p">)</span>
		<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">rbd_block</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">diag</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ok</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_monitor</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">FORE200E_CP_MONITOR_OFFSET</span><span class="p">;</span>
    
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">BSTAT_COLD_START</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_monitor</span><span class="o">-&gt;</span><span class="n">bstat</span><span class="p">);</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">ok</span> <span class="o">=</span> <span class="n">fore200e_io_poll</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_monitor</span><span class="o">-&gt;</span><span class="n">bstat</span><span class="p">,</span> <span class="n">BSTAT_SELFTEST_OK</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    
	    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;device %s self-test failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;device %s self-test passed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_RESET</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;removing device %s at 0x%lx, IRQ %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">phys_base</span><span class="p">,</span> 
	   <span class="n">fore200e_irq_itoa</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">FORE200E_STATE_RESET</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* first, reset the board to prevent further interrupts or data transfers */</span>
	<span class="n">fore200e_reset</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="cm">/* then, release all allocated resources */</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_COMPLETE</span>:
	<span class="n">kfree</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_IRQ</span>:
	<span class="n">free_irq</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_ALLOC_BUF</span>:
	<span class="n">fore200e_free_rx_buf</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_INIT_BSQ</span>:
	<span class="n">fore200e_uninit_bs_queue</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_INIT_RXQ</span>:
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_rxq</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_rxq</span><span class="p">.</span><span class="n">rpd</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_INIT_TXQ</span>:
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_txq</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_txq</span><span class="p">.</span><span class="n">tpd</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_INIT_CMDQ</span>:
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_cmdq</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_INITIALIZE</span>:
	<span class="cm">/* nothing to do for that state */</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_START_FW</span>:
	<span class="cm">/* nothing to do for that state */</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_RESET</span>:
	<span class="cm">/* nothing to do for that state */</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_MAP</span>:
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">unmap</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_CONFIGURE</span>:
	<span class="cm">/* nothing to do for that state */</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_REGISTER</span>:
	<span class="cm">/* XXX shouldn&#39;t we *start* by deregistering the device? */</span>
	<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">FORE200E_STATE_BLANK</span>:
	<span class="cm">/* nothing to do for that state */</span>
	<span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PCI</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fore200e_pca_read</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* on big-endian hosts, the board is configured to convert</span>
<span class="cm">       the endianess of slave RAM accesses  */</span>
    <span class="k">return</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_pca_write</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* on big-endian hosts, the board is configured to convert</span>
<span class="cm">       the endianess of slave RAM accesses  */</span>
    <span class="n">writel</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u32</span>
<span class="nf">fore200e_pca_dma_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">((</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span><span class="p">)</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;PCI DVMA mapping: virt_addr = 0x%p, size = %d, direction = %d,  --&gt; dma_addr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">virt_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">dma_addr</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_pca_dma_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;PCI DVMA unmapping: dma_addr = 0x%08x, size = %d, direction = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

    <span class="n">pci_unmap_single</span><span class="p">((</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span><span class="p">)</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_pca_dma_sync_for_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;PCI DVMA sync: dma_addr = 0x%08x, size = %d, direction = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

    <span class="n">pci_dma_sync_single_for_cpu</span><span class="p">((</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span><span class="p">)</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_pca_dma_sync_for_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;PCI DVMA sync: dma_addr = 0x%08x, size = %d, direction = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

    <span class="n">pci_dma_sync_single_for_device</span><span class="p">((</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span><span class="p">)</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* allocate a DMA consistent chunk of memory intended to act as a communication mechanism</span>
<span class="cm">   (to hold descriptors, status, queues, etc.) shared by the driver and the adapter */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_pca_dma_chunk_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chunk</span><span class="o">*</span> <span class="n">chunk</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alignment</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* returned chunks are page-aligned */</span>
    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">nbr</span><span class="p">;</span>
    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">((</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span><span class="p">)</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">,</span>
					     <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">((</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">align_addr</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span><span class="p">;</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* free a DMA consistent chunk of memory */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_pca_dma_chunk_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chunk</span><span class="o">*</span> <span class="n">chunk</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pci_free_consistent</span><span class="p">((</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span><span class="p">)</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">,</span>
			<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">,</span>
			<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span><span class="p">,</span>
			<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_pca_irq_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* this is a 1 bit register */</span>
    <span class="kt">int</span> <span class="n">irq_posted</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">psr</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_ATM_FORE200E_DEBUG) &amp;&amp; (CONFIG_ATM_FORE200E_DEBUG == 2)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">irq_posted</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">hcr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PCA200E_HCR_OUTFULL</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;FIFO OUT full, device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">return</span> <span class="n">irq_posted</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_pca_irq_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">writel</span><span class="p">(</span><span class="n">PCA200E_HCR_CLRINTR</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">hcr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_pca_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">writel</span><span class="p">(</span><span class="n">PCA200E_HCR_RESET</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">hcr</span><span class="p">);</span>
    <span class="n">fore200e_spin</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">hcr</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_pca_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;device %s being mapped in memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">phys_base</span><span class="p">,</span> <span class="n">PCA200E_IOSPACE_LENGTH</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;can&#39;t map device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;device %s mapped to 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span><span class="p">);</span>

    <span class="cm">/* gain access to the PCA specific registers  */</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">hcr</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">PCA200E_HCR_OFFSET</span><span class="p">;</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">imr</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">PCA200E_IMR_OFFSET</span><span class="p">;</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">pca</span><span class="p">.</span><span class="n">psr</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">PCA200E_PSR_OFFSET</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_MAP</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_pca_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;device %s being unmapped from memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_pca_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">pci_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span><span class="p">)</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>
    <span class="n">u8</span>              <span class="n">master_ctrl</span><span class="p">,</span> <span class="n">latency</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;device %s being configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;incorrect IRQ setting - misconfigured PCI-PCI bridge?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCA200E_PCI_MASTER_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">master_ctrl</span><span class="p">);</span>

    <span class="n">master_ctrl</span> <span class="o">=</span> <span class="n">master_ctrl</span>
<span class="cp">#if defined(__BIG_ENDIAN)</span>
	<span class="cm">/* request the PCA board to convert the endianess of slave RAM accesses */</span>
	<span class="o">|</span> <span class="n">PCA200E_CTRL_CONVERT_ENDIAN</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">        | PCA200E_CTRL_DIS_CACHE_RD</span>
<span class="c">        | PCA200E_CTRL_DIS_WRT_INVAL</span>
<span class="c">        | PCA200E_CTRL_ENA_CONT_REQ_MODE</span>
<span class="c">        | PCA200E_CTRL_2_CACHE_WRT_INVAL</span>
<span class="cp">#endif</span>
	<span class="o">|</span> <span class="n">PCA200E_CTRL_LARGE_PCI_BURSTS</span><span class="p">;</span>
    
    <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCA200E_PCI_MASTER_CTRL</span><span class="p">,</span> <span class="n">master_ctrl</span><span class="p">);</span>

    <span class="cm">/* raise latency from 32 (default) to 192, as this seems to prevent NIC</span>
<span class="cm">       lockups (under heavy rx loads) due to continuous &#39;FIFO OUT full&#39; condition.</span>
<span class="cm">       this may impact the performances of other PCI devices on the same bus, though */</span>
    <span class="n">latency</span> <span class="o">=</span> <span class="mi">192</span><span class="p">;</span>
    <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">latency</span><span class="p">);</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_CONFIGURE</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">fore200e_pca_prom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">prom_data</span><span class="o">*</span> <span class="n">prom</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_cmdq</span><span class="o">*</span>       <span class="n">cmdq</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_cmdq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host_cmdq_entry</span><span class="o">*</span> <span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="p">];</span>
    <span class="k">struct</span> <span class="n">prom_opcode</span>      <span class="n">opcode</span><span class="p">;</span>
    <span class="kt">int</span>                     <span class="n">ok</span><span class="p">;</span>
    <span class="n">u32</span>                     <span class="n">prom_dma</span><span class="p">;</span>

    <span class="n">FORE200E_NEXT_ENTRY</span><span class="p">(</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">QUEUE_SIZE_CMD</span><span class="p">);</span>

    <span class="n">opcode</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_GET_PROM</span><span class="p">;</span>
    <span class="n">opcode</span><span class="p">.</span><span class="n">pad</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">prom_dma</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_map</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">prom</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prom_data</span><span class="p">),</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">prom_dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">prom_block</span><span class="p">.</span><span class="n">prom_haddr</span><span class="p">);</span>
    
    <span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_PENDING</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">opcode</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">prom_block</span><span class="p">.</span><span class="n">opcode</span><span class="p">);</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">fore200e_poll</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">STATUS_COMPLETE</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>

    <span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_unmap</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">prom_dma</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prom_data</span><span class="p">),</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;unable to get PROM data from device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#if defined(__BIG_ENDIAN)</span>
    
<span class="cp">#define swap_here(addr) (*((u32*)(addr)) = swab32( *((u32*)(addr)) ))</span>

    <span class="cm">/* MAC address is stored as little-endian */</span>
    <span class="n">swap_here</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prom</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">swap_here</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prom</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="cp">#endif</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_pca_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span> <span class="n">pci_dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span><span class="o">*</span><span class="p">)</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;   PCI bus/slot/function:</span><span class="se">\t</span><span class="s">%d/%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>


<span class="cp">#ifdef CONFIG_SBUS</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fore200e_sba_read</span><span class="p">(</span><span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">sbus_readl</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_sba_write</span><span class="p">(</span><span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="k">volatile</span> <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">sbus_writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fore200e_sba_dma_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_addr</span><span class="p">;</span>

	<span class="n">dma_addr</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">virt_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;SBUS DVMA mapping: virt_addr = 0x%p, size = %d, direction = %d --&gt; dma_addr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">virt_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">);</span>
    
	<span class="k">return</span> <span class="n">dma_addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_sba_dma_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;SBUS DVMA unmapping: dma_addr = 0x%08x, size = %d, direction = %d,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

	<span class="n">dma_unmap_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_sba_dma_sync_for_cpu</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;SBUS DVMA sync: dma_addr = 0x%08x, size = %d, direction = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
    
	<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_sba_dma_sync_for_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;SBUS DVMA sync: dma_addr = 0x%08x, size = %d, direction = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>

	<span class="n">dma_sync_single_for_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">direction</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Allocate a DVMA consistent chunk of memory intended to act as a communication mechanism</span>
<span class="cm"> * (to hold descriptors, status, queues, etc.) shared by the driver and the adapter.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fore200e_sba_dma_chunk_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alignment</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>

	<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_size</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">align_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="n">nbr</span><span class="p">;</span>

	<span class="cm">/* returned chunks are page-aligned */</span>
	<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chunk</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">chunk</span><span class="o">-&gt;</span><span class="n">align_addr</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span><span class="p">;</span>
    
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* free a DVMA consistent chunk of memory */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_sba_dma_chunk_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_size</span><span class="p">,</span>
			  <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">alloc_addr</span><span class="p">,</span> <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_sba_irq_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hcr</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">hcr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBA200E_HCR_STICKY</span><span class="p">;</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">hcr</span> <span class="o">|</span> <span class="n">SBA200E_HCR_INTR_ENA</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">hcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fore200e_sba_irq_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">hcr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBA200E_HCR_INTR_REQ</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_sba_irq_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hcr</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">hcr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SBA200E_HCR_STICKY</span><span class="p">;</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">hcr</span> <span class="o">|</span> <span class="n">SBA200E_HCR_INTR_CLR</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">hcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_sba_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">SBA200E_HCR_RESET</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">hcr</span><span class="p">);</span>
	<span class="n">fore200e_spin</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">hcr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fore200e_sba_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bursts</span><span class="p">;</span>

	<span class="cm">/* gain access to the SBA specific registers  */</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">hcr</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SBA200E_HCR_LENGTH</span><span class="p">,</span> <span class="s">&quot;SBA HCR&quot;</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">bsr</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SBA200E_BSR_LENGTH</span><span class="p">,</span> <span class="s">&quot;SBA BSR&quot;</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">isr</span> <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SBA200E_ISR_LENGTH</span><span class="p">,</span> <span class="s">&quot;SBA ISR&quot;</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span>    <span class="o">=</span> <span class="n">of_ioremap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SBA200E_RAM_LENGTH</span><span class="p">,</span> <span class="s">&quot;SBA RAM&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;unable to map RAM of device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;device %s mapped to 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span><span class="p">);</span>
    
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">isr</span><span class="p">);</span> <span class="cm">/* XXX hardwired interrupt level */</span>

	<span class="cm">/* get the supported DVMA burst sizes */</span>
	<span class="n">bursts</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">,</span> <span class="s">&quot;burst-sizes&quot;</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbus_can_dma_64bit</span><span class="p">())</span>
		<span class="n">sbus_set_sbus64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">bursts</span><span class="p">);</span>

	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_MAP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fore200e_sba_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>

	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">hcr</span><span class="p">,</span> <span class="n">SBA200E_HCR_LENGTH</span><span class="p">);</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">bsr</span><span class="p">,</span> <span class="n">SBA200E_BSR_LENGTH</span><span class="p">);</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sba</span><span class="p">.</span><span class="n">isr</span><span class="p">,</span> <span class="n">SBA200E_ISR_LENGTH</span><span class="p">);</span>
	<span class="n">of_iounmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span><span class="p">,</span>    <span class="n">SBA200E_RAM_LENGTH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fore200e_sba_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_CONFIGURE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fore200e_sba_prom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">prom_data</span> <span class="o">*</span><span class="n">prom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">prop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;madaddrlo2&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prom</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">prop</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">prop</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;madaddrhi4&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prop</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prom</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">prop</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">prom</span><span class="o">-&gt;</span><span class="n">serial_number</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span>
						    <span class="s">&quot;serialnumber&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">prom</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">=</span> <span class="n">of_getintprop_default</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span>
						  <span class="s">&quot;promversion&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fore200e_sba_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">linux_prom_registers</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>

	<span class="n">regs</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;   SBUS slot/device:</span><span class="se">\t\t</span><span class="s">%d/&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">regs</span> <span class="o">?</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">which_io</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_SBUS */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_tx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_txq</span><span class="o">*</span>        <span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_txq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host_txq_entry</span><span class="o">*</span>  <span class="n">entry</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span>         <span class="n">vcc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">fore200e_vc_map</span><span class="o">*</span> <span class="n">vc_map</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_txq</span><span class="p">.</span><span class="n">txing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
	
	<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="p">];</span>

        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;TX COMPLETED: entry = %p [tail = %d], vc_map = %p, skb = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		<span class="n">entry</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">vc_map</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* free copy of misaligned data */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	
	<span class="cm">/* remove DMA mapping */</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_unmap</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">tsd</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="n">buffer</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">tpd</span><span class="o">-&gt;</span><span class="n">tsd</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="n">length</span><span class="p">,</span>
				 <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

	<span class="n">vc_map</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">vc_map</span><span class="p">;</span>

	<span class="cm">/* vcc closed since the time the entry was submitted for tx? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

	    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;no ready vcc found for PDU sent on device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	    <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
	    <span class="n">ASSERT</span><span class="p">(</span><span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">);</span>

	    <span class="cm">/* vcc closed then immediately re-opened? */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">incarn</span> <span class="o">!=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">incarn</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* when a vcc is closed, some PDUs may be still pending in the tx queue.</span>
<span class="cm">		   if the same vcc is immediately re-opened, those pending PDUs must</span>
<span class="cm">		   not be popped after the completion of their emission, as they refer</span>
<span class="cm">		   to the prior incarnation of that vcc. otherwise, sk_atm(vcc)-&gt;sk_wmem_alloc</span>
<span class="cm">		   would be decremented by the size of the (unrelated) skb, possibly</span>
<span class="cm">		   leading to a negative sk-&gt;sk_wmem_alloc count, ultimately freezing the vcc.</span>
<span class="cm">		   we thus bind the tx entry to the current incarnation of the vcc</span>
<span class="cm">		   when the entry is submitted for tx. When the tx later completes,</span>
<span class="cm">		   if the incarnation number of the tx entry does not match the one</span>
<span class="cm">		   of the vcc, then this implies that the vcc has been closed then re-opened.</span>
<span class="cm">		   we thus just drop the skb here. */</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;vcc closed-then-re-opened; dropping PDU sent on device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="p">{</span>
		<span class="n">vcc</span> <span class="o">=</span> <span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>

		<span class="cm">/* notify tx completion */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
		    <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#if 1</span>
		<span class="cm">/* race fixed by the above incarnation mechanism, but... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		    <span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="cm">/* check error condition */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ERROR</span><span class="p">)</span>
		    <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="k">else</span>
		    <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>

	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_txq</span><span class="p">.</span><span class="n">txing</span><span class="o">--</span><span class="p">;</span>

	<span class="n">FORE200E_NEXT_ENTRY</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">,</span> <span class="n">QUEUE_SIZE_TX</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cp">#ifdef FORE200E_BSQ_DEBUG</span>
<span class="kt">int</span> <span class="nf">bsq_audit</span><span class="p">(</span><span class="kt">int</span> <span class="n">where</span><span class="p">,</span> <span class="k">struct</span> <span class="n">host_bsq</span><span class="o">*</span> <span class="n">bsq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scheme</span><span class="p">,</span> <span class="kt">int</span> <span class="n">magn</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">buffer</span><span class="o">*</span> <span class="n">buffer</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">buffer</span> <span class="o">=</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">supplied</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;bsq_audit(%d): queue %d.%d, buffer %ld supplied but in free list!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">where</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">magn</span> <span class="o">!=</span> <span class="n">magn</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;bsq_audit(%d): queue %d.%d, buffer %ld, unexpected magn = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">where</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">magn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">scheme</span> <span class="o">!=</span> <span class="n">scheme</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;bsq_audit(%d): queue %d.%d, buffer %ld, unexpected scheme = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">where</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">scheme</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">fore200e_rx_buf_nbr</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">]))</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;bsq_audit(%d): queue %d.%d, out of range buffer index = %ld !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">where</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf_count</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;bsq_audit(%d): queue %d.%d, %d bufs in free list, but freebuf_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">where</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf_count</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_supply</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span>  <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">host_bsq</span><span class="o">*</span>       <span class="n">bsq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host_bsq_entry</span><span class="o">*</span> <span class="n">entry</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">buffer</span><span class="o">*</span>         <span class="n">buffer</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scheme</span> <span class="o">&lt;</span> <span class="n">BUFFER_SCHEME_NBR</span><span class="p">;</span> <span class="n">scheme</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">magn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">magn</span> <span class="o">&lt;</span> <span class="n">BUFFER_MAGN_NBR</span><span class="p">;</span> <span class="n">magn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	    <span class="n">bsq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">];</span>

<span class="cp">#ifdef FORE200E_BSQ_DEBUG</span>
	    <span class="n">bsq_audit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bsq</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">);</span>
<span class="cp">#endif</span>
	    <span class="k">while</span> <span class="p">(</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf_count</span> <span class="o">&gt;=</span> <span class="n">RBD_BLK_SIZE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;supplying %d rx buffers to queue %d / %d, freebuf_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">RBD_BLK_SIZE</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf_count</span><span class="p">);</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RBD_BLK_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		    <span class="cm">/* take the first buffer in the free buffer list */</span>
		    <span class="n">buffer</span> <span class="o">=</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf</span><span class="p">;</span>
		    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;no more free bufs in queue %d.%d, but freebuf_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf_count</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		    <span class="p">}</span>
		    <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		    
<span class="cp">#ifdef FORE200E_BSQ_DEBUG</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">supplied</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;queue %d.%d, buffer %lu already supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		    <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">supplied</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rbd_block</span><span class="o">-&gt;</span><span class="n">rbd</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">buffer_haddr</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">;</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rbd_block</span><span class="o">-&gt;</span><span class="n">rbd</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">handle</span>       <span class="o">=</span> <span class="n">FORE200E_BUF2HDL</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">FORE200E_NEXT_ENTRY</span><span class="p">(</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">QUEUE_SIZE_BS</span><span class="p">);</span>

 		<span class="cm">/* decrease accordingly the number of free rx buffers */</span>
		<span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf_count</span> <span class="o">-=</span> <span class="n">RBD_BLK_SIZE</span><span class="p">;</span>

		<span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_PENDING</span><span class="p">;</span>
		<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">rbd_block_dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">rbd_block_haddr</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_push_rpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span> <span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpd</span><span class="o">*</span> <span class="n">rpd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span>      <span class="n">skb</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">buffer</span><span class="o">*</span>       <span class="n">buffer</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">fore200e_vcc</span><span class="o">*</span> <span class="n">fore200e_vcc</span><span class="p">;</span>
    <span class="kt">int</span>                  <span class="n">i</span><span class="p">,</span> <span class="n">pdu_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef FORE200E_52BYTE_AAL0_SDU</span>
    <span class="n">u32</span>                  <span class="n">cell_header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
    
    <span class="n">fore200e_vcc</span> <span class="o">=</span> <span class="n">FORE200E_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">fore200e_vcc</span><span class="p">);</span>

<span class="cp">#ifdef FORE200E_52BYTE_AAL0_SDU</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">==</span> <span class="n">ATM_AAL0_SDU</span><span class="p">))</span> <span class="p">{</span>

	<span class="n">cell_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">gfc</span> <span class="o">&lt;&lt;</span> <span class="n">ATM_HDR_GFC_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	              <span class="p">(</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="n">ATM_HDR_VPI_SHIFT</span><span class="p">)</span> <span class="o">|</span>
                      <span class="p">(</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="n">ATM_HDR_VCI_SHIFT</span><span class="p">)</span> <span class="o">|</span>
                      <span class="p">(</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">plt</span> <span class="o">&lt;&lt;</span> <span class="n">ATM_HDR_PTI_SHIFT</span><span class="p">)</span> <span class="o">|</span> 
                       <span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">clp</span><span class="p">;</span>
	<span class="n">pdu_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif</span>
    
    <span class="cm">/* compute total PDU length */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rpd</span><span class="o">-&gt;</span><span class="n">nseg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="n">pdu_len</span> <span class="o">+=</span> <span class="n">rpd</span><span class="o">-&gt;</span><span class="n">rsd</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">length</span><span class="p">;</span>
    
    <span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">pdu_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;unable to alloc new skb, rx PDU length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdu_len</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span> 

    <span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
    
<span class="cp">#ifdef FORE200E_52BYTE_AAL0_SDU</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cell_header</span><span class="p">)</span> <span class="p">{</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="n">cell_header</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="cm">/* reassemble segments */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rpd</span><span class="o">-&gt;</span><span class="n">nseg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="cm">/* rebuild rx buffer address from rsd handle */</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">FORE200E_HDL2BUF</span><span class="p">(</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">rsd</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">handle</span><span class="p">);</span>
	
	<span class="cm">/* Make device DMA transfer visible to CPU.  */</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_sync_for_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">rpd</span><span class="o">-&gt;</span><span class="n">rsd</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rpd</span><span class="o">-&gt;</span><span class="n">rsd</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">length</span><span class="p">),</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">align_addr</span><span class="p">,</span> <span class="n">rpd</span><span class="o">-&gt;</span><span class="n">rsd</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">length</span><span class="p">);</span>

	<span class="cm">/* Now let the device get at it again.  */</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_sync_for_device</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="n">rpd</span><span class="o">-&gt;</span><span class="n">rsd</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;rx skb: len = %d, truesize = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">pdu_len</span> <span class="o">&lt;</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_min_pdu</span><span class="p">)</span>
	<span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_min_pdu</span> <span class="o">=</span> <span class="n">pdu_len</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pdu_len</span> <span class="o">&gt;</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_max_pdu</span><span class="p">)</span>
	<span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_max_pdu</span> <span class="o">=</span> <span class="n">pdu_len</span><span class="p">;</span>
    <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_pdu</span><span class="o">++</span><span class="p">;</span>

    <span class="cm">/* push PDU */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;receive buffers saturated for %d.%d.%d - PDU dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
    <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_collect_rpd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpd</span><span class="o">*</span> <span class="n">rpd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_bsq</span><span class="o">*</span> <span class="n">bsq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">buffer</span><span class="o">*</span>   <span class="n">buffer</span><span class="p">;</span>
    <span class="kt">int</span>              <span class="n">i</span><span class="p">;</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rpd</span><span class="o">-&gt;</span><span class="n">nseg</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	<span class="cm">/* rebuild rx buffer address from rsd handle */</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">FORE200E_HDL2BUF</span><span class="p">(</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">rsd</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">handle</span><span class="p">);</span>

	<span class="n">bsq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">scheme</span> <span class="p">][</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">magn</span> <span class="p">];</span>

<span class="cp">#ifdef FORE200E_BSQ_DEBUG</span>
	<span class="n">bsq_audit</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">bsq</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">scheme</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">magn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">-&gt;</span><span class="n">supplied</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;queue %d.%d, buffer %ld was not supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">scheme</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">magn</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">supplied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* re-insert the buffer into the free buffer list */</span>
	<span class="n">buffer</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf</span><span class="p">;</span>
	<span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="cm">/* then increment the number of free rx buffers */</span>
	<span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf_count</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_rxq</span><span class="o">*</span>        <span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_rxq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host_rxq_entry</span><span class="o">*</span>  <span class="n">entry</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span>         <span class="n">vcc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">fore200e_vc_map</span><span class="o">*</span> <span class="n">vc_map</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
	
	<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="p">];</span>

	<span class="cm">/* no more received PDUs */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_COMPLETE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="n">vc_map</span> <span class="o">=</span> <span class="n">FORE200E_VC_MAP</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vpi</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vci</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

	    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;no ready VC found for PDU received on %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vpi</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vci</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
	    <span class="n">vcc</span> <span class="o">=</span> <span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
	    <span class="n">ASSERT</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>

	    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_ERROR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">fore200e_push_rpd</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;damaged PDU on %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vpi</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vci</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>

	<span class="n">FORE200E_NEXT_ENTRY</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">QUEUE_SIZE_RX</span><span class="p">);</span>

	<span class="n">fore200e_collect_rpd</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="p">);</span>

	<span class="cm">/* rewrite the rpd address to ack the received PDU */</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">rpd_dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">rpd_haddr</span><span class="p">);</span>
	<span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>

	<span class="n">fore200e_supply</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="cp">#ifndef FORE200E_USE_TASKLET</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">fore200e_rx_irq</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">fore200e_tx_irq</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">fore200e_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span> <span class="o">=</span> <span class="n">FORE200E_DEV</span><span class="p">((</span><span class="k">struct</span> <span class="n">atm_dev</span><span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">irq_check</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;interrupt NOT triggered by device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;interrupt triggered by device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

<span class="cp">#ifdef FORE200E_USE_TASKLET</span>
    <span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">tx_tasklet</span><span class="p">);</span>
    <span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>
<span class="cp">#else</span>
    <span class="n">fore200e_irq</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
<span class="cp">#endif</span>
    
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">irq_ack</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef FORE200E_USE_TASKLET</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_tx_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;tx tasklet scheduled for device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">fore200e_tx_irq</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_rx_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>    <span class="n">flags</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;rx tasklet scheduled for device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="n">fore200e_rx_irq</span><span class="p">((</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_select_scheme</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span> <span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* fairly balance the VCs over (identical) buffer schemes */</span>
    <span class="kt">int</span> <span class="n">scheme</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">?</span> <span class="n">BUFFER_SCHEME_ONE</span> <span class="o">:</span> <span class="n">BUFFER_SCHEME_TWO</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;VC %d.%d.%d uses buffer scheme %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">scheme</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">scheme</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> 
<span class="nf">fore200e_activate_vcin</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">activate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span> <span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mtu</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_cmdq</span><span class="o">*</span>        <span class="n">cmdq</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_cmdq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host_cmdq_entry</span><span class="o">*</span>  <span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="p">];</span>
    <span class="k">struct</span> <span class="n">activate_opcode</span>   <span class="n">activ_opcode</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">deactivate_opcode</span> <span class="n">deactiv_opcode</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">vpvc</span>              <span class="n">vpvc</span><span class="p">;</span>
    <span class="kt">int</span>                      <span class="n">ok</span><span class="p">;</span>
    <span class="k">enum</span> <span class="n">fore200e_aal</span>        <span class="n">aal</span> <span class="o">=</span> <span class="n">fore200e_atm2fore_aal</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">);</span>

    <span class="n">FORE200E_NEXT_ENTRY</span><span class="p">(</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">QUEUE_SIZE_CMD</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">activate</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">FORE200E_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">fore200e_select_scheme</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	
	<span class="n">activ_opcode</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_ACTIVATE_VCIN</span><span class="p">;</span>
	<span class="n">activ_opcode</span><span class="p">.</span><span class="n">aal</span>    <span class="o">=</span> <span class="n">aal</span><span class="p">;</span>
	<span class="n">activ_opcode</span><span class="p">.</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">FORE200E_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scheme</span><span class="p">;</span>
	<span class="n">activ_opcode</span><span class="p">.</span><span class="n">pad</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="n">deactiv_opcode</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_DEACTIVATE_VCIN</span><span class="p">;</span>
	<span class="n">deactiv_opcode</span><span class="p">.</span><span class="n">pad</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">vpvc</span><span class="p">.</span><span class="n">vci</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
    <span class="n">vpvc</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>

    <span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_PENDING</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">activate</span><span class="p">)</span> <span class="p">{</span>

<span class="cp">#ifdef FORE200E_52BYTE_AAL0_SDU</span>
	<span class="n">mtu</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="cm">/* the MTU is not used by the cp, except in the case of AAL0 */</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">mtu</span><span class="p">,</span>                        <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">activate_block</span><span class="p">.</span><span class="n">mtu</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vpvc</span><span class="p">,</span>         <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">activate_block</span><span class="p">.</span><span class="n">vpvc</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">activ_opcode</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">activate_block</span><span class="p">.</span><span class="n">opcode</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vpvc</span><span class="p">,</span>         <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">deactivate_block</span><span class="p">.</span><span class="n">vpvc</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">deactiv_opcode</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">deactivate_block</span><span class="p">.</span><span class="n">opcode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">fore200e_poll</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">STATUS_COMPLETE</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>

    <span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;unable to %s VC %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">activate</span> <span class="o">?</span> <span class="s">&quot;open&quot;</span> <span class="o">:</span> <span class="s">&quot;close&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;VC %d.%d.%d %sed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> 
	    <span class="n">activate</span> <span class="o">?</span> <span class="s">&quot;open&quot;</span> <span class="o">:</span> <span class="s">&quot;clos&quot;</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define FORE200E_MAX_BACK2BACK_CELLS 255    </span><span class="cm">/* XXX depends on CDVT */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_rate_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_qos</span><span class="o">*</span> <span class="n">qos</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tpd_rate</span><span class="o">*</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&lt;</span> <span class="n">ATM_OC3_PCR</span><span class="p">)</span> <span class="p">{</span>
    
	<span class="cm">/* compute the data cells to idle cells ratio from the tx PCR */</span>
	<span class="n">rate</span><span class="o">-&gt;</span><span class="n">data_cells</span> <span class="o">=</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">*</span> <span class="n">FORE200E_MAX_BACK2BACK_CELLS</span> <span class="o">/</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>
	<span class="n">rate</span><span class="o">-&gt;</span><span class="n">idle_cells</span> <span class="o">=</span> <span class="n">FORE200E_MAX_BACK2BACK_CELLS</span> <span class="o">-</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">data_cells</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* disable rate control */</span>
	<span class="n">rate</span><span class="o">-&gt;</span><span class="n">data_cells</span> <span class="o">=</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">idle_cells</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span>        <span class="n">fore200e</span> <span class="o">=</span> <span class="n">FORE200E_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">fore200e_vcc</span><span class="o">*</span>    <span class="n">fore200e_vcc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">fore200e_vc_map</span><span class="o">*</span> <span class="n">vc_map</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>	    <span class="n">flags</span><span class="p">;</span>
    <span class="kt">int</span>			    <span class="n">vci</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
    <span class="kt">short</span>		    <span class="n">vpi</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>

    <span class="n">ASSERT</span><span class="p">((</span><span class="n">vpi</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">FORE200E_VPI_BITS</span><span class="p">));</span>
    <span class="n">ASSERT</span><span class="p">((</span><span class="n">vci</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vci</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">FORE200E_VCI_BITS</span><span class="p">));</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="n">vc_map</span> <span class="o">=</span> <span class="n">FORE200E_VC_MAP</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;VC %d.%d.%d already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>

    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="n">fore200e_vcc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e_vcc</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_vcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;opening %d.%d.%d:%d QoS = (tx: cl=%s, pcr=%d-%d, cdv=%d, max_sdu=%d; &quot;</span>
	    <span class="s">&quot;rx: cl=%s, pcr=%d-%d, cdv=%d, max_sdu=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">fore200e_atm2fore_aal</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">),</span>
	    <span class="n">fore200e_traffic_class</span><span class="p">[</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="p">],</span>
	    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_cdv</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">,</span>
	    <span class="n">fore200e_traffic_class</span><span class="p">[</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="p">],</span>
	    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_cdv</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">);</span>
    
    <span class="cm">/* pseudo-CBR bandwidth requested? */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
	
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rate_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">available_cell_rate</span> <span class="o">&lt;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rate_mtx</span><span class="p">);</span>

	    <span class="n">kfree</span><span class="p">(</span><span class="n">fore200e_vcc</span><span class="p">);</span>
	    <span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reserve bandwidth */</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">available_cell_rate</span> <span class="o">-=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rate_mtx</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

    <span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
    <span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">fore200e_vcc</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_activate_vcin</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">available_cell_rate</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fore200e_vcc</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="cm">/* compute rate control parameters */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
	
	<span class="n">fore200e_rate_ctrl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_HASQOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;tx on %d.%d.%d:%d, tx PCR = %d, rx PCR = %d, data_cells = %u, idle_cells = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">fore200e_atm2fore_aal</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">),</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span> 
		<span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">.</span><span class="n">data_cells</span><span class="p">,</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">.</span><span class="n">idle_cells</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_min_pdu</span> <span class="o">=</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_min_pdu</span> <span class="o">=</span> <span class="n">MAX_PDU_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_max_pdu</span> <span class="o">=</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_max_pdu</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_pdu</span>     <span class="o">=</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_pdu</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* new incarnation of the vcc */</span>
    <span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">incarn</span> <span class="o">=</span> <span class="o">++</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">incarn_count</span><span class="p">;</span>

    <span class="cm">/* VC unusable before this flag is set */</span>
    <span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fore200e_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span> <span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span>        <span class="n">fore200e</span> <span class="o">=</span> <span class="n">FORE200E_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">fore200e_vcc</span><span class="o">*</span>    <span class="n">fore200e_vcc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">fore200e_vc_map</span><span class="o">*</span> <span class="n">vc_map</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>           <span class="n">flags</span><span class="p">;</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
    <span class="n">ASSERT</span><span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">FORE200E_VPI_BITS</span><span class="p">));</span>
    <span class="n">ASSERT</span><span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">FORE200E_VCI_BITS</span><span class="p">));</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;closing %d.%d.%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">fore200e_atm2fore_aal</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">));</span>

    <span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

    <span class="n">fore200e_activate_vcin</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="n">vc_map</span> <span class="o">=</span> <span class="n">FORE200E_VC_MAP</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>

    <span class="cm">/* the vc is no longer considered as &quot;in use&quot; by fore200e_open() */</span>
    <span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">fore200e_vcc</span> <span class="o">=</span> <span class="n">FORE200E_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="cm">/* release reserved bandwidth, if any */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rate_mtx</span><span class="p">);</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">available_cell_rate</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rate_mtx</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_HASQOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
    <span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">fore200e_vcc</span><span class="p">);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">fore200e_vcc</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span>        <span class="n">fore200e</span>     <span class="o">=</span> <span class="n">FORE200E_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">fore200e_vcc</span><span class="o">*</span>    <span class="n">fore200e_vcc</span> <span class="o">=</span> <span class="n">FORE200E_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">fore200e_vc_map</span><span class="o">*</span> <span class="n">vc_map</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host_txq</span><span class="o">*</span>        <span class="n">txq</span>          <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_txq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host_txq_entry</span><span class="o">*</span>  <span class="n">entry</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">tpd</span><span class="o">*</span>             <span class="n">tpd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">tpd_haddr</span>        <span class="n">tpd_haddr</span><span class="p">;</span>
    <span class="kt">int</span>                     <span class="n">retry</span>        <span class="o">=</span> <span class="n">CONFIG_ATM_FORE200E_TX_RETRY</span><span class="p">;</span>
    <span class="kt">int</span>                     <span class="n">tx_copy</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span>                     <span class="n">tx_len</span>       <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
    <span class="n">u32</span><span class="o">*</span>                    <span class="n">cell_header</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span>          <span class="n">skb_data</span><span class="p">;</span>
    <span class="kt">int</span>                     <span class="n">skb_len</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span>          <span class="n">data</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>           <span class="n">flags</span><span class="p">;</span>

    <span class="n">ASSERT</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sk_wmem_alloc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">fore200e_vcc</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;VC %d.%d.%d not ready for tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cp">#ifdef FORE200E_52BYTE_AAL0_SDU</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">==</span> <span class="n">ATM_AAL0_SDU</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">cell_header</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">skb_data</span>    <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>    <span class="cm">/* skip 4-byte cell header */</span>
	<span class="n">skb_len</span>     <span class="o">=</span> <span class="n">tx_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span>  <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;user-supplied cell header = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">cell_header</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> 
<span class="cp">#endif</span>
    <span class="p">{</span>
	<span class="n">skb_data</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">skb_len</span>  <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb_data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;misaligned tx PDU on device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">tx_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tx_len</span>  <span class="o">=</span> <span class="n">skb_len</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb_len</span> <span class="o">%</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">))</span> <span class="p">{</span>

        <span class="cm">/* this simply NUKES the PCA board */</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;incomplete tx AAL0 PDU on device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">tx_copy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tx_len</span>  <span class="o">=</span> <span class="p">((</span><span class="n">skb_len</span> <span class="o">/</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">tx_copy</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">tx_len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">skb_data</span><span class="p">,</span> <span class="n">skb_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_len</span> <span class="o">&lt;</span> <span class="n">tx_len</span><span class="p">)</span>
	    <span class="n">memset</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">skb_len</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">tx_len</span> <span class="o">-</span> <span class="n">skb_len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">skb_data</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">vc_map</span> <span class="o">=</span> <span class="n">FORE200E_VC_MAP</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
    <span class="n">ASSERT</span><span class="p">(</span><span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">==</span> <span class="n">vcc</span><span class="p">);</span>

  <span class="nl">retry_here:</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="p">];</span>

    <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_FREE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">txing</span> <span class="o">&gt;=</span> <span class="n">QUEUE_SIZE_TX</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>

	<span class="cm">/* try to free completed tx queue entries */</span>
	<span class="n">fore200e_tx_irq</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="n">STATUS_FREE</span><span class="p">)</span> <span class="p">{</span>

	    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	    <span class="cm">/* retry once again? */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">retry</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">retry_here</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>

	    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">tx_sat</span><span class="o">++</span><span class="p">;</span>
	    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;tx queue of device %s is saturated, PDU dropped - heartbeat is %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">heartbeat</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	    <span class="p">}</span>
	    <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">tx_copy</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	    <span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">incarn</span> <span class="o">=</span> <span class="n">vc_map</span><span class="o">-&gt;</span><span class="n">incarn</span><span class="p">;</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">vc_map</span> <span class="o">=</span> <span class="n">vc_map</span><span class="p">;</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span>    <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span>   <span class="o">=</span> <span class="n">tx_copy</span> <span class="o">?</span> <span class="n">data</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="n">tpd</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">tpd</span><span class="p">;</span>
    <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">tsd</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_map</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tx_len</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
    <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">tsd</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">tx_len</span><span class="p">;</span>

    <span class="n">FORE200E_NEXT_ENTRY</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">QUEUE_SIZE_TX</span><span class="p">);</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">txing</span><span class="o">++</span><span class="p">;</span>

    <span class="cm">/* The dma_map call above implies a dma_sync so the device can use it,</span>
<span class="cm">     * thus no explicit dma_sync call is necessary here.</span>
<span class="cm">     */</span>
    
    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s">&quot;tx on %d.%d.%d:%d, len = %u (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
	    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">fore200e_atm2fore_aal</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">),</span>
	    <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">tsd</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span><span class="p">,</span> <span class="n">skb_len</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">skb_len</span> <span class="o">&lt;</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_min_pdu</span><span class="p">)</span>
	<span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_min_pdu</span> <span class="o">=</span> <span class="n">skb_len</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">skb_len</span> <span class="o">&gt;</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_max_pdu</span><span class="p">)</span>
	<span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_max_pdu</span> <span class="o">=</span> <span class="n">skb_len</span><span class="p">;</span>
    <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_pdu</span><span class="o">++</span><span class="p">;</span>

    <span class="cm">/* set tx rate control information */</span>
    <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">.</span><span class="n">data_cells</span> <span class="o">=</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">.</span><span class="n">data_cells</span><span class="p">;</span>
    <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">.</span><span class="n">idle_cells</span> <span class="o">=</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">.</span><span class="n">idle_cells</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">cell_header</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">clp</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cell_header</span> <span class="o">&amp;</span> <span class="n">ATM_HDR_CLP</span><span class="p">);</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">plt</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cell_header</span> <span class="o">&amp;</span> <span class="n">ATM_HDR_PTI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ATM_HDR_PTI_SHIFT</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vci</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cell_header</span> <span class="o">&amp;</span> <span class="n">ATM_HDR_VCI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ATM_HDR_VCI_SHIFT</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cell_header</span> <span class="o">&amp;</span> <span class="n">ATM_HDR_VPI_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ATM_HDR_VPI_SHIFT</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">gfc</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">cell_header</span> <span class="o">&amp;</span> <span class="n">ATM_HDR_GFC_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">ATM_HDR_GFC_SHIFT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* set the ATM header, common to all cells conveying the PDU */</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">clp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">plt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vci</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">vpi</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>
	<span class="n">tpd</span><span class="o">-&gt;</span><span class="n">atm_header</span><span class="p">.</span><span class="n">gfc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">tx_len</span><span class="p">;</span>
    <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">nseg</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">aal</span>    <span class="o">=</span> <span class="n">fore200e_atm2fore_aal</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">);</span>
    <span class="n">tpd</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">.</span><span class="n">intr</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">tpd_haddr</span><span class="p">.</span><span class="n">size</span>  <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpd</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">TPD_HADDR_SHIFT</span><span class="p">);</span>  <span class="cm">/* size is expressed in 32 byte blocks */</span>
    <span class="n">tpd_haddr</span><span class="p">.</span><span class="n">pad</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">tpd_haddr</span><span class="p">.</span><span class="n">haddr</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">tpd_dma</span> <span class="o">&gt;&gt;</span> <span class="n">TPD_HADDR_SHIFT</span><span class="p">;</span>          <span class="cm">/* shift the address, as we are in a bitfield */</span>

    <span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_PENDING</span><span class="p">;</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tpd_haddr</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">tpd_haddr</span><span class="p">);</span>

    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_getstats</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_cmdq</span><span class="o">*</span>       <span class="n">cmdq</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_cmdq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host_cmdq_entry</span><span class="o">*</span> <span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="p">];</span>
    <span class="k">struct</span> <span class="n">stats_opcode</span>     <span class="n">opcode</span><span class="p">;</span>
    <span class="kt">int</span>                     <span class="n">ok</span><span class="p">;</span>
    <span class="n">u32</span>                     <span class="n">stats_dma_addr</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stats</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">stats_dma_addr</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_map</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stats</span><span class="p">),</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
    
    <span class="n">FORE200E_NEXT_ENTRY</span><span class="p">(</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">QUEUE_SIZE_CMD</span><span class="p">);</span>

    <span class="n">opcode</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_GET_STATS</span><span class="p">;</span>
    <span class="n">opcode</span><span class="p">.</span><span class="n">pad</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">stats_dma_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">stats_block</span><span class="p">.</span><span class="n">stats_haddr</span><span class="p">);</span>
    
    <span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_PENDING</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">opcode</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">stats_block</span><span class="p">.</span><span class="n">opcode</span><span class="p">);</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">fore200e_poll</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">STATUS_COMPLETE</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>

    <span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_unmap</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">stats_dma_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">stats</span><span class="p">),</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;unable to get statistics from device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span> <span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* struct fore200e* fore200e = FORE200E_DEV(vcc-&gt;dev); */</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;getsockopt %d.%d.%d, level = %d, optname = 0x%x, optval = 0x%p, optlen = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span> <span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* struct fore200e* fore200e = FORE200E_DEV(vcc-&gt;dev); */</span>
    
    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;setsockopt %d.%d.%d, level = %d, optname = 0x%x, optval = 0x%p, optlen = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">optname</span><span class="p">,</span> <span class="n">optval</span><span class="p">,</span> <span class="n">optlen</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#if 0</span><span class="c"> /* currently unused */</span>
<span class="c">static int</span>
<span class="c">fore200e_get_oc3(struct fore200e* fore200e, struct oc3_regs* regs)</span>
<span class="c">{</span>
<span class="c">    struct host_cmdq*       cmdq  = &amp;fore200e-&gt;host_cmdq;</span>
<span class="c">    struct host_cmdq_entry* entry = &amp;cmdq-&gt;host_entry[ cmdq-&gt;head ];</span>
<span class="c">    struct oc3_opcode       opcode;</span>
<span class="c">    int                     ok;</span>
<span class="c">    u32                     oc3_regs_dma_addr;</span>

<span class="c">    oc3_regs_dma_addr = fore200e-&gt;bus-&gt;dma_map(fore200e, regs, sizeof(struct oc3_regs), DMA_FROM_DEVICE);</span>

<span class="c">    FORE200E_NEXT_ENTRY(cmdq-&gt;head, QUEUE_SIZE_CMD);</span>

<span class="c">    opcode.opcode = OPCODE_GET_OC3;</span>
<span class="c">    opcode.reg    = 0;</span>
<span class="c">    opcode.value  = 0;</span>
<span class="c">    opcode.mask   = 0;</span>

<span class="c">    fore200e-&gt;bus-&gt;write(oc3_regs_dma_addr, &amp;entry-&gt;cp_entry-&gt;cmd.oc3_block.regs_haddr);</span>
<span class="c">    </span>
<span class="c">    *entry-&gt;status = STATUS_PENDING;</span>

<span class="c">    fore200e-&gt;bus-&gt;write(*(u32*)&amp;opcode, (u32*)&amp;entry-&gt;cp_entry-&gt;cmd.oc3_block.opcode);</span>

<span class="c">    ok = fore200e_poll(fore200e, entry-&gt;status, STATUS_COMPLETE, 400);</span>

<span class="c">    *entry-&gt;status = STATUS_FREE;</span>

<span class="c">    fore200e-&gt;bus-&gt;dma_unmap(fore200e, oc3_regs_dma_addr, sizeof(struct oc3_regs), DMA_FROM_DEVICE);</span>
<span class="c">    </span>
<span class="c">    if (ok == 0) {</span>
<span class="c">	printk(FORE200E &quot;unable to get OC-3 regs of device %s\n&quot;, fore200e-&gt;name);</span>
<span class="c">	return -EIO;</span>
<span class="c">    }</span>

<span class="c">    return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_set_oc3</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_cmdq</span><span class="o">*</span>       <span class="n">cmdq</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_cmdq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">host_cmdq_entry</span><span class="o">*</span> <span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="p">];</span>
    <span class="k">struct</span> <span class="n">oc3_opcode</span>       <span class="n">opcode</span><span class="p">;</span>
    <span class="kt">int</span>                     <span class="n">ok</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;set OC-3 reg = 0x%02x, value = 0x%02x, mask = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>

    <span class="n">FORE200E_NEXT_ENTRY</span><span class="p">(</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">QUEUE_SIZE_CMD</span><span class="p">);</span>

    <span class="n">opcode</span><span class="p">.</span><span class="n">opcode</span> <span class="o">=</span> <span class="n">OPCODE_SET_OC3</span><span class="p">;</span>
    <span class="n">opcode</span><span class="p">.</span><span class="n">reg</span>    <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
    <span class="n">opcode</span><span class="p">.</span><span class="n">value</span>  <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">opcode</span><span class="p">.</span><span class="n">mask</span>   <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">oc3_block</span><span class="p">.</span><span class="n">regs_haddr</span><span class="p">);</span>
    
    <span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_PENDING</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">opcode</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cp_entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">oc3_block</span><span class="p">.</span><span class="n">opcode</span><span class="p">);</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">fore200e_poll</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">STATUS_COMPLETE</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>

    <span class="o">*</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;unable to set OC-3 reg 0x%02x of device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_setloop</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop_mode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u32</span> <span class="n">mct_value</span><span class="p">,</span> <span class="n">mct_mask</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
    
    <span class="k">switch</span> <span class="p">(</span><span class="n">loop_mode</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">case</span> <span class="n">ATM_LM_NONE</span>:
	<span class="n">mct_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
	<span class="n">mct_mask</span>  <span class="o">=</span> <span class="n">SUNI_MCT_DLE</span> <span class="o">|</span> <span class="n">SUNI_MCT_LLE</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
	
    <span class="k">case</span> <span class="n">ATM_LM_LOC_PHY</span>:
	<span class="n">mct_value</span> <span class="o">=</span> <span class="n">mct_mask</span> <span class="o">=</span> <span class="n">SUNI_MCT_DLE</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">ATM_LM_RMT_PHY</span>:
	<span class="n">mct_value</span> <span class="o">=</span> <span class="n">mct_mask</span> <span class="o">=</span> <span class="n">SUNI_MCT_LLE</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">error</span> <span class="o">=</span> <span class="n">fore200e_set_oc3</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">SUNI_MCT</span><span class="p">,</span> <span class="n">mct_value</span><span class="p">,</span> <span class="n">mct_mask</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">loop_mode</span> <span class="o">=</span> <span class="n">loop_mode</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_fetch_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sonet_stats</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">sonet_stats</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_getstats</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

    <span class="n">tmp</span><span class="p">.</span><span class="n">section_bip</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">section_bip8_errors</span><span class="p">);</span>
    <span class="n">tmp</span><span class="p">.</span><span class="n">line_bip</span>    <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">line_bip24_errors</span><span class="p">);</span>
    <span class="n">tmp</span><span class="p">.</span><span class="n">path_bip</span>    <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">path_bip8_errors</span><span class="p">);</span>
    <span class="n">tmp</span><span class="p">.</span><span class="n">line_febe</span>   <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">line_febe_errors</span><span class="p">);</span>
    <span class="n">tmp</span><span class="p">.</span><span class="n">path_febe</span>   <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">path_febe_errors</span><span class="p">);</span>
    <span class="n">tmp</span><span class="p">.</span><span class="n">corr_hcs</span>    <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">corr_hcs_errors</span><span class="p">);</span>
    <span class="n">tmp</span><span class="p">.</span><span class="n">uncorr_hcs</span>  <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">ucorr_hcs_errors</span><span class="p">);</span>
    <span class="n">tmp</span><span class="p">.</span><span class="n">tx_cells</span>    <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal0</span><span class="p">.</span><span class="n">cells_transmitted</span><span class="p">)</span>  <span class="o">+</span>
	              <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cells_transmitted</span><span class="p">)</span> <span class="o">+</span>
	              <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cells_transmitted</span><span class="p">);</span>
    <span class="n">tmp</span><span class="p">.</span><span class="n">rx_cells</span>    <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal0</span><span class="p">.</span><span class="n">cells_received</span><span class="p">)</span>     <span class="o">+</span>
	              <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cells_received</span><span class="p">)</span>    <span class="o">+</span>
	              <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cells_received</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sonet_stats</span><span class="p">))</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>	
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span> <span class="o">=</span> <span class="n">FORE200E_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    
    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;ioctl cmd = 0x%x (%u), arg = 0x%p (%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">case</span> <span class="n">SONET_GETSTAT</span>:
	<span class="k">return</span> <span class="n">fore200e_fetch_stats</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sonet_stats</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">SONET_GETDIAG</span>:
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">ATM_SETLOOP</span>:
	<span class="k">return</span> <span class="n">fore200e_setloop</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

    <span class="k">case</span> <span class="n">ATM_GETLOOP</span>:
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">loop_mode</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">ATM_QUERYLOOP</span>:
	<span class="k">return</span> <span class="n">put_user</span><span class="p">(</span><span class="n">ATM_LM_LOC_PHY</span> <span class="o">|</span> <span class="n">ATM_LM_RMT_PHY</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span> <span class="cm">/* not implemented */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_change_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span> <span class="n">vcc</span><span class="p">,</span><span class="k">struct</span> <span class="n">atm_qos</span><span class="o">*</span> <span class="n">qos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e_vcc</span><span class="o">*</span> <span class="n">fore200e_vcc</span> <span class="o">=</span> <span class="n">FORE200E_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span>     <span class="n">fore200e</span>     <span class="o">=</span> <span class="n">FORE200E_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;VC %d.%d.%d not ready for QoS change</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;change_qos %d.%d.%d, &quot;</span>
	    <span class="s">&quot;(tx: cl=%s, pcr=%d-%d, cdv=%d, max_sdu=%d; &quot;</span>
	    <span class="s">&quot;rx: cl=%s, pcr=%d-%d, cdv=%d, max_sdu=%d), flags = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span>
	    <span class="s">&quot;available_cell_rate = %u&quot;</span><span class="p">,</span>
	    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">itf</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span>
	    <span class="n">fore200e_traffic_class</span><span class="p">[</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="p">],</span>
	    <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">,</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_cdv</span><span class="p">,</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">,</span>
	    <span class="n">fore200e_traffic_class</span><span class="p">[</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="p">],</span>
	    <span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">,</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_cdv</span><span class="p">,</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">,</span>
	    <span class="n">flags</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">available_cell_rate</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rate_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">available_cell_rate</span> <span class="o">+</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&lt;</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rate_mtx</span><span class="p">);</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">available_cell_rate</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">;</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">available_cell_rate</span> <span class="o">-=</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rate_mtx</span><span class="p">);</span>
	
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">,</span> <span class="n">qos</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_qos</span><span class="p">));</span>
	
	<span class="cm">/* update rate control parameters */</span>
	<span class="n">fore200e_rate_ctrl</span><span class="p">(</span><span class="n">qos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_HASQOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
    

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_irq_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">fore200e_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;unable to reserve IRQ %s for device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">fore200e_irq_itoa</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">),</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;IRQ %s reserved for device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">fore200e_irq_itoa</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">),</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="cp">#ifdef FORE200E_USE_TASKLET</span>
    <span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">tx_tasklet</span><span class="p">,</span> <span class="n">fore200e_tx_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fore200e</span><span class="p">);</span>
    <span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">,</span> <span class="n">fore200e_rx_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">fore200e</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_IRQ</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_get_esi</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">prom_data</span><span class="o">*</span> <span class="n">prom</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prom_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">ok</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prom</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">prom_read</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">prom</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
    <span class="p">}</span>
	
    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;device %s, rev. %c, S/N: %d, ESI: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> 
	   <span class="p">(</span><span class="n">prom</span><span class="o">-&gt;</span><span class="n">hw_revision</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;@&#39;</span><span class="p">,</span>    <span class="cm">/* probably meaningless with SBA boards */</span>
	   <span class="n">prom</span><span class="o">-&gt;</span><span class="n">serial_number</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prom</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESI_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">prom</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">];</span>
    <span class="p">}</span>
    
    <span class="n">kfree</span><span class="p">(</span><span class="n">prom</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_alloc_rx_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">nbr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">host_bsq</span><span class="o">*</span> <span class="n">bsq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">buffer</span><span class="o">*</span>   <span class="n">buffer</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scheme</span> <span class="o">&lt;</span> <span class="n">BUFFER_SCHEME_NBR</span><span class="p">;</span> <span class="n">scheme</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">magn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">magn</span> <span class="o">&lt;</span> <span class="n">BUFFER_MAGN_NBR</span><span class="p">;</span> <span class="n">magn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	    <span class="n">bsq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">];</span>

	    <span class="n">nbr</span>  <span class="o">=</span> <span class="n">fore200e_rx_buf_nbr</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">];</span>
	    <span class="n">size</span> <span class="o">=</span> <span class="n">fore200e_rx_buf_size</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">];</span>

	    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;rx buffers %d / %d are being allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">);</span>

	    <span class="cm">/* allocate the array of receive buffers */</span>
	    <span class="n">buffer</span> <span class="o">=</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">nbr</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buffer</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	    <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">buffer</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">scheme</span> <span class="o">=</span> <span class="n">scheme</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">magn</span>   <span class="o">=</span> <span class="n">magn</span><span class="p">;</span>
<span class="cp">#ifdef FORE200E_BSQ_DEBUG</span>
		<span class="n">buffer</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">index</span>  <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">supplied</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="cm">/* allocate the receive buffer body */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fore200e_chunk_alloc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">buffer_alignment</span><span class="p">,</span>
					 <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		    
		    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fore200e_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span> <span class="o">--</span><span class="n">i</span> <span class="p">].</span><span class="n">data</span><span class="p">);</span>
		    <span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
		    
		    <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* insert the buffer into the free buffer list */</span>
		<span class="n">buffer</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">next</span> <span class="o">=</span> <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf</span><span class="p">;</span>
		<span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span> <span class="n">i</span> <span class="p">];</span>
	    <span class="p">}</span>
	    <span class="cm">/* all the buffers are free, initially */</span>
	    <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">freebuf_count</span> <span class="o">=</span> <span class="n">nbr</span><span class="p">;</span>

<span class="cp">#ifdef FORE200E_BSQ_DEBUG</span>
	    <span class="n">bsq_audit</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">bsq</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_ALLOC_BUF</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_init_bs_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">host_bsq</span><span class="o">*</span>     <span class="n">bsq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">cp_bsq_entry</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">cp_entry</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scheme</span> <span class="o">&lt;</span> <span class="n">BUFFER_SCHEME_NBR</span><span class="p">;</span> <span class="n">scheme</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">magn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">magn</span> <span class="o">&lt;</span> <span class="n">BUFFER_MAGN_NBR</span><span class="p">;</span> <span class="n">magn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;buffer supply queue %d / %d is being initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">);</span>

	    <span class="n">bsq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">];</span>

	    <span class="cm">/* allocate and align the array of status words */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_alloc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="k">enum</span> <span class="n">status</span><span class="p">),</span> 
					       <span class="n">QUEUE_SIZE_BS</span><span class="p">,</span>
					       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">status_alignment</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="cm">/* allocate and align the array of receive buffer descriptors */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_alloc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">rbd_block</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rbd_block</span><span class="p">),</span>
					       <span class="n">QUEUE_SIZE_BS</span><span class="p">,</span>
					       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">descr_alignment</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		
		<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	    <span class="p">}</span>
	    
	    <span class="cm">/* get the base address of the cp resident buffer supply queue entries */</span>
	    <span class="n">cp_entry</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> 
		       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">cp_bsq</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">]);</span>
	    
	    <span class="cm">/* fill the host resident and cp resident buffer supply queue entries */</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QUEUE_SIZE_BS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		
		<span class="n">bsq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status</span> <span class="o">=</span> 
		                     <span class="n">FORE200E_INDEX</span><span class="p">(</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">align_addr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	        <span class="n">bsq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">rbd_block</span> <span class="o">=</span>
		                     <span class="n">FORE200E_INDEX</span><span class="p">(</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">rbd_block</span><span class="p">.</span><span class="n">align_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_block</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">bsq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">rbd_block_dma</span> <span class="o">=</span>
		                     <span class="n">FORE200E_DMA_INDEX</span><span class="p">(</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">rbd_block</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rbd_block</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">bsq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">cp_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">];</span>
		
		<span class="o">*</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>
		
		<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">FORE200E_DMA_INDEX</span><span class="p">(</span><span class="n">bsq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> 
				     <span class="o">&amp;</span><span class="n">cp_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status_haddr</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_INIT_BSQ</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_init_rx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_rxq</span><span class="o">*</span>     <span class="n">rxq</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_rxq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">cp_rxq_entry</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">cp_entry</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;receive queue is being initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="cm">/* allocate and align the array of status words */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_alloc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">enum</span> <span class="n">status</span><span class="p">),</span> 
				       <span class="n">QUEUE_SIZE_RX</span><span class="p">,</span>
				       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">status_alignment</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* allocate and align the array of receive PDU descriptors */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_alloc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rpd</span><span class="p">),</span> 
				       <span class="n">QUEUE_SIZE_RX</span><span class="p">,</span>
				       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">descr_alignment</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* get the base address of the cp resident rx queue entries */</span>
    <span class="n">cp_entry</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">cp_rxq</span><span class="p">);</span>

    <span class="cm">/* fill the host resident and cp resident rx entries */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QUEUE_SIZE_RX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status</span> <span class="o">=</span> 
	                     <span class="n">FORE200E_INDEX</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">align_addr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">rpd</span> <span class="o">=</span> 
	                     <span class="n">FORE200E_INDEX</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="p">.</span><span class="n">align_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpd</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">rpd_dma</span> <span class="o">=</span> 
	                     <span class="n">FORE200E_DMA_INDEX</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpd</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">cp_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">];</span>

	<span class="o">*</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>

	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">FORE200E_DMA_INDEX</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> 
			     <span class="o">&amp;</span><span class="n">cp_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status_haddr</span><span class="p">);</span>

	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">FORE200E_DMA_INDEX</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rpd</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rpd</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">cp_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">rpd_haddr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* set the head entry of the queue */</span>
    <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_INIT_RXQ</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_init_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_txq</span><span class="o">*</span>     <span class="n">txq</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_txq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">cp_txq_entry</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">cp_entry</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;transmit queue is being initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="cm">/* allocate and align the array of status words */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_alloc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">enum</span> <span class="n">status</span><span class="p">),</span> 
				       <span class="n">QUEUE_SIZE_TX</span><span class="p">,</span>
				       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">status_alignment</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* allocate and align the array of transmit PDU descriptors */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_alloc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tpd</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tpd</span><span class="p">),</span> 
				       <span class="n">QUEUE_SIZE_TX</span><span class="p">,</span>
				       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">descr_alignment</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_free</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* get the base address of the cp resident tx queue entries */</span>
    <span class="n">cp_entry</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">cp_txq</span><span class="p">);</span>

    <span class="cm">/* fill the host resident and cp resident tx entries */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QUEUE_SIZE_TX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status</span> <span class="o">=</span> 
	                     <span class="n">FORE200E_INDEX</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">align_addr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">tpd</span> <span class="o">=</span> 
	                     <span class="n">FORE200E_INDEX</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tpd</span><span class="p">.</span><span class="n">align_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tpd</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">tpd_dma</span>  <span class="o">=</span> 
                             <span class="n">FORE200E_DMA_INDEX</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tpd</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tpd</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">cp_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">];</span>

	<span class="o">*</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>
	
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">FORE200E_DMA_INDEX</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> 
			     <span class="o">&amp;</span><span class="n">cp_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status_haddr</span><span class="p">);</span>
	
        <span class="cm">/* although there is a one-to-one mapping of tx queue entries and tpds,</span>
<span class="cm">	   we do not write here the DMA (physical) base address of each tpd into</span>
<span class="cm">	   the related cp resident entry, because the cp relies on this write</span>
<span class="cm">	   operation to detect that a new pdu has been submitted for tx */</span>
    <span class="p">}</span>

    <span class="cm">/* set the head and tail entries of the queue */</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">txq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_INIT_TXQ</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_init_cmd_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">host_cmdq</span><span class="o">*</span>     <span class="n">cmdq</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_cmdq</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">cp_cmdq_entry</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">cp_entry</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;command queue is being initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="cm">/* allocate and align the array of status words */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dma_chunk_alloc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">enum</span> <span class="n">status</span><span class="p">),</span> 
				       <span class="n">QUEUE_SIZE_CMD</span><span class="p">,</span>
				       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">status_alignment</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="cm">/* get the base address of the cp resident cmd queue entries */</span>
    <span class="n">cp_entry</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">cp_cmdq</span><span class="p">);</span>

    <span class="cm">/* fill the host resident and cp resident cmd entries */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">QUEUE_SIZE_CMD</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	
	<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status</span>   <span class="o">=</span> 
                              <span class="n">FORE200E_INDEX</span><span class="p">(</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">align_addr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">cp_entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cp_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">];</span>

	<span class="o">*</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">host_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_FREE</span><span class="p">;</span>

	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">FORE200E_DMA_INDEX</span><span class="p">(</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">dma_addr</span><span class="p">,</span> <span class="k">enum</span> <span class="n">status</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> 
                             <span class="o">&amp;</span><span class="n">cp_entry</span><span class="p">[</span> <span class="n">i</span> <span class="p">].</span><span class="n">status_haddr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="cm">/* set the head entry of the queue */</span>
    <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_INIT_CMDQ</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">fore200e_param_bs_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">buffer_scheme</span> <span class="n">scheme</span><span class="p">,</span> <span class="k">enum</span> <span class="n">buffer_magn</span> <span class="n">magn</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">queue_length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pool_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">supply_blksize</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">bs_spec</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">bs_spec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">bs_spec</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">];</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">queue_length</span><span class="p">,</span>                           <span class="o">&amp;</span><span class="n">bs_spec</span><span class="o">-&gt;</span><span class="n">queue_length</span><span class="p">);</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">fore200e_rx_buf_size</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">],</span> <span class="o">&amp;</span><span class="n">bs_spec</span><span class="o">-&gt;</span><span class="n">buffer_size</span><span class="p">);</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">pool_size</span><span class="p">,</span>                              <span class="o">&amp;</span><span class="n">bs_spec</span><span class="o">-&gt;</span><span class="n">pool_size</span><span class="p">);</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">supply_blksize</span><span class="p">,</span>                         <span class="o">&amp;</span><span class="n">bs_spec</span><span class="o">-&gt;</span><span class="n">supply_blksize</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">cp_queues</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">cpq</span><span class="p">;</span>
    <span class="kt">int</span>               <span class="n">ok</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;device %s being initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">rate_mtx</span><span class="p">);</span>
    <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">);</span>

    <span class="n">cpq</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">FORE200E_CP_QUEUES_OFFSET</span><span class="p">;</span>

    <span class="cm">/* enable cp to host interrupts */</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">imask</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">)</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">irq_enable</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
    
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">NBR_CONNECT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">num_connect</span><span class="p">);</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">QUEUE_SIZE_CMD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">cmd_queue_len</span><span class="p">);</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">QUEUE_SIZE_RX</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">rx_queue_len</span><span class="p">);</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">QUEUE_SIZE_TX</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">tx_queue_len</span><span class="p">);</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">RSD_EXTENSION</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">rsd_extension</span><span class="p">);</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">TSD_EXTENSION</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">tsd_extension</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">scheme</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scheme</span> <span class="o">&lt;</span> <span class="n">BUFFER_SCHEME_NBR</span><span class="p">;</span> <span class="n">scheme</span><span class="o">++</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">magn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">magn</span> <span class="o">&lt;</span> <span class="n">BUFFER_MAGN_NBR</span><span class="p">;</span> <span class="n">magn</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">fore200e_param_bs_queue</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">scheme</span><span class="p">,</span> <span class="n">magn</span><span class="p">,</span>
				    <span class="n">QUEUE_SIZE_BS</span><span class="p">,</span> 
				    <span class="n">fore200e_rx_buf_nbr</span><span class="p">[</span> <span class="n">scheme</span> <span class="p">][</span> <span class="n">magn</span> <span class="p">],</span>
				    <span class="n">RBD_BLK_SIZE</span><span class="p">);</span>

    <span class="cm">/* issue the initialize command */</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">STATUS_PENDING</span><span class="p">,</span>    <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">OPCODE_INITIALIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">opcode</span><span class="p">);</span>

    <span class="n">ok</span> <span class="o">=</span> <span class="n">fore200e_io_poll</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cpq</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="n">STATUS_COMPLETE</span><span class="p">,</span> <span class="mi">3000</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ok</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;device %s initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;device %s initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_INITIALIZE</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">fore200e_monitor_putc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="kt">char</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">cp_monitor</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">monitor</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_monitor</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">    printk(&quot;%c&quot;, c);</span>
<span class="cp">#endif</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">c</span><span class="p">)</span> <span class="o">|</span> <span class="n">FORE200E_CP_MONITOR_UART_AVAIL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">soft_uart</span><span class="p">.</span><span class="n">send</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_monitor_getc</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">cp_monitor</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">monitor</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_monitor</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>      <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
    <span class="kt">int</span>                <span class="n">c</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>

	<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">soft_uart</span><span class="p">.</span><span class="n">recv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="n">FORE200E_CP_MONITOR_UART_AVAIL</span><span class="p">)</span> <span class="p">{</span>

	    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">FORE200E_CP_MONITOR_UART_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">monitor</span><span class="o">-&gt;</span><span class="n">soft_uart</span><span class="p">.</span><span class="n">recv</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	    printk(&quot;%c&quot;, c &amp; 0xFF);</span>
<span class="cp">#endif</span>
	    <span class="k">return</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">fore200e_monitor_puts</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>

	<span class="cm">/* the i960 monitor doesn&#39;t accept any new character if it has something to say */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">fore200e_monitor_getc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
	
	<span class="n">fore200e_monitor_putc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">*</span><span class="n">str</span><span class="o">++</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">fore200e_monitor_getc</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef __LITTLE_ENDIAN</span>
<span class="cp">#define FW_EXT &quot;.bin&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define FW_EXT &quot;_ecd.bin2&quot;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_load_and_start_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">firmware</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">fw_header</span> <span class="o">*</span><span class="n">fw_header</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">__le32</span> <span class="o">*</span><span class="n">fw_data</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">fw_size</span><span class="p">;</span>
    <span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">load_addr</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> <span class="s">&quot;PCA-200E&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_SBUS</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> <span class="s">&quot;SBA-200E&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">else</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc_name</span><span class="p">,</span> <span class="n">FW_EXT</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">firmware</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">device</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;problem loading firmware image %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fw_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="n">fw_size</span> <span class="o">=</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
    <span class="n">fw_header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span> <span class="o">*</span><span class="p">)</span> <span class="n">firmware</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
    <span class="n">load_addr</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw_header</span><span class="o">-&gt;</span><span class="n">load_offset</span><span class="p">);</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;device %s firmware being loaded at 0x%p (%d words)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">load_addr</span><span class="p">,</span> <span class="n">fw_size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw_header</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FW_HEADER_MAGIC</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;corrupted %s firmware image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(;</span> <span class="n">fw_size</span><span class="o">--</span><span class="p">;</span> <span class="n">fw_data</span><span class="o">++</span><span class="p">,</span> <span class="n">load_addr</span><span class="o">++</span><span class="p">)</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">fw_data</span><span class="p">),</span> <span class="n">load_addr</span><span class="p">);</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;device %s firmware being started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="cp">#if defined(__sparc_v9__)</span>
    <span class="cm">/* reported to be required by SBA cards on some sparc64 hosts */</span>
    <span class="n">fore200e_spin</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="cp">#endif</span>

    <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\r</span><span class="s">go %x</span><span class="se">\r</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fw_header</span><span class="o">-&gt;</span><span class="n">start_offset</span><span class="p">));</span>
    <span class="n">fore200e_monitor_puts</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_io_poll</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_monitor</span><span class="o">-&gt;</span><span class="n">bstat</span><span class="p">,</span> <span class="n">BSTAT_CP_RUNNING</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;device %s firmware didn&#39;t start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;device %s firmware started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_START_FW</span><span class="p">;</span>
    <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">release:</span>
    <span class="n">release_firmware</span><span class="p">(</span><span class="n">firmware</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">atm_dev</span><span class="o">*</span> <span class="n">atm_dev</span><span class="p">;</span>

    <span class="n">DPRINTK</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s">&quot;device %s being registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

    <span class="n">atm_dev</span> <span class="o">=</span> <span class="n">atm_dev_register</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc_name</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fore200e_ops</span><span class="p">,</span>
                               <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">atm_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;unable to register device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">fore200e</span><span class="p">;</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">atm_dev</span> <span class="o">=</span> <span class="n">atm_dev</span><span class="p">;</span>

    <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="n">FORE200E_VPI_BITS</span><span class="p">;</span>
    <span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="n">FORE200E_VCI_BITS</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">available_cell_rate</span> <span class="o">=</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_REGISTER</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_register</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">configure</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_reset</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_load_and_start_fw</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_initialize</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_init_cmd_queue</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_init_tx_queue</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_init_rx_queue</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_init_bs_queue</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_alloc_rx_buf</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_get_esi</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e_irq_request</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

    <span class="n">fore200e_supply</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>

    <span class="cm">/* all done, board initialization is now complete */</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FORE200E_STATE_COMPLETE</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">fore200e_sba_match</span><span class="p">[];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fore200e_sba_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">fore200e_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">match</span> <span class="o">=</span> <span class="n">of_match_device</span><span class="p">(</span><span class="n">fore200e_sba_match</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">match</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">bus</span> <span class="o">=</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">fore200e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fore200e</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span> <span class="o">=</span> <span class="n">op</span><span class="p">;</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">archdata</span><span class="p">.</span><span class="n">irqs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">phys_base</span> <span class="o">=</span> <span class="n">op</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">fore200e_init</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fore200e_shutdown</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fore200e</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">fore200e_sba_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">op</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">fore200e_shutdown</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">fore200e_sba_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SBA200E_PROM_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fore200e_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	<span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">fore200e_sba_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">fore200e_sba_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;fore_200e&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">fore200e_sba_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">fore200e_sba_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">fore200e_sba_remove</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fore200e_pca_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_ent</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">fore200e_bus</span><span class="o">*</span> <span class="n">bus</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fore200e_bus</span><span class="o">*</span><span class="p">)</span> <span class="n">pci_ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span> <span class="n">fore200e</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="n">fore200e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fore200e</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span>       <span class="o">=</span> <span class="n">bus</span><span class="p">;</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus_dev</span>   <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>    
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">irq</span>       <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
    <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">phys_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">sprintf</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

    <span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;device %s found at 0x%lx, IRQ %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	   <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> 
	   <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">phys_base</span><span class="p">,</span> <span class="n">fore200e_irq_itoa</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">));</span>

    <span class="n">sprintf</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s-%d&quot;</span><span class="p">,</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">model_name</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">fore200e_init</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fore200e_shutdown</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">++</span><span class="n">index</span><span class="p">;</span>
    <span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">fore200e</span><span class="p">);</span>

<span class="nl">out:</span>
    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out_free:</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
<span class="nl">out_disable:</span>
    <span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
    <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">fore200e_pca_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e</span> <span class="o">*</span><span class="n">fore200e</span><span class="p">;</span>

    <span class="n">fore200e</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

    <span class="n">fore200e_shutdown</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
    <span class="n">kfree</span><span class="p">(</span><span class="n">fore200e</span><span class="p">);</span>
    <span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">fore200e_pca_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">PCI_VENDOR_ID_FORE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FORE_PCA200E</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">fore200e_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">},</span>
    <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">fore200e_pca_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">fore200e_pca_driver</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">name</span> <span class="o">=</span>     <span class="s">&quot;fore_200e&quot;</span><span class="p">,</span>
    <span class="p">.</span><span class="n">probe</span> <span class="o">=</span>    <span class="n">fore200e_pca_detect</span><span class="p">,</span>
    <span class="p">.</span><span class="n">remove</span> <span class="o">=</span>   <span class="n">__devexit_p</span><span class="p">(</span><span class="n">fore200e_pca_remove_one</span><span class="p">),</span>
    <span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">fore200e_pca_tbl</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">fore200e_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">FORE200E</span> <span class="s">&quot;FORE Systems 200E-series ATM driver - version &quot;</span> <span class="n">FORE200E_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e_sba_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e_pca_driver</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_SBUS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e_sba_driver</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fore200e_module_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e_pca_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SBUS</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e_sba_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fore200e_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">loff_t</span><span class="o">*</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">fore200e</span><span class="o">*</span>     <span class="n">fore200e</span>  <span class="o">=</span> <span class="n">FORE200E_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">fore200e_vcc</span><span class="o">*</span> <span class="n">fore200e_vcc</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">atm_vcc</span><span class="o">*</span>      <span class="n">vcc</span><span class="p">;</span>
    <span class="kt">int</span>                  <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>        <span class="n">flags</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fore200e_getstats</span><span class="p">(</span><span class="n">fore200e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot; device:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   internal name:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* print bus-specific information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc_read</span><span class="p">)</span>
	    <span class="n">len</span> <span class="o">+=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">proc_read</span><span class="p">(</span><span class="n">fore200e</span><span class="p">,</span> <span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	
	<span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
		<span class="s">&quot;   interrupt line:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;   physical base address:</span><span class="se">\t</span><span class="s">0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;   virtual base address:</span><span class="se">\t</span><span class="s">0x%p</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;   factory address (ESI):</span><span class="se">\t</span><span class="s">%pM</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;   board serial number:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fore200e_irq_itoa</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">phys_base</span><span class="p">,</span>
		<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">virt_base</span><span class="p">,</span>
		<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">,</span>
		<span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span>
		       <span class="s">&quot;   free small bufs, scheme 1:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   free large bufs, scheme 1:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   free small bufs, scheme 2:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   free large bufs, scheme 2:</span><span class="se">\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">BUFFER_SCHEME_ONE</span> <span class="p">][</span> <span class="n">BUFFER_MAGN_SMALL</span> <span class="p">].</span><span class="n">freebuf_count</span><span class="p">,</span>
		       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">BUFFER_SCHEME_ONE</span> <span class="p">][</span> <span class="n">BUFFER_MAGN_LARGE</span> <span class="p">].</span><span class="n">freebuf_count</span><span class="p">,</span>
		       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">BUFFER_SCHEME_TWO</span> <span class="p">][</span> <span class="n">BUFFER_MAGN_SMALL</span> <span class="p">].</span><span class="n">freebuf_count</span><span class="p">,</span>
		       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">host_bsq</span><span class="p">[</span> <span class="n">BUFFER_SCHEME_TWO</span> <span class="p">][</span> <span class="n">BUFFER_MAGN_LARGE</span> <span class="p">].</span><span class="n">freebuf_count</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">hb</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">heartbeat</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span>
		      <span class="s">&quot; cell processor:</span><span class="se">\n</span><span class="s">&quot;</span>
		      <span class="s">&quot;   heartbeat state:</span><span class="se">\t\t</span><span class="s">&quot;</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">hb</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mh">0xDEAD</span><span class="p">)</span>
	    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hb</span><span class="p">);</span>
	<span class="k">else</span>
	    <span class="n">len</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;*** FATAL ERROR %04x ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hb</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">media_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	    <span class="s">&quot;unshielded twisted pair&quot;</span><span class="p">,</span>
	    <span class="s">&quot;multimode optical fiber ST&quot;</span><span class="p">,</span>
	    <span class="s">&quot;multimode optical fiber SC&quot;</span><span class="p">,</span>
	    <span class="s">&quot;single-mode optical fiber ST&quot;</span><span class="p">,</span>
	    <span class="s">&quot;single-mode optical fiber SC&quot;</span><span class="p">,</span>
	    <span class="s">&quot;unknown&quot;</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">oc3_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	    <span class="s">&quot;normal operation&quot;</span><span class="p">,</span>
	    <span class="s">&quot;diagnostic loopback&quot;</span><span class="p">,</span>
	    <span class="s">&quot;line loopback&quot;</span><span class="p">,</span>
	    <span class="s">&quot;unknown&quot;</span>
	<span class="p">};</span>

	<span class="n">u32</span> <span class="n">fw_release</span>     <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">fw_release</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mon960_release</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">mon960_release</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">oc3_revision</span>   <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">oc3_revision</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">media_index</span>    <span class="o">=</span> <span class="n">FORE200E_MEDIA_INDEX</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_queues</span><span class="o">-&gt;</span><span class="n">media_type</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">oc3_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">media_index</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">media_index</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	
	<span class="k">switch</span> <span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">loop_mode</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">case</span> <span class="n">ATM_LM_NONE</span>:    <span class="n">oc3_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		                 <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">ATM_LM_LOC_PHY</span>: <span class="n">oc3_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		                 <span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">ATM_LM_RMT_PHY</span>: <span class="n">oc3_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		                 <span class="k">break</span><span class="p">;</span>
	    <span class="nl">default:</span>             <span class="n">oc3_index</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span>
		       <span class="s">&quot;   firmware release:</span><span class="se">\t\t</span><span class="s">%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   monitor release:</span><span class="se">\t\t</span><span class="s">%d.%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   media type:</span><span class="se">\t\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   OC-3 revision:</span><span class="se">\t\t</span><span class="s">0x%x</span><span class="se">\n</span><span class="s">&quot;</span>
                       <span class="s">&quot;   OC-3 mode:</span><span class="se">\t\t\t</span><span class="s">%s&quot;</span><span class="p">,</span>
		       <span class="n">fw_release</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">fw_release</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>  <span class="n">fw_release</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">,</span>
		       <span class="n">mon960_release</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">mon960_release</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		       <span class="n">media_name</span><span class="p">[</span> <span class="n">media_index</span> <span class="p">],</span>
		       <span class="n">oc3_revision</span><span class="p">,</span>
		       <span class="n">oc3_mode</span><span class="p">[</span> <span class="n">oc3_index</span> <span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cp_monitor</span> <span class="n">__iomem</span> <span class="o">*</span> <span class="n">cp_monitor</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">cp_monitor</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span>
		       <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span>
		       <span class="s">&quot; monitor:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   version number:</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   boot status word:</span><span class="se">\t\t</span><span class="s">0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp_monitor</span><span class="o">-&gt;</span><span class="n">mon_version</span><span class="p">),</span>
		       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cp_monitor</span><span class="o">-&gt;</span><span class="n">bstat</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span>
		       <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot; device statistics:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;  4b5b:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     crc_header_errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     framing_errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">crc_header_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">framing_errors</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;  OC-3:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     section_bip8_errors:</span><span class="se">\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     path_bip8_errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     line_bip24_errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     line_febe_errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     path_febe_errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     corr_hcs_errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     ucorr_hcs_errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">section_bip8_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">path_bip8_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">line_bip24_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">line_febe_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">path_febe_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">corr_hcs_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">oc3</span><span class="p">.</span><span class="n">ucorr_hcs_errors</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   ATM:</span><span class="se">\t\t\t\t</span><span class="s">     cells</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     TX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     RX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     vpi out of range:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     vpi no conn:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     vci out of range:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     vci no conn:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">atm</span><span class="p">.</span><span class="n">cells_transmitted</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">atm</span><span class="p">.</span><span class="n">cells_received</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">atm</span><span class="p">.</span><span class="n">vpi_bad_range</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">atm</span><span class="p">.</span><span class="n">vpi_no_conn</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">atm</span><span class="p">.</span><span class="n">vci_bad_range</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">atm</span><span class="p">.</span><span class="n">vci_no_conn</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   AAL0:</span><span class="se">\t\t\t</span><span class="s">     cells</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     TX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     RX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     dropped:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal0</span><span class="p">.</span><span class="n">cells_transmitted</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal0</span><span class="p">.</span><span class="n">cells_received</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal0</span><span class="p">.</span><span class="n">cells_dropped</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   AAL3/4:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     SAR sublayer:</span><span class="se">\t\t</span><span class="s">     cells</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       TX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       RX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       dropped:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       CRC errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       protocol errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     CS  sublayer:</span><span class="se">\t\t</span><span class="s">      PDUs</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       TX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       RX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       dropped:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       protocol errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cells_transmitted</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cells_received</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cells_dropped</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cells_crc_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cells_protocol_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cspdus_transmitted</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cspdus_received</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cspdus_dropped</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal34</span><span class="p">.</span><span class="n">cspdus_protocol_errors</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   AAL5:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     SAR sublayer:</span><span class="se">\t\t</span><span class="s">     cells</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       TX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       RX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       dropped:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       congestions:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     CS  sublayer:</span><span class="se">\t\t</span><span class="s">      PDUs</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       TX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       RX:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       dropped:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       CRC errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;       protocol errors:</span><span class="se">\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cells_transmitted</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cells_received</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cells_dropped</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">congestion_experienced</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cspdus_transmitted</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cspdus_received</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cspdus_dropped</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cspdus_crc_errors</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aal5</span><span class="p">.</span><span class="n">cspdus_protocol_errors</span><span class="p">));</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;   AUX:</span><span class="se">\t\t</span><span class="s">       allocation failures</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     small b1:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     large b1:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     small b2:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     large b2:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     RX PDUs:</span><span class="se">\t\t\t</span><span class="s">%10u</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;     TX PDUs:</span><span class="se">\t\t\t</span><span class="s">%10lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">.</span><span class="n">small_b1_failed</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">.</span><span class="n">large_b1_failed</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">.</span><span class="n">small_b2_failed</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">.</span><span class="n">large_b2_failed</span><span class="p">),</span>
		       <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">.</span><span class="n">rpd_alloc_failed</span><span class="p">),</span>
		       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">tx_sat</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot; receive carrier:</span><span class="se">\t\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">aux</span><span class="p">.</span><span class="n">receive_carrier</span> <span class="o">?</span> <span class="s">&quot;ON&quot;</span> <span class="o">:</span> <span class="s">&quot;OFF!&quot;</span><span class="p">);</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot; VCCs:</span><span class="se">\n</span><span class="s">  address   VPI VCI   AAL &quot;</span>
		       <span class="s">&quot;TX PDUs   TX min/max size  RX PDUs   RX min/max size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NBR_CONNECT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

	<span class="n">vcc</span> <span class="o">=</span> <span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">vc_map</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vcc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	    <span class="k">continue</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

	    <span class="n">fore200e_vcc</span> <span class="o">=</span> <span class="n">FORE200E_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	    <span class="n">ASSERT</span><span class="p">(</span><span class="n">fore200e_vcc</span><span class="p">);</span>

	    <span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span>
			  <span class="s">&quot;  %08x  %03d %05d %1d   %09lu %05d/%05d      %09lu %05d/%05d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vcc</span><span class="p">,</span>
			  <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">fore200e_atm2fore_aal</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">),</span>
			  <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_pdu</span><span class="p">,</span>
			  <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_min_pdu</span> <span class="o">&gt;</span> <span class="mh">0xFFFF</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_min_pdu</span><span class="p">,</span>
			  <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">tx_max_pdu</span><span class="p">,</span>
			  <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_pdu</span><span class="p">,</span>
			  <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_min_pdu</span> <span class="o">&gt;</span> <span class="mh">0xFFFF</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_min_pdu</span><span class="p">,</span>
			  <span class="n">fore200e_vcc</span><span class="o">-&gt;</span><span class="n">rx_max_pdu</span><span class="p">);</span>

	    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fore200e</span><span class="o">-&gt;</span><span class="n">q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fore200e_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fore200e_module_cleanup</span><span class="p">);</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">fore200e_ops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>       <span class="o">=</span> <span class="n">fore200e_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>      <span class="o">=</span> <span class="n">fore200e_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>      <span class="o">=</span> <span class="n">fore200e_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span> <span class="o">=</span> <span class="n">fore200e_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span> <span class="o">=</span> <span class="n">fore200e_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send</span>       <span class="o">=</span> <span class="n">fore200e_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_qos</span> <span class="o">=</span> <span class="n">fore200e_change_qos</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_read</span>  <span class="o">=</span> <span class="n">fore200e_proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>      <span class="o">=</span> <span class="n">THIS_MODULE</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fore200e_bus</span> <span class="n">fore200e_bus</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PCI</span>
    <span class="p">{</span> <span class="s">&quot;PCA-200E&quot;</span><span class="p">,</span> <span class="s">&quot;pca200e&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> 
      <span class="n">fore200e_pca_read</span><span class="p">,</span>
      <span class="n">fore200e_pca_write</span><span class="p">,</span>
      <span class="n">fore200e_pca_dma_map</span><span class="p">,</span>
      <span class="n">fore200e_pca_dma_unmap</span><span class="p">,</span>
      <span class="n">fore200e_pca_dma_sync_for_cpu</span><span class="p">,</span>
      <span class="n">fore200e_pca_dma_sync_for_device</span><span class="p">,</span>
      <span class="n">fore200e_pca_dma_chunk_alloc</span><span class="p">,</span>
      <span class="n">fore200e_pca_dma_chunk_free</span><span class="p">,</span>
      <span class="n">fore200e_pca_configure</span><span class="p">,</span>
      <span class="n">fore200e_pca_map</span><span class="p">,</span>
      <span class="n">fore200e_pca_reset</span><span class="p">,</span>
      <span class="n">fore200e_pca_prom_read</span><span class="p">,</span>
      <span class="n">fore200e_pca_unmap</span><span class="p">,</span>
      <span class="nb">NULL</span><span class="p">,</span>
      <span class="n">fore200e_pca_irq_check</span><span class="p">,</span>
      <span class="n">fore200e_pca_irq_ack</span><span class="p">,</span>
      <span class="n">fore200e_pca_proc_read</span><span class="p">,</span>
    <span class="p">},</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_SBUS</span>
    <span class="p">{</span> <span class="s">&quot;SBA-200E&quot;</span><span class="p">,</span> <span class="s">&quot;sba200e&quot;</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
      <span class="n">fore200e_sba_read</span><span class="p">,</span>
      <span class="n">fore200e_sba_write</span><span class="p">,</span>
      <span class="n">fore200e_sba_dma_map</span><span class="p">,</span>
      <span class="n">fore200e_sba_dma_unmap</span><span class="p">,</span>
      <span class="n">fore200e_sba_dma_sync_for_cpu</span><span class="p">,</span>
      <span class="n">fore200e_sba_dma_sync_for_device</span><span class="p">,</span>
      <span class="n">fore200e_sba_dma_chunk_alloc</span><span class="p">,</span>
      <span class="n">fore200e_sba_dma_chunk_free</span><span class="p">,</span>
      <span class="n">fore200e_sba_configure</span><span class="p">,</span>
      <span class="n">fore200e_sba_map</span><span class="p">,</span>
      <span class="n">fore200e_sba_reset</span><span class="p">,</span>
      <span class="n">fore200e_sba_prom_read</span><span class="p">,</span>
      <span class="n">fore200e_sba_unmap</span><span class="p">,</span>
      <span class="n">fore200e_sba_irq_enable</span><span class="p">,</span>
      <span class="n">fore200e_sba_irq_check</span><span class="p">,</span>
      <span class="n">fore200e_sba_irq_ack</span><span class="p">,</span>
      <span class="n">fore200e_sba_proc_read</span><span class="p">,</span>
    <span class="p">},</span>
<span class="cp">#endif</span>
    <span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PCI</span>
<span class="cp">#ifdef __LITTLE_ENDIAN__</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;pca200e.bin&quot;</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;pca200e_ecd.bin2&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_SBUS</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;sba200e_ecd.bin2&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
