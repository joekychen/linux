<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › atm › nicstar.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>nicstar.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * nicstar.c</span>
<span class="cm"> *</span>
<span class="cm"> * Device driver supporting CBR for IDT 77201/77211 &quot;NICStAR&quot; based cards.</span>
<span class="cm"> *</span>
<span class="cm"> * IMPORTANT: The included file nicstarmac.c was NOT WRITTEN BY ME.</span>
<span class="cm"> *            It was taken from the frle-0.22 device driver.</span>
<span class="cm"> *            As the file doesn&#39;t have a copyright notice, in the file</span>
<span class="cm"> *            nicstarmac.copyright I put the copyright notice from the</span>
<span class="cm"> *            frle-0.22 device driver.</span>
<span class="cm"> *            Some code is based on the nicstar driver by M. Welsh.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Rui Prior (rprior@inescn.pt)</span>
<span class="cm"> * PowerPC support by Jay Talbott (jay_talbott@mcg.mot.com) April 1999</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * (C) INESC 1999</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * IMPORTANT INFORMATION</span>
<span class="cm"> *</span>
<span class="cm"> * There are currently three types of spinlocks:</span>
<span class="cm"> *</span>
<span class="cm"> * 1 - Per card interrupt spinlock (to protect structures and such)</span>
<span class="cm"> * 2 - Per SCQ scq spinlock</span>
<span class="cm"> * 3 - Per card resource spinlock (to access registers, etc.)</span>
<span class="cm"> *</span>
<span class="cm"> * These must NEVER be grabbed in reverse order.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* Header files */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;linux/atm.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &quot;nicstar.h&quot;</span>
<span class="cp">#ifdef CONFIG_ATM_NICSTAR_USE_SUNI</span>
<span class="cp">#include &quot;suni.h&quot;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_NICSTAR_USE_SUNI */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_ATM_NICSTAR_USE_IDT77105</span>
<span class="cp">#include &quot;idt77105.h&quot;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_NICSTAR_USE_IDT77105 */</span><span class="cp"></span>

<span class="cm">/* Additional code */</span>

<span class="cp">#include &quot;nicstarmac.c&quot;</span>

<span class="cm">/* Configurable parameters */</span>

<span class="cp">#undef PHY_LOOPBACK</span>
<span class="cp">#undef TX_DEBUG</span>
<span class="cp">#undef RX_DEBUG</span>
<span class="cp">#undef GENERAL_DEBUG</span>
<span class="cp">#undef EXTRA_DEBUG</span>

<span class="cp">#undef NS_USE_DESTRUCTORS	</span><span class="cm">/* For now keep this undefined unless you know</span>
<span class="cm">				   you&#39;re going to use only raw ATM */</span><span class="cp"></span>

<span class="cm">/* Do not touch these */</span>

<span class="cp">#ifdef TX_DEBUG</span>
<span class="cp">#define TXPRINTK(args...) printk(args)</span>
<span class="cp">#else</span>
<span class="cp">#define TXPRINTK(args...)</span>
<span class="cp">#endif </span><span class="cm">/* TX_DEBUG */</span><span class="cp"></span>

<span class="cp">#ifdef RX_DEBUG</span>
<span class="cp">#define RXPRINTK(args...) printk(args)</span>
<span class="cp">#else</span>
<span class="cp">#define RXPRINTK(args...)</span>
<span class="cp">#endif </span><span class="cm">/* RX_DEBUG */</span><span class="cp"></span>

<span class="cp">#ifdef GENERAL_DEBUG</span>
<span class="cp">#define PRINTK(args...) printk(args)</span>
<span class="cp">#else</span>
<span class="cp">#define PRINTK(args...)</span>
<span class="cp">#endif </span><span class="cm">/* GENERAL_DEBUG */</span><span class="cp"></span>

<span class="cp">#ifdef EXTRA_DEBUG</span>
<span class="cp">#define XPRINTK(args...) printk(args)</span>
<span class="cp">#else</span>
<span class="cp">#define XPRINTK(args...)</span>
<span class="cp">#endif </span><span class="cm">/* EXTRA_DEBUG */</span><span class="cp"></span>

<span class="cm">/* Macros */</span>

<span class="cp">#define CMD_BUSY(card) (readl((card)-&gt;membase + STAT) &amp; NS_STAT_CMDBZ)</span>

<span class="cp">#define NS_DELAY mdelay(1)</span>

<span class="cp">#define PTR_DIFF(a, b)	((u32)((unsigned long)(a) - (unsigned long)(b)))</span>

<span class="cp">#ifndef ATM_SKB</span>
<span class="cp">#define ATM_SKB(s) (&amp;(s)-&gt;atm)</span>
<span class="cp">#endif</span>

<span class="cp">#define scq_virt_to_bus(scq, p) \</span>
<span class="cp">		(scq-&gt;dma + ((unsigned long)(p) - (unsigned long)(scq)-&gt;org))</span>

<span class="cm">/* Function declarations */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">ns_read_sram</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sram_address</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ns_write_sram</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sram_address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">value</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="n">ns_init_card</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">);</span>
<span class="k">static</span> <span class="n">scq_info</span> <span class="o">*</span><span class="n">get_scq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">scd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">free_scq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">scq_info</span> <span class="o">*</span> <span class="n">scq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">push_rxbufs</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ns_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ns_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ns_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fill_tst</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">vc_map</span> <span class="o">*</span> <span class="n">vc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ns_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">push_scqe</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">vc_map</span> <span class="o">*</span> <span class="n">vc</span><span class="p">,</span> <span class="n">scq_info</span> <span class="o">*</span> <span class="n">scq</span><span class="p">,</span> <span class="n">ns_scqe</span> <span class="o">*</span> <span class="n">tbd</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">process_tsq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">drain_scq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">scq_info</span> <span class="o">*</span> <span class="n">scq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">process_rsq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dequeue_rx</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">ns_rsqe</span> <span class="o">*</span> <span class="n">rsqe</span><span class="p">);</span>
<span class="cp">#ifdef NS_USE_DESTRUCTORS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ns_sb_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ns_lb_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ns_hb_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">hb</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* NS_USE_DESTRUCTORS */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">recycle_rx_buf</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">recycle_iovec_rx_bufs</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">recycle_iov_buf</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iovb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dequeue_sm_buf</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dequeue_lg_buf</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ns_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ns_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">);</span>
<span class="cp">#ifdef EXTRA_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">which_list</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ns_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ns_parse_mac</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">esi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ns_phy_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ns_phy_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">);</span>

<span class="cm">/* Global variables */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ns_dev</span> <span class="o">*</span><span class="n">cards</span><span class="p">[</span><span class="n">NS_MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">num_cards</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">atm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ns_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">ns_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">ns_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send</span> <span class="o">=</span> <span class="n">ns_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_put</span> <span class="o">=</span> <span class="n">ns_phy_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_get</span> <span class="o">=</span> <span class="n">ns_phy_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_read</span> <span class="o">=</span> <span class="n">ns_proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">ns_timer</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">[</span><span class="n">NS_MAX_CARDS</span><span class="p">];</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* Functions */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">nicstar_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">index</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cards</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">ns_init_card</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">pcidev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cards</span><span class="p">[</span><span class="n">index</span><span class="o">--</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* don&#39;t increment index */</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">nicstar_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">hb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iovb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">);</span>

	<span class="cm">/* Stop everything */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>

	<span class="cm">/* De-register device */</span>
	<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">);</span>

	<span class="cm">/* Disable PCI device */</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="cm">/* Free up resources */</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: freeing %d huge buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">hb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">hb</span><span class="p">);</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: %d huge buffers freed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: freeing %d iovec buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">iovb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">iovb</span><span class="p">);</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: %d iovec buffers freed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">lb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">lb</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">sb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
	<span class="n">free_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NS_FRSCD_NUM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">free_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tx_vcc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">idr_remove_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">idr</span><span class="p">);</span>
	<span class="n">idr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">idr</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">NS_RSQSIZE</span> <span class="o">+</span> <span class="n">NS_RSQ_ALIGNMENT</span><span class="p">,</span>
			    <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">org</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">NS_TSQSIZE</span> <span class="o">+</span> <span class="n">NS_TSQ_ALIGNMENT</span><span class="p">,</span>
			    <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">org</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">nicstar_pci_tbl</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">IDT</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_IDT_IDT77201</span><span class="p">),</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>			<span class="cm">/* terminate list */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">nicstar_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">nicstar_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nicstar&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">nicstar_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">nicstar_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">nicstar_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">nicstar_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Initialized to remove compile warning */</span>

	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar: nicstar_init() called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nicstar_driver</span><span class="p">);</span>

	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar: TX debug enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar: RX debug enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar: General debug enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#ifdef PHY_LOOPBACK</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar: using PHY loopback.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PHY_LOOPBACK */</span><span class="cp"></span>
	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar: nicstar_init() returned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns_timer</span><span class="p">);</span>
		<span class="n">ns_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NS_POLL_PERIOD</span><span class="p">;</span>
		<span class="n">ns_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0UL</span><span class="p">;</span>
		<span class="n">ns_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ns_poll</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns_timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">nicstar_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar: nicstar_cleanup() called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns_timer</span><span class="p">);</span>

	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nicstar_driver</span><span class="p">);</span>

	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar: nicstar_cleanup() returned.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ns_read_sram</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sram_address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">sram_address</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">sram_address</span> <span class="o">&amp;=</span> <span class="mh">0x0007FFFC</span><span class="p">;</span>	<span class="cm">/* address must be dword aligned */</span>
	<span class="n">sram_address</span> <span class="o">|=</span> <span class="mh">0x50000000</span><span class="p">;</span>	<span class="cm">/* SRAM read command */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">sram_address</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_write_sram</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">u32</span> <span class="n">sram_address</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">value</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">count</span><span class="o">--</span><span class="p">;</span>		<span class="cm">/* count range now is 0..3 instead of 1..4 */</span>
	<span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* to use increments of 4 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">c</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">value</span><span class="o">++</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
	<span class="cm">/* Note: DR# registers are the first 4 dwords in nicstar&#39;s memspace,</span>
<span class="cm">	   so card-&gt;membase + DR0 == card-&gt;membase */</span>
	<span class="n">sram_address</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">sram_address</span> <span class="o">&amp;=</span> <span class="mh">0x0007FFFC</span><span class="p">;</span>
	<span class="n">sram_address</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x40000000</span> <span class="o">|</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">sram_address</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ns_init_card</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pci_latency</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">u32d</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ns_cfg_rctsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bcount</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">membase</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t enable PCI device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;nicstar%d: No suitable DMA available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">card</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ns_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t allocate memory for device structure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">i</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>
	<span class="n">membase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">membase</span><span class="p">,</span> <span class="n">NS_IOREMAP_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t ioremap() membase.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: membase at 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_latency</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t read PCI latency timer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef NS_PCI_LATENCY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_latency</span> <span class="o">&lt;</span> <span class="n">NS_PCI_LATENCY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: setting PCI latency timer to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="n">NS_PCI_LATENCY</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_byte</span>
			    <span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">NS_PCI_LATENCY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t set PCI latency timer to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">NS_PCI_LATENCY</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* NS_PCI_LATENCY */</span><span class="cp"></span>

	<span class="cm">/* Clear timer overflow */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">NS_STAT_TMROF</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_TMROF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>

	<span class="cm">/* Software reset */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NS_CFG_SWRST</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
	<span class="n">NS_DELAY</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>

	<span class="cm">/* PHY reset */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000008</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">GP</span><span class="p">);</span>
	<span class="n">NS_DELAY</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">GP</span><span class="p">);</span>
	<span class="n">NS_DELAY</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NS_CMD_WRITE_UTILITY</span> <span class="o">|</span> <span class="mh">0x00000100</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>	<span class="cm">/* Sync UTOPIA with SAR clock */</span>
	<span class="n">NS_DELAY</span><span class="p">;</span>

	<span class="cm">/* Detect PHY type */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NS_CMD_READ_UTILITY</span> <span class="o">|</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR0</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00000009</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: PHY seems to be 25 Mbps.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">max_pcr</span> <span class="o">=</span> <span class="n">ATM_25_PCR</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000008</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_CMD_WRITE_UTILITY</span> <span class="o">|</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
		<span class="cm">/* Clear an eventual pending interrupt */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_SFBQF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
<span class="cp">#ifdef PHY_LOOPBACK</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000022</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_CMD_WRITE_UTILITY</span> <span class="o">|</span> <span class="mh">0x00000202</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PHY_LOOPBACK */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x00000030</span>:
	<span class="k">case</span> <span class="mh">0x00000031</span>:
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: PHY seems to be 155 Mbps.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">max_pcr</span> <span class="o">=</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>
<span class="cp">#ifdef PHY_LOOPBACK</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000002</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_CMD_WRITE_UTILITY</span> <span class="o">|</span> <span class="mh">0x00000205</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PHY_LOOPBACK */</span><span class="cp"></span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: unknown PHY type (0x%08X).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">GP</span><span class="p">);</span>

	<span class="cm">/* Determine SRAM size */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="mh">0x76543210</span><span class="p">;</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mh">0x1C003</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="mh">0x89ABCDEF</span><span class="p">;</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mh">0x14003</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns_read_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mh">0x14003</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x89ABCDEF</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ns_read_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mh">0x1C003</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x76543210</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sram_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sram_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: %dK x 32bit SRAM size.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sram_size</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_size</span> <span class="o">=</span> <span class="n">NS_MAX_RCTSIZE</span><span class="p">;</span>

<span class="cp">#if (NS_MAX_RCTSIZE == 4096)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sram_size</span> <span class="o">==</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;nicstar%d: limiting maximum VCI. See NS_MAX_RCTSIZE in nicstar.h</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">i</span><span class="p">);</span>
<span class="cp">#elif (NS_MAX_RCTSIZE == 16384)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sram_size</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;nicstar%d: wasting memory. See NS_MAX_RCTSIZE in nicstar.h</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">i</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_size</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#error NS_MAX_RCTSIZE must be either 4096 or 16384 in nicstar.c</span>
<span class="cp">#endif</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span> <span class="o">=</span> <span class="n">NS_VPIBITS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_size</span> <span class="o">==</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">-</span> <span class="n">NS_VPIBITS</span><span class="p">;</span>
	<span class="k">else</span>			<span class="cm">/* card-&gt;rct_size == 16384 */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">=</span> <span class="mi">14</span> <span class="o">-</span> <span class="n">NS_VPIBITS</span><span class="p">;</span>

	<span class="cm">/* Initialize the nicstar eeprom/eprom stuff, for the MAC addr */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">nicstar_init_eprom</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>

	<span class="cm">/* Set the VPI/VCI MSb mask to zero so we can receive OAM cells */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">VPM</span><span class="p">);</span>

	<span class="cm">/* Initialize TSQ */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">org</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					     <span class="n">NS_TSQSIZE</span> <span class="o">+</span> <span class="n">NS_TSQ_ALIGNMENT</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">org</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t allocate TSQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">org</span><span class="p">,</span> <span class="n">NS_TSQ_ALIGNMENT</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">NS_TSQ_NUM_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NS_TSQ_NUM_ENTRIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns_tsi_init</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">TSQH</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ALIGN</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">NS_TSQ_ALIGNMENT</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">TSQB</span><span class="p">);</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: TSQ base at 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

	<span class="cm">/* Initialize RSQ */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">org</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					     <span class="n">NS_RSQSIZE</span> <span class="o">+</span> <span class="n">NS_RSQ_ALIGNMENT</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">org</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t allocate RSQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">org</span><span class="p">,</span> <span class="n">NS_RSQ_ALIGNMENT</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">NS_RSQ_NUM_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NS_RSQ_NUM_ENTRIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns_rsqe_init</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span> <span class="o">+</span> <span class="n">j</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">RSQH</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">ALIGN</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">NS_RSQ_ALIGNMENT</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">RSQB</span><span class="p">);</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: RSQ base at 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>

	<span class="cm">/* Initialize SCQ0, the only VBR SCQ used */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">scq1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">scq2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span> <span class="o">=</span> <span class="n">get_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">VBR_SCQSIZE</span><span class="p">,</span> <span class="n">NS_VRSCD0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t get SCQ0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">u32d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scq_virt_to_bus</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">u32d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">u32d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">u32d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">NS_VRSCD0</span><span class="p">,</span> <span class="n">u32d</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">NS_VRSCD1</span><span class="p">,</span> <span class="n">u32d</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* These last two won&#39;t be used */</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">NS_VRSCD2</span><span class="p">,</span> <span class="n">u32d</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* but are initialized, just in case... */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="o">-&gt;</span><span class="n">scd</span> <span class="o">=</span> <span class="n">NS_VRSCD0</span><span class="p">;</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: VBR-SCQ0 base at 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>

	<span class="cm">/* Initialize TSTs */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_addr</span> <span class="o">=</span> <span class="n">NS_TST0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free_entries</span> <span class="o">=</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">NS_TST_OPCODE_VARIABLE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">NS_TST0</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ns_tste_make</span><span class="p">(</span><span class="n">NS_TST_OPCODE_END</span><span class="p">,</span> <span class="n">NS_TST0</span><span class="p">);</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">NS_TST0</span> <span class="o">+</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">NS_TST1</span> <span class="o">+</span> <span class="n">j</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ns_tste_make</span><span class="p">(</span><span class="n">NS_TST_OPCODE_END</span><span class="p">,</span> <span class="n">NS_TST1</span><span class="p">);</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">NS_TST1</span> <span class="o">+</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tste2vc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NS_TST0</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">TSTB</span><span class="p">);</span>

	<span class="cm">/* Initialize RCT. AAL type is set on opening the VC. */</span>
<span class="cp">#ifdef RCQ_SUPPORT</span>
	<span class="n">u32d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">NS_RCTE_RAWCELLINTEN</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">u32d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* RCQ_SUPPORT */</span><span class="cp"></span>
	<span class="n">u32d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">u32d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">u32d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">u32d</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vcmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NS_MAX_RCTSIZE</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vc_map</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NS_FRSCD_NUM</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Initialize buffer levels */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MIN_SB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">NUM_SB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MAX_SB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MIN_LB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">NUM_LB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MAX_LB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MIN_IOVB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">NUM_IOVB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MAX_IOVB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">MIN_HB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">NUM_HB</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">MAX_HB</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sm_handle</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sm_addr</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lg_handle</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lg_addr</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">efbie</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* To prevent push_rxbufs from enabling the interrupt */</span>

	<span class="n">idr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">idr</span><span class="p">);</span>

	<span class="cm">/* Pre-allocate some huge buffers */</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_HB</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">hb</span><span class="p">;</span>
		<span class="n">hb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NS_HBUFSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t allocate %dth of %d huge buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">NUM_HB</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
			<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">hb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_NONE</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">hb</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate large buffers */</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Not used */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_LB</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lb</span><span class="p">;</span>
		<span class="n">lb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NS_LGSKBSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t allocate %dth of %d large buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">NUM_LB</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
			<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_LG</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">NS_SMBUFSIZE</span><span class="p">);</span>
		<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
		<span class="cm">/* Due to the implementation of push_rxbufs() this is 1, not 0 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcbuf</span> <span class="o">=</span> <span class="n">lb</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rawcell</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ns_rcqe</span> <span class="o">*</span><span class="p">)</span> <span class="n">lb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rawch</span> <span class="o">=</span> <span class="n">NS_PRV_DMA</span><span class="p">(</span><span class="n">lb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Test for strange behaviour which leads to crashes */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bcount</span> <span class="o">=</span>
	     <span class="n">ns_stat_lfbqc_get</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;nicstar%d: Strange... Just allocated %d large buffers and lfbqc = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">bcount</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate small buffers */</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Not used */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_SB</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
		<span class="n">sb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NS_SMSKBSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t allocate %dth of %d small buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">NUM_SB</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
			<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_SM</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NS_AAL0_HEADER</span><span class="p">);</span>
		<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Test for strange behaviour which leads to crashes */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bcount</span> <span class="o">=</span>
	     <span class="n">ns_stat_sfbqc_get</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">)))</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;nicstar%d: Strange... Just allocated %d small buffers and sfbqc = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">bcount</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate iovec buffers */</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NUM_IOVB</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iovb</span><span class="p">;</span>
		<span class="n">iovb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">NS_IOVBUFSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iovb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t allocate %dth of %d iovec buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">NUM_IOVB</span><span class="p">);</span>
			<span class="n">error</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_NONE</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">iovb</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure NICStAR */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rct_size</span> <span class="o">==</span> <span class="mi">4096</span><span class="p">)</span>
		<span class="n">ns_cfg_rctsize</span> <span class="o">=</span> <span class="n">NS_CFG_RCTSIZE_4096_ENTRIES</span><span class="p">;</span>
	<span class="k">else</span>			<span class="cm">/* (card-&gt;rct_size == 16384) */</span>
		<span class="n">ns_cfg_rctsize</span> <span class="o">=</span> <span class="n">NS_CFG_RCTSIZE_16384_ENTRIES</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">efbie</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">intcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span>
	    <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ns_irq_handler</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;nicstar&quot;</span><span class="p">,</span> <span class="n">card</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t allocate IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register device */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span> <span class="o">=</span> <span class="n">atm_dev_register</span><span class="p">(</span><span class="s">&quot;nicstar&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atm_ops</span><span class="p">,</span>
					<span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t register device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
		<span class="n">ns_init_card_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns_parse_mac</span><span class="p">(</span><span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">nicstar_read_eprom</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">,</span> <span class="n">NICSTAR_EPROM_MAC_ADDR_OFFSET</span><span class="p">,</span>
				   <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\x00\x00\x00\x00\x00\x00</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span>
		    <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nicstar_read_eprom</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">,</span>
					   <span class="n">NICSTAR_EPROM_MAC_ADDR_OFFSET_ALT</span><span class="p">,</span>
					   <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: MAC address %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">);</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">max_pcr</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ATM_NICSTAR_USE_SUNI</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">max_pcr</span> <span class="o">==</span> <span class="n">ATM_OC3_PCR</span><span class="p">)</span>
		<span class="n">suni_init</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_NICSTAR_USE_SUNI */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_ATM_NICSTAR_USE_IDT77105</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">max_pcr</span> <span class="o">==</span> <span class="n">ATM_25_PCR</span><span class="p">)</span>
		<span class="n">idt77105_init</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_NICSTAR_USE_IDT77105 */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">NS_CFG_RXPATH</span> <span class="o">|</span> <span class="n">NS_CFG_SMBUFSIZE</span> <span class="o">|</span> <span class="n">NS_CFG_LGBUFSIZE</span> <span class="o">|</span> <span class="n">NS_CFG_EFBIE</span> <span class="o">|</span> <span class="n">NS_CFG_RSQSIZE</span> <span class="o">|</span> <span class="n">NS_CFG_VPIBITS</span> <span class="o">|</span> <span class="n">ns_cfg_rctsize</span> <span class="o">|</span> <span class="n">NS_CFG_RXINT_NODELAY</span> <span class="o">|</span> <span class="n">NS_CFG_RAWIE</span> <span class="o">|</span>	<span class="cm">/* Only enabled if RCQ_SUPPORT */</span>
	       <span class="n">NS_CFG_RSQAFIE</span> <span class="o">|</span> <span class="n">NS_CFG_TXEN</span> <span class="o">|</span> <span class="n">NS_CFG_TXIE</span> <span class="o">|</span> <span class="n">NS_CFG_TSQFIE_OPT</span> <span class="o">|</span>	<span class="cm">/* Only enabled if ENABLE_TSQFIE */</span>
	       <span class="n">NS_CFG_PHYIE</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>

	<span class="n">num_cards</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">ns_init_card_error</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">17</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iovb</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">iovb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">iovb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">sb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
		<span class="n">free_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lb</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">lb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">lb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">hb</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">hb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">hb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">org</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">org</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">scq_info</span> <span class="o">*</span><span class="nf">get_scq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">u32</span> <span class="n">scd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">VBR_SCQSIZE</span> <span class="o">&amp;&amp;</span> <span class="n">size</span> <span class="o">!=</span> <span class="n">CBR_SCQSIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">scq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">scq_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scq</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">scq</span><span class="o">-&gt;</span><span class="n">org</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">org</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scq</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
			   <span class="p">(</span><span class="n">size</span> <span class="o">/</span> <span class="n">NS_SCQE_SIZE</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">org</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">scq</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="n">NS_SCQE_SIZE</span><span class="p">;</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">PTR_ALIGN</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">org</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span> <span class="o">=</span> <span class="n">scd</span><span class="p">;</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="n">NS_SCQE_SIZE</span><span class="p">;</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">tbd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scqfull_waitq</span><span class="p">);</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">scq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* For variable rate SCQ vcc must be NULL */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_scq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">==</span> <span class="n">VBR_SCQ_NUM_ENTRIES</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="k">else</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* vcc must be != NULL */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;nicstar: free_scq() called with vcc == NULL for fixed rate scq.&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
						<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="k">else</span>
						<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			    <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">==</span> <span class="n">VBR_SCQ_NUM_ENTRIES</span> <span class="o">?</span>
				 <span class="n">VBR_SCQSIZE</span> <span class="o">:</span> <span class="n">CBR_SCQSIZE</span><span class="p">),</span>
			    <span class="n">scq</span><span class="o">-&gt;</span><span class="n">org</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">scq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The handles passed must be pointers to the sk_buff containing the small</span>
<span class="cm">   or large buffer(s) cast to u32. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">push_rxbufs</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">handle1</span><span class="p">,</span> <span class="o">*</span><span class="n">handle2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* *BARF* */</span>
	<span class="n">handle2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">addr2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">handle1</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">addr1</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">BUF_SM</span>
				<span class="o">?</span> <span class="n">NS_SMSKBSIZE</span> <span class="o">:</span> <span class="n">NS_LGSKBSIZE</span><span class="p">),</span>
			       <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">NS_PRV_DMA</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">addr1</span><span class="p">;</span> <span class="cm">/* save so we can unmap later */</span>

<span class="cp">#ifdef GENERAL_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: push_rxbufs called with addr1 = 0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* GENERAL_DEBUG */</span><span class="cp"></span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">=</span> <span class="n">ns_stat_sfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">=</span> <span class="n">ns_stat_lfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">BUF_SM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sm_addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">addr2</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sm_addr</span><span class="p">;</span>
				<span class="n">handle2</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sm_handle</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sm_addr</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sm_handle</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* (!sm_addr) */</span>

				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sm_addr</span> <span class="o">=</span> <span class="n">addr1</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sm_handle</span> <span class="o">=</span> <span class="n">handle1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* buf_type == BUF_LG */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addr2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lg_addr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">addr2</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lg_addr</span><span class="p">;</span>
				<span class="n">handle2</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lg_handle</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">lg_addr</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">lg_handle</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* (!lg_addr) */</span>

				<span class="n">card</span><span class="o">-&gt;</span><span class="n">lg_addr</span> <span class="o">=</span> <span class="n">addr1</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">lg_handle</span> <span class="o">=</span> <span class="n">handle1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">BUF_SM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">&gt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_unlink</span><span class="p">(</span><span class="n">handle1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">handle1</span><span class="p">);</span>
				<span class="n">skb_unlink</span><span class="p">(</span><span class="n">handle2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">handle2</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* (buf_type == BUF_LG) */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">&gt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb_unlink</span><span class="p">(</span><span class="n">handle1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">handle1</span><span class="p">);</span>
				<span class="n">skb_unlink</span><span class="p">(</span><span class="n">handle2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">handle2</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idr_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">idr</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;nicstar%d: no free memory for idr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id1</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">idr_get_new_above</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">idr</span><span class="p">,</span> <span class="n">handle1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id2</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">idr_get_new_above</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">idr</span><span class="p">,</span> <span class="n">handle2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id2</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">addr2</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR3</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">id2</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR2</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">addr1</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR1</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">id1</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR0</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_CMD_WRITE_FREEBUFQ</span> <span class="o">|</span> <span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: Pushing %s buffers at 0x%x and 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
			<span class="p">(</span><span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">BUF_SM</span> <span class="o">?</span> <span class="s">&quot;small&quot;</span> <span class="o">:</span> <span class="s">&quot;large&quot;</span><span class="p">),</span>
			<span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">efbie</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">&gt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">min</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">&gt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">efbie</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">)</span> <span class="o">|</span> <span class="n">NS_CFG_EFBIE</span><span class="p">),</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ns_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat_r</span><span class="p">;</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">atmdev</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">intcnt</span><span class="o">++</span><span class="p">;</span>

	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: NICStAR generated an interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">stat_r</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>

	<span class="cm">/* Transmit Status Indicator has been written to T. S. Queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_TSIF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: TSI interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">process_tsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_TSIF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Incomplete CS-PDU has been transmitted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_TXICP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_TXICP</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: Incomplete CS-PDU transmitted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Transmit Status Queue 7/8 full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_TSQF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_TSQF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: TSQ full.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">process_tsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Timer overflow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_TMROF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_TMROF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: Timer overflow.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* PHY device interrupt signal active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_PHYI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_PHYI</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: PHY interrupt.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Small Buffer Queue is full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_SFBQF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_SFBQF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Small free buffer queue is full.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Large Buffer Queue is full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_LFBQF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_LFBQF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Large free buffer queue is full.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Receive Status Queue is full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_RSQF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_RSQF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: RSQ full.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">process_rsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Complete CS-PDU received */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_EOPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: End of CS-PDU received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">process_rsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_EOPDU</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Raw cell received */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_RAWCF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_RAWCF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
<span class="cp">#ifndef RCQ_SUPPORT</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Raw cell received and no support yet...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* RCQ_SUPPORT */</span><span class="cp"></span>
		<span class="cm">/* NOTE: the following procedure may keep a raw cell pending until the</span>
<span class="cm">		   next interrupt. As this preliminary support is only meant to</span>
<span class="cm">		   avoid buffer leakage, this is not an issue. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">RAWCT</span><span class="p">)</span> <span class="o">!=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rawch</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ns_rcqe_islast</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rawcell</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">oldbuf</span><span class="p">;</span>

				<span class="n">oldbuf</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rcbuf</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcbuf</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">idr</span><span class="p">,</span>
						       <span class="n">ns_rcqe_nextbufhandle</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rawcell</span><span class="p">));</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rawch</span> <span class="o">=</span> <span class="n">NS_PRV_DMA</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rcbuf</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rawcell</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ns_rcqe</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">rcbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="n">recycle_rx_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">oldbuf</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rawch</span> <span class="o">+=</span> <span class="n">NS_RCQE_SIZE</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">rawcell</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Small buffer queue is empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_SFBQE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_SFBQE</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Small free buffer queue empty.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_SMSKBSIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">)</span> <span class="o">&amp;</span>
				       <span class="o">~</span><span class="n">NS_CFG_EFBIE</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">efbie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_SM</span><span class="p">;</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NS_AAL0_HEADER</span><span class="p">);</span>
			<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">process_rsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Large buffer queue empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_LFBQE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lb</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_LFBQE</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Large free buffer queue empty.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">min</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_LGSKBSIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">)</span> <span class="o">&amp;</span>
				       <span class="o">~</span><span class="n">NS_CFG_EFBIE</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">efbie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_LG</span><span class="p">;</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">NS_SMBUFSIZE</span><span class="p">);</span>
			<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">process_rsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Receive Status Queue is 7/8 full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_RSQAF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_STAT_RSQAF</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: RSQ almost full.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">process_rsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: end of interrupt service</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ns_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmpl</span><span class="p">,</span> <span class="n">modl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tcr</span><span class="p">,</span> <span class="n">tcra</span><span class="p">;</span>		<span class="cm">/* target cell rate, and absolute value */</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Number of entries in the TST. Initialized to remove</span>
<span class="cm">				   the compiler warning. */</span>
	<span class="n">u32</span> <span class="n">u32d</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">frscdi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Index of the SCD. Initialized to remove the compiler</span>
<span class="cm">				   warning. How I wish compilers were clever enough to</span>
<span class="cm">				   tell which variables can truly be used</span>
<span class="cm">				   uninitialized... */</span>
	<span class="kt">int</span> <span class="n">inuse</span><span class="p">;</span>		<span class="cm">/* tx or rx vc already in use by another vcc */</span>
	<span class="kt">short</span> <span class="n">vpi</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vci</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: opening vpi.vci %d.%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vpi</span><span class="p">,</span>
	       <span class="n">vci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: unsupported AAL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vcmap</span><span class="p">[</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">|</span> <span class="n">vci</span><span class="p">]);</span>
	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>

	<span class="n">inuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span>
		<span class="n">inuse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span>
		<span class="n">inuse</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: %s vci already in use.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
		       <span class="n">inuse</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;tx&quot;</span> <span class="o">:</span> <span class="n">inuse</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="s">&quot;rx&quot;</span> <span class="o">:</span> <span class="s">&quot;tx and rx&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* NOTE: You are not allowed to modify an open connection&#39;s QOS. To change</span>
<span class="cm">	   that, remove the ATM_VF_PARTIAL flag checking. There may be other changes</span>
<span class="cm">	   needed to do that. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">;</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check requested cell rate and availability of SCD */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">==</span> <span class="mi">0</span>
			    <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PRINTK</span>
				    <span class="p">(</span><span class="s">&quot;nicstar%d: trying to open a CBR vc with cell rate = 0 </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">tcr</span> <span class="o">=</span> <span class="n">atm_pcr_goal</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">));</span>
			<span class="n">tcra</span> <span class="o">=</span> <span class="n">tcr</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">tcr</span> <span class="o">:</span> <span class="o">-</span><span class="n">tcr</span><span class="p">;</span>

			<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: target cell rate = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">);</span>

			<span class="n">tmpl</span> <span class="o">=</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tcra</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
			    <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">;</span>
			<span class="n">modl</span> <span class="o">=</span> <span class="n">tmpl</span> <span class="o">%</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">max_pcr</span><span class="p">;</span>

			<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">tmpl</span> <span class="o">/</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">max_pcr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">modl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">n</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">=</span>
				     <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free_entries</span> <span class="o">-</span>
				      <span class="n">NS_TST_RESERVED</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">PRINTK</span>
					    <span class="p">(</span><span class="s">&quot;nicstar%d: no CBR bandwidth free.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;nicstar%d: selected bandwidth &lt; granularity.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free_entries</span> <span class="o">-</span> <span class="n">NS_TST_RESERVED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">PRINTK</span>
				    <span class="p">(</span><span class="s">&quot;nicstar%d: not enough free CBR bandwidth.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free_entries</span> <span class="o">-=</span> <span class="n">n</span><span class="p">;</span>

			<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: writing %d tst entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">frscdi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">frscdi</span> <span class="o">&lt;</span> <span class="n">NS_FRSCD_NUM</span><span class="p">;</span> <span class="n">frscdi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">frscdi</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">frscdi</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frscdi</span> <span class="o">==</span> <span class="n">NS_FRSCD_NUM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PRINTK</span>
				    <span class="p">(</span><span class="s">&quot;nicstar%d: no SCD available for CBR channel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free_entries</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">cbr_scd</span> <span class="o">=</span> <span class="n">NS_FRSCD</span> <span class="o">+</span> <span class="n">frscdi</span> <span class="o">*</span> <span class="n">NS_FRSCD_SIZE</span><span class="p">;</span>

			<span class="n">scq</span> <span class="o">=</span> <span class="n">get_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">CBR_SCQSIZE</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cbr_scd</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: can&#39;t get fixed rate SCQ.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">frscdi</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free_entries</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span> <span class="o">=</span> <span class="n">scq</span><span class="p">;</span>
			<span class="n">u32d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">scq_virt_to_bus</span><span class="p">(</span><span class="n">scq</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
			<span class="n">u32d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">u32d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0xffffffff</span><span class="p">;</span>
			<span class="n">u32d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cbr_scd</span><span class="p">,</span> <span class="n">u32d</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">fill_tst</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">vc</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_UBR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">cbr_scd</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx_vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">tbd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* Open the connection in hardware */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL5</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">NS_RCTE_AAL5</span> <span class="o">|</span> <span class="n">NS_RCTE_CONNECTOPEN</span><span class="p">;</span>
			<span class="k">else</span>	<span class="cm">/* vcc-&gt;qos.aal == ATM_AAL0 */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">NS_RCTE_AAL0</span> <span class="o">|</span> <span class="n">NS_RCTE_CONNECTOPEN</span><span class="p">;</span>
<span class="cp">#ifdef RCQ_SUPPORT</span>
			<span class="n">status</span> <span class="o">|=</span> <span class="n">NS_RCTE_RAWCELLINTEN</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* RCQ_SUPPORT */</span><span class="cp"></span>
			<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
				      <span class="n">NS_RCT</span> <span class="o">+</span>
				      <span class="p">(</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">|</span> <span class="n">vci</span><span class="p">)</span> <span class="o">*</span>
				      <span class="n">NS_RCT_ENTRY_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vc</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: closing vpi.vci %d.%d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">addr</span> <span class="o">=</span>
		    <span class="n">NS_RCT</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">)</span> <span class="o">*</span> <span class="n">NS_RCT_ENTRY_SIZE</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">NS_CMD_CLOSE_CONNECTION</span> <span class="o">|</span> <span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iovb</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

			<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">=</span> <span class="n">ns_stat_sfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">=</span> <span class="n">ns_stat_lfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>

			<span class="n">PRINTK</span>
			    <span class="p">(</span><span class="s">&quot;nicstar%d: closing a VC with pending rx buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">iovb</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span><span class="p">;</span>
			<span class="n">recycle_iovec_rx_bufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span><span class="n">iovb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">));</span>
			<span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">recycle_iov_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iovb</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">ns_scqe</span> <span class="o">*</span><span class="n">scqep</span><span class="p">;</span>
		<span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">;</span>

		<span class="n">scq</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">scqep</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scqep</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span>
				<span class="n">scqep</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">scqep</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scqep</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* If the last entry is not a TSR, place one in the SCQ in order to</span>
<span class="cm">			   be able to completely drain it and then close. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns_scqe_is_tsr</span><span class="p">(</span><span class="n">scqep</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">!=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ns_scqe</span> <span class="n">tsr</span><span class="p">;</span>
				<span class="n">u32</span> <span class="n">scdi</span><span class="p">,</span> <span class="n">scqi</span><span class="p">;</span>
				<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

				<span class="n">tsr</span><span class="p">.</span><span class="n">word_1</span> <span class="o">=</span> <span class="n">ns_tsr_mkword_1</span><span class="p">(</span><span class="n">NS_TSR_INTENABLE</span><span class="p">);</span>
				<span class="n">scdi</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">cbr_scd</span> <span class="o">-</span> <span class="n">NS_FRSCD</span><span class="p">)</span> <span class="o">/</span> <span class="n">NS_FRSCD_SIZE</span><span class="p">;</span>
				<span class="n">scqi</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">-</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
				<span class="n">tsr</span><span class="p">.</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">ns_tsr_mkword_2</span><span class="p">(</span><span class="n">scdi</span><span class="p">,</span> <span class="n">scqi</span><span class="p">);</span>
				<span class="n">tsr</span><span class="p">.</span><span class="n">word_3</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
				<span class="n">tsr</span><span class="p">.</span><span class="n">word_4</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
				<span class="o">*</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tsr</span><span class="p">;</span>
				<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scqi</span><span class="p">;</span>
				<span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span>
					<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">scq_virt_to_bus</span><span class="p">(</span><span class="n">scq</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
				<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="cm">/* Free all TST entries */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">NS_TST_OPCODE_VARIABLE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tste2vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">vc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span>
					      <span class="mi">1</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">tste2vc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_free_entries</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">cbr_scd</span> <span class="o">-</span> <span class="n">NS_FRSCD</span><span class="p">)</span> <span class="o">/</span> <span class="n">NS_FRSCD_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">free_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">,</span> <span class="n">vcc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* remove all references to vcc before deleting it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">==</span> <span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">atm_return</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>
				<span class="n">PRINTK</span>
				    <span class="p">(</span><span class="s">&quot;nicstar: deleted pending vcc mapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#ifdef RX_DEBUG</span>
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">stat</span><span class="p">,</span> <span class="n">cfg</span><span class="p">;</span>
		<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CFG</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;STAT = 0x%08X  CFG = 0x%08X  </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;TSQ: base = 0x%p  next = 0x%p  last = 0x%p  TSQT = 0x%08X </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
		     <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">TSQT</span><span class="p">));</span>
		<span class="n">printk</span>
		    <span class="p">(</span><span class="s">&quot;RSQ: base = 0x%p  next = 0x%p  last = 0x%p  RSQT = 0x%08X </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
		     <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">last</span><span class="p">,</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">RSQT</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Empty free buffer queue interrupt %s </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">efbie</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SBCNT = %d  count = %d   LBCNT = %d count = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ns_stat_sfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">count</span><span class="p">,</span>
		       <span class="n">ns_stat_lfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;hbpool.count = %d  iovpool.count = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* RX_DEBUG */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_tst</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">vc_map</span> <span class="o">*</span> <span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">new_tst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">e</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* It would be very complicated to keep the two TSTs synchronized while</span>
<span class="cm">	   assuring that writes are only made to the inactive TST. So, for now I</span>
<span class="cm">	   will use only one TST. If problems occur, I will change this again */</span>

	<span class="n">new_tst</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_addr</span><span class="p">;</span>

	<span class="cm">/* Fill procedure */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">e</span> <span class="o">&lt;</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">;</span> <span class="n">e</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tste2vc</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: No free TST entries found. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">cl</span> <span class="o">=</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">ns_tste_make</span><span class="p">(</span><span class="n">NS_TST_OPCODE_FIXED</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">cbr_scd</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cl</span> <span class="o">&gt;=</span> <span class="n">NS_TST_NUM_ENTRIES</span> <span class="o">&amp;&amp;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tste2vc</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">tste2vc</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
			<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">new_tst</span> <span class="o">+</span> <span class="n">e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">cl</span> <span class="o">-=</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">;</span>
			<span class="n">r</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">e</span> <span class="o">==</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cl</span> <span class="o">+=</span> <span class="n">n</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* End of fill procedure */</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">ns_tste_make</span><span class="p">(</span><span class="n">NS_TST_OPCODE_END</span><span class="p">,</span> <span class="n">new_tst</span><span class="p">);</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">new_tst</span> <span class="o">+</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_addr</span> <span class="o">+</span> <span class="n">NS_TST_NUM_ENTRIES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">tst_addr</span> <span class="o">=</span> <span class="n">new_tst</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ns_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="n">ns_scqe</span> <span class="n">scqe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* TBD flags, not CPU flags */</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">TXPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: ns_send() called.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vc</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc_map</span> <span class="o">*</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: vcc-&gt;dev_data == NULL on ns_send().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Trying to transmit on a non-tx VC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Only AAL0 and AAL5 are supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: No scatter-gather yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>

	<span class="n">NS_PRV_DMA</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buflen</span> <span class="o">=</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">47</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48</span> <span class="o">*</span> <span class="mi">48</span><span class="p">;</span>	<span class="cm">/* Multiple of 48 */</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">NS_TBD_AAL5</span><span class="p">;</span>
		<span class="n">scqe</span><span class="p">.</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NS_PRV_DMA</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">scqe</span><span class="p">.</span><span class="n">word_3</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">scqe</span><span class="p">.</span><span class="n">word_4</span> <span class="o">=</span>
		    <span class="n">ns_tbd_mkword_4</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span>
				    <span class="n">atm_options</span> <span class="o">&amp;</span> <span class="n">ATM_ATMOPT_CLP</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">NS_TBD_EOPDU</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* (vcc-&gt;qos.aal == ATM_AAL0) */</span>

		<span class="n">buflen</span> <span class="o">=</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>	<span class="cm">/* i.e., 48 bytes */</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">NS_TBD_AAL0</span><span class="p">;</span>
		<span class="n">scqe</span><span class="p">.</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NS_PRV_DMA</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">NS_AAL0_HEADER</span><span class="p">);</span>
		<span class="n">scqe</span><span class="p">.</span><span class="n">word_3</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>	<span class="cm">/* Payload type 1 - end of pdu */</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">NS_TBD_EOPDU</span><span class="p">;</span>
		<span class="n">scqe</span><span class="p">.</span><span class="n">word_4</span> <span class="o">=</span>
		    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">NS_TBD_VC_MASK</span><span class="p">);</span>
		<span class="cm">/* Force the VPI/VCI to be the same as in VCC struct */</span>
		<span class="n">scqe</span><span class="p">.</span><span class="n">word_4</span> <span class="o">|=</span>
		    <span class="n">cpu_to_le32</span><span class="p">((((</span><span class="n">u32</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span>
				  <span class="n">vpi</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">NS_TBD_VPI_SHIFT</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span>
							      <span class="n">vci</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				 <span class="n">NS_TBD_VCI_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">NS_TBD_VC_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scqe</span><span class="p">.</span><span class="n">word_1</span> <span class="o">=</span> <span class="n">ns_tbd_mkword_1_novbr</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="n">scq</span> <span class="o">=</span> <span class="p">((</span><span class="n">vc_map</span> <span class="o">*</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scqe</span><span class="p">.</span><span class="n">word_1</span> <span class="o">=</span>
		    <span class="n">ns_tbd_mkword_1</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="n">scq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">push_scqe</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">vc</span><span class="p">,</span> <span class="n">scq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scqe</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_err</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">push_scqe</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">vc_map</span> <span class="o">*</span> <span class="n">vc</span><span class="p">,</span> <span class="n">scq_info</span> <span class="o">*</span> <span class="n">scq</span><span class="p">,</span> <span class="n">ns_scqe</span> <span class="o">*</span> <span class="n">tbd</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">ns_scqe</span> <span class="n">tsr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scdi</span><span class="p">,</span> <span class="n">scqi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scq_is_vbr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Error pushing TBD.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scq</span><span class="o">-&gt;</span><span class="n">full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scqfull_waitq</span><span class="p">,</span>
					       <span class="n">SCQFULL_TIMEOUT</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Timeout pushing TBD.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="o">*</span><span class="n">tbd</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">-</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: sending skb at 0x%p (pos %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: TBD written:</span><span class="se">\n</span><span class="s">0x%x</span><span class="se">\n</span><span class="s">0x%x</span><span class="se">\n</span><span class="s">0x%x</span><span class="se">\n</span><span class="s">0x%x</span><span class="se">\n</span><span class="s"> at 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_2</span><span class="p">),</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_3</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tbd</span><span class="o">-&gt;</span><span class="n">word_4</span><span class="p">),</span>
		<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span>
		<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>

	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">tbd_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span> <span class="o">==</span> <span class="n">VBR_SCQ_NUM_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scq</span><span class="o">-&gt;</span><span class="n">tbd_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">scq_is_vbr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">scq_is_vbr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">tbd_count</span> <span class="o">&gt;=</span> <span class="n">MAX_TBD_PER_VC</span>
	    <span class="o">||</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">tbd_count</span> <span class="o">&gt;=</span> <span class="n">MAX_TBD_PER_SCQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">has_run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">data</span> <span class="o">=</span> <span class="n">scq_virt_to_bus</span><span class="p">(</span><span class="n">scq</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
				<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Error pushing TSR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">scq</span><span class="o">-&gt;</span><span class="n">full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">has_run</span><span class="o">++</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scqfull_waitq</span><span class="p">,</span>
						       <span class="n">SCQFULL_TIMEOUT</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tsr</span><span class="p">.</span><span class="n">word_1</span> <span class="o">=</span> <span class="n">ns_tsr_mkword_1</span><span class="p">(</span><span class="n">NS_TSR_INTENABLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scq_is_vbr</span><span class="p">)</span>
				<span class="n">scdi</span> <span class="o">=</span> <span class="n">NS_TSR_SCDISVBR</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">scdi</span> <span class="o">=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">cbr_scd</span> <span class="o">-</span> <span class="n">NS_FRSCD</span><span class="p">)</span> <span class="o">/</span> <span class="n">NS_FRSCD_SIZE</span><span class="p">;</span>
			<span class="n">scqi</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">-</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="n">tsr</span><span class="p">.</span><span class="n">word_2</span> <span class="o">=</span> <span class="n">ns_tsr_mkword_2</span><span class="p">(</span><span class="n">scdi</span><span class="p">,</span> <span class="n">scqi</span><span class="p">);</span>
			<span class="n">tsr</span><span class="p">.</span><span class="n">word_3</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">tsr</span><span class="p">.</span><span class="n">word_4</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>

			<span class="o">*</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tsr</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scqi</span><span class="p">;</span>
			<span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">XPRINTK</span>
			    <span class="p">(</span><span class="s">&quot;nicstar%d: TSR written:</span><span class="se">\n</span><span class="s">0x%x</span><span class="se">\n</span><span class="s">0x%x</span><span class="se">\n</span><span class="s">0x%x</span><span class="se">\n</span><span class="s">0x%x</span><span class="se">\n</span><span class="s"> at 0x%p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsr</span><span class="p">.</span><span class="n">word_1</span><span class="p">),</span>
			     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsr</span><span class="p">.</span><span class="n">word_2</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsr</span><span class="p">.</span><span class="n">word_3</span><span class="p">),</span>
			     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsr</span><span class="p">.</span><span class="n">word_4</span><span class="p">),</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span>
				<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">tbd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">scq</span><span class="o">-&gt;</span><span class="n">tbd_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: Timeout pushing TSR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">scq_virt_to_bus</span><span class="p">(</span><span class="n">scq</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="n">ns_write_sram</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">scd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_tsq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">scdi</span><span class="p">;</span>
	<span class="n">scq_info</span> <span class="o">*</span><span class="n">scq</span><span class="p">;</span>
	<span class="n">ns_tsi</span> <span class="o">*</span><span class="n">previous</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">one_ahead</span><span class="p">,</span> <span class="o">*</span><span class="n">two_ahead</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">serviced_entries</span><span class="p">;</span>	<span class="cm">/* flag indicating at least on entry was serviced */</span>

	<span class="n">serviced_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
		<span class="n">one_ahead</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">one_ahead</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">one_ahead</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
		<span class="n">two_ahead</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">two_ahead</span> <span class="o">=</span> <span class="n">one_ahead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ns_tsi_isempty</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">ns_tsi_isempty</span><span class="p">(</span><span class="n">one_ahead</span><span class="p">)</span> <span class="o">||</span>
	       <span class="o">!</span><span class="n">ns_tsi_isempty</span><span class="p">(</span><span class="n">two_ahead</span><span class="p">))</span>
		<span class="cm">/* At most two empty, as stated in the 77201 errata */</span>
	<span class="p">{</span>
		<span class="n">serviced_entries</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Skip the one or two possible empty entries */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">ns_tsi_isempty</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns_tsi_tmrof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">scdi</span> <span class="o">=</span> <span class="n">ns_tsi_getscdindex</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scdi</span> <span class="o">==</span> <span class="n">NS_TSI_SCDISVBR</span><span class="p">)</span>
				<span class="n">scq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scq0</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">scdi</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;nicstar%d: could not find VC from SCD index.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
					<span class="n">ns_tsi_init</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">scq</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">scd2vc</span><span class="p">[</span><span class="n">scdi</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">scq</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">drain_scq</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">scq</span><span class="p">,</span> <span class="n">ns_tsi_getscqpos</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">));</span>
			<span class="n">scq</span><span class="o">-&gt;</span><span class="n">full</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">scqfull_waitq</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">ns_tsi_init</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">previous</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
			<span class="n">one_ahead</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">one_ahead</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">one_ahead</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
			<span class="n">two_ahead</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">two_ahead</span> <span class="o">=</span> <span class="n">one_ahead</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">serviced_entries</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">PTR_DIFF</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">tsq</span><span class="p">.</span><span class="n">base</span><span class="p">),</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">TSQH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drain_scq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">scq_info</span> <span class="o">*</span> <span class="n">scq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: drain_scq() called, scq at 0x%p, pos %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">scq</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Bad index on drain_scq().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">-</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">XPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: freeing skb at 0x%p (index %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					 <span class="n">NS_PRV_DMA</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
					 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
					 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">scq</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">==</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">num_entries</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">scq</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_rsq</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_rsqe</span> <span class="o">*</span><span class="n">previous</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns_rsqe_valid</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">dequeue_rx</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">ns_rsqe_init</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">previous</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">ns_rsqe_valid</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">next</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">PTR_DIFF</span><span class="p">(</span><span class="n">previous</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rsq</span><span class="p">.</span><span class="n">base</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">RSQH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dequeue_rx</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="n">ns_rsqe</span> <span class="o">*</span> <span class="n">rsqe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">;</span>
	<span class="n">vc_map</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iovb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">aal5_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">=</span> <span class="n">ns_stat_sfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">=</span> <span class="n">ns_stat_lfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">buffer_handle</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">idr</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RXPRINTK</span><span class="p">(</span><span class="n">KERN_ERR</span>
			 <span class="s">&quot;nicstar%d: idr_find() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">idr</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
        <span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				    <span class="n">NS_PRV_DMA</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">BUF_SM</span>
				     <span class="o">?</span> <span class="n">NS_SMSKBSIZE</span> <span class="o">:</span> <span class="n">NS_LGSKBSIZE</span><span class="p">),</span>
				    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
			 <span class="n">NS_PRV_DMA</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
			 <span class="p">(</span><span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">BUF_SM</span>
			  <span class="o">?</span> <span class="n">NS_SMSKBSIZE</span> <span class="o">:</span> <span class="n">NS_LGSKBSIZE</span><span class="p">),</span>
			 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">vpi</span> <span class="o">=</span> <span class="n">ns_rsqe_vpi</span><span class="p">(</span><span class="n">rsqe</span><span class="p">);</span>
	<span class="n">vci</span> <span class="o">=</span> <span class="n">ns_rsqe_vci</span><span class="p">(</span><span class="n">rsqe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">&gt;=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vpibits</span> <span class="o">||</span> <span class="n">vci</span> <span class="o">&gt;=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: SDU received for out-of-range vc %d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="n">recycle_rx_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">vcmap</span><span class="p">[</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">vcibits</span> <span class="o">|</span> <span class="n">vci</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RXPRINTK</span><span class="p">(</span><span class="s">&quot;nicstar%d: SDU received on non-rx vc %d.%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="n">recycle_rx_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vcc</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_vcc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cell</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">cell</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ns_rsqe_cellcount</span><span class="p">(</span><span class="n">rsqe</span><span class="p">);</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_SMSKBSIZE</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span>
				    <span class="p">(</span><span class="s">&quot;nicstar%d: Can&#39;t allocate buffers for aal0.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">atomic_add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RXPRINTK</span>
				    <span class="p">(</span><span class="s">&quot;nicstar%d: atm_charge() dropped aal0 packets.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">atomic_add</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>	<span class="cm">/* already increased by 1 */</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Rebuild the header */</span>
			<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rsqe</span><span class="o">-&gt;</span><span class="n">word_1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">ns_rsqe_clp</span><span class="p">(</span><span class="n">rsqe</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00000001</span> <span class="o">:</span> <span class="mh">0x00000000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ns_rsqe_eopdu</span><span class="p">(</span><span class="n">rsqe</span><span class="p">))</span>
				<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">|=</span> <span class="mh">0x00000002</span><span class="p">;</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NS_AAL0_HEADER</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">sb</span><span class="p">),</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">);</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">);</span>
			<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
			<span class="n">cell</span> <span class="o">+=</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">recycle_rx_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* To reach this point, the AAL layer can only be AAL5 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">iovb</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iovb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">queue</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iovb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* No buffers in the queue */</span>
			<span class="n">iovb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">NS_IOVBUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">iovb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: Out of iovec buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
				<span class="n">recycle_rx_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_NONE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_iovb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">new_iovb</span> <span class="o">=</span>
			     <span class="n">alloc_skb</span><span class="p">(</span><span class="n">NS_IOVBUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_NONE</span><span class="p">;</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">new_iovb</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span> <span class="o">=</span> <span class="n">iovb</span><span class="p">;</span>
		<span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iovb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iovb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">iovb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">iovb</span><span class="p">);</span>
		<span class="cm">/* IMPORTANT: a pointer to the sk_buff containing the small or large</span>
<span class="cm">		   buffer is stored as iovec base, NOT a pointer to the</span>
<span class="cm">		   small or large buffer itself. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">NS_MAX_IOVECS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: received too big AAL5 SDU.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
		<span class="n">recycle_iovec_rx_bufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span><span class="n">iovb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				      <span class="n">NS_MAX_IOVECS</span><span class="p">);</span>
		<span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iovb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iovb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">iovb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="n">skb_reset_tail_pointer</span><span class="p">(</span><span class="n">iovb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iov</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span><span class="n">iovb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)[</span><span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span><span class="o">++</span><span class="p">];</span>
	<span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">=</span> <span class="n">ns_rsqe_cellcount</span><span class="p">(</span><span class="n">rsqe</span><span class="p">)</span> <span class="o">*</span> <span class="mi">48</span><span class="p">;</span>
	<span class="n">iovb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+=</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>

<span class="cp">#ifdef EXTRA_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BUF_SM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;nicstar%d: Expected a small buffer, and this is not one.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">which_list</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
			<span class="n">recycle_rx_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">recycle_iov_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iovb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>		<span class="cm">/* NS_PRV_IOVCNT(iovb) &gt;= 2 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BUF_LG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span>
			    <span class="p">(</span><span class="s">&quot;nicstar%d: Expected a large buffer, and this is not one.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">which_list</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
			<span class="n">recycle_iovec_rx_bufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span><span class="n">iovb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">));</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">recycle_iov_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iovb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* EXTRA_DEBUG */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ns_rsqe_eopdu</span><span class="p">(</span><span class="n">rsqe</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This works correctly regardless of the endianness of the host */</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">L1L2</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
						<span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">aal5_len</span> <span class="o">=</span> <span class="n">L1L2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">L1L2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">aal5_len</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x10000</span> <span class="o">:</span> <span class="n">aal5_len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ns_rsqe_crcerr</span><span class="p">(</span><span class="n">rsqe</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">len</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">iovb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">||</span> <span class="n">len</span> <span class="o">+</span> <span class="p">(</span><span class="mi">47</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">iovb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: AAL5 CRC error&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">&gt;</span> <span class="n">iovb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">||</span> <span class="n">len</span> <span class="o">+</span> <span class="p">(</span><span class="mi">47</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">iovb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; - PDU size mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
			<span class="n">recycle_iovec_rx_bufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span><span class="n">iovb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">));</span>
			<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">recycle_iov_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iovb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* By this point we (hopefully) have a complete SDU without errors. */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Just a small buffer */</span>
			<span class="cm">/* skb points to a small buffer */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="n">dequeue_sm_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#ifdef NS_USE_DESTRUCTORS</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">ns_sb_destructor</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* NS_USE_DESTRUCTORS */</span><span class="cp"></span>
				<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
				<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* One small plus one large buffer */</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

			<span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)(</span><span class="n">iov</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">;</span>
			<span class="cm">/* skb points to a large buffer */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">NS_SMBUFSIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">sb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
					<span class="n">dequeue_sm_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
<span class="cp">#ifdef NS_USE_DESTRUCTORS</span>
					<span class="n">sb</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">ns_sb_destructor</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* NS_USE_DESTRUCTORS */</span><span class="cp"></span>
					<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
					<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">sb</span><span class="p">);</span>
					<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* len &gt; NS_SMBUFSIZE, the usual case */</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dequeue_lg_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="cp">#ifdef NS_USE_DESTRUCTORS</span>
					<span class="n">skb</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">ns_lb_destructor</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* NS_USE_DESTRUCTORS */</span><span class="cp"></span>
					<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NS_SMBUFSIZE</span><span class="p">);</span>
					<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
								  <span class="n">NS_SMBUFSIZE</span><span class="p">);</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">NS_SMBUFSIZE</span><span class="p">);</span>
					<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
					<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>

			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* Must push a huge buffer */</span>

			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">hb</span><span class="p">,</span> <span class="o">*</span><span class="n">sb</span><span class="p">,</span> <span class="o">*</span><span class="n">lb</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">hb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* No buffers in the queue */</span>

				<span class="n">hb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_HBUFSIZE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;nicstar%d: Out of huge buffers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
					<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
					<span class="n">recycle_iovec_rx_bufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
							      <span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span>
							      <span class="n">iovb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							      <span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">));</span>
					<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="n">recycle_iov_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iovb</span><span class="p">);</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_hb</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">new_hb</span> <span class="o">=</span>
					     <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_HBUFSIZE</span><span class="p">))</span> <span class="o">!=</span>
					    <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span>
							       <span class="n">queue</span><span class="p">,</span> <span class="n">new_hb</span><span class="p">);</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">hb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_NONE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_hb</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">new_hb</span> <span class="o">=</span>
				     <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_HBUFSIZE</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">new_hb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_NONE</span><span class="p">;</span>
					<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span>
						       <span class="n">new_hb</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">min</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">new_hb</span> <span class="o">=</span>
					     <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_HBUFSIZE</span><span class="p">))</span> <span class="o">!=</span>
					    <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">new_hb</span><span class="p">)</span> <span class="o">=</span>
						    <span class="n">BUF_NONE</span><span class="p">;</span>
						<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span>
							       <span class="n">queue</span><span class="p">,</span> <span class="n">new_hb</span><span class="p">);</span>
						<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">iov</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="p">)</span><span class="n">iovb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">hb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">recycle_iovec_rx_bufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iov</span><span class="p">,</span>
						      <span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">hb</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">hb</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Copy the small buffer to the huge buffer */</span>
				<span class="n">sb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">;</span>
				<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">hb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							  <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">);</span>
				<span class="n">skb_put</span><span class="p">(</span><span class="n">hb</span><span class="p">,</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">);</span>
				<span class="n">remaining</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">;</span>
				<span class="n">iov</span><span class="o">++</span><span class="p">;</span>
				<span class="cm">/* Free the small buffer */</span>
				<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>

				<span class="cm">/* Copy all large buffers to the huge buffer and free them */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">NS_PRV_IOVCNT</span><span class="p">(</span><span class="n">iovb</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">lb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">;</span>
					<span class="n">tocopy</span> <span class="o">=</span>
					    <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">remaining</span><span class="p">,</span> <span class="n">iov</span><span class="o">-&gt;</span><span class="n">iov_len</span><span class="p">);</span>
					<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span>
								  <span class="n">skb_tail_pointer</span>
								  <span class="p">(</span><span class="n">hb</span><span class="p">),</span> <span class="n">tocopy</span><span class="p">);</span>
					<span class="n">skb_put</span><span class="p">(</span><span class="n">hb</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">);</span>
					<span class="n">iov</span><span class="o">++</span><span class="p">;</span>
					<span class="n">remaining</span> <span class="o">-=</span> <span class="n">tocopy</span><span class="p">;</span>
					<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
				<span class="p">}</span>
<span class="cp">#ifdef EXTRA_DEBUG</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">remaining</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">hb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;nicstar%d: Huge buffer len mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* EXTRA_DEBUG */</span><span class="cp"></span>
				<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">hb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
<span class="cp">#ifdef NS_USE_DESTRUCTORS</span>
				<span class="n">hb</span><span class="o">-&gt;</span><span class="n">destructor</span> <span class="o">=</span> <span class="n">ns_hb_destructor</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* NS_USE_DESTRUCTORS */</span><span class="cp"></span>
				<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">hb</span><span class="p">);</span>
				<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">hb</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">rx_iov</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">recycle_iov_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">iovb</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cp">#ifdef NS_USE_DESTRUCTORS</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_sb_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">=</span> <span class="n">ns_stat_sfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">=</span> <span class="n">ns_stat_lfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">sb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NS_SMSKBSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_SM</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NS_AAL0_HEADER</span><span class="p">);</span>
		<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">min</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_lb_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">=</span> <span class="n">ns_stat_sfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">=</span> <span class="n">ns_stat_lfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">lb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NS_LGSKBSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_LG</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">NS_SMBUFSIZE</span><span class="p">);</span>
		<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">min</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_hb_destructor</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">hb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">hb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NS_HBUFSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">hb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_NONE</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">hb</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* NS_USE_DESTRUCTORS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recycle_rx_buf</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">BUF_NONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: What kind of rx buffer is this?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recycle_iovec_rx_bufs</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iovec</span> <span class="o">*</span><span class="n">iov</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">recycle_rx_buf</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)(</span><span class="n">iov</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iov_base</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">recycle_iov_buf</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iovb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">iovb</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">iovb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dequeue_sm_buf</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_unlink</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
<span class="cp">#ifdef NS_USE_DESTRUCTORS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">min</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_sb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_sb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_SMSKBSIZE</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">new_sb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_SM</span><span class="p">;</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">new_sb</span><span class="p">);</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_sb</span><span class="p">,</span> <span class="n">NS_AAL0_HEADER</span><span class="p">);</span>
			<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">new_sb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span>
<span class="cp">#endif </span><span class="cm">/* NS_USE_DESTRUCTORS */</span><span class="cp"></span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_sb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_sb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_SMSKBSIZE</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">new_sb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_SM</span><span class="p">;</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">new_sb</span><span class="p">);</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_sb</span><span class="p">,</span> <span class="n">NS_AAL0_HEADER</span><span class="p">);</span>
			<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">new_sb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dequeue_lg_buf</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_unlink</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
<span class="cp">#ifdef NS_USE_DESTRUCTORS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">min</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_lb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_lb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_LGSKBSIZE</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">new_lb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_LG</span><span class="p">;</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">new_lb</span><span class="p">);</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_lb</span><span class="p">,</span> <span class="n">NS_SMBUFSIZE</span><span class="p">);</span>
			<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">new_lb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span>
<span class="cp">#endif </span><span class="cm">/* NS_USE_DESTRUCTORS */</span><span class="cp"></span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_lb</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_lb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">NS_LGSKBSIZE</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">new_lb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_LG</span><span class="p">;</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">new_lb</span><span class="p">);</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">new_lb</span><span class="p">,</span> <span class="n">NS_SMBUFSIZE</span><span class="p">);</span>
			<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">new_lb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ns_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span> <span class="n">pos</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">;</span>

	<span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Pool   count    min   init    max </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Small  %5d  %5d  %5d  %5d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ns_stat_sfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">min</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">init</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Large  %5d  %5d  %5d  %5d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">ns_stat_lfbqc_get</span><span class="p">(</span><span class="n">stat</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">min</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">init</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Huge   %5d  %5d  %5d  %5d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">min</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">init</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Iovec  %5d  %5d  %5d  %5d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">min</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">init</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;Interrupt counter: %u </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">intcnt</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">intcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Dump 25.6 Mbps PHY registers */</span>
<span class="c">	/* Now there&#39;s a 25.6 Mbps PHY driver this code isn&#39;t needed. I left it</span>
<span class="c">	   here just in case it&#39;s needed for debugging. */</span>
<span class="c">	if (card-&gt;max_pcr == ATM_25_PCR &amp;&amp; !left--) {</span>
<span class="c">		u32 phy_regs[4];</span>
<span class="c">		u32 i;</span>

<span class="c">		for (i = 0; i &lt; 4; i++) {</span>
<span class="c">			while (CMD_BUSY(card)) ;</span>
<span class="c">			writel(NS_CMD_READ_UTILITY | 0x00000200 | i,</span>
<span class="c">			       card-&gt;membase + CMD);</span>
<span class="c">			while (CMD_BUSY(card)) ;</span>
<span class="c">			phy_regs[i] = readl(card-&gt;membase + DR0) &amp; 0x000000FF;</span>
<span class="c">		}</span>

<span class="c">		return sprintf(page, &quot;PHY regs: 0x%02X 0x%02X 0x%02X 0x%02X \n&quot;,</span>
<span class="c">			       phy_regs[0], phy_regs[1], phy_regs[2],</span>
<span class="c">			       phy_regs[3]);</span>
<span class="c">	}</span>
<span class="cp">#endif /* 0 - Dump 25.6 Mbps PHY registers */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* Dump TST */</span>
<span class="c">	if (left-- &lt; NS_TST_NUM_ENTRIES) {</span>
<span class="c">		if (card-&gt;tste2vc[left + 1] == NULL)</span>
<span class="c">			return sprintf(page, &quot;%5d - VBR/UBR \n&quot;, left + 1);</span>
<span class="c">		else</span>
<span class="c">			return sprintf(page, &quot;%5d - %d %d \n&quot;, left + 1,</span>
<span class="c">				       card-&gt;tste2vc[left + 1]-&gt;tx_vcc-&gt;vpi,</span>
<span class="c">				       card-&gt;tste2vc[left + 1]-&gt;tx_vcc-&gt;vci);</span>
<span class="c">	}</span>
<span class="cp">#endif /* 0 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ns_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">pool_levels</span> <span class="n">pl</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">btype</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NS_GETPSTAT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span>
		    <span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">buftype</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">((</span><span class="n">pool_levels</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buftype</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">buftype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NS_BUFTYPE_SMALL</span>:
			<span class="n">pl</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
			    <span class="n">ns_stat_sfbqc_get</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">));</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NS_BUFTYPE_LARGE</span>:
			<span class="n">pl</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span>
			    <span class="n">ns_stat_lfbqc_get</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">));</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NS_BUFTYPE_HUGE</span>:
			<span class="n">pl</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NS_BUFTYPE_IOVEC</span>:
			<span class="n">pl</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
			<span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">copy_to_user</span><span class="p">((</span><span class="n">pool_levels</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pl</span><span class="p">)))</span>
			<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pl</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NS_SETBUFLEV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pl</span><span class="p">,</span> <span class="p">(</span><span class="n">pool_levels</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pl</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span> <span class="o">&gt;=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span>
		    <span class="o">||</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span> <span class="o">&gt;=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">buftype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NS_BUFTYPE_SMALL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span> <span class="o">&gt;</span> <span class="n">TOP_SB</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NS_BUFTYPE_LARGE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span> <span class="o">&gt;</span> <span class="n">TOP_LB</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NS_BUFTYPE_HUGE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span> <span class="o">&gt;</span> <span class="n">TOP_HB</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NS_BUFTYPE_IOVEC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span> <span class="o">&gt;</span> <span class="n">TOP_IOVB</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">init</span><span class="p">;</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">pl</span><span class="p">.</span><span class="n">level</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NS_ADJBUFLEV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">btype</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>	<span class="cm">/* a long is the same size as a pointer or bigger */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">btype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NS_BUFTYPE_SMALL</span>:
			<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">sbnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">sb</span><span class="p">;</span>

				<span class="n">sb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NS_SMSKBSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">sb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_SM</span><span class="p">;</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">sbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">sb</span><span class="p">,</span> <span class="n">NS_AAL0_HEADER</span><span class="p">);</span>
				<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">sb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NS_BUFTYPE_LARGE</span>:
			<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbfqc</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">lbnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">lb</span><span class="p">;</span>

				<span class="n">lb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NS_LGSKBSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_LG</span><span class="p">;</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">lb</span><span class="p">,</span> <span class="n">NS_SMBUFSIZE</span><span class="p">);</span>
				<span class="n">push_rxbufs</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">lb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NS_BUFTYPE_HUGE</span>:
			<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">hb</span><span class="p">;</span>

				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">hb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;nicstar%d: huge buffer count inconsistent.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">hb</span><span class="p">);</span>

			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hbnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">hb</span><span class="p">;</span>

				<span class="n">hb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">NS_HBUFSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">hb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">hb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_NONE</span><span class="p">;</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">hb</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">hbpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">NS_BUFTYPE_IOVEC</span>:
			<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iovb</span><span class="p">;</span>

				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">iovb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">iovb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">printk</span>
					    <span class="p">(</span><span class="s">&quot;nicstar%d: iovec buffer count inconsistent.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					     <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">iovb</span><span class="p">);</span>

			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">iovnr</span><span class="p">.</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">iovb</span><span class="p">;</span>

				<span class="n">iovb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">NS_IOVBUFSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">iovb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">iovb</span><span class="p">)</span> <span class="o">=</span> <span class="n">BUF_NONE</span><span class="p">;</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span> <span class="n">iovb</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">iovpool</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nicstar%d: %s == NULL </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">?</span> <span class="s">&quot;dev-&gt;phy-&gt;ioctl&quot;</span> <span class="o">:</span> <span class="s">&quot;dev-&gt;phy&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef EXTRA_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">which_list</span><span class="p">(</span><span class="n">ns_dev</span> <span class="o">*</span> <span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;skb buf_type: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">NS_PRV_BUFTYPE</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* EXTRA_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat_r</span><span class="p">,</span> <span class="n">stat_w</span><span class="p">;</span>

	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar: Entering ns_poll().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">cards</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Probably it isn&#39;t worth spinning */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">stat_w</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">stat_r</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_TSIF</span><span class="p">)</span>
			<span class="n">stat_w</span> <span class="o">|=</span> <span class="n">NS_STAT_TSIF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stat_r</span> <span class="o">&amp;</span> <span class="n">NS_STAT_EOPDU</span><span class="p">)</span>
			<span class="n">stat_w</span> <span class="o">|=</span> <span class="n">NS_STAT_EOPDU</span><span class="p">;</span>

		<span class="n">process_tsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">process_rsq</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">stat_w</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">STAT</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">int_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ns_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NS_POLL_PERIOD</span><span class="p">);</span>
	<span class="n">PRINTK</span><span class="p">(</span><span class="s">&quot;nicstar: Leaving ns_poll().</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ns_parse_mac</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">esi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">byte1</span><span class="p">,</span> <span class="n">byte0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">esi</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">byte1</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">mac</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">byte0</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">mac</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">byte1</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="n">byte0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ns_phy_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">value</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR0</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NS_CMD_WRITE_UTILITY</span> <span class="o">|</span> <span class="mh">0x00000200</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">),</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">ns_phy_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ns_dev</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">NS_CMD_READ_UTILITY</span> <span class="o">|</span> <span class="mh">0x00000200</span> <span class="o">|</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">),</span>
	       <span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">CMD</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">CMD_BUSY</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">membase</span> <span class="o">+</span> <span class="n">DR0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000000FF</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">res_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">nicstar_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">nicstar_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
