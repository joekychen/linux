<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › atm › firestream.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>firestream.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* drivers/atm/firestream.c - FireStream 155 (MB86697) and</span>
<span class="cm"> *                            FireStream  50 (MB86695) device driver </span>
<span class="cm"> */</span>
 
<span class="cm">/* Written &amp; (C) 2000 by R.E.Wolff@BitWizard.nl </span>
<span class="cm"> * Copied snippets from zatm.c by Werner Almesberger, EPFL LRC/ICA </span>
<span class="cm"> * and ambassador.c Copyright (C) 1995-1999  Madge Networks Ltd </span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; if not, write to the Free Software</span>
<span class="cm">  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm">  The GNU GPL is contained in /usr/doc/copyright/GPL on a Debian</span>
<span class="cm">  system and in the file COPYING in the Linux kernel source.</span>
<span class="cm">*/</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/poison.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/atm.h&gt;</span>
<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;linux/sonet.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt; </span><span class="cm">/* for request_region */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/uio.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/string.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>

<span class="cp">#include &quot;firestream.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">loopback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">num</span><span class="o">=</span><span class="mh">0x5a</span><span class="p">;</span>

<span class="cm">/* According to measurements (but they look suspicious to me!) done in</span>
<span class="cm"> * &#39;97, 37% of the packets are one cell in size. So it pays to have</span>
<span class="cm"> * buffers allocated at that size. A large jump in percentage of</span>
<span class="cm"> * packets occurs at packets around 536 bytes in length. So it also</span>
<span class="cm"> * pays to have those pre-allocated. Unfortunately, we can&#39;t fully</span>
<span class="cm"> * take advantage of this as the majority of the packets is likely to</span>
<span class="cm"> * be TCP/IP (As where obviously the measurement comes from) There the</span>
<span class="cm"> * link would be opened with say a 1500 byte MTU, and we can&#39;t handle</span>
<span class="cm"> * smaller buffers more efficiently than the larger ones. -- REW</span>
<span class="cm"> */</span>

<span class="cm">/* Due to the way Linux memory management works, specifying &quot;576&quot; as</span>
<span class="cm"> * an allocation size here isn&#39;t going to help. They are allocated</span>
<span class="cm"> * from 1024-byte regions anyway. With the size of the sk_buffs (quite</span>
<span class="cm"> * large), it doesn&#39;t pay to allocate the smallest size (64) -- REW */</span>

<span class="cm">/* This is all guesswork. Hard numbers to back this up or disprove this, </span>
<span class="cm"> * are appreciated. -- REW */</span>

<span class="cm">/* The last entry should be about 64k. However, the &quot;buffer size&quot; is</span>
<span class="cm"> * passed to the chip in a 16 bit field. I don&#39;t know how &quot;65536&quot;</span>
<span class="cm"> * would be interpreted. -- REW */</span>

<span class="cp">#define NP FS_NR_FREE_POOLS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_buf_sizes</span><span class="p">[</span><span class="n">NP</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span><span class="mi">128</span><span class="p">,</span>  <span class="mi">256</span><span class="p">,</span>  <span class="mi">512</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span> <span class="mi">65520</span><span class="p">};</span>
<span class="cm">/* log2:                 7     8     9    10    11    12    14     16 */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int rx_pool_sizes[NP] = {1024, 1024, 512, 256,  128,  64,   32,    32};</span>
<span class="cp">#else</span>
<span class="cm">/* debug */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_pool_sizes</span><span class="p">[</span><span class="n">NP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">128</span><span class="p">,</span>  <span class="mi">128</span><span class="p">,</span>  <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>   <span class="mi">64</span><span class="p">,</span>   <span class="mi">64</span><span class="p">,</span>   <span class="mi">32</span><span class="p">,</span>    <span class="mi">32</span><span class="p">};</span>
<span class="cp">#endif</span>
<span class="cm">/* log2:                 10    10    9    8     7     6     5      5  */</span>
<span class="cm">/* sumlog2:              17    18    18   18    18    18    19     21 */</span>
<span class="cm">/* mem allocated:        128k  256k  256k 256k  256k  256k  512k   2M */</span>
<span class="cm">/* tot mem: almost 4M */</span>

<span class="cm">/* NP is shorter, so that it fits on a single line. */</span>
<span class="cp">#undef NP</span>


<span class="cm">/* Small hardware gotcha:</span>

<span class="cm">   The FS50 CAM (VP/VC match registers) always take the lowest channel</span>
<span class="cm">   number that matches. This is not a problem.</span>

<span class="cm">   However, they also ignore whether the channel is enabled or</span>
<span class="cm">   not. This means that if you allocate channel 0 to 1.2 and then</span>
<span class="cm">   channel 1 to 0.0, then disabeling channel 0 and writing 0 to the</span>
<span class="cm">   match channel for channel 0 will &quot;steal&quot; the traffic from channel</span>
<span class="cm">   1, even if you correctly disable channel 0.</span>

<span class="cm">   Workaround: </span>

<span class="cm">   - When disabling channels, write an invalid VP/VC value to the</span>
<span class="cm">   match register. (We use 0xffffffff, which in the worst case </span>
<span class="cm">   matches VP/VC = &lt;maxVP&gt;/&lt;maxVC&gt;, but I expect it not to match</span>
<span class="cm">   anything as some &quot;when not in use, program to 0&quot; bits are now</span>
<span class="cm">   programmed to 1...)</span>

<span class="cm">   - Don&#39;t initialize the match registers to 0, as 0.0 is a valid</span>
<span class="cm">   channel.</span>
<span class="cm">*/</span>


<span class="cm">/* Optimization hints and tips.</span>

<span class="cm">   The FireStream chips are very capable of reducing the amount of</span>
<span class="cm">   &quot;interrupt-traffic&quot; for the CPU. This driver requests an interrupt on EVERY</span>
<span class="cm">   action. You could try to minimize this a bit. </span>

<span class="cm">   Besides that, the userspace-&gt;kernel copy and the PCI bus are the</span>
<span class="cm">   performance limiting issues for this driver.</span>

<span class="cm">   You could queue up a bunch of outgoing packets without telling the</span>
<span class="cm">   FireStream. I&#39;m not sure that&#39;s going to win you much though. The</span>
<span class="cm">   Linux layer won&#39;t tell us in advance when it&#39;s not going to give us</span>
<span class="cm">   any more packets in a while. So this is tricky to implement right without</span>
<span class="cm">   introducing extra delays. </span>
<span class="cm">  </span>
<span class="cm">   -- REW</span>
<span class="cm"> */</span>




<span class="cm">/* The strings that define what the RX queue entry is all about. */</span>
<span class="cm">/* Fujitsu: Please tell me which ones can have a pointer to a </span>
<span class="cm">   freepool descriptor! */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">res_strings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;RX OK: streaming not EOP&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: streaming EOP&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: Single buffer packet&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: packet mode&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: F4 OAM (end to end)&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: F4 OAM (Segment)&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: F5 OAM (end to end)&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: F5 OAM (Segment)&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: RM cell&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: TRANSP cell&quot;</span><span class="p">,</span> 
	<span class="s">&quot;RX OK: TRANSPC cell&quot;</span><span class="p">,</span> 
	<span class="s">&quot;Unmatched cell&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 12&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 13&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 14&quot;</span><span class="p">,</span> 
	<span class="s">&quot;Unrecognized cell&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 16&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reassemby abort: AAL5 abort&quot;</span><span class="p">,</span> 
	<span class="s">&quot;packet purged&quot;</span><span class="p">,</span> 
	<span class="s">&quot;packet ageing timeout&quot;</span><span class="p">,</span> 
	<span class="s">&quot;channel ageing timeout&quot;</span><span class="p">,</span> 
	<span class="s">&quot;calculated length error&quot;</span><span class="p">,</span> 
	<span class="s">&quot;programmed length limit error&quot;</span><span class="p">,</span> 
	<span class="s">&quot;aal5 crc32 error&quot;</span><span class="p">,</span> 
	<span class="s">&quot;oam transp or transpc crc10 error&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 25&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 26&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 27&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 28&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 29&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 30&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reassembly abort: no buffers&quot;</span><span class="p">,</span> 
	<span class="s">&quot;receive buffer overflow&quot;</span><span class="p">,</span> 
	<span class="s">&quot;change in GFC&quot;</span><span class="p">,</span> 
	<span class="s">&quot;receive buffer full&quot;</span><span class="p">,</span> 
	<span class="s">&quot;low priority discard - no receive descriptor&quot;</span><span class="p">,</span> 
	<span class="s">&quot;low priority discard - missing end of packet&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 41&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 42&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 43&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 44&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 45&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 46&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 47&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 48&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 49&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 50&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 51&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 52&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 53&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 54&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 55&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 56&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 57&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 58&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 59&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 60&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 61&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 62&quot;</span><span class="p">,</span> 
	<span class="s">&quot;reserved 63&quot;</span><span class="p">,</span> 
<span class="p">};</span>  

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">irq_bitname</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;LPCO&quot;</span><span class="p">,</span>
	<span class="s">&quot;DPCO&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBRQ0_W&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBRQ1_W&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBRQ2_W&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBRQ3_W&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBRQ0_NF&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBRQ1_NF&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBRQ2_NF&quot;</span><span class="p">,</span>
	<span class="s">&quot;RBRQ3_NF&quot;</span><span class="p">,</span>
	<span class="s">&quot;BFP_SC&quot;</span><span class="p">,</span>
	<span class="s">&quot;INIT&quot;</span><span class="p">,</span>
	<span class="s">&quot;INIT_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;USCEO&quot;</span><span class="p">,</span>
	<span class="s">&quot;UPEC0&quot;</span><span class="p">,</span>
	<span class="s">&quot;VPFCO&quot;</span><span class="p">,</span>
	<span class="s">&quot;CRCCO&quot;</span><span class="p">,</span>
	<span class="s">&quot;HECO&quot;</span><span class="p">,</span>
	<span class="s">&quot;TBRQ_W&quot;</span><span class="p">,</span>
	<span class="s">&quot;TBRQ_NF&quot;</span><span class="p">,</span>
	<span class="s">&quot;CTPQ_E&quot;</span><span class="p">,</span>
	<span class="s">&quot;GFC_C0&quot;</span><span class="p">,</span>
	<span class="s">&quot;PCI_FTL&quot;</span><span class="p">,</span>
	<span class="s">&quot;CSQ_W&quot;</span><span class="p">,</span>
	<span class="s">&quot;CSQ_NF&quot;</span><span class="p">,</span>
	<span class="s">&quot;EXT_INT&quot;</span><span class="p">,</span>
	<span class="s">&quot;RXDMA_S&quot;</span>
<span class="p">};</span>


<span class="cp">#define PHY_EOF -1</span>
<span class="cp">#define PHY_CLEARALL -2</span>

<span class="k">struct</span> <span class="n">reginit_item</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">reginit_item</span> <span class="n">PHY_NTC_INIT</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PHY_CLEARALL</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span> 
	<span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span>  <span class="mh">0x0001</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span>  <span class="mh">0x7605</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1A</span><span class="p">,</span>  <span class="mh">0x0001</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1B</span><span class="p">,</span>  <span class="mh">0x0005</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x38</span><span class="p">,</span>  <span class="mh">0x0003</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x39</span><span class="p">,</span>  <span class="mh">0x0006</span> <span class="p">},</span>   <span class="cm">/* changed here to make loopback */</span>
	<span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span>  <span class="mh">0x5262</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span>  <span class="mh">0x0213</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="mh">0x0003</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PHY_EOF</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>    <span class="cm">/* -1 signals end of list */</span>
<span class="p">};</span>


<span class="cm">/* Safetyfeature: If the card interrupts more than this number of times</span>
<span class="cm">   in a jiffy (1/100th of a second) then we just disable the interrupt and</span>
<span class="cm">   print a message. This prevents the system from hanging. </span>

<span class="cm">   150000 packets per second is close to the limit a PC is going to have</span>
<span class="cm">   anyway. We therefore have to disable this for production. -- REW */</span>
<span class="cp">#undef IRQ_RATE_LIMIT </span><span class="c1">// 100</span>

<span class="cm">/* Interrupts work now. Unlike serial cards, ATM cards don&#39;t work all</span>
<span class="cm">   that great without interrupts. -- REW */</span>
<span class="cp">#undef FS_POLL_FREQ </span><span class="c1">// 100</span>

<span class="cm">/* </span>
<span class="cm">   This driver can spew a whole lot of debugging output at you. If you</span>
<span class="cm">   need maximum performance, you should disable the DEBUG define. To</span>
<span class="cm">   aid in debugging in the field, I&#39;m leaving the compile-time debug</span>
<span class="cm">   features enabled, and disable them &quot;runtime&quot;. That allows me to</span>
<span class="cm">   instruct people with problems to enable debugging without requiring</span>
<span class="cm">   them to recompile... -- REW</span>
<span class="cm">*/</span>
<span class="cp">#define DEBUG</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define fs_dprintk(f, str...) if (fs_debug &amp; f) printk (str)</span>
<span class="cp">#else</span>
<span class="cp">#define fs_dprintk(f, str...) </span><span class="cm">/* nothing */</span><span class="cp"></span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">fs_keystream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cm">/* I didn&#39;t forget to set this to zero before shipping. Hit me with a stick </span>
<span class="cm">   if you get this with the debug default not set to zero again. -- REW */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fs_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#define fs_debug 0</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef MODULE</span>
<span class="cp">#ifdef DEBUG </span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fs_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">loopback</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fs_keystream</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cm">/* XXX Add rx_buf_sizes, and rx_pool_sizes As per request Amar. -- REW */</span>
<span class="cp">#endif</span>


<span class="cp">#define FS_DEBUG_FLOW    0x00000001</span>
<span class="cp">#define FS_DEBUG_OPEN    0x00000002</span>
<span class="cp">#define FS_DEBUG_QUEUE   0x00000004</span>
<span class="cp">#define FS_DEBUG_IRQ     0x00000008</span>
<span class="cp">#define FS_DEBUG_INIT    0x00000010</span>
<span class="cp">#define FS_DEBUG_SEND    0x00000020</span>
<span class="cp">#define FS_DEBUG_PHY     0x00000040</span>
<span class="cp">#define FS_DEBUG_CLEANUP 0x00000080</span>
<span class="cp">#define FS_DEBUG_QOS     0x00000100</span>
<span class="cp">#define FS_DEBUG_TXQ     0x00000200</span>
<span class="cp">#define FS_DEBUG_ALLOC   0x00000400</span>
<span class="cp">#define FS_DEBUG_TXMEM   0x00000800</span>
<span class="cp">#define FS_DEBUG_QSIZE   0x00001000</span>


<span class="cp">#define func_enter() fs_dprintk(FS_DEBUG_FLOW, &quot;fs: enter %s\n&quot;, __func__)</span>
<span class="cp">#define func_exit()  fs_dprintk(FS_DEBUG_FLOW, &quot;fs: exit  %s\n&quot;, __func__)</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">fs_boards</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">my_hd</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%p &quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">?</span><span class="n">len</span><span class="o">:</span><span class="mi">16</span><span class="p">);</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%02x %s&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">7</span><span class="p">)</span><span class="o">?</span><span class="s">&quot; &quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span>  <span class="p">;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;   %s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span><span class="o">==</span><span class="mi">7</span><span class="p">)</span><span class="o">?</span><span class="s">&quot; &quot;</span><span class="o">:</span><span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">j</span> <span class="o">&lt;</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span><span class="o">?</span><span class="n">len</span><span class="o">:</span><span class="mi">16</span><span class="p">);</span><span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mh">0x20</span><span class="p">)</span><span class="o">?</span><span class="sc">&#39;.&#39;</span><span class="o">:</span><span class="p">((</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span><span class="o">?</span><span class="sc">&#39;.&#39;</span><span class="o">:</span><span class="n">ch</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* DEBUG */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">my_hd</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">){}</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="cm">/********** free an skb (as per ATM device driver documentation) **********/</span>

<span class="cm">/* Hmm. If this is ATM specific, why isn&#39;t there an ATM routine for this?</span>
<span class="cm"> * I copied it over from the ambassador driver. -- REW */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">fs_kfree_skb</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span> <span class="n">skb</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
		<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span> <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_kfree_skb_any</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>




<span class="cm">/* It seems the ATM forum recommends this horribly complicated 16bit</span>
<span class="cm"> * floating point format. Turns out the Ambassador uses the exact same</span>
<span class="cm"> * encoding. I just copied it over. If Mitch agrees, I&#39;ll move it over</span>
<span class="cm"> * to the atm_misc file or something like that. (and remove it from </span>
<span class="cm"> * here and the ambassador driver) -- REW</span>
<span class="cm"> */</span>

<span class="cm">/* The good thing about this format is that it is monotonic. So, </span>
<span class="cm">   a conversion routine need not be very complicated. To be able to</span>
<span class="cm">   round &quot;nearest&quot; we need to take along a few extra bits. Lets</span>
<span class="cm">   put these after 16 bits, so that we can just return the top 16</span>
<span class="cm">   bits of the 32bit number as the result:</span>

<span class="cm">   int mr (unsigned int rate, int r) </span>
<span class="cm">     {</span>
<span class="cm">     int e = 16+9;</span>
<span class="cm">     static int round[4]={0, 0, 0xffff, 0x8000};</span>
<span class="cm">     if (!rate) return 0;</span>
<span class="cm">     while (rate &amp; 0xfc000000) {</span>
<span class="cm">       rate &gt;&gt;= 1;</span>
<span class="cm">       e++;</span>
<span class="cm">     }</span>
<span class="cm">     while (! (rate &amp; 0xfe000000)) {</span>
<span class="cm">       rate &lt;&lt;= 1;</span>
<span class="cm">       e--;</span>
<span class="cm">     }</span>


<span class="cm">//DIVIDER</span>
<span class="cm">     rate &amp;= ~0x02000000;</span>

<span class="cm">//DIVIDER</span>
<span class="cm">     rate |= e &lt;&lt; (16+9);</span>

<span class="cm">//DIVIDER</span>
<span class="cm">     return (rate + round[r]) &gt;&gt; 16;</span>
<span class="cm">   }</span>

<span class="cm">   14 lines-of-code. Compare that with the 120 that the Ambassador</span>
<span class="cm">   guys needed. (would be 8 lines shorter if I&#39;d try to really reduce</span>
<span class="cm">   the number of lines:</span>

<span class="cm">   int mr (unsigned int rate, int r) </span>
<span class="cm">   {</span>
<span class="cm">     int e = 16+9;</span>
<span class="cm">     static int round[4]={0, 0, 0xffff, 0x8000};</span>
<span class="cm">     if (!rate) return 0;</span>
<span class="cm">     for (;  rate &amp; 0xfc000000 ;rate &gt;&gt;= 1, e++);</span>
<span class="cm">     for (;!(rate &amp; 0xfe000000);rate &lt;&lt;= 1, e--);</span>
<span class="cm">     return ((rate &amp; ~0x02000000) | (e &lt;&lt; (16+9)) + round[r]) &gt;&gt; 16;</span>
<span class="cm">   }</span>

<span class="cm">   Exercise for the reader: Remove one more line-of-code, without</span>
<span class="cm">   cheating. (Just joining two lines is cheating). (I know it&#39;s</span>
<span class="cm">   possible, don&#39;t think you&#39;ve beat me if you found it... If you</span>
<span class="cm">   manage to lose two lines or more, keep me updated! ;-)</span>

<span class="cm">   -- REW */</span>


<span class="cp">#define ROUND_UP      1</span>
<span class="cp">#define ROUND_DOWN    2</span>
<span class="cp">#define ROUND_NEAREST 3</span>
<span class="cm">/********** make rate (not quite as much fun as Horizon) **********/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">make_rate</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">r</span><span class="p">,</span>
		      <span class="n">u16</span> <span class="o">*</span><span class="n">bits</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">actual</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">exp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* hush gcc */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">man</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="cm">/* hush gcc */</span>
  
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QOS</span><span class="p">,</span> <span class="s">&quot;make_rate %u&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
  
	<span class="cm">/* rates in cells per second, ITU format (nasty 16-bit floating-point)</span>
<span class="cm">	   given 5-bit e and 9-bit m:</span>
<span class="cm">	   rate = EITHER (1+m/2^9)*2^e    OR 0</span>
<span class="cm">	   bits = EITHER 1&lt;&lt;14 | e&lt;&lt;9 | m OR 0</span>
<span class="cm">	   (bit 15 is &quot;reserved&quot;, bit 14 &quot;non-zero&quot;)</span>
<span class="cm">	   smallest rate is 0 (special representation)</span>
<span class="cm">	   largest rate is (1+511/512)*2^31 = 4290772992 (&lt; 2^32-1)</span>
<span class="cm">	   smallest non-zero rate is (1+0/512)*2^0 = 1 (&gt; 0)</span>
<span class="cm">	   simple algorithm:</span>
<span class="cm">	   find position of top bit, this gives e</span>
<span class="cm">	   remove top bit and shift (rounding if feeling clever) by 9-e</span>
<span class="cm">	*/</span>
	<span class="cm">/* Ambassador ucode bug: please don&#39;t set bit 14! so 0 rate not</span>
<span class="cm">	   representable. // This should move into the ambassador driver</span>
<span class="cm">	   when properly merged. -- REW */</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mh">0xffc00000U</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* larger than largest representable rate */</span>
    
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">ROUND_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
			<span class="n">man</span> <span class="o">=</span> <span class="mi">511</span><span class="p">;</span>
		<span class="p">}</span>
    
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* representable rate */</span>
    
		<span class="n">exp</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="n">man</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
    
		<span class="cm">/* invariant: rate = man*2^(exp-31) */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">man</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">31</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">man</span> <span class="o">=</span> <span class="n">man</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
    
		<span class="cm">/* man has top bit set</span>
<span class="cm">		   rate = (2^31+(man-2^31))*2^(exp-31)</span>
<span class="cm">		   rate = (1+(man-2^31)/2^31)*2^exp </span>
<span class="cm">		*/</span>
		<span class="n">man</span> <span class="o">=</span> <span class="n">man</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">man</span> <span class="o">&amp;=</span> <span class="mh">0xffffffffU</span><span class="p">;</span> <span class="cm">/* a nop on 32-bit systems */</span>
		<span class="cm">/* rate = (1+man/2^32)*2^exp</span>
<span class="cm">    </span>
<span class="cm">		   exp is in the range 0 to 31, man is in the range 0 to 2^32-1</span>
<span class="cm">		   time to lose significance... we want m in the range 0 to 2^9-1</span>
<span class="cm">		   rounding presents a minor problem... we first decide which way</span>
<span class="cm">		   we are rounding (based on given rounding direction and possibly</span>
<span class="cm">		   the bits of the mantissa that are to be discarded).</span>
<span class="cm">		*/</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ROUND_DOWN</span>: <span class="p">{</span>
			<span class="cm">/* just truncate */</span>
			<span class="n">man</span> <span class="o">=</span> <span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">ROUND_UP</span>: <span class="p">{</span>
			<span class="cm">/* check all bits that we are discarding */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">man</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">0U</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">man</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* no need to check for round up outside of range */</span>
					<span class="n">man</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">exp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">ROUND_NEAREST</span>: <span class="p">{</span>
			<span class="cm">/* check msb that we are discarding */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">man</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">man</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* no need to check for round up outside of range */</span>
					<span class="n">man</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">exp</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">man</span> <span class="o">=</span> <span class="p">(</span><span class="n">man</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">32</span><span class="o">-</span><span class="mi">9</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="p">}</span>
    
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* zero rate - not representable */</span>
    
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="n">ROUND_DOWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">exp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">man</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
  
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QOS</span><span class="p">,</span> <span class="s">&quot;rate: man=%u, exp=%hu&quot;</span><span class="p">,</span> <span class="n">man</span><span class="p">,</span> <span class="n">exp</span><span class="p">);</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">bits</span><span class="p">)</span>
		<span class="o">*</span><span class="n">bits</span> <span class="o">=</span> <span class="cm">/* (1&lt;&lt;14) | */</span> <span class="p">(</span><span class="n">exp</span><span class="o">&lt;&lt;</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">man</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">actual</span><span class="p">)</span>
		<span class="o">*</span><span class="n">actual</span> <span class="o">=</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span>
			<span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">exp</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">man</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">exp</span><span class="o">-</span><span class="mi">9</span><span class="p">))</span>
			<span class="o">:</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">exp</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">man</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="n">exp</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="n">exp</span><span class="p">));</span>
  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>




<span class="cm">/* FireStream access routines */</span>
<span class="cm">/* For DEEP-DOWN debugging these can be rigged to intercept accesses to</span>
<span class="cm">   certain registers or to just log all accesses. */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">write_fs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>  <span class="nf">read_fs</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">FS_QENTRY</span> <span class="o">*</span><span class="nf">get_qentry</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_WP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">Q_ADDR_MASK</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">submit_qentry</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">FS_QENTRY</span> <span class="o">*</span><span class="n">qe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">wp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FS_QENTRY</span> <span class="o">*</span><span class="n">cqe</span><span class="p">;</span>

	<span class="cm">/* XXX Sanity check: the write pointer can be checked to be </span>
<span class="cm">	   still the same as the value passed as qe... -- REW */</span>
	<span class="cm">/*  udelay (5); */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">wp</span> <span class="o">=</span> <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_WP</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">Q_FULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_TXQ</span><span class="p">,</span> <span class="s">&quot;Found queue at %x full. Waiting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			    <span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">schedule</span> <span class="p">();</span>
	<span class="p">}</span>

	<span class="n">wp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>
	<span class="n">cqe</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">wp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qe</span> <span class="o">!=</span> <span class="n">cqe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_TXQ</span><span class="p">,</span> <span class="s">&quot;q mismatch! %p %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qe</span><span class="p">,</span> <span class="n">cqe</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_WP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">Q_INCWRAP</span><span class="p">);</span>

	<span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">c</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">++</span> <span class="o">%</span> <span class="mi">100</span><span class="p">))</span>
			<span class="p">{</span>
				<span class="kt">int</span> <span class="n">rp</span><span class="p">,</span> <span class="n">wp</span><span class="p">;</span>
				<span class="n">rp</span> <span class="o">=</span>  <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
				<span class="n">wp</span> <span class="o">=</span>  <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_WP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
				<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_TXQ</span><span class="p">,</span> <span class="s">&quot;q at %d: %x-%x: %x entries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
					    <span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">wp</span><span class="o">-</span><span class="n">rp</span><span class="p">);</span>
			<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG_EXTRA</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">FS_QENTRY</span> <span class="n">pq</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qp</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">FS_BPENTRY</span> <span class="n">dq</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">qd</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">da</span><span class="p">[</span><span class="mi">60</span><span class="p">];</span>
<span class="cp">#endif </span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">submit_queue</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> 
			  <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">p1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">p2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">p3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">FS_QENTRY</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>

	<span class="n">qe</span> <span class="o">=</span> <span class="n">get_qentry</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">q</span><span class="p">);</span>
	<span class="n">qe</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">qe</span><span class="o">-&gt;</span><span class="n">p0</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
	<span class="n">qe</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">=</span> <span class="n">p2</span><span class="p">;</span>
	<span class="n">qe</span><span class="o">-&gt;</span><span class="n">p2</span> <span class="o">=</span> <span class="n">p3</span><span class="p">;</span>
	<span class="n">submit_qentry</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span>  <span class="n">q</span><span class="p">,</span> <span class="n">qe</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG_EXTRA</span>
	<span class="n">pq</span><span class="p">[</span><span class="n">qp</span><span class="p">].</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">pq</span><span class="p">[</span><span class="n">qp</span><span class="p">].</span><span class="n">p0</span> <span class="o">=</span> <span class="n">p1</span><span class="p">;</span>
	<span class="n">pq</span><span class="p">[</span><span class="n">qp</span><span class="p">].</span><span class="n">p1</span> <span class="o">=</span> <span class="n">p2</span><span class="p">;</span>
	<span class="n">pq</span><span class="p">[</span><span class="n">qp</span><span class="p">].</span><span class="n">p2</span> <span class="o">=</span> <span class="n">p3</span><span class="p">;</span>
	<span class="n">qp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qp</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">)</span> <span class="n">qp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* Test the &quot;other&quot; way one day... -- REW */</span>
<span class="cp">#if 1</span>
<span class="cp">#define submit_command submit_queue</span>
<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">submit_command</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> 
			    <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">p1</span><span class="p">,</span> <span class="n">u32</span> <span class="n">p2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">p3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMDR0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMDR1</span><span class="p">,</span> <span class="n">p1</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMDR2</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CMDR3</span><span class="p">,</span> <span class="n">p3</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>



<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_return_queue</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FS_QENTRY</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tc</span><span class="p">;</span>
  
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">rq</span> <span class="o">=</span> <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">Q_EMPTY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;reaping return queue entry at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span> 
		<span class="n">qe</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">rq</span><span class="p">);</span>
    
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;queue entry: %08x %08x %08x %08x. (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			    <span class="n">qe</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">,</span> <span class="n">STATUS_CODE</span> <span class="p">(</span><span class="n">qe</span><span class="p">));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">STATUS_CODE</span> <span class="p">(</span><span class="n">qe</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">tc</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">qe</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">);</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free tc: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tc</span><span class="p">);</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">tc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
    
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">Q_INCWRAP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_txdone_queue</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">rq</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FS_QENTRY</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FS_BPENTRY</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">rq</span> <span class="o">=</span> <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">Q_EMPTY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;reaping txdone entry at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span> 
		<span class="n">qe</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">rq</span><span class="p">);</span>
    
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;queue entry: %08x %08x %08x %08x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			    <span class="n">qe</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">,</span> <span class="n">STATUS_CODE</span> <span class="p">(</span><span class="n">qe</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">STATUS_CODE</span> <span class="p">(</span><span class="n">qe</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_TXMEM</span><span class="p">,</span> <span class="s">&quot;queue entry: %08x %08x %08x %08x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				    <span class="n">qe</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">,</span> <span class="n">STATUS_CODE</span> <span class="p">(</span><span class="n">qe</span><span class="p">));</span>


		<span class="k">switch</span> <span class="p">(</span><span class="n">STATUS_CODE</span> <span class="p">(</span><span class="n">qe</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x01</span>: <span class="cm">/* This is for AAL0 where we put the chip in streaming mode */</span>
			<span class="cm">/* Fall through */</span>
		<span class="k">case</span> <span class="mh">0x02</span>:
			<span class="cm">/* Process a real txdone entry. */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;td not aligned: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">;</span>
			<span class="n">td</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;Pool entry: %08x %08x %08x %08x %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				    <span class="n">td</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">bsa</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">aal_bufsize</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="p">);</span>
      
			<span class="n">skb</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="n">FS_VCC</span> <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wake_up_interruptible</span> <span class="p">(</span><span class="o">&amp;</span> <span class="n">FS_VCC</span> <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
				<span class="n">FS_VCC</span> <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">last_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">td</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ntxpckts</span><span class="o">--</span><span class="p">;</span>

			<span class="p">{</span>
				<span class="k">static</span> <span class="kt">int</span> <span class="n">c</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">++</span> <span class="o">%</span> <span class="mi">100</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QSIZE</span><span class="p">,</span> <span class="s">&quot;[%d]&quot;</span><span class="p">,</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ntxpckts</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>

			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_TXMEM</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">);</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free t-skb: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">fs_kfree_skb</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>

			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free trans-d: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">td</span><span class="p">);</span> 
			<span class="n">memset</span> <span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">ATM_POISON_FREE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">FS_BPENTRY</span><span class="p">));</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">td</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* Here we get the tx purge inhibit command ... */</span>
			<span class="cm">/* Action, I believe, is &quot;don&#39;t do anything&quot;. -- REW */</span>
			<span class="p">;</span>
		<span class="p">}</span>
    
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">Q_INCWRAP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">process_incoming</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">rq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FS_QENTRY</span> <span class="o">*</span><span class="n">qe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FS_BPENTRY</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>    
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atm_vcc</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">rq</span> <span class="o">=</span> <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">Q_EMPTY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;reaping incoming queue entry at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rq</span><span class="p">);</span> 
		<span class="n">qe</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">rq</span><span class="p">);</span>
    
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;queue entry: %08x %08x %08x %08x.  &quot;</span><span class="p">,</span> 
			    <span class="n">qe</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p1</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p2</span><span class="p">);</span>

		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;-&gt; %x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			    <span class="n">STATUS_CODE</span> <span class="p">(</span><span class="n">qe</span><span class="p">),</span> 
			    <span class="n">res_strings</span><span class="p">[</span><span class="n">STATUS_CODE</span><span class="p">(</span><span class="n">qe</span><span class="p">)]);</span>

		<span class="n">pe</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">qe</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">);</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;Pool entry: %08x %08x %08x %08x %p %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			    <span class="n">pe</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">bsa</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">aal_bufsize</span><span class="p">,</span> 
			    <span class="n">pe</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span>
      
		<span class="n">channo</span> <span class="o">=</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">channo</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">)</span>
			<span class="n">atm_vcc</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">[</span><span class="n">channo</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">atm_vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Single buffer packet */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">STATUS_CODE</span> <span class="p">(</span><span class="n">qe</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1</span>:
			<span class="cm">/* Fall through for streaming mode */</span>
		<span class="k">case</span> <span class="mh">0x2</span>:<span class="cm">/* Packet received OK.... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
				<span class="n">pe</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">n</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">				fs_dprintk (FS_DEBUG_QUEUE, &quot;Got skb: %p\n&quot;, skb);</span>
<span class="c">				if (FS_DEBUG_QUEUE &amp; fs_debug) my_hd (bus_to_virt (pe-&gt;bsa), 0x20);</span>
<span class="cp">#endif</span>
				<span class="n">skb_put</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">qe</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span> 
				<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="p">;</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
				<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free rec-skb: %p (pushed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">push</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free rec-d: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pe</span><span class="p">);</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">pe</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Got a receive on a non-open channel %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channo</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x17</span>:<span class="cm">/* AAL 5 CRC32 error. IFF the length field is nonzero, a buffer</span>
<span class="cm">			     has been consumed and needs to be processed. -- REW */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qe</span><span class="o">-&gt;</span><span class="n">p1</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pe</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">qe</span><span class="o">-&gt;</span><span class="n">p0</span><span class="p">);</span>
				<span class="n">pe</span><span class="o">-&gt;</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">n</span><span class="o">--</span><span class="p">;</span>
				<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free rec-skb: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pe</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span> <span class="p">(</span><span class="n">pe</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free rec-d: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pe</span><span class="p">);</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">pe</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">)</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1f</span>: <span class="cm">/*  Reassembly abort: no buffers. */</span>
			<span class="cm">/* Silently increment error counter. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">)</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_drop</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="cm">/* Hmm. Haven&#39;t written the code to handle the others yet... -- REW */</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Don&#39;t know what to do with RX status %x: %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				<span class="n">STATUS_CODE</span><span class="p">(</span><span class="n">qe</span><span class="p">),</span> <span class="n">res_strings</span><span class="p">[</span><span class="n">STATUS_CODE</span> <span class="p">(</span><span class="n">qe</span><span class="p">)]);</span>
		<span class="p">}</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">Q_INCWRAP</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cp">#define DO_DIRECTION(tp) ((tp)-&gt;traffic_class != ATM_NONE)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fs_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atm_vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fs_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fs_transmit_config</span> <span class="o">*</span><span class="n">tc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_trafprm</span> <span class="o">*</span> <span class="n">txtp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_trafprm</span> <span class="o">*</span> <span class="n">rxtp</span><span class="p">;</span>
	<span class="cm">/*  struct fs_receive_config *rc;*/</span>
	<span class="cm">/*  struct FS_QENTRY *qe; */</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bfp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">to</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">tmc0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">vpi</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vci</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>

	<span class="n">func_enter</span> <span class="p">();</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">FS_DEV</span><span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_OPEN</span><span class="p">,</span> <span class="s">&quot;fs: open on dev: %p, vcc at %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">dev</span><span class="p">,</span> <span class="n">atm_vcc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vci</span> <span class="o">!=</span> <span class="n">ATM_VPI_UNSPEC</span> <span class="o">&amp;&amp;</span> <span class="n">vpi</span> <span class="o">!=</span> <span class="n">ATM_VCI_UNSPEC</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL2</span><span class="p">))</span>
	  <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* XXX AAL0 */</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_OPEN</span><span class="p">,</span> <span class="s">&quot;fs: (itf %d): open %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>	

	<span class="cm">/* XXX handle qos parameters (rate limiting) ? */</span>

	<span class="n">vcc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fs_vcc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc VCC: %p(%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fs_vcc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">last_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>

	<span class="n">txtp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">;</span>
	<span class="n">rxtp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FS50</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Increment the channel numer: take a free one next time.  */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">to</span><span class="o">=</span><span class="mi">33</span><span class="p">;</span><span class="n">to</span><span class="p">;</span><span class="n">to</span><span class="o">--</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">channo</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We only have 32 channels */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channo</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">channo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* If we need to do RX, AND the RX is inuse, try the next */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">DO_DIRECTION</span><span class="p">(</span><span class="n">rxtp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">])</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="cm">/* If we need to do TX, AND the TX is inuse, try the next */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">DO_DIRECTION</span><span class="p">(</span><span class="n">txtp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_inuse</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="cm">/* Ok, both are free! (or not needed) */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;No more free channels for FS50..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">channo</span> <span class="o">&amp;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel_mask</span><span class="p">;</span>
      
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span> <span class="o">=</span> <span class="p">(</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="n">FS155_VCI_BITS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">DO_DIRECTION</span><span class="p">(</span><span class="n">rxtp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">]))</span> <span class="o">||</span>
			    <span class="p">(</span> <span class="n">DO_DIRECTION</span><span class="p">(</span><span class="n">txtp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_inuse</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Channel is in use for FS155.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_OPEN</span><span class="p">,</span> <span class="s">&quot;OK. Allocated channel %x(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DO_DIRECTION</span> <span class="p">(</span><span class="n">txtp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tc</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_transmit_config</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc tc: %p(%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">tc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_transmit_config</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_OPEN</span><span class="p">,</span> <span class="s">&quot;fs: can&#39;t alloc transmit_config.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Allocate the &quot;open&quot; entry from the high priority txq. This makes</span>
<span class="cm">		   it most likely that the chip will notice it. It also prevents us</span>
<span class="cm">		   from having to wait for completion. On the other hand, we may</span>
<span class="cm">		   need to wait for completion anyway, to see if it completed</span>
<span class="cm">		   successfully. */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATM_AAL2</span>:
		<span class="k">case</span> <span class="n">ATM_AAL0</span>:
		  <span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
		    <span class="o">|</span> <span class="n">TC_FLAGS_TRANSPARENT_PAYLOAD</span>
		    <span class="o">|</span> <span class="n">TC_FLAGS_PACKET</span>
		    <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">)</span>
		    <span class="o">|</span> <span class="n">TC_FLAGS_TYPE_UBR</span> <span class="cm">/* XXX Change to VBR -- PVDL */</span>
		    <span class="o">|</span> <span class="n">TC_FLAGS_CAL0</span><span class="p">;</span>
		  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATM_AAL5</span>:
		  <span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span>
			<span class="o">|</span> <span class="n">TC_FLAGS_AAL5</span>
			<span class="o">|</span> <span class="n">TC_FLAGS_PACKET</span>  <span class="cm">/* ??? */</span>
			<span class="o">|</span> <span class="n">TC_FLAGS_TYPE_CBR</span>
			<span class="o">|</span> <span class="n">TC_FLAGS_CAL0</span><span class="p">;</span>
		  <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Unknown aal: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">);</span>
			<span class="n">tc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Docs are vague about this atm_hdr field. By the way, the FS</span>
<span class="cm">		 * chip makes odd errors if lower bits are set.... -- REW */</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">atm_hdr</span> <span class="o">=</span>  <span class="p">(</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span> 
		<span class="n">tmc0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">pcr</span> <span class="o">=</span> <span class="n">atm_pcr_goal</span> <span class="p">(</span><span class="n">txtp</span><span class="p">);</span>

			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_OPEN</span><span class="p">,</span> <span class="s">&quot;pcr = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcr</span><span class="p">);</span>

			<span class="cm">/* XXX Hmm. officially we&#39;re only allowed to do this if rounding </span>
<span class="cm">			   is round_down -- REW */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_FS50</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="mi">51840000</span><span class="o">/</span><span class="mi">53</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span>  <span class="n">pcr</span> <span class="o">=</span> <span class="mi">51840000</span><span class="o">/</span><span class="mi">53</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="mi">155520000</span><span class="o">/</span><span class="mi">53</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span> <span class="n">pcr</span> <span class="o">=</span> <span class="mi">155520000</span><span class="o">/</span><span class="mi">53</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcr</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* no rate cap */</span>
				<span class="n">tmc0</span> <span class="o">=</span> <span class="n">IS_FS50</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">?</span><span class="mh">0x61BE</span><span class="o">:</span><span class="mh">0x64c9</span><span class="p">;</span> <span class="cm">/* Just copied over the bits from Fujitsu -- REW */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pcr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">r</span> <span class="o">=</span> <span class="n">ROUND_DOWN</span><span class="p">;</span>
					<span class="n">pcr</span> <span class="o">=</span> <span class="o">-</span><span class="n">pcr</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">r</span> <span class="o">=</span> <span class="n">ROUND_UP</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">error</span> <span class="o">=</span> <span class="n">make_rate</span> <span class="p">(</span><span class="n">pcr</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmc0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">tc</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_OPEN</span><span class="p">,</span> <span class="s">&quot;pcr = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcr</span><span class="p">);</span>
		<span class="p">}</span>
      
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">TMC</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmc0</span> <span class="o">|</span> <span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">TMC</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Unused */</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">TMC</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Unused */</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">TMC</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Unused */</span>
    
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">spec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="cm">/* UTOPIA address, UDF, HEC: Unused -&gt; 0 */</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">rtag</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* What should I do with routing tags??? </span>
<span class="cm">				    -- Not used -- AS -- Thanks -- REW*/</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">rtag</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tc</span><span class="o">-&gt;</span><span class="n">rtag</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fs_debug</span> <span class="o">&amp;</span> <span class="n">FS_DEBUG_OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_OPEN</span><span class="p">,</span> <span class="s">&quot;TX config record:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">my_hd</span> <span class="p">(</span><span class="n">tc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">tc</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* We now use the &quot;submit_command&quot; function to submit commands to</span>
<span class="cm">		   the firestream. There is a define up near the definition of</span>
<span class="cm">		   that routine that switches this routine between immediate write</span>
<span class="cm">		   to the immediate command registers and queuing the commands in</span>
<span class="cm">		   the HPTXQ for execution. This last technique might be more</span>
<span class="cm">		   efficient if we know we&#39;re going to submit a whole lot of</span>
<span class="cm">		   commands in one go, but this driver is not setup to be able to</span>
<span class="cm">		   use such a construct. So it probably doen&#39;t matter much right</span>
<span class="cm">		   now. -- REW */</span>
    
		<span class="cm">/* The command is IMMediate and INQueue. The parameters are out-of-line.. */</span>
		<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span> 
				<span class="n">QE_CMD_CONFIG_TX</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span>
				<span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">tc</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span> 
				<span class="n">QE_CMD_TX_EN</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_inuse</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DO_DIRECTION</span> <span class="p">(</span><span class="n">rxtp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">]</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">bfp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">bfp</span> <span class="o">&lt;</span> <span class="n">FS_NR_FREE_POOLS</span><span class="p">;</span> <span class="n">bfp</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">&lt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="n">bfp</span><span class="p">].</span><span class="n">bufsize</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bfp</span> <span class="o">&gt;=</span> <span class="n">FS_NR_FREE_POOLS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_OPEN</span><span class="p">,</span> <span class="s">&quot;No free pool fits sdu: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
				    <span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">);</span>
			<span class="cm">/* XXX Cleanup? -- Would just calling fs_close work??? -- REW */</span>

			<span class="cm">/* XXX clear tx inuse. Close TX part? */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATM_AAL0</span>:
		<span class="k">case</span> <span class="n">ATM_AAL2</span>:
			<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span>
					<span class="n">QE_CMD_CONFIG_RX</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span>
					<span class="n">RC_FLAGS_TRANSP</span> <span class="o">|</span>
					<span class="n">RC_FLAGS_BFPS_BFP</span> <span class="o">*</span> <span class="n">bfp</span> <span class="o">|</span>
					<span class="n">RC_FLAGS_RXBM_PSB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATM_AAL5</span>:
			<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span>
					<span class="n">QE_CMD_CONFIG_RX</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span>
					<span class="n">RC_FLAGS_AAL5</span> <span class="o">|</span>
					<span class="n">RC_FLAGS_BFPS_BFP</span> <span class="o">*</span> <span class="n">bfp</span> <span class="o">|</span>
					<span class="n">RC_FLAGS_RXBM_PSB</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FS50</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span> 
					<span class="n">QE_CMD_REG_WR</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span><span class="p">,</span>
					<span class="mh">0x80</span> <span class="o">+</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span>
					<span class="p">(</span><span class="n">vpi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">vci</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span> <span class="cm">/* XXX -- Use defines. */</span>
		<span class="p">}</span>
		<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span> 
				<span class="n">QE_CMD_RX_EN</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
    
	<span class="cm">/* Indicate we&#39;re done! */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">func_exit</span> <span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">fs_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atm_vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">FS_DEV</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fs_vcc</span> <span class="o">*</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">FS_VCC</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atm_trafprm</span> <span class="o">*</span> <span class="n">txtp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_trafprm</span> <span class="o">*</span> <span class="n">rxtp</span><span class="p">;</span>

	<span class="n">func_enter</span> <span class="p">();</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QSIZE</span><span class="p">,</span> <span class="s">&quot;--==**[%d]**==--&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ntxpckts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">last_skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;Waiting for skb %p to be sent.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
			    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">last_skb</span><span class="p">);</span>
		<span class="cm">/* We&#39;re going to wait for the last packet to get sent on this VC. It would</span>
<span class="cm">		   be impolite not to send them don&#39;t you think? </span>
<span class="cm">		   XXX</span>
<span class="cm">		   We don&#39;t know which packets didn&#39;t get sent. So if we get interrupted in </span>
<span class="cm">		   this sleep_on, we&#39;ll lose any reference to these packets. Memory leak!</span>
<span class="cm">		   On the other hand, it&#39;s awfully convenient that we can abort a &quot;close&quot; that</span>
<span class="cm">		   is taking too long. Maybe just use non-interruptible sleep on? -- REW */</span>
		<span class="n">interruptible_sleep_on</span> <span class="p">(</span><span class="o">&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">txtp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">;</span>
	<span class="n">rxtp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">;</span>
  

	<span class="cm">/* See App note XXX (Unpublished as of now) for the reason for the </span>
<span class="cm">	   removal of the &quot;CMD_IMM_INQ&quot; part of the TX_PURGE_INH... -- REW */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DO_DIRECTION</span> <span class="p">(</span><span class="n">txtp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span>
				<span class="n">QE_CMD_TX_PURGE_INH</span> <span class="o">|</span> <span class="cm">/*QE_CMD_IMM_INQ|*/</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">clear_bit</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_inuse</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DO_DIRECTION</span> <span class="p">(</span><span class="n">rxtp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span>
				<span class="n">QE_CMD_RX_PURGE_INH</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span> <span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  
		<span class="cm">/* This means that this is configured as a receive channel */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_FS50</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Disable the receive filter. Is 0/0 indeed an invalid receive</span>
<span class="cm">			   channel? -- REW.  Yes it is. -- Hang. Ok. I&#39;ll use -1</span>
<span class="cm">			   (0xfff...) -- REW */</span>
			<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span> 
					<span class="n">QE_CMD_REG_WR</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span><span class="p">,</span>
					<span class="mh">0x80</span> <span class="o">+</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span> 
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free vcc: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">vcc</span><span class="p">);</span>

	<span class="n">func_exit</span> <span class="p">();</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">fs_send</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atm_vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">FS_DEV</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fs_vcc</span> <span class="o">*</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">FS_VCC</span> <span class="p">(</span><span class="n">atm_vcc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">FS_BPENTRY</span> <span class="o">*</span><span class="n">td</span><span class="p">;</span>

	<span class="n">func_enter</span> <span class="p">();</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_TXMEM</span><span class="p">,</span> <span class="s">&quot;I&quot;</span><span class="p">);</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_SEND</span><span class="p">,</span> <span class="s">&quot;Send: atm_vcc %p skb %p vcc %p dev %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">atm_vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc t-skb: %p (atm_send)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">atm_vcc</span><span class="p">;</span>

	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">last_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">td</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">FS_BPENTRY</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc transd: %p(%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">td</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">FS_BPENTRY</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">td</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Oops out of mem */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_SEND</span><span class="p">,</span> <span class="s">&quot;first word in buffer: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="n">td</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span>  <span class="n">TD_EPI</span> <span class="o">|</span> <span class="n">TD_DATA</span> <span class="o">|</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">bsa</span>  <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">td</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ntxpckts</span><span class="o">++</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_EXTRA</span>
	<span class="n">da</span><span class="p">[</span><span class="n">qd</span><span class="p">]</span> <span class="o">=</span> <span class="n">td</span><span class="p">;</span>
	<span class="n">dq</span><span class="p">[</span><span class="n">qd</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">dq</span><span class="p">[</span><span class="n">qd</span><span class="p">].</span><span class="n">next</span>  <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">dq</span><span class="p">[</span><span class="n">qd</span><span class="p">].</span><span class="n">bsa</span>   <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">bsa</span><span class="p">;</span>
	<span class="n">dq</span><span class="p">[</span><span class="n">qd</span><span class="p">].</span><span class="n">skb</span>   <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">dq</span><span class="p">[</span><span class="n">qd</span><span class="p">].</span><span class="n">dev</span>   <span class="o">=</span> <span class="n">td</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">qd</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qd</span> <span class="o">&gt;=</span> <span class="mi">60</span><span class="p">)</span> <span class="n">qd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">submit_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span> 
		      <span class="n">QE_TRANSMIT_DE</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span>
		      <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">td</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> 
		      <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">td</span><span class="p">));</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;in send: txq %d txrq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_EA</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span> <span class="o">-</span>
		    <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_SA</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">.</span><span class="n">offset</span><span class="p">)),</span>
		    <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_EA</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_relq</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span> <span class="o">-</span>
		    <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_SA</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_relq</span><span class="p">.</span><span class="n">offset</span><span class="p">)));</span>

	<span class="n">func_exit</span> <span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Some function placeholders for functions we don&#39;t yet support. */</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int fs_ioctl(struct atm_dev *dev,unsigned int cmd,void __user *arg)</span>
<span class="c">{</span>
<span class="c">	func_enter ();</span>
<span class="c">	func_exit ();</span>
<span class="c">	return -ENOIOCTLCMD;</span>
<span class="c">}</span>


<span class="c">static int fs_getsockopt(struct atm_vcc *vcc,int level,int optname,</span>
<span class="c">			 void __user *optval,int optlen)</span>
<span class="c">{</span>
<span class="c">	func_enter ();</span>
<span class="c">	func_exit ();</span>
<span class="c">	return 0;</span>
<span class="c">}</span>


<span class="c">static int fs_setsockopt(struct atm_vcc *vcc,int level,int optname,</span>
<span class="c">			 void __user *optval,unsigned int optlen)</span>
<span class="c">{</span>
<span class="c">	func_enter ();</span>
<span class="c">	func_exit ();</span>
<span class="c">	return 0;</span>
<span class="c">}</span>


<span class="c">static void fs_phy_put(struct atm_dev *dev,unsigned char value,</span>
<span class="c">		       unsigned long addr)</span>
<span class="c">{</span>
<span class="c">	func_enter ();</span>
<span class="c">	func_exit ();</span>
<span class="c">}</span>


<span class="c">static unsigned char fs_phy_get(struct atm_dev *dev,unsigned long addr)</span>
<span class="c">{</span>
<span class="c">	func_enter ();</span>
<span class="c">	func_exit ();</span>
<span class="c">	return 0;</span>
<span class="c">}</span>


<span class="c">static int fs_change_qos(struct atm_vcc *vcc,struct atm_qos *qos,int flags)</span>
<span class="c">{</span>
<span class="c">	func_enter ();</span>
<span class="c">	func_exit ();</span>
<span class="c">	return 0;</span>
<span class="c">};</span>

<span class="cp">#endif</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>         <span class="n">fs_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>        <span class="n">fs_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send</span> <span class="o">=</span>         <span class="n">fs_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>        <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="cm">/* ioctl:          fs_ioctl, */</span>
	<span class="cm">/* getsockopt:     fs_getsockopt, */</span>
	<span class="cm">/* setsockopt:     fs_setsockopt, */</span>
	<span class="cm">/* change_qos:     fs_change_qos, */</span>

	<span class="cm">/* For now implement these internally here... */</span>  
	<span class="cm">/* phy_put:        fs_phy_put, */</span>
	<span class="cm">/* phy_get:        fs_phy_get, */</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">undocumented_pci_fix</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tint</span><span class="p">;</span>

	<span class="cm">/* The Windows driver says: */</span>
	<span class="cm">/* Switch off FireStream Retry Limit Threshold </span>
<span class="cm">	 */</span>

	<span class="cm">/* The register at 0x28 is documented as &quot;reserved&quot;, no further</span>
<span class="cm">	   comments. */</span>

	<span class="n">pci_read_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tint</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tint</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tint</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">pci_write_config_dword</span> <span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="n">tint</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>



<span class="cm">/**************************************************************************</span>
<span class="cm"> *                              PHY routines                              *</span>
<span class="cm"> **************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">write_phy</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">regnum</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span> <span class="n">QE_CMD_PRP_WR</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span><span class="p">,</span>
			<span class="n">regnum</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_phy</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">reginit_item</span> <span class="o">*</span><span class="n">reginit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">func_enter</span> <span class="p">();</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">reginit</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">PHY_EOF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reginit</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">==</span> <span class="n">PHY_CLEARALL</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* &quot;PHY_CLEARALL means clear all registers. Numregisters is in &quot;val&quot;. */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">reginit</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">write_phy</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">write_phy</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reginit</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">reginit</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">reginit</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">func_exit</span> <span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_chip</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SARMODE0</span><span class="p">,</span> <span class="n">SARMODE0_SRTS0</span><span class="p">);</span>

	<span class="cm">/* Undocumented delay */</span>
	<span class="n">udelay</span> <span class="p">(</span><span class="mi">128</span><span class="p">);</span>

	<span class="cm">/* The &quot;internal registers are documented to all reset to zero, but </span>
<span class="cm">	   comments &amp; code in the Windows driver indicates that the pools are</span>
<span class="cm">	   NOT reset. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">FS_NR_FREE_POOLS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CNF</span> <span class="p">(</span><span class="n">RXB_FP</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_SA</span>  <span class="p">(</span><span class="n">RXB_FP</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_EA</span>  <span class="p">(</span><span class="n">RXB_FP</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CNT</span> <span class="p">(</span><span class="n">RXB_FP</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CTU</span> <span class="p">(</span><span class="n">RXB_FP</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* The same goes for the match channel registers, although those are</span>
<span class="cm">	   NOT documented that way in the Windows driver. -- REW */</span>
	<span class="cm">/* The Windows driver DOES write 0 to these registers somewhere in</span>
<span class="cm">	   the init sequence. However, a small hardware-feature, will</span>
<span class="cm">	   prevent reception of data on VPI/VCI = 0/0 (Unless the channel</span>
<span class="cm">	   allocated happens to have no disabled channels that have a lower</span>
<span class="cm">	   number. -- REW */</span>

	<span class="cm">/* Clear the match channel registers. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FS50</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">FS50_NR_CHANNELS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x200</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="o">*</span><span class="nf">aligned_kmalloc</span> <span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">alignment</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span>  <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">alignment</span> <span class="o">&lt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">t</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">alignment</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="s">&quot;Kmalloc doesn&#39;t align things correctly! %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">aligned_kmalloc</span> <span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">alignment</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">t</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Request for &gt; 0x10 alignment not yet implemented (hard!)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_q</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> 
			  <span class="k">struct</span> <span class="n">queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nentries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_rq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="n">nentries</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">FS_QENTRY</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">FS_QENTRY</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">func_enter</span> <span class="p">();</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;Inititing queue at %x: %d entries:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">queue</span><span class="p">,</span> <span class="n">nentries</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">aligned_kmalloc</span> <span class="p">(</span><span class="n">sz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc queue: %p(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_SA</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_EA</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">nentries</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_WP</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_rq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Configuration for the receive queue: 0: interrupt immediately,</span>
<span class="cm">		   no pre-warning to empty queues: We do our best to keep the</span>
<span class="cm">		   queue filled anyway. */</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_CNF</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="mi">0</span> <span class="p">);</span> 
	<span class="p">}</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">sa</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">ea</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">queue</span><span class="p">;</span> 

	<span class="n">func_exit</span> <span class="p">();</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">init_fp</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> 
			   <span class="k">struct</span> <span class="n">freepool</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_buffers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">func_enter</span> <span class="p">();</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;Inititing free pool at %x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CNF</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="p">(</span><span class="n">bufsize</span> <span class="o">*</span> <span class="n">RBFP_RBS</span><span class="p">)</span> <span class="o">|</span> <span class="n">RBFP_RBSVAL</span> <span class="o">|</span> <span class="n">RBFP_CME</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_SA</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_EA</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>  <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CTU</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CNT</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">queue</span><span class="p">;</span> 
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">bufsize</span><span class="p">;</span>
	<span class="n">fp</span><span class="o">-&gt;</span><span class="n">nr_buffers</span> <span class="o">=</span> <span class="n">nr_buffers</span><span class="p">;</span>

	<span class="n">func_exit</span> <span class="p">();</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">nr_buffers_in_freepool</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">freepool</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* This seems to be unreliable.... */</span>
<span class="c">	return read_fs (dev, FP_CNT (fp-&gt;offset));</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/* Check if this gets going again if a pool ever runs out.  -- Yes, it</span>
<span class="cm">   does. I&#39;ve seen &quot;receive abort: no buffers&quot; and things started</span>
<span class="cm">   working again after that...  -- REW */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">top_off_fp</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">freepool</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span>
			<span class="n">gfp_t</span> <span class="n">gfp_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">FS_BPENTRY</span> <span class="o">*</span><span class="n">qe</span><span class="p">,</span> <span class="o">*</span><span class="n">ne</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qe_tmp</span><span class="p">;</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;Topping off queue at %x (%d-%d/%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CNT</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)),</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">,</span> 
		    <span class="n">fp</span><span class="o">-&gt;</span><span class="n">nr_buffers</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nr_buffers_in_freepool</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">nr_buffers</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">,</span> <span class="n">gfp_flags</span><span class="p">);</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc rec-skb: %p(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">ne</span> <span class="o">=</span> <span class="n">kmalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">FS_BPENTRY</span><span class="p">),</span> <span class="n">gfp_flags</span><span class="p">);</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc rec-d: %p(%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">FS_BPENTRY</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ne</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free rec-skb: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;Adding skb %p desc %p -&gt; %p(%p) &quot;</span><span class="p">,</span> 
			    <span class="n">skb</span><span class="p">,</span> <span class="n">ne</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ne</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FP_FLAGS_EPI</span> <span class="o">|</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">;</span>
		<span class="n">ne</span><span class="o">-&gt;</span><span class="n">next</span>  <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="n">ne</span><span class="o">-&gt;</span><span class="n">bsa</span>   <span class="o">=</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">ne</span><span class="o">-&gt;</span><span class="n">aal_bufsize</span> <span class="o">=</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">;</span>
		<span class="n">ne</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">ne</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="n">fp</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * FIXME: following code encodes and decodes</span>
<span class="cm">		 * machine pointers (could be 64-bit) into a</span>
<span class="cm">		 * 32-bit register.</span>
<span class="cm">		 */</span>

		<span class="n">qe_tmp</span> <span class="o">=</span> <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_EA</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">));</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;link at %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">qe_tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qe_tmp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qe</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">qe_tmp</span><span class="p">);</span>
			<span class="n">qe</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">ne</span><span class="p">);</span>
			<span class="n">qe</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FP_FLAGS_EPI</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_SA</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">virt_to_bus</span><span class="p">(</span><span class="n">ne</span><span class="p">));</span>

		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_EA</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="n">virt_to_bus</span> <span class="p">(</span><span class="n">ne</span><span class="p">));</span>
		<span class="n">fp</span><span class="o">-&gt;</span><span class="n">n</span><span class="o">++</span><span class="p">;</span>   <span class="cm">/* XXX Atomic_inc? */</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CTU</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;Added %d entries. </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">free_queue</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">func_enter</span> <span class="p">();</span>

	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_SA</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_EA</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_RP</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_WP</span><span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Configuration ? */</span>

	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free queue: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">sa</span><span class="p">);</span>

	<span class="n">func_exit</span> <span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">free_freepool</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">freepool</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">func_enter</span> <span class="p">();</span>

	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CNF</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_SA</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_EA</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CNT</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_CTU</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">func_exit</span> <span class="p">();</span>
<span class="p">}</span>



<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">fs_irq</span> <span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ISR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">func_enter</span> <span class="p">();</span>

<span class="cp">#ifdef IRQ_RATE_LIMIT</span>
	<span class="cm">/* Aaargh! I&#39;m ashamed. This costs more lines-of-code than the actual </span>
<span class="cm">	   interrupt routine!. (Well, used to when I wrote that comment) -- REW */</span>
	<span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">lastjif</span><span class="p">;</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">nintr</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    
		<span class="k">if</span> <span class="p">(</span><span class="n">lastjif</span> <span class="o">==</span> <span class="n">jiffies</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">nintr</span> <span class="o">&gt;</span> <span class="n">IRQ_RATE_LIMIT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free_irq</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev_id</span><span class="p">);</span>
				<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;fs: Too many interrupts. Turning off interrupt %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lastjif</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">nintr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_QUEUE</span><span class="p">,</span> <span class="s">&quot;in intr: txq %d txrq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_EA</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span> <span class="o">-</span>
		    <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_SA</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">.</span><span class="n">offset</span><span class="p">)),</span>
		    <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_EA</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_relq</span><span class="p">.</span><span class="n">offset</span><span class="p">))</span> <span class="o">-</span>
		    <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">Q_SA</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_relq</span><span class="p">.</span><span class="n">offset</span><span class="p">)));</span>

	<span class="cm">/* print the bits in the ISR register. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fs_debug</span> <span class="o">&amp;</span> <span class="n">FS_DEBUG_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The FS_DEBUG things are unnecessary here. But this way it is</span>
<span class="cm">		   clear for grep that these are debug prints. */</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_IRQ</span><span class="p">,</span>  <span class="s">&quot;IRQ status:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">27</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> 
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> 
				<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">irq_bitname</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_RBRQ0_W</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;Iiiin-coming (0)!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">process_incoming</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_rq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="cm">/* items mentioned on RBRQ0 are from FP 0 or 1. */</span>
		<span class="n">top_off_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">top_off_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_RBRQ1_W</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;Iiiin-coming (1)!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">process_incoming</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_rq</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">top_off_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">top_off_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_RBRQ2_W</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;Iiiin-coming (2)!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">process_incoming</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_rq</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">top_off_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">top_off_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_RBRQ3_W</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;Iiiin-coming (3)!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">process_incoming</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_rq</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">top_off_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">top_off_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_CSQ_W</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;Command executed ok!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">process_return_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">st_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISR_TBRQ_W</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;Data tramsitted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">process_txdone_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_relq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">func_exit</span> <span class="p">();</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef FS_POLL_FREQ</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fs_poll</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
  
	<span class="n">fs_irq</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">FS_POLL_FREQ</span><span class="p">;</span>
	<span class="n">add_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">fs_init</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>  <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">isr</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">func_enter</span> <span class="p">();</span>
	<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>

	<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;found a FireStream %d card, base %16llx, irq%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">IS_FS50</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">?</span><span class="mi">50</span><span class="o">:</span><span class="mi">155</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fs_debug</span> <span class="o">&amp;</span> <span class="n">FS_DEBUG_INIT</span><span class="p">)</span>
		<span class="n">my_hd</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">undocumented_pci_fix</span> <span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>

	<span class="n">reset_chip</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
  
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SARMODE0</span><span class="p">,</span> <span class="mi">0</span> 
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE0_SHADEN</span><span class="p">)</span> <span class="cm">/* We don&#39;t use shadow registers. */</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE0_INTMODE_READCLEAR</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE0_CWRE</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="n">IS_FS50</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="n">SARMODE0_PRPWT_FS50_5</span><span class="o">:</span>
			  <span class="n">SARMODE0_PRPWT_FS155_3</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE0_CALSUP_1</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="n">IS_FS50</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">0</span>
				   <span class="o">|</span> <span class="n">SARMODE0_RXVCS_32</span>
				   <span class="o">|</span> <span class="n">SARMODE0_ABRVCS_32</span> 
				   <span class="o">|</span> <span class="n">SARMODE0_TXVCS_32</span><span class="p">)</span><span class="o">:</span>
		                  <span class="p">(</span><span class="mi">0</span>
				   <span class="o">|</span> <span class="n">SARMODE0_RXVCS_1k</span>
				   <span class="o">|</span> <span class="n">SARMODE0_ABRVCS_1k</span> 
				   <span class="o">|</span> <span class="n">SARMODE0_TXVCS_1k</span><span class="p">)));</span>

	<span class="cm">/* 10ms * 100 is 1 second. That should be enough, as AN3:9 says it takes</span>
<span class="cm">	   1ms. */</span>
	<span class="n">to</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isr</span> <span class="o">=</span> <span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ISR</span><span class="p">);</span>

		<span class="cm">/* This bit is documented as &quot;RESERVED&quot; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_INIT_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Error initializing the FS... </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_INIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;Ha! Initialized OK!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Try again after 10ms. */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;timeout initializing the FS... </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* XXX fix for fs155 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">channel_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span> 
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">channo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* AN3: 10 */</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SARMODE1</span><span class="p">,</span> <span class="mi">0</span> 
		  <span class="o">|</span> <span class="p">(</span><span class="n">fs_keystream</span> <span class="o">*</span> <span class="n">SARMODE1_DEFHEC</span><span class="p">)</span> <span class="cm">/* XXX PHY */</span>
		  <span class="o">|</span> <span class="p">((</span><span class="n">loopback</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">SARMODE1_TSTLP</span><span class="p">)</span> <span class="cm">/* XXX Loopback mode enable... */</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE1_DCRM</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE1_DCOAM</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE1_OAMCRC</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE1_DUMPE</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE1_GPLEN</span><span class="p">)</span> 
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE1_GNAM</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE1_GVAS</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE1_GPAS</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE1_GPRI</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE1_PMS</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE1_GFCR</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE1_HECM2</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE1_HECM1</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE1_HECM0</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="cm">/* That&#39;s what hang&#39;s driver does. Program to 0 */</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="mh">0xff</span><span class="p">)</span> <span class="cm">/* XXX FS155 */</span><span class="p">);</span>


	<span class="cm">/* Cal prescale etc */</span>

	<span class="cm">/* AN3: 11 */</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">TMCONF</span><span class="p">,</span> <span class="mh">0x0000000f</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CALPRESCALE</span><span class="p">,</span> <span class="mh">0x01010101</span> <span class="o">*</span> <span class="n">num</span><span class="p">);</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x000F00E4</span><span class="p">);</span>

	<span class="cm">/* AN3: 12 */</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CELLOSCONF</span><span class="p">,</span> <span class="mi">0</span>
		  <span class="o">|</span> <span class="p">(</span>   <span class="mi">0</span> <span class="o">*</span> <span class="n">CELLOSCONF_CEN</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span>       <span class="n">CELLOSCONF_SC1</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mh">0x80</span> <span class="o">*</span> <span class="n">CELLOSCONF_COBS</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="n">num</span>  <span class="o">*</span> <span class="n">CELLOSCONF_COPK</span><span class="p">)</span>  <span class="cm">/* Changed from 0xff to 0x5a */</span>
		  <span class="o">|</span> <span class="p">(</span><span class="n">num</span>  <span class="o">*</span> <span class="n">CELLOSCONF_COST</span><span class="p">));</span><span class="cm">/* after a hint from Hang. </span>
<span class="cm">					       * performance jumped 50-&gt;70... */</span>

	<span class="cm">/* Magic value by Hang */</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">CELLOSCONF_COST</span><span class="p">,</span> <span class="mh">0x0B809191</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_FS50</span> <span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RAS0</span><span class="p">,</span> <span class="n">RAS0_DCD_XHLT</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nchannels</span> <span class="o">=</span> <span class="n">FS50_NR_CHANNELS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RAS0</span><span class="p">,</span> <span class="n">RAS0_DCD_XHLT</span> 
			  <span class="o">|</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FS155_VPI_BITS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">RAS0_VPSEL</span><span class="p">)</span>
			  <span class="o">|</span> <span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FS155_VCI_BITS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">RAS0_VCSEL</span><span class="p">));</span>
		<span class="cm">/* We can chose the split arbitrarily. We might be able to </span>
<span class="cm">		   support more. Whatever. This should do for now. */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="n">FS155_VPI_BITS</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="n">FS155_VCI_BITS</span><span class="p">;</span>
    
		<span class="cm">/* Address bits we can&#39;t use should be compared to 0. */</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RAC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Manual (AN9, page 6) says ASF1=0 means compare Utopia address</span>
<span class="cm">		 * too.  I can&#39;t find ASF1 anywhere. Anyway, we AND with just the</span>
<span class="cm">		 * other bits, then compare with 0, which is exactly what we</span>
<span class="cm">		 * want. */</span>
		<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RAM</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">28</span> <span class="o">-</span> <span class="n">FS155_VPI_BITS</span> <span class="o">-</span> <span class="n">FS155_VCI_BITS</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nchannels</span> <span class="o">=</span> <span class="n">FS155_NR_CHANNELS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span> <span class="o">=</span> <span class="n">kcalloc</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="p">),</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc atmvccs: %p(%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nchannels</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Couldn&#39;t allocate memory for VCC buffers. Woops!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* XXX Clean up..... */</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_inuse</span> <span class="o">=</span> <span class="n">kzalloc</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nchannels</span> <span class="o">/</span> <span class="mi">8</span> <span class="cm">/* bits/byte */</span> <span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc tx_inuse: %p(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nchannels</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Couldn&#39;t allocate memory for tx_inuse bits!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* XXX Clean up..... */</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* -- RAS1 : FS155 and 50 differ. Default (0) should be OK for both */</span>
	<span class="cm">/* -- RAS2 : FS50 only: Default is OK. */</span>

	<span class="cm">/* DMAMODE, default should be OK. -- REW */</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMAMR</span><span class="p">,</span> <span class="n">DMAMR_TX_MODE_FULL</span><span class="p">);</span>

	<span class="n">init_q</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span> <span class="n">TX_PQ</span><span class="p">(</span><span class="n">TXQ_HP</span><span class="p">),</span> <span class="n">TXQ_NENTRIES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_q</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lp_txq</span><span class="p">,</span> <span class="n">TX_PQ</span><span class="p">(</span><span class="n">TXQ_LP</span><span class="p">),</span> <span class="n">TXQ_NENTRIES</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_q</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_relq</span><span class="p">,</span> <span class="n">TXB_RQ</span><span class="p">,</span> <span class="n">TXQ_NENTRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">init_q</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">st_q</span><span class="p">,</span> <span class="n">ST_Q</span><span class="p">,</span> <span class="n">TXQ_NENTRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">FS_NR_FREE_POOLS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RXB_FP</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> 
			 <span class="n">rx_buf_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rx_pool_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">top_off_fp</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">FS_NR_RX_QUEUES</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">init_q</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_rq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RXB_RQ</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">RXRQ_NENTRIES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">fs_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;firestream&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;couldn&#39;t get irq %d for firestream.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="cm">/* XXX undo all previous stuff... */</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_INIT</span><span class="p">,</span> <span class="s">&quot;Grabbed irq %d for dev at %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
  
	<span class="cm">/* We want to be notified of most things. Just the statistics count</span>
<span class="cm">	   overflows are not interesting */</span>
	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IMR</span><span class="p">,</span> <span class="mi">0</span>
		  <span class="o">|</span> <span class="n">ISR_RBRQ0_W</span> 
		  <span class="o">|</span> <span class="n">ISR_RBRQ1_W</span> 
		  <span class="o">|</span> <span class="n">ISR_RBRQ2_W</span> 
		  <span class="o">|</span> <span class="n">ISR_RBRQ3_W</span> 
		  <span class="o">|</span> <span class="n">ISR_TBRQ_W</span>
		  <span class="o">|</span> <span class="n">ISR_CSQ_W</span><span class="p">);</span>

	<span class="n">write_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SARMODE0</span><span class="p">,</span> <span class="mi">0</span> 
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE0_SHADEN</span><span class="p">)</span> <span class="cm">/* We don&#39;t use shadow registers. */</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE0_GINT</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE0_INTMODE_READCLEAR</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">*</span> <span class="n">SARMODE0_CWRE</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="n">IS_FS50</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">?</span><span class="n">SARMODE0_PRPWT_FS50_5</span><span class="o">:</span> 
		                  <span class="n">SARMODE0_PRPWT_FS155_3</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE0_CALSUP_1</span><span class="p">)</span>
		  <span class="o">|</span> <span class="p">(</span><span class="n">IS_FS50</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="mi">0</span>
				    <span class="o">|</span> <span class="n">SARMODE0_RXVCS_32</span>
				    <span class="o">|</span> <span class="n">SARMODE0_ABRVCS_32</span> 
				    <span class="o">|</span> <span class="n">SARMODE0_TXVCS_32</span><span class="p">)</span><span class="o">:</span>
		                   <span class="p">(</span><span class="mi">0</span>
				    <span class="o">|</span> <span class="n">SARMODE0_RXVCS_1k</span>
				    <span class="o">|</span> <span class="n">SARMODE0_ABRVCS_1k</span> 
				    <span class="o">|</span> <span class="n">SARMODE0_TXVCS_1k</span><span class="p">))</span>
		  <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">SARMODE0_RUN</span><span class="p">));</span>

	<span class="n">init_phy</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PHY_NTC_INIT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loopback</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_phy</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef FS_POLL_FREQ</span>
	<span class="n">init_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">fs_poll</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">FS_POLL_FREQ</span><span class="p">;</span>
	<span class="n">add_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
  
	<span class="n">func_exit</span> <span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">firestream_init_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span>
				       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atm_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">fs_dev</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">))</span> 
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="n">fs_dev</span> <span class="o">=</span> <span class="n">kzalloc</span> <span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Alloc fs-dev: %p(%Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fs_dev</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fs_dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fs_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">atm_dev</span> <span class="o">=</span> <span class="n">atm_dev_register</span><span class="p">(</span><span class="s">&quot;fs&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atm_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free_fs_dev</span><span class="p">;</span>
  
	<span class="n">fs_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">fs_dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span> <span class="o">=</span> <span class="n">atm_dev</span><span class="p">;</span>
	<span class="n">fs_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fs_init</span><span class="p">(</span><span class="n">fs_dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out_free_atm_dev</span><span class="p">;</span>

	<span class="n">fs_dev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">fs_boards</span><span class="p">;</span>
	<span class="n">fs_boards</span> <span class="o">=</span> <span class="n">fs_dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_out_free_atm_dev:</span>
	<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">atm_dev</span><span class="p">);</span>
 <span class="nl">err_out_free_fs_dev:</span>
 	<span class="n">kfree</span><span class="p">(</span><span class="n">fs_dev</span><span class="p">);</span>
 <span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">firestream_remove_one</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fs_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="n">nxtdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fs_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">FS_BPENTRY</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="o">*</span><span class="n">nxt</span><span class="p">;</span>
  
	<span class="n">func_enter</span> <span class="p">();</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	printk (&quot;hptxq:\n&quot;);</span>
<span class="c">	for (i=0;i&lt;60;i++) {</span>
<span class="c">		printk (&quot;%d: %08x %08x %08x %08x \n&quot;, </span>
<span class="c">			i, pq[qp].cmd, pq[qp].p0, pq[qp].p1, pq[qp].p2);</span>
<span class="c">		qp++;</span>
<span class="c">		if (qp &gt;= 60) qp = 0;</span>
<span class="c">	}</span>

<span class="c">	printk (&quot;descriptors:\n&quot;);</span>
<span class="c">	for (i=0;i&lt;60;i++) {</span>
<span class="c">		printk (&quot;%d: %p: %08x %08x %p %p\n&quot;, </span>
<span class="c">			i, da[qd], dq[qd].flags, dq[qd].bsa, dq[qd].skb, dq[qd].dev);</span>
<span class="c">		qd++;</span>
<span class="c">		if (qd &gt;= 60) qd = 0;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fs_boards</span><span class="p">;</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span><span class="n">dev</span><span class="o">=</span><span class="n">nxtdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_CLEANUP</span><span class="p">,</span> <span class="s">&quot;Releasing resources for dev at %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* XXX Hit all the tx channels too! */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">vcc</span> <span class="o">=</span> <span class="n">FS_VCC</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span>
						<span class="n">QE_CMD_TX_PURGE_INH</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
				<span class="n">submit_command</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">,</span>
						<span class="n">QE_CMD_RX_PURGE_INH</span> <span class="o">|</span> <span class="n">QE_CMD_IMM_INQ</span> <span class="o">|</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">channo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* XXX Wait a while for the chip to release all buffers. */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">FS_NR_FREE_POOLS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">fp</span><span class="o">=</span><span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">read_fs</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">FP_SA</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">)));</span>
			     <span class="o">!</span><span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FP_FLAGS_EPI</span><span class="p">);</span><span class="n">fp</span> <span class="o">=</span> <span class="n">nxt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free rec-skb: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dev_kfree_skb_any</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">nxt</span> <span class="o">=</span> <span class="n">bus_to_virt</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
				<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free rec-d: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free rec-skb: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free rec-d: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fp</span><span class="p">);</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Hang the chip in &quot;reset&quot;, prevent it clobbering memory that is</span>
<span class="cm">		   no longer ours. */</span>
		<span class="n">reset_chip</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_CLEANUP</span><span class="p">,</span> <span class="s">&quot;Freeing irq%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">free_irq</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">del_timer</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

		<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_dev</span><span class="p">);</span>
		<span class="n">free_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hp_txq</span><span class="p">);</span>
		<span class="n">free_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lp_txq</span><span class="p">);</span>
		<span class="n">free_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_relq</span><span class="p">);</span>
		<span class="n">free_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">st_q</span><span class="p">);</span>

		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free atmvccs: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">atm_vccs</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span> <span class="n">FS_NR_FREE_POOLS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">free_freepool</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_fp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">FS_NR_RX_QUEUES</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">free_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_rq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
		<span class="n">fs_dprintk</span> <span class="p">(</span><span class="n">FS_DEBUG_ALLOC</span><span class="p">,</span> <span class="s">&quot;Free fs-dev: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">nxtdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">func_exit</span> <span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">firestream_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">FUJITSU_ME</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FUJITSU_FS50</span><span class="p">),</span> <span class="n">FS_IS50</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">FUJITSU_ME</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FUJITSU_FS155</span><span class="p">),</span> <span class="n">FS_IS155</span><span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">firestream_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">firestream_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;firestream&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">firestream_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">firestream_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">firestream_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">firestream_init_module</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">func_enter</span> <span class="p">();</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">firestream_driver</span><span class="p">);</span>
	<span class="n">func_exit</span> <span class="p">();</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">firestream_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">firestream_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">firestream_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">firestream_cleanup_module</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Now the mantissa is in positions bit 16-25. Excepf for the "hidden 1" that's in bit 26.</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Next add in the exponent</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>And perform the rounding:</p></td><td class="code"><div class="highlight"><pre>undefined</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
