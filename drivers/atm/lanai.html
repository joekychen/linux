<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › atm › lanai.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>lanai.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* lanai.c -- Copyright 1999-2003 by Mitchell Blank Jr &lt;mitch@sfgoth.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License</span>
<span class="cm"> *  as published by the Free Software Foundation; either version</span>
<span class="cm"> *  2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver supports ATM cards based on the Efficient &quot;Lanai&quot;</span>
<span class="cm"> * chipset such as the Speedstream 3010 and the ENI-25p.  The</span>
<span class="cm"> * Speedstream 3060 is currently not supported since we don&#39;t</span>
<span class="cm"> * have the code to drive the on-board Alcatel DSL chipset (yet).</span>
<span class="cm"> *</span>
<span class="cm"> * Thanks to Efficient for supporting this project with hardware,</span>
<span class="cm"> * documentation, and by answering my questions.</span>
<span class="cm"> *</span>
<span class="cm"> * Things not working yet:</span>
<span class="cm"> *</span>
<span class="cm"> * o  We don&#39;t support the Speedstream 3060 yet - this card has</span>
<span class="cm"> *    an on-board DSL modem chip by Alcatel and the driver will</span>
<span class="cm"> *    need some extra code added to handle it</span>
<span class="cm"> *</span>
<span class="cm"> * o  Note that due to limitations of the Lanai only one VCC can be</span>
<span class="cm"> *    in CBR at once</span>
<span class="cm"> *</span>
<span class="cm"> * o We don&#39;t currently parse the EEPROM at all.  The code is all</span>
<span class="cm"> *   there as per the spec, but it doesn&#39;t actually work.  I think</span>
<span class="cm"> *   there may be some issues with the docs.  Anyway, do NOT</span>
<span class="cm"> *   enable it yet - bugs in that code may actually damage your</span>
<span class="cm"> *   hardware!  Because of this you should hardware an ESI before</span>
<span class="cm"> *   trying to use this in a LANE or MPOA environment.</span>
<span class="cm"> *</span>
<span class="cm"> * o  AAL0 is stubbed in but the actual rx/tx path isn&#39;t written yet:</span>
<span class="cm"> *	vcc_tx_aal0() needs to send or queue a SKB</span>
<span class="cm"> *	vcc_tx_unqueue_aal0() needs to attempt to send queued SKBs</span>
<span class="cm"> *	vcc_rx_aal0() needs to handle AAL0 interrupts</span>
<span class="cm"> *    This isn&#39;t too much work - I just wanted to get other things</span>
<span class="cm"> *    done first.</span>
<span class="cm"> *</span>
<span class="cm"> * o  lanai_change_qos() isn&#39;t written yet</span>
<span class="cm"> *</span>
<span class="cm"> * o  There aren&#39;t any ioctl&#39;s yet -- I&#39;d like to eventually support</span>
<span class="cm"> *    setting loopback and LED modes that way.</span>
<span class="cm"> *</span>
<span class="cm"> * o  If the segmentation engine or DMA gets shut down we should restart</span>
<span class="cm"> *    card as per section 17.0i.  (see lanai_reset)</span>
<span class="cm"> *</span>
<span class="cm"> * o setsockopt(SO_CIRANGE) isn&#39;t done (although despite what the</span>
<span class="cm"> *   API says it isn&#39;t exactly commonly implemented)</span>
<span class="cm"> */</span>

<span class="cm">/* Version history:</span>
<span class="cm"> *   v.1.00 -- 26-JUL-2003 -- PCI/DMA updates</span>
<span class="cm"> *   v.0.02 -- 11-JAN-2000 -- Endian fixes</span>
<span class="cm"> *   v.0.01 -- 30-NOV-1999 -- Initial release</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cm">/* -------------------- TUNABLE PARAMATERS: */</span>

<span class="cm">/*</span>
<span class="cm"> * Maximum number of VCIs per card.  Setting it lower could theoretically</span>
<span class="cm"> * save some memory, but since we allocate our vcc list with get_free_pages,</span>
<span class="cm"> * it&#39;s not really likely for most architectures</span>
<span class="cm"> */</span>
<span class="cp">#define NUM_VCI			(1024)</span>

<span class="cm">/*</span>
<span class="cm"> * Enable extra debugging</span>
<span class="cm"> */</span>
<span class="cp">#define DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * Debug _all_ register operations with card, except the memory test.</span>
<span class="cm"> * Also disables the timed poll to prevent extra chattiness.  This</span>
<span class="cm"> * isn&#39;t for normal use</span>
<span class="cm"> */</span>
<span class="cp">#undef DEBUG_RW</span>

<span class="cm">/*</span>
<span class="cm"> * The programming guide specifies a full test of the on-board SRAM</span>
<span class="cm"> * at initialization time.  Undefine to remove this</span>
<span class="cm"> */</span>
<span class="cp">#define FULL_MEMORY_TEST</span>

<span class="cm">/*</span>
<span class="cm"> * This is the number of (4 byte) service entries that we will</span>
<span class="cm"> * try to allocate at startup.  Note that we will end up with</span>
<span class="cm"> * one PAGE_SIZE&#39;s worth regardless of what this is set to</span>
<span class="cm"> */</span>
<span class="cp">#define SERVICE_ENTRIES		(1024)</span>
<span class="cm">/* TODO: make above a module load-time option */</span>

<span class="cm">/*</span>
<span class="cm"> * We normally read the onboard EEPROM in order to discover our MAC</span>
<span class="cm"> * address.  Undefine to _not_ do this</span>
<span class="cm"> */</span>
<span class="cm">/* #define READ_EEPROM */</span> <span class="cm">/* ***DONT ENABLE YET*** */</span>
<span class="cm">/* TODO: make above a module load-time option (also) */</span>

<span class="cm">/*</span>
<span class="cm"> * Depth of TX fifo (in 128 byte units; range 2-31)</span>
<span class="cm"> * Smaller numbers are better for network latency</span>
<span class="cm"> * Larger numbers are better for PCI latency</span>
<span class="cm"> * I&#39;m really sure where the best tradeoff is, but the BSD driver uses</span>
<span class="cm"> * 7 and it seems to work ok.</span>
<span class="cm"> */</span>
<span class="cp">#define TX_FIFO_DEPTH		(7)</span>
<span class="cm">/* TODO: make above a module load-time option */</span>

<span class="cm">/*</span>
<span class="cm"> * How often (in jiffies) we will try to unstick stuck connections -</span>
<span class="cm"> * shouldn&#39;t need to happen much</span>
<span class="cm"> */</span>
<span class="cp">#define LANAI_POLL_PERIOD	(10*HZ)</span>
<span class="cm">/* TODO: make above a module load-time option */</span>

<span class="cm">/*</span>
<span class="cm"> * When allocating an AAL5 receiving buffer, try to make it at least</span>
<span class="cm"> * large enough to hold this many max_sdu sized PDUs</span>
<span class="cm"> */</span>
<span class="cp">#define AAL5_RX_MULTIPLIER	(3)</span>
<span class="cm">/* TODO: make above a module load-time option */</span>

<span class="cm">/*</span>
<span class="cm"> * Same for transmitting buffer</span>
<span class="cm"> */</span>
<span class="cp">#define AAL5_TX_MULTIPLIER	(3)</span>
<span class="cm">/* TODO: make above a module load-time option */</span>

<span class="cm">/*</span>
<span class="cm"> * When allocating an AAL0 transmiting buffer, how many cells should fit.</span>
<span class="cm"> * Remember we&#39;ll end up with a PAGE_SIZE of them anyway, so this isn&#39;t</span>
<span class="cm"> * really critical</span>
<span class="cm"> */</span>
<span class="cp">#define AAL0_TX_MULTIPLIER	(40)</span>
<span class="cm">/* TODO: make above a module load-time option */</span>

<span class="cm">/*</span>
<span class="cm"> * How large should we make the AAL0 receiving buffer.  Remember that this</span>
<span class="cm"> * is shared between all AAL0 VC&#39;s</span>
<span class="cm"> */</span>
<span class="cp">#define AAL0_RX_BUFFER_SIZE	(PAGE_SIZE)</span>
<span class="cm">/* TODO: make above a module load-time option */</span>

<span class="cm">/*</span>
<span class="cm"> * Should we use Lanai&#39;s &quot;powerdown&quot; feature when no vcc&#39;s are bound?</span>
<span class="cm"> */</span>
<span class="cm">/* #define USE_POWERDOWN */</span>
<span class="cm">/* TODO: make above a module load-time option (also) */</span>

<span class="cm">/* -------------------- DEBUGGING AIDS: */</span>

<span class="cp">#define DEV_LABEL &quot;lanai&quot;</span>

<span class="cp">#ifdef DEBUG</span>

<span class="cp">#define DPRINTK(format, args...) \</span>
<span class="cp">	printk(KERN_DEBUG DEV_LABEL &quot;: &quot; format, ##args)</span>
<span class="cp">#define APRINTK(truth, format, args...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if (unlikely(!(truth))) \</span>
<span class="cp">			printk(KERN_ERR DEV_LABEL &quot;: &quot; format, ##args); \</span>
<span class="cp">	} while (0)</span>

<span class="cp">#else </span><span class="cm">/* !DEBUG */</span><span class="cp"></span>

<span class="cp">#define DPRINTK(format, args...)</span>
<span class="cp">#define APRINTK(truth, format, args...)</span>

<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="cp">#ifdef DEBUG_RW</span>
<span class="cp">#define RWDEBUG(format, args...) \</span>
<span class="cp">	printk(KERN_DEBUG DEV_LABEL &quot;: &quot; format, ##args)</span>
<span class="cp">#else </span><span class="cm">/* !DEBUG_RW */</span><span class="cp"></span>
<span class="cp">#define RWDEBUG(format, args...)</span>
<span class="cp">#endif</span>

<span class="cm">/* -------------------- DATA DEFINITIONS: */</span>

<span class="cp">#define LANAI_MAPPING_SIZE	(0x40000)</span>
<span class="cp">#define LANAI_EEPROM_SIZE	(128)</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="n">vci_t</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bus_addr_t</span><span class="p">;</span>

<span class="cm">/* DMA buffer in host memory for TX, RX, or service list. */</span>
<span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>	<span class="cm">/* From get_free_pages */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>	<span class="cm">/* One past last byte */</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>	<span class="cm">/* Pointer to current host location */</span>
	<span class="n">dma_addr_t</span> <span class="n">dmaaddr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lanai_vcc_stats</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">rx_nomem</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="n">rx_badlen</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="n">service_trash</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="n">service_stream</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="n">service_rxcrc</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">aal5</span><span class="p">;</span>
		<span class="k">struct</span> <span class="p">{</span>
		<span class="p">}</span> <span class="n">aal0</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">x</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lanai_dev</span><span class="p">;</span>			<span class="cm">/* Forward declaration */</span>

<span class="cm">/*</span>
<span class="cm"> * This is the card-specific per-vcc data.  Note that unlike some other</span>
<span class="cm"> * drivers there is NOT a 1-to-1 correspondance between these and</span>
<span class="cm"> * atm_vcc&#39;s - each one of these represents an actual 2-way vcc, but</span>
<span class="cm"> * an atm_vcc can be 1-way and share with a 1-way vcc in the other</span>
<span class="cm"> * direction.  To make it weirder, there can even be 0-way vccs</span>
<span class="cm"> * bound to us, waiting to do a change_qos</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="p">{</span>
	<span class="n">bus_addr_t</span> <span class="n">vbase</span><span class="p">;</span>		<span class="cm">/* Base of VCC&#39;s registers */</span>
	<span class="k">struct</span> <span class="n">lanai_vcc_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nref</span><span class="p">;</span>			<span class="cm">/* # of atm_vcc&#39;s who reference us */</span>
	<span class="n">vci_t</span> <span class="n">vci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atmvcc</span><span class="p">;</span>	<span class="cm">/* atm_vcc who is receiver */</span>
	<span class="p">}</span> <span class="n">rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atmvcc</span><span class="p">;</span>	<span class="cm">/* atm_vcc who is transmitter */</span>
		<span class="kt">int</span> <span class="n">endptr</span><span class="p">;</span>		<span class="cm">/* last endptr from service entry */</span>
		<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">backlog</span><span class="p">;</span>
		<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">unqueue</span><span class="p">)(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="p">}</span> <span class="n">tx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">lanai_type</span> <span class="p">{</span>
	<span class="n">lanai2</span>	<span class="o">=</span> <span class="n">PCI_DEVICE_ID_EF_ATM_LANAI2</span><span class="p">,</span>
	<span class="n">lanaihb</span>	<span class="o">=</span> <span class="n">PCI_DEVICE_ID_EF_ATM_LANAIHB</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lanai_dev_stats</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">ovfl_trash</span><span class="p">;</span>	<span class="cm">/* # of cells dropped - buffer overflow */</span>
	<span class="kt">unsigned</span> <span class="n">vci_trash</span><span class="p">;</span>	<span class="cm">/* # of cells dropped - closed vci */</span>
	<span class="kt">unsigned</span> <span class="n">hec_err</span><span class="p">;</span>	<span class="cm">/* # of cells dropped - bad HEC */</span>
	<span class="kt">unsigned</span> <span class="n">atm_ovfl</span><span class="p">;</span>	<span class="cm">/* # of cells dropped - rx fifo overflow */</span>
	<span class="kt">unsigned</span> <span class="n">pcierr_parity_detect</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pcierr_serr_set</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pcierr_master_abort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pcierr_m_target_abort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pcierr_s_target_abort</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pcierr_master_parity</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">service_notx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">service_norx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">service_rxnotaal5</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">dma_reenable</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">card_reset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="p">{</span>
	<span class="n">bus_addr_t</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lanai_dev_stats</span> <span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="n">service</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">**</span><span class="n">vccs</span><span class="p">;</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="kt">int</span> <span class="n">nbound</span><span class="p">;</span>			<span class="cm">/* number of bound vccs */</span>
<span class="cp">#endif</span>
	<span class="k">enum</span> <span class="n">lanai_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">vci_t</span> <span class="n">num_vci</span><span class="p">;</span>			<span class="cm">/* Currently just NUM_VCI */</span>
	<span class="n">u8</span> <span class="n">eeprom</span><span class="p">[</span><span class="n">LANAI_EEPROM_SIZE</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">serialno</span><span class="p">,</span> <span class="n">magicno</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">backlog_vccs</span><span class="p">,</span> <span class="n">NUM_VCI</span><span class="p">);</span>   <span class="cm">/* VCCs with tx backlog */</span>
	<span class="n">DECLARE_BITMAP</span><span class="p">(</span><span class="n">transmit_ready</span><span class="p">,</span> <span class="n">NUM_VCI</span><span class="p">);</span> <span class="cm">/* VCCs with transmit space */</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">naal0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="n">aal0buf</span><span class="p">;</span>	<span class="cm">/* AAL0 RX buffers */</span>
	<span class="n">u32</span> <span class="n">conf1</span><span class="p">,</span> <span class="n">conf2</span><span class="p">;</span>		<span class="cm">/* CONFIG[12] registers */</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>			<span class="cm">/* STATUS register */</span>
	<span class="n">spinlock_t</span> <span class="n">endtxlock</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">servicelock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">cbrvcc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">board_rev</span><span class="p">;</span>
<span class="cm">/* TODO - look at race conditions with maintence of conf1/conf2 */</span>
<span class="cm">/* TODO - transmit locking: should we use _irq not _irqsave? */</span>
<span class="cm">/* TODO - organize above in some rational fashion (see &lt;asm/cache.h&gt;) */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Each device has two bitmaps for each VCC (baclog_vccs and transmit_ready)</span>
<span class="cm"> * This function iterates one of these, calling a given function for each</span>
<span class="cm"> * vci with their bit set</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vci_bitfield_iterate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">lp</span><span class="p">,</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="p">,</span><span class="n">vci_t</span> <span class="n">vci</span><span class="p">))</span>
<span class="p">{</span>
	<span class="n">vci_t</span> <span class="n">vci</span><span class="p">;</span>

	<span class="n">for_each_set_bit</span><span class="p">(</span><span class="n">vci</span><span class="p">,</span> <span class="n">lp</span><span class="p">,</span> <span class="n">NUM_VCI</span><span class="p">)</span>
		<span class="n">func</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- BUFFER  UTILITIES: */</span>

<span class="cm">/*</span>
<span class="cm"> * Lanai needs DMA buffers aligned to 256 bytes of at least 1024 bytes -</span>
<span class="cm"> * usually any page allocation will do.  Just to be safe in case</span>
<span class="cm"> * PAGE_SIZE is insanely tiny, though...</span>
<span class="cm"> */</span>
<span class="cp">#define LANAI_PAGE_SIZE   ((PAGE_SIZE &gt;= 1024) ? PAGE_SIZE : 1024)</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate a buffer in host RAM for service list, RX, or TX</span>
<span class="cm"> * Returns buf-&gt;start==NULL if no memory</span>
<span class="cm"> * Note that the size will be rounded up 2^n bytes, and</span>
<span class="cm"> * if we can&#39;t allocate that we&#39;ll settle for something smaller</span>
<span class="cm"> * until minbytes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_buf_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="kt">size_t</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">minbytes</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">))</span>	<span class="cm">/* max lanai buffer size */</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">LANAI_PAGE_SIZE</span><span class="p">;</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="p">;</span> <span class="n">size</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minbytes</span> <span class="o">&lt;</span> <span class="n">LANAI_PAGE_SIZE</span><span class="p">)</span>
		<span class="n">minbytes</span> <span class="o">=</span> <span class="n">LANAI_PAGE_SIZE</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Technically we could use non-consistent mappings for</span>
<span class="cm">		 * everything, but the way the lanai uses DMA memory would</span>
<span class="cm">		 * make that a terrific pain.  This is much simpler.</span>
<span class="cm">		 */</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">dmaaddr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Success */</span>
			<span class="cm">/* Lanai requires 256-byte alignment of DMA bufs */</span>
			<span class="n">APRINTK</span><span class="p">((</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">dmaaddr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFFFFFF00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
			    <span class="s">&quot;bad dmaaddr: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dmaaddr</span><span class="p">);</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span>
			    <span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)[</span><span class="n">size</span><span class="p">]);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">size</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">minbytes</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* size of buffer in bytes */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">lanai_buf_size</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_buf_deallocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
		    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dmaaddr</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* size of buffer as &quot;card order&quot; (0=1k .. 7=128k) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lanai_buf_size_cardorder</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">lanai_buf_size</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">PAGE_SHIFT</span> <span class="o">-</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* This can only happen if PAGE_SIZE is gigantic, but just in case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span>
		<span class="n">order</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">order</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------- PORT I/O UTILITIES: */</span>

<span class="cm">/* Registers (and their bit-fields) */</span>
<span class="k">enum</span> <span class="n">lanai_register</span> <span class="p">{</span>
	<span class="n">Reset_Reg</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* Reset; read for chip type; bits: */</span>
<span class="cp">#define   RESET_GET_BOARD_REV(x)    (((x)&gt;&gt; 0)&amp;0x03)	</span><span class="cm">/* Board revision */</span><span class="cp"></span>
<span class="cp">#define   RESET_GET_BOARD_ID(x)	    (((x)&gt;&gt; 2)&amp;0x03)	</span><span class="cm">/* Board ID */</span><span class="cp"></span>
<span class="cp">#define     BOARD_ID_LANAI256		(0)	</span><span class="cm">/* 25.6M adapter card */</span><span class="cp"></span>
	<span class="n">Endian_Reg</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>	<span class="cm">/* Endian setting */</span>
	<span class="n">IntStatus_Reg</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>	<span class="cm">/* Interrupt status */</span>
	<span class="n">IntStatusMasked_Reg</span>	<span class="o">=</span> <span class="mh">0x0C</span><span class="p">,</span>	<span class="cm">/* Interrupt status (masked) */</span>
	<span class="n">IntAck_Reg</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>	<span class="cm">/* Interrupt acknowledge */</span>
	<span class="n">IntAckMasked_Reg</span>	<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>	<span class="cm">/* Interrupt acknowledge (masked) */</span>
	<span class="n">IntStatusSet_Reg</span>	<span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>	<span class="cm">/* Get status + enable/disable */</span>
	<span class="n">IntStatusSetMasked_Reg</span>	<span class="o">=</span> <span class="mh">0x1C</span><span class="p">,</span>	<span class="cm">/* Get status + en/di (masked) */</span>
	<span class="n">IntControlEna_Reg</span>	<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>	<span class="cm">/* Interrupt control enable */</span>
	<span class="n">IntControlDis_Reg</span>	<span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>	<span class="cm">/* Interrupt control disable */</span>
	<span class="n">Status_Reg</span>		<span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>	<span class="cm">/* Status */</span>
<span class="cp">#define   STATUS_PROMDATA	 (0x00000001)	</span><span class="cm">/* PROM_DATA pin */</span><span class="cp"></span>
<span class="cp">#define   STATUS_WAITING	 (0x00000002)	</span><span class="cm">/* Interrupt being delayed */</span><span class="cp"></span>
<span class="cp">#define	  STATUS_SOOL		 (0x00000004)	</span><span class="cm">/* SOOL alarm */</span><span class="cp"></span>
<span class="cp">#define   STATUS_LOCD		 (0x00000008)	</span><span class="cm">/* LOCD alarm */</span><span class="cp"></span>
<span class="cp">#define	  STATUS_LED		 (0x00000010)	</span><span class="cm">/* LED (HAPPI) output */</span><span class="cp"></span>
<span class="cp">#define   STATUS_GPIN		 (0x00000020)	</span><span class="cm">/* GPIN pin */</span><span class="cp"></span>
<span class="cp">#define   STATUS_BUTTBUSY	 (0x00000040)	</span><span class="cm">/* Butt register is pending */</span><span class="cp"></span>
	<span class="n">Config1_Reg</span>		<span class="o">=</span> <span class="mh">0x2C</span><span class="p">,</span>	<span class="cm">/* Config word 1; bits: */</span>
<span class="cp">#define   CONFIG1_PROMDATA	 (0x00000001)	</span><span class="cm">/* PROM_DATA pin */</span><span class="cp"></span>
<span class="cp">#define   CONFIG1_PROMCLK	 (0x00000002)	</span><span class="cm">/* PROM_CLK pin */</span><span class="cp"></span>
<span class="cp">#define   CONFIG1_SET_READMODE(x) ((x)*0x004)	</span><span class="cm">/* PCI BM reads; values: */</span><span class="cp"></span>
<span class="cp">#define     READMODE_PLAIN	    (0)		</span><span class="cm">/*   Plain memory read */</span><span class="cp"></span>
<span class="cp">#define     READMODE_LINE	    (2)		</span><span class="cm">/*   Memory read line */</span><span class="cp"></span>
<span class="cp">#define     READMODE_MULTIPLE	    (3)		</span><span class="cm">/*   Memory read multiple */</span><span class="cp"></span>
<span class="cp">#define   CONFIG1_DMA_ENABLE	 (0x00000010)	</span><span class="cm">/* Turn on DMA */</span><span class="cp"></span>
<span class="cp">#define   CONFIG1_POWERDOWN	 (0x00000020)	</span><span class="cm">/* Turn off clocks */</span><span class="cp"></span>
<span class="cp">#define   CONFIG1_SET_LOOPMODE(x) ((x)*0x080)	</span><span class="cm">/* Clock&amp;loop mode; values: */</span><span class="cp"></span>
<span class="cp">#define     LOOPMODE_NORMAL	    (0)		</span><span class="cm">/*   Normal - no loop */</span><span class="cp"></span>
<span class="cp">#define     LOOPMODE_TIME	    (1)</span>
<span class="cp">#define     LOOPMODE_DIAG	    (2)</span>
<span class="cp">#define     LOOPMODE_LINE	    (3)</span>
<span class="cp">#define   CONFIG1_MASK_LOOPMODE  (0x00000180)</span>
<span class="cp">#define   CONFIG1_SET_LEDMODE(x) ((x)*0x0200)	</span><span class="cm">/* Mode of LED; values: */</span><span class="cp"></span>
<span class="cp">#define     LEDMODE_NOT_SOOL	    (0)		</span><span class="cm">/*   !SOOL */</span><span class="cp"></span>
<span class="cp">#define	    LEDMODE_OFF		    (1)		</span><span class="cm">/*   0     */</span><span class="cp"></span>
<span class="cp">#define	    LEDMODE_ON		    (2)		</span><span class="cm">/*   1     */</span><span class="cp"></span>
<span class="cp">#define	    LEDMODE_NOT_LOCD	    (3)		</span><span class="cm">/*   !LOCD */</span><span class="cp"></span>
<span class="cp">#define	    LEDMORE_GPIN	    (4)		</span><span class="cm">/*   GPIN  */</span><span class="cp"></span>
<span class="cp">#define     LEDMODE_NOT_GPIN	    (7)		</span><span class="cm">/*   !GPIN */</span><span class="cp"></span>
<span class="cp">#define   CONFIG1_MASK_LEDMODE	 (0x00000E00)</span>
<span class="cp">#define   CONFIG1_GPOUT1	 (0x00001000)	</span><span class="cm">/* Toggle for reset */</span><span class="cp"></span>
<span class="cp">#define   CONFIG1_GPOUT2	 (0x00002000)	</span><span class="cm">/* Loopback PHY */</span><span class="cp"></span>
<span class="cp">#define   CONFIG1_GPOUT3	 (0x00004000)	</span><span class="cm">/* Loopback lanai */</span><span class="cp"></span>
	<span class="n">Config2_Reg</span>		<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span>	<span class="cm">/* Config word 2; bits: */</span>
<span class="cp">#define   CONFIG2_HOWMANY	 (0x00000001)	</span><span class="cm">/* &gt;512 VCIs? */</span><span class="cp"></span>
<span class="cp">#define   CONFIG2_PTI7_MODE	 (0x00000002)	</span><span class="cm">/* Make PTI=7 RM, not OAM */</span><span class="cp"></span>
<span class="cp">#define   CONFIG2_VPI_CHK_DIS	 (0x00000004)	</span><span class="cm">/* Ignore RX VPI value */</span><span class="cp"></span>
<span class="cp">#define   CONFIG2_HEC_DROP	 (0x00000008)	</span><span class="cm">/* Drop cells w/ HEC errors */</span><span class="cp"></span>
<span class="cp">#define   CONFIG2_VCI0_NORMAL	 (0x00000010)	</span><span class="cm">/* Treat VCI=0 normally */</span><span class="cp"></span>
<span class="cp">#define   CONFIG2_CBR_ENABLE	 (0x00000020)	</span><span class="cm">/* Deal with CBR traffic */</span><span class="cp"></span>
<span class="cp">#define   CONFIG2_TRASH_ALL	 (0x00000040)	</span><span class="cm">/* Trashing incoming cells */</span><span class="cp"></span>
<span class="cp">#define   CONFIG2_TX_DISABLE	 (0x00000080)	</span><span class="cm">/* Trashing outgoing cells */</span><span class="cp"></span>
<span class="cp">#define   CONFIG2_SET_TRASH	 (0x00000100)	</span><span class="cm">/* Turn trashing on */</span><span class="cp"></span>
	<span class="n">Statistics_Reg</span>		<span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span>	<span class="cm">/* Statistics; bits: */</span>
<span class="cp">#define   STATS_GET_FIFO_OVFL(x)    (((x)&gt;&gt; 0)&amp;0xFF)	</span><span class="cm">/* FIFO overflowed */</span><span class="cp"></span>
<span class="cp">#define   STATS_GET_HEC_ERR(x)      (((x)&gt;&gt; 8)&amp;0xFF)	</span><span class="cm">/* HEC was bad */</span><span class="cp"></span>
<span class="cp">#define   STATS_GET_BAD_VCI(x)      (((x)&gt;&gt;16)&amp;0xFF)	</span><span class="cm">/* VCI not open */</span><span class="cp"></span>
<span class="cp">#define   STATS_GET_BUF_OVFL(x)     (((x)&gt;&gt;24)&amp;0xFF)	</span><span class="cm">/* VCC buffer full */</span><span class="cp"></span>
	<span class="n">ServiceStuff_Reg</span>	<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>	<span class="cm">/* Service stuff; bits: */</span>
<span class="cp">#define   SSTUFF_SET_SIZE(x) ((x)*0x20000000)	</span><span class="cm">/* size of service buffer */</span><span class="cp"></span>
<span class="cp">#define   SSTUFF_SET_ADDR(x)	    ((x)&gt;&gt;8)	</span><span class="cm">/* set address of buffer */</span><span class="cp"></span>
	<span class="n">ServWrite_Reg</span>		<span class="o">=</span> <span class="mh">0x3C</span><span class="p">,</span>	<span class="cm">/* ServWrite Pointer */</span>
	<span class="n">ServRead_Reg</span>		<span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>	<span class="cm">/* ServRead Pointer */</span>
	<span class="n">TxDepth_Reg</span>		<span class="o">=</span> <span class="mh">0x44</span><span class="p">,</span>	<span class="cm">/* FIFO Transmit Depth */</span>
	<span class="n">Butt_Reg</span>		<span class="o">=</span> <span class="mh">0x48</span><span class="p">,</span>	<span class="cm">/* Butt register */</span>
	<span class="n">CBR_ICG_Reg</span>		<span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="n">CBR_PTR_Reg</span>		<span class="o">=</span> <span class="mh">0x54</span><span class="p">,</span>
	<span class="n">PingCount_Reg</span>		<span class="o">=</span> <span class="mh">0x58</span><span class="p">,</span>	<span class="cm">/* Ping count */</span>
	<span class="n">DMA_Addr_Reg</span>		<span class="o">=</span> <span class="mh">0x5C</span>	<span class="cm">/* DMA address */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bus_addr_t</span> <span class="nf">reg_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">lanai_register</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">reg_read</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">lanai_register</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">t</span><span class="p">;</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
	<span class="n">RWDEBUG</span><span class="p">(</span><span class="s">&quot;R [0x%08X] 0x%02X = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">reg</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">reg_write</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">lanai_register</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RWDEBUG</span><span class="p">(</span><span class="s">&quot;W [0x%08X] 0x%02X &lt; 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">reg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">conf1_write</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span><span class="p">,</span> <span class="n">Config1_Reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">conf2_write</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf2</span><span class="p">,</span> <span class="n">Config2_Reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Same as conf2_write(), but defers I/O if we&#39;re powered down */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">conf2_write_if_powerup</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">&amp;</span> <span class="n">CONFIG1_POWERDOWN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* USE_POWERDOWN */</span><span class="cp"></span>
	<span class="n">conf2_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">reset_board</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;about to reset board</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Reset_Reg</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we don&#39;t delay a little while here then we can end up</span>
<span class="cm">	 * leaving the card in a VERY weird state and lock up the</span>
<span class="cm">	 * PCI bus.  This isn&#39;t documented anywhere but I&#39;ve convinced</span>
<span class="cm">	 * myself after a lot of painful experimentation</span>
<span class="cm">	 */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- CARD SRAM UTILITIES: */</span>

<span class="cm">/* The SRAM is mapped into normal PCI memory space - the only catch is</span>
<span class="cm"> * that it is only 16-bits wide but must be accessed as 32-bit.  The</span>
<span class="cm"> * 16 high bits will be zero.  We don&#39;t hide this, since they get</span>
<span class="cm"> * programmed mostly like discrete registers anyway</span>
<span class="cm"> */</span>
<span class="cp">#define SRAM_START (0x20000)</span>
<span class="cp">#define SRAM_BYTES (0x20000)	</span><span class="cm">/* Again, half don&#39;t really exist */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bus_addr_t</span> <span class="nf">sram_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">SRAM_START</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">sram_read</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">sram_addr</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sram_write</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">sram_addr</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sram_test_word</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
				    <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pattern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">readback</span><span class="p">;</span>
	<span class="n">sram_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">readback</span> <span class="o">=</span> <span class="n">sram_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">readback</span> <span class="o">==</span> <span class="n">pattern</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span>
	    <span class="s">&quot;(itf %d): SRAM word at %d bad: wrote 0x%X, read 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">pattern</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">readback</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sram_test_pass</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="n">u32</span> <span class="n">pattern</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">SRAM_BYTES</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">sram_test_word</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pattern</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sram_test_and_clear</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef FULL_MEMORY_TEST</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;testing SRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">sram_test_pass</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mh">0x5555</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">sram_test_pass</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mh">0xAAAA</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;clearing SRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sram_test_pass</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- CARD-BASED VCC TABLE UTILITIES: */</span>

<span class="cm">/* vcc table */</span>
<span class="k">enum</span> <span class="n">lanai_vcc_offset</span> <span class="p">{</span>
	<span class="n">vcc_rxaddr1</span>		<span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* Location1, plus bits: */</span>
<span class="cp">#define   RXADDR1_SET_SIZE(x) ((x)*0x0000100)	</span><span class="cm">/* size of RX buffer */</span><span class="cp"></span>
<span class="cp">#define   RXADDR1_SET_RMMODE(x) ((x)*0x00800)	</span><span class="cm">/* RM cell action; values: */</span><span class="cp"></span>
<span class="cp">#define     RMMODE_TRASH	  (0)		</span><span class="cm">/*   discard */</span><span class="cp"></span>
<span class="cp">#define     RMMODE_PRESERVE	  (1)		</span><span class="cm">/*   input as AAL0 */</span><span class="cp"></span>
<span class="cp">#define     RMMODE_PIPE		  (2)		</span><span class="cm">/*   pipe to coscheduler */</span><span class="cp"></span>
<span class="cp">#define     RMMODE_PIPEALL	  (3)		</span><span class="cm">/*   pipe non-RM too */</span><span class="cp"></span>
<span class="cp">#define   RXADDR1_OAM_PRESERVE	 (0x00002000)	</span><span class="cm">/* Input OAM cells as AAL0 */</span><span class="cp"></span>
<span class="cp">#define   RXADDR1_SET_MODE(x) ((x)*0x0004000)	</span><span class="cm">/* Reassembly mode */</span><span class="cp"></span>
<span class="cp">#define     RXMODE_TRASH	  (0)		</span><span class="cm">/*   discard */</span><span class="cp"></span>
<span class="cp">#define     RXMODE_AAL0		  (1)		</span><span class="cm">/*   non-AAL5 mode */</span><span class="cp"></span>
<span class="cp">#define     RXMODE_AAL5		  (2)		</span><span class="cm">/*   AAL5, intr. each PDU */</span><span class="cp"></span>
<span class="cp">#define     RXMODE_AAL5_STREAM	  (3)		</span><span class="cm">/*   AAL5 w/o per-PDU intr */</span><span class="cp"></span>
	<span class="n">vcc_rxaddr2</span>		<span class="o">=</span> <span class="mh">0x04</span><span class="p">,</span>	<span class="cm">/* Location2 */</span>
	<span class="n">vcc_rxcrc1</span>		<span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span>	<span class="cm">/* RX CRC claculation space */</span>
	<span class="n">vcc_rxcrc2</span>		<span class="o">=</span> <span class="mh">0x0C</span><span class="p">,</span>
	<span class="n">vcc_rxwriteptr</span>		<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="cm">/* RX writeptr, plus bits: */</span>
<span class="cp">#define   RXWRITEPTR_LASTEFCI	 (0x00002000)	</span><span class="cm">/* Last PDU had EFCI bit */</span><span class="cp"></span>
<span class="cp">#define   RXWRITEPTR_DROPPING	 (0x00004000)	</span><span class="cm">/* Had error, dropping */</span><span class="cp"></span>
<span class="cp">#define   RXWRITEPTR_TRASHING	 (0x00008000)	</span><span class="cm">/* Trashing */</span><span class="cp"></span>
	<span class="n">vcc_rxbufstart</span>		<span class="o">=</span> <span class="mh">0x14</span><span class="p">,</span>	<span class="cm">/* RX bufstart, plus bits: */</span>
<span class="cp">#define   RXBUFSTART_CLP	 (0x00004000)</span>
<span class="cp">#define   RXBUFSTART_CI		 (0x00008000)</span>
	<span class="n">vcc_rxreadptr</span>		<span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>	<span class="cm">/* RX readptr */</span>
	<span class="n">vcc_txicg</span>		<span class="o">=</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="cm">/* TX ICG */</span>
	<span class="n">vcc_txaddr1</span>		<span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>	<span class="cm">/* Location1, plus bits: */</span>
<span class="cp">#define   TXADDR1_SET_SIZE(x) ((x)*0x0000100)	</span><span class="cm">/* size of TX buffer */</span><span class="cp"></span>
<span class="cp">#define   TXADDR1_ABR		 (0x00008000)	</span><span class="cm">/* use ABR (doesn&#39;t work) */</span><span class="cp"></span>
	<span class="n">vcc_txaddr2</span>		<span class="o">=</span> <span class="mh">0x24</span><span class="p">,</span>	<span class="cm">/* Location2 */</span>
	<span class="n">vcc_txcrc1</span>		<span class="o">=</span> <span class="mh">0x28</span><span class="p">,</span>	<span class="cm">/* TX CRC claculation space */</span>
	<span class="n">vcc_txcrc2</span>		<span class="o">=</span> <span class="mh">0x2C</span><span class="p">,</span>
	<span class="n">vcc_txreadptr</span>		<span class="o">=</span> <span class="mh">0x30</span><span class="p">,</span> <span class="cm">/* TX Readptr, plus bits: */</span>
<span class="cp">#define   TXREADPTR_GET_PTR(x) ((x)&amp;0x01FFF)</span>
<span class="cp">#define   TXREADPTR_MASK_DELTA	(0x0000E000)	</span><span class="cm">/* ? */</span><span class="cp"></span>
	<span class="n">vcc_txendptr</span>		<span class="o">=</span> <span class="mh">0x34</span><span class="p">,</span> <span class="cm">/* TX Endptr, plus bits: */</span>
<span class="cp">#define   TXENDPTR_CLP		(0x00002000)</span>
<span class="cp">#define   TXENDPTR_MASK_PDUMODE	(0x0000C000)	</span><span class="cm">/* PDU mode; values: */</span><span class="cp"></span>
<span class="cp">#define     PDUMODE_AAL0	 (0*0x04000)</span>
<span class="cp">#define     PDUMODE_AAL5	 (2*0x04000)</span>
<span class="cp">#define     PDUMODE_AAL5STREAM	 (3*0x04000)</span>
	<span class="n">vcc_txwriteptr</span>		<span class="o">=</span> <span class="mh">0x38</span><span class="p">,</span>	<span class="cm">/* TX Writeptr */</span>
<span class="cp">#define   TXWRITEPTR_GET_PTR(x) ((x)&amp;0x1FFF)</span>
	<span class="n">vcc_txcbr_next</span>		<span class="o">=</span> <span class="mh">0x3C</span>	<span class="cm">/* # of next CBR VCI in ring */</span>
<span class="cp">#define   TXCBR_NEXT_BOZO	(0x00008000)	</span><span class="cm">/* &quot;bozo bit&quot; */</span><span class="cp"></span>
<span class="p">};</span>

<span class="cp">#define CARDVCC_SIZE	(0x40)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bus_addr_t</span> <span class="nf">cardvcc_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="n">vci_t</span> <span class="n">vci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sram_addr</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">vci</span> <span class="o">*</span> <span class="n">CARDVCC_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">cardvcc_read</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">lanai_vcc_offset</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">APRINTK</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cardvcc_read: unbound vcc!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">val</span><span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">RWDEBUG</span><span class="p">(</span><span class="s">&quot;VR vci=%04d 0x%02X = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">cardvcc_write</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="k">enum</span> <span class="n">lanai_vcc_offset</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">APRINTK</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;cardvcc_write: unbound vcc!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">APRINTK</span><span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="s">&quot;cardvcc_write: bad val 0x%X (vci=%d, addr=0x%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">val</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">RWDEBUG</span><span class="p">(</span><span class="s">&quot;VW vci=%04d 0x%02X &gt; 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- COMPUTE SIZE OF AN AAL5 PDU: */</span>

<span class="cm">/* How many bytes will an AAL5 PDU take to transmit - remember that:</span>
<span class="cm"> *   o  we need to add 8 bytes for length, CPI, UU, and CRC</span>
<span class="cm"> *   o  we need to round up to 48 bytes for cells</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">aal5_size</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cells</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">47</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cells</span> <span class="o">*</span> <span class="mi">48</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* How many bytes can we send if we have &quot;space&quot; space, assuming we have</span>
<span class="cm"> * to send full cells</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">aal5_spacefor</span><span class="p">(</span><span class="kt">int</span> <span class="n">space</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cells</span> <span class="o">=</span> <span class="n">space</span> <span class="o">/</span> <span class="mi">48</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cells</span> <span class="o">*</span> <span class="mi">48</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------- FREE AN ATM SKB: */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lanai_free_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atmvcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">pop</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">atmvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- TURN VCCS ON AND OFF: */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">host_vcc_start_rx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addr1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dmaaddr</span> <span class="o">=</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">dmaaddr</span><span class="p">;</span>
		<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">vcc_rxcrc1</span><span class="p">);</span>
		<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">vcc_rxcrc2</span><span class="p">);</span>
		<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_rxwriteptr</span><span class="p">);</span>
		<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_rxbufstart</span><span class="p">);</span>
		<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_rxreadptr</span><span class="p">);</span>
		<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="p">(</span><span class="n">dmaaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">vcc_rxaddr2</span><span class="p">);</span>
		<span class="n">addr1</span> <span class="o">=</span> <span class="p">((</span><span class="n">dmaaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span>
		    <span class="n">RXADDR1_SET_SIZE</span><span class="p">(</span><span class="n">lanai_buf_size_cardorder</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">))</span><span class="o">|</span>
		    <span class="n">RXADDR1_SET_RMMODE</span><span class="p">(</span><span class="n">RMMODE_TRASH</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* ??? */</span>
		 <span class="cm">/* RXADDR1_OAM_PRESERVE |	--- no OAM support yet */</span>
		    <span class="n">RXADDR1_SET_MODE</span><span class="p">(</span><span class="n">RXMODE_AAL5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">addr1</span> <span class="o">=</span> <span class="n">RXADDR1_SET_RMMODE</span><span class="p">(</span><span class="n">RMMODE_PRESERVE</span><span class="p">)</span> <span class="o">|</span> <span class="cm">/* ??? */</span>
		    <span class="n">RXADDR1_OAM_PRESERVE</span> <span class="o">|</span>		      <span class="cm">/* ??? */</span>
		    <span class="n">RXADDR1_SET_MODE</span><span class="p">(</span><span class="n">RXMODE_AAL0</span><span class="p">);</span>
	<span class="cm">/* This one must be last! */</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">vcc_rxaddr1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">host_vcc_start_tx</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dmaaddr</span> <span class="o">=</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">dmaaddr</span><span class="p">;</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txicg</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">vcc_txcrc1</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">vcc_txcrc2</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txreadptr</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txendptr</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txwriteptr</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span>
		<span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">TXCBR_NEXT_BOZO</span> <span class="o">|</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txcbr_next</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="p">(</span><span class="n">dmaaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">vcc_txaddr2</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span>
	    <span class="p">((</span><span class="n">dmaaddr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">TXADDR1_SET_SIZE</span><span class="p">(</span><span class="n">lanai_buf_size_cardorder</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">)),</span>
	    <span class="n">vcc_txaddr1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Shutdown receiving on card */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_shutdown_rx_vci</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>	<span class="cm">/* We were never bound to a VCI */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* 15.1.1 - set to trashing, wait one cell time (15us) */</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span>
	    <span class="n">RXADDR1_SET_RMMODE</span><span class="p">(</span><span class="n">RMMODE_TRASH</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">RXADDR1_SET_MODE</span><span class="p">(</span><span class="n">RXMODE_TRASH</span><span class="p">),</span> <span class="n">vcc_rxaddr1</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
	<span class="cm">/* 15.1.2 - clear rest of entries */</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_rxaddr2</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_rxcrc1</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_rxcrc2</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_rxwriteptr</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_rxbufstart</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_rxreadptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Shutdown transmitting on card.</span>
<span class="cm"> * Unfortunately the lanai needs us to wait until all the data</span>
<span class="cm"> * drains out of the buffer before we can dealloc it, so this</span>
<span class="cm"> * can take awhile -- up to 370ms for a full 128KB buffer</span>
<span class="cm"> * assuming everone else is quiet.  In theory the time is</span>
<span class="cm"> * boundless if there&#39;s a CBR VCC holding things up.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_shutdown_tx_vci</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">,</span> <span class="n">lastread</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">APRINTK</span><span class="p">(</span><span class="o">!</span><span class="n">in_interrupt</span><span class="p">(),</span>
	    <span class="s">&quot;lanai_shutdown_tx_vci called w/o process context!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>	<span class="cm">/* We were never bound to a VCI */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* 15.2.1 - wait for queue to drain */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">backlog</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">lanai_free_skb</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">backlog_vccs</span><span class="p">);</span>
	<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to wait for the VCC to drain but don&#39;t wait forever.  We</span>
<span class="cm">	 * give each 1K of buffer size 1/128th of a second to clear out.</span>
<span class="cm">	 * TODO: maybe disable CBR if we&#39;re about to timeout?</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
	    <span class="p">(((</span><span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">write</span> <span class="o">=</span> <span class="n">TXWRITEPTR_GET_PTR</span><span class="p">(</span><span class="n">cardvcc_read</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">vcc_txwriteptr</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">read</span> <span class="o">=</span> <span class="n">TXREADPTR_GET_PTR</span><span class="p">(</span><span class="n">cardvcc_read</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">vcc_txreadptr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">==</span> <span class="n">write</span> <span class="o">&amp;&amp;</span>	   <span class="cm">/* Is TX buffer empty? */</span>
		    <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_CBR</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">cardvcc_read</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">vcc_txcbr_next</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">TXCBR_NEXT_BOZO</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read</span> <span class="o">!=</span> <span class="n">lastread</span><span class="p">)</span> <span class="p">{</span>	   <span class="cm">/* Has there been any progress? */</span>
			<span class="n">lastread</span> <span class="o">=</span> <span class="n">read</span><span class="p">;</span>
			<span class="n">timeout</span> <span class="o">+=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): Timed out on &quot;</span>
			    <span class="s">&quot;backlog closing vci %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;read, write = %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">read</span><span class="p">,</span> <span class="n">write</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* 15.2.2 - clear out all tx registers */</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txreadptr</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txwriteptr</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txendptr</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txcrc1</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txcrc2</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txaddr2</span><span class="p">);</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vcc_txaddr1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- MANAGING AAL0 RX BUFFER: */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">aal0_buffer_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;aal0_buffer_allocate: allocating AAL0 RX buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">lanai_buf_allocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">aal0buf</span><span class="p">,</span> <span class="n">AAL0_RX_BUFFER_SIZE</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>
			   <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">aal0buf</span><span class="p">.</span><span class="n">start</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENOMEM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">aal0_buffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;aal0_buffer_allocate: freeing AAL0 RX buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">lanai_buf_deallocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">aal0buf</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- EEPROM UTILITIES: */</span>

<span class="cm">/* Offsets of data in the EEPROM */</span>
<span class="cp">#define EEPROM_COPYRIGHT	(0)</span>
<span class="cp">#define EEPROM_COPYRIGHT_LEN	(44)</span>
<span class="cp">#define EEPROM_CHECKSUM		(62)</span>
<span class="cp">#define EEPROM_CHECKSUM_REV	(63)</span>
<span class="cp">#define EEPROM_MAC		(64)</span>
<span class="cp">#define EEPROM_MAC_REV		(70)</span>
<span class="cp">#define EEPROM_SERIAL		(112)</span>
<span class="cp">#define EEPROM_SERIAL_REV	(116)</span>
<span class="cp">#define EEPROM_MAGIC		(120)</span>
<span class="cp">#define EEPROM_MAGIC_REV	(124)</span>

<span class="cp">#define EEPROM_MAGIC_VALUE	(0x5AB478D2)</span>

<span class="cp">#ifndef READ_EEPROM</span>

<span class="cm">/* Stub functions to use if EEPROM reading is disabled */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): *NOT* reading EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_MAC</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">eeprom_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">serialno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">magicno</span> <span class="o">=</span> <span class="n">EEPROM_MAGIC_VALUE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* READ_EEPROM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">eeprom_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
<span class="cp">#define set_config1(x)   do { lanai-&gt;conf1 = x; conf1_write(lanai); \</span>
<span class="cp">			    } while (0)</span>
<span class="cp">#define clock_h()	 set_config1(lanai-&gt;conf1 | CONFIG1_PROMCLK)</span>
<span class="cp">#define clock_l()	 set_config1(lanai-&gt;conf1 &amp;~ CONFIG1_PROMCLK)</span>
<span class="cp">#define data_h()	 set_config1(lanai-&gt;conf1 | CONFIG1_PROMDATA)</span>
<span class="cp">#define data_l()	 set_config1(lanai-&gt;conf1 &amp;~ CONFIG1_PROMDATA)</span>
<span class="cp">#define pre_read()	 do { data_h(); clock_h(); udelay(5); } while (0)</span>
<span class="cp">#define read_pin()	 (reg_read(lanai, Status_Reg) &amp; STATUS_PROMDATA)</span>
<span class="cp">#define send_stop()	 do { data_l(); udelay(5); clock_h(); udelay(5); \</span>
<span class="cp">			      data_h(); udelay(5); } while (0)</span>
	<span class="cm">/* start with both clock and data high */</span>
	<span class="n">data_h</span><span class="p">();</span> <span class="n">clock_h</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">LANAI_EEPROM_SIZE</span><span class="p">;</span> <span class="n">address</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Command=read + address */</span>
		<span class="cm">/* send start bit */</span>
		<span class="n">data_l</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">clock_l</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>   <span class="cm">/* write command out */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CONFIG1_PROMDATA</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">i</span><span class="p">)</span> <span class="o">?</span> <span class="n">CONFIG1_PROMDATA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">!=</span> <span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_config1</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>	<span class="cm">/* Let new data settle */</span>
			<span class="p">}</span>
			<span class="n">clock_h</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span> <span class="n">clock_l</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* look for ack */</span>
		<span class="n">data_h</span><span class="p">();</span> <span class="n">clock_h</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_pin</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>	<span class="cm">/* No ack seen */</span>
		<span class="n">clock_l</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="cm">/* read back result */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data_h</span><span class="p">();</span> <span class="n">clock_h</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
			<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="o">!!</span><span class="n">read_pin</span><span class="p">();</span>
			<span class="n">clock_l</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* look again for ack */</span>
		<span class="n">data_h</span><span class="p">();</span> <span class="n">clock_h</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">read_pin</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>	<span class="cm">/* Spurious ack */</span>
		<span class="n">clock_l</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">send_stop</span><span class="p">();</span>
		<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;EEPROM 0x%04X %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">address</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nl">error:</span>
	<span class="n">clock_l</span><span class="p">();</span> <span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>		<span class="cm">/* finish read */</span>
	<span class="n">send_stop</span><span class="p">();</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): error reading EEPROM byte %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">address</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="cp">#undef set_config1</span>
<span class="cp">#undef clock_h</span>
<span class="cp">#undef clock_l</span>
<span class="cp">#undef data_h</span>
<span class="cp">#undef data_l</span>
<span class="cp">#undef pre_read</span>
<span class="cp">#undef read_pin</span>
<span class="cp">#undef send_stop</span>
<span class="p">}</span>

<span class="cm">/* read a big-endian 4-byte value out of eeprom */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">eeprom_be4</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">be32_to_cpup</span><span class="p">((</span><span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">address</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* Checksum/validate EEPROM contents */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">eeprom_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="cm">/* First, see if we can get an ASCIIZ string out of the copyright */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">EEPROM_COPYRIGHT</span><span class="p">;</span>
	    <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">EEPROM_COPYRIGHT</span> <span class="o">+</span> <span class="n">EEPROM_COPYRIGHT_LEN</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mh">0x7E</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">EEPROM_COPYRIGHT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">i</span> <span class="o">!=</span> <span class="n">EEPROM_COPYRIGHT</span> <span class="o">+</span> <span class="n">EEPROM_COPYRIGHT_LEN</span> <span class="o">&amp;&amp;</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eeprom: copyright = </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">[</span><span class="n">EEPROM_COPYRIGHT</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eeprom: copyright not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Validate checksum */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">EEPROM_CHECKSUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">s</span> <span class="o">&amp;=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">e</span><span class="p">[</span><span class="n">EEPROM_CHECKSUM</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): EEPROM checksum bad &quot;</span>
		    <span class="s">&quot;(wanted 0x%02X, got 0x%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">e</span><span class="p">[</span><span class="n">EEPROM_CHECKSUM</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span> <span class="o">^=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">e</span><span class="p">[</span><span class="n">EEPROM_CHECKSUM_REV</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): EEPROM inverse checksum &quot;</span>
		    <span class="s">&quot;bad (wanted 0x%02X, got 0x%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">e</span><span class="p">[</span><span class="n">EEPROM_CHECKSUM_REV</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Verify MAC address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="p">[</span><span class="n">EEPROM_MAC</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">e</span><span class="p">[</span><span class="n">EEPROM_MAC_REV</span> <span class="o">+</span> <span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span>
			    <span class="s">&quot;(itf %d) : EEPROM MAC addresses don&#39;t match &quot;</span>
			    <span class="s">&quot;(0x%02X, inverse 0x%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">e</span><span class="p">[</span><span class="n">EEPROM_MAC</span> <span class="o">+</span> <span class="n">i</span><span class="p">],</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">e</span><span class="p">[</span><span class="n">EEPROM_MAC_REV</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eeprom: MAC address = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">[</span><span class="n">EEPROM_MAC</span><span class="p">]);</span>
	<span class="cm">/* Verify serial number */</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">serialno</span> <span class="o">=</span> <span class="n">eeprom_be4</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">EEPROM_SERIAL</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">eeprom_be4</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">EEPROM_SERIAL_REV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">serialno</span> <span class="o">^</span> <span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): EEPROM serial numbers &quot;</span>
		    <span class="s">&quot;don&#39;t match (0x%08X, inverse 0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">serialno</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">v</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eeprom: Serial number = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">serialno</span><span class="p">);</span>
	<span class="cm">/* Verify magic number */</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">magicno</span> <span class="o">=</span> <span class="n">eeprom_be4</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">EEPROM_MAGIC</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">eeprom_be4</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">EEPROM_MAGIC_REV</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">magicno</span> <span class="o">^</span> <span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): EEPROM magic numbers &quot;</span>
		    <span class="s">&quot;don&#39;t match (0x%08X, inverse 0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">magicno</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eeprom: Magic number = 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">magicno</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">magicno</span> <span class="o">!=</span> <span class="n">EEPROM_MAGIC_VALUE</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): warning - EEPROM &quot;</span>
		    <span class="s">&quot;magic not what expected (got 0x%08X, not 0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">magicno</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">EEPROM_MAGIC_VALUE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* READ_EEPROM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">eeprom_mac</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_MAC</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* -------------------- INTERRUPT HANDLING UTILITIES: */</span>

<span class="cm">/* Interrupt types */</span>
<span class="cp">#define INT_STATS	(0x00000002)	</span><span class="cm">/* Statistics counter overflow */</span><span class="cp"></span>
<span class="cp">#define INT_SOOL	(0x00000004)	</span><span class="cm">/* SOOL changed state */</span><span class="cp"></span>
<span class="cp">#define INT_LOCD	(0x00000008)	</span><span class="cm">/* LOCD changed state */</span><span class="cp"></span>
<span class="cp">#define INT_LED		(0x00000010)	</span><span class="cm">/* LED (HAPPI) changed state */</span><span class="cp"></span>
<span class="cp">#define INT_GPIN	(0x00000020)	</span><span class="cm">/* GPIN changed state */</span><span class="cp"></span>
<span class="cp">#define INT_PING	(0x00000040)	</span><span class="cm">/* PING_COUNT fulfilled */</span><span class="cp"></span>
<span class="cp">#define INT_WAKE	(0x00000080)	</span><span class="cm">/* Lanai wants bus */</span><span class="cp"></span>
<span class="cp">#define INT_CBR0	(0x00000100)	</span><span class="cm">/* CBR sched hit VCI 0 */</span><span class="cp"></span>
<span class="cp">#define INT_LOCK	(0x00000200)	</span><span class="cm">/* Service list overflow */</span><span class="cp"></span>
<span class="cp">#define INT_MISMATCH	(0x00000400)	</span><span class="cm">/* TX magic list mismatch */</span><span class="cp"></span>
<span class="cp">#define INT_AAL0_STR	(0x00000800)	</span><span class="cm">/* Non-AAL5 buffer half filled */</span><span class="cp"></span>
<span class="cp">#define INT_AAL0	(0x00001000)	</span><span class="cm">/* Non-AAL5 data available */</span><span class="cp"></span>
<span class="cp">#define INT_SERVICE	(0x00002000)	</span><span class="cm">/* Service list entries available */</span><span class="cp"></span>
<span class="cp">#define INT_TABORTSENT	(0x00004000)	</span><span class="cm">/* Target abort sent by lanai */</span><span class="cp"></span>
<span class="cp">#define INT_TABORTBM	(0x00008000)	</span><span class="cm">/* Abort rcv&#39;d as bus master */</span><span class="cp"></span>
<span class="cp">#define INT_TIMEOUTBM	(0x00010000)	</span><span class="cm">/* No response to bus master */</span><span class="cp"></span>
<span class="cp">#define INT_PCIPARITY	(0x00020000)	</span><span class="cm">/* Parity error on PCI */</span><span class="cp"></span>

<span class="cm">/* Sets of the above */</span>
<span class="cp">#define INT_ALL		(0x0003FFFE)	</span><span class="cm">/* All interrupts */</span><span class="cp"></span>
<span class="cp">#define INT_STATUS	(0x0000003C)	</span><span class="cm">/* Some status pin changed */</span><span class="cp"></span>
<span class="cp">#define INT_DMASHUT	(0x00038000)	</span><span class="cm">/* DMA engine got shut down */</span><span class="cp"></span>
<span class="cp">#define INT_SEGSHUT	(0x00000700)	</span><span class="cm">/* Segmentation got shut down */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">intr_pending</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">IntStatusMasked_Reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">intr_enable</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">IntControlEna_Reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">intr_disable</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="n">u32</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">IntControlDis_Reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- CARD/PCI STATUS: */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">status_message</span><span class="p">(</span><span class="kt">int</span> <span class="n">itf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">onoff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;off to on&quot;</span><span class="p">,</span> <span class="s">&quot;on to off&quot;</span> <span class="p">};</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): %s changed from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">itf</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">onoff</span><span class="p">[</span><span class="o">!</span><span class="n">status</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_check_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">new</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">Status_Reg</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">changes</span> <span class="o">=</span> <span class="n">new</span> <span class="o">^</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
<span class="cp">#define e(flag, name) \</span>
<span class="cp">		if (changes &amp; flag) \</span>
<span class="cp">			status_message(lanai-&gt;number, name, new &amp; flag)</span>
	<span class="n">e</span><span class="p">(</span><span class="n">STATUS_SOOL</span><span class="p">,</span> <span class="s">&quot;SOOL&quot;</span><span class="p">);</span>
	<span class="n">e</span><span class="p">(</span><span class="n">STATUS_LOCD</span><span class="p">,</span> <span class="s">&quot;LOCD&quot;</span><span class="p">);</span>
	<span class="n">e</span><span class="p">(</span><span class="n">STATUS_LED</span><span class="p">,</span> <span class="s">&quot;LED&quot;</span><span class="p">);</span>
	<span class="n">e</span><span class="p">(</span><span class="n">STATUS_GPIN</span><span class="p">,</span> <span class="s">&quot;GPIN&quot;</span><span class="p">);</span>
<span class="cp">#undef e</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcistatus_got</span><span class="p">(</span><span class="kt">int</span> <span class="n">itf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): PCI got %s error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">itf</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcistatus_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clearonly</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">s</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): can&#39;t read PCI_STATUS: &quot;</span>
		    <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span> <span class="o">&amp;=</span> <span class="n">PCI_STATUS_DETECTED_PARITY</span> <span class="o">|</span> <span class="n">PCI_STATUS_SIG_SYSTEM_ERROR</span> <span class="o">|</span>
	    <span class="n">PCI_STATUS_REC_MASTER_ABORT</span> <span class="o">|</span> <span class="n">PCI_STATUS_REC_TARGET_ABORT</span> <span class="o">|</span>
	    <span class="n">PCI_STATUS_SIG_TARGET_ABORT</span> <span class="o">|</span> <span class="n">PCI_STATUS_PARITY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_STATUS</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): can&#39;t write PCI_STATUS: &quot;</span>
		    <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clearonly</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#define e(flag, name, stat) \</span>
<span class="cp">		if (s &amp; flag) { \</span>
<span class="cp">			pcistatus_got(lanai-&gt;number, name); \</span>
<span class="cp">			++lanai-&gt;stats.pcierr_##stat; \</span>
<span class="cp">		}</span>
	<span class="n">e</span><span class="p">(</span><span class="n">PCI_STATUS_DETECTED_PARITY</span><span class="p">,</span> <span class="s">&quot;parity&quot;</span><span class="p">,</span> <span class="n">parity_detect</span><span class="p">);</span>
	<span class="n">e</span><span class="p">(</span><span class="n">PCI_STATUS_SIG_SYSTEM_ERROR</span><span class="p">,</span> <span class="s">&quot;signalled system&quot;</span><span class="p">,</span> <span class="n">serr_set</span><span class="p">);</span>
	<span class="n">e</span><span class="p">(</span><span class="n">PCI_STATUS_REC_MASTER_ABORT</span><span class="p">,</span> <span class="s">&quot;master&quot;</span><span class="p">,</span> <span class="n">master_abort</span><span class="p">);</span>
	<span class="n">e</span><span class="p">(</span><span class="n">PCI_STATUS_REC_TARGET_ABORT</span><span class="p">,</span> <span class="s">&quot;master target&quot;</span><span class="p">,</span> <span class="n">m_target_abort</span><span class="p">);</span>
	<span class="n">e</span><span class="p">(</span><span class="n">PCI_STATUS_SIG_TARGET_ABORT</span><span class="p">,</span> <span class="s">&quot;slave&quot;</span><span class="p">,</span> <span class="n">s_target_abort</span><span class="p">);</span>
	<span class="n">e</span><span class="p">(</span><span class="n">PCI_STATUS_PARITY</span><span class="p">,</span> <span class="s">&quot;master parity&quot;</span><span class="p">,</span> <span class="n">master_parity</span><span class="p">);</span>
<span class="cp">#undef e</span>
<span class="p">}</span>

<span class="cm">/* -------------------- VCC TX BUFFER UTILITIES: */</span>

<span class="cm">/* space left in tx buffer in bytes */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">vcc_tx_space</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">endptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">endptr</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">-=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="o">-</span>
	    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">-=</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* Leave &quot;bubble&quot; - if start==end it looks empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">+=</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* test if VCC is currently backlogged */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">vcc_is_backlogged</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">backlog</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Bit fields in the segmentation buffer descriptor */</span>
<span class="cp">#define DESCRIPTOR_MAGIC	(0xD0000000)</span>
<span class="cp">#define DESCRIPTOR_AAL5		(0x00008000)</span>
<span class="cp">#define DESCRIPTOR_AAL5_STREAM	(0x00004000)</span>
<span class="cp">#define DESCRIPTOR_CLP		(0x00002000)</span>

<span class="cm">/* Add 32-bit descriptor with its padding */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vcc_tx_add_aal5_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">APRINTK</span><span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="s">&quot;vcc_tx_add_aal5_descriptor: bad ptr=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* Hope the values REALLY don&#39;t matter */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="o">-</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">APRINTK</span><span class="p">((</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0001FFF0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="s">&quot;vcc_tx_add_aal5_descriptor: bad pos (%d) before, vci=%d, &quot;</span>
	    <span class="s">&quot;start,ptr,end=%p,%p,%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span>
	    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">APRINTK</span><span class="p">((</span><span class="n">pos</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0001FFF0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="s">&quot;vcc_tx_add_aal5_descriptor: bad pos (%d) after, vci=%d, &quot;</span>
	    <span class="s">&quot;start,ptr,end=%p,%p,%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span>
	    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DESCRIPTOR_MAGIC</span> <span class="o">|</span> <span class="n">DESCRIPTOR_AAL5</span> <span class="o">|</span>
	    <span class="p">((</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">atm_options</span> <span class="o">&amp;</span> <span class="n">ATM_ATMOPT_CLP</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">DESCRIPTOR_CLP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">pos</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add 32-bit AAL5 trailer and leave room for its CRC */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vcc_tx_add_aal5_trailer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpi</span><span class="p">,</span> <span class="kt">int</span> <span class="n">uu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">APRINTK</span><span class="p">((((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">,</span>
	    <span class="s">&quot;vcc_tx_add_aal5_trailer: bad ptr=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">((</span><span class="n">uu</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cpi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vcc_tx_memcpy</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">src</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">e</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vcc_tx_memzero</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">m</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">e</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
		<span class="n">e</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="n">m</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Update &quot;butt&quot; register to specify new WritePtr */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lanai_endtx</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptr</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="o">-</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">APRINTK</span><span class="p">((</span><span class="n">ptr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0001FFF0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="s">&quot;lanai_endtx: bad ptr (%d), vci=%d, start,ptr,end=%p,%p,%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">ptr</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span>
	    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">end</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since the &quot;butt register&quot; is a shared resounce on the card we</span>
<span class="cm">	 * serialize all accesses to it through this spinlock.  This is</span>
<span class="cm">	 * mostly just paranoia since the register is rarely &quot;busy&quot; anyway</span>
<span class="cm">	 * but is needed for correctness.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">endtxlock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We need to check if the &quot;butt busy&quot; bit is set before</span>
<span class="cm">	 * updating the butt register.  In theory this should</span>
<span class="cm">	 * never happen because the ATM card is plenty fast at</span>
<span class="cm">	 * updating the register.  Still, we should make sure</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">Status_Reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">STATUS_BUTTBUSY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): butt register &quot;</span>
			    <span class="s">&quot;always busy!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Before we tall the card to start work we need to be sure 100% of</span>
<span class="cm">	 * the info in the service buffer has been written before we tell</span>
<span class="cm">	 * the card about it</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">Butt_Reg</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">endtxlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add one AAL5 PDU to lvcc&#39;s transmit buffer.  Caller garauntees there&#39;s</span>
<span class="cm"> * space available.  &quot;pdusize&quot; is the number of bytes the PDU will take</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_send_one_aal5</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pdusize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pad</span><span class="p">;</span>
	<span class="n">APRINTK</span><span class="p">(</span><span class="n">pdusize</span> <span class="o">==</span> <span class="n">aal5_size</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
	    <span class="s">&quot;lanai_send_one_aal5: wrong size packet (%d != %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">pdusize</span><span class="p">,</span> <span class="n">aal5_size</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="n">vcc_tx_add_aal5_descriptor</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdusize</span><span class="p">);</span>
	<span class="n">pad</span> <span class="o">=</span> <span class="n">pdusize</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">APRINTK</span><span class="p">(</span><span class="n">pad</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pad is negative (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
	<span class="n">APRINTK</span><span class="p">(</span><span class="n">pad</span> <span class="o">&lt;</span> <span class="mi">48</span><span class="p">,</span> <span class="s">&quot;pad is too big (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
	<span class="n">vcc_tx_memcpy</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">vcc_tx_memzero</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
	<span class="n">vcc_tx_add_aal5_trailer</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lanai_endtx</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">);</span>
	<span class="n">lanai_free_skb</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Try to fill the buffer - don&#39;t call unless there is backlog */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vcc_tx_unqueue_aal5</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">endptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">space</span> <span class="o">=</span> <span class="n">vcc_tx_space</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">endptr</span><span class="p">);</span>
	<span class="n">APRINTK</span><span class="p">(</span><span class="n">vcc_is_backlogged</span><span class="p">(</span><span class="n">lvcc</span><span class="p">),</span>
	    <span class="s">&quot;vcc_tx_unqueue() called with empty backlog (vci=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">space</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">backlog</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_backlog</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">aal5_size</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&gt;</span> <span class="n">space</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No room for this packet - put it back on queue */</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">backlog</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lanai_send_one_aal5</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">space</span> <span class="o">-=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc_is_backlogged</span><span class="p">(</span><span class="n">lvcc</span><span class="p">))</span> <span class="p">{</span>
	    <span class="nl">no_backlog:</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">backlog_vccs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Given an skb that we want to transmit either send it now or queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vcc_tx_aal5</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">space</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc_is_backlogged</span><span class="p">(</span><span class="n">lvcc</span><span class="p">))</span>		<span class="cm">/* Already backlogged */</span>
		<span class="k">goto</span> <span class="n">queue_it</span><span class="p">;</span>
	<span class="n">space</span> <span class="o">=</span> <span class="n">vcc_tx_space</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span>
		    <span class="n">TXREADPTR_GET_PTR</span><span class="p">(</span><span class="n">cardvcc_read</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">vcc_txreadptr</span><span class="p">)));</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">aal5_size</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">APRINTK</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">&gt;=</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;vcc_tx_aal5: n too small (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">space</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* No space for this PDU */</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">backlog_vccs</span><span class="p">);</span>
	    <span class="nl">queue_it:</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">backlog</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lanai_send_one_aal5</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vcc_tx_unqueue_aal0</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">endptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DEV_LABEL</span>
	    <span class="s">&quot;: vcc_tx_unqueue_aal0: not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vcc_tx_aal0</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;: vcc_tx_aal0: not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Remember to increment lvcc-&gt;tx.atmvcc-&gt;stats-&gt;tx */</span>
	<span class="n">lanai_free_skb</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- VCC RX BUFFER UTILITIES: */</span>

<span class="cm">/* unlike the _tx_ cousins, this doesn&#39;t update ptr */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vcc_rx_memcpy</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">m</span> <span class="o">=</span> <span class="p">((</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span>
	    <span class="p">((</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">end</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest</span> <span class="o">+</span> <span class="n">n</span> <span class="o">-</span> <span class="n">m</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">m</span><span class="p">);</span>
	<span class="cm">/* Make sure that these copies don&#39;t get reordered */</span>
	<span class="n">barrier</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Receive AAL5 data on a VCC with a particular endptr */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vcc_rx_aal5</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">endptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">[</span><span class="n">endptr</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">end</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">+=</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">APRINTK</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">n</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">),</span>
	    <span class="s">&quot;vcc_rx_aal5: n out of range (%d/%Zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">n</span><span class="p">,</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">));</span>
	<span class="cm">/* Recover the second-to-last word to get true pdu length */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">end</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">)</span>
		<span class="n">x</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">end</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">];</span>
	<span class="cm">/*</span>
<span class="cm">	 * Before we actually read from the buffer, make sure the memory</span>
<span class="cm">	 * changes have arrived</span>
<span class="cm">	 */</span>
	<span class="n">rmb</span><span class="p">();</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="n">aal5_size</span><span class="p">(</span><span class="n">size</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Make sure size matches padding */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): Got bad AAL5 length &quot;</span>
		    <span class="s">&quot;on vci=%d - size=%d n=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">rx_badlen</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">atm_alloc_charge</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_nomem</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">vcc_rx_memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="p">;</span>
	<span class="n">__net_timestamp</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
    <span class="nl">out:</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">endptr</span><span class="p">,</span> <span class="n">vcc_rxreadptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vcc_rx_aal0</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;: vcc_rx_aal0: not implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Remember to get read_lock(&amp;vcc_sklist_lock) while looking up VC */</span>
	<span class="cm">/* Remember to increment lvcc-&gt;rx.atmvcc-&gt;stats-&gt;rx */</span>
<span class="p">}</span>

<span class="cm">/* -------------------- MANAGING HOST-BASED VCC TABLE: */</span>

<span class="cm">/* Decide whether to use vmalloc or get_zeroed_page for VCC table */</span>
<span class="cp">#if (NUM_VCI * BITS_PER_LONG) &lt;= PAGE_SIZE</span>
<span class="cp">#define VCCTABLE_GETFREEPAGE</span>
<span class="cp">#else</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">vcc_table_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef VCCTABLE_GETFREEPAGE</span>
	<span class="n">APRINTK</span><span class="p">((</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">num_vci</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
	    <span class="s">&quot;vcc table &gt; PAGE_SIZE!&quot;</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">**</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ENOMEM</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="kt">int</span> <span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">num_vci</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vcc_table_deallocate</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef VCCTABLE_GETFREEPAGE</span>
	<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* Allocate a fresh lanai_vcc, with the appropriate things cleared */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="nf">new_lanai_vcc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">;</span>
	<span class="n">lvcc</span> <span class="o">=</span>  <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lvcc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">lvcc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">backlog</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lvcc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lanai_get_sized_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lanai_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_sdu</span><span class="p">,</span> <span class="kt">int</span> <span class="n">multiplier</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">max_sdu</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">max_sdu</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">max_sdu</span> <span class="o">=</span> <span class="n">aal5_size</span><span class="p">(</span><span class="n">max_sdu</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_sdu</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">lanai_buf_allocate</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">max_sdu</span> <span class="o">+</span> <span class="mi">32</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lanai_buf_size</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): wanted %d bytes &quot;</span>
		    <span class="s">&quot;for %s buffer, got only %Zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		    <span class="n">name</span><span class="p">,</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Allocated %Zu byte %s buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Setup a RX buffer for a currently unbound AAL5 vci */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">lanai_setup_rx_vci_aal5</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">lanai_get_sized_buffer</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span>
	    <span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">,</span> <span class="n">AAL5_RX_MULTIPLIER</span><span class="p">,</span> <span class="s">&quot;RX&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Setup a TX buffer for a currently unbound AAL5 vci */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lanai_setup_tx_vci</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_sdu</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">unqueue</span> <span class="o">=</span> <span class="n">vcc_tx_unqueue_aal0</span><span class="p">;</span>
		<span class="n">max_sdu</span> <span class="o">=</span> <span class="n">ATM_CELL_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">multiplier</span> <span class="o">=</span> <span class="n">AAL0_TX_MULTIPLIER</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">unqueue</span> <span class="o">=</span> <span class="n">vcc_tx_unqueue_aal5</span><span class="p">;</span>
		<span class="n">max_sdu</span> <span class="o">=</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">;</span>
		<span class="n">multiplier</span> <span class="o">=</span> <span class="n">AAL5_TX_MULTIPLIER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">lanai_get_sized_buffer</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">max_sdu</span><span class="p">,</span>
	    <span class="n">multiplier</span><span class="p">,</span> <span class="s">&quot;TX&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">host_vcc_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">vci_t</span> <span class="n">vci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>    <span class="cm">/* We already were bound in the other direction */</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Binding vci %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">nbound</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Coming out of powerdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONFIG1_POWERDOWN</span><span class="p">;</span>
		<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="n">conf2_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">=</span> <span class="n">cardvcc_addr</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">[</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">=</span> <span class="n">vci</span><span class="p">]</span> <span class="o">=</span> <span class="n">lvcc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">host_vcc_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/* This vcc was never bound */</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Unbinding vci %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">[</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">nbound</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Going into powerdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">|=</span> <span class="n">CONFIG1_POWERDOWN</span><span class="p">;</span>
		<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* -------------------- RESET CARD: */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): *NOT* resetting - not &quot;</span>
	    <span class="s">&quot;implemented</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="cm">/* TODO */</span>
	<span class="cm">/* The following is just a hack until we write the real</span>
<span class="cm">	 * resetter - at least ack whatever interrupt sent us</span>
<span class="cm">	 * here</span>
<span class="cm">	 */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">INT_ALL</span><span class="p">,</span> <span class="n">IntAck_Reg</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">card_reset</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------- SERVICE LIST UTILITIES: */</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate service buffer and tell card about it</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">service_buffer_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lanai_buf_allocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">,</span> <span class="n">SERVICE_ENTRIES</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
	    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">start</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;allocated service buffer at 0x%08lX, size %Zu(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
	    <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">),</span>
	    <span class="n">lanai_buf_size_cardorder</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">));</span>
	<span class="cm">/* Clear ServWrite register to be safe */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ServWrite_Reg</span><span class="p">);</span>
	<span class="cm">/* ServiceStuff register contains size and address of buffer */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span>
	    <span class="n">SSTUFF_SET_SIZE</span><span class="p">(</span><span class="n">lanai_buf_size_cardorder</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">))</span> <span class="o">|</span>
	    <span class="n">SSTUFF_SET_ADDR</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">dmaaddr</span><span class="p">),</span>
	    <span class="n">ServiceStuff_Reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">service_buffer_deallocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lanai_buf_deallocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Bitfields in service list */</span>
<span class="cp">#define SERVICE_TX	(0x80000000)	</span><span class="cm">/* Was from transmission */</span><span class="cp"></span>
<span class="cp">#define SERVICE_TRASH	(0x40000000)	</span><span class="cm">/* RXed PDU was trashed */</span><span class="cp"></span>
<span class="cp">#define SERVICE_CRCERR	(0x20000000)	</span><span class="cm">/* RXed PDU had CRC error */</span><span class="cp"></span>
<span class="cp">#define SERVICE_CI	(0x10000000)	</span><span class="cm">/* RXed PDU had CI set */</span><span class="cp"></span>
<span class="cp">#define SERVICE_CLP	(0x08000000)	</span><span class="cm">/* RXed PDU had CLP set */</span><span class="cp"></span>
<span class="cp">#define SERVICE_STREAM	(0x04000000)	</span><span class="cm">/* RX Stream mode */</span><span class="cp"></span>
<span class="cp">#define SERVICE_GET_VCI(x) (((x)&gt;&gt;16)&amp;0x3FF)</span>
<span class="cp">#define SERVICE_GET_END(x) ((x)&amp;0x1FFF)</span>

<span class="cm">/* Handle one thing from the service list - returns true if it marked a</span>
<span class="cm"> * VCC ready for xmit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_service</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="n">u32</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vci_t</span> <span class="n">vci</span> <span class="o">=</span> <span class="n">SERVICE_GET_VCI</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">;</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="n">lvcc</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">[</span><span class="n">vci</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lvcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;(itf %d) got service entry 0x%X for nonexistent &quot;</span>
		    <span class="s">&quot;vcc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SERVICE_TX</span><span class="p">)</span>
			<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">service_notx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">service_norx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SERVICE_TX</span><span class="p">)</span> <span class="p">{</span>			<span class="cm">/* segmentation interrupt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;(itf %d) got service entry 0x%X for non-TX &quot;</span>
			    <span class="s">&quot;vcc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
			<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">service_notx</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">__set_bit</span><span class="p">(</span><span class="n">vci</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">transmit_ready</span><span class="p">);</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">endptr</span> <span class="o">=</span> <span class="n">SERVICE_GET_END</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;(itf %d) got service entry 0x%X for non-RX &quot;</span>
		    <span class="s">&quot;vcc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">service_norx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;(itf %d) got RX service entry 0x%X for non-AAL5 &quot;</span>
		    <span class="s">&quot;vcc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">s</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">service_rxnotaal5</span><span class="o">++</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SERVICE_TRASH</span> <span class="o">|</span> <span class="n">SERVICE_STREAM</span> <span class="o">|</span> <span class="n">SERVICE_CRCERR</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">vcc_rx_aal5</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">SERVICE_GET_END</span><span class="p">(</span><span class="n">s</span><span class="p">));</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SERVICE_TRASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;got trashed rx pdu on vci %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">service_trash</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">SERVICE_GET_END</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span>
		    <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span><span class="p">)</span> <span class="o">-</span>
		    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">))</span> <span class="o">+</span> <span class="mi">47</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bytes</span> <span class="o">+=</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ovfl_trash</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">/</span> <span class="mi">48</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SERVICE_STREAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">service_stream</span><span class="o">++</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): Got AAL5 stream &quot;</span>
		    <span class="s">&quot;PDU on VCI %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
		<span class="n">lanai_reset</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;got rx crc error on vci %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">service_rxcrc</span><span class="o">++</span><span class="p">;</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">.</span><span class="n">start</span><span class="p">[</span><span class="n">SERVICE_GET_END</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>
	<span class="n">cardvcc_write</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">SERVICE_GET_END</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">vcc_rxreadptr</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Try transmitting on all VCIs that we marked ready to serve */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iter_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="n">vci_t</span> <span class="n">vci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">[</span><span class="n">vci</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc_is_backlogged</span><span class="p">(</span><span class="n">lvcc</span><span class="p">))</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">unqueue</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">endptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Run service queue -- called from interrupt context or with</span>
<span class="cm"> * interrupts otherwise disabled and with the lanai-&gt;servicelock</span>
<span class="cm"> * lock held</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_service</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ntx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wreg</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">ServWrite_Reg</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="n">wreg</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">ptr</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ntx</span> <span class="o">+=</span> <span class="n">handle_service</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span>
		    <span class="n">le32_to_cpup</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">ptr</span><span class="o">++</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">ptr</span> <span class="o">&gt;=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>
			<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">wreg</span><span class="p">,</span> <span class="n">ServRead_Reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
		<span class="n">vci_bitfield_iterate</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">transmit_ready</span><span class="p">,</span>
		    <span class="n">iter_transmit</span><span class="p">);</span>
		<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">transmit_ready</span><span class="p">,</span> <span class="n">NUM_VCI</span><span class="p">);</span>
		<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* -------------------- GATHER STATISTICS: */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">statreg</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">Statistics_Reg</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">atm_ovfl</span> <span class="o">+=</span> <span class="n">STATS_GET_FIFO_OVFL</span><span class="p">(</span><span class="n">statreg</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hec_err</span> <span class="o">+=</span> <span class="n">STATS_GET_HEC_ERR</span><span class="p">(</span><span class="n">statreg</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vci_trash</span> <span class="o">+=</span> <span class="n">STATS_GET_BAD_VCI</span><span class="p">(</span><span class="n">statreg</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ovfl_trash</span> <span class="o">+=</span> <span class="n">STATS_GET_BUF_OVFL</span><span class="p">(</span><span class="n">statreg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- POLLING TIMER: */</span>

<span class="cp">#ifndef DEBUG_RW</span>
<span class="cm">/* Try to undequeue 1 backlogged vcc */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iter_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="n">vci_t</span> <span class="n">vci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">[</span><span class="n">vci</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">endptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">vcc_is_backlogged</span><span class="p">(</span><span class="n">lvcc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">__clear_bit</span><span class="p">(</span><span class="n">vci</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">backlog_vccs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">endptr</span> <span class="o">=</span> <span class="n">TXREADPTR_GET_PTR</span><span class="p">(</span><span class="n">cardvcc_read</span><span class="p">(</span><span class="n">lvcc</span><span class="p">,</span> <span class="n">vcc_txreadptr</span><span class="p">));</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">unqueue</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="n">endptr</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !DEBUG_RW */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_timed_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
<span class="cp">#ifndef DEBUG_RW</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">&amp;</span> <span class="n">CONFIG1_POWERDOWN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* USE_POWERDOWN */</span><span class="cp"></span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* If we can grab the spinlock, check if any services need to be run */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spin_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">servicelock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">run_service</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">servicelock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* ...and see if any backlogged VCs can make progress */</span>
	<span class="cm">/* unfortunately linux has no read_trylock() currently */</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="n">vci_bitfield_iterate</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">backlog_vccs</span><span class="p">,</span> <span class="n">iter_dequeue</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">get_statistics</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* !DEBUG_RW */</span><span class="cp"></span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">LANAI_POLL_PERIOD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lanai_timed_poll_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">LANAI_POLL_PERIOD</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lanai</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">lanai_timed_poll</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lanai_timed_poll_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- INTERRUPT SERVICE: */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lanai_int_1</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_SERVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">INT_SERVICE</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">servicelock</span><span class="p">);</span>
		<span class="n">run_service</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">servicelock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_AAL0_STR</span> <span class="o">|</span> <span class="n">INT_AAL0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_AAL0_STR</span> <span class="o">|</span> <span class="n">INT_AAL0</span><span class="p">);</span>
		<span class="n">vcc_rx_aal0</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* The rest of the interrupts are pretty rare */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">==</span> <span class="n">reason</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_STATS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reason</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INT_STATS</span><span class="p">;</span>	<span class="cm">/* No need to ack */</span>
		<span class="n">get_statistics</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_STATUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_STATUS</span><span class="p">;</span>
		<span class="n">lanai_check_status</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_DMASHUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): driver error - DMA &quot;</span>
		    <span class="s">&quot;shutdown, reason=0x%08X, address=0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_DMASHUT</span><span class="p">),</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">DMA_Addr_Reg</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_TABORTBM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lanai_reset</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_DMASHUT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): re-enabling DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">dma_reenable</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pcistatus_check</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_TABORTSENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_TABORTSENT</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): sent PCI target abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">pcistatus_check</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_SEGSHUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): driver error - &quot;</span>
		    <span class="s">&quot;segmentation shutdown, reason=0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">INT_SEGSHUT</span><span class="p">));</span>
		<span class="n">lanai_reset</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_PING</span> <span class="o">|</span> <span class="n">INT_WAKE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): driver error - &quot;</span>
		    <span class="s">&quot;unexpected interrupt 0x%08X, resetting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INT_PING</span> <span class="o">|</span> <span class="n">INT_WAKE</span><span class="p">)));</span>
		<span class="n">lanai_reset</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ack</span> <span class="o">!=</span> <span class="n">reason</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;unacked ints: 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ack</span><span class="p">));</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
   <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">IntAck_Reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lanai_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span> <span class="o">=</span> <span class="n">devid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reason</span><span class="p">;</span>

<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re powered down we shouldn&#39;t be generating any interrupts -</span>
<span class="cm">	 * so assume that this is a shared interrupt line and it&#39;s for someone</span>
<span class="cm">	 * else</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">&amp;</span> <span class="n">CONFIG1_POWERDOWN</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">intr_pending</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>	<span class="cm">/* Must be for someone else */</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>		<span class="cm">/* Maybe we&#39;ve been unplugged? */</span>
		<span class="n">lanai_int_1</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="n">reason</span> <span class="o">=</span> <span class="n">intr_pending</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">reason</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO - it would be nice if we could use the &quot;delayed interrupt&quot; system</span>
<span class="cm"> *   to some advantage</span>
<span class="cm"> */</span>

<span class="cm">/* -------------------- CHECK BOARD ID/REV: */</span>

<span class="cm">/*</span>
<span class="cm"> * The board id and revision are stored both in the reset register and</span>
<span class="cm"> * in the PCI configuration space - the documentation says to check</span>
<span class="cm"> * each of them.  If revp!=NULL we store the revision there</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_board_id_and_rev</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">revp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%s says board_id=%d, board_rev=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">RESET_GET_BOARD_ID</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">RESET_GET_BOARD_REV</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">RESET_GET_BOARD_ID</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="o">!=</span> <span class="n">BOARD_ID_LANAI256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;: Found %s board-id %d -- not a &quot;</span>
		    <span class="s">&quot;Lanai 25.6</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">RESET_GET_BOARD_ID</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">revp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">revp</span> <span class="o">=</span> <span class="n">RESET_GET_BOARD_REV</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------- PCI INITIALIZATION/SHUTDOWN: */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lanai_pci_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): can&#39;t enable &quot;</span>
		    <span class="s">&quot;PCI device&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DEV_LABEL</span>
		    <span class="s">&quot;(itf %d): No suitable DMA available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DEV_LABEL</span>
		    <span class="s">&quot;(itf %d): No suitable DMA available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">check_board_id_and_rev</span><span class="p">(</span><span class="s">&quot;PCI&quot;</span><span class="p">,</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
	<span class="cm">/* Set latency timer to zero as per lanai docs */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): can&#39;t write &quot;</span>
		    <span class="s">&quot;PCI_LATENCY_TIMER: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pcistatus_check</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pcistatus_check</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------- VPI/VCI ALLOCATION: */</span>

<span class="cm">/*</span>
<span class="cm"> * We _can_ use VCI==0 for normal traffic, but only for UBR (or we&#39;ll</span>
<span class="cm"> * get a CBRZERO interrupt), and we can use it only if no one is receiving</span>
<span class="cm"> * AAL0 traffic (since they will use the same queue) - according to the</span>
<span class="cm"> * docs we shouldn&#39;t even use it for AAL0 traffic</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">vci0_is_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span> <span class="o">||</span> <span class="n">qos</span><span class="o">-&gt;</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">naal0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf2</span> <span class="o">|=</span> <span class="n">CONFIG2_VCI0_NORMAL</span><span class="p">;</span>
		<span class="n">conf2_write_if_powerup</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return true if vci is currently unused, or if requested qos is</span>
<span class="cm"> * compatible</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vci_is_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span> <span class="n">vci_t</span> <span class="n">vci</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atmvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">[</span><span class="n">vci</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vci</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">vci0_is_ok</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">qos</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lvcc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">!=</span> <span class="n">atmvcc</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">!=</span> <span class="n">atmvcc</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span> <span class="o">!=</span> <span class="n">atmvcc</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span> <span class="o">&amp;&amp;</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">naal0</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">qos</span><span class="o">-&gt;</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">vci0</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vci0</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">vci0</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONFIG2_VCI0_NORMAL</span><span class="p">;</span>
		<span class="n">conf2_write_if_powerup</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lanai_normalize_ci</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atmvcc</span><span class="p">,</span> <span class="kt">short</span> <span class="o">*</span><span class="n">vpip</span><span class="p">,</span> <span class="n">vci_t</span> <span class="o">*</span><span class="n">vcip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">vpip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATM_VPI_ANY</span>:
			<span class="o">*</span><span class="n">vpip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* FALLTHROUGH */</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">vcip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATM_VCI_ANY</span>:
			<span class="k">for</span> <span class="p">(</span><span class="o">*</span><span class="n">vcip</span> <span class="o">=</span> <span class="n">ATM_NOT_RSV_VCI</span><span class="p">;</span> <span class="o">*</span><span class="n">vcip</span> <span class="o">&lt;</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">num_vci</span><span class="p">;</span>
			    <span class="p">(</span><span class="o">*</span><span class="n">vcip</span><span class="p">)</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vci_is_ok</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="o">*</span><span class="n">vcip</span><span class="p">,</span> <span class="n">atmvcc</span><span class="p">))</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">vcip</span> <span class="o">&gt;=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">num_vci</span> <span class="o">||</span> <span class="o">*</span><span class="n">vcip</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">vci_is_ok</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="o">*</span><span class="n">vcip</span><span class="p">,</span> <span class="n">atmvcc</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------- MANAGE CBR: */</span>

<span class="cm">/*</span>
<span class="cm"> * CBR ICG is stored as a fixed-point number with 4 fractional bits.</span>
<span class="cm"> * Note that storing a number greater than 2046.0 will result in</span>
<span class="cm"> * incorrect shaping</span>
<span class="cm"> */</span>
<span class="cp">#define CBRICG_FRAC_BITS	(4)</span>
<span class="cp">#define CBRICG_MAX		(2046 &lt;&lt; CBRICG_FRAC_BITS)</span>

<span class="cm">/*</span>
<span class="cm"> * ICG is related to PCR with the formula PCR = MAXPCR / (ICG + 1)</span>
<span class="cm"> * where MAXPCR is (according to the docs) 25600000/(54*8),</span>
<span class="cm"> * which is equal to (3125&lt;&lt;9)/27.</span>
<span class="cm"> *</span>
<span class="cm"> * Solving for ICG, we get:</span>
<span class="cm"> *    ICG = MAXPCR/PCR - 1</span>
<span class="cm"> *    ICG = (3125&lt;&lt;9)/(27*PCR) - 1</span>
<span class="cm"> *    ICG = ((3125&lt;&lt;9) - (27*PCR)) / (27*PCR)</span>
<span class="cm"> *</span>
<span class="cm"> * The end result is supposed to be a fixed-point number with FRAC_BITS</span>
<span class="cm"> * bits of a fractional part, so we keep everything in the numerator</span>
<span class="cm"> * shifted by that much as we compute</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcr_to_cbricg</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rounddown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* 1 = Round PCR down, i.e. round ICG _up_ */</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">icg</span><span class="p">,</span> <span class="n">pcr</span> <span class="o">=</span> <span class="n">atm_pcr_goal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* Use maximum bandwidth */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rounddown</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pcr</span> <span class="o">=</span> <span class="o">-</span><span class="n">pcr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">pcr</span> <span class="o">*</span> <span class="mi">27</span><span class="p">;</span>
	<span class="n">icg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3125</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">9</span> <span class="o">+</span> <span class="n">CBRICG_FRAC_BITS</span><span class="p">))</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="n">CBRICG_FRAC_BITS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rounddown</span><span class="p">)</span>
		<span class="n">icg</span> <span class="o">+=</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">icg</span> <span class="o">/=</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">icg</span> <span class="o">&gt;</span> <span class="n">CBRICG_MAX</span><span class="p">)</span>
		<span class="n">icg</span> <span class="o">=</span> <span class="n">CBRICG_MAX</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;pcr_to_cbricg: pcr=%d rounddown=%c icg=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">pcr</span><span class="p">,</span> <span class="n">rounddown</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="n">icg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">icg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lanai_cbr_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">pcr_to_cbricg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">),</span> <span class="n">CBR_ICG_Reg</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span> <span class="n">CBR_PTR_Reg</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf2</span> <span class="o">|=</span> <span class="n">CONFIG2_CBR_ENABLE</span><span class="p">;</span>
	<span class="n">conf2_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lanai_cbr_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf2</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CONFIG2_CBR_ENABLE</span><span class="p">;</span>
	<span class="n">conf2_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------- OPERATIONS: */</span>

<span class="cm">/* setup a newly detected device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lanai_dev_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">raw_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;In lanai_dev_open()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Basic device fields */</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">num_vci</span> <span class="o">=</span> <span class="n">NUM_VCI</span><span class="p">;</span>
	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">backlog_vccs</span><span class="p">,</span> <span class="n">NUM_VCI</span><span class="p">);</span>
	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">transmit_ready</span><span class="p">,</span> <span class="n">NUM_VCI</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">naal0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">nbound</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">endtxlock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">servicelock</span><span class="p">);</span>
	<span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">&lt;</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">num_vci</span><span class="p">)</span>
		<span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span><span class="o">++</span><span class="p">;</span>
	<span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">=</span> <span class="n">ATM_25_PCR</span><span class="p">;</span>

	<span class="cm">/* 3.2: PCI initialization */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">lanai_pci_start</span><span class="p">(</span><span class="n">lanai</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">raw_base</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus_addr_t</span><span class="p">)</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">raw_base</span><span class="p">,</span> <span class="n">LANAI_MAPPING_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;: couldn&#39;t remap I/O space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_pci</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* 3.3: Reset lanai and PHY */</span>
	<span class="n">reset_board</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">Config1_Reg</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CONFIG1_GPOUT1</span> <span class="o">|</span> <span class="n">CONFIG1_POWERDOWN</span> <span class="o">|</span>
	    <span class="n">CONFIG1_MASK_LEDMODE</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">|=</span> <span class="n">CONFIG1_SET_LEDMODE</span><span class="p">(</span><span class="n">LEDMODE_NOT_SOOL</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">|</span> <span class="n">CONFIG1_GPOUT1</span><span class="p">,</span> <span class="n">Config1_Reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * 3.4: Turn on endian mode for big-endian hardware</span>
<span class="cm">	 *   We don&#39;t actually want to do this - the actual bit fields</span>
<span class="cm">	 *   in the endian register are not documented anywhere.</span>
<span class="cm">	 *   Instead we do the bit-flipping ourselves on big-endian</span>
<span class="cm">	 *   hardware.</span>
<span class="cm">	 *</span>
<span class="cm">	 * 3.5: get the board ID/rev by reading the reset register</span>
<span class="cm">	 */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">check_board_id_and_rev</span><span class="p">(</span><span class="s">&quot;register&quot;</span><span class="p">,</span>
	    <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">Reset_Reg</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">board_rev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_unmap</span><span class="p">;</span>

	<span class="cm">/* 3.6: read EEPROM */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">eeprom_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_unmap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">eeprom_validate</span><span class="p">(</span><span class="n">lanai</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_unmap</span><span class="p">;</span>

	<span class="cm">/* 3.7: re-reset PHY, do loopback tests, setup PHY */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">|</span> <span class="n">CONFIG1_GPOUT1</span><span class="p">,</span> <span class="n">Config1_Reg</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="cm">/* TODO - loopback tests */</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CONFIG1_GPOUT2</span> <span class="o">|</span> <span class="n">CONFIG1_GPOUT3</span> <span class="o">|</span> <span class="n">CONFIG1_DMA_ENABLE</span><span class="p">);</span>
	<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>

	<span class="cm">/* 3.8/3.9: test and initialize card SRAM */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">sram_test_and_clear</span><span class="p">(</span><span class="n">lanai</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_unmap</span><span class="p">;</span>

	<span class="cm">/* 3.10: initialize lanai registers */</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">|=</span> <span class="n">CONFIG1_DMA_ENABLE</span><span class="p">;</span>
	<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">service_buffer_allocate</span><span class="p">(</span><span class="n">lanai</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_unmap</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">vcc_table_allocate</span><span class="p">(</span><span class="n">lanai</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_service</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf2</span> <span class="o">=</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">num_vci</span> <span class="o">&gt;=</span> <span class="mi">512</span> <span class="o">?</span> <span class="n">CONFIG2_HOWMANY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">CONFIG2_HEC_DROP</span> <span class="o">|</span>	<span class="cm">/* ??? */</span> <span class="n">CONFIG2_PTI7_MODE</span><span class="p">;</span>
	<span class="n">conf2_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">TX_FIFO_DEPTH</span><span class="p">,</span> <span class="n">TxDepth_Reg</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CBR_ICG_Reg</span><span class="p">);</span>	<span class="cm">/* CBR defaults to no limit */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lanai_int</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
	    <span class="n">DEV_LABEL</span><span class="p">,</span> <span class="n">lanai</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;: can&#39;t allocate interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_vcctable</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mb</span><span class="p">();</span>				<span class="cm">/* Make sure that all that made it */</span>
	<span class="n">intr_enable</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">INT_ALL</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">INT_PING</span> <span class="o">|</span> <span class="n">INT_WAKE</span><span class="p">));</span>
	<span class="cm">/* 3.11: initialize loop mode (i.e. turn looping off) */</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">=</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CONFIG1_MASK_LOOPMODE</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">CONFIG1_SET_LOOPMODE</span><span class="p">(</span><span class="n">LOOPMODE_NORMAL</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">CONFIG1_GPOUT2</span> <span class="o">|</span> <span class="n">CONFIG1_GPOUT3</span><span class="p">;</span>
	<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">Status_Reg</span><span class="p">);</span>
	<span class="cm">/* We&#39;re now done initializing this card */</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">|=</span> <span class="n">CONFIG1_POWERDOWN</span><span class="p">;</span>
	<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">,</span> <span class="n">eeprom_mac</span><span class="p">(</span><span class="n">lanai</span><span class="p">),</span> <span class="n">ESI_LEN</span><span class="p">);</span>
	<span class="n">lanai_timed_poll_start</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): rev.%d, base=0x%lx, irq=%u &quot;</span>
		<span class="s">&quot;(%pMF)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): LANAI%s, serialno=%u(0x%X), &quot;</span>
	    <span class="s">&quot;board_rev=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
	    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">==</span><span class="n">lanai2</span> <span class="o">?</span> <span class="s">&quot;2&quot;</span> <span class="o">:</span> <span class="s">&quot;HB&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">serialno</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">serialno</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">board_rev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nl">error_vcctable:</span>
	<span class="n">vcc_table_deallocate</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
    <span class="nl">error_service:</span>
	<span class="n">service_buffer_deallocate</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
    <span class="nl">error_unmap:</span>
	<span class="n">reset_board</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">Config1_Reg</span><span class="p">)</span> <span class="o">|</span> <span class="n">CONFIG1_POWERDOWN</span><span class="p">;</span>
	<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
    <span class="nl">error_pci:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
    <span class="nl">error:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called when device is being shutdown, and all vcc&#39;s are gone - higher</span>
<span class="cm"> * levels will deallocate the atm device for us</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_dev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): shutting down interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">lanai_timed_poll_stop</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">Config1_Reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CONFIG1_POWERDOWN</span><span class="p">;</span>
	<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">intr_disable</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">INT_ALL</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lanai</span><span class="p">);</span>
	<span class="n">reset_board</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="cp">#ifdef USE_POWERDOWN</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">conf1</span> <span class="o">|=</span> <span class="n">CONFIG1_POWERDOWN</span><span class="p">;</span>
	<span class="n">conf1_write</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="n">vcc_table_deallocate</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="n">service_buffer_deallocate</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* close a vcc */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lanai_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atmvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="n">atmvcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lanai_shutdown_rx_vci</span><span class="p">(</span><span class="n">lvcc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">naal0</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">aal0_buffer_free</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">lanai_buf_deallocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="n">atmvcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">lanai_cbr_shutdown</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
			<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lanai_shutdown_tx_vci</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">);</span>
		<span class="n">lanai_buf_deallocate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">nref</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host_vcc_unbind</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lvcc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* open a vcc on the card to vpi/vci */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lanai_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atmvcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vci</span> <span class="o">=</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">vpi</span> <span class="o">=</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>
	<span class="cm">/* we don&#39;t support partial open - it&#39;s not really useful anyway */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">vpi</span> <span class="o">==</span> <span class="n">ATM_VPI_UNSPEC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vci</span> <span class="o">==</span> <span class="n">ATM_VCI_UNSPEC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">lanai</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">lanai_normalize_ci</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">atmvcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vpi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL0</span> <span class="o">&amp;&amp;</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): open %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">vpi</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
	<span class="n">lvcc</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">[</span><span class="n">vci</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lvcc</span> <span class="o">=</span> <span class="n">new_lanai_vcc</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lvcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">lvcc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">nref</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">APRINTK</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;rx.atmvcc!=NULL, vci=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vci</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">naal0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">result</span> <span class="o">=</span> <span class="n">aal0_buffer_allocate</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">lanai_setup_rx_vci_aal5</span><span class="p">(</span>
			    <span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">=</span> <span class="n">atmvcc</span><span class="p">;</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_nomem</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">rx_badlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">service_trash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">service_stream</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">service_rxcrc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span>
			<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">naal0</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">APRINTK</span><span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;tx.atmvcc!=NULL, vci=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vci</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">lanai_setup_tx_vci</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
		<span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">=</span> <span class="n">atmvcc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">APRINTK</span><span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span>
			    <span class="s">&quot;cbrvcc!=NULL, vci=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
			<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span> <span class="o">=</span> <span class="n">atmvcc</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">host_vcc_bind</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="n">vci</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Make sure everything made it to RAM before we tell the card about</span>
<span class="cm">	 * the VCC</span>
<span class="cm">	 */</span>
	<span class="n">wmb</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="p">)</span>
		<span class="n">host_vcc_start_rx</span><span class="p">(</span><span class="n">lvcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">host_vcc_start_tx</span><span class="p">(</span><span class="n">lvcc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span> <span class="o">==</span> <span class="n">atmvcc</span><span class="p">)</span>
			<span class="n">lanai_cbr_setup</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nl">out_free:</span>
	<span class="n">lanai_close</span><span class="p">(</span><span class="n">atmvcc</span><span class="p">);</span>
    <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lanai_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atmvcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lvcc</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">vbase</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	      <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">!=</span> <span class="n">atmvcc</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">einval</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;lanai_send: skb==NULL for vci=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">einval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">lanai</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;lanai_send: lanai==NULL for vci=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">einval</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">atmvcc</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ATM_AAL5</span>:
			<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">vcc_tx_aal5</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ATM_AAL0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">ATM_CELL_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">einval</span><span class="p">;</span>
  <span class="cm">/* NOTE - this next line is technically invalid - we haven&#39;t unshared skb */</span>
			<span class="n">cpu_to_be32s</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">vcc_tx_aal0</span><span class="p">(</span><span class="n">lanai</span><span class="p">,</span> <span class="n">lvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;lanai_send: bad aal=%d on vci=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span><span class="p">,</span>
	    <span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
    <span class="nl">einval:</span>
	<span class="n">lanai_free_skb</span><span class="p">(</span><span class="n">atmvcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lanai_change_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">atmvcc</span><span class="p">,</span>
	<span class="cm">/*const*/</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>		<span class="cm">/* TODO: need to write this */</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_PROC_FS</span>
<span class="cp">#define lanai_proc_read NULL</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lanai_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atmdev</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">dev_data</span><span class="p">;</span>
	<span class="n">loff_t</span> <span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lanai_vcc</span> <span class="o">*</span><span class="n">lvcc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): chip=LANAI%s, &quot;</span>
		    <span class="s">&quot;serial=%u, magic=0x%08X, num_vci=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">==</span><span class="n">lanai2</span> <span class="o">?</span> <span class="s">&quot;2&quot;</span> <span class="o">:</span> <span class="s">&quot;HB&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">serialno</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">magicno</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">num_vci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;revision: board=%d, pci_if=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">board_rev</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;EEPROM ESI: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">[</span><span class="n">EEPROM_MAC</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;status: SOOL=%d, LOCD=%d, LED=%d, &quot;</span>
		    <span class="s">&quot;GPIN=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_SOOL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_LOCD</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_LED</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_GPIN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;global buffer sizes: service=%Zu, &quot;</span>
		    <span class="s">&quot;aal0_rx=%Zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">),</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">naal0</span> <span class="o">?</span> <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai</span><span class="o">-&gt;</span><span class="n">aal0buf</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">get_statistics</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;cells in error: overflow=%u, &quot;</span>
		    <span class="s">&quot;closed_vci=%u, bad_HEC=%u, rx_fifo=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">ovfl_trash</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">vci_trash</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">hec_err</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">atm_ovfl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;PCI errors: parity_detect=%u, &quot;</span>
		    <span class="s">&quot;master_abort=%u, master_target_abort=%u,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pcierr_parity_detect</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pcierr_serr_set</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pcierr_m_target_abort</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;            slave_target_abort=%u, &quot;</span>
		    <span class="s">&quot;master_parity=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pcierr_s_target_abort</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pcierr_master_parity</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;                     no_tx=%u, &quot;</span>
		    <span class="s">&quot;no_rx=%u, bad_rx_aal=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">service_norx</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">service_notx</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">service_rxnotaal5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span><span class="o">--</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;resets: dma=%u, card=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">dma_reenable</span><span class="p">,</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">card_reset</span><span class="p">);</span>
	<span class="cm">/* At this point, &quot;left&quot; should be the VCI we&#39;re looking for */</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="p">;</span> <span class="n">left</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="n">NUM_VCI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">lvcc</span> <span class="o">=</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">vccs</span><span class="p">[</span><span class="n">left</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Note that we re-use &quot;left&quot; here since we&#39;re done with it */</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;VCI %4d: nref=%d, rx_nomem=%u&quot;</span><span class="p">,</span>  <span class="p">(</span><span class="n">vci_t</span><span class="p">)</span> <span class="n">left</span><span class="p">,</span>
	    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">nref</span><span class="p">,</span> <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_nomem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">left</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">left</span><span class="p">],</span> <span class="s">&quot;,</span><span class="se">\n</span><span class="s">          rx_AAL=%d&quot;</span><span class="p">,</span>
		    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL5</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL5</span><span class="p">)</span>
			<span class="n">left</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">left</span><span class="p">],</span> <span class="s">&quot;, rx_buf_size=%Zu, &quot;</span>
			    <span class="s">&quot;rx_bad_len=%u,</span><span class="se">\n</span><span class="s">          rx_service_trash=%u, &quot;</span>
			    <span class="s">&quot;rx_service_stream=%u, rx_bad_crc=%u&quot;</span><span class="p">,</span>
			    <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">.</span><span class="n">buf</span><span class="p">),</span>
			    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">rx_badlen</span><span class="p">,</span>
			    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">service_trash</span><span class="p">,</span>
			    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">service_stream</span><span class="p">,</span>
			    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">aal5</span><span class="p">.</span><span class="n">service_rxcrc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">left</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page</span><span class="p">[</span><span class="n">left</span><span class="p">],</span> <span class="s">&quot;,</span><span class="se">\n</span><span class="s">          tx_AAL=%d, &quot;</span>
		    <span class="s">&quot;tx_buf_size=%Zu, tx_qos=%cBR, tx_backlogged=%c&quot;</span><span class="p">,</span>
		    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL5</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		    <span class="n">lanai_buf_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">buf</span><span class="p">),</span>
		    <span class="n">lvcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">atmvcc</span> <span class="o">==</span> <span class="n">lanai</span><span class="o">-&gt;</span><span class="n">cbrvcc</span> <span class="o">?</span> <span class="sc">&#39;C&#39;</span> <span class="o">:</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span>
		    <span class="n">vcc_is_backlogged</span><span class="p">(</span><span class="n">lvcc</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;Y&#39;</span> <span class="o">:</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>
	<span class="n">page</span><span class="p">[</span><span class="n">left</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="n">page</span><span class="p">[</span><span class="n">left</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="nl">out:</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">left</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PROC_FS */</span><span class="cp"></span>

<span class="cm">/* -------------------- HOOKS: */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">dev_close</span>	<span class="o">=</span> <span class="n">lanai_dev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">lanai_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">lanai_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send</span>		<span class="o">=</span> <span class="n">lanai_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_put</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_get</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_qos</span>	<span class="o">=</span> <span class="n">lanai_change_qos</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_read</span>	<span class="o">=</span> <span class="n">lanai_proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span>
<span class="p">};</span>

<span class="cm">/* initialize one probed card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">lanai_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ident</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lanai_dev</span> <span class="o">*</span><span class="n">lanai</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">atmdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">lanai</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lanai</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lanai</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span>
		       <span class="s">&quot;: couldn&#39;t allocate dev_data structure!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atmdev</span> <span class="o">=</span> <span class="n">atm_dev_register</span><span class="p">(</span><span class="n">DEV_LABEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atmdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span>
		    <span class="s">&quot;: couldn&#39;t register atm device!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atmdev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">lanai</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">lanai</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">lanai_type</span><span class="p">)</span> <span class="n">ident</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">lanai_dev_open</span><span class="p">(</span><span class="n">atmdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;lanai_start() failed, err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">result</span><span class="p">);</span>
		<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">atmdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">lanai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">lanai_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EF</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EF_ATM_LANAI2</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EF</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EF_ATM_LANAIHB</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>	<span class="cm">/* terminal entry */</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">lanai_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">lanai_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">DEV_LABEL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">lanai_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">lanai_init_one</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">lanai_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;: no adapter found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">lanai_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We&#39;ll only get called when all the interfaces are already</span>
<span class="cm">	 * gone, so there isn&#39;t much to do</span>
<span class="cm">	 */</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;cleanup_module()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lanai_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">lanai_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">lanai_module_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mitchell Blank Jr &lt;mitch@sfgoth.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Efficient Networks Speedstream 3010 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
