<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › atm › eni.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>eni.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* drivers/atm/eni.c - Efficient Networks ENI155P device driver */</span>
 
<span class="cm">/* Written 1995-2000 by Werner Almesberger, EPFL LRC/ICA */</span>
 

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/atm.h&gt;</span>
<span class="cp">#include &lt;linux/atmdev.h&gt;</span>
<span class="cp">#include &lt;linux/sonet.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/uio.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/atm_eni.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/string.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &quot;tonga.h&quot;</span>
<span class="cp">#include &quot;midway.h&quot;</span>
<span class="cp">#include &quot;suni.h&quot;</span>
<span class="cp">#include &quot;eni.h&quot;</span>

<span class="cp">#if !defined(__i386__) &amp;&amp; !defined(__x86_64__)</span>
<span class="cp">#ifndef ioremap_nocache</span>
<span class="cp">#define ioremap_nocache(X,Y) ioremap(X,Y)</span>
<span class="cp">#endif </span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *</span>
<span class="cm"> * Show stoppers</span>
<span class="cm"> *  none</span>
<span class="cm"> *</span>
<span class="cm"> * Minor</span>
<span class="cm"> *  - OAM support</span>
<span class="cm"> *  - fix bugs listed below</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * KNOWN BUGS:</span>
<span class="cm"> *</span>
<span class="cm"> * - may run into JK-JK bug and deadlock</span>
<span class="cm"> * - should allocate UBR channel first</span>
<span class="cm"> * - buffer space allocation algorithm is stupid</span>
<span class="cm"> *   (RX: should be maxSDU+maxdelay*rate</span>
<span class="cm"> *    TX: should be maxSDU+min(maxSDU,maxdelay*rate) )</span>
<span class="cm"> * - doesn&#39;t support OAM cells</span>
<span class="cm"> * - eni_put_free may hang if not putting memory fragments that _complete_</span>
<span class="cm"> *   2^n block (never happens in real life, though)</span>
<span class="cm"> */</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">#define DPRINTK(format,args...) printk(KERN_DEBUG format,##args)</span>
<span class="cp">#else</span>
<span class="cp">#define DPRINTK(format,args...)</span>
<span class="cp">#endif</span>


<span class="cp">#ifndef CONFIG_ATM_ENI_TUNE_BURST</span>
<span class="cp">#define CONFIG_ATM_ENI_BURST_TX_8W</span>
<span class="cp">#define CONFIG_ATM_ENI_BURST_RX_4W</span>
<span class="cp">#endif</span>


<span class="cp">#ifndef CONFIG_ATM_ENI_DEBUG</span>


<span class="cp">#define NULLCHECK(x)</span>

<span class="cp">#define EVENT(s,a,b)</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">event_dump</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>


<span class="cp">#else</span>


<span class="cm">/* </span>
<span class="cm"> * NULL pointer checking</span>
<span class="cm"> */</span>

<span class="cp">#define NULLCHECK(x) \</span>
<span class="cp">	if ((unsigned long) (x) &lt; 0x30) \</span>
<span class="cp">		printk(KERN_CRIT #x &quot;==0x%lx\n&quot;,(unsigned long) (x))</span>

<span class="cm">/*</span>
<span class="cm"> * Very extensive activity logging. Greatly improves bug detection speed but</span>
<span class="cm"> * costs a few Mbps if enabled.</span>
<span class="cm"> */</span>

<span class="cp">#define EV 64</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ev</span><span class="p">[</span><span class="n">EV</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ev_a</span><span class="p">[</span><span class="n">EV</span><span class="p">],</span><span class="n">ev_b</span><span class="p">[</span><span class="n">EV</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">EVENT</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">a</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ev</span><span class="p">[</span><span class="n">ec</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> 
	<span class="n">ev_a</span><span class="p">[</span><span class="n">ec</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">ev_b</span><span class="p">[</span><span class="n">ec</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">ec</span> <span class="o">=</span> <span class="p">(</span><span class="n">ec</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">EV</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">event_dump</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">EV</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">ec</span><span class="o">+</span><span class="n">n</span><span class="p">)</span> <span class="o">%</span> <span class="n">EV</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">ev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">?</span> <span class="n">ev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;(null)&quot;</span><span class="p">,</span><span class="n">ev_a</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">ev_b</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_ENI_DEBUG */</span><span class="cp"></span>


<span class="cm">/*</span>
<span class="cm"> * NExx   must not be equal at end</span>
<span class="cm"> * EExx   may be equal at end</span>
<span class="cm"> * xxPJOK verify validity of pointer jumps</span>
<span class="cm"> * xxPMOK operating on a circular buffer of &quot;c&quot; words</span>
<span class="cm"> */</span>

<span class="cp">#define NEPJOK(a0,a1,b) \</span>
<span class="cp">    ((a0) &lt; (a1) ? (b) &lt;= (a0) || (b) &gt; (a1) : (b) &lt;= (a0) &amp;&amp; (b) &gt; (a1))</span>
<span class="cp">#define EEPJOK(a0,a1,b) \</span>
<span class="cp">    ((a0) &lt; (a1) ? (b) &lt; (a0) || (b) &gt;= (a1) : (b) &lt; (a0) &amp;&amp; (b) &gt;= (a1))</span>
<span class="cp">#define NEPMOK(a0,d,b,c) NEPJOK(a0,(a0+d) &amp; (c-1),b)</span>
<span class="cp">#define EEPMOK(a0,d,b,c) EEPJOK(a0,(a0+d) &amp; (c-1),b)</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">dma_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">queued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">requeued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">backlogged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">rx_enqueued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">rx_dequeued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">pushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">submitted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
  <span class="n">putting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">eni_boards</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cm">/* Read/write registers on card */</span>
<span class="cp">#define eni_in(r)	readl(eni_dev-&gt;reg+(r)*4)</span>
<span class="cp">#define eni_out(v,r)	writel((v),eni_dev-&gt;reg+(r)*4)</span>


<span class="cm">/*-------------------------------- utilities --------------------------------*/</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;  %d: %p %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span>
		    <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">,</span>
		    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">order</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;Free memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dump_mem</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;TX buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;  TX %d @ %p: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span>
			    <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">words</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;RX buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;  RX %d @ %p: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span>
			    <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">,</span>
			    <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;----</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">eni_put_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_free</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span><span class="n">order</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;init 0x%lx+%ld(0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">+=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">base_diff</span><span class="p">;</span>
	<span class="n">list</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;eni_put_free overflow (%p,%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">start</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">start</span> <span class="o">|</span> <span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">));</span> <span class="n">order</span><span class="o">++</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">MID_MIN_BUF_SIZE</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;eni_put_free: order %d too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">order</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list</span><span class="p">[</span><span class="n">len</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">list</span><span class="p">[</span><span class="n">len</span><span class="p">].</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
		<span class="n">len</span><span class="o">++</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="cm">/*dump_mem(eni_dev);*/</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">eni_alloc_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_free</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">start</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">best_order</span><span class="p">,</span><span class="n">index</span><span class="p">;</span>

	<span class="n">list</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">MID_MIN_BUF_SIZE</span><span class="p">)</span> <span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">MID_MIN_BUF_SIZE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MID_MAX_BUF_SIZE</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">)</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">size</span><span class="p">;</span> <span class="n">order</span><span class="o">++</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;trying: %ld-&gt;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="n">order</span><span class="p">);</span>
	<span class="n">best_order</span> <span class="o">=</span> <span class="mi">65</span><span class="p">;</span> <span class="cm">/* we don&#39;t have more than 2^64 of anything ... */</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* silence GCC */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">best_order</span> <span class="o">&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">order</span> <span class="o">&amp;&amp;</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">order</span> <span class="o">&gt;</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">best_order</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">order</span><span class="p">;</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">best_order</span> <span class="o">==</span> <span class="mi">65</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">start</span><span class="o">-</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">base_diff</span><span class="p">;</span>
	<span class="n">list</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="o">--</span><span class="n">len</span><span class="p">];</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">;</span>
	<span class="n">eni_put_free</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="n">start</span><span class="o">+*</span><span class="n">size</span><span class="p">,(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">best_order</span><span class="p">)</span><span class="o">-*</span><span class="n">size</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%ld bytes (order %d) at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="n">order</span><span class="p">,</span><span class="n">start</span><span class="p">);</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>       <span class="cm">/* never leak data */</span>
	<span class="cm">/*dump_mem(eni_dev);*/</span>
	<span class="k">return</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">eni_free_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_free</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">order</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">+=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">base_diff</span><span class="p">;</span>
	<span class="n">list</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_len</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">size</span><span class="p">;</span> <span class="n">order</span><span class="o">++</span><span class="p">)</span> <span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eni_free_mem: %p+0x%lx (order %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">order</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">)</span> <span class="o">==</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">start</span><span class="o">^</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">order</span> <span class="o">==</span> <span class="n">order</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;match[%d]: 0x%lx/0x%lx(0x%x), %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">,</span><span class="n">start</span><span class="p">,</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">,</span><span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">order</span><span class="p">,</span><span class="n">order</span><span class="p">);</span>
			<span class="n">list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="o">--</span><span class="n">len</span><span class="p">];</span>
			<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">order</span><span class="p">));</span>
			<span class="n">order</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;eni_free_mem overflow (%p,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">start</span><span class="p">,</span>
		    <span class="n">order</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list</span><span class="p">[</span><span class="n">len</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
	<span class="n">list</span><span class="p">[</span><span class="n">len</span><span class="p">].</span><span class="n">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_len</span> <span class="o">=</span> <span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*dump_mem(eni_dev);*/</span>
<span class="p">}</span>


<span class="cm">/*----------------------------------- RX ------------------------------------*/</span>


<span class="cp">#define ENI_VCC_NOS ((struct atm_vcc *) 1)</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_ident_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* immediately halt adapter */</span>
	<span class="n">eni_out</span><span class="p">(</span><span class="n">eni_in</span><span class="p">(</span><span class="n">MID_MC_S</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="o">~</span><span class="p">(</span><span class="n">MID_DMA_ENABLE</span> <span class="o">|</span> <span class="n">MID_TX_ENABLE</span> <span class="o">|</span> <span class="n">MID_RX_ENABLE</span><span class="p">),</span><span class="n">MID_MC_S</span><span class="p">);</span>
	<span class="cm">/* dump useful information */</span>
	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): driver error - RX ident &quot;</span>
	    <span class="s">&quot;mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;  VCI %d, rxing %d, words %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span>
	    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;  host descr 0x%lx, rx pos 0x%lx, descr value &quot;</span>
	    <span class="s">&quot;0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx_pos</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="o">+</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="o">*</span><span class="mi">4</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;  last %p, servicing %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">,</span>
	    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">servicing</span><span class="p">);</span>
	<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;---dump ends here---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;---recent events---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">event_dump</span><span class="p">();</span>
	<span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* really stop it */</span>
	<span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slow</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_rx_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">skip</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">eff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_rd</span><span class="p">,</span><span class="n">dma_wr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma</span><span class="p">[</span><span class="n">RX_DMA_BUF</span><span class="o">*</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">here</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">paddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* GCC, shut up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">paddr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">ENI_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): VCI %d has &quot;</span>
			    <span class="s">&quot;mis-aligned RX data (0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">);</span>
		<span class="n">ENI_PRV_SIZE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="o">+</span><span class="n">skip</span><span class="p">;</span>
		    <span class="cm">/* PDU plus descriptor */</span>
		<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">eff</span> <span class="o">&amp;&amp;</span> <span class="n">skip</span><span class="p">)</span> <span class="o">||</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* @@@ actually, skip is always == 1 ... */</span>
		<span class="n">here</span> <span class="o">=</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="o">+</span><span class="n">skip</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">here</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span>
		    <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_VCI_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">MID_DT_JK</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">here</span> <span class="o">=</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="o">+</span><span class="n">size</span><span class="o">+</span><span class="n">skip</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eff</span><span class="p">)</span> <span class="n">size</span> <span class="o">+=</span> <span class="n">skip</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">words</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;strange things happen ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;strange things happen ... (skip=%ld,eff=%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">size</span><span class="p">,</span><span class="n">eff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">words</span> <span class="o">=</span> <span class="n">eff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">init</span><span class="p">;</span>

			<span class="n">init</span> <span class="o">=</span> <span class="mi">4</span><span class="o">-</span><span class="p">((</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">init</span> <span class="o">&gt;</span> <span class="n">words</span><span class="p">)</span> <span class="n">init</span> <span class="o">=</span> <span class="n">words</span><span class="p">;</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_WORD</span> <span class="o">|</span> <span class="p">(</span><span class="n">init</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_VCI_SHIFT</span><span class="p">);</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
			<span class="n">paddr</span> <span class="o">+=</span> <span class="n">init</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">words</span> <span class="o">-=</span> <span class="n">init</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_RX_16W </span><span class="cm">/* may work with some PCI chipsets ... */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_16W</span> <span class="o">|</span> <span class="p">((</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			    <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span>
			    <span class="n">MID_DMA_VCI_SHIFT</span><span class="p">);</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
			<span class="n">paddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">words</span> <span class="o">&amp;=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_RX_8W  </span><span class="cm">/* works only with *some* PCI chipsets ... */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_8W</span> <span class="o">|</span> <span class="p">((</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			    <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span>
			    <span class="n">MID_DMA_VCI_SHIFT</span><span class="p">);</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
			<span class="n">paddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">words</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_RX_4W </span><span class="cm">/* recommended */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_4W</span> <span class="o">|</span> <span class="p">((</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			    <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span>
			    <span class="n">MID_DMA_VCI_SHIFT</span><span class="p">);</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
			<span class="n">paddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">words</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_RX_2W </span><span class="cm">/* probably useless if RX_4W, RX_8W, ... */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_2W</span> <span class="o">|</span> <span class="p">((</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			    <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span>
			    <span class="n">MID_DMA_VCI_SHIFT</span><span class="p">);</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
			<span class="n">paddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">words</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_WORD</span> <span class="o">|</span> <span class="p">(</span><span class="n">words</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span>
			    <span class="o">|</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_VCI_SHIFT</span><span class="p">);</span>
			<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">eff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">here</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_VCI_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">MID_DT_JK</span><span class="p">;</span>
		<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">j</span> <span class="o">||</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">RX_DMA_BUF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;!j or j too big!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">trouble</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">MID_DMA_END</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_wr</span> <span class="o">=</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_DMA_WR_RX</span><span class="p">);</span>
	<span class="n">dma_rd</span> <span class="o">=</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_DMA_RD_RX</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Can I move the dma_wr pointer by 2j+1 positions without overwriting</span>
<span class="cm">	 * data that hasn&#39;t been read (position of dma_rd) yet ?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NEPMOK</span><span class="p">(</span><span class="n">dma_wr</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dma_rd</span><span class="p">,</span><span class="n">NR_DMA_RX</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* @@@ +1 is ugly */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): RX DMA full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">trouble</span><span class="p">;</span>
	<span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="o">+</span><span class="n">dma_wr</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dma</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="o">+</span><span class="n">dma_wr</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">dma_wr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_wr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NR_DMA_RX</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ENI_PRV_POS</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="o">+</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
<span class="n">rx_enqueued</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span> <span class="o">=</span> <span class="n">here</span><span class="p">;</span>
	<span class="n">eni_out</span><span class="p">(</span><span class="n">dma_wr</span><span class="p">,</span><span class="n">MID_DMA_WR_RX</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">trouble:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paddr</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">paddr</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		    <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">discard</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>

	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;discard (size=%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">do_rx_dma</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;BUSY LOOP&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	    <span class="cm">/* could do a full fallback, but that might be more expensive */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="p">)</span> <span class="n">ENI_PRV_POS</span><span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">last</span><span class="p">)</span> <span class="o">+=</span> <span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx_pos</span><span class="o">+</span><span class="n">size</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * TODO: should check whether direct copies (without DMA setup, dequeuing on</span>
<span class="cm"> * interrupt, etc.) aren&#39;t much faster for AAL0</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_aal0</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">descr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;rx_aal0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="o">+</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">descr</span> <span class="o">&amp;</span> <span class="n">MID_RED_IDEN</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">MID_RED_RX_ID</span> <span class="o">&lt;&lt;</span> <span class="n">MID_RED_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx_ident_err</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="o">&amp;</span> <span class="n">MID_RED_T</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): trashing empty cell</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">ATM_CELL_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* no HEC */</span>
	<span class="p">}</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">length</span> <span class="o">?</span> <span class="n">atm_alloc_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">discard</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">tstamp</span> <span class="o">=</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;got len %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_rx_dma</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">skb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_aal5</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">descr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">,</span><span class="n">eff</span><span class="p">,</span><span class="n">length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;rx_aal5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;rx_aal5</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">descr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="o">+</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">descr</span> <span class="o">&amp;</span> <span class="n">MID_RED_IDEN</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">MID_RED_RX_ID</span> <span class="o">&lt;&lt;</span> <span class="n">MID_RED_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rx_ident_err</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MID_RED_T</span> <span class="o">|</span> <span class="n">MID_RED_CRC_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">descr</span> <span class="o">&amp;</span> <span class="n">MID_RED_T</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;empty cell (descr=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">descr</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): trashing empty cell</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">silence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">silence</span><span class="p">)</span> <span class="o">||</span> <span class="n">silence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): &quot;</span>
				    <span class="s">&quot;discarding PDU(s) with CRC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
				<span class="n">silence</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">HZ</span><span class="p">)</span><span class="o">|</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">descr</span> <span class="o">&amp;</span> <span class="n">MID_RED_COUNT</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ATM_CELL_PAYLOAD</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;CRC error (descr=0x%lx,size=%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">descr</span><span class="p">,</span>
			    <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">eff</span> <span class="o">=</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">descr</span> <span class="o">&amp;</span> <span class="n">MID_RED_COUNT</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ATM_CELL_PAYLOAD</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;size=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="o">+</span><span class="p">(((</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="o">+</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">)))</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
				<span class="cm">/* -trailer(2)+header(1) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">length</span> <span class="o">&lt;=</span>
		  <span class="n">ATM_MAX_AAL5_PDU</span><span class="p">)</span> <span class="n">eff</span> <span class="o">=</span> <span class="p">(</span><span class="n">length</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>				 <span class="cm">/* ^ trailer length (8) */</span>
			<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;bad PDU (descr=0x08%lx,length=%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">descr</span><span class="p">,</span>
			    <span class="n">length</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): bad AAL5 PDU &quot;</span>
			    <span class="s">&quot;(VCI=%d,length=%ld,size=%ld (descr 0x%lx))</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span><span class="n">length</span><span class="p">,</span><span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span><span class="n">descr</span><span class="p">);</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">eff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">eff</span> <span class="o">?</span> <span class="n">atm_alloc_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">eff</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span><span class="n">GFP_ATOMIC</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">discard</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;got len %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_rx_dma</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">skb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">eff</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">rx_vcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vci_dsc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>

	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">vci_dsc</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">+</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
	<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;rx_vcc(1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">vci_dsc</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MID_VCI_DESCR</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">MID_VCI_DESCR_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;rx_vcc(2: host dsc=0x%lx, nic dsc=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">,</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CB_DESCR %ld REG_DESCR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">,</span>
		    <span class="p">(((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">vci_dsc</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MID_VCI_DESCR</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		    <span class="n">MID_VCI_DESCR_SHIFT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">(</span><span class="n">vcc</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* clear IN_SERVICE flag */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">vci_dsc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MID_VCI_IN_SERVICE</span><span class="p">,</span><span class="n">vci_dsc</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If new data has arrived between evaluating the while condition and</span>
<span class="cm">	 * clearing IN_SERVICE, we wouldn&#39;t be notified until additional data</span>
<span class="cm">	 * follows. So we have to loop again to be sure.</span>
<span class="cm">	 */</span>
	<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;rx_vcc(3)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">descr</span> <span class="o">!=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">vci_dsc</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MID_VCI_DESCR</span><span class="p">)</span>
	    <span class="o">&gt;&gt;</span> <span class="n">MID_VCI_DESCR_SHIFT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;rx_vcc(4: host dsc=0x%lx, nic dsc=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">,</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;CB_DESCR %ld REG_DESCR %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">,</span>
		    <span class="p">(((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">readl</span><span class="p">(</span><span class="n">vci_dsc</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MID_VCI_DESCR</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		    <span class="n">MID_VCI_DESCR_SHIFT</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">(</span><span class="n">vcc</span><span class="p">))</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">poll_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>

	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">curr</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;poll_rx.fast</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_vcc</span><span class="p">(</span><span class="n">curr</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ENI_VCC_NOS</span><span class="p">;</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">servicing</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">curr</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">slow</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;poll_rx.slow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_vcc</span><span class="p">(</span><span class="n">curr</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">slow</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ENI_VCC_NOS</span><span class="p">;</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">curr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">servicing</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_service</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vci</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;get_service</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">eni_in</span><span class="p">(</span><span class="n">MID_SERV_WRITE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">serv_read</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vci</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">service</span><span class="o">+</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">serv_read</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">serv_read</span> <span class="o">=</span> <span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">serv_read</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NR_SERVICE</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">vcc</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span><span class="p">[</span><span class="n">vci</span> <span class="o">&amp;</span> <span class="mi">1023</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): VCI %ld not &quot;</span>
			    <span class="s">&quot;found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">vci</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* nasty but we try to go on anyway */</span>
			<span class="cm">/* @@@ nope, doesn&#39;t work */</span>
		<span class="p">}</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;getting from service</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">ENI_VCC_NOS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;double service</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;Grr, servicing VCC %ld twice</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">vci</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">ktime_get_real</span><span class="p">();</span>
		<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">fast</span><span class="p">)</span>
				<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">last_fast</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="k">else</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">last_fast</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">slow</span><span class="p">)</span>
				<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">last_slow</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="k">else</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">slow</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
			<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">last_slow</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
		<span class="p">}</span>
<span class="n">putting</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">servicing</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dequeue_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vci_dsc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span><span class="p">;</span>

	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): RX but not &quot;</span>
				    <span class="s">&quot;rxing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
				<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;nothing to dequeue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;dequeued (size=%ld,pos=0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ENI_PRV_SIZE</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
		    <span class="n">ENI_PRV_POS</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
<span class="n">rx_dequeued</span><span class="o">++</span><span class="p">;</span>
		<span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
		<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
		<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vci_dsc</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">+</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">EEPMOK</span><span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx_pos</span><span class="p">,</span><span class="n">ENI_PRV_SIZE</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
		    <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">vci_dsc</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MID_VCI_READ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">MID_VCI_READ_SHIFT</span><span class="p">,</span>
		    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;requeuing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="o">--</span><span class="p">;</span>
		<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx_pos</span> <span class="o">=</span> <span class="n">ENI_PRV_POS</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">ENI_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		    <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;pushing (len=%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span>
				    <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_skb_prv</span><span class="p">));</span>
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">pushed</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_wait</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_rx_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;open_rx_first</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="o">*</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_mult</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MID_MAX_BUF_SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">&lt;=</span>
	    <span class="n">MID_MAX_BUF_SIZE</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">MID_MAX_BUF_SIZE</span><span class="p">;</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span> <span class="o">=</span> <span class="n">eni_alloc_mem</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;rx at 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">);</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL5</span> <span class="o">?</span> <span class="n">rx_aal5</span> <span class="o">:</span> <span class="n">rx_aal0</span><span class="p">;</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">descr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rxing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">servicing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ENI_VCC_NOS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_rx_second</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">here</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">order</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;open_rx_second</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* set up VCI descriptor */</span>
	<span class="n">here</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">+</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;loc 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="o">-</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">size</span><span class="p">;</span> <span class="n">order</span><span class="o">++</span><span class="p">)</span> <span class="n">size</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">here</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span> <span class="cm">/* descr, read = 0 */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">here</span><span class="o">+</span><span class="mi">8</span><span class="p">);</span> <span class="cm">/* write, state, count = 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">])</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): BUG - VCI %d already &quot;</span>
		    <span class="s">&quot;in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span> <span class="cm">/* now it counts */</span>
	<span class="n">writel</span><span class="p">(((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span> <span class="o">?</span> <span class="n">MID_MODE_RAW</span> <span class="o">:</span> <span class="n">MID_MODE_AAL5</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
	    <span class="n">MID_VCI_MODE_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="n">MID_VCI_PTI_MODE</span> <span class="o">|</span>
	    <span class="p">(((</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="o">-</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">MID_LOC_SKIP</span><span class="o">+</span><span class="mi">2</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
	    <span class="n">MID_VCI_LOCATION_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">order</span> <span class="o">&lt;&lt;</span> <span class="n">MID_VCI_SIZE_SHIFT</span><span class="p">),</span><span class="n">here</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span><span class="n">current</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">here</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>

	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">!=</span> <span class="n">ATM_VPI_UNSPEC</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">!=</span> <span class="n">ATM_VCI_UNSPEC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">here</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">+</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
		<span class="cm">/* block receiver */</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MID_VCI_MODE</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MID_MODE_TRASH</span> <span class="o">&lt;&lt;</span>
		    <span class="n">MID_VCI_MODE_SHIFT</span><span class="p">),</span><span class="n">here</span><span class="p">);</span>
		<span class="cm">/* wait for receiver to become idle */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">27</span><span class="p">);</span>
		<span class="cm">/* discard pending cell */</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">here</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">MID_VCI_IN_SERVICE</span><span class="p">,</span><span class="n">here</span><span class="p">);</span>
		<span class="cm">/* don&#39;t accept any new ones */</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="cm">/* wait for RX queue to drain */</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eni_close: waiting for RX ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;RX closing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_wait</span><span class="p">,</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">barrier</span><span class="p">();</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="cm">/* transition service-&gt;rx: rxing++, servicing-- */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">servicing</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">barrier</span><span class="p">();</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;drain PDUs (rx %ld, serv %ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="p">,</span>
			    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">servicing</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%d+%d RX left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">servicing</span><span class="p">,</span>
			    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">at_end</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

			<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">+</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="o">*</span><span class="mi">16</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MID_VCI_READ</span><span class="p">;</span>
			<span class="n">at_end</span> <span class="o">=</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx_pos</span> <span class="o">==</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="n">MID_VCI_READ_SHIFT</span><span class="p">;</span>
			<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">at_end</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;drain discard (host 0x%lx, nic 0x%lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx_pos</span><span class="p">,</span><span class="n">tmp</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;draining RX: host 0x%lx, nic 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx_pos</span><span class="p">,</span><span class="n">tmp</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
		<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_wait</span><span class="p">,</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">eni_free_mem</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>

	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">**</span><span class="p">)</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): couldn&#39;t get free page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">free_page</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_mult</span> <span class="o">=</span> <span class="n">DEFAULT_RX_MULT</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">fast</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">last_fast</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">slow</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">last_slow</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_wait</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_queue</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">serv_read</span> <span class="o">=</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_SERV_WRITE</span><span class="p">);</span>
	<span class="n">eni_out</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">MID_DMA_WR_RX</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*----------------------------------- TX ------------------------------------*/</span>


<span class="k">enum</span> <span class="n">enq_res</span> <span class="p">{</span> <span class="n">enq_ok</span><span class="p">,</span><span class="n">enq_next</span><span class="p">,</span><span class="n">enq_jam</span> <span class="p">};</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">put_dma</span><span class="p">(</span><span class="kt">int</span> <span class="n">chan</span><span class="p">,</span><span class="n">u32</span> <span class="o">*</span><span class="n">dma</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">j</span><span class="p">,</span><span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">,</span>
    <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">init</span><span class="p">,</span><span class="n">words</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;put_dma: 0x%lx+0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
	<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;put_dma: 0x%lx+0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"> /* don&#39;t complain anymore */</span>
<span class="c">	if (paddr &amp; 3)</span>
<span class="c">		printk(KERN_ERR &quot;put_dma: unaligned addr (0x%lx)\n&quot;,paddr);</span>
<span class="c">	if (size &amp; 3)</span>
<span class="c">		printk(KERN_ERR &quot;put_dma: unaligned size (0x%lx)\n&quot;,size);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init</span> <span class="o">=</span> <span class="mi">4</span><span class="o">-</span><span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init</span> <span class="o">&gt;</span> <span class="n">size</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="n">init</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;put_dma: %lx DMA: %d/%d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span><span class="n">init</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_BYTE</span> <span class="o">|</span> <span class="p">(</span><span class="n">init</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">paddr</span> <span class="o">+=</span> <span class="n">init</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">init</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">words</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">init</span> <span class="o">=</span> <span class="mi">8</span><span class="o">-</span><span class="p">((</span><span class="n">paddr</span> <span class="o">&amp;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init</span> <span class="o">&gt;</span> <span class="n">words</span><span class="p">)</span> <span class="n">init</span> <span class="o">=</span> <span class="n">words</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;put_dma: %lx DMA: %d/%d words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span><span class="n">init</span><span class="p">,</span><span class="n">words</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_WORD</span> <span class="o">|</span> <span class="p">(</span><span class="n">init</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">paddr</span> <span class="o">+=</span> <span class="n">init</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">words</span> <span class="o">-=</span> <span class="n">init</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_TX_16W </span><span class="cm">/* may work with some PCI chipsets ... */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;put_dma: %lx DMA: %d*16/%d words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span><span class="n">words</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_16W</span> <span class="o">|</span> <span class="p">((</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span>
		    <span class="o">|</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">paddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">words</span> <span class="o">&amp;=</span> <span class="mi">15</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_TX_8W </span><span class="cm">/* recommended */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;put_dma: %lx DMA: %d*8/%d words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span><span class="n">words</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_8W</span> <span class="o">|</span> <span class="p">((</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span>
		    <span class="o">|</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">paddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">words</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_TX_4W </span><span class="cm">/* probably useless if TX_8W or TX_16W */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;put_dma: %lx DMA: %d*4/%d words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span><span class="n">words</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_4W</span> <span class="o">|</span> <span class="p">((</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span>
		    <span class="o">|</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">paddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">words</span> <span class="o">&amp;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_TX_2W </span><span class="cm">/* probably useless if TX_4W, TX_8W, ... */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;put_dma: %lx DMA: %d*2/%d words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span><span class="n">words</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_2W</span> <span class="o">|</span> <span class="p">((</span><span class="n">words</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span>
		    <span class="o">|</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">paddr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">words</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">words</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">words</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;put_dma: %lx DMA: %d words</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span>
		    <span class="n">words</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_WORD</span> <span class="o">|</span> <span class="p">(</span><span class="n">words</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
		<span class="n">paddr</span> <span class="o">+=</span> <span class="n">words</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;put_dma: %lx DMA: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">paddr</span><span class="p">,</span>
		    <span class="n">size</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">MID_DT_BYTE</span> <span class="o">|</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">);</span>
		<span class="n">dma</span><span class="p">[(</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">enum</span> <span class="n">enq_res</span> <span class="nf">do_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_tx</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_rd</span><span class="p">,</span><span class="n">dma_wr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* in words */</span>
	<span class="kt">int</span> <span class="n">aal5</span><span class="p">,</span><span class="n">dma_size</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;do_tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">NULLCHECK</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;do_tx: skb=0x%lx, %ld bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
	<span class="n">NULLCHECK</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">NULLCHECK</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">);</span>
	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">NULLCHECK</span><span class="p">(</span><span class="n">tx</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"> /* Enable this for testing with the &quot;align&quot; program */</span>
<span class="c">	{</span>
<span class="c">		unsigned int hack = *((char *) skb-&gt;data)-&#39;0&#39;;</span>

<span class="c">		if (hack &lt; 8) {</span>
<span class="c">			skb-&gt;data += hack;</span>
<span class="c">			skb-&gt;len -= hack;</span>
<span class="c">		}</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c"> /* should work now */</span>
<span class="c">	if ((unsigned long) skb-&gt;data &amp; 3)</span>
<span class="c">		printk(KERN_ERR DEV_LABEL &quot;(itf %d): VCI %d has mis-aligned &quot;</span>
<span class="c">		    &quot;TX data\n&quot;,vcc-&gt;dev-&gt;number,vcc-&gt;vci);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * Potential future IP speedup: make hard_header big enough to put</span>
<span class="cm">	 * segmentation descriptor directly into PDU. Saves: 4 slave writes,</span>
<span class="cm">	 * 1 DMA xfer &amp; 2 DMA&#39;ed bytes (protocol layering is for wimps :-)</span>
<span class="cm">	 */</span>

	<span class="n">aal5</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL5</span><span class="p">;</span>
	<span class="cm">/* check space in buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aal5</span><span class="p">)</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">ATM_CELL_PAYLOAD</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">TX_DESCR_SIZE</span><span class="p">;</span>
			<span class="cm">/* cell without HEC plus segmentation header (includes</span>
<span class="cm">			   four-byte cell header) */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">AAL5_TRAILER</span><span class="o">+</span><span class="n">ATM_CELL_PAYLOAD</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* add AAL5 trailer */</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">size</span><span class="o">-</span><span class="p">(</span><span class="n">size</span> <span class="o">%</span> <span class="n">ATM_CELL_PAYLOAD</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">TX_DESCR_SIZE</span><span class="p">;</span>
						<span class="cm">/* add segmentation header */</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Can I move tx_pos by size bytes without getting closer than TX_GAP</span>
<span class="cm">	 * to the read pointer ? TX_GAP means to leave some space for what</span>
<span class="cm">	 * the manual calls &quot;too close&quot;.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">NEPMOK</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="p">,</span><span class="n">size</span><span class="o">+</span><span class="n">TX_GAP</span><span class="p">,</span>
	    <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_TX_RDPTR</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)),</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): TX full (size %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">enq_next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* check DMA */</span>
	<span class="n">dma_wr</span> <span class="o">=</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_DMA_WR_TX</span><span class="p">);</span>
	<span class="n">dma_rd</span> <span class="o">=</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_DMA_RD_TX</span><span class="p">);</span>
	<span class="n">dma_size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* JK for descriptor and final fill, plus final size</span>
<span class="cm">			 mis-alignment fix */</span>
<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;iovcnt = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span> <span class="n">dma_size</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="n">dma_size</span> <span class="o">+=</span> <span class="mi">5</span><span class="o">*</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_size</span> <span class="o">&gt;</span> <span class="n">TX_DMA_BUF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): needs %d DMA entries &quot;</span>
		    <span class="s">&quot;(got only %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">dma_size</span><span class="p">,</span><span class="n">TX_DMA_BUF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;dma_wr is %d, tx_pos is %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dma_wr</span><span class="p">,</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_wr</span> <span class="o">!=</span> <span class="n">dma_rd</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">dma_rd</span><span class="o">+</span><span class="n">NR_DMA_TX</span><span class="o">-</span><span class="n">dma_wr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NR_DMA_TX</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;</span>
	     <span class="n">dma_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): TX DMA full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">enq_jam</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">paddr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
	    <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">ENI_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">paddr</span><span class="p">;</span>
	<span class="cm">/* prepare DMA queue entries */</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="o">+</span><span class="n">TX_DESCR_SIZE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
	     <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	     <span class="n">MID_DT_JK</span><span class="p">;</span>
	<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aal5</span><span class="p">)</span> <span class="n">put_dma</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span><span class="o">&amp;</span><span class="n">j</span><span class="p">,</span><span class="n">paddr</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">else</span> <span class="n">put_dma</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span><span class="o">&amp;</span><span class="n">j</span><span class="p">,</span><span class="n">paddr</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">-</span><span class="mi">4</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;doing direct send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> <span class="cm">/* @@@ well, this doesn&#39;t work anyway */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">put_dma</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span><span class="o">&amp;</span><span class="n">j</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
				    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				    <span class="n">skb_headlen</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">put_dma</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span><span class="o">&amp;</span><span class="n">j</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span>
				    <span class="n">skb_frag_page</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span>
					<span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page_offset</span><span class="p">,</span>
				    <span class="n">skb_frag_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">frags</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">put_dma</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">j</span><span class="p">,</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span>
			<span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* JK for AAL5 trailer - AAL0 doesn&#39;t need it, but who cares ... */</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(((</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="o">+</span><span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span>
	     <span class="n">MID_DMA_COUNT_SHIFT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&lt;&lt;</span> <span class="n">MID_DMA_CHAN_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	     <span class="n">MID_DMA_END</span> <span class="o">|</span> <span class="n">MID_DT_JK</span><span class="p">;</span>
	<span class="n">j</span><span class="o">++</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;DMA at end: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">j</span><span class="p">);</span>
	<span class="cm">/* store frame */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">MID_SEG_TX_ID</span> <span class="o">&lt;&lt;</span> <span class="n">MID_SEG_ID_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">aal5</span> <span class="o">?</span> <span class="n">MID_SEG_AAL5</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">prescaler</span> <span class="o">&lt;&lt;</span> <span class="n">MID_SEG_PR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">&lt;&lt;</span> <span class="n">MID_SEG_RATE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">size</span><span class="o">/</span><span class="p">(</span><span class="n">ATM_CELL_PAYLOAD</span><span class="o">/</span><span class="mi">4</span><span class="p">)),</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span><span class="o">+</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
<span class="cm">/*printk(&quot;dsc = 0x%08lx\n&quot;,(unsigned long) readl(tx-&gt;send+tx-&gt;tx_pos*4));*/</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="n">MID_SEG_VCI_SHIFT</span><span class="p">)</span> <span class="o">|</span>
            <span class="p">(</span><span class="n">aal5</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">atm_options</span> <span class="o">&amp;</span> <span class="n">ATM_ATMOPT_CLP</span> <span class="o">?</span> <span class="n">MID_SEG_CLP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
	    <span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span><span class="o">+</span><span class="p">((</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;size: %d, len:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aal5</span><span class="p">)</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span><span class="o">+</span>
                    <span class="p">((</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="o">+</span><span class="n">size</span><span class="o">-</span><span class="n">AAL5_TRAILER</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">],</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="o">+</span><span class="n">dma_wr</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="o">+</span><span class="n">dma_wr</span><span class="o">*</span><span class="mi">8</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">dma_wr</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_wr</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NR_DMA_TX</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ENI_PRV_POS</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="p">;</span>
	<span class="n">ENI_PRV_SIZE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">txing</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="o">+</span><span class="n">size</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;dma_wr set to %d, tx_pos is now %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dma_wr</span><span class="p">,</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span><span class="p">);</span>
	<span class="n">eni_out</span><span class="p">(</span><span class="n">dma_wr</span><span class="p">,</span><span class="n">MID_DMA_WR_TX</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
<span class="n">queued</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">enq_ok</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">poll_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_tx</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">enq_res</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;poll_tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">NR_CHAN</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">)</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">do_tx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">enq_ok</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
				<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;re-queuing TX PDU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
<span class="n">requeued</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">enq_jam</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">dequeue_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_tx</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>

	<span class="n">NULLCHECK</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">NULLCHECK</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
		<span class="n">NULLCHECK</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
		<span class="n">NULLCHECK</span><span class="p">(</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;dequeue_tx: next 0x%lx curr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ENI_PRV_POS</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
		    <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_TX_DESCRSTART</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">txing</span> <span class="o">&lt;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span> <span class="o">&amp;&amp;</span> <span class="n">ENI_PRV_POS</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_TX_DESCRSTART</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">txing</span> <span class="o">-=</span> <span class="n">ENI_PRV_SIZE</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">ENI_PRV_PADDR</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		    <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span> <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">);</span>
<span class="n">dma_complete</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">eni_tx</span> <span class="o">*</span><span class="nf">alloc_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">,</span><span class="kt">int</span> <span class="n">ubr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">!</span><span class="n">ubr</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send</span><span class="p">)</span> <span class="k">return</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">comp_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">pcr</span><span class="p">,</span><span class="kt">int</span> <span class="n">reserved</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">pre</span><span class="p">,</span>
    <span class="kt">int</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span><span class="kt">int</span> <span class="n">unlimited</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pre_div</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">2048</span> <span class="p">};</span>
	    <span class="cm">/* 2^(((x+2)^2-(x+2))/2+1) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlimited</span><span class="p">)</span> <span class="o">*</span><span class="n">pre</span> <span class="o">=</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">div</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="o">*</span><span class="n">pre</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">pre</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">pre</span><span class="p">)</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">TS_CLOCK</span><span class="o">/</span><span class="n">pre_div</span><span class="p">[</span><span class="o">*</span><span class="n">pre</span><span class="p">]</span><span class="o">/</span><span class="mi">64</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">pcr</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="n">div</span> <span class="o">=</span> <span class="n">pre_div</span><span class="p">[</span><span class="o">*</span><span class="n">pre</span><span class="p">]</span><span class="o">**</span><span class="n">pcr</span><span class="p">;</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;min div %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">div</span><span class="p">);</span>
			<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">TS_CLOCK</span><span class="o">/</span><span class="n">div</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">div</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">pcr</span><span class="p">)</span> <span class="o">*</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_bw</span><span class="o">+</span><span class="n">reserved</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="o">*</span><span class="n">pre</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="o">*</span><span class="n">pre</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">pre</span><span class="p">)</span><span class="o">--</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">TS_CLOCK</span><span class="o">/</span><span class="n">pre_div</span><span class="p">[</span><span class="o">*</span><span class="n">pre</span><span class="p">]</span><span class="o">/</span><span class="mi">64</span> <span class="o">&gt;</span> <span class="o">-*</span><span class="n">pcr</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pre</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">pre</span><span class="p">)</span><span class="o">++</span><span class="p">;</span> <span class="cm">/* else fail later */</span>
			<span class="n">div</span> <span class="o">=</span> <span class="n">pre_div</span><span class="p">[</span><span class="o">*</span><span class="n">pre</span><span class="p">]</span><span class="o">*-*</span><span class="n">pcr</span><span class="p">;</span>
			<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;max div %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">div</span><span class="p">);</span>
			<span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">TS_CLOCK</span><span class="p">,</span> <span class="n">div</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">res</span> <span class="o">&gt;</span> <span class="n">MID_SEG_MAX_RATE</span><span class="p">)</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">MID_SEG_MAX_RATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">TS_CLOCK</span><span class="o">/</span><span class="n">pre_div</span><span class="p">[</span><span class="o">*</span><span class="n">pre</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="o">*</span><span class="n">res</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;out pcr: %d (%d:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">pcr</span><span class="p">,</span><span class="o">*</span><span class="n">pre</span><span class="p">,</span><span class="o">*</span><span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">reserve_or_set_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span><span class="k">struct</span> <span class="n">atm_trafprm</span> <span class="o">*</span><span class="n">txtp</span><span class="p">,</span>
    <span class="kt">int</span> <span class="n">set_rsv</span><span class="p">,</span><span class="kt">int</span> <span class="n">set_shp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">eni_tx</span> <span class="o">*</span><span class="n">tx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">,</span><span class="n">ubr</span><span class="p">,</span><span class="n">unlimited</span><span class="p">,</span><span class="n">new_tx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pre</span><span class="p">,</span><span class="n">res</span><span class="p">,</span><span class="n">order</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">atm_pcr_goal</span><span class="p">(</span><span class="n">txtp</span><span class="p">);</span>
	<span class="n">ubr</span> <span class="o">=</span> <span class="n">txtp</span><span class="o">-&gt;</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_UBR</span><span class="p">;</span>
	<span class="n">unlimited</span> <span class="o">=</span> <span class="n">ubr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">rate</span> <span class="o">||</span> <span class="n">rate</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">ATM_OC3_PCR</span> <span class="o">||</span>
	    <span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">ATM_OC3_PCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">unlimited</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">txtp</span><span class="o">-&gt;</span><span class="n">max_sdu</span><span class="o">*</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_mult</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MID_MAX_BUF_SIZE</span> <span class="o">&amp;&amp;</span> <span class="n">txtp</span><span class="o">-&gt;</span><span class="n">max_sdu</span> <span class="o">&lt;=</span>
		    <span class="n">MID_MAX_BUF_SIZE</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">MID_MAX_BUF_SIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ubr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ubr</span><span class="p">;</span>
			<span class="n">txtp</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">UBR_BUFFER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">new_tx</span> <span class="o">=</span> <span class="o">!</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* for gcc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_tx</span><span class="p">)</span> <span class="n">tx</span> <span class="o">=</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">eni_alloc_mem</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="n">tx</span> <span class="o">=</span> <span class="n">alloc_tx</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="n">unlimited</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eni_free_mem</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="n">mem</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;got chan %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">shaping</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">order</span><span class="o">+</span><span class="mi">10</span><span class="p">));</span> <span class="n">order</span><span class="o">++</span><span class="p">);</span>
		<span class="n">eni_out</span><span class="p">((</span><span class="n">order</span> <span class="o">&lt;&lt;</span> <span class="n">MID_SIZE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span><span class="o">-</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">MID_LOC_SKIP</span><span class="o">+</span><span class="mi">2</span><span class="p">)),</span>
		    <span class="n">MID_TX_PLACE</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">));</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">tx_pos</span> <span class="o">=</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_TX_DESCRSTART</span><span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span> <span class="o">&amp;</span>
		    <span class="n">MID_DESCR_START</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">comp_tx</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">rate</span><span class="p">,</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pre</span><span class="p">,</span><span class="o">&amp;</span><span class="n">res</span><span class="p">,</span><span class="n">unlimited</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span>  <span class="o">&amp;&amp;</span> <span class="n">txtp</span><span class="o">-&gt;</span><span class="n">min_pcr</span> <span class="o">&gt;</span> <span class="n">rate</span><span class="p">)</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">txtp</span><span class="o">-&gt;</span><span class="n">max_pcr</span> <span class="o">&amp;&amp;</span> <span class="n">txtp</span><span class="o">-&gt;</span><span class="n">max_pcr</span> <span class="o">!=</span> <span class="n">ATM_MAX_PCR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">txtp</span><span class="o">-&gt;</span><span class="n">max_pcr</span> <span class="o">&lt;</span> <span class="n">rate</span><span class="p">)</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ubr</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_bw</span><span class="o">+</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="n">set_rsv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">set_shp</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">shaping</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">set_rsv</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ubr</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">eni_free_mem</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="n">mem</span><span class="p">,</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">txtp</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_rsv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ubr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_bw</span> <span class="o">+=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">;</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_bw</span> <span class="o">-=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_shp</span> <span class="o">||</span> <span class="p">(</span><span class="n">unlimited</span> <span class="o">&amp;&amp;</span> <span class="n">new_tx</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlimited</span> <span class="o">&amp;&amp;</span> <span class="n">new_tx</span><span class="p">)</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ubr</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">prescaler</span> <span class="o">=</span> <span class="n">pre</span><span class="p">;</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="n">tx</span><span class="o">-&gt;</span><span class="n">shaping</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_shp</span><span class="p">)</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;rsv %d shp %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">shaping</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_tx_first</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">txing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">reserve_or_set_tx</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_tx_second</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* nothing to do */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">close_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span><span class="n">current</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>

	<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* wait for TX queue to drain */</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eni_close: waiting for TX ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">,</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">txing</span><span class="p">;</span>

		<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
		<span class="n">txing</span> <span class="o">=</span> <span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">)</span> <span class="o">||</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">txing</span><span class="p">;</span>
		<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">txing</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;%d TX left</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">txing</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">,</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">!=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ubr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Looping a few times in here is probably far cheaper than</span>
<span class="cm">		 * keeping track of TX completions all the time, so let&#39;s poll</span>
<span class="cm">		 * a bit ...</span>
<span class="cm">		 */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">eni_in</span><span class="p">(</span><span class="n">MID_TX_RDPTR</span><span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span> <span class="o">!=</span>
		    <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_TX_DESCRSTART</span><span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)))</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="n">eni_free_mem</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_bw</span> <span class="o">+=</span> <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_bw</span> <span class="o">=</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_mult</span> <span class="o">=</span> <span class="n">DEFAULT_TX_MULT</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ubr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>
	<span class="n">eni_out</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">MID_DMA_WR_TX</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">send</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*--------------------------------- common ----------------------------------*/</span>


<span class="cp">#if 0</span><span class="c"> /* may become useful again when tuning things */</span>

<span class="c">static void foo(void)</span>
<span class="c">{</span>
<span class="c">printk(KERN_INFO</span>
<span class="c">  &quot;tx_complete=%d,dma_complete=%d,queued=%d,requeued=%d,sub=%d,\n&quot;</span>
<span class="c">  &quot;backlogged=%d,rx_enqueued=%d,rx_dequeued=%d,putting=%d,pushed=%d\n&quot;,</span>
<span class="c">  tx_complete,dma_complete,queued,requeued,submitted,backlogged,</span>
<span class="c">  rx_enqueued,rx_dequeued,putting,pushed);</span>
<span class="c">if (eni_boards) printk(KERN_INFO &quot;loss: %ld\n&quot;,ENI_DEV(eni_boards)-&gt;lost);</span>
<span class="c">}</span>

<span class="cp">#endif</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">bug_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;bug_int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MID_DMA_ERR_ACK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): driver error - DMA &quot;</span>
		    <span class="s">&quot;error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MID_TX_IDENT_MISM</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): driver error - ident &quot;</span>
		    <span class="s">&quot;mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MID_TX_DMA_OVFL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): driver error - DMA &quot;</span>
		    <span class="s">&quot;overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;---dump ends here---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;---recent events---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">event_dump</span><span class="p">();</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">eni_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reason</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;eni_int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">reason</span> <span class="o">=</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_ISA</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;: int 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">reason</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Must handle these two right now, because reading ISA doesn&#39;t clear</span>
<span class="cm">	 * them, so they re-occur and we never make it to the tasklet. Since</span>
<span class="cm">	 * they&#39;re rare, we don&#39;t mind the occasional invocation of eni_tasklet</span>
<span class="cm">	 * with eni_dev-&gt;events == 0.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MID_STAT_OVFL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;stat overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">lost</span> <span class="o">+=</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MID_OVFL_TRASH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">MID_SUNI_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;SUNI int</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		foo();</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">eni_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">events</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eni_tasklet (dev %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">events</span> <span class="o">=</span> <span class="n">xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">MID_RX_DMA_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;INT: RX DMA complete, starting dequeue_rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">dequeue_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;dequeue_rx done, starting poll_rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">poll_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;poll_rx done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* poll_tx ? */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">MID_SERVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;INT: service, starting get_service</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">get_service</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;get_service done, starting poll_rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">poll_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;poll_rx done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">MID_TX_DMA_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;INT: TX DMA COMPLETE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">dequeue_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">MID_TX_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;INT: TX COMPLETE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="n">tx_complete</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_wait</span><span class="p">);</span>
		<span class="cm">/* poll_rx ? */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MID_DMA_ERR_ACK</span> <span class="o">|</span> <span class="n">MID_TX_IDENT_MISM</span> <span class="o">|</span> <span class="n">MID_TX_DMA_OVFL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;bug interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">bug_int</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">events</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">poll_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*--------------------------------- entries ---------------------------------*/</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">media_name</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;MMF&quot;</span><span class="p">,</span> <span class="s">&quot;SMF&quot;</span><span class="p">,</span> <span class="s">&quot;MMF&quot;</span><span class="p">,</span> <span class="s">&quot;03?&quot;</span><span class="p">,</span> <span class="cm">/*  0- 3 */</span>
    <span class="s">&quot;UTP&quot;</span><span class="p">,</span> <span class="s">&quot;05?&quot;</span><span class="p">,</span> <span class="s">&quot;06?&quot;</span><span class="p">,</span> <span class="s">&quot;07?&quot;</span><span class="p">,</span> <span class="cm">/*  4- 7 */</span>
    <span class="s">&quot;TAXI&quot;</span><span class="p">,</span><span class="s">&quot;09?&quot;</span><span class="p">,</span> <span class="s">&quot;10?&quot;</span><span class="p">,</span> <span class="s">&quot;11?&quot;</span><span class="p">,</span> <span class="cm">/*  8-11 */</span>
    <span class="s">&quot;12?&quot;</span><span class="p">,</span> <span class="s">&quot;13?&quot;</span><span class="p">,</span> <span class="s">&quot;14?&quot;</span><span class="p">,</span> <span class="s">&quot;15?&quot;</span><span class="p">,</span> <span class="cm">/* 12-15 */</span>
    <span class="s">&quot;MMF&quot;</span><span class="p">,</span> <span class="s">&quot;SMF&quot;</span><span class="p">,</span> <span class="s">&quot;18?&quot;</span><span class="p">,</span> <span class="s">&quot;19?&quot;</span><span class="p">,</span> <span class="cm">/* 16-19 */</span>
    <span class="s">&quot;UTP&quot;</span><span class="p">,</span> <span class="s">&quot;21?&quot;</span><span class="p">,</span> <span class="s">&quot;22?&quot;</span><span class="p">,</span> <span class="s">&quot;23?&quot;</span><span class="p">,</span> <span class="cm">/* 20-23 */</span>
    <span class="s">&quot;24?&quot;</span><span class="p">,</span> <span class="s">&quot;25?&quot;</span><span class="p">,</span> <span class="s">&quot;26?&quot;</span><span class="p">,</span> <span class="s">&quot;27?&quot;</span><span class="p">,</span> <span class="cm">/* 24-27 */</span>
    <span class="s">&quot;28?&quot;</span><span class="p">,</span> <span class="s">&quot;29?&quot;</span><span class="p">,</span> <span class="s">&quot;30?&quot;</span><span class="p">,</span> <span class="s">&quot;31?&quot;</span>  <span class="cm">/* 28-31 */</span>
<span class="p">};</span>


<span class="cp">#define SET_SEPROM \</span>
<span class="cp">  ({ if (!error &amp;&amp; !pci_error) { \</span>
<span class="cp">    pci_error = pci_write_config_byte(eni_dev-&gt;pci_dev,PCI_TONGA_CTRL,tonga); \</span>
<span class="cp">    udelay(10); </span><span class="cm">/* 10 usecs */</span><span class="cp"> \</span>
<span class="cp">  } })</span>
<span class="cp">#define GET_SEPROM \</span>
<span class="cp">  ({ if (!error &amp;&amp; !pci_error) { \</span>
<span class="cp">    pci_error = pci_read_config_byte(eni_dev-&gt;pci_dev,PCI_TONGA_CTRL,&amp;tonga); \</span>
<span class="cp">    udelay(10); </span><span class="cm">/* 10 usecs */</span><span class="cp"> \</span>
<span class="cp">  } })</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">get_esi_asic</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tonga</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span><span class="n">failed</span><span class="p">,</span><span class="n">pci_error</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">address</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>

	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tonga</span> <span class="o">=</span> <span class="n">SEPROM_MAGIC</span> <span class="o">|</span> <span class="n">SEPROM_DATA</span> <span class="o">|</span> <span class="n">SEPROM_CLK</span><span class="p">;</span>
	<span class="n">SET_SEPROM</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESI_LEN</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pci_error</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start operation */</span>
		<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_DATA</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_CLK</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="n">tonga</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEPROM_DATA</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="n">tonga</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEPROM_CLK</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="cm">/* send address */</span>
		<span class="n">address</span> <span class="o">=</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="n">SEPROM_ESI_BASE</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tonga</span> <span class="o">=</span> <span class="p">(</span><span class="n">address</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">tonga</span> <span class="o">|</span> <span class="n">SEPROM_DATA</span> <span class="o">:</span>
			    <span class="n">tonga</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SEPROM_DATA</span><span class="p">;</span>
			<span class="n">SET_SEPROM</span><span class="p">;</span>
			<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_CLK</span><span class="p">;</span>
			<span class="n">SET_SEPROM</span><span class="p">;</span>
			<span class="n">tonga</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEPROM_CLK</span><span class="p">;</span>
			<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* get ack */</span>
		<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_DATA</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_CLK</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="n">GET_SEPROM</span><span class="p">;</span>
		<span class="n">failed</span> <span class="o">=</span> <span class="n">tonga</span> <span class="o">&amp;</span> <span class="n">SEPROM_DATA</span><span class="p">;</span>
		<span class="n">tonga</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEPROM_CLK</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_DATA</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">failed</span><span class="p">)</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_DATA</span><span class="p">;</span>
				<span class="n">SET_SEPROM</span><span class="p">;</span>
				<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_CLK</span><span class="p">;</span>
				<span class="n">SET_SEPROM</span><span class="p">;</span>
				<span class="n">GET_SEPROM</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tonga</span> <span class="o">&amp;</span> <span class="n">SEPROM_DATA</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">tonga</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEPROM_CLK</span><span class="p">;</span>
				<span class="n">SET_SEPROM</span><span class="p">;</span>
				<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_DATA</span><span class="p">;</span>
				<span class="n">SET_SEPROM</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* get ack */</span>
			<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_DATA</span><span class="p">;</span>
			<span class="n">SET_SEPROM</span><span class="p">;</span>
			<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_CLK</span><span class="p">;</span>
			<span class="n">SET_SEPROM</span><span class="p">;</span>
			<span class="n">GET_SEPROM</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tonga</span> <span class="o">&amp;</span> <span class="n">SEPROM_DATA</span><span class="p">))</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">tonga</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEPROM_CLK</span><span class="p">;</span>
			<span class="n">SET_SEPROM</span><span class="p">;</span>
			<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_DATA</span><span class="p">;</span>
			<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* stop operation */</span>
		<span class="n">tonga</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SEPROM_DATA</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_CLK</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
		<span class="n">tonga</span> <span class="o">|=</span> <span class="n">SEPROM_DATA</span><span class="p">;</span>
		<span class="n">SET_SEPROM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): error reading ESI &quot;</span>
		    <span class="s">&quot;(0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">pci_error</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#undef SET_SEPROM</span>
<span class="cp">#undef GET_SEPROM</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">get_esi_fpga</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mac_base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mac_base</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="n">EPROM_SIZE</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">midway_eprom</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESI_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="n">mac_base</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">^</span><span class="mi">3</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">eni_do_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">midway_eprom</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">eprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">real_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">last</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;eni_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="n">NR_VCI_LD</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">link_rate</span> <span class="o">=</span> <span class="n">ATM_OC3_PCR</span><span class="p">;</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_dev</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">real_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">PCI_COMMAND</span><span class="p">,</span>
	    <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">asic</span> <span class="o">?</span> <span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): can&#39;t enable memory &quot;</span>
		    <span class="s">&quot;(0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): rev.%d,base=0x%lx,irq=%d,&quot;</span><span class="p">,</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span><span class="n">real_base</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">real_base</span><span class="p">,</span><span class="n">MAP_MAX_SIZE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): can&#39;t set up page &quot;</span>
		    <span class="s">&quot;mapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">base_diff</span> <span class="o">=</span> <span class="n">real_base</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">base</span><span class="p">;</span>
	<span class="cm">/* id may not be present in ASIC Tonga boards - check this @@@ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">asic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eprom</span> <span class="o">=</span> <span class="p">(</span><span class="n">base</span><span class="o">+</span><span class="n">EPROM_SIZE</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">midway_eprom</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eprom</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ENI155_MAGIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span>
			       <span class="s">&quot;(itf %d): bad magic - expected 0x%x, got 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ENI155_MAGIC</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">readl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eprom</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">));</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="n">PHY_BASE</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="n">REG_BASE</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span> <span class="o">=</span> <span class="n">base</span><span class="o">+</span><span class="n">RAM_BASE</span><span class="p">;</span>
	<span class="n">last</span> <span class="o">=</span> <span class="n">MAP_MAX_SIZE</span><span class="o">-</span><span class="n">RAM_BASE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">last</span><span class="o">-</span><span class="n">RAM_INCREMENT</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="n">RAM_INCREMENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x55555555</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55555555</span><span class="p">)</span> <span class="n">last</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">writel</span><span class="p">(</span><span class="mh">0xAAAAAAAA</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAAAAAAAA</span><span class="p">)</span> <span class="n">last</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">else</span> <span class="n">writel</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">last</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">RAM_INCREMENT</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
	<span class="cm">/* TODO: should shrink allocation now */</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;mem=%dkB (&quot;</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>
	<span class="cm">/* TODO: check for non-SUNI, check for TAXI ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">eni_in</span><span class="p">(</span><span class="n">MID_RES_ID_MCON</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span> <span class="o">!=</span> <span class="o">!</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">asic</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): ERROR - wrong id 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_RES_ID_MCON</span><span class="p">));</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">asic</span> <span class="o">?</span> <span class="n">get_esi_asic</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">:</span> <span class="n">get_esi_fpga</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESI_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s%02X&quot;</span><span class="p">,</span><span class="n">i</span> <span class="o">?</span> <span class="s">&quot;-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): %s,%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
	    <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_RES_ID_MCON</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x200</span> <span class="o">?</span> <span class="s">&quot;ASIC&quot;</span> <span class="o">:</span> <span class="s">&quot;FPGA&quot;</span><span class="p">,</span>
	    <span class="n">media_name</span><span class="p">[</span><span class="n">eni_in</span><span class="p">(</span><span class="n">MID_RES_ID_MCON</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">DAUGTHER_ID</span><span class="p">]);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">suni_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="nl">unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">base</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eni_do_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">ed</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">eni_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">buffer_mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;eni_start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="o">&amp;</span><span class="n">eni_int</span><span class="p">,</span><span class="n">IRQF_SHARED</span><span class="p">,</span><span class="n">DEV_LABEL</span><span class="p">,</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): IRQ%d is already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">PCI_COMMAND</span><span class="p">,</span>
	    <span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span> <span class="o">|</span>
	    <span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">asic</span> <span class="o">?</span> <span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): can&#39;t enable memory+&quot;</span>
		    <span class="s">&quot;master (0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span><span class="n">PCI_TONGA_CTRL</span><span class="p">,</span>
	    <span class="n">END_SWAP_DMA</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): can&#39;t set endian swap &quot;</span>
		    <span class="s">&quot;(0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* determine addresses of internal tables */</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_dma</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">NR_VCI</span><span class="o">*</span><span class="mi">16</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_dma</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="o">+</span><span class="n">NR_DMA_RX</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="o">+</span><span class="n">NR_DMA_TX</span><span class="o">*</span><span class="mi">8</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">service</span><span class="o">+</span><span class="n">NR_SERVICE</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;vci 0x%lx,rx 0x%lx, tx 0x%lx,srv 0x%lx,buf 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_dma</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_dma</span><span class="p">,</span>
	     <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">,</span><span class="n">eni_tasklet</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* initialize memory management */</span>
	<span class="n">buffer_mem</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">-</span> <span class="p">(</span><span class="n">buf</span> <span class="o">-</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list_size</span> <span class="o">=</span> <span class="n">buffer_mem</span><span class="o">/</span><span class="n">MID_MIN_BUF_SIZE</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_free</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list_size</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): couldn&#39;t get free page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_irq</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">eni_put_free</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">buffer_mem</span><span class="p">);</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="o">*</span><span class="n">NR_VCI</span><span class="p">);</span> <span class="cm">/* clear VCI table */</span>
	<span class="cm">/*</span>
<span class="cm">	 * byte_addr  free (k)</span>
<span class="cm">	 * 0x00000000     512  VCI table</span>
<span class="cm">	 * 0x00004000	  496  RX DMA</span>
<span class="cm">	 * 0x00005000	  492  TX DMA</span>
<span class="cm">	 * 0x00006000	  488  service list</span>
<span class="cm">	 * 0x00007000	  484  buffers</span>
<span class="cm">	 * 0x00080000	    0  end (512kB)</span>
<span class="cm">	 */</span>
	<span class="n">eni_out</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="n">MID_IE</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">start_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">goto</span> <span class="n">free_list</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">start_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">goto</span> <span class="n">free_list</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">goto</span> <span class="n">free_list</span><span class="p">;</span>
	<span class="n">eni_out</span><span class="p">(</span><span class="n">eni_in</span><span class="p">(</span><span class="n">MID_MC_S</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">MID_INT_SEL_SHIFT</span><span class="p">)</span> <span class="o">|</span>
	    <span class="n">MID_TX_LOCK_MODE</span> <span class="o">|</span> <span class="n">MID_DMA_ENABLE</span> <span class="o">|</span> <span class="n">MID_TX_ENABLE</span> <span class="o">|</span> <span class="n">MID_RX_ENABLE</span><span class="p">,</span>
	    <span class="n">MID_MC_S</span><span class="p">);</span>
	    <span class="cm">/* Tonga uses SBus INTReq1 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">eni_in</span><span class="p">(</span><span class="n">MID_ISA</span><span class="p">);</span> <span class="cm">/* clear Midway interrupts */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">free_list:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="p">);</span>

<span class="nl">free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">eni_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;eni_close</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">close_rx</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">close_tx</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;eni_close: done waiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* deallocate memory */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">));</span>
	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/*foo();*/</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">eni_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">vpi</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vci</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;eni_open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">EVENT</span><span class="p">(</span><span class="s">&quot;eni_open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vci</span> <span class="o">!=</span> <span class="n">ATM_VPI_UNSPEC</span> <span class="o">&amp;&amp;</span> <span class="n">vpi</span> <span class="o">!=</span> <span class="n">ATM_VCI_UNSPEC</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL0</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">DPRINTK</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): open %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span>
	    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_vcc</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_vcc</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">eni_vcc</span><span class="p">;</span>
		<span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* for eni_close after open_rx */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">open_rx_first</span><span class="p">(</span><span class="n">vcc</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">eni_close</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">open_tx_first</span><span class="p">(</span><span class="n">vcc</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">eni_close</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vci</span> <span class="o">==</span> <span class="n">ATM_VPI_UNSPEC</span> <span class="o">||</span> <span class="n">vpi</span> <span class="o">==</span> <span class="n">ATM_VCI_UNSPEC</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">open_rx_second</span><span class="p">(</span><span class="n">vcc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">eni_close</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">open_tx_second</span><span class="p">(</span><span class="n">vcc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">eni_close</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* should power down SUNI while !ref_count @@@ */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">eni_change_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span><span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span><span class="kt">int</span> <span class="n">flgs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">eni_tx</span> <span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span><span class="n">rate</span><span class="p">,</span><span class="n">rsv</span><span class="p">,</span><span class="n">shp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tx</span> <span class="o">==</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ubr</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EBADFD</span><span class="p">;</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">atm_pcr_goal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">rate</span> <span class="o">=</span> <span class="o">-</span><span class="n">rate</span><span class="p">;</span>
	<span class="n">rsv</span> <span class="o">=</span> <span class="n">shp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flgs</span> <span class="o">&amp;</span> <span class="n">ATM_MF_DEC_RSV</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">)</span> <span class="n">rsv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flgs</span> <span class="o">&amp;</span> <span class="n">ATM_MF_INC_RSV</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">rate</span> <span class="o">||</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">))</span> <span class="n">rsv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flgs</span> <span class="o">&amp;</span> <span class="n">ATM_MF_DEC_SHP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">shaping</span><span class="p">)</span> <span class="n">shp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flgs</span> <span class="o">&amp;</span> <span class="n">ATM_MF_INC_SHP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">rate</span> <span class="o">||</span> <span class="n">rate</span> <span class="o">&gt;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">shaping</span><span class="p">))</span> <span class="n">shp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsv</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">shp</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">reserve_or_set_tx</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">qos</span><span class="o">-&gt;</span><span class="n">txtp</span><span class="p">,</span><span class="n">rsv</span><span class="p">,</span><span class="n">shp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">shp</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">flgs</span> <span class="o">&amp;</span> <span class="n">ATM_MF_IMMED</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Walk through the send buffer and patch the rate information in all</span>
<span class="cm">	 * segmentation buffer descriptors of this VCC.</span>
<span class="cm">	 */</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dsc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">!=</span> <span class="n">vcc</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">dsc</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span><span class="o">+</span><span class="n">ENI_PRV_POS</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">((</span><span class="n">readl</span><span class="p">(</span><span class="n">dsc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">MID_SEG_RATE</span> <span class="o">|</span> <span class="n">MID_SEG_PR</span><span class="p">))</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">prescaler</span> <span class="o">&lt;&lt;</span> <span class="n">MID_SEG_PR_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="o">&lt;&lt;</span> <span class="n">MID_SEG_RATE_SHIFT</span><span class="p">),</span> <span class="n">dsc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">eni_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ENI_MEMDUMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Please use /proc/atm/&quot;</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;:%d &quot;</span>
		    <span class="s">&quot;instead of obsolete ioctl ENI_MEMDUMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="n">dump</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ENI_SETMULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">eni_multipliers</span> <span class="n">mult</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mult</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_multipliers</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mult</span><span class="p">.</span><span class="n">tx</span> <span class="o">&amp;&amp;</span> <span class="n">mult</span><span class="p">.</span><span class="n">tx</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mult</span><span class="p">.</span><span class="n">rx</span> <span class="o">&amp;&amp;</span><span class="n">mult</span><span class="p">.</span><span class="n">rx</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">mult</span><span class="p">.</span><span class="n">tx</span> <span class="o">&gt;</span> <span class="mi">65536</span> <span class="o">||</span> <span class="n">mult</span><span class="p">.</span><span class="n">rx</span> <span class="o">&gt;</span> <span class="mi">65536</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mult</span><span class="p">.</span><span class="n">tx</span><span class="p">)</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_mult</span> <span class="o">=</span> <span class="n">mult</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mult</span><span class="p">.</span><span class="n">rx</span><span class="p">)</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_mult</span> <span class="o">=</span> <span class="n">mult</span><span class="p">.</span><span class="n">rx</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ATM_SETCIRANGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">atm_cirange</span> <span class="n">ci</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ci</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_cirange</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ci</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ci</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">==</span> <span class="n">ATM_CI_MAX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ci</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">==</span> <span class="n">NR_VCI_LD</span> <span class="o">||</span> <span class="n">ci</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">==</span> <span class="n">ATM_CI_MAX</span><span class="p">))</span>
		    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">cmd</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">eni_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span><span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
    <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span><span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">eni_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span><span class="kt">int</span> <span class="n">level</span><span class="p">,</span><span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>
    <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">eni_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">enq_res</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">DPRINTK</span><span class="p">(</span><span class="s">&quot;&gt;eni_send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span> <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;!skb in eni_send ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">==</span> <span class="n">ATM_AAL0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">ATM_CELL_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">else</span> <span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="n">submitted</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
	<span class="n">tasklet_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">do_tx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">tasklet_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="n">enq_ok</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>
<span class="n">backlogged</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ENI_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">task</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">eni_phy_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span><span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">+</span><span class="n">addr</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">eni_phy_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">+</span><span class="n">addr</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">eni_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hlist_node</span> <span class="o">*</span><span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">signal</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;LOST&quot;</span><span class="p">,</span><span class="s">&quot;unknown&quot;</span><span class="p">,</span><span class="s">&quot;okay&quot;</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span><span class="n">i</span><span class="p">;</span>

	<span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d) signal %s, %dkB, &quot;</span>
		    <span class="s">&quot;%d cps remaining</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">signal</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">],</span>
		    <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_bw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">left</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;%4sBursts: TX&quot;</span>
<span class="cp">#if !defined(CONFIG_ATM_ENI_BURST_TX_16W) &amp;&amp; \</span>
<span class="cp">    !defined(CONFIG_ATM_ENI_BURST_TX_8W) &amp;&amp; \</span>
<span class="cp">    !defined(CONFIG_ATM_ENI_BURST_TX_4W) &amp;&amp; \</span>
<span class="cp">    !defined(CONFIG_ATM_ENI_BURST_TX_2W)</span>
		    <span class="s">&quot; none&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_TX_16W</span>
		    <span class="s">&quot; 16W&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_TX_8W</span>
		    <span class="s">&quot; 8W&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_TX_4W</span>
		    <span class="s">&quot; 4W&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_TX_2W</span>
		    <span class="s">&quot; 2W&quot;</span>
<span class="cp">#endif</span>
		    <span class="s">&quot;, RX&quot;</span>
<span class="cp">#if !defined(CONFIG_ATM_ENI_BURST_RX_16W) &amp;&amp; \</span>
<span class="cp">    !defined(CONFIG_ATM_ENI_BURST_RX_8W) &amp;&amp; \</span>
<span class="cp">    !defined(CONFIG_ATM_ENI_BURST_RX_4W) &amp;&amp; \</span>
<span class="cp">    !defined(CONFIG_ATM_ENI_BURST_RX_2W)</span>
		    <span class="s">&quot; none&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_RX_16W</span>
		    <span class="s">&quot; 16W&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_RX_8W</span>
		    <span class="s">&quot; 8W&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_RX_4W</span>
		    <span class="s">&quot; 4W&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ATM_ENI_BURST_RX_2W</span>
		    <span class="s">&quot; 2W&quot;</span>
<span class="cp">#endif</span>
<span class="cp">#ifndef CONFIG_ATM_ENI_TUNE_BURST</span>
		    <span class="s">&quot; (default)&quot;</span>
<span class="cp">#endif</span>
		    <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">left</span><span class="p">)</span> 
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;%4sBuffer multipliers: tx %d%%, rx %d%%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx_mult</span><span class="p">,</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">rx_mult</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NR_CHAN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">eni_tx</span> <span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;tx[%d]:    0x%ld-0x%ld &quot;</span>
			    <span class="s">&quot;(%6ld bytes), rsv %d cps, shp %d cps%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span> <span class="o">-</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">),</span>
			    <span class="n">tx</span><span class="o">-&gt;</span><span class="n">send</span><span class="o">-</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">*</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
			    <span class="n">tx</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">shaping</span><span class="p">,</span>
			    <span class="n">tx</span> <span class="o">==</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ubr</span> <span class="o">?</span> <span class="s">&quot; (UBR)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">left</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;%10sbacklog %u packets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">backlog</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VCC_HTABLE_SIZE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hlist_head</span> <span class="o">*</span><span class="n">head</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vcc_hash</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">sk_for_each</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">eni_vcc</span> <span class="o">*</span><span class="n">eni_vcc</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

			<span class="n">vcc</span> <span class="o">=</span> <span class="n">atm_sk</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">eni_vcc</span> <span class="o">=</span> <span class="n">ENI_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">left</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;vcc %4d: &quot;</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">length</span><span class="p">,</span><span class="s">&quot;0x%ld-0x%ld &quot;</span>
				    <span class="s">&quot;(%6ld bytes)&quot;</span><span class="p">,</span>
				    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span> <span class="o">-</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">),</span>
				    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">recv</span><span class="o">-</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">*</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
				    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">words</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span> <span class="n">length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">length</span><span class="p">,</span><span class="s">&quot;, &quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">)</span>
				<span class="n">length</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="o">+</span><span class="n">length</span><span class="p">,</span><span class="s">&quot;tx[%d], txing %d bytes&quot;</span><span class="p">,</span>
				    <span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span><span class="n">eni_vcc</span><span class="o">-&gt;</span><span class="n">txing</span><span class="p">);</span>
			<span class="n">page</span><span class="p">[</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
			<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">length</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc_sklist_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">eni_free</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">free_list</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">left</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="o">+</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">base_diff</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span><span class="s">&quot;free      %p-%p (%6d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">fe</span><span class="o">-&gt;</span><span class="n">start</span><span class="o">-</span><span class="n">offset</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">start</span><span class="o">-</span><span class="n">offset</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		    <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">eni_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">eni_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">eni_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">getsockopt</span>	<span class="o">=</span> <span class="n">eni_getsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setsockopt</span>	<span class="o">=</span> <span class="n">eni_setsockopt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send</span>		<span class="o">=</span> <span class="n">eni_send</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_put</span>	<span class="o">=</span> <span class="n">eni_phy_put</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_get</span>	<span class="o">=</span> <span class="n">eni_phy_get</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_qos</span>	<span class="o">=</span> <span class="n">eni_change_qos</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_read</span>	<span class="o">=</span> <span class="n">eni_proc_read</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">eni_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">eni_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">eni_zero</span> <span class="o">*</span><span class="n">zero</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">eni_dev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eni_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_disable</span><span class="p">;</span>

	<span class="n">zero</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">;</span>
	<span class="n">zero</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">ENI_ZEROES_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zero</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_kfree</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">atm_dev_register</span><span class="p">(</span><span class="n">DEV_LABEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_consistent</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">eni_dev</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">asic</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">eni_do_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">eni_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_eni_release</span><span class="p">;</span>

	<span class="n">eni_dev</span><span class="o">-&gt;</span><span class="n">more</span> <span class="o">=</span> <span class="n">eni_boards</span><span class="p">;</span>
	<span class="n">eni_boards</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_eni_release:</span>
	<span class="n">eni_do_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_unregister:</span>
	<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_free_consistent:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">ENI_ZEROES_SIZE</span><span class="p">,</span> <span class="n">zero</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">zero</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
<span class="nl">err_kfree:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">eni_dev</span><span class="p">);</span>
<span class="nl">err_disable:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">eni_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EF</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EF_ATM_FPGA</span><span class="p">),</span> <span class="mi">0</span> <span class="cm">/* FPGA */</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">EF</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_EF_ATM_ASIC</span><span class="p">),</span> <span class="mi">1</span> <span class="cm">/* ASIC */</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span><span class="n">eni_pci_tbl</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">eni_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">eni_dev</span> <span class="o">*</span><span class="n">ed</span> <span class="o">=</span> <span class="n">ENI_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">eni_zero</span> <span class="o">*</span><span class="n">zero</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ed</span><span class="o">-&gt;</span><span class="n">zero</span><span class="p">;</span>

	<span class="n">eni_do_release</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ENI_ZEROES_SIZE</span><span class="p">,</span> <span class="n">zero</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">zero</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ed</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">eni_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DEV_LABEL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">eni_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">eni_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">eni_remove_one</span><span class="p">),</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">eni_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span> <span class="cm">/* dummy for sizeof */</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_skb_prv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;eni_detect: skb-&gt;cb is too small (%Zd &lt; %Zd)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">),</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eni_skb_prv</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">eni_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">eni_init</span><span class="p">);</span>
<span class="cm">/* @@@ since exit routine not defined, this module can not be unloaded */</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
