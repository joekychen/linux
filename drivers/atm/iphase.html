<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › atm › iphase.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>iphase.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm">         iphase.c: Device driver for Interphase ATM PCI adapter cards </span>
<span class="cm">                    Author: Peter Wang  &lt;pwang@iphase.com&gt;            </span>
<span class="cm">		   Some fixes: Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm">                   Interphase Corporation  &lt;www.iphase.com&gt;           </span>
<span class="cm">                               Version: 1.0                           </span>
<span class="cm">*******************************************************************************</span>
<span class="cm">      </span>
<span class="cm">      This software may be used and distributed according to the terms</span>
<span class="cm">      of the GNU General Public License (GPL), incorporated herein by reference.</span>
<span class="cm">      Drivers based on this skeleton fall under the GPL and must retain</span>
<span class="cm">      the authorship (implicit copyright) notice.</span>

<span class="cm">      This program is distributed in the hope that it will be useful, but</span>
<span class="cm">      WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">      MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU</span>
<span class="cm">      General Public License for more details.</span>
<span class="cm">      </span>
<span class="cm">      Modified from an incomplete driver for Interphase 5575 1KVC 1M card which </span>
<span class="cm">      was originally written by Monalisa Agrawal at UNH. Now this driver </span>
<span class="cm">      supports a variety of varients of Interphase ATM PCI (i)Chip adapter </span>
<span class="cm">      card family (See www.iphase.com/products/ClassSheet.cfm?ClassID=ATM) </span>
<span class="cm">      in terms of PHY type, the size of control memory and the size of </span>
<span class="cm">      packet memory. The followings are the change log and history:</span>
<span class="cm">     </span>
<span class="cm">          Bugfix the Mona&#39;s UBR driver.</span>
<span class="cm">          Modify the basic memory allocation and dma logic.</span>
<span class="cm">          Port the driver to the latest kernel from 2.0.46.</span>
<span class="cm">          Complete the ABR logic of the driver, and added the ABR work-</span>
<span class="cm">              around for the hardware anormalies.</span>
<span class="cm">          Add the CBR support.</span>
<span class="cm">	  Add the flow control logic to the driver to allow rate-limit VC.</span>
<span class="cm">          Add 4K VC support to the board with 512K control memory.</span>
<span class="cm">          Add the support of all the variants of the Interphase ATM PCI </span>
<span class="cm">          (i)Chip adapter cards including x575 (155M OC3 and UTP155), x525</span>
<span class="cm">          (25M UTP25) and x531 (DS3 and E3).</span>
<span class="cm">          Add SMP support.</span>

<span class="cm">      Support and updates available at: ftp://ftp.iphase.com/pub/atm</span>

<span class="cm">*******************************************************************************/</span>

<span class="cp">#include &lt;linux/module.h&gt;  </span>
<span class="cp">#include &lt;linux/kernel.h&gt;  </span>
<span class="cp">#include &lt;linux/mm.h&gt;  </span>
<span class="cp">#include &lt;linux/pci.h&gt;  </span>
<span class="cp">#include &lt;linux/errno.h&gt;  </span>
<span class="cp">#include &lt;linux/atm.h&gt;  </span>
<span class="cp">#include &lt;linux/atmdev.h&gt;  </span>
<span class="cp">#include &lt;linux/sonet.h&gt;  </span>
<span class="cp">#include &lt;linux/skbuff.h&gt;  </span>
<span class="cp">#include &lt;linux/time.h&gt;  </span>
<span class="cp">#include &lt;linux/delay.h&gt;  </span>
<span class="cp">#include &lt;linux/uio.h&gt;  </span>
<span class="cp">#include &lt;linux/init.h&gt;  </span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;  </span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;  </span>
<span class="cp">#include &lt;asm/string.h&gt;  </span>
<span class="cp">#include &lt;asm/byteorder.h&gt;  </span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &quot;iphase.h&quot;		  </span>
<span class="cp">#include &quot;suni.h&quot;		  </span>
<span class="cp">#define swap_byte_order(x) (((x &amp; 0xff) &lt;&lt; 8) | ((x &amp; 0xff00) &gt;&gt; 8))</span>

<span class="cp">#define PRIV(dev) ((struct suni_priv *) dev-&gt;phy_data)</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ia_phy_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">desc_dbg</span><span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">);</span>

<span class="k">static</span> <span class="n">IADEV</span> <span class="o">*</span><span class="n">ia_dev</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">_ia_dev</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">iadev_count</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ia_led_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">ia_timer</span><span class="p">,</span> <span class="n">ia_led_timer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">IA_TX_BUF</span> <span class="o">=</span> <span class="n">DFL_TX_BUFFERS</span><span class="p">,</span> <span class="n">IA_TX_BUF_SZ</span> <span class="o">=</span> <span class="n">DFL_TX_BUF_SZ</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">IA_RX_BUF</span> <span class="o">=</span> <span class="n">DFL_RX_BUFFERS</span><span class="p">,</span> <span class="n">IA_RX_BUF_SZ</span> <span class="o">=</span> <span class="n">DFL_RX_BUF_SZ</span><span class="p">;</span>
<span class="k">static</span> <span class="n">uint</span> <span class="n">IADebugFlag</span> <span class="o">=</span> <span class="cm">/* IF_IADBG_ERR | IF_IADBG_CBR| IF_IADBG_INIT_ADAPTER</span>
<span class="cm">            |IF_IADBG_ABR | IF_IADBG_EVENT*/</span> <span class="mi">0</span><span class="p">;</span> 

<span class="n">module_param</span><span class="p">(</span><span class="n">IA_TX_BUF</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">IA_TX_BUF_SZ</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">IA_RX_BUF</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">IA_RX_BUF_SZ</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">IADebugFlag</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/**************************** IA_LIB **********************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_init_rtn_q</span> <span class="p">(</span><span class="n">IARTN_Q</span> <span class="o">*</span><span class="n">que</span><span class="p">)</span> 
<span class="p">{</span> 
   <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 
   <span class="n">que</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_enque_head_rtn_q</span> <span class="p">(</span><span class="n">IARTN_Q</span> <span class="o">*</span><span class="n">que</span><span class="p">,</span> <span class="n">IARTN_Q</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span> 
<span class="p">{</span>
   <span class="n">data</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> 
      <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">que</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="n">data</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
      <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
   <span class="p">}</span> 
   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_enque_rtn_q</span> <span class="p">(</span><span class="n">IARTN_Q</span> <span class="o">*</span><span class="n">que</span><span class="p">,</span> <span class="k">struct</span> <span class="n">desc_tbl_t</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">IARTN_Q</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
   <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
   <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> 
      <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">que</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="n">que</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
      <span class="n">que</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">que</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
   <span class="p">}</span>      
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">IARTN_Q</span> <span class="o">*</span> <span class="nf">ia_deque_rtn_q</span> <span class="p">(</span><span class="n">IARTN_Q</span> <span class="o">*</span><span class="n">que</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">IARTN_Q</span> <span class="o">*</span><span class="n">tmpdata</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="n">tmpdata</span> <span class="o">=</span> <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span> <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">que</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">)</span>  
      <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">que</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">else</span> 
      <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">que</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">tmpdata</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_hack_tcq</span><span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">u_short</span> 		<span class="n">desc1</span><span class="p">;</span>
  <span class="n">u_short</span>		<span class="n">tcq_wr</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">ia_vcc</span>         <span class="o">*</span><span class="n">iavcc_r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 

  <span class="n">tcq_wr</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_WR_PTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span> <span class="o">!=</span> <span class="n">tcq_wr</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">desc1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_ram</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span><span class="p">);</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc1</span><span class="p">)</span> <span class="p">;</span>
     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc1</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">IF_ABR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot; Desc %d is reset at %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc1</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);)</span>
        <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_ram</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span>                                 
     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc1</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">iavcc_r</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc1</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">iavcc</span><span class="p">))</span> <span class="p">{</span> 
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: Fatal err in get_desc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">iavcc_r</span><span class="o">-&gt;</span><span class="n">vc_desc_cnt</span><span class="o">--</span><span class="p">;</span>
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc1</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia_hack: return_q skb = 0x%p desc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc1</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">txskb</span><span class="p">,</span> <span class="n">desc1</span><span class="p">);)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iavcc_r</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rate_limit</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">IA_SKB_STATE</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc1</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">txskb</span><span class="p">)</span> <span class="o">|=</span> <span class="n">IA_TX_DONE</span><span class="p">;</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">ia_enque_rtn_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_return_q</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc1</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia_hack_tcq: No memory available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span> 
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc1</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">iavcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc1</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">txskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_ed</span><span class="p">)</span> 
        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_st</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="cm">/* ia_hack_tcq */</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_desc</span> <span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ia_vcc</span> <span class="o">*</span><span class="n">iavcc</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">u_short</span> 		<span class="n">desc_num</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sk_buff</span>        <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">ia_vcc</span>         <span class="o">*</span><span class="n">iavcc_r</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> 
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">;</span>
  <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">ltimeout</span><span class="p">;</span>

  <span class="n">ia_hack_tcq</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
  <span class="k">if</span><span class="p">((</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">timer</span><span class="o">+</span><span class="mi">50</span><span class="p">))</span> <span class="o">||</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span><span class="o">==</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span><span class="p">)))</span> <span class="p">{</span>
     <span class="n">timer</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> 
     <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
     <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">i</span><span class="o">++</span><span class="p">;</span>
           <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">ltimeout</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iavcc</span><span class="o">-&gt;</span><span class="n">ltimeout</span><span class="p">;</span> 
        <span class="n">delta</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timestamp</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;=</span> <span class="n">ltimeout</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">IF_ABR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;RECOVER run!! desc_tbl %d = %d  delta = %ld, time = %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);)</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_st</span><span class="p">)</span> 
              <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">=</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_ed</span><span class="p">;</span>
           <span class="k">else</span> 
              <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
           <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_ram</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span><span class="p">)</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
           <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txskb</span><span class="p">)</span> <span class="o">||</span> 
                          <span class="o">!</span><span class="p">(</span><span class="n">iavcc_r</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iavcc</span><span class="p">))</span>
              <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Fatal err, desc table vcc or skb is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="k">else</span> 
              <span class="n">iavcc_r</span><span class="o">-&gt;</span><span class="n">vc_desc_cnt</span><span class="o">--</span><span class="p">;</span>
           <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">iavcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
           <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">txskb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
     <span class="p">}</span> <span class="cm">/* while */</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span><span class="p">)</span> 
     <span class="k">return</span> <span class="mh">0xFFFF</span><span class="p">;</span>
    
  <span class="cm">/* Get the next available descriptor number from TCQ */</span>
  <span class="n">desc_num</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_ram</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span><span class="p">);</span>

  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">desc_num</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc_num</span> <span class="o">-</span><span class="mi">1</span><span class="p">]).</span><span class="n">timestamp</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_ed</span><span class="p">)</span> 
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_st</span><span class="p">;</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span><span class="p">)</span> 
        <span class="k">return</span> <span class="mh">0xFFFF</span><span class="p">;</span> 
     <span class="n">desc_num</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_ram</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="cm">/* get system time */</span>
  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc_num</span> <span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">desc_num</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_lockup</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="n">IADEV</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">u_char</span>          	<span class="n">foundLockUp</span><span class="p">;</span>
  <span class="n">vcstatus_t</span>		<span class="o">*</span><span class="n">vcstatus</span><span class="p">;</span>
  <span class="n">u_short</span>               <span class="o">*</span><span class="n">shd_tbl</span><span class="p">;</span>
  <span class="n">u_short</span>               <span class="n">tempCellSlot</span><span class="p">,</span> <span class="n">tempFract</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">main_vc</span> <span class="o">*</span><span class="n">abr_vc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">main_vc</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">MAIN_VC_TABLE_ADDR</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">ext_vc</span> <span class="o">*</span><span class="n">eabr_vc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext_vc</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">EXT_VC_TABLE_ADDR</span><span class="p">;</span>
  <span class="n">u_int</span>  <span class="n">i</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_ABR</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">vcstatus</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcstatus_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vc_status</span><span class="p">);</span>
     <span class="n">vcstatus</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
     <span class="n">foundLockUp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="k">if</span><span class="p">(</span> <span class="n">vcstatus</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">==</span> <span class="mh">0x05</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">abr_vc</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
	<span class="n">eabr_vc</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">eabr_vc</span><span class="o">-&gt;</span><span class="n">last_desc</span> <span class="p">)</span> <span class="p">{</span>
	   <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">abr_vc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">==</span> <span class="n">ABR_STATE</span> <span class="cm">/* 0x2 */</span> <span class="p">)</span> <span class="p">{</span>
              <span class="cm">/* Wait for 10 Micro sec */</span>
              <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	      <span class="k">if</span> <span class="p">((</span><span class="n">eabr_vc</span><span class="o">-&gt;</span><span class="n">last_desc</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">((</span><span class="n">abr_vc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span><span class="o">==</span><span class="n">ABR_STATE</span><span class="p">))</span>
		 <span class="n">foundLockUp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="p">}</span>
	   <span class="k">else</span> <span class="p">{</span>
	      <span class="n">tempCellSlot</span> <span class="o">=</span> <span class="n">abr_vc</span><span class="o">-&gt;</span><span class="n">last_cell_slot</span><span class="p">;</span>
              <span class="n">tempFract</span>    <span class="o">=</span> <span class="n">abr_vc</span><span class="o">-&gt;</span><span class="n">fraction</span><span class="p">;</span>
              <span class="k">if</span><span class="p">((</span><span class="n">tempCellSlot</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lastTime</span><span class="p">)</span>
                         <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">tempFract</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fract</span><span class="p">))</span>
	         <span class="n">foundLockUp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 		    
              <span class="n">dev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lastTime</span> <span class="o">=</span> <span class="n">tempCellSlot</span><span class="p">;</span>   
              <span class="n">dev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fract</span> <span class="o">=</span> <span class="n">tempFract</span><span class="p">;</span> 
	   <span class="p">}</span> 	    
        <span class="p">}</span> <span class="cm">/* last descriptor */</span>	 	   
        <span class="n">vcstatus</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>     	
     <span class="p">}</span> <span class="cm">/* vcstatus-&gt;cnt */</span>
	
     <span class="k">if</span> <span class="p">(</span><span class="n">foundLockUp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">IF_ABR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;LOCK UP found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span> 
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xFFFD</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">MODE_REG_0</span><span class="p">);</span>
        <span class="cm">/* Wait for 10 Micro sec */</span>
        <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> 
        <span class="n">abr_vc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span> <span class="mh">0xFFF8</span><span class="p">;</span>
        <span class="n">abr_vc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="mh">0x0001</span><span class="p">;</span>  <span class="cm">/* state is idle */</span>
	<span class="n">shd_tbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ABR_SCHED_TABLE_ADDR</span><span class="p">;</span>                
	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">shd_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span> <span class="n">i</span><span class="o">++</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="p">)</span>
           <span class="n">shd_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
        <span class="k">else</span>
           <span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ABR Seg. may not continue on VC %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);)</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">T_ONLINE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">MODE_REG_0</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">TRANSMIT_DONE</span><span class="o">|</span><span class="n">TCQ_NOT_EMPTY</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_MASK_REG</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">TRANSMIT_DONE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_INTR_STATUS_REG</span><span class="p">);</span>       
	<span class="n">vcstatus</span><span class="o">-&gt;</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span> <span class="cm">/* foundLockUp */</span>

  <span class="p">}</span> <span class="cm">/* if an ABR VC */</span>


<span class="p">}</span>
 
<span class="cm">/*</span>
<span class="cm">** Conversion of 24-bit cellrate (cells/sec) to 16-bit floating point format.</span>
<span class="cm">**</span>
<span class="cm">**  +----+----+------------------+-------------------------------+</span>
<span class="cm">**  |  R | NZ |  5-bit exponent  |        9-bit mantissa         |</span>
<span class="cm">**  +----+----+------------------+-------------------------------+</span>
<span class="cm">** </span>
<span class="cm">**    R = reserved (written as 0)</span>
<span class="cm">**    NZ = 0 if 0 cells/sec; 1 otherwise</span>
<span class="cm">**</span>
<span class="cm">**    if NZ = 1, rate = 1.mmmmmmmmm x 2^(eeeee) cells/sec</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">cellrate_to_float</span><span class="p">(</span><span class="n">u32</span> <span class="n">cr</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#define	NZ 		0x4000</span>
<span class="cp">#define	M_BITS		9		</span><span class="cm">/* Number of bits in mantissa */</span><span class="cp"></span>
<span class="cp">#define	E_BITS		5		</span><span class="cm">/* Number of bits in exponent */</span><span class="cp"></span>
<span class="cp">#define	M_MASK		0x1ff		</span>
<span class="cp">#define	E_MASK		0x1f</span>
  <span class="n">u16</span>   <span class="n">flot</span><span class="p">;</span>
  <span class="n">u32</span>	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cr</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
  <span class="kt">int</span> 	<span class="n">i</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">cr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
     <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">tmp</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
     <span class="n">i</span><span class="o">++</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">M_BITS</span><span class="p">)</span>
     <span class="n">flot</span> <span class="o">=</span> <span class="n">NZ</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">M_BITS</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cr</span> <span class="o">&amp;</span> <span class="n">M_MASK</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">M_BITS</span><span class="p">)</span>
     <span class="n">flot</span> <span class="o">=</span> <span class="n">NZ</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">M_BITS</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">cr</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">M_BITS</span> <span class="o">-</span> <span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">M_MASK</span><span class="p">);</span>
  <span class="k">else</span>
     <span class="n">flot</span> <span class="o">=</span> <span class="n">NZ</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">M_BITS</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">cr</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">M_BITS</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">M_MASK</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">flot</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c">** Conversion of 16-bit floating point format to 24-bit cellrate (cells/sec).</span>
<span class="c">*/</span>
<span class="c">static u32</span>
<span class="c">float_to_cellrate(u16 rate)</span>
<span class="c">{</span>
<span class="c">  u32   exp, mantissa, cps;</span>
<span class="c">  if ((rate &amp; NZ) == 0)</span>
<span class="c">     return 0;</span>
<span class="c">  exp = (rate &gt;&gt; M_BITS) &amp; E_MASK;</span>
<span class="c">  mantissa = rate &amp; M_MASK;</span>
<span class="c">  if (exp == 0)</span>
<span class="c">     return 1;</span>
<span class="c">  cps = (1 &lt;&lt; M_BITS) | mantissa;</span>
<span class="c">  if (exp == M_BITS)</span>
<span class="c">     cps = cps;</span>
<span class="c">  else if (exp &gt; M_BITS)</span>
<span class="c">     cps &lt;&lt;= (exp - M_BITS);</span>
<span class="c">  else</span>
<span class="c">     cps &gt;&gt;= (M_BITS - exp);</span>
<span class="c">  return cps;</span>
<span class="c">}</span>
<span class="cp">#endif </span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_abr_vc</span> <span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">srv_cls_param_t</span> <span class="o">*</span><span class="n">srv_p</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">class_type</span> <span class="o">=</span> <span class="n">ATM_ABR</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">pcr</span>        <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">mcr</span>        <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">icr</span>        <span class="o">=</span> <span class="mh">0x055cb7</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">tbe</span>        <span class="o">=</span> <span class="mh">0xffffff</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">frtt</span>       <span class="o">=</span> <span class="mh">0x3a</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">rif</span>        <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">rdf</span>        <span class="o">=</span> <span class="mh">0xb</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">nrm</span>        <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">trm</span>        <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">cdf</span>        <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
  <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">adtf</span>       <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">ia_open_abr_vc</span><span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">srv_cls_param_t</span> <span class="o">*</span><span class="n">srv_p</span><span class="p">,</span> 
                                                <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flag</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">f_vc_abr_entry</span>  <span class="o">*</span><span class="n">f_abr_vc</span><span class="p">;</span>
  <span class="n">r_vc_abr_entry</span>  <span class="o">*</span><span class="n">r_abr_vc</span><span class="p">;</span>
  <span class="n">u32</span>		<span class="n">icr</span><span class="p">;</span>
  <span class="n">u8</span>		<span class="n">trm</span><span class="p">,</span> <span class="n">nrm</span><span class="p">,</span> <span class="n">crm</span><span class="p">;</span>
  <span class="n">u16</span>		<span class="n">adtf</span><span class="p">,</span> <span class="n">air</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr16</span><span class="p">;</span>	
  <span class="n">f_abr_vc</span> <span class="o">=</span><span class="p">(</span><span class="n">f_vc_abr_entry</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">MAIN_VC_TABLE_ADDR</span><span class="p">;</span>
  <span class="n">f_abr_vc</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>       
  <span class="k">switch</span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* FFRED initialization */</span>
<span class="cp">#if 0</span><span class="c">  /* sanity check */</span>
<span class="c">       if (srv_p-&gt;pcr == 0)</span>
<span class="c">          return INVALID_PCR;</span>
<span class="c">       if (srv_p-&gt;pcr &gt; dev-&gt;LineRate)</span>
<span class="c">          srv_p-&gt;pcr = dev-&gt;LineRate;</span>
<span class="c">       if ((srv_p-&gt;mcr + dev-&gt;sum_mcr) &gt; dev-&gt;LineRate)</span>
<span class="c">	  return MCR_UNAVAILABLE;</span>
<span class="c">       if (srv_p-&gt;mcr &gt; srv_p-&gt;pcr)</span>
<span class="c">	  return INVALID_MCR;</span>
<span class="c">       if (!(srv_p-&gt;icr))</span>
<span class="c">	  srv_p-&gt;icr = srv_p-&gt;pcr;</span>
<span class="c">       if ((srv_p-&gt;icr &lt; srv_p-&gt;mcr) || (srv_p-&gt;icr &gt; srv_p-&gt;pcr))</span>
<span class="c">	  return INVALID_ICR;</span>
<span class="c">       if ((srv_p-&gt;tbe &lt; MIN_TBE) || (srv_p-&gt;tbe &gt; MAX_TBE))</span>
<span class="c">	  return INVALID_TBE;</span>
<span class="c">       if ((srv_p-&gt;frtt &lt; MIN_FRTT) || (srv_p-&gt;frtt &gt; MAX_FRTT))</span>
<span class="c">	  return INVALID_FRTT;</span>
<span class="c">       if (srv_p-&gt;nrm &gt; MAX_NRM)</span>
<span class="c">	  return INVALID_NRM;</span>
<span class="c">       if (srv_p-&gt;trm &gt; MAX_TRM)</span>
<span class="c">	  return INVALID_TRM;</span>
<span class="c">       if (srv_p-&gt;adtf &gt; MAX_ADTF)</span>
<span class="c">          return INVALID_ADTF;</span>
<span class="c">       else if (srv_p-&gt;adtf == 0)</span>
<span class="c">	  srv_p-&gt;adtf = 1;</span>
<span class="c">       if (srv_p-&gt;cdf &gt; MAX_CDF)</span>
<span class="c">	  return INVALID_CDF;</span>
<span class="c">       if (srv_p-&gt;rif &gt; MAX_RIF)</span>
<span class="c">	  return INVALID_RIF;</span>
<span class="c">       if (srv_p-&gt;rdf &gt; MAX_RDF)</span>
<span class="c">	  return INVALID_RDF;</span>
<span class="cp">#endif</span>
       <span class="n">memset</span> <span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">f_abr_vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">f_abr_vc</span><span class="p">));</span>
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_vc_type</span> <span class="o">=</span> <span class="n">ABR</span><span class="p">;</span>
       <span class="n">nrm</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">nrm</span><span class="p">;</span>     <span class="cm">/* (2 ** (srv_p-&gt;nrm +1)) */</span>
			          <span class="cm">/* i.e 2**n = 2 &lt;&lt; (n-1) */</span>
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_nrm</span> <span class="o">=</span> <span class="n">nrm</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">nrm</span><span class="p">;</span>
       <span class="n">trm</span> <span class="o">=</span> <span class="mi">100000</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">trm</span><span class="p">));</span>
       <span class="k">if</span> <span class="p">(</span> <span class="n">trm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">trm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_nrmexp</span> <span class="o">=</span><span class="p">(((</span><span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">nrm</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">MRM</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">trm</span><span class="p">;</span>
       <span class="n">crm</span> <span class="o">=</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">tbe</span> <span class="o">/</span> <span class="n">nrm</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">crm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">crm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_crm</span> <span class="o">=</span> <span class="n">crm</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_pcr</span> <span class="o">=</span> <span class="n">cellrate_to_float</span><span class="p">(</span><span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">pcr</span><span class="p">);</span>
       <span class="n">icr</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">icr</span><span class="p">,</span> <span class="p">(</span><span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">tbe</span> <span class="o">&gt;</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">frtt</span><span class="p">)</span> <span class="o">?</span>
				<span class="p">((</span><span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">tbe</span><span class="o">/</span><span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">frtt</span><span class="p">)</span><span class="o">*</span><span class="mi">1000000</span><span class="p">)</span> <span class="o">:</span>
				<span class="p">(</span><span class="mi">1000000</span><span class="o">/</span><span class="p">(</span><span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">frtt</span><span class="o">/</span><span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">tbe</span><span class="p">)));</span>
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_icr</span> <span class="o">=</span> <span class="n">cellrate_to_float</span><span class="p">(</span><span class="n">icr</span><span class="p">);</span>
       <span class="n">adtf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10000</span> <span class="o">*</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">adtf</span><span class="p">)</span><span class="o">/</span><span class="mi">8192</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">adtf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">adtf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> 
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_cdf</span> <span class="o">=</span> <span class="p">((</span><span class="mi">7</span> <span class="o">-</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">cdf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span> <span class="n">adtf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">;</span>
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_mcr</span> <span class="o">=</span> <span class="n">cellrate_to_float</span><span class="p">(</span><span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">mcr</span><span class="p">);</span>
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_acr</span> <span class="o">=</span> <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_icr</span><span class="p">;</span>
       <span class="n">f_abr_vc</span><span class="o">-&gt;</span><span class="n">f_status</span> <span class="o">=</span> <span class="mh">0x0042</span><span class="p">;</span>
       <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* RFRED initialization */</span>	
       <span class="n">ptr16</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reass_ram</span> <span class="o">+</span> <span class="n">REASS_TABLE</span><span class="o">*</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">);</span> 
       <span class="o">*</span><span class="p">(</span><span class="n">ptr16</span> <span class="o">+</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">)</span> <span class="o">=</span> <span class="n">NO_AAL5_PKT</span> <span class="o">|</span> <span class="n">REASS_ABR</span><span class="p">;</span>
       <span class="n">r_abr_vc</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_vc_abr_entry</span><span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">ABR_VC_TABLE</span><span class="o">*</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">);</span>
       <span class="n">r_abr_vc</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
       <span class="n">r_abr_vc</span><span class="o">-&gt;</span><span class="n">r_status_rdf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">rdf</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">;</span>
       <span class="n">air</span> <span class="o">=</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">15</span> <span class="o">-</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">rif</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="n">air</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">air</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
       <span class="n">r_abr_vc</span><span class="o">-&gt;</span><span class="n">r_air</span> <span class="o">=</span> <span class="n">cellrate_to_float</span><span class="p">(</span><span class="n">air</span><span class="p">);</span>
       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vc_status</span> <span class="o">=</span> <span class="n">VC_ACTIVE</span> <span class="o">|</span> <span class="n">VC_ABR</span><span class="p">;</span>
       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sum_mcr</span>	   <span class="o">+=</span> <span class="n">srv_p</span><span class="o">-&gt;</span><span class="n">mcr</span><span class="p">;</span>
       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">n_abr</span><span class="o">++</span><span class="p">;</span>
       <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
       <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span>	<span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_cbr_setup</span> <span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">u32</span> <span class="n">rateLow</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">rateHigh</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">ia_vcc</span> <span class="o">*</span><span class="n">ia_vcc</span><span class="p">;</span>

   <span class="kt">int</span>   <span class="n">idealSlot</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">testSlot</span><span class="p">,</span> <span class="n">toBeAssigned</span><span class="p">,</span> <span class="n">inc</span><span class="p">;</span>
   <span class="n">u32</span>   <span class="n">spacing</span><span class="p">;</span>
   <span class="n">u16</span>  <span class="o">*</span><span class="n">SchedTbl</span><span class="p">,</span> <span class="o">*</span><span class="n">TstSchedTbl</span><span class="p">;</span>
   <span class="n">u16</span>  <span class="n">cbrVC</span><span class="p">,</span> <span class="n">vcIndex</span><span class="p">;</span>
   <span class="n">u32</span>   <span class="n">fracSlot</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">u32</span>   <span class="n">sp_mod</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">u32</span>   <span class="n">sp_mod2</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="cm">/* IpAdjustTrafficParams */</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;PCR for CBR not defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">rate</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">;</span>
   <span class="n">entries</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">/</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">Granularity</span><span class="p">;</span>
   <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;CBR: CBR entries=0x%x for rate=0x%x &amp; Gran=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                <span class="n">entries</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">Granularity</span><span class="p">);)</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;CBR: Bandwidth smaller than granularity of CBR table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span> 
   <span class="n">rateLow</span>  <span class="o">=</span>  <span class="n">entries</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">Granularity</span><span class="p">;</span>
   <span class="n">rateHigh</span> <span class="o">=</span> <span class="p">(</span><span class="n">entries</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">Granularity</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="n">rate</span> <span class="o">-</span> <span class="n">rateLow</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">rateHigh</span> <span class="o">-</span> <span class="n">rate</span><span class="p">))</span>
      <span class="n">entries</span><span class="o">++</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrRemEntries</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;CBR: Not enough bandwidth to support this PCR.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
      <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Entries = 0x%x, CbrRemEntries = 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                       <span class="n">entries</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrRemEntries</span><span class="p">);)</span>
      <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
   <span class="p">}</span>   

   <span class="n">ia_vcc</span> <span class="o">=</span> <span class="n">INPH_IA_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
   <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">NumCbrEntry</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span> 
   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sum_mcr</span> <span class="o">+=</span> <span class="n">entries</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">Granularity</span><span class="p">;</span> 
   <span class="cm">/* IaFFrednInsertCbrSched */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Starting at an arbitrary location, place the entries into the table
as smoothly as possible</p></td><td class="code"><div class="highlight"><pre>   <span class="n">cbrVC</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">spacing</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span> <span class="o">/</span> <span class="n">entries</span><span class="p">;</span>
   <span class="n">sp_mod</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span> <span class="o">%</span> <span class="n">entries</span><span class="p">;</span> <span class="c1">// get modulo</span>
   <span class="n">toBeAssigned</span> <span class="o">=</span> <span class="n">entries</span><span class="p">;</span>
   <span class="n">fracSlot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">vcIndex</span>  <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
   <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Vci=0x%x,Spacing=0x%x,Sp_mod=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">vcIndex</span><span class="p">,</span><span class="n">spacing</span><span class="p">,</span><span class="n">sp_mod</span><span class="p">);)</span>
   <span class="k">while</span> <span class="p">(</span><span class="n">toBeAssigned</span><span class="p">)</span>
   <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>If this is the first time, start the table loading for this connection
as close to entryPoint as possible.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">toBeAssigned</span> <span class="o">==</span> <span class="n">entries</span><span class="p">)</span>
      <span class="p">{</span>
         <span class="n">idealSlot</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrEntryPt</span><span class="p">;</span>
         <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrEntryPt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>    <span class="c1">// Adding 2 helps to prevent clumping</span>
         <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrEntryPt</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">)</span> 
            <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrEntryPt</span> <span class="o">-=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">;</span><span class="c1">// Wrap if necessary</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">idealSlot</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">spacing</span> <span class="o">+</span> <span class="n">fracSlot</span><span class="p">);</span> <span class="c1">// Point to the next location</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>in the table that would be  smoothest</p></td><td class="code"><div class="highlight"><pre>         <span class="n">fracSlot</span> <span class="o">=</span> <span class="p">((</span><span class="n">sp_mod</span> <span class="o">+</span> <span class="n">sp_mod2</span><span class="p">)</span> <span class="o">/</span> <span class="n">entries</span><span class="p">);</span>  <span class="c1">// get new integer part</span>
         <span class="n">sp_mod2</span>  <span class="o">=</span> <span class="p">((</span><span class="n">sp_mod</span> <span class="o">+</span> <span class="n">sp_mod2</span><span class="p">)</span> <span class="o">%</span> <span class="n">entries</span><span class="p">);</span>  <span class="c1">// calc new fractional part</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">idealSlot</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">)</span> 
         <span class="n">idealSlot</span> <span class="o">-=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">;</span>  </pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Continuously check around this ideal value until a null
location is encountered.</p></td><td class="code"><div class="highlight"><pre>      <span class="n">SchedTbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">CBR_SCHED_TABLE</span><span class="o">*</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">);</span> 
      <span class="n">inc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">testSlot</span> <span class="o">=</span> <span class="n">idealSlot</span><span class="p">;</span>
      <span class="n">TstSchedTbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">SchedTbl</span><span class="o">+</span><span class="n">testSlot</span><span class="p">);</span>  <span class="c1">//set index and read in value</span>
      <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;CBR Testslot 0x%x AT Location 0x%p, NumToAssign=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                <span class="n">testSlot</span><span class="p">,</span> <span class="n">TstSchedTbl</span><span class="p">,</span><span class="n">toBeAssigned</span><span class="p">);)</span>
      <span class="n">memcpy</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cbrVC</span><span class="p">,(</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">TstSchedTbl</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cbrVC</span><span class="p">));</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">cbrVC</span><span class="p">)</span>  <span class="c1">// If another VC at this location, we have to keep looking</span>
      <span class="p">{</span>
          <span class="n">inc</span><span class="o">++</span><span class="p">;</span>
          <span class="n">testSlot</span> <span class="o">=</span> <span class="n">idealSlot</span> <span class="o">-</span> <span class="n">inc</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">testSlot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Wrap if necessary</span>
             <span class="n">testSlot</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">;</span>
             <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Testslot Wrap. STable Start=0x%p,Testslot=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                                       <span class="n">SchedTbl</span><span class="p">,</span><span class="n">testSlot</span><span class="p">);)</span>
          <span class="p">}</span>
          <span class="n">TstSchedTbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">SchedTbl</span> <span class="o">+</span> <span class="n">testSlot</span><span class="p">);</span>  <span class="c1">// set table index</span>
          <span class="n">memcpy</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cbrVC</span><span class="p">,(</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">TstSchedTbl</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cbrVC</span><span class="p">));</span> 
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cbrVC</span><span class="p">)</span>
             <span class="k">break</span><span class="p">;</span>
          <span class="n">testSlot</span> <span class="o">=</span> <span class="n">idealSlot</span> <span class="o">+</span> <span class="n">inc</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">testSlot</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Wrap if necessary</span>
             <span class="n">testSlot</span> <span class="o">-=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">;</span>
             <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;TotCbrEntries=%d&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">);)</span>
             <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot; Testslot=0x%x ToBeAssgned=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                            <span class="n">testSlot</span><span class="p">,</span> <span class="n">toBeAssigned</span><span class="p">);)</span>
          <span class="p">}</span> </pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>set table index and read in value</p></td><td class="code"><div class="highlight"><pre>          <span class="n">TstSchedTbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">SchedTbl</span> <span class="o">+</span> <span class="n">testSlot</span><span class="p">);</span>
          <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Reading CBR Tbl from 0x%p, CbrVal=0x%x Iteration %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                          <span class="n">TstSchedTbl</span><span class="p">,</span><span class="n">cbrVC</span><span class="p">,</span><span class="n">inc</span><span class="p">);)</span>
          <span class="n">memcpy</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cbrVC</span><span class="p">,(</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">TstSchedTbl</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cbrVC</span><span class="p">));</span>
       <span class="p">}</span> <span class="cm">/* while */</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Move this VCI number into this location of the CBR Sched table.</p></td><td class="code"><div class="highlight"><pre>       <span class="n">memcpy</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">TstSchedTbl</span><span class="p">,</span> <span class="p">(</span><span class="n">caddr_t</span><span class="p">)</span><span class="o">&amp;</span><span class="n">vcIndex</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">TstSchedTbl</span><span class="p">));</span>
       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">CbrRemEntries</span><span class="o">--</span><span class="p">;</span>
       <span class="n">toBeAssigned</span><span class="o">--</span><span class="p">;</span>
   <span class="p">}</span> <span class="cm">/* while */</span> 

   <span class="cm">/* IaFFrednCbrEnable */</span>
   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">NumEnabledCBR</span><span class="o">++</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">NumEnabledCBR</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">writew</span><span class="p">((</span><span class="n">CBR_EN</span> <span class="o">|</span> <span class="n">UBR_EN</span> <span class="o">|</span> <span class="n">ABR_EN</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x23</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">STPARMS</span><span class="p">);</span>
       <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;CBR is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_cbrVc_close</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>
   <span class="n">u16</span> <span class="o">*</span><span class="n">SchedTbl</span><span class="p">,</span> <span class="n">NullVci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">NumFound</span><span class="p">;</span>

   <span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
   <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">NumEnabledCBR</span><span class="o">--</span><span class="p">;</span>
   <span class="n">SchedTbl</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">CBR_SCHED_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">NumEnabledCBR</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">writew</span><span class="p">((</span><span class="n">UBR_EN</span> <span class="o">|</span> <span class="n">ABR_EN</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x23</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">STPARMS</span><span class="p">);</span>
      <span class="n">IF_CBR</span> <span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;CBR support disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
   <span class="p">}</span>
   <span class="n">NumFound</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
   <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">SchedTbl</span> <span class="o">==</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">CbrRemEntries</span><span class="o">++</span><span class="p">;</span>
         <span class="o">*</span><span class="n">SchedTbl</span> <span class="o">=</span> <span class="n">NullVci</span><span class="p">;</span>
         <span class="n">IF_CBR</span><span class="p">(</span><span class="n">NumFound</span><span class="o">++</span><span class="p">;)</span>
      <span class="p">}</span>
      <span class="n">SchedTbl</span><span class="o">++</span><span class="p">;</span>   
   <span class="p">}</span> 
   <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Exit ia_cbrVc_close, NumRemoved=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">NumFound</span><span class="p">);)</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_avail_descs</span><span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span> <span class="p">{</span>
   <span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   <span class="n">ia_hack_tcq</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span> <span class="o">&gt;=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span><span class="p">)</span>
      <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span> <span class="o">-</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
   <span class="k">else</span>
      <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_ed</span> <span class="o">-</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span> <span class="o">-</span>
                   <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_st</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
   <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>    

<span class="k">static</span> <span class="kt">int</span> <span class="n">ia_pkt_tx</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_que_tx</span> <span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span> <span class="p">{</span> 
   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">num_desc</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
   <span class="n">num_desc</span> <span class="o">=</span> <span class="n">ia_avail_descs</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>

   <span class="k">while</span> <span class="p">(</span><span class="n">num_desc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_backlog</span><span class="p">)))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia_que_tx: Null vcc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
         <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
         <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Free the SKB on closed vci %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
         <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ia_pkt_tx</span> <span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
         <span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_backlog</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">num_desc</span><span class="o">--</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_tx_poll</span> <span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">skb1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
   <span class="k">struct</span> <span class="n">ia_vcc</span> <span class="o">*</span><span class="n">iavcc</span><span class="p">;</span>
   <span class="n">IARTN_Q</span> <span class="o">*</span>  <span class="n">rtne</span><span class="p">;</span>

   <span class="n">ia_hack_tcq</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
   <span class="k">while</span> <span class="p">(</span> <span class="p">(</span><span class="n">rtne</span> <span class="o">=</span> <span class="n">ia_deque_rtn_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_return_q</span><span class="p">)))</span> <span class="p">{</span>
       <span class="n">skb</span> <span class="o">=</span> <span class="n">rtne</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">txskb</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia_tx_poll: skb is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia_tx_poll: vcc is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	   <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
       <span class="p">}</span>

       <span class="n">iavcc</span> <span class="o">=</span> <span class="n">INPH_IA_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iavcc</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia_tx_poll: iavcc is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	   <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
       <span class="p">}</span>

       <span class="n">skb1</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iavcc</span><span class="o">-&gt;</span><span class="n">txing_skb</span><span class="p">);</span>
       <span class="k">while</span> <span class="p">(</span><span class="n">skb1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb1</span> <span class="o">!=</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">IA_SKB_STATE</span><span class="p">(</span><span class="n">skb1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IA_TX_DONE</span><span class="p">))</span> <span class="p">{</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA_tx_intr: Vci %d lost pkt!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Release the SKB not match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb1</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
          <span class="p">{</span>
             <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb1</span><span class="p">);</span>
             <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Tansmit Done - skb 0x%lx return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                                          <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb1</span><span class="p">);)</span>
          <span class="p">}</span>
          <span class="k">else</span> 
             <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb1</span><span class="p">);</span>
          <span class="n">skb1</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iavcc</span><span class="o">-&gt;</span><span class="n">txing_skb</span><span class="p">);</span>
       <span class="p">}</span>                                                        
       <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb1</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: Vci %d - skb not found requed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);)</span>
          <span class="n">ia_enque_head_rtn_q</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_return_q</span><span class="p">,</span> <span class="n">rtne</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
       <span class="p">{</span>
          <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
          <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Tx Done - skb 0x%lx return</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="p">);)</span>
       <span class="p">}</span>
       <span class="k">else</span> 
          <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
       <span class="n">kfree</span><span class="p">(</span><span class="n">rtne</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ia_que_tx</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
<span class="nl">out:</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void ia_eeprom_put (IADEV *iadev, u32 addr, u_short val)</span>
<span class="c">{</span>
<span class="c">        u32	t;</span>
<span class="c">	int	i;</span>
<span class="c">	/*</span>
<span class="c">	 * Issue a command to enable writes to the NOVRAM</span>
<span class="c">	 */</span>
<span class="c">	NVRAM_CMD (EXTEND + EWEN);</span>
<span class="c">	NVRAM_CLR_CE;</span>
<span class="c">	/*</span>
<span class="c">	 * issue the write command</span>
<span class="c">	 */</span>
<span class="c">	NVRAM_CMD(IAWRITE + addr);</span>
<span class="c">	/* </span>
<span class="c">	 * Send the data, starting with D15, then D14, and so on for 16 bits</span>
<span class="c">	 */</span>
<span class="c">	for (i=15; i&gt;=0; i--) {</span>
<span class="c">		NVRAM_CLKOUT (val &amp; 0x8000);</span>
<span class="c">		val &lt;&lt;= 1;</span>
<span class="c">	}</span>
<span class="c">	NVRAM_CLR_CE;</span>
<span class="c">	CFG_OR(NVCE);</span>
<span class="c">	t = readl(iadev-&gt;reg+IPHASE5575_EEPROM_ACCESS); </span>
<span class="c">	while (!(t &amp; NVDO))</span>
<span class="c">		t = readl(iadev-&gt;reg+IPHASE5575_EEPROM_ACCESS); </span>

<span class="c">	NVRAM_CLR_CE;</span>
<span class="c">	/*</span>
<span class="c">	 * disable writes again</span>
<span class="c">	 */</span>
<span class="c">	NVRAM_CMD(EXTEND + EWDS)</span>
<span class="c">	NVRAM_CLR_CE;</span>
<span class="c">	CFG_AND(~NVDI);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">ia_eeprom_get</span> <span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span>	<span class="n">val</span><span class="p">;</span>
        <span class="n">u32</span>	<span class="n">t</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Read the first bit that was clocked with the falling edge of the</span>
<span class="cm">	 * the last command data clock</span>
<span class="cm">	 */</span>
	<span class="n">NVRAM_CMD</span><span class="p">(</span><span class="n">IAREAD</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Now read the rest of the bits, the next bit read is D14, then D13,</span>
<span class="cm">	 * and so on.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">NVRAM_CLKIN</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">NVRAM_CLR_CE</span><span class="p">;</span>
	<span class="n">CFG_AND</span><span class="p">(</span><span class="o">~</span><span class="n">NVDI</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_hw_type</span><span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span> <span class="p">{</span>
   <span class="n">u_short</span> <span class="n">memType</span> <span class="o">=</span> <span class="n">ia_eeprom_get</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="mi">25</span><span class="p">);</span>   
   <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memType</span> <span class="o">=</span> <span class="n">memType</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">((</span><span class="n">memType</span> <span class="o">&amp;</span> <span class="n">MEM_SIZE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MEM_SIZE_1M</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">=</span> <span class="n">IA_TX_BUF</span><span class="p">;</span>
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span> <span class="o">=</span> <span class="n">IA_TX_BUF_SZ</span><span class="p">;</span>
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span> <span class="o">=</span> <span class="n">IA_RX_BUF</span><span class="p">;</span>
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="n">IA_RX_BUF_SZ</span><span class="p">;</span> 
   <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">memType</span> <span class="o">&amp;</span> <span class="n">MEM_SIZE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MEM_SIZE_512K</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">IA_TX_BUF</span> <span class="o">==</span> <span class="n">DFL_TX_BUFFERS</span><span class="p">)</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">=</span> <span class="n">IA_TX_BUF</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">else</span> 
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">=</span> <span class="n">IA_TX_BUF</span><span class="p">;</span>
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span> <span class="o">=</span> <span class="n">IA_TX_BUF_SZ</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">IA_RX_BUF</span> <span class="o">==</span> <span class="n">DFL_RX_BUFFERS</span><span class="p">)</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span> <span class="o">=</span> <span class="n">IA_RX_BUF</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span> <span class="o">=</span> <span class="n">IA_RX_BUF</span><span class="p">;</span>
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="n">IA_RX_BUF_SZ</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">IA_TX_BUF</span> <span class="o">==</span> <span class="n">DFL_TX_BUFFERS</span><span class="p">)</span> 
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">=</span> <span class="n">IA_TX_BUF</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">=</span> <span class="n">IA_TX_BUF</span><span class="p">;</span>
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span> <span class="o">=</span> <span class="n">IA_TX_BUF_SZ</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">IA_RX_BUF</span> <span class="o">==</span> <span class="n">DFL_RX_BUFFERS</span><span class="p">)</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span> <span class="o">=</span> <span class="n">IA_RX_BUF</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
      <span class="k">else</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span> <span class="o">=</span> <span class="n">IA_RX_BUF</span><span class="p">;</span>
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span> <span class="o">=</span> <span class="n">IA_RX_BUF_SZ</span><span class="p">;</span> 
   <span class="p">}</span> 
   <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_pkt_ram</span> <span class="o">=</span> <span class="n">TX_PACKET_RAM</span> <span class="o">+</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span><span class="p">);</span> 
   <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;BUF: tx=%d,sz=%d rx=%d sz= %d rx_pkt_ram=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
         <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span><span class="p">,</span>
         <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_pkt_ram</span><span class="p">);)</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">   if ((memType &amp; FE_MASK) == FE_SINGLE_MODE) {</span>
<span class="c">      iadev-&gt;phy_type = PHY_OC3C_S;</span>
<span class="c">   else if ((memType &amp; FE_MASK) == FE_UTP_OPTION)</span>
<span class="c">      iadev-&gt;phy_type = PHY_UTP155;</span>
<span class="c">   else</span>
<span class="c">     iadev-&gt;phy_type = PHY_OC3C_M;</span>
<span class="cp">#endif</span>
   
   <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">memType</span> <span class="o">&amp;</span> <span class="n">FE_MASK</span><span class="p">;</span>
   <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;memType = 0x%x iadev-&gt;phy_type = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                         <span class="n">memType</span><span class="p">,</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">);)</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">FE_25MBIT_PHY</span><span class="p">)</span> 
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(((</span><span class="mi">25600000</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mi">26</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">27</span><span class="o">*</span><span class="mi">53</span><span class="p">));</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">FE_DS3_PHY</span><span class="p">)</span>
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(((</span><span class="mi">44736000</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mi">26</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">27</span><span class="o">*</span><span class="mi">53</span><span class="p">));</span>
   <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">FE_E3_PHY</span><span class="p">)</span> 
      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(((</span><span class="mi">34368000</span><span class="o">/</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mi">26</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">27</span><span class="o">*</span><span class="mi">53</span><span class="p">));</span>
   <span class="k">else</span>
       <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">ATM_OC3_PCR</span><span class="p">);</span>
   <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;iadev-&gt;LineRate = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">);)</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">ia_phy_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">iadev_priv</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">ia</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_phy_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">iadev_priv</span> <span class="o">*</span><span class="n">ia</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ia</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_frontend_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">iadev_priv</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">FE_25MBIT_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">MB25_INTR_STATUS</span><span class="p">);</span>
		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">carrier_detect</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MB25_IS_GSB</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">FE_DS3_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">SUNI_DS3_FRM_INTR_STAT</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">SUNI_DS3_FRM_STAT</span><span class="p">);</span>
		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">carrier_detect</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SUNI_DS3_LOSV</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">FE_E3_PHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">SUNI_E3_FRM_MAINT_INTR_IND</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">SUNI_E3_FRM_FRAM_INTR_IND_STAT</span><span class="p">);</span>
		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">carrier_detect</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SUNI_E3_LOS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">SUNI_RSOP_STATUS</span><span class="p">);</span>
		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">carrier_detect</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SUNI_LOSV</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;IA: SUNI carrier %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">carrier_detect</span> <span class="o">?</span> <span class="s">&quot;detected&quot;</span> <span class="o">:</span> <span class="s">&quot;lost signal&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_mb25_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">iadev_priv</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">   mb25-&gt;mb25_master_ctrl = MB25_MC_DRIC | MB25_MC_DREC | MB25_MC_ENABLED;</span>
<span class="cp">#endif</span>
	<span class="n">ia_phy_write32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">MB25_MASTER_CTRL</span><span class="p">,</span> <span class="n">MB25_MC_DRIC</span> <span class="o">|</span> <span class="n">MB25_MC_DREC</span><span class="p">);</span>
	<span class="n">ia_phy_write32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">MB25_DIAG_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">carrier_detect</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">MB25_INTR_STATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MB25_IS_GSB</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">ia_reg</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_phy_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">iadev_priv</span> <span class="o">*</span><span class="n">iadev</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">ia_reg</span> <span class="o">*</span><span class="n">regs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ia_phy_write32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">regs</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_suni_pm7345_init_ds3</span><span class="p">(</span><span class="k">struct</span> <span class="n">iadev_priv</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ia_reg</span> <span class="n">suni_ds3_init</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">SUNI_DS3_FRM_INTR_ENBL</span><span class="p">,</span>	<span class="mh">0x17</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_DS3_FRM_CFG</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_DS3_TRAN_CFG</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_CONFIG</span><span class="p">,</span>			<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_SPLR_CFG</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_SPLT_CFG</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">SUNI_DS3_FRM_STAT</span><span class="p">);</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">carrier_detect</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SUNI_DS3_LOSV</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ia_phy_write</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">suni_ds3_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">suni_ds3_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_suni_pm7345_init_e3</span><span class="p">(</span><span class="k">struct</span> <span class="n">iadev_priv</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ia_reg</span> <span class="n">suni_e3_init</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">SUNI_E3_FRM_FRAM_OPTIONS</span><span class="p">,</span>		<span class="mh">0x04</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_E3_FRM_MAINT_OPTIONS</span><span class="p">,</span>		<span class="mh">0x20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_E3_FRM_FRAM_INTR_ENBL</span><span class="p">,</span>		<span class="mh">0x1d</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_E3_FRM_MAINT_INTR_ENBL</span><span class="p">,</span>		<span class="mh">0x30</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_E3_TRAN_STAT_DIAG_OPTIONS</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_E3_TRAN_FRAM_OPTIONS</span><span class="p">,</span>		<span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_CONFIG</span><span class="p">,</span>				<span class="n">SUNI_PM7345_E3ENBL</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_SPLR_CFG</span><span class="p">,</span>			<span class="mh">0x41</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_SPLT_CFG</span><span class="p">,</span>			<span class="mh">0x41</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">SUNI_E3_FRM_FRAM_INTR_IND_STAT</span><span class="p">);</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">carrier_detect</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SUNI_E3_LOS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ia_phy_write</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">suni_e3_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">suni_e3_init</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_suni_pm7345_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">iadev_priv</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ia_reg</span> <span class="n">suni_init</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Enable RSOP loss of signal interrupt. */</span>
		<span class="p">{</span> <span class="n">SUNI_INTR_ENBL</span><span class="p">,</span>		<span class="mh">0x28</span> <span class="p">},</span>
		<span class="cm">/* Clear error counters. */</span>
		<span class="p">{</span> <span class="n">SUNI_ID_RESET</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>
		<span class="cm">/* Clear &quot;PMCTST&quot; in master test register. */</span>
		<span class="p">{</span> <span class="n">SUNI_MASTER_TEST</span><span class="p">,</span>		<span class="mi">0</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SUNI_RXCP_CTRL</span><span class="p">,</span>		<span class="mh">0x2c</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_FCTRL</span><span class="p">,</span>		<span class="mh">0x81</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SUNI_RXCP_IDLE_PAT_H1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_IDLE_PAT_H2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_IDLE_PAT_H3</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_IDLE_PAT_H4</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SUNI_RXCP_IDLE_MASK_H1</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_IDLE_MASK_H2</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_IDLE_MASK_H3</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_IDLE_MASK_H4</span><span class="p">,</span>	<span class="mh">0xfe</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SUNI_RXCP_CELL_PAT_H1</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_CELL_PAT_H2</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_CELL_PAT_H3</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_CELL_PAT_H4</span><span class="p">,</span>	<span class="mh">0x01</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SUNI_RXCP_CELL_MASK_H1</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_CELL_MASK_H2</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_CELL_MASK_H3</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_RXCP_CELL_MASK_H4</span><span class="p">,</span>	<span class="mh">0xff</span> <span class="p">},</span>

		<span class="p">{</span> <span class="n">SUNI_TXCP_CTRL</span><span class="p">,</span>		<span class="mh">0xa4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_TXCP_INTR_EN_STS</span><span class="p">,</span>	<span class="mh">0x10</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">SUNI_TXCP_IDLE_PAT_H5</span><span class="p">,</span>	<span class="mh">0x55</span> <span class="p">}</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">FE_DS3_PHY</span><span class="p">)</span>
		<span class="n">ia_suni_pm7345_init_ds3</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ia_suni_pm7345_init_e3</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>

	<span class="n">ia_phy_write</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">suni_init</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">suni_init</span><span class="p">));</span>

	<span class="n">ia_phy_write32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">SUNI_CONFIG</span><span class="p">,</span> <span class="n">ia_phy_read32</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">SUNI_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="o">~</span><span class="p">(</span><span class="n">SUNI_PM7345_LLB</span> <span class="o">|</span> <span class="n">SUNI_PM7345_CLB</span> <span class="o">|</span>
		  <span class="n">SUNI_PM7345_DLB</span> <span class="o">|</span> <span class="n">SUNI_PM7345_PLB</span><span class="p">));</span>
<span class="cp">#ifdef __SNMP__</span>
   <span class="n">suni_pm7345</span><span class="o">-&gt;</span><span class="n">suni_rxcp_intr_en_sts</span> <span class="o">|=</span> <span class="n">SUNI_OOCDE</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* __SNMP__ */</span><span class="cp"></span>
   <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/***************************** IA_LIB END *****************************/</span>
    
<span class="cp">#ifdef CONFIG_ATM_IA_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tcnter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">xdump</span><span class="p">(</span> <span class="n">u_char</span><span class="o">*</span>  <span class="n">cp</span><span class="p">,</span> <span class="kt">int</span>  <span class="n">length</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span>  <span class="n">prefix</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">col</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="n">prntBuf</span><span class="p">[</span><span class="mi">120</span><span class="p">];</span>
    <span class="n">u_char</span><span class="o">*</span>  <span class="n">pBuf</span> <span class="o">=</span> <span class="n">prntBuf</span><span class="p">;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">){</span>
        <span class="n">pBuf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span> <span class="n">pBuf</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">prefix</span> <span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">count</span> <span class="o">+</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">col</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">pBuf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span> <span class="n">pBuf</span><span class="p">,</span> <span class="s">&quot; &quot;</span> <span class="p">);</span>
            <span class="n">pBuf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span> <span class="n">pBuf</span><span class="p">,</span> <span class="s">&quot;%02X &quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="k">while</span><span class="p">(</span><span class="n">col</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">){</span>      <span class="cm">/* pad end of buffer with blanks */</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">col</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">sprintf</span><span class="p">(</span> <span class="n">pBuf</span><span class="p">,</span> <span class="s">&quot; &quot;</span> <span class="p">);</span>
            <span class="n">pBuf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span> <span class="n">pBuf</span><span class="p">,</span> <span class="s">&quot;   &quot;</span> <span class="p">);</span>
        <span class="p">}</span>
        <span class="n">pBuf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span> <span class="n">pBuf</span><span class="p">,</span> <span class="s">&quot;  &quot;</span> <span class="p">);</span>
        <span class="k">for</span><span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">count</span> <span class="o">+</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">col</span><span class="o">++</span><span class="p">){</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isprint</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">cp</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="n">col</span><span class="p">]))</span>
                <span class="n">pBuf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span> <span class="n">pBuf</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span> <span class="p">);</span>
            <span class="k">else</span>
                <span class="n">pBuf</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span> <span class="n">pBuf</span><span class="p">,</span> <span class="s">&quot;.&quot;</span> <span class="p">);</span>
                <span class="p">}</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prntBuf</span><span class="p">);</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="n">col</span><span class="p">;</span>
        <span class="n">pBuf</span> <span class="o">=</span> <span class="n">prntBuf</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>  <span class="cm">/* close xdump(... */</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ATM_IA_DEBUG */</span><span class="cp"></span>

  
<span class="k">static</span> <span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">ia_boards</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>  
  
<span class="cp">#define ACTUAL_RAM_BASE \</span>
<span class="cp">	RAM_BASE*((iadev-&gt;mem)/(128 * 1024))  </span>
<span class="cp">#define ACTUAL_SEG_RAM_BASE \</span>
<span class="cp">	IPHASE5575_FRAG_CONTROL_RAM_BASE*((iadev-&gt;mem)/(128 * 1024))  </span>
<span class="cp">#define ACTUAL_REASS_RAM_BASE \</span>
<span class="cp">	IPHASE5575_REASS_CONTROL_RAM_BASE*((iadev-&gt;mem)/(128 * 1024))  </span>
  
  
<span class="cm">/*-- some utilities and memory allocation stuff will come here -------------*/</span>  
  
<span class="k">static</span> <span class="kt">void</span> <span class="nf">desc_dbg</span><span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">u_short</span> <span class="n">tcq_wr_ptr</span><span class="p">,</span> <span class="n">tcq_st_ptr</span><span class="p">,</span> <span class="n">tcq_ed_ptr</span><span class="p">;</span>
  <span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>regval = readl((u32)ia_cmds->maddr);</p></td><td class="code"><div class="highlight"><pre>  <span class="n">tcq_wr_ptr</span> <span class="o">=</span>  <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_WR_PTR</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;B_tcq_wr = 0x%x desc = %d last desc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                     <span class="n">tcq_wr_ptr</span><span class="p">,</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">tcq_wr_ptr</span><span class="p">),</span>
                     <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">tcq_wr_ptr</span><span class="o">-</span><span class="mi">2</span><span class="p">));</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot; host_tcq_wr = 0x%x  host_tcq_rd = 0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span><span class="p">,</span> 
                   <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span><span class="p">);</span>
  <span class="n">tcq_st_ptr</span> <span class="o">=</span>  <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_ST_ADR</span><span class="p">);</span>
  <span class="n">tcq_ed_ptr</span> <span class="o">=</span>  <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_ED_ADR</span><span class="p">);</span>
  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;tcq_st_ptr = 0x%x    tcq_ed_ptr = 0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tcq_st_ptr</span><span class="p">,</span> <span class="n">tcq_ed_ptr</span><span class="p">);</span>
  <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">tcq_st_ptr</span> <span class="o">!=</span> <span class="n">tcq_ed_ptr</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">tmp</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">tcq_st_ptr</span><span class="p">;</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;TCQ slot %d desc = %d  Addr = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">readw</span><span class="p">(</span><span class="n">tmp</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>
      <span class="n">tcq_st_ptr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Desc_tbl[%d] = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timestamp</span><span class="p">);</span>
<span class="p">}</span> 
  
  
<span class="cm">/*----------------------------- Receiving side stuff --------------------------*/</span>  
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_excp_rcvd</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>  
<span class="p">{</span>  
<span class="cp">#if 0</span><span class="c"> /* closing the receiving size will cause too many excp int */  </span>
<span class="c">  IADEV *iadev;  </span>
<span class="c">  u_short state;  </span>
<span class="c">  u_short excpq_rd_ptr;  </span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>u_short *ptr;  </p></td><td class="code"><div class="highlight"><pre><span class="c">  int vci, error = 1;  </span>
<span class="c">  iadev = INPH_IA_DEV(dev);  </span>
<span class="c">  state = readl(iadev-&gt;reass_reg + STATE_REG) &amp; 0xffff;  </span>
<span class="c">  while((state &amp; EXCPQ_EMPTY) != EXCPQ_EMPTY)  </span>
<span class="c">  { printk(&quot;state = %x \n&quot;, state); </span>
<span class="c">        excpq_rd_ptr = readw(iadev-&gt;reass_reg + EXCP_Q_RD_PTR) &amp; 0xffff;  </span>
<span class="c"> printk(&quot;state = %x excpq_rd_ptr = %x \n&quot;, state, excpq_rd_ptr); </span>
<span class="c">        if (excpq_rd_ptr == *(u16*)(iadev-&gt;reass_reg + EXCP_Q_WR_PTR))</span>
<span class="c">            IF_ERR(printk(&quot;excpq_rd_ptr is wrong!!!\n&quot;);)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>TODO: update exception stat</p></td><td class="code"><div class="highlight"><pre><span class="c">	vci = readw(iadev-&gt;reass_ram+excpq_rd_ptr);  </span>
<span class="c">	error = readw(iadev-&gt;reass_ram+excpq_rd_ptr+2) &amp; 0x0007;  </span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>pwang_test</p></td><td class="code"><div class="highlight"><pre><span class="c">	excpq_rd_ptr += 4;  </span>
<span class="c">	if (excpq_rd_ptr &gt; (readw(iadev-&gt;reass_reg + EXCP_Q_ED_ADR)&amp; 0xffff))  </span>
<span class="c"> 	    excpq_rd_ptr = readw(iadev-&gt;reass_reg + EXCP_Q_ST_ADR)&amp; 0xffff;</span>
<span class="c">	writew( excpq_rd_ptr, iadev-&gt;reass_reg + EXCP_Q_RD_PTR);  </span>
<span class="c">        state = readl(iadev-&gt;reass_reg + STATE_REG) &amp; 0xffff;  </span>
<span class="c">  }  </span>
<span class="cp">#endif</span>
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">desc</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
        <span class="n">writew</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_wr</span><span class="p">);</span> 
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_wr</span> <span class="o">+=</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_wr</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_ed</span><span class="p">)</span>
		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_wr</span> <span class="o">=</span>  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_st</span><span class="p">;</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_wr</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_WR_PTR</span><span class="p">);</span>  
<span class="p">}</span>  
  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>  
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">rx_buf_desc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf_desc_ptr</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">desc</span><span class="p">;</span>   
	<span class="k">struct</span> <span class="n">dle</span><span class="o">*</span> <span class="n">wr_ptr</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>  
	<span class="n">u_int</span> <span class="n">buf_addr</span><span class="p">,</span> <span class="n">dma_addr</span><span class="p">;</span>  

	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_rd</span> <span class="o">==</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_WR_PTR</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">))</span> 
	<span class="p">{</span>  
   	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d) Receive queue empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>  
	    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>  
	<span class="p">}</span>  
	<span class="cm">/* mask 1st 3 bits to get the actual descno. */</span>  
	<span class="n">desc</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_rd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>  
        <span class="n">IF_RX</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;reass_ram = %p iadev-&gt;rfL.pcq_rd = 0x%x desc = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_rd</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
              <span class="n">printk</span><span class="p">(</span><span class="s">&quot; pcq_wr_ptr = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                               <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_WR_PTR</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">);)</span>
	<span class="cm">/* update the read pointer  - maybe we shud do this in the end*/</span>  
	<span class="k">if</span> <span class="p">(</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_rd</span><span class="o">==</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_ed</span><span class="p">)</span> 
		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_rd</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_st</span><span class="p">;</span>  
	<span class="k">else</span>  
		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_rd</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_rd</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_RD_PTR</span><span class="p">);</span>  
  
	<span class="cm">/* get the buffer desc entry.  </span>
<span class="cm">		update stuff. - doesn&#39;t seem to be any update necessary  </span>
<span class="cm">	*/</span>  
	<span class="n">buf_desc_ptr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">RX_DESC_BASE_ADDR</span><span class="p">;</span>
	<span class="cm">/* make the ptr point to the corresponding buffer desc entry */</span>  
	<span class="n">buf_desc_ptr</span> <span class="o">+=</span> <span class="n">desc</span><span class="p">;</span>	  
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span><span class="p">)</span> <span class="o">||</span> 
                      <span class="p">((</span><span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">vc_index</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="p">))</span> <span class="p">{</span> 
            <span class="n">free_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
            <span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: bad descriptor desc = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);)</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">vcc</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_open</span><span class="p">[</span><span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">vc_index</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">];</span>  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc</span><span class="p">)</span>  
	<span class="p">{</span>      
                <span class="n">free_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span> 
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: null vcc, drop PDU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>  
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  
	<span class="p">}</span>  
	  
  
	<span class="cm">/* might want to check the status bits for errors */</span>  
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">desc_mode</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_CER</span> <span class="o">|</span> <span class="n">RX_PTE</span> <span class="o">|</span> <span class="n">RX_OFL</span><span class="p">))</span>  
	<span class="p">{</span>  
                <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
		<span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: bad packet, dropping it&quot;</span><span class="p">);)</span>  
                <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_CER</span><span class="p">)</span> <span class="p">{</span> 
                    <span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot; cause: packet CRC error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_PTE</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot; cause: packet time out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot; cause: buffer overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
                <span class="p">}</span>
		<span class="k">goto</span> <span class="n">out_free_desc</span><span class="p">;</span>
	<span class="p">}</span>  
  
	<span class="cm">/*  </span>
<span class="cm">		build DLE.	  </span>
<span class="cm">	*/</span>  
  
	<span class="n">buf_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_lo</span><span class="p">;</span>  
	<span class="n">dma_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">dma_start_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">dma_start_lo</span><span class="p">;</span>  
	<span class="n">len</span> <span class="o">=</span> <span class="n">dma_addr</span> <span class="o">-</span> <span class="n">buf_addr</span><span class="p">;</span>  
        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Over %d bytes sdu received, dropped!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">);</span>
           <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
	   <span class="k">goto</span> <span class="n">out_free_desc</span><span class="p">;</span>
        <span class="p">}</span>
		  
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">atm_alloc_charge</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">)))</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
              <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Drop control packets</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	      <span class="k">goto</span> <span class="n">out_free_desc</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>  </pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>pwang_test</p></td><td class="code"><div class="highlight"><pre>        <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
        <span class="n">ATM_DESC</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>        
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dma_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>  

	<span class="cm">/* Build the DLE structure */</span>  
	<span class="n">wr_ptr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">write</span><span class="p">;</span>  
	<span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">sys_pkt_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		<span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">local_pkt_addr</span> <span class="o">=</span> <span class="n">buf_addr</span><span class="p">;</span>  
	<span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>	<span class="cm">/* We don&#39;t know this do we ?? */</span>  
	<span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">DMA_INT_ENABLE</span><span class="p">;</span>  
  
	<span class="cm">/* shud take care of wrap around here too. */</span>  
        <span class="k">if</span><span class="p">(</span><span class="o">++</span><span class="n">wr_ptr</span> <span class="o">==</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>
             <span class="n">wr_ptr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">wr_ptr</span><span class="p">;</span>  
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>  
	<span class="cm">/* Increment transaction counter */</span>  
	<span class="n">writel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">+</span><span class="n">IPHASE5575_RX_COUNTER</span><span class="p">);</span>   
<span class="nl">out:</span>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="nl">out_free_desc:</span>
        <span class="n">free_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>  
<span class="p">{</span>  
  <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
  <span class="n">u_short</span> <span class="n">status</span><span class="p">;</span>  
  <span class="n">u_short</span> <span class="n">state</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>  
  
  <span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
  <span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_INTR_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>  
  <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;rx_intr: status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_PKT_RCVD</span><span class="p">)</span>  
  <span class="p">{</span>  
	<span class="cm">/* do something */</span>  
	<span class="cm">/* Basically recvd an interrupt for receiving a packet.  </span>
<span class="cm">	A descriptor would have been written to the packet complete   </span>
<span class="cm">	queue. Get all the descriptors and set up dma to move the   </span>
<span class="cm">	packets till the packet complete queue is empty..  </span>
<span class="cm">	*/</span>  
	<span class="n">state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span> <span class="o">+</span> <span class="n">STATE_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>  
        <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Rx intr status: RX_PKT_RCVD %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);)</span> 
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">PCQ_EMPTY</span><span class="p">))</span>  
	<span class="p">{</span>  
             <span class="n">rx_pkt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	     <span class="n">state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span> <span class="o">+</span> <span class="n">STATE_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>  
	<span class="p">}</span>  
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rxing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>  
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_FREEQ_EMPT</span><span class="p">)</span>  
  <span class="p">{</span>   
     <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_tmp_cnt</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_pkt_cnt</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_tmp_jif</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> 
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rxing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
     <span class="p">}</span> 
     <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_tmp_jif</span> <span class="o">+</span> <span class="mi">50</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
               <span class="p">((</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_pkt_cnt</span> <span class="o">-</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_tmp_cnt</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
               <span class="n">free_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Test logic RUN!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span> <span class="o">~</span><span class="p">(</span><span class="n">RX_FREEQ_EMPT</span><span class="o">|</span><span class="n">RX_EXCP_RCVD</span><span class="p">),</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_MASK_REG</span><span class="p">);</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rxing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Rx intr status: RX_FREEQ_EMPT %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);)</span>  
  <span class="p">}</span>  

  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_EXCP_RCVD</span><span class="p">)</span>  
  <span class="p">{</span>  
	<span class="cm">/* probably need to handle the exception queue also. */</span>  
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Rx intr status: RX_EXCP_RCVD %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);)</span>  
	<span class="n">rx_excp_rcvd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
  <span class="p">}</span>  


  <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RX_RAW_RCVD</span><span class="p">)</span>  
  <span class="p">{</span>  
	<span class="cm">/* need to handle the raw incoming cells. This deepnds on   </span>
<span class="cm">	whether we have programmed to receive the raw cells or not.  </span>
<span class="cm">	Else ignore. */</span>  
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Rx intr status:  RX_RAW_RCVD %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);)</span>  
  <span class="p">}</span>  
<span class="p">}</span>  
  
  
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_dle_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>  
<span class="p">{</span>  
  <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
  <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>   
  <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>  
  <span class="kt">int</span> <span class="n">desc</span><span class="p">;</span>  
  <span class="n">u_short</span> <span class="n">state</span><span class="p">;</span>   
  <span class="k">struct</span> <span class="n">dle</span> <span class="o">*</span><span class="n">dle</span><span class="p">,</span> <span class="o">*</span><span class="n">cur_dle</span><span class="p">;</span>  
  <span class="n">u_int</span> <span class="n">dle_lp</span><span class="p">;</span>  
  <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
 
  <span class="cm">/* free all the dles done, that is just update our own dle read pointer   </span>
<span class="cm">	- do we really need to do this. Think not. */</span>  
  <span class="cm">/* DMA is done, just get all the recevie buffers from the rx dma queue  </span>
<span class="cm">	and push them up to the higher layer protocol. Also free the desc  </span>
<span class="cm">	associated with the buffer. */</span>  
  <span class="n">dle</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">read</span><span class="p">;</span>  
  <span class="n">dle_lp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">+</span><span class="n">IPHASE5575_RX_LIST_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="p">)</span><span class="o">*</span><span class="n">DLE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>  
  <span class="n">cur_dle</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">dle_lp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>  
  <span class="k">while</span><span class="p">(</span><span class="n">dle</span> <span class="o">!=</span> <span class="n">cur_dle</span><span class="p">)</span>  
  <span class="p">{</span>  
      <span class="cm">/* free the DMAed skb */</span>  
      <span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dma_q</span><span class="p">);</span>  
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>  
         <span class="k">goto</span> <span class="n">INCR_DLE</span><span class="p">;</span>
      <span class="n">desc</span> <span class="o">=</span> <span class="n">ATM_DESC</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
      <span class="n">free_desc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>  
               
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
      <span class="p">{</span>  
          <span class="n">printk</span><span class="p">(</span><span class="s">&quot;rx_dle_intr: skb len 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>  
	  <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>  
      <span class="p">}</span>  
      <span class="k">else</span>  
      <span class="p">{</span>  
          <span class="k">struct</span> <span class="n">cpcs_trailer</span> <span class="o">*</span><span class="n">trailer</span><span class="p">;</span>
          <span class="n">u_short</span> <span class="n">length</span><span class="p">;</span>
          <span class="k">struct</span> <span class="n">ia_vcc</span> <span class="o">*</span><span class="n">ia_vcc</span><span class="p">;</span>

	  <span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">write</span><span class="o">-&gt;</span><span class="n">sys_pkt_addr</span><span class="p">,</span>
	  	<span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
          <span class="cm">/* no VCC related housekeeping done as yet. lets see */</span>  
          <span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
	  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
	      <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: null vcc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>  
              <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
              <span class="k">goto</span> <span class="n">INCR_DLE</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">ia_vcc</span> <span class="o">=</span> <span class="n">INPH_IA_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">ia_vcc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
          <span class="p">{</span>
             <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
             <span class="n">atm_return</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>
             <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
             <span class="k">goto</span> <span class="n">INCR_DLE</span><span class="p">;</span>
           <span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>get real pkt length  pwang_test</p></td><td class="code"><div class="highlight"><pre>          <span class="n">trailer</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cpcs_trailer</span><span class="o">*</span><span class="p">)((</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
                                 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">trailer</span><span class="p">));</span>
	  <span class="n">length</span> <span class="o">=</span> <span class="n">swap_byte_order</span><span class="p">(</span><span class="n">trailer</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> 
                              <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpcs_trailer</span><span class="p">))))</span>
          <span class="p">{</span>
             <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_err</span><span class="p">);</span>
             <span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;rx_dle_intr: Bad  AAL5 trailer %d (skb len %d)&quot;</span><span class="p">,</span> 
                                                            <span class="n">length</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);)</span>
             <span class="n">atm_return</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">truesize</span><span class="p">);</span>
             <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
             <span class="k">goto</span> <span class="n">INCR_DLE</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
          
	  <span class="cm">/* Display the packet */</span>  
	  <span class="n">IF_RXPKT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Dmad Recvd data: len = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>  
          <span class="n">xdump</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;RX: &quot;</span><span class="p">);</span>
          <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>

	  <span class="n">IF_RX</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;rx_dle_intr: skb push&quot;</span><span class="p">);)</span>  
	  <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">push</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span><span class="n">skb</span><span class="p">);</span>  
	  <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">);</span>
          <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_pkt_cnt</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span>  
<span class="nl">INCR_DLE:</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">dle</span> <span class="o">==</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>  
    	  <span class="n">dle</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>  
  <span class="p">}</span>  
  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dle</span><span class="p">;</span>  
  
  <span class="cm">/* if the interrupts are masked because there were no free desc available,  </span>
<span class="cm">		unmask them now. */</span> 
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="p">)</span> <span class="p">{</span>
     <span class="n">state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span> <span class="o">+</span> <span class="n">STATE_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FREEQ_EMPTY</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span> <span class="o">+</span> <span class="n">REASS_MASK_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
        <span class="n">writel</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">RX_FREEQ_EMPT</span> <span class="o">|</span><span class="cm">/* RX_EXCP_RCVD |*/</span> <span class="n">RX_PKT_RCVD</span><span class="p">),</span>
                                      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_MASK_REG</span><span class="p">);</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rxing</span><span class="o">++</span><span class="p">;</span> 
     <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>  
  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="n">u_short</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">vc_table</span><span class="p">;</span>  
	<span class="n">u_short</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reass_ptr</span><span class="p">;</span>  
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;iadev: open_rx %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);)</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>    
	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>  
        <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_ABR</span><span class="p">)</span> <span class="p">{</span>  
           <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">FE_25MBIT_PHY</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA:  ABR not support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
               <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> 
           <span class="p">}</span>
        <span class="p">}</span>
	<span class="cm">/* Make only this VCI in the vc table valid and let all   </span>
<span class="cm">		others be invalid entries */</span>  
	<span class="n">vc_table</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">RX_VC_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
	<span class="n">vc_table</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
	<span class="cm">/* mask the last 6 bits and OR it with 3 for 1K VCs */</span>  

        <span class="o">*</span><span class="n">vc_table</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="cm">/* Also keep a list of open rx vcs so that we can attach them with  </span>
<span class="cm">		incoming PDUs later. */</span>  
	<span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_ABR</span><span class="p">)</span> <span class="o">||</span> 
                                <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_ABR</span><span class="p">))</span>  
	<span class="p">{</span>  
                <span class="n">srv_cls_param_t</span> <span class="n">srv_p</span><span class="p">;</span>
                <span class="n">init_abr_vc</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srv_p</span><span class="p">);</span>
                <span class="n">ia_open_abr_vc</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srv_p</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> 
       	<span class="k">else</span> <span class="p">{</span>  <span class="cm">/* for UBR  later may need to add CBR logic */</span>
        	<span class="n">reass_ptr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">REASS_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
           	<span class="n">reass_ptr</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
           	<span class="o">*</span><span class="n">reass_ptr</span> <span class="o">=</span> <span class="n">NO_AAL5_PKT</span><span class="p">;</span>
       	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_open</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">])</span>  
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): VCI %d already open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  
			<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_open</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">rx_buf_desc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf_desc_ptr</span><span class="p">;</span>  
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rx_pkt_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
	<span class="kt">void</span> <span class="o">*</span><span class="n">dle_addr</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">abr_vc_table</span>  <span class="o">*</span><span class="n">abr_vc_table</span><span class="p">;</span> 
	<span class="n">u16</span> <span class="o">*</span><span class="n">vc_table</span><span class="p">;</span>  
	<span class="n">u16</span> <span class="o">*</span><span class="n">reass_table</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">vcsize_sel</span><span class="p">;</span>  
	<span class="n">u_short</span> <span class="n">freeq_st_adr</span><span class="p">;</span>  
	<span class="n">u_short</span> <span class="o">*</span><span class="n">freeq_start</span><span class="p">;</span>  
  
	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  </pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>spin<em>lock</em>init(&amp;iadev->rx_lock); </p></td><td class="code"><div class="highlight"><pre>  
	<span class="cm">/* Allocate 4k bytes - more aligned than needed (4k boundary) */</span>
	<span class="n">dle_addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">DLE_TOTAL_SIZE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_dma</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dle_addr</span><span class="p">)</span>  <span class="p">{</span>  
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;can&#39;t allocate DLEs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dle</span> <span class="o">*</span><span class="p">)</span><span class="n">dle_addr</span><span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dle_addr</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="p">)</span><span class="o">*</span><span class="n">DLE_ENTRIES</span><span class="p">);</span>
	<span class="cm">/* the end of the dle q points to the entry after the last  </span>
<span class="cm">	DLE that can be used. */</span>  
  
	<span class="cm">/* write the upper 20 bits of the start address to rx list address register */</span>  
	<span class="cm">/* We know this is 32bit bus addressed so the following is safe */</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_dma</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">,</span>
	       <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="n">IPHASE5575_RX_LIST_ADDR</span><span class="p">);</span>  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Tx Dle list addr: 0x%p value: 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">+</span><span class="n">IPHASE5575_TX_LIST_ADDR</span><span class="p">,</span>
                      <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="n">IPHASE5575_TX_LIST_ADDR</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Rx Dle list addr: 0x%p value: 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                      <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">+</span><span class="n">IPHASE5575_RX_LIST_ADDR</span><span class="p">,</span>
                      <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="n">IPHASE5575_RX_LIST_ADDR</span><span class="p">));)</span>
  
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_MASK_REG</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">MODE_REG</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">RESET_REASS</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_COMMAND_REG</span><span class="p">);</span>  
  
	<span class="cm">/* Receive side control memory map  </span>
<span class="cm">	   -------------------------------  </span>
<span class="cm">  </span>
<span class="cm">		Buffer descr	0x0000 (736 - 23K)  </span>
<span class="cm">		VP Table	0x5c00 (256 - 512)  </span>
<span class="cm">		Except q	0x5e00 (128 - 512)  </span>
<span class="cm">		Free buffer q	0x6000 (1K - 2K)  </span>
<span class="cm">		Packet comp q	0x6800 (1K - 2K)  </span>
<span class="cm">		Reass Table	0x7000 (1K - 2K)  </span>
<span class="cm">		VC Table	0x7800 (1K - 2K)  </span>
<span class="cm">		ABR VC Table	0x8000 (1K - 32K)  </span>
<span class="cm">	*/</span>  
	  
	<span class="cm">/* Base address for Buffer Descriptor Table */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">RX_DESC_BASE</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_DESC_BASE</span><span class="p">);</span>  
	<span class="cm">/* Set the buffer size register */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">BUF_SIZE</span><span class="p">);</span>  
  
	<span class="cm">/* Initialize each entry in the Buffer Descriptor Table */</span>  
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">RX_DESC_BASE_ADDR</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">RX_DESC_BASE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
	<span class="n">buf_desc_ptr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">RX_DESC_BASE_ADDR</span><span class="p">;</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">buf_desc_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buf_desc_ptr</span><span class="p">));</span>
	<span class="n">buf_desc_ptr</span><span class="o">++</span><span class="p">;</span>  
	<span class="n">rx_pkt_start</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_pkt_ram</span><span class="p">;</span>  
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="n">memset_io</span><span class="p">(</span><span class="n">buf_desc_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buf_desc_ptr</span><span class="p">));</span>  
		<span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_hi</span> <span class="o">=</span> <span class="n">rx_pkt_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>  
		<span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_lo</span> <span class="o">=</span> <span class="n">rx_pkt_start</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>  
		<span class="n">buf_desc_ptr</span><span class="o">++</span><span class="p">;</span>		  
		<span class="n">rx_pkt_start</span> <span class="o">+=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">;</span>  
	<span class="p">}</span>  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Rx Buffer desc ptr: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf_desc_ptr</span><span class="p">);)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">FREE_BUF_DESC_Q</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span> 
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_QUEUE_BASE</span><span class="p">);</span> 
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_ST_ADR</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_short</span><span class="p">),</span> 
                                         <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_ED_ADR</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_RD_PTR</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_short</span><span class="p">),</span> 
                                        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_WR_PTR</span><span class="p">);</span>    
	<span class="cm">/* Fill the FREEQ with all the free descriptors. */</span>  
	<span class="n">freeq_st_adr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_ST_ADR</span><span class="p">);</span>  
	<span class="n">freeq_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">freeq_st_adr</span><span class="p">);</span>  
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="o">*</span><span class="n">freeq_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>  
		<span class="n">freeq_start</span><span class="o">++</span><span class="p">;</span>  
	<span class="p">}</span>  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;freeq_start: 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freeq_start</span><span class="p">);)</span>
        <span class="cm">/* Packet Complete Queue */</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">PKT_COMP_Q</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_ST_ADR</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_short</span><span class="p">),</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_ED_ADR</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_RD_PTR</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_WR_PTR</span><span class="p">);</span>

        <span class="cm">/* Exception Queue */</span>
        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">EXCEPTION_Q</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">EXCP_Q_ST_ADR</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">NUM_RX_EXCP</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RX_ERROR_Q</span><span class="p">),</span> 
                                             <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">EXCP_Q_ED_ADR</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">EXCP_Q_RD_PTR</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">EXCP_Q_WR_PTR</span><span class="p">);</span> 
 
    	<span class="cm">/* Load local copy of FREEQ and PCQ ptrs */</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_st</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_ST_ADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
       	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_ed</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_ED_ADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span> <span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_rd</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_RD_PTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">fdq_wr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">FREEQ_WR_PTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_st</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_ST_ADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_ed</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_ED_ADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_rd</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_RD_PTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_wr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PCQ_WR_PTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	
        <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;INIT:pcq_st:0x%x pcq_ed:0x%x pcq_rd:0x%x pcq_wr:0x%x&quot;</span><span class="p">,</span> 
              <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_st</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_ed</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_rd</span><span class="p">,</span> 
              <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rfL</span><span class="p">.</span><span class="n">pcq_wr</span><span class="p">);)</span>		  
	<span class="cm">/* just for check - no VP TBL */</span>  
	<span class="cm">/* VP Table */</span>  
	<span class="cm">/* writew(0x0b80, iadev-&gt;reass_reg+VP_LKUP_BASE); */</span>  
	<span class="cm">/* initialize VP Table for invalid VPIs  </span>
<span class="cm">		- I guess we can write all 1s or 0x000f in the entire memory  </span>
<span class="cm">		  space or something similar.  </span>
<span class="cm">	*/</span>  
  
	<span class="cm">/* This seems to work and looks right to me too !!! */</span>  
        <span class="n">i</span> <span class="o">=</span>  <span class="n">REASS_TABLE</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">((</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">),</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_TABLE_BASE</span><span class="p">);</span>   
 	<span class="cm">/* initialize Reassembly table to I don&#39;t know what ???? */</span>  
	<span class="n">reass_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>  
        <span class="n">j</span> <span class="o">=</span> <span class="n">REASS_TABLE_SZ</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
		<span class="o">*</span><span class="n">reass_table</span><span class="o">++</span> <span class="o">=</span> <span class="n">NO_AAL5_PKT</span><span class="p">;</span>  
       <span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
       <span class="n">vcsize_sel</span> <span class="o">=</span>  <span class="mi">0</span><span class="p">;</span>
       <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">i</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="n">vcsize_sel</span><span class="o">++</span><span class="p">;</span>
       <span class="p">}</span>
       <span class="n">i</span> <span class="o">=</span> <span class="n">RX_VC_TABLE</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
       <span class="n">writew</span><span class="p">(((</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff8</span><span class="p">)</span> <span class="o">|</span> <span class="n">vcsize_sel</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">VC_LKUP_BASE</span><span class="p">);</span>
       <span class="n">vc_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">RX_VC_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">);</span>  
        <span class="n">j</span> <span class="o">=</span> <span class="n">RX_VC_TABLE_SZ</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="cm">/* shift the reassembly pointer by 3 + lower 3 bits of   </span>
<span class="cm">		vc_lkup_base register (=3 for 1K VCs) and the last byte   </span>
<span class="cm">		is those low 3 bits.   </span>
<span class="cm">		Shall program this later.  </span>
<span class="cm">		*/</span>  
		<span class="o">*</span><span class="n">vc_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">15</span><span class="p">;</span>	<span class="cm">/* for invalid VCI */</span>  
		<span class="n">vc_table</span><span class="o">++</span><span class="p">;</span>  
	<span class="p">}</span>  
        <span class="cm">/* ABR VC table */</span>
        <span class="n">i</span> <span class="o">=</span>  <span class="n">ABR_VC_TABLE</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">ABR_LKUP_BASE</span><span class="p">);</span>
                   
        <span class="n">i</span> <span class="o">=</span> <span class="n">ABR_VC_TABLE</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
	<span class="n">abr_vc_table</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">abr_vc_table</span> <span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>  
        <span class="n">j</span> <span class="o">=</span> <span class="n">REASS_TABLE_SZ</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
        <span class="n">memset</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">abr_vc_table</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">abr_vc_table</span><span class="p">));</span>
    	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>   		
		<span class="n">abr_vc_table</span><span class="o">-&gt;</span><span class="n">rdf</span> <span class="o">=</span> <span class="mh">0x0003</span><span class="p">;</span>
             	<span class="n">abr_vc_table</span><span class="o">-&gt;</span><span class="n">air</span> <span class="o">=</span> <span class="mh">0x5eb1</span><span class="p">;</span>
	       	<span class="n">abr_vc_table</span><span class="o">++</span><span class="p">;</span>   	
        <span class="p">}</span>  

	<span class="cm">/* Initialize other registers */</span>  
  
	<span class="cm">/* VP Filter Register set for VC Reassembly only */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xff00</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">VP_FILTER</span><span class="p">);</span>  
        <span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">XTRA_RM_OFFSET</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="mh">0x1</span><span class="p">,</span>  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PROTOCOL_ID</span><span class="p">);</span>

	<span class="cm">/* Packet Timeout Count  related Registers : </span>
<span class="cm">	   Set packet timeout to occur in about 3 seconds</span>
<span class="cm">	   Set Packet Aging Interval count register to overflow in about 4 us</span>
<span class="cm"> 	*/</span>  
        <span class="n">writew</span><span class="p">(</span><span class="mh">0xF6F8</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">PKT_TM_CNT</span> <span class="p">);</span>

        <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">|=</span> <span class="p">((</span><span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">TMOUT_RANGE</span><span class="p">);</span>

        <span class="cm">/* initiate the desc_tble */</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* to clear the interrupt status register - read it */</span>  
	<span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_INTR_STATUS_REG</span><span class="p">);</span>   
  
	<span class="cm">/* Mask Register - clear it */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">RX_FREEQ_EMPT</span><span class="o">|</span><span class="n">RX_PKT_RCVD</span><span class="p">),</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_MASK_REG</span><span class="p">);</span>  
  
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dma_q</span><span class="p">);</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_free_desc_qhead</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>   

	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_open</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;itf %d couldn&#39;t get free page</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>  
		<span class="k">goto</span> <span class="n">err_free_dle</span><span class="p">;</span>
	<span class="p">}</span>  

        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rxing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_pkt_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Mode Register */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">R_ONLINE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">MODE_REG</span><span class="p">);</span>  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  

<span class="nl">err_free_dle:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">DLE_TOTAL_SIZE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
			    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_dma</span><span class="p">);</span>  
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>  
  

<span class="cm">/*  </span>
<span class="cm">	The memory map suggested in appendix A and the coding for it.   </span>
<span class="cm">	Keeping it around just in case we change our mind later.  </span>
<span class="cm">  </span>
<span class="cm">		Buffer descr	0x0000 (128 - 4K)  </span>
<span class="cm">		UBR sched	0x1000 (1K - 4K)  </span>
<span class="cm">		UBR Wait q	0x2000 (1K - 4K)  </span>
<span class="cm">		Commn queues	0x3000 Packet Ready, Trasmit comp(0x3100)  </span>
<span class="cm">					(128 - 256) each  </span>
<span class="cm">		extended VC	0x4000 (1K - 8K)  </span>
<span class="cm">		ABR sched	0x6000	and ABR wait queue (1K - 2K) each  </span>
<span class="cm">		CBR sched	0x7000 (as needed)  </span>
<span class="cm">		VC table	0x8000 (1K - 32K)  </span>
<span class="cm">*/</span>  
  
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">status</span><span class="p">;</span>  
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
  
	<span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_INTR_STATUS_REG</span><span class="p">);</span>  
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TRANSMIT_DONE</span><span class="p">){</span>

           <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Tansmit Done Intr logic run</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
           <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
           <span class="n">ia_tx_poll</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
           <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
           <span class="n">writew</span><span class="p">(</span><span class="n">TRANSMIT_DONE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_INTR_STATUS_REG</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">close_pending</span><span class="p">)</span>  
               <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
        <span class="p">}</span>     	  
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TCQ_NOT_EMPTY</span><span class="p">)</span>  
	<span class="p">{</span>  
	    <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;TCQ_NOT_EMPTY int received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
	<span class="p">}</span>  
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_dle_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">dle</span> <span class="o">*</span><span class="n">dle</span><span class="p">,</span> <span class="o">*</span><span class="n">cur_dle</span><span class="p">;</span> 
        <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ia_vcc</span>  <span class="o">*</span><span class="n">iavcc</span><span class="p">;</span>
        <span class="n">u_int</span> <span class="n">dle_lp</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

        <span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>   
        <span class="n">dle</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">read</span><span class="p">;</span>
        <span class="n">dle_lp</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">+</span><span class="n">IPHASE5575_TX_LIST_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> 
                                        <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="p">)</span><span class="o">*</span><span class="n">DLE_ENTRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
        <span class="n">cur_dle</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">dle_lp</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">dle</span> <span class="o">!=</span> <span class="n">cur_dle</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="cm">/* free the DMAed skb */</span> 
            <span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dma_q</span><span class="p">);</span> 
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

	    <span class="cm">/* Revenge of the 2 dle (skb + trailer) used in ia_pkt_tx() */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">dle</span> <span class="o">-</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">dle</span><span class="o">-&gt;</span><span class="n">sys_pkt_addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	    <span class="p">}</span>
            <span class="n">vcc</span> <span class="o">=</span> <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;tx_dle_intr: vcc is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                  <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

                  <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">iavcc</span> <span class="o">=</span> <span class="n">INPH_IA_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iavcc</span><span class="p">)</span> <span class="p">{</span>
                  <span class="n">printk</span><span class="p">(</span><span class="s">&quot;tx_dle_intr: iavcc is null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		  <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                  <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
                  <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">&gt;=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rate_limit</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
               <span class="p">{</span>     
                 <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
               <span class="p">}</span> 
               <span class="k">else</span> <span class="p">{</span>
                 <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
               <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Hold the rate-limited skb for flow control */</span>
               <span class="n">IA_SKB_STATE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">|=</span> <span class="n">IA_DLED</span><span class="p">;</span>
               <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iavcc</span><span class="o">-&gt;</span><span class="n">txing_skb</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;tx_dle_intr: enque skb = 0x%p </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);)</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">dle</span> <span class="o">==</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>
                 <span class="n">dle</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">dle</span><span class="p">;</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">open_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="k">struct</span> <span class="n">ia_vcc</span> <span class="o">*</span><span class="n">ia_vcc</span><span class="p">;</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">main_vc</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">ext_vc</span> <span class="o">*</span><span class="n">evc</span><span class="p">;</span>  
        <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;iadev: open_tx entered vcc-&gt;vci = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);)</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>  
        
        <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">FE_25MBIT_PHY</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_ABR</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA:  ABR not support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
               <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> 
           <span class="p">}</span>
	  <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA:  CBR not support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
               <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> 
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">ia_vcc</span> <span class="o">=</span>  <span class="n">INPH_IA_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">ia_vcc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ia_vcc</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">&gt;</span> 
                         <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpcs_trailer</span><span class="p">))){</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA:  SDU size over (%d) the configured SDU size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span><span class="p">,</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span><span class="p">);</span>
	   <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
           <span class="n">kfree</span><span class="p">(</span><span class="n">ia_vcc</span><span class="p">);</span>
           <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> 
        <span class="p">}</span>
	<span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">vc_desc_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">txing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

        <span class="cm">/* find pcr */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">==</span> <span class="n">ATM_MAX_PCR</span><span class="p">)</span> 
           <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span>
           <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&gt;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> 
           <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">)</span>
             <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">;</span>
        <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="p">)</span> <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">ltimeout</span> <span class="o">=</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span> <span class="o">/</span> <span class="mi">130</span><span class="p">))</span> <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">ltimeout</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">&lt;=</span> <span class="mi">170</span><span class="p">)</span> <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">ltimeout</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
        <span class="k">else</span> <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">ltimeout</span> <span class="o">=</span> <span class="mi">2700</span> <span class="o">*</span> <span class="n">HZ</span>  <span class="o">/</span> <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">&lt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rate_limit</span><span class="p">)</span>
           <span class="n">skb_queue_head_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">txing_skb</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">&lt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rate_limit</span><span class="p">)</span> <span class="p">{</span>
	   <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sk_atm</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>

	   <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">(</span><span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="mi">60000</span><span class="p">)</span>
                  <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
               <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">)</span>
                  <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
               <span class="k">else</span>
                 <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_sdu</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
           <span class="p">}</span>
           <span class="k">else</span>
             <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_sndbuf</span> <span class="o">=</span> <span class="mi">24576</span><span class="p">;</span>
        <span class="p">}</span>
           
	<span class="n">vc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">main_vc</span> <span class="o">*</span><span class="p">)</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">MAIN_VC_TABLE_ADDR</span><span class="p">;</span>  
	<span class="n">evc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext_vc</span> <span class="o">*</span><span class="p">)</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">EXT_VC_TABLE_ADDR</span><span class="p">;</span>  
	<span class="n">vc</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>  
	<span class="n">evc</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>  
	<span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vc</span><span class="p">));</span>  
	<span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">evc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">evc</span><span class="p">));</span>  
	  
	<span class="cm">/* store the most significant 4 bits of vci as the last 4 bits   </span>
<span class="cm">		of first part of atm header.  </span>
<span class="cm">	   store the last 12 bits of vci as first 12 bits of the second  </span>
<span class="cm">		part of the atm header.  </span>
<span class="cm">	*/</span>  
	<span class="n">evc</span><span class="o">-&gt;</span><span class="n">atm_hdr1</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000f</span><span class="p">;</span>  
	<span class="n">evc</span><span class="o">-&gt;</span><span class="n">atm_hdr2</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>  
 
	<span class="cm">/* check the following for different traffic classes */</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_UBR</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">UBR</span><span class="p">;</span>  
                <span class="n">vc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">CRC_APPEND</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">-&gt;</span><span class="n">acr</span> <span class="o">=</span> <span class="n">cellrate_to_float</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">);</span>  
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
                   <span class="n">vc</span><span class="o">-&gt;</span><span class="n">acr</span> <span class="o">=</span> <span class="n">cellrate_to_float</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span><span class="p">);</span>  
                <span class="n">IF_UBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;UBR: txtp.pcr = 0x%x f_rate = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                             <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span><span class="p">,</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">acr</span><span class="p">);)</span>
	<span class="p">}</span>  
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_ABR</span><span class="p">)</span>  
	<span class="p">{</span>       <span class="n">srv_cls_param_t</span> <span class="n">srv_p</span><span class="p">;</span>
		<span class="n">IF_ABR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Tx ABR VCC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
                <span class="n">init_abr_vc</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srv_p</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">pcr</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">pcr</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                   <span class="kt">int</span> <span class="n">tmpsum</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">sum_mcr</span><span class="o">+</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">sum_cbr</span><span class="o">+</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">;</span>
                   <span class="k">if</span> <span class="p">(</span><span class="n">tmpsum</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">)</span>
                       <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">mcr</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">;</span>
                   <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">sum_mcr</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">;</span>
                <span class="p">}</span> 
                <span class="k">else</span> <span class="n">srv_p</span><span class="p">.</span><span class="n">mcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">icr</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">icr</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">icr</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">tbe</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">tbe</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">tbe</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">frtt</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">frtt</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">frtt</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">rif</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">rif</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">rif</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">rdf</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">rdf</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">rdf</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">nrm_pres</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">nrm</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">nrm</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">trm_pres</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">trm</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">trm</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">adtf_pres</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">adtf</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">adtf</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">cdf_pres</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">cdf</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">cdf</span><span class="p">;</span>    
                <span class="k">if</span> <span class="p">(</span><span class="n">srv_p</span><span class="p">.</span><span class="n">icr</span> <span class="o">&gt;</span> <span class="n">srv_p</span><span class="p">.</span><span class="n">pcr</span><span class="p">)</span>
                   <span class="n">srv_p</span><span class="p">.</span><span class="n">icr</span> <span class="o">=</span> <span class="n">srv_p</span><span class="p">.</span><span class="n">pcr</span><span class="p">;</span>    
                <span class="n">IF_ABR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ABR:vcc-&gt;qos.txtp.max_pcr = %d  mcr = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                                      <span class="n">srv_p</span><span class="p">.</span><span class="n">pcr</span><span class="p">,</span> <span class="n">srv_p</span><span class="p">.</span><span class="n">mcr</span><span class="p">);)</span>
		<span class="n">ia_open_abr_vc</span><span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">srv_p</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">FE_25MBIT_PHY</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA:  CBR not support</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                    <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> 
                <span class="p">}</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">max_pcr</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">)</span> <span class="p">{</span>
                   <span class="n">IF_CBR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;PCR is not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
                   <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">vc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">CBR</span><span class="p">;</span>
                <span class="n">vc</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">CRC_APPEND</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">ia_cbr_setup</span> <span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">vcc</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>     
                    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
                <span class="p">}</span>
       <span class="p">}</span> 
	<span class="k">else</span>  
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;iadev:  Non UBR, ABR and CBR traffic not supportedn&quot;</span><span class="p">);</span> 
        
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vc_status</span> <span class="o">|=</span> <span class="n">VC_ACTIVE</span><span class="p">;</span>
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia open_tx returning </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">tx_buf_desc</span> <span class="o">*</span><span class="n">buf_desc_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tx_pkt_start</span><span class="p">;</span>  
	<span class="kt">void</span> <span class="o">*</span><span class="n">dle_addr</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>  
	<span class="n">u_short</span> <span class="n">tcq_st_adr</span><span class="p">;</span>  
	<span class="n">u_short</span> <span class="o">*</span><span class="n">tcq_start</span><span class="p">;</span>  
	<span class="n">u_short</span> <span class="n">prq_st_adr</span><span class="p">;</span>  
	<span class="n">u_short</span> <span class="o">*</span><span class="n">prq_start</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">main_vc</span> <span class="o">*</span><span class="n">vc</span><span class="p">;</span>  
	<span class="k">struct</span> <span class="n">ext_vc</span> <span class="o">*</span><span class="n">evc</span><span class="p">;</span>   
        <span class="n">u_short</span> <span class="n">tmp16</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">vcsize_sel</span><span class="p">;</span>
 
	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
        <span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">);</span>
 
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Tx MASK REG: 0x%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_MASK_REG</span><span class="p">));)</span>  

	<span class="cm">/* Allocate 4k (boundary aligned) bytes */</span>
	<span class="n">dle_addr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">DLE_TOTAL_SIZE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_dma</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dle_addr</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;can&#39;t allocate DLEs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="o">*</span><span class="p">)</span><span class="n">dle_addr</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dle_addr</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dle</span><span class="p">)</span><span class="o">*</span><span class="n">DLE_ENTRIES</span><span class="p">);</span>

	<span class="cm">/* write the upper 20 bits of the start address to tx list address register */</span>  
	<span class="n">writel</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_dma</span> <span class="o">&amp;</span> <span class="mh">0xfffff000</span><span class="p">,</span>
	       <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="n">IPHASE5575_TX_LIST_ADDR</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_MASK_REG</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">MODE_REG_0</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">RESET_SEG</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_COMMAND_REG</span><span class="p">);</span>  
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">MAIN_VC_TABLE_ADDR</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">MAIN_VC_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">EXT_VC_TABLE_ADDR</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">EXT_VC_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ABR_SCHED_TABLE_ADDR</span><span class="o">=</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">ABR_SCHED_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
  
	<span class="cm">/*  </span>
<span class="cm">	   Transmit side control memory map  </span>
<span class="cm">	   --------------------------------    </span>
<span class="cm">	 Buffer descr 	0x0000 (128 - 4K)  </span>
<span class="cm">	 Commn queues	0x1000	Transmit comp, Packet ready(0x1400)   </span>
<span class="cm">					(512 - 1K) each  </span>
<span class="cm">					TCQ - 4K, PRQ - 5K  </span>
<span class="cm">	 CBR Table 	0x1800 (as needed) - 6K  </span>
<span class="cm">	 UBR Table	0x3000 (1K - 4K) - 12K  </span>
<span class="cm">	 UBR Wait queue	0x4000 (1K - 4K) - 16K  </span>
<span class="cm">	 ABR sched	0x5000	and ABR wait queue (1K - 2K) each  </span>
<span class="cm">				ABR Tbl - 20K, ABR Wq - 22K   </span>
<span class="cm">	 extended VC	0x6000 (1K - 8K) - 24K  </span>
<span class="cm">	 VC Table	0x8000 (1K - 32K) - 32K  </span>
<span class="cm">	  </span>
<span class="cm">	Between 0x2000 (8K) and 0x3000 (12K) there is 4K space left for VBR Tbl  </span>
<span class="cm">	and Wait q, which can be allotted later.  </span>
<span class="cm">	*/</span>  
     
	<span class="cm">/* Buffer Descriptor Table Base address */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">TX_DESC_BASE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_DESC_BASE</span><span class="p">);</span>  
  
	<span class="cm">/* initialize each entry in the buffer descriptor table */</span>  
	<span class="n">buf_desc_ptr</span> <span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_buf_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">TX_DESC_BASE</span><span class="p">);</span>  
	<span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">buf_desc_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buf_desc_ptr</span><span class="p">));</span>  
	<span class="n">buf_desc_ptr</span><span class="o">++</span><span class="p">;</span>  
	<span class="n">tx_pkt_start</span> <span class="o">=</span> <span class="n">TX_PACKET_RAM</span><span class="p">;</span>  
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">buf_desc_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">buf_desc_ptr</span><span class="p">));</span>  
		<span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">desc_mode</span> <span class="o">=</span> <span class="n">AAL5</span><span class="p">;</span>  
		<span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_hi</span> <span class="o">=</span> <span class="n">tx_pkt_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>  
		<span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_lo</span> <span class="o">=</span> <span class="n">tx_pkt_start</span> <span class="o">&amp;</span> <span class="mh">0x0000ffff</span><span class="p">;</span>  
		<span class="n">buf_desc_ptr</span><span class="o">++</span><span class="p">;</span>		  
		<span class="n">tx_pkt_start</span> <span class="o">+=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span><span class="p">;</span>  
	<span class="p">}</span>  
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpcs_trailer_desc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot; couldn&#39;t get mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">goto</span> <span class="n">err_free_dle</span><span class="p">;</span>
        <span class="p">}</span>
       	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
       	<span class="p">{</span>
	    <span class="k">struct</span> <span class="n">cpcs_trailer</span> <span class="o">*</span><span class="n">cpcs</span><span class="p">;</span>
 
       	    <span class="n">cpcs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cpcs</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">GFP_DMA</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">cpcs</span><span class="p">)</span> <span class="p">{</span>                
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot; couldn&#39;t get freepage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span> 
		<span class="k">goto</span> <span class="n">err_free_tx_bufs</span><span class="p">;</span>
            <span class="p">}</span>
	    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cpcs</span> <span class="o">=</span> <span class="n">cpcs</span><span class="p">;</span>
	    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span>
		<span class="n">cpcs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cpcs</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">*</span>
                                   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">desc_tbl_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot; couldn&#39;t get mem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_all_tx_bufs</span><span class="p">;</span>
	<span class="p">}</span>
  
	<span class="cm">/* Communication Queues base address */</span>  
        <span class="n">i</span> <span class="o">=</span> <span class="n">TX_COMP_Q</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_QUEUE_BASE</span><span class="p">);</span>  
  
	<span class="cm">/* Transmit Complete Queue */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_ST_ADR</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_RD_PTR</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_short</span><span class="p">),</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_WR_PTR</span><span class="p">);</span> 
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">host_tcq_wr</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u_short</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u_short</span><span class="p">),</span> 
                                              <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_ED_ADR</span><span class="p">);</span> 
	<span class="cm">/* Fill the TCQ with all the free descriptors. */</span>  
	<span class="n">tcq_st_adr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_ST_ADR</span><span class="p">);</span>  
	<span class="n">tcq_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">tcq_st_adr</span><span class="p">);</span>  
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="o">*</span><span class="n">tcq_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>  
		<span class="n">tcq_start</span><span class="o">++</span><span class="p">;</span>  
	<span class="p">}</span>  
  
	<span class="cm">/* Packet Ready Queue */</span>  
        <span class="n">i</span> <span class="o">=</span> <span class="n">PKT_RDY_Q</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span> 
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">PRQ_ST_ADR</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u_short</span><span class="p">),</span> 
                                              <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">PRQ_ED_ADR</span><span class="p">);</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">PRQ_RD_PTR</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">PRQ_WR_PTR</span><span class="p">);</span>  
	 
        <span class="cm">/* Load local copy of PRQ and TCQ ptrs */</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_st</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">PRQ_ST_ADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_ed</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">PRQ_ED_ADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
 	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_wr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">PRQ_WR_PTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_st</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_ST_ADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_ed</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_ED_ADR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_RD_PTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="cm">/* Just for safety initializing the queue to have desc 1 always */</span>  
	<span class="cm">/* Fill the PRQ with all the free descriptors. */</span>  
	<span class="n">prq_st_adr</span> <span class="o">=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">PRQ_ST_ADR</span><span class="p">);</span>  
	<span class="n">prq_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">prq_st_adr</span><span class="p">);</span>  
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="o">*</span><span class="n">prq_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span><span class="mi">0</span><span class="p">;</span>	<span class="cm">/* desc 1 in all entries */</span>  
		<span class="n">prq_start</span><span class="o">++</span><span class="p">;</span>  
	<span class="p">}</span>  
	<span class="cm">/* CBR Table */</span>  
        <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Start CBR Init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
<span class="cp">#if 1  </span><span class="cm">/* for 1K VC board, CBR_PTR_BASE is 0 */</span><span class="cp"></span>
        <span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_PTR_BASE</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* Charlie&#39;s logic is wrong ? */</span><span class="cp"></span>
        <span class="n">tmp16</span> <span class="o">=</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">CBR_SCHED_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">17</span><span class="p">;</span>
        <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cbr_ptr_base = 0x%x &quot;</span><span class="p">,</span> <span class="n">tmp16</span><span class="p">);)</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">tmp16</span><span class="p">,</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_PTR_BASE</span><span class="p">);</span>
<span class="cp">#endif</span>

        <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;value in register = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                                   <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_PTR_BASE</span><span class="p">));)</span>
        <span class="n">tmp16</span> <span class="o">=</span> <span class="p">(</span><span class="n">CBR_SCHED_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">tmp16</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_TAB_BEG</span><span class="p">);</span>
        <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;cbr_tab_beg = 0x%x in reg = 0x%x </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp16</span><span class="p">,</span>
                                        <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_TAB_BEG</span><span class="p">));)</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">tmp16</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_TAB_END</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// CBR_PTR;</span>
        <span class="n">tmp16</span> <span class="o">=</span> <span class="p">(</span><span class="n">CBR_SCHED_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span> <span class="o">+</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="o">*</span><span class="mi">6</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">tmp16</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_TAB_END</span><span class="p">);</span>
        <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;iadev-&gt;seg_reg = 0x%p CBR_PTR_BASE = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
               <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="p">,</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_PTR_BASE</span><span class="p">));)</span>
        <span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;CBR_TAB_BEG = 0x%x, CBR_TAB_END = 0x%x, CBR_PTR = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
          <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_TAB_BEG</span><span class="p">),</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_TAB_END</span><span class="p">),</span>
          <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CBR_TAB_END</span><span class="o">+</span><span class="mi">1</span><span class="p">));)</span>

        <span class="cm">/* Initialize the CBR Schedualing Table */</span>
        <span class="n">memset_io</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">CBR_SCHED_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">,</span> 
                                                          <span class="mi">0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="o">*</span><span class="mi">6</span><span class="p">);</span> 
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">CbrRemEntries</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">CbrEntryPt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">Granularity</span> <span class="o">=</span> <span class="n">MAX_ATM_155</span> <span class="o">/</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">CbrTotEntries</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">NumEnabledCBR</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* UBR scheduling Table and wait queue */</span>  
	<span class="cm">/* initialize all bytes of UBR scheduler table and wait queue to 0   </span>
<span class="cm">		- SCHEDSZ is 1K (# of entries).  </span>
<span class="cm">		- UBR Table size is 4K  </span>
<span class="cm">		- UBR wait queue is 4K  </span>
<span class="cm">	   since the table and wait queues are contiguous, all the bytes   </span>
<span class="cm">	   can be initialized by one memeset.</span>
<span class="cm">	*/</span>  
        
        <span class="n">vcsize_sel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">8</span><span class="o">*</span><span class="mi">1024</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">i</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
          <span class="n">vcsize_sel</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
 
        <span class="n">i</span> <span class="o">=</span> <span class="n">MAIN_VC_TABLE</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">vcsize_sel</span> <span class="o">|</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfff8</span><span class="p">),</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">VCT_BASE</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">=</span>  <span class="n">EXT_VC_TABLE</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">((</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">VCTE_BASE</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">UBR_SCHED_TABLE</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">,</span>  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">UBR_SBPTR_BASE</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">UBR_WAIT_Q</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span> 
        <span class="n">writew</span><span class="p">((</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">UBRWQ_BASE</span><span class="p">);</span>
 	<span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">UBR_SCHED_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">),</span>
                                                       <span class="mi">0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="o">*</span><span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* ABR scheduling Table(0x5000-0x57ff) and wait queue(0x5800-0x5fff)*/</span>  
	<span class="cm">/* initialize all bytes of ABR scheduler table and wait queue to 0   </span>
<span class="cm">		- SCHEDSZ is 1K (# of entries).  </span>
<span class="cm">		- ABR Table size is 2K  </span>
<span class="cm">		- ABR wait queue is 2K  </span>
<span class="cm">	   since the table and wait queues are contiguous, all the bytes   </span>
<span class="cm">	   can be initialized by one memeset.</span>
<span class="cm">	*/</span>  
        <span class="n">i</span> <span class="o">=</span> <span class="n">ABR_SCHED_TABLE</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">((</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">ABR_SBPTR_BASE</span><span class="p">);</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ABR_WAIT_Q</span> <span class="o">*</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
        <span class="n">writew</span><span class="p">((</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">ABRWQ_BASE</span><span class="p">);</span>
 
        <span class="n">i</span> <span class="o">=</span> <span class="n">ABR_SCHED_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">i</span><span class="p">),</span>  <span class="mi">0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">vc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">main_vc</span> <span class="o">*</span><span class="p">)</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">MAIN_VC_TABLE_ADDR</span><span class="p">;</span>  
	<span class="n">evc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ext_vc</span> <span class="o">*</span><span class="p">)</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">EXT_VC_TABLE_ADDR</span><span class="p">;</span>  
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Get freepage  failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	   <span class="k">goto</span> <span class="n">err_free_desc_tbl</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vc</span><span class="p">));</span>  
		<span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">evc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">evc</span><span class="p">));</span>  
                <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">testTable_t</span><span class="p">),</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">goto</span> <span class="n">err_free_test_tables</span><span class="p">;</span>
              	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lastTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fract</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vc_status</span> <span class="o">=</span> <span class="n">VC_UBR</span><span class="p">;</span>
		<span class="n">vc</span><span class="o">++</span><span class="p">;</span>  
		<span class="n">evc</span><span class="o">++</span><span class="p">;</span>  
	<span class="p">}</span>  
  
	<span class="cm">/* Other Initialization */</span>  
	  
	<span class="cm">/* Max Rate Register */</span>  
        <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="n">FE_25MBIT_PHY</span><span class="p">)</span> <span class="p">{</span>
	   <span class="n">writew</span><span class="p">(</span><span class="n">RATE25</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">MAXRATE</span><span class="p">);</span>  
	   <span class="n">writew</span><span class="p">((</span><span class="n">UBR_EN</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x23</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">STPARMS</span><span class="p">);</span>  
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
	   <span class="n">writew</span><span class="p">(</span><span class="n">cellrate_to_float</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">),</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">MAXRATE</span><span class="p">);</span>
	   <span class="n">writew</span><span class="p">((</span><span class="n">UBR_EN</span> <span class="o">|</span> <span class="n">ABR_EN</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0x23</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">STPARMS</span><span class="p">);</span>  
        <span class="p">}</span>
	<span class="cm">/* Set Idle Header Reigisters to be sure */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">IDLEHEADHI</span><span class="p">);</span>  
	<span class="n">writew</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">IDLEHEADLO</span><span class="p">);</span>  
  
	<span class="cm">/* Program ABR UBR Priority Register  as  PRI_ABR_UBR_EQUAL */</span>
        <span class="n">writew</span><span class="p">(</span><span class="mh">0xaa00</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">ABRUBR_ARB</span><span class="p">);</span> 

        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">close_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
        <span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">timeout_wait</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dma_q</span><span class="p">);</span>  
	<span class="n">ia_init_rtn_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_return_q</span><span class="p">);</span>  

	<span class="cm">/* RM Cell Protocol ID and Message Type */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">RM_TYPE_4_0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">RM_TYPE</span><span class="p">);</span>  
        <span class="n">skb_queue_head_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_backlog</span><span class="p">);</span>
  
	<span class="cm">/* Mode Register 1 */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">MODE_REG_1_VAL</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">MODE_REG_1</span><span class="p">);</span>  
  
	<span class="cm">/* Mode Register 0 */</span>  
	<span class="n">writew</span><span class="p">(</span><span class="n">T_ONLINE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">MODE_REG_0</span><span class="p">);</span>  
  
	<span class="cm">/* Interrupt Status Register - read to clear */</span>  
	<span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_INTR_STATUS_REG</span><span class="p">);</span>  
  
	<span class="cm">/* Interrupt Mask Reg- don&#39;t mask TCQ_NOT_EMPTY interrupt generation */</span>  
        <span class="n">writew</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">TRANSMIT_DONE</span> <span class="o">|</span> <span class="n">TCQ_NOT_EMPTY</span><span class="p">),</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_MASK_REG</span><span class="p">);</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">TRANSMIT_DONE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_INTR_STATUS_REG</span><span class="p">);</span>  
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_pkt_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rate_limit</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span>
  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_test_tables:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">);</span>
<span class="nl">err_free_desc_tbl:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">);</span>
<span class="nl">err_free_all_tx_bufs:</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">;</span>
<span class="nl">err_free_tx_bufs:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cpcs_trailer_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">cpcs</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">cpcs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>
<span class="nl">err_free_dle:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">DLE_TOTAL_SIZE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
			    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_dma</span><span class="p">);</span>  
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>   
   
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ia_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>  
<span class="p">{</span>  
   <span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>  
   <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>  
   <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>  
   <span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
   <span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">status</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span>  
   <span class="p">{</span> 
	<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia_int: status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);)</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_REASSINT</span><span class="p">)</span>  
	<span class="p">{</span>  
	   <span class="cm">/* do something */</span>  
	   <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;REASSINT Bus status reg: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);)</span> 
	   <span class="n">rx_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="p">}</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_DLERINT</span><span class="p">)</span>  
	<span class="p">{</span>  
	   <span class="cm">/* Clear this bit by writing a 1 to it. */</span>  
	   <span class="n">writel</span><span class="p">(</span><span class="n">STAT_DLERINT</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">IPHASE5575_BUS_STATUS_REG</span><span class="p">);</span>
	   <span class="n">rx_dle_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="p">}</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_SEGINT</span><span class="p">)</span>  
	<span class="p">{</span>  
	   <span class="cm">/* do something */</span> 
           <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: tx_intr </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span> 
	   <span class="n">tx_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="p">}</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_DLETINT</span><span class="p">)</span>  
	<span class="p">{</span>  
	   <span class="n">writel</span><span class="p">(</span><span class="n">STAT_DLETINT</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">IPHASE5575_BUS_STATUS_REG</span><span class="p">);</span>
	   <span class="n">tx_dle_intr</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="p">}</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_FEINT</span> <span class="o">|</span> <span class="n">STAT_ERRINT</span> <span class="o">|</span> <span class="n">STAT_MARKINT</span><span class="p">))</span>  
	<span class="p">{</span>  
           <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_FEINT</span><span class="p">)</span> 
               <span class="n">ia_frontend_intr</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
	<span class="p">}</span>  
   <span class="p">}</span>
   <span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>  
	  
	  
	  
<span class="cm">/*----------------------------- entries --------------------------------*/</span>  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_esi</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>  
	<span class="n">u32</span> <span class="n">mac1</span><span class="p">;</span>  
	<span class="n">u16</span> <span class="n">mac2</span><span class="p">;</span>  
	  
	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="n">mac1</span> <span class="o">=</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span>  
				<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_MAC1</span><span class="p">)));</span>  
	<span class="n">mac2</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_MAC2</span><span class="p">)));</span>  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ESI: 0x%08x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mac1</span><span class="p">,</span> <span class="n">mac2</span><span class="p">);)</span>  
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAC1_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac1</span> <span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="n">MAC1_LEN</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">));</span>  
	  
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAC2_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">MAC1_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac2</span> <span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="p">(</span><span class="n">MAC2_LEN</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span><span class="n">i</span><span class="p">));</span>  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
	  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_sar</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pci</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>  
	  
	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
	  <span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span>  
				<span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span>  
  	      <span class="k">return</span> <span class="n">error</span><span class="p">;</span>  
	<span class="n">writel</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_EXT_RESET</span><span class="p">);</span>  
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
	  <span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span>  
					<span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">pci</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">!=</span> <span class="n">PCIBIOS_SUCCESSFUL</span><span class="p">)</span>  
	    <span class="k">return</span> <span class="n">error</span><span class="p">;</span>  
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
	  
	  
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ia_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">real_base</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">command</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span> 
	  
	<span class="cm">/* The device has been identified and registered. Now we read   </span>
<span class="cm">	   necessary configuration info like memory base address,   </span>
<span class="cm">	   interrupt number etc */</span>  
	  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;&gt;ia_init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vpi_bits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="n">NR_VCI_LD</span><span class="p">;</span>  

	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="n">real_base</span> <span class="o">=</span> <span class="n">pci_resource_start</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		  
	<span class="n">error</span> <span class="o">=</span> <span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): init error 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span><span class="n">error</span><span class="p">);</span>  
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>  
	<span class="p">}</span>  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): rev.%d,realbase=0x%lx,irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">real_base</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);)</span>
	  
	<span class="cm">/* find mapping size of board */</span>  
	  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci_map_size</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci_map_size</span> <span class="o">==</span> <span class="mh">0x100000</span><span class="p">){</span>
          <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ci_range</span><span class="p">.</span><span class="n">vci_bits</span> <span class="o">=</span> <span class="n">NR_VCI_4K_LD</span><span class="p">;</span>  
          <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci_map_size</span> <span class="o">==</span> <span class="mh">0x40000</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
          <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Unknown pci_map_size = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci_map_size</span><span class="p">);</span>
           <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span> <span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;map size: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci_map_size</span><span class="p">);)</span>  
	  
	<span class="cm">/* enable bus mastering */</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>

	<span class="cm">/*  </span>
<span class="cm">	 * Delay at least 1us before doing any mem accesses (how &#39;bout 10?)  </span>
<span class="cm">	 */</span>  
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>  
	  
	<span class="cm">/* mapping the physical address to a virtual address in address space */</span>  
	<span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">real_base</span><span class="p">,</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci_map_size</span><span class="p">);</span>  <span class="cm">/* ioremap is not resolved ??? */</span>  
	  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">base</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="n">printk</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot; (itf %d): can&#39;t set up page mapping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>  
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>  
	<span class="p">}</span>  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot; (itf %d): rev.%d,base=%p,irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);)</span>
	  
	<span class="cm">/* filling the iphase dev structure */</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci_map_size</span> <span class="o">/</span><span class="mi">2</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">real_base</span> <span class="o">=</span> <span class="n">real_base</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>  
		  
	<span class="cm">/* Bus Interface Control Registers */</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">REG_BASE</span><span class="p">;</span>
	<span class="cm">/* Segmentation Control Registers */</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SEG_BASE</span><span class="p">;</span>
	<span class="cm">/* Reassembly Control Registers */</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">REASS_BASE</span><span class="p">;</span>  
	<span class="cm">/* Front end/ DMA control registers */</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PHY_BASE</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">PHY_BASE</span><span class="p">;</span>  
	<span class="cm">/* RAM - Segmentation RAm and Reassembly RAM */</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ram</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ACTUAL_RAM_BASE</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ACTUAL_SEG_RAM_BASE</span><span class="p">;</span>  
	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">ACTUAL_REASS_RAM_BASE</span><span class="p">;</span>  
  
	<span class="cm">/* lets print out the above */</span>  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Base addrs: %p %p %p </span><span class="se">\n</span><span class="s"> %p %p %p %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
          <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="p">,</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="p">,</span> 
          <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ram</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="p">,</span> 
          <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="p">);)</span> 
	  
	<span class="cm">/* lets try reading the MAC address */</span>  
	<span class="n">error</span> <span class="o">=</span> <span class="n">get_esi</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">iounmap</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	  <span class="k">return</span> <span class="n">error</span><span class="p">;</span>  
	<span class="p">}</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: &quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ESI_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>  
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s%02X&quot;</span><span class="p">,</span><span class="n">i</span> <span class="o">?</span> <span class="s">&quot;-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">esi</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>  
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>  
  
        <span class="cm">/* reset SAR */</span>  
        <span class="k">if</span> <span class="p">(</span><span class="n">reset_sar</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
	   <span class="n">iounmap</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: reset SAR fail, please try again</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_update_stats</span><span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">carrier_detect</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_cell_cnt</span> <span class="o">+=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">CELL_CTR0</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_cell_cnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">CELL_CTR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">drop_rxpkt</span> <span class="o">+=</span>  <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span> <span class="o">+</span> <span class="n">DRP_PKT_CNTR</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">drop_rxcell</span> <span class="o">+=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span> <span class="o">+</span> <span class="n">ERR_CNTR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_cell_cnt</span> <span class="o">+=</span> <span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span> <span class="o">+</span> <span class="n">CELL_CTR_LO_AUTO</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">;</span>
    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_cell_cnt</span> <span class="o">+=</span> <span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">CELL_CTR_HIGH_AUTO</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xffff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">;</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
  
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_led_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
 	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
  	<span class="k">static</span> <span class="n">u_char</span> <span class="n">blinking</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
        <span class="n">u_char</span> <span class="n">i</span><span class="p">;</span>
        <span class="k">static</span> <span class="n">u32</span> <span class="n">ctrl_reg</span><span class="p">;</span> 
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iadev_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
	      <span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">);</span>
	      <span class="k">if</span> <span class="p">(</span><span class="n">blinking</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		 <span class="n">blinking</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
                 <span class="n">ctrl_reg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">CTRL_LED</span><span class="p">);</span>
                 <span class="n">writel</span><span class="p">(</span><span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">);</span>
                 <span class="n">ia_update_stats</span><span class="p">(</span><span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
              <span class="p">}</span>
              <span class="k">else</span> <span class="p">{</span>
		 <span class="n">blinking</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		 <span class="n">ctrl_reg</span> <span class="o">|=</span> <span class="n">CTRL_LED</span><span class="p">;</span>
                 <span class="n">writel</span><span class="p">(</span><span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">);</span>
                 <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
                 <span class="k">if</span> <span class="p">(</span><span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">close_pending</span><span class="p">)</span>  
                    <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">);</span>
                 <span class="n">ia_tx_poll</span><span class="p">(</span><span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
                 <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia_dev</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
              <span class="p">}</span>
           <span class="p">}</span>
        <span class="p">}</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
 	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_phy_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span>   
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">+</span><span class="n">addr</span><span class="p">);</span>  
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">ia_phy_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">+</span><span class="n">addr</span><span class="p">);</span>  
<span class="p">}</span>  

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_free_tx</span><span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_vc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cpcs_trailer_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">dma_addr</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">cpcs</span><span class="p">),</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">cpcs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">DLE_TOTAL_SIZE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
			    <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_dma</span><span class="p">);</span>  
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_free_rx</span><span class="p">(</span><span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_open</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">DLE_TOTAL_SIZE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">,</span>
			  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_dle_dma</span><span class="p">);</span>  
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ia_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>  
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">phy</span><span class="p">;</span>  
	<span class="n">u32</span> <span class="n">ctrl_reg</span><span class="p">;</span>  
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;&gt;ia_start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
	<span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
        <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ia_int</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DEV_LABEL</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): IRQ%d is already in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>  
                    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>  
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
        <span class="p">}</span>  
        <span class="cm">/* @@@ should release IRQ on error */</span>  
	<span class="cm">/* enabling memory + master */</span>  
        <span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span>   
				<span class="n">PCI_COMMAND</span><span class="p">,</span>   
				<span class="n">PCI_COMMAND_MEMORY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span> <span class="p">)))</span>   
	<span class="p">{</span>  
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): can&#39;t enable memory+&quot;</span>  
                    <span class="s">&quot;master (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>  
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>  
		<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
        <span class="p">}</span>  
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>  
  
	<span class="cm">/* Maybe we should reset the front end, initialize Bus Interface Control   </span>
<span class="cm">		Registers and see. */</span>  
  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus ctrl reg: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                            <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">));)</span>  
	<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">);</span>  
	<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctrl_reg</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CTRL_LED</span> <span class="o">|</span> <span class="n">CTRL_FE_RST</span><span class="p">))</span>  
			<span class="o">|</span> <span class="n">CTRL_B8</span>  
			<span class="o">|</span> <span class="n">CTRL_B16</span>  
			<span class="o">|</span> <span class="n">CTRL_B32</span>  
			<span class="o">|</span> <span class="n">CTRL_B48</span>  
			<span class="o">|</span> <span class="n">CTRL_B64</span>  
			<span class="o">|</span> <span class="n">CTRL_B128</span>  
			<span class="o">|</span> <span class="n">CTRL_ERRMASK</span>  
			<span class="o">|</span> <span class="n">CTRL_DLETMASK</span>		<span class="cm">/* shud be removed l8r */</span>  
			<span class="o">|</span> <span class="n">CTRL_DLERMASK</span>  
			<span class="o">|</span> <span class="n">CTRL_SEGMASK</span>  
			<span class="o">|</span> <span class="n">CTRL_REASSMASK</span> 	  
			<span class="o">|</span> <span class="n">CTRL_FEMASK</span>  
			<span class="o">|</span> <span class="n">CTRL_CSPREEMPT</span><span class="p">;</span>  
  
       <span class="n">writel</span><span class="p">(</span><span class="n">ctrl_reg</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">);</span>   
  
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus ctrl reg after initializing: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                           <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">));</span>  
	   <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus status reg after init: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                            <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_STATUS_REG</span><span class="p">));)</span>  
    
        <span class="n">ia_hw_type</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span> 
	<span class="n">error</span> <span class="o">=</span> <span class="n">tx_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_irq</span><span class="p">;</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">rx_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_tx</span><span class="p">;</span>
  
	<span class="n">ctrl_reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">);</span>  
       	<span class="n">writel</span><span class="p">(</span><span class="n">ctrl_reg</span> <span class="o">|</span> <span class="n">CTRL_FE_RST</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">);</span>   
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Bus ctrl reg after initializing: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                               <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">+</span><span class="n">IPHASE5575_BUS_CONTROL_REG</span><span class="p">));)</span>  
        <span class="n">phy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* resolve compiler complaint */</span>
        <span class="n">IF_INIT</span> <span class="p">(</span> 
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">=</span><span class="n">ia_phy_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span>  
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: pm5346,rev.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">phy</span><span class="o">&amp;</span><span class="mh">0x0f</span><span class="p">);</span>  
	<span class="k">else</span>  
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA: utopia,rev.%0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">phy</span><span class="p">);)</span> 

	<span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span>  <span class="n">FE_25MBIT_PHY</span><span class="p">)</span>
           <span class="n">ia_mb25_init</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FE_DS3_PHY</span> <span class="o">|</span> <span class="n">FE_E3_PHY</span><span class="p">))</span>
           <span class="n">ia_suni_pm7345_init</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">suni_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_rx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err_free_rx</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Get iadev-&gt;carrier_detect status */</span>
		<span class="n">ia_frontend_intr</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_rx:</span>
	<span class="n">ia_free_rx</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
<span class="nl">err_free_tx:</span>
	<span class="n">ia_free_tx</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
<span class="nl">err_free_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>  
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ia_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>  
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
        <span class="n">u16</span> <span class="o">*</span><span class="n">vc_table</span><span class="p">;</span>
        <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ia_vcc</span> <span class="o">*</span><span class="n">ia_vcc</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">tmp_tx_backlog</span><span class="p">,</span> <span class="n">tmp_vcc_backlog</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">closetime</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>

        <span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="n">ia_vcc</span> <span class="o">=</span> <span class="n">INPH_IA_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ia_vcc</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>  

        <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia_close: ia_vcc-&gt;vc_desc_cnt = %d  vci = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                              <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">vc_desc_cnt</span><span class="p">,</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);)</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
        <span class="n">skb_queue_head_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_tx_backlog</span><span class="p">);</span>
        <span class="n">skb_queue_head_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_vcc_backlog</span><span class="p">);</span> 
        <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">close_pending</span><span class="o">++</span><span class="p">;</span>
	   <span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">timeout_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	   <span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	   <span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">timeout_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
           <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> 
           <span class="k">while</span><span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_backlog</span><span class="p">)))</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">==</span> <span class="n">vcc</span><span class="p">){</span> 
                 <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
                 <span class="k">else</span> <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
              <span class="p">}</span>
              <span class="k">else</span> 
                 <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_tx_backlog</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
           <span class="p">}</span> 
           <span class="k">while</span><span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_tx_backlog</span><span class="p">)))</span> 
             <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_backlog</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
           <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA TX Done decs_cnt = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">vc_desc_cnt</span><span class="p">);)</span> 
           <span class="n">closetime</span> <span class="o">=</span> <span class="mi">300000</span> <span class="o">/</span> <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">pcr</span><span class="p">;</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">closetime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
              <span class="n">closetime</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
           <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
           <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">close_wait</span><span class="p">,</span> <span class="p">(</span><span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">vc_desc_cnt</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">),</span> <span class="n">closetime</span><span class="p">);</span>
           <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">close_pending</span><span class="o">--</span><span class="p">;</span>
           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">lastTime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">fract</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">testTable</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vc_status</span> <span class="o">=</span> <span class="n">VC_UBR</span><span class="p">;</span> 
           <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_ABR</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                 <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">sum_mcr</span> <span class="o">-=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">min_pcr</span><span class="p">;</span>
           <span class="p">}</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_CBR</span><span class="p">)</span> <span class="p">{</span>
              <span class="n">ia_vcc</span> <span class="o">=</span> <span class="n">INPH_IA_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span> 
              <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">sum_mcr</span> <span class="o">-=</span> <span class="n">ia_vcc</span><span class="o">-&gt;</span><span class="n">NumCbrEntry</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">Granularity</span><span class="p">;</span>
              <span class="n">ia_cbrVc_close</span> <span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
           <span class="p">}</span>
           <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">!=</span> <span class="n">ATM_NONE</span><span class="p">)</span> <span class="p">{</span>   </pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>reset reass table</p></td><td class="code"><div class="highlight"><pre>           <span class="n">vc_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">REASS_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">);</span>
           <span class="n">vc_table</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span> 
           <span class="o">*</span><span class="n">vc_table</span> <span class="o">=</span> <span class="n">NO_AAL5_PKT</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>reset vc table</p></td><td class="code"><div class="highlight"><pre>           <span class="n">vc_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">RX_VC_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">);</span>
           <span class="n">vc_table</span> <span class="o">+=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
           <span class="o">*</span><span class="n">vc_table</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="mi">15</span><span class="p">;</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">rxtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_ABR</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">struct</span> <span class="n">abr_vc_table</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">abr_vc_table</span> <span class="o">=</span> 
                                <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_ram</span><span class="o">+</span><span class="n">ABR_VC_TABLE</span><span class="o">*</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memSize</span><span class="p">);</span>
              <span class="n">abr_vc_table</span> <span class="o">+=</span>  <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
              <span class="n">abr_vc_table</span><span class="o">-&gt;</span><span class="n">rdf</span> <span class="o">=</span> <span class="mh">0x0003</span><span class="p">;</span>
              <span class="n">abr_vc_table</span><span class="o">-&gt;</span><span class="n">air</span> <span class="o">=</span> <span class="mh">0x5eb1</span><span class="p">;</span>
           <span class="p">}</span>                                 </pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Drain the packets</p></td><td class="code"><div class="highlight"><pre>           <span class="n">rx_dle_intr</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span> 
           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_open</span><span class="p">[</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">INPH_IA_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">));</span>  
        <span class="n">ia_vcc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">clear_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>        
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">)</span>
<span class="p">{</span>  
	<span class="k">struct</span> <span class="n">ia_vcc</span> <span class="o">*</span><span class="n">ia_vcc</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_PARTIAL</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>  
	<span class="p">{</span>  
		<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia: not partially allocated resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span> <span class="o">!=</span> <span class="n">ATM_VPI_UNSPEC</span> <span class="o">&amp;&amp;</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span> <span class="o">!=</span> <span class="n">ATM_VCI_UNSPEC</span><span class="p">)</span>  
	<span class="p">{</span>  
		<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;iphase open: unspec part</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_ADDR</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>  
	<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">aal</span> <span class="o">!=</span> <span class="n">ATM_AAL5</span><span class="p">)</span>  
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>  
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;(itf %d): open %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                 <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vpi</span><span class="p">,</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">);)</span>  
  
	<span class="cm">/* Device dependent initialization */</span>  
	<span class="n">ia_vcc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ia_vcc</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ia_vcc</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>  
	<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">ia_vcc</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">open_rx</span><span class="p">(</span><span class="n">vcc</span><span class="p">)))</span>  
	<span class="p">{</span>  
		<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;iadev: error in open_rx, closing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
		<span class="n">ia_close</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>  
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>  
	<span class="p">}</span>  
  
	<span class="k">if</span> <span class="p">((</span><span class="n">error</span> <span class="o">=</span> <span class="n">open_tx</span><span class="p">(</span><span class="n">vcc</span><span class="p">)))</span>  
	<span class="p">{</span>  
		<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;iadev: error in open_tx, closing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
		<span class="n">ia_close</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>  
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>  
	<span class="p">}</span>  
  
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">        {</span>
<span class="c">           static u8 first = 1; </span>
<span class="c">           if (first) {</span>
<span class="c">              ia_timer.expires = jiffies + 3*HZ;</span>
<span class="c">              add_timer(&amp;ia_timer);</span>
<span class="c">              first = 0;</span>
<span class="c">           }           </span>
<span class="c">        }</span>
<span class="cp">#endif</span>
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia open returning</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_change_qos</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atm_qos</span> <span class="o">*</span><span class="n">qos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;&gt;ia_change_qos</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>  
<span class="p">{</span>  
   <span class="n">IA_CMDBUF</span> <span class="n">ia_cmds</span><span class="p">;</span>
   <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>
   <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">board</span><span class="p">;</span>
   <span class="n">u16</span> <span class="n">__user</span> <span class="o">*</span><span class="n">tmps</span><span class="p">;</span>
   <span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;&gt;ia_ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
   <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">IA_CMD</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
      <span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">cmd</span><span class="p">,</span><span class="n">arg</span><span class="p">);</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia_cmds</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">ia_cmds</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span> 
   <span class="n">board</span> <span class="o">=</span> <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
   <span class="k">if</span> <span class="p">((</span><span class="n">board</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">board</span> <span class="o">&gt;</span> <span class="n">iadev_count</span><span class="p">))</span>
         <span class="n">board</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    
   <span class="n">iadev</span> <span class="o">=</span> <span class="n">ia_dev</span><span class="p">[</span><span class="n">board</span><span class="p">];</span>
   <span class="k">switch</span> <span class="p">(</span><span class="n">ia_cmds</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">case</span> <span class="n">MEMDUMP</span>:
   <span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ia_cmds</span><span class="p">.</span><span class="n">sub_cmd</span><span class="p">)</span> <span class="p">{</span>
       	  <span class="k">case</span> <span class="n">MEMDUMP_DEV</span>:     
	     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	     <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ia_cmds</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">iadev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">IADEV</span><span class="p">)))</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="n">MEMDUMP_SEGREG</span>:
	     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
             <span class="n">tmps</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ia_cmds</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
             <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">0x80</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tmps</span><span class="o">++</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">put_user</span><span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span> <span class="n">tmps</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
             <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="n">MEMDUMP_REASSREG</span>:
	     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
             <span class="n">tmps</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">ia_cmds</span><span class="p">.</span><span class="n">buf</span><span class="p">;</span>
             <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mh">0x80</span><span class="p">;</span> <span class="n">i</span><span class="o">+=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tmps</span><span class="o">++</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">put_user</span><span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">),</span> <span class="n">tmps</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
             <span class="k">break</span><span class="p">;</span>
          <span class="k">case</span> <span class="n">MEMDUMP_FFL</span>:
          <span class="p">{</span>  
             <span class="n">ia_regs_t</span>       <span class="o">*</span><span class="n">regs_local</span><span class="p">;</span>
             <span class="n">ffredn_t</span>        <span class="o">*</span><span class="n">ffL</span><span class="p">;</span>
             <span class="n">rfredn_t</span>        <span class="o">*</span><span class="n">rfL</span><span class="p">;</span>
                     
	     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	     <span class="n">regs_local</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">regs_local</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">regs_local</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	     <span class="n">ffL</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs_local</span><span class="o">-&gt;</span><span class="n">ffredn</span><span class="p">;</span>
	     <span class="n">rfL</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">regs_local</span><span class="o">-&gt;</span><span class="n">rfredn</span><span class="p">;</span>
             <span class="cm">/* Copy real rfred registers into the local copy */</span>
 	     <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">rfredn_t</span><span class="p">))</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="p">((</span><span class="n">u_int</span> <span class="o">*</span><span class="p">)</span><span class="n">rfL</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
             	<span class="cm">/* Copy real ffred registers into the local copy */</span>
	     <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">ffredn_t</span><span class="p">))</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="p">((</span><span class="n">u_int</span> <span class="o">*</span><span class="p">)</span><span class="n">ffL</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>

             <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ia_cmds</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">regs_local</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ia_regs_t</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">kfree</span><span class="p">(</span><span class="n">regs_local</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
             <span class="p">}</span>
             <span class="n">kfree</span><span class="p">(</span><span class="n">regs_local</span><span class="p">);</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Board %d registers dumped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">board</span><span class="p">);</span>
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                  
	 <span class="p">}</span>	
    	     <span class="k">break</span><span class="p">;</span>        
         <span class="k">case</span> <span class="n">READ_REG</span>:
         <span class="p">{</span>  
	     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
             <span class="n">desc_dbg</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span> 
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
         <span class="p">}</span>
             <span class="k">break</span><span class="p">;</span>
         <span class="k">case</span> <span class="mh">0x6</span>:
         <span class="p">{</span>  
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;skb = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_backlog</span><span class="p">));</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;rtn_q: 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">ia_deque_rtn_q</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_return_q</span><span class="p">));</span>
         <span class="p">}</span>
             <span class="k">break</span><span class="p">;</span>
         <span class="k">case</span> <span class="mh">0x8</span>:
         <span class="p">{</span>
             <span class="k">struct</span> <span class="n">k_sonet_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
             <span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">PRIV</span><span class="p">(</span><span class="n">_ia_dev</span><span class="p">[</span><span class="n">board</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">sonet_stats</span><span class="p">;</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;section_bip: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">section_bip</span><span class="p">));</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;line_bip   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">line_bip</span><span class="p">));</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;path_bip   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">path_bip</span><span class="p">));</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;line_febe  : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">line_febe</span><span class="p">));</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;path_febe  : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">path_febe</span><span class="p">));</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;corr_hcs   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">corr_hcs</span><span class="p">));</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;uncorr_hcs : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">uncorr_hcs</span><span class="p">));</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;tx_cells   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_cells</span><span class="p">));</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;rx_cells   : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_cells</span><span class="p">));</span>
         <span class="p">}</span>
            <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
         <span class="k">case</span> <span class="mh">0x9</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
               <span class="n">free_desc</span><span class="p">(</span><span class="n">_ia_dev</span><span class="p">[</span><span class="n">board</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>
            <span class="n">writew</span><span class="p">(</span> <span class="o">~</span><span class="p">(</span><span class="n">RX_FREEQ_EMPT</span> <span class="o">|</span> <span class="n">RX_EXCP_RCVD</span><span class="p">),</span> 
                                            <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">reass_reg</span><span class="o">+</span><span class="n">REASS_MASK_REG</span><span class="p">);</span>
            <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rxing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            
            <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>

         <span class="k">case</span> <span class="mh">0xb</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
            <span class="n">ia_frontend_intr</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
         <span class="k">case</span> <span class="mh">0xa</span>:
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
         <span class="p">{</span>  
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
             <span class="n">IADebugFlag</span> <span class="o">=</span> <span class="n">ia_cmds</span><span class="p">.</span><span class="n">maddr</span><span class="p">;</span>
             <span class="n">printk</span><span class="p">(</span><span class="s">&quot;New debug option loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
         <span class="p">}</span>
             <span class="k">break</span><span class="p">;</span>
         <span class="nl">default:</span>
             <span class="n">ia_cmds</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
             <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>	
   <span class="p">}</span>
      <span class="k">break</span><span class="p">;</span>
   <span class="nl">default:</span>
      <span class="k">break</span><span class="p">;</span>

   <span class="p">}</span>	
   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_getsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>   
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;&gt;ia_getsockopt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>  
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_setsockopt</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">,</span> <span class="kt">int</span> <span class="n">optname</span><span class="p">,</span>   
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">optval</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">optlen</span><span class="p">)</span>  
<span class="p">{</span>  
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;&gt;ia_setsockopt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>  
<span class="p">}</span>  
  
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_pkt_tx</span> <span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">dle</span> <span class="o">*</span><span class="n">wr_ptr</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">tx_buf_desc</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">buf_desc_ptr</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">desc</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">comp_code</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">total_len</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">cpcs_trailer</span> <span class="o">*</span><span class="n">trailer</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">ia_vcc</span> <span class="o">*</span><span class="n">iavcc</span><span class="p">;</span>

        <span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>  
        <span class="n">iavcc</span> <span class="o">=</span> <span class="n">INPH_IA_VCC</span><span class="p">(</span><span class="n">vcc</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iavcc</span><span class="o">-&gt;</span><span class="n">txing</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;discard packet on closed VC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
		<span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
           <span class="k">else</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	   <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Transmit size over tx buffer size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
                 <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
           <span class="k">else</span>
                 <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
          <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
           <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Misaligned SKB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>
                 <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
           <span class="k">else</span>
                 <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
           <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>       
	<span class="cm">/* Get a descriptor number from our free descriptor queue  </span>
<span class="cm">	   We get the descr number from the TCQ now, since I am using  </span>
<span class="cm">	   the TCQ as a free buffer queue. Initially TCQ will be   </span>
<span class="cm">	   initialized with all the descriptors and is hence, full.  </span>
<span class="cm">	*/</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="n">get_desc</span> <span class="p">(</span><span class="n">iadev</span><span class="p">,</span> <span class="n">iavcc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> 
	    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">comp_code</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>  
	<span class="n">desc</span> <span class="o">&amp;=</span> <span class="mh">0x1fff</span><span class="p">;</span>  
  
	<span class="k">if</span> <span class="p">((</span><span class="n">desc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">desc</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">))</span>  
	<span class="p">{</span>  
		<span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;invalid desc for send: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="p">);)</span> 
                <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">)</span>   
		    <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">pop</span><span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>   
		<span class="k">else</span>  
		    <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>   <span class="cm">/* return SUCCESS */</span>
	<span class="p">}</span>  
  
	<span class="k">if</span> <span class="p">(</span><span class="n">comp_code</span><span class="p">)</span>  
	<span class="p">{</span>  
	    <span class="n">IF_ERR</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;send desc:%d completion code %d error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                                            <span class="n">desc</span><span class="p">,</span> <span class="n">comp_code</span><span class="p">);)</span>  
	<span class="p">}</span>  
       
        <span class="cm">/* remember the desc and vcc mapping */</span>
        <span class="n">iavcc</span><span class="o">-&gt;</span><span class="n">vc_desc_cnt</span><span class="o">++</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">iavcc</span> <span class="o">=</span> <span class="n">iavcc</span><span class="p">;</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">desc_tbl</span><span class="p">[</span><span class="n">desc</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">txskb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
        <span class="n">IA_SKB_STATE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_ed</span><span class="p">)</span>
	  	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span>  <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_st</span><span class="p">;</span>
	<span class="n">writew</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">tcq_rd</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">TCQ_RD_PTR</span><span class="p">);</span>
  
	<span class="cm">/* Put the descriptor number in the packet ready queue  </span>
<span class="cm">		and put the updated write pointer in the DLE field   </span>
<span class="cm">	*/</span>   
	<span class="o">*</span><span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_wr</span><span class="p">)</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span> 

 	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_wr</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_wr</span> <span class="o">&gt;</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_ed</span><span class="p">)</span>
                <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_wr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_st</span><span class="p">;</span>
	  
	<span class="cm">/* Figure out the exact length of the packet and padding required to </span>
<span class="cm">           make it  aligned on a 48 byte boundary.  */</span>
	<span class="n">total_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpcs_trailer</span><span class="p">);</span>  
	<span class="n">total_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">total_len</span> <span class="o">+</span> <span class="mi">47</span><span class="p">)</span> <span class="o">/</span> <span class="mi">48</span><span class="p">)</span> <span class="o">*</span> <span class="mi">48</span><span class="p">;</span>
	<span class="n">IF_TX</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia packet len:%d padding:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_len</span><span class="p">,</span> <span class="n">total_len</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);)</span>  
 
	<span class="cm">/* Put the packet in a tx buffer */</span>   
	<span class="n">trailer</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">desc</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">cpcs</span><span class="p">;</span>
        <span class="n">IF_TX</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Sent: skb = 0x%p skb-&gt;data: 0x%p len: %d, desc: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                  <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">desc</span><span class="p">);)</span>
	<span class="n">trailer</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
        <span class="cm">/*big endian*/</span> 
	<span class="n">trailer</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">trailer</span><span class="o">-&gt;</span><span class="n">crc32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* not needed - dummy bytes */</span>  

	<span class="cm">/* Display the packet */</span>  
	<span class="n">IF_TXPKT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Sent data: len = %d MsgNum = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> 
                                                        <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">tcnter</span><span class="o">++</span><span class="p">);</span>  
        <span class="n">xdump</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;TX: &quot;</span><span class="p">);</span>
        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>

	<span class="cm">/* Build the buffer descriptor */</span>  
	<span class="n">buf_desc_ptr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_ram</span><span class="o">+</span><span class="n">TX_DESC_BASE</span><span class="p">;</span>
	<span class="n">buf_desc_ptr</span> <span class="o">+=</span> <span class="n">desc</span><span class="p">;</span>	<span class="cm">/* points to the corresponding entry */</span>  
	<span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">desc_mode</span> <span class="o">=</span> <span class="n">AAL5</span> <span class="o">|</span> <span class="n">EOM_EN</span> <span class="o">|</span> <span class="n">APP_CRC32</span> <span class="o">|</span> <span class="n">CMPL_INT</span><span class="p">;</span>   
	<span class="cm">/* Huh ? p.115 of users guide describes this as a read-only register */</span>
        <span class="n">writew</span><span class="p">(</span><span class="n">TRANSMIT_DONE</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">seg_reg</span><span class="o">+</span><span class="n">SEG_INTR_STATUS_REG</span><span class="p">);</span>
	<span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">vc_index</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
	<span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">total_len</span><span class="p">;</span>  

        <span class="k">if</span> <span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">qos</span><span class="p">.</span><span class="n">txtp</span><span class="p">.</span><span class="n">traffic_class</span> <span class="o">==</span> <span class="n">ATM_ABR</span><span class="p">)</span>  
	   <span class="n">clear_lockup</span> <span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">iadev</span><span class="p">);</span>

	<span class="cm">/* Build the DLE structure */</span>  
	<span class="n">wr_ptr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">write</span><span class="p">;</span>  
	<span class="n">memset</span><span class="p">((</span><span class="n">caddr_t</span><span class="p">)</span><span class="n">wr_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wr_ptr</span><span class="p">));</span>  
	<span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">sys_pkt_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">local_pkt_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> 
                                                  <span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_lo</span><span class="p">;</span>  
	<span class="cm">/* wr_ptr-&gt;bytes = swap_byte_order(total_len); didn&#39;t seem to affect?? */</span>
	<span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>  

        <span class="cm">/* hw bug - DLEs of 0x2d, 0x2e, 0x2f cause DMA lockup */</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xb</span><span class="p">)</span>
           <span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>

	<span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">TX_DLE_PSI</span><span class="p">;</span> 
	<span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">prq_wr_ptr_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
	<span class="cm">/* end is not to be used for the DLE q */</span>  
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">wr_ptr</span> <span class="o">==</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>  
		<span class="n">wr_ptr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>  
        
        <span class="cm">/* Build trailer dle */</span>
        <span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">sys_pkt_addr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">[</span><span class="n">desc</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">dma_addr</span><span class="p">;</span>
        <span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">local_pkt_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> 
          <span class="n">buf_desc_ptr</span><span class="o">-&gt;</span><span class="n">buf_start_lo</span><span class="p">)</span> <span class="o">+</span> <span class="n">total_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpcs_trailer</span><span class="p">);</span>

        <span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">bytes</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpcs_trailer</span><span class="p">);</span>
        <span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">DMA_INT_ENABLE</span><span class="p">;</span> 
        <span class="n">wr_ptr</span><span class="o">-&gt;</span><span class="n">prq_wr_ptr_data</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">ffL</span><span class="p">.</span><span class="n">prq_wr</span><span class="p">;</span>
        
        <span class="cm">/* end is not to be used for the DLE q */</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">wr_ptr</span> <span class="o">==</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">end</span><span class="p">)</span>  
                <span class="n">wr_ptr</span> <span class="o">=</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>

	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dle_q</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">wr_ptr</span><span class="p">;</span>  
        <span class="n">ATM_DESC</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">=</span> <span class="n">vcc</span><span class="o">-&gt;</span><span class="n">vci</span><span class="p">;</span>
        <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_dma_q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

        <span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
        <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_pkt_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Increment transaction counter */</span>  
	<span class="n">writel</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="o">+</span><span class="n">IPHASE5575_TX_COUNTER</span><span class="p">);</span>  
        
<span class="cp">#if 0</span><span class="c">        </span>
<span class="c">        /* add flow control logic */ </span>
<span class="c">        if (atomic_read(&amp;vcc-&gt;stats-&gt;tx) % 20 == 0) {</span>
<span class="c">          if (iavcc-&gt;vc_desc_cnt &gt; 10) {</span>
<span class="c">             vcc-&gt;tx_quota =  vcc-&gt;tx_quota * 3 / 4;</span>
<span class="c">            printk(&quot;Tx1:  vcc-&gt;tx_quota = %d \n&quot;, (u32)vcc-&gt;tx_quota );</span>
<span class="c">              iavcc-&gt;flow_inc = -1;</span>
<span class="c">              iavcc-&gt;saved_tx_quota = vcc-&gt;tx_quota;</span>
<span class="c">           } else if ((iavcc-&gt;flow_inc &lt; 0) &amp;&amp; (iavcc-&gt;vc_desc_cnt &lt; 3)) {</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>vcc->tx<em>quota = 3 * iavcc->saved</em>tx_quota / 4;</p></td><td class="code"><div class="highlight"><pre><span class="c">             printk(&quot;Tx2:  vcc-&gt;tx_quota = %d \n&quot;, (u32)vcc-&gt;tx_quota ); </span>
<span class="c">              iavcc-&gt;flow_inc = 0;</span>
<span class="c">           }</span>
<span class="c">        }</span>
<span class="cp">#endif</span>
	<span class="n">IF_TX</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia send done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>  
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>  
<span class="p">}</span>  

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_vcc</span> <span class="o">*</span><span class="n">vcc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
        <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span> 
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

        <span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">&gt;</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cpcs_trailer</span><span class="p">))))</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;null skb in ia_send</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
            <span class="k">else</span> <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
        <span class="p">}</span>                         
        <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span> 
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ATM_VF_READY</span><span class="p">,</span><span class="o">&amp;</span><span class="n">vcc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)){</span> 
            <span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
            <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
            <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> 
        <span class="p">}</span>
        <span class="n">ATM_SKB</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">vcc</span> <span class="o">=</span> <span class="n">vcc</span><span class="p">;</span>
 
        <span class="k">if</span> <span class="p">(</span><span class="n">skb_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_backlog</span><span class="p">))</span> <span class="p">{</span>
           <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_backlog</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">ia_pkt_tx</span> <span class="p">(</span><span class="n">vcc</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
              <span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_backlog</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
           <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ia_proc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span> 
  <span class="kt">int</span>   <span class="n">left</span> <span class="o">=</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>   
  <span class="kt">char</span>  <span class="o">*</span><span class="n">tmpPtr</span><span class="p">;</span>
  <span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">FE_25MBIT_PHY</span><span class="p">)</span> <span class="p">{</span>
       <span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;  Board Type         :  Iphase5525-1KVC-128K</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
       <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
     <span class="p">}</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">FE_DS3_PHY</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;  Board Type         :  Iphase-ATM-DS3&quot;</span><span class="p">);</span>
     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">FE_E3_PHY</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;  Board Type         :  Iphase-ATM-E3&quot;</span><span class="p">);</span>
     <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">FE_UTP_OPTION</span><span class="p">)</span>
         <span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;  Board Type         :  Iphase-ATM-UTP155&quot;</span><span class="p">);</span> 
     <span class="k">else</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;  Board Type         :  Iphase-ATM-OC3&quot;</span><span class="p">);</span>
     <span class="n">tmpPtr</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
     <span class="k">if</span> <span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci_map_size</span> <span class="o">==</span> <span class="mh">0x40000</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmpPtr</span><span class="p">,</span> <span class="s">&quot;-1KVC-&quot;</span><span class="p">);</span>
     <span class="k">else</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmpPtr</span><span class="p">,</span> <span class="s">&quot;-4KVC-&quot;</span><span class="p">);</span>  
     <span class="n">tmpPtr</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span> 
     <span class="k">if</span> <span class="p">((</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memType</span> <span class="o">&amp;</span> <span class="n">MEM_SIZE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MEM_SIZE_1M</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmpPtr</span><span class="p">,</span> <span class="s">&quot;1M  </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">memType</span> <span class="o">&amp;</span> <span class="n">MEM_SIZE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MEM_SIZE_512K</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmpPtr</span><span class="p">,</span> <span class="s">&quot;512K</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="k">else</span>
       <span class="n">n</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">tmpPtr</span><span class="p">,</span> <span class="s">&quot;128K</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
     <span class="k">return</span> <span class="n">n</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left</span><span class="p">)</span> <span class="p">{</span>
     <span class="k">return</span>  <span class="n">sprintf</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="s">&quot;  Number of Tx Buffer:  %u</span><span class="se">\n</span><span class="s">&quot;</span>
                           <span class="s">&quot;  Size of Tx Buffer  :  %u</span><span class="se">\n</span><span class="s">&quot;</span>
                           <span class="s">&quot;  Number of Rx Buffer:  %u</span><span class="se">\n</span><span class="s">&quot;</span>
                           <span class="s">&quot;  Size of Rx Buffer  :  %u</span><span class="se">\n</span><span class="s">&quot;</span>
                           <span class="s">&quot;  Packets Receiverd  :  %u</span><span class="se">\n</span><span class="s">&quot;</span>
                           <span class="s">&quot;  Packets Transmitted:  %u</span><span class="se">\n</span><span class="s">&quot;</span>
                           <span class="s">&quot;  Cells Received     :  %u</span><span class="se">\n</span><span class="s">&quot;</span>
                           <span class="s">&quot;  Cells Transmitted  :  %u</span><span class="se">\n</span><span class="s">&quot;</span>
                           <span class="s">&quot;  Board Dropped Cells:  %u</span><span class="se">\n</span><span class="s">&quot;</span>
                           <span class="s">&quot;  Board Dropped Pkts :  %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">,</span>  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_buf_sz</span><span class="p">,</span>
                           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">num_rx_desc</span><span class="p">,</span>  <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_buf_sz</span><span class="p">,</span>
                           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_pkt_cnt</span><span class="p">,</span>   <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_pkt_cnt</span><span class="p">,</span>
                           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">rx_cell_cnt</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">tx_cell_cnt</span><span class="p">,</span>
                           <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">drop_rxcell</span><span class="p">,</span> <span class="n">iadev</span><span class="o">-&gt;</span><span class="n">drop_rxpkt</span><span class="p">);</span>                        
  <span class="p">}</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
  
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">atmdev_ops</span> <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>  
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">ia_open</span><span class="p">,</span>  
	<span class="p">.</span><span class="n">close</span>		<span class="o">=</span> <span class="n">ia_close</span><span class="p">,</span>  
	<span class="p">.</span><span class="n">ioctl</span>		<span class="o">=</span> <span class="n">ia_ioctl</span><span class="p">,</span>  
	<span class="p">.</span><span class="n">getsockopt</span>	<span class="o">=</span> <span class="n">ia_getsockopt</span><span class="p">,</span>  
	<span class="p">.</span><span class="n">setsockopt</span>	<span class="o">=</span> <span class="n">ia_setsockopt</span><span class="p">,</span>  
	<span class="p">.</span><span class="n">send</span>		<span class="o">=</span> <span class="n">ia_send</span><span class="p">,</span>  
	<span class="p">.</span><span class="n">phy_put</span>	<span class="o">=</span> <span class="n">ia_phy_put</span><span class="p">,</span>  
	<span class="p">.</span><span class="n">phy_get</span>	<span class="o">=</span> <span class="n">ia_phy_get</span><span class="p">,</span>  
	<span class="p">.</span><span class="n">change_qos</span>	<span class="o">=</span> <span class="n">ia_change_qos</span><span class="p">,</span>  
	<span class="p">.</span><span class="n">proc_read</span>	<span class="o">=</span> <span class="n">ia_proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>  
	  
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">ia_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>  
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>  
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span><span class="p">;</span>  
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">iadev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iadev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">iadev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ia detected at bus:%d dev: %d function:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">),</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">));)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free_iadev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">atm_dev_register</span><span class="p">(</span><span class="n">DEV_LABEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ops</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_disable_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_data</span> <span class="o">=</span> <span class="n">iadev</span><span class="p">;</span>
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="n">DEV_LABEL</span> <span class="s">&quot;registered at (itf :%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);)</span>
	<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;dev_id = 0x%p iadev-&gt;LineRate = %d </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">LineRate</span><span class="p">);)</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">ia_dev</span><span class="p">[</span><span class="n">iadev_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">iadev</span><span class="p">;</span>
	<span class="n">_ia_dev</span><span class="p">[</span><span class="n">iadev_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">iadev_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ia_init</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">ia_start</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>  
		<span class="n">IF_INIT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;IA register failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);)</span>
		<span class="n">iadev_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">ia_dev</span><span class="p">[</span><span class="n">iadev_count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">_ia_dev</span><span class="p">[</span><span class="n">iadev_count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_deregister_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;iadev_count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iadev_count</span><span class="p">);)</span>

	<span class="n">iadev</span><span class="o">-&gt;</span><span class="n">next_board</span> <span class="o">=</span> <span class="n">ia_boards</span><span class="p">;</span>  
	<span class="n">ia_boards</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>  

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_deregister_dev:</span>
	<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>  
<span class="nl">err_out_disable_dev:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_out_free_iadev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">ia_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atm_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">IADEV</span> <span class="o">*</span><span class="n">iadev</span> <span class="o">=</span> <span class="n">INPH_IA_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Disable phy interrupts */</span>
	<span class="n">ia_phy_put</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ia_phy_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SUNI_RSOP_CIE</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">SUNI_RSOP_CIE_LOSE</span><span class="p">),</span>
				   <span class="n">SUNI_RSOP_CIE</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* De-register device */</span>  
      	<span class="n">free_irq</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">iadev_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ia_dev</span><span class="p">[</span><span class="n">iadev_count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">_ia_dev</span><span class="p">[</span><span class="n">iadev_count</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">IF_EVENT</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;deregistering iav at (itf:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);)</span>
	<span class="n">atm_dev_deregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

      	<span class="n">iounmap</span><span class="p">(</span><span class="n">iadev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>  
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ia_free_rx</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
	<span class="n">ia_free_tx</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>

      	<span class="n">kfree</span><span class="p">(</span><span class="n">iadev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">ia_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IPHASE</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_IPHASE</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">ia_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">ia_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>         <span class="n">DEV_LABEL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>     <span class="n">ia_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>        <span class="n">ia_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span>       <span class="n">__devexit_p</span><span class="p">(</span><span class="n">ia_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ia_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ia_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia_timer</span><span class="p">);</span> 
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DEV_LABEL</span> <span class="s">&quot;: no adapter found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>  
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ia_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia_driver</span><span class="p">);</span>

        <span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ia_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ia_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ia_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
