<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › dio › dio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>dio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Code to support devices on the DIO and DIO-II bus</span>
<span class="cm"> * Copyright (C) 05/1998 Peter Maydell &lt;pmaydell@chiark.greenend.org.uk&gt;</span>
<span class="cm"> * Copyright (C) 2004 Jochen Friedrich &lt;jochen@scram.de&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * This code has basically these routines at the moment:</span>
<span class="cm"> * int dio_find(u_int deviceid)</span>
<span class="cm"> *    Search the list of DIO devices and return the select code</span>
<span class="cm"> *    of the next unconfigured device found that matches the given device ID.</span>
<span class="cm"> *    Note that the deviceid parameter should be the encoded ID.</span>
<span class="cm"> *    This means that framebuffers should pass it as </span>
<span class="cm"> *    DIO_ENCODE_ID(DIO_ID_FBUFFER,DIO_ID2_TOPCAT)</span>
<span class="cm"> *    (or whatever); everybody else just uses DIO_ID_FOOBAR.</span>
<span class="cm"> * unsigned long dio_scodetophysaddr(int scode)</span>
<span class="cm"> *    Return the physical address corresponding to the given select code.</span>
<span class="cm"> * int dio_scodetoipl(int scode)</span>
<span class="cm"> *    Every DIO card has a fixed interrupt priority level. This function </span>
<span class="cm"> *    returns it, whatever it is.</span>
<span class="cm"> * const char *dio_scodetoname(int scode)</span>
<span class="cm"> *    Return a character string describing this board [might be &quot;&quot; if </span>
<span class="cm"> *    not CONFIG_DIO_CONSTANTS]</span>
<span class="cm"> * void dio_config_board(int scode)     mark board as configured in the list</span>
<span class="cm"> * void dio_unconfig_board(int scode)   mark board as no longer configured</span>
<span class="cm"> *</span>
<span class="cm"> * This file is based on the way the Amiga port handles Zorro II cards, </span>
<span class="cm"> * although we aren&#39;t so complicated...</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/dio.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;                         </span><span class="cm">/* kmalloc() */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;                             </span><span class="cm">/* readb() */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">dio_bus</span> <span class="n">dio_bus</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">resources</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* DIO range */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DIO mem&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x00600000</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x007fffff</span> <span class="p">},</span>
		<span class="cm">/* DIO-II range */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DIO-II mem&quot;</span><span class="p">,</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mh">0x01000000</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x1fffffff</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DIO bus&quot;</span>
<span class="p">};</span>

<span class="cm">/* not a real config option yet! */</span>
<span class="cp">#define CONFIG_DIO_CONSTANTS</span>

<span class="cp">#ifdef CONFIG_DIO_CONSTANTS</span>
<span class="cm">/* We associate each numeric ID with an appropriate descriptive string</span>
<span class="cm"> * using a constant array of these structs.</span>
<span class="cm"> * FIXME: we should be able to arrange to throw away most of the strings</span>
<span class="cm"> * using the initdata stuff. Then we wouldn&#39;t need to worry about </span>
<span class="cm"> * carrying them around...</span>
<span class="cm"> * I think we do this by copying them into newly kmalloc()ed memory and </span>
<span class="cm"> * marking the names[] array as .initdata ?</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dioname</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* useful macro */</span>
<span class="cp">#define DIONAME(x) { DIO_ID_##x, DIO_DESC_##x }</span>
<span class="cp">#define DIOFBNAME(x) { DIO_ENCODE_ID( DIO_ID_FBUFFER, DIO_ID2_##x), DIO_DESC2_##x }</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dioname</span> <span class="n">names</span><span class="p">[]</span> <span class="o">=</span> 
<span class="p">{</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">DCA0</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">DCA0REM</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">DCA1</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">DCA1REM</span><span class="p">),</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">DCM</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">DCMREM</span><span class="p">),</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">LAN</span><span class="p">),</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">FHPIB</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">NHPIB</span><span class="p">),</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">SCSI0</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">SCSI1</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">SCSI2</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">SCSI3</span><span class="p">),</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">FBUFFER</span><span class="p">),</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">PARALLEL</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">VME</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">DCL</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">DCLREM</span><span class="p">),</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC0</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC1</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC2</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC3</span><span class="p">),</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC4</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC5</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC6</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC7</span><span class="p">),</span>
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC8</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC9</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC10</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC11</span><span class="p">),</span> 
        <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC12</span><span class="p">),</span> <span class="n">DIONAME</span><span class="p">(</span><span class="n">MISC13</span><span class="p">),</span>
        <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">GATORBOX</span><span class="p">),</span> <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">TOPCAT</span><span class="p">),</span> <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">RENAISSANCE</span><span class="p">),</span>
        <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">LRCATSEYE</span><span class="p">),</span> <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">HRCCATSEYE</span><span class="p">),</span> <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">HRMCATSEYE</span><span class="p">),</span>
        <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">DAVINCI</span><span class="p">),</span> <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">XXXCATSEYE</span><span class="p">),</span> <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">HYPERION</span><span class="p">),</span>
        <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">XGENESIS</span><span class="p">),</span> <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">TIGER</span><span class="p">),</span> <span class="n">DIOFBNAME</span><span class="p">(</span><span class="n">YGENESIS</span><span class="p">)</span>   
<span class="p">};</span>

<span class="cp">#undef DIONAME</span>
<span class="cp">#undef DIOFBNAME</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">unknowndioname</span> 
        <span class="o">=</span> <span class="s">&quot;unknown DIO board -- please email &lt;linux-m68k@lists.linux-m68k.org&gt;!&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">dio_getname</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
        <span class="cm">/* return pointer to a constant string describing the board with given ID */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">names</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> 
                        <span class="k">return</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>

        <span class="k">return</span> <span class="n">unknowndioname</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">dio_no_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
<span class="cp">#define dio_getname(_id)	(dio_no_name)</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_DIO_CONSTANTS */</span><span class="cp"></span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">dio_find</span><span class="p">(</span><span class="kt">int</span> <span class="n">deviceid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Called to find a DIO device before the full bus scan has run.</span>
<span class="cm">	 * Only used by the console driver.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">scode</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">prid</span><span class="p">,</span> <span class="n">secid</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">scode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scode</span> <span class="o">&lt;</span> <span class="n">DIO_SCMAX</span><span class="p">;</span> <span class="n">scode</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pa</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">DIO_SCINHOLE</span><span class="p">(</span><span class="n">scode</span><span class="p">))</span>
                        <span class="k">continue</span><span class="p">;</span>

                <span class="n">pa</span> <span class="o">=</span> <span class="n">dio_scodetophysaddr</span><span class="p">(</span><span class="n">scode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">&lt;</span> <span class="n">DIOII_SCBASE</span><span class="p">)</span>
			<span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">va</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

		<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">va</span> <span class="o">+</span> <span class="n">DIO_IDOFF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">&gt;=</span> <span class="n">DIOII_SCBASE</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>             <span class="cm">/* no board present at that select code */</span>
		<span class="p">}</span>

		<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
		<span class="n">prid</span> <span class="o">=</span> <span class="n">DIO_ID</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">DIO_NEEDSSECID</span><span class="p">(</span><span class="n">prid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">secid</span> <span class="o">=</span> <span class="n">DIO_SECID</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
                        <span class="n">id</span> <span class="o">=</span> <span class="n">DIO_ENCODE_ID</span><span class="p">(</span><span class="n">prid</span><span class="p">,</span> <span class="n">secid</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">prid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">deviceid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">&gt;=</span> <span class="n">DIOII_SCBASE</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">scode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is the function that scans the DIO space and works out what</span>
<span class="cm"> * hardware is actually present.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dio_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">scode</span><span class="p">;</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dio_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACH_IS_HP300</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Scanning for DIO devices...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Initialize the DIO bus */</span> 
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dio_bus</span><span class="p">.</span><span class="n">devices</span><span class="p">);</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dio_bus</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dio&quot;</span><span class="p">);</span>
	<span class="n">error</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dio_bus</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;DIO: Error registering dio_bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Request all resources */</span>
	<span class="n">dio_bus</span><span class="p">.</span><span class="n">num_resources</span> <span class="o">=</span> <span class="p">(</span><span class="n">hp300_model</span> <span class="o">==</span> <span class="n">HP_320</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dio_bus</span><span class="p">.</span><span class="n">num_resources</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dio_bus</span><span class="p">.</span><span class="n">resources</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Register all devices */</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">scode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">scode</span> <span class="o">&lt;</span> <span class="n">DIO_SCMAX</span><span class="p">;</span> <span class="o">++</span><span class="n">scode</span><span class="p">)</span>
        <span class="p">{</span>
                <span class="n">u_char</span> <span class="n">prid</span><span class="p">,</span> <span class="n">secid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>        <span class="cm">/* primary, secondary ID bytes */</span>
                <span class="n">u_char</span> <span class="o">*</span><span class="n">va</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pa</span><span class="p">;</span>
                
                <span class="k">if</span> <span class="p">(</span><span class="n">DIO_SCINHOLE</span><span class="p">(</span><span class="n">scode</span><span class="p">))</span>
                        <span class="k">continue</span><span class="p">;</span>

		<span class="n">pa</span> <span class="o">=</span> <span class="n">dio_scodetophysaddr</span><span class="p">(</span><span class="n">scode</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">&lt;</span> <span class="n">DIOII_SCBASE</span><span class="p">)</span>
			<span class="n">va</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">pa</span> <span class="o">+</span> <span class="n">DIO_VIRADDRBASE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">va</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

		<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">va</span> <span class="o">+</span> <span class="n">DIO_IDOFF</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">&gt;=</span> <span class="n">DIOII_SCBASE</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>              <span class="cm">/* no board present at that select code */</span>
		<span class="p">}</span>

		<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>

                <span class="cm">/* Found a board, allocate it an entry in the list */</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dio_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dio_bus</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dio_bus</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dio_bus_type</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">scode</span> <span class="o">=</span> <span class="n">scode</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">pa</span> <span class="o">+</span> <span class="n">DIO_SIZE</span><span class="p">(</span><span class="n">scode</span><span class="p">,</span> <span class="n">va</span><span class="p">);</span>
		<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%02x&quot;</span><span class="p">,</span> <span class="n">scode</span><span class="p">);</span>

                <span class="cm">/* read the ID byte(s) and encode if necessary. */</span>
		<span class="n">prid</span> <span class="o">=</span> <span class="n">DIO_ID</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">DIO_NEEDSSECID</span><span class="p">(</span><span class="n">prid</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">secid</span> <span class="o">=</span> <span class="n">DIO_SECID</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
                        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">DIO_ENCODE_ID</span><span class="p">(</span><span class="n">prid</span><span class="p">,</span> <span class="n">secid</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span>
                        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">prid</span><span class="p">;</span>

                <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ipl</span> <span class="o">=</span> <span class="n">DIO_IPL</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
                <span class="n">strcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">dio_getname</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;select code %3d: ipl %d: ID %02X&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">scode</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ipl</span><span class="p">,</span> <span class="n">prid</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">DIO_NEEDSSECID</span><span class="p">(</span><span class="n">prid</span><span class="p">))</span>
                        <span class="n">printk</span><span class="p">(</span><span class="s">&quot;:%02X&quot;</span><span class="p">,</span> <span class="n">secid</span><span class="p">);</span>
                <span class="n">printk</span><span class="p">(</span><span class="s">&quot;: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">&gt;=</span> <span class="n">DIOII_SCBASE</span><span class="p">)</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">va</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;DIO: Error registering device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">dio_create_sysfs_dev_files</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error creating sysfs files</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">subsys_initcall</span><span class="p">(</span><span class="n">dio_init</span><span class="p">);</span>

<span class="cm">/* Bear in mind that this is called in the very early stages of initialisation</span>
<span class="cm"> * in order to get the address of the serial port for the console...</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">dio_scodetophysaddr</span><span class="p">(</span><span class="kt">int</span> <span class="n">scode</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">&gt;=</span> <span class="n">DIOII_SCBASE</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">DIOII_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">scode</span> <span class="o">-</span> <span class="mi">132</span><span class="p">)</span> <span class="o">*</span> <span class="n">DIOII_DEVSIZE</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scode</span> <span class="o">&gt;</span> <span class="n">DIO_SCMAX</span> <span class="o">||</span> <span class="n">scode</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">DIO_SCINHOLE</span><span class="p">(</span><span class="n">scode</span><span class="p">))</span>
                <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">DIO_BASE</span> <span class="o">+</span> <span class="n">scode</span> <span class="o">*</span> <span class="n">DIO_DEVSIZE</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
