<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › crystalhd › crystalhd_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>crystalhd_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/***************************************************************************</span>
<span class="cm"> * Copyright (c) 2005-2009, Broadcom Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> *  Name: crystalhd_hw . c</span>
<span class="cm"> *</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *		BCM70010 Linux driver HW layer.</span>
<span class="cm"> *</span>
<span class="cm"> **********************************************************************</span>
<span class="cm"> * This file is part of the crystalhd device driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation, version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this driver.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> **********************************************************************/</span>

<span class="cp">#include &quot;crystalhd.h&quot;</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cm">/* Functions internal to this file */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_enable_uarts</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">UartSelectA</span><span class="p">,</span> <span class="n">BSVS_UART_STREAM</span><span class="p">);</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">UartSelectB</span><span class="p">,</span> <span class="n">BSVS_UART_DEC_OUTER</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_start_dram</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_PARAM</span><span class="p">,</span> <span class="p">((</span><span class="mi">40</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
	<span class="cm">/* tras (40ns tras)/(5ns period) -1 ((15/5 - 1) &lt;&lt;  4) | // trcd */</span>
		      <span class="p">((</span><span class="mi">15</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>  <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* trp */</span>
		      <span class="p">((</span><span class="mi">10</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* trrd */</span>
		      <span class="p">((</span><span class="mi">15</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* twr */</span>
		      <span class="p">((</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>		<span class="cm">/* twtr */</span>
		      <span class="p">((</span><span class="mi">70</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">)</span> <span class="o">|</span>	<span class="cm">/* trfc */</span>
		      <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">23</span><span class="p">));</span>

	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_PRECHARGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_EXT_MODE</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_MODE</span><span class="p">,</span> <span class="mh">0x132</span><span class="p">);</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_PRECHARGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_REFRESH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_REFRESH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_MODE</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>
	<span class="cm">/* setting the refresh rate here */</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_REF_PARAM</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mi">96</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_bring_out_of_rst</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">link_misc_perst_deco_ctrl</span> <span class="n">rst_deco_cntrl</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">link_misc_perst_clk_ctrl</span> <span class="n">rst_clk_cntrl</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Link clocks: MISC_PERST_CLOCK_CTRL Clear PLL power down bit,</span>
<span class="cm">	 * delay to allow PLL to lock Clear alternate clock, stop clock bits</span>
<span class="cm">	 */</span>
	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_CLOCK_CTRL</span><span class="p">);</span>
	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">pll_pwr_dn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_CLOCK_CTRL</span><span class="p">,</span> <span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_CLOCK_CTRL</span><span class="p">);</span>
	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">stop_core_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">sel_alt_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_CLOCK_CTRL</span><span class="p">,</span> <span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Bus Arbiter Timeout: GISB_ARBITER_TIMER</span>
<span class="cm">	 * Set internal bus arbiter timeout to 40us based on core clock speed</span>
<span class="cm">	 * (63MHz * 40us = 0x9D8)</span>
<span class="cm">	 */</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">GISB_ARBITER_TIMER</span><span class="p">,</span> <span class="mh">0x9D8</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Decoder clocks: MISC_PERST_DECODER_CTRL</span>
<span class="cm">	 * Enable clocks while 7412 reset is asserted, delay</span>
<span class="cm">	 * De-assert 7412 reset</span>
<span class="cm">	 */</span>
	<span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_DECODER_CTRL</span><span class="p">);</span>
	<span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">stop_bcm_7412_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">bcm7412_rst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_DECODER_CTRL</span><span class="p">,</span> <span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_DECODER_CTRL</span><span class="p">);</span>
	<span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">bcm7412_rst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_DECODER_CTRL</span><span class="p">,</span> <span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Disable OTP_CONTENT_MISC to 0 to disable all secure modes */</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">OTP_CONTENT_MISC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Clear bit 29 of 0x404 */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_TL_TRANSACTION_CONFIGURATION</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BC_BIT</span><span class="p">(</span><span class="mi">29</span><span class="p">);</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_TL_TRANSACTION_CONFIGURATION</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* 2.5V regulator must be set to 2.6 volts (+6%) */</span>
	<span class="cm">/* FIXME: jarod: what&#39;s the point of this reg read? */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_VREG_CTRL</span><span class="p">);</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_VREG_CTRL</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_put_in_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">link_misc_perst_deco_ctrl</span> <span class="n">rst_deco_cntrl</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">link_misc_perst_clk_ctrl</span>  <span class="n">rst_clk_cntrl</span><span class="p">;</span>
	<span class="kt">uint32_t</span>                  <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Decoder clocks: MISC_PERST_DECODER_CTRL</span>
<span class="cm">	 * Assert 7412 reset, delay</span>
<span class="cm">	 * Assert 7412 stop clock</span>
<span class="cm">	 */</span>
	<span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_DECODER_CTRL</span><span class="p">);</span>
	<span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">stop_bcm_7412_clk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_DECODER_CTRL</span><span class="p">,</span> <span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Bus Arbiter Timeout: GISB_ARBITER_TIMER</span>
<span class="cm">	 * Set internal bus arbiter timeout to 40us based on core clock speed</span>
<span class="cm">	 * (6.75MHZ * 40us = 0x10E)</span>
<span class="cm">	 */</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">GISB_ARBITER_TIMER</span><span class="p">,</span> <span class="mh">0x10E</span><span class="p">);</span>

	<span class="cm">/* Link clocks: MISC_PERST_CLOCK_CTRL</span>
<span class="cm">	 * Stop core clk, delay</span>
<span class="cm">	 * Set alternate clk, delay, set PLL power down</span>
<span class="cm">	 */</span>
	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_CLOCK_CTRL</span><span class="p">);</span>
	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">stop_core_clk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">sel_alt_clk</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_CLOCK_CTRL</span><span class="p">,</span> <span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_CLOCK_CTRL</span><span class="p">);</span>
	<span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">pll_pwr_dn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_CLOCK_CTRL</span><span class="p">,</span> <span class="n">rst_clk_cntrl</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Read and restore the Transaction Configuration Register</span>
<span class="cm">	 * after core reset</span>
<span class="cm">	 */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_TL_TRANSACTION_CONFIGURATION</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Link core soft reset: MISC3_RESET_CTRL</span>
<span class="cm">	 * - Write BIT[0]=1 and read it back for core reset to take place</span>
<span class="cm">	 */</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC3_RESET_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rst_deco_cntrl</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC3_RESET_CTRL</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* restore the transaction configuration register */</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_TL_TRANSACTION_CONFIGURATION</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">intr_mask_reg</span>   <span class="n">intr_mask</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_INTR_MSK_STS_REG</span><span class="p">);</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_pcie_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_pcie_rbusmast_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_pcie_rgr_bridge</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_rx_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_rx_err</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_tx_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_tx_err</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_INTR_MSK_SET_REG</span><span class="p">,</span> <span class="n">intr_mask</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">intr_mask_reg</span>   <span class="n">intr_mask</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_INTR_MSK_STS_REG</span><span class="p">);</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_pcie_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_pcie_rbusmast_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_pcie_rgr_bridge</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_rx_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_rx_err</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_tx_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">intr_mask</span><span class="p">.</span><span class="n">mask_tx_err</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_INTR_MSK_CLR_REG</span><span class="p">,</span> <span class="n">intr_mask</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_clear_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* FIXME: jarod: wouldn&#39;t we want to write a 0 to the reg? Or does the write clear the bits specified? */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_ERROR_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_ERROR_STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_ERROR_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_ERROR_STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_DMA_ERROR_STATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_DMA_ERROR_STATUS</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_clear_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">intr_sts</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_INTR_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr_sts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_INTR_CLR_REG</span><span class="p">,</span> <span class="n">intr_sts</span><span class="p">);</span>

		<span class="cm">/* Write End Of Interrupt for PCIE */</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_EOI_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_soft_rst</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* Assert c011 soft reset*/</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_HostSwReset</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="cm">/* Release c011 soft reset*/</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_HostSwReset</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="cm">/* Disable Stuffing..*/</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC2_GLOBAL_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC2_GLOBAL_CTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_load_firmware_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_DRAM_BASE_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">BC_DRAM_FW_CFG_ADDR</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">));</span>

	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">AES_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">AES_CONFIG_INFO</span><span class="p">,</span> <span class="p">(</span><span class="n">BC_DRAM_FW_CFG_ADDR</span> <span class="o">&amp;</span> <span class="mh">0x7FFFF</span><span class="p">));</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">AES_CMD</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* FIXME: jarod: I&#39;ve seen this fail, and introducing extra delays helps... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">AES_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_start_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dbg_options</span><span class="p">,</span> <span class="n">glb_cntrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg_pwrmgmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;Starting BCM70012 Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">reg_pwrmgmt</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_DLL_DATA_LINK_CONTROL</span><span class="p">);</span>
	<span class="n">reg_pwrmgmt</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASPM_L1_ENABLE</span><span class="p">;</span>

	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_DLL_DATA_LINK_CONTROL</span><span class="p">,</span> <span class="n">reg_pwrmgmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crystalhd_bring_out_of_rst</span><span class="p">(</span><span class="n">adp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed To Bring Link Out Of Reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crystalhd_disable_interrupts</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>

	<span class="n">crystalhd_clear_errors</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>

	<span class="n">crystalhd_clear_interrupts</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>

	<span class="n">crystalhd_enable_interrupts</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>

	<span class="cm">/* Enable the option for getting the total no. of DWORDS</span>
<span class="cm">	 * that have been transferred by the RXDMA engine</span>
<span class="cm">	 */</span>
	<span class="n">dbg_options</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_DMA_DEBUG_OPTIONS_REG</span><span class="p">);</span>
	<span class="n">dbg_options</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_DMA_DEBUG_OPTIONS_REG</span><span class="p">,</span> <span class="n">dbg_options</span><span class="p">);</span>

	<span class="cm">/* Enable PCI Global Control options */</span>
	<span class="n">glb_cntrl</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC2_GLOBAL_CTRL</span><span class="p">);</span>
	<span class="n">glb_cntrl</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="n">glb_cntrl</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC2_GLOBAL_CTRL</span><span class="p">,</span> <span class="n">glb_cntrl</span><span class="p">);</span>

	<span class="n">crystalhd_enable_interrupts</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>

	<span class="n">crystalhd_soft_rst</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>
	<span class="n">crystalhd_start_dram</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>
	<span class="n">crystalhd_enable_uarts</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_stop_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;Stopping BCM70012 Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* Clear and disable interrupts */</span>
	<span class="n">crystalhd_disable_interrupts</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>
	<span class="n">crystalhd_clear_errors</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>
	<span class="n">crystalhd_clear_interrupts</span><span class="p">(</span><span class="n">adp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crystalhd_put_in_reset</span><span class="p">(</span><span class="n">adp</span><span class="p">))</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to Put Link To Reset State</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_DLL_DATA_LINK_CONTROL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">ASPM_L1_ENABLE</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_DLL_DATA_LINK_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Set PCI Clk Req */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_CLK_REQ_REG</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">PCI_CLK_REQ_ENABLE</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_CLK_REQ_REG</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="nf">crystalhd_hw_alloc_rx_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">temp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_pool_head</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_pool_head</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_pool_head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">temp</span><span class="o">-&gt;</span><span class="n">dio_req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">temp</span><span class="o">-&gt;</span><span class="n">pkt_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">temp</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_hw_free_rx_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">pkt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pkt</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_pool_head</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_pool_head</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Call back from TX - IOQ deletion.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will release the TX DMA rings allocated</span>
<span class="cm"> * druing setup_dma rings interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Memory is allocated per DMA ring basis. This is just</span>
<span class="cm"> * a place holder to be able to create the dio queues.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_tx_desc_rel_call_back</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Rx Packet release callback..</span>
<span class="cm"> *</span>
<span class="cm"> * Release All user mapped capture buffers and Our DMA packets</span>
<span class="cm"> * back to our free pool. The actual cleanup of the DMA</span>
<span class="cm"> * ring descriptors happen during dma ring release.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_rx_pkt_rel_call_back</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="p">)</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pkt</span> <span class="o">||</span> <span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid arg - %p %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dio_req</span><span class="p">)</span>
		<span class="n">crystalhd_unmap_dio</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">dio_req</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Missing dio_req: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">pkt_tag</span><span class="p">);</span>

	<span class="n">crystalhd_hw_free_rx_pkt</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pkt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define crystalhd_hw_delete_ioq(adp, q)		\</span>
<span class="cp">	if (q) {				\</span>
<span class="cp">		crystalhd_delete_dioq(adp, q);	\</span>
<span class="cp">		q = NULL;			\</span>
<span class="cp">	}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_hw_delete_ioqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Deleting IOQs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">crystalhd_hw_delete_ioq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_actq</span><span class="p">);</span>
	<span class="n">crystalhd_hw_delete_ioq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_freeq</span><span class="p">);</span>
	<span class="n">crystalhd_hw_delete_ioq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_actq</span><span class="p">);</span>
	<span class="n">crystalhd_hw_delete_ioq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_freeq</span><span class="p">);</span>
	<span class="n">crystalhd_hw_delete_ioq</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_rdyq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define crystalhd_hw_create_ioq(sts, hw, q, cb)			\</span>
<span class="cp">do {								\</span>
<span class="cp">	sts = crystalhd_create_dioq(hw-&gt;adp, &amp;q, cb, hw);	\</span>
<span class="cp">	if (sts != BC_STS_SUCCESS)				\</span>
<span class="cp">		goto hw_create_ioq_err;				\</span>
<span class="cp">} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * Create IOQs..</span>
<span class="cm"> *</span>
<span class="cm"> * TX - Active &amp; Free</span>
<span class="cm"> * RX - Active, Ready and Free.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_create_ioqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span>   <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span>   <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crystalhd_hw_create_ioq</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_freeq</span><span class="p">,</span>
			      <span class="n">crystalhd_tx_desc_rel_call_back</span><span class="p">);</span>
	<span class="n">crystalhd_hw_create_ioq</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_actq</span><span class="p">,</span>
			      <span class="n">crystalhd_tx_desc_rel_call_back</span><span class="p">);</span>

	<span class="n">crystalhd_hw_create_ioq</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_freeq</span><span class="p">,</span>
			      <span class="n">crystalhd_rx_pkt_rel_call_back</span><span class="p">);</span>
	<span class="n">crystalhd_hw_create_ioq</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_rdyq</span><span class="p">,</span>
			      <span class="n">crystalhd_rx_pkt_rel_call_back</span><span class="p">);</span>
	<span class="n">crystalhd_hw_create_ioq</span><span class="p">(</span><span class="n">sts</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_actq</span><span class="p">,</span>
			      <span class="n">crystalhd_rx_pkt_rel_call_back</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>

<span class="nl">hw_create_ioq_err:</span>
	<span class="n">crystalhd_hw_delete_ioqs</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_code_in_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">needed_sz</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="n">b_188_byte_pkts</span><span class="p">,</span>  <span class="kt">uint8_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">base</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">writep</span><span class="p">,</span> <span class="n">readp</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">cpbSize</span><span class="p">,</span> <span class="n">cpbFullness</span><span class="p">,</span> <span class="n">fifoSize</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ASF Bit is set */</span>
		<span class="n">base</span>   <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_Dec_TsAudCDB2Base</span><span class="p">);</span>
		<span class="n">end</span>    <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_Dec_TsAudCDB2End</span><span class="p">);</span>
		<span class="n">writep</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_Dec_TsAudCDB2Wrptr</span><span class="p">);</span>
		<span class="n">readp</span>  <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_Dec_TsAudCDB2Rdptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b_188_byte_pkts</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/*Encrypted 188 byte packets*/</span>
		<span class="n">base</span>   <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_Dec_TsUser0Base</span><span class="p">);</span>
		<span class="n">end</span>    <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_Dec_TsUser0End</span><span class="p">);</span>
		<span class="n">writep</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_Dec_TsUser0Wrptr</span><span class="p">);</span>
		<span class="n">readp</span>  <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_Dec_TsUser0Rdptr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">base</span>   <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_DecCA_RegCinBase</span><span class="p">);</span>
		<span class="n">end</span>    <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_DecCA_RegCinEnd</span><span class="p">);</span>
		<span class="n">writep</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_DecCA_RegCinWrPtr</span><span class="p">);</span>
		<span class="n">readp</span>  <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">REG_DecCA_RegCinRdPtr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cpbSize</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">writep</span> <span class="o">&gt;=</span> <span class="n">readp</span><span class="p">)</span>
		<span class="n">cpbFullness</span> <span class="o">=</span> <span class="n">writep</span> <span class="o">-</span> <span class="n">readp</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cpbFullness</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">base</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">readp</span> <span class="o">-</span> <span class="n">writep</span><span class="p">);</span>

	<span class="n">fifoSize</span> <span class="o">=</span> <span class="n">cpbSize</span> <span class="o">-</span> <span class="n">cpbFullness</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fifoSize</span> <span class="o">&lt;</span> <span class="n">BC_INFIFO_THRESHOLD</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">needed_sz</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fifoSize</span> <span class="o">-</span> <span class="n">BC_INFIFO_THRESHOLD</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_tx_req_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					    <span class="kt">uint32_t</span> <span class="n">list_id</span><span class="p">,</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_dma_pkt</span> <span class="o">*</span><span class="n">tx_req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pwr_lock</span><span class="o">--</span><span class="p">;</span>

	<span class="n">tx_req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_dma_pkt</span> <span class="o">*</span><span class="p">)</span><span class="n">crystalhd_dioq_find_and_fetch</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_actq</span><span class="p">,</span> <span class="n">list_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span> <span class="o">!=</span> <span class="n">BC_STS_IO_USER_ABORT</span><span class="p">)</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Find and Fetch Did not find req</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_NO_DATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">call_back</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">call_back</span><span class="p">(</span><span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">dio_req</span><span class="p">,</span> <span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">cb_event</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
		<span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">dio_req</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">cb_event</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">call_back</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Missing Tx Callback - %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">list_tag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now put back the tx_list back in FreeQ */</span>
	<span class="n">tx_req</span><span class="o">-&gt;</span><span class="n">list_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">crystalhd_dioq_add</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_freeq</span><span class="p">,</span> <span class="n">tx_req</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_tx_list0_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">err_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">err_mask</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L0_DESC_TX_ABORT_ERRORS_MASK</span> <span class="o">|</span>
		<span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L0_DMA_DATA_TX_ABORT_ERRORS_MASK</span> <span class="o">|</span>
		<span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L0_FIFO_FULL_ERRORS_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err_sts</span> <span class="o">&amp;</span> <span class="n">err_mask</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Error on Tx-L0 %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_sts</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">err_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L0_FIFO_FULL_ERRORS_MASK</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L0_FIFO_FULL_ERRORS_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* reset list index.*/</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_list_post_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">err_sts</span> <span class="o">&amp;</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_DMA_ERROR_STATUS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_tx_list1_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">err_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">err_mask</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err_mask</span> <span class="o">=</span> <span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L1_DESC_TX_ABORT_ERRORS_MASK</span> <span class="o">|</span>
		<span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L1_DMA_DATA_TX_ABORT_ERRORS_MASK</span> <span class="o">|</span>
		<span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L1_FIFO_FULL_ERRORS_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">err_sts</span> <span class="o">&amp;</span> <span class="n">err_mask</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Error on Tx-L1 %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_sts</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">err_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L1_FIFO_FULL_ERRORS_MASK</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_TX_DMA_ERROR_STATUS_TX_L1_FIFO_FULL_ERRORS_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="cm">/* reset list index.*/</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_list_post_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">err_sts</span> <span class="o">&amp;</span> <span class="n">err_mask</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_DMA_ERROR_STATUS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_tx_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">int_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">err_sts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_sts</span> <span class="o">&amp;</span> <span class="n">INTR_INTR_STATUS_L0_TX_DMA_DONE_INTR_MASK</span><span class="p">)</span>
		<span class="n">crystalhd_hw_tx_req_complete</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_ioq_tag_seed</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">BC_STS_SUCCESS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_sts</span> <span class="o">&amp;</span> <span class="n">INTR_INTR_STATUS_L1_TX_DMA_DONE_INTR_MASK</span><span class="p">)</span>
		<span class="n">crystalhd_hw_tx_req_complete</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_ioq_tag_seed</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					   <span class="n">BC_STS_SUCCESS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">int_sts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">INTR_INTR_STATUS_L0_TX_DMA_ERR_INTR_MASK</span> <span class="o">|</span>
			<span class="n">INTR_INTR_STATUS_L1_TX_DMA_ERR_INTR_MASK</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* No error mask set.. */</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle Tx errors. */</span>
	<span class="n">err_sts</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_DMA_ERROR_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crystalhd_tx_list0_handler</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">err_sts</span><span class="p">))</span>
		<span class="n">crystalhd_hw_tx_req_complete</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_ioq_tag_seed</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="n">BC_STS_ERROR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crystalhd_tx_list1_handler</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">err_sts</span><span class="p">))</span>
		<span class="n">crystalhd_hw_tx_req_complete</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_ioq_tag_seed</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
					   <span class="n">BC_STS_ERROR</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_hw_dump_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_descriptor</span> <span class="o">*</span><span class="n">p_dma_desc</span><span class="p">,</span>
				 <span class="kt">uint32_t</span> <span class="n">ul_desc_index</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">ix</span><span class="p">,</span> <span class="n">ll</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dma_desc</span> <span class="o">||</span> <span class="o">!</span><span class="n">cnt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* FIXME: jarod: perhaps a modparam desc_debug to enable this, rather than</span>
<span class="cm">	 * setting ll (log level, I presume) to non-zero? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ll</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="n">ul_desc_index</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ul_desc_index</span> <span class="o">+</span> <span class="n">cnt</span><span class="p">);</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">ll</span><span class="p">,</span> <span class="s">&quot;%s[%d] Buff[%x:%x] Next:[%x:%x] XferSz:%x Intr:%x,Last:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">p_dma_desc</span><span class="p">[</span><span class="n">ul_desc_index</span><span class="p">].</span><span class="n">dma_dir</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;TDesc&quot;</span> <span class="o">:</span> <span class="s">&quot;RDesc&quot;</span><span class="p">),</span>
		       <span class="n">ul_desc_index</span><span class="p">,</span>
		       <span class="n">p_dma_desc</span><span class="p">[</span><span class="n">ul_desc_index</span><span class="p">].</span><span class="n">buff_addr_high</span><span class="p">,</span>
		       <span class="n">p_dma_desc</span><span class="p">[</span><span class="n">ul_desc_index</span><span class="p">].</span><span class="n">buff_addr_low</span><span class="p">,</span>
		       <span class="n">p_dma_desc</span><span class="p">[</span><span class="n">ul_desc_index</span><span class="p">].</span><span class="n">next_desc_addr_high</span><span class="p">,</span>
		       <span class="n">p_dma_desc</span><span class="p">[</span><span class="n">ul_desc_index</span><span class="p">].</span><span class="n">next_desc_addr_low</span><span class="p">,</span>
		       <span class="n">p_dma_desc</span><span class="p">[</span><span class="n">ul_desc_index</span><span class="p">].</span><span class="n">xfer_size</span><span class="p">,</span>
		       <span class="n">p_dma_desc</span><span class="p">[</span><span class="n">ul_desc_index</span><span class="p">].</span><span class="n">intr_enable</span><span class="p">,</span>
		       <span class="n">p_dma_desc</span><span class="p">[</span><span class="n">ul_desc_index</span><span class="p">].</span><span class="n">last_rec_indicator</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_fill_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">ioreq</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">dma_descriptor</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span>
				      <span class="n">dma_addr_t</span> <span class="n">desc_paddr_base</span><span class="p">,</span>
				      <span class="kt">uint32_t</span> <span class="n">sg_cnt</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sg_st_ix</span><span class="p">,</span>
				      <span class="kt">uint32_t</span> <span class="n">sg_st_off</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">xfr_sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sg_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">last_desc_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">desc_phy_addr</span> <span class="o">=</span> <span class="n">desc_paddr_base</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">addr_64</span> <span class="n">addr_temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioreq</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc_paddr_base</span> <span class="o">||</span> <span class="o">!</span><span class="n">xfr_sz</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">sg_cnt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">dir_tx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">sg_cnt</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Setup SGLE index. */</span>
		<span class="n">sg_ix</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">+</span> <span class="n">sg_st_ix</span><span class="p">;</span>

		<span class="cm">/* Get SGLE length */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">crystalhd_get_sgle_len</span><span class="p">(</span><span class="n">ioreq</span><span class="p">,</span> <span class="n">sg_ix</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot; len in sg %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">sg_ix</span><span class="p">,</span> <span class="n">sg_cnt</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BC_STS_NOT_IMPL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Setup DMA desc with Phy addr &amp; Length at current index. */</span>
		<span class="n">addr_temp</span><span class="p">.</span><span class="n">full_addr</span> <span class="o">=</span> <span class="n">crystalhd_get_sgle_paddr</span><span class="p">(</span><span class="n">ioreq</span><span class="p">,</span> <span class="n">sg_ix</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sg_ix</span> <span class="o">==</span> <span class="n">sg_st_ix</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr_temp</span><span class="p">.</span><span class="n">full_addr</span> <span class="o">+=</span> <span class="n">sg_st_off</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="n">sg_st_off</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">]));</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">buff_addr_low</span>  <span class="o">=</span> <span class="n">addr_temp</span><span class="p">.</span><span class="n">low_part</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">buff_addr_high</span> <span class="o">=</span> <span class="n">addr_temp</span><span class="p">.</span><span class="n">high_part</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">dma_dir</span>        <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">dir_tx</span><span class="p">;</span>

		<span class="cm">/* Chain DMA descriptor.  */</span>
		<span class="n">addr_temp</span><span class="p">.</span><span class="n">full_addr</span> <span class="o">=</span> <span class="n">desc_phy_addr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_descriptor</span><span class="p">);</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">next_desc_addr_low</span> <span class="o">=</span> <span class="n">addr_temp</span><span class="p">.</span><span class="n">low_part</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">next_desc_addr_high</span> <span class="o">=</span> <span class="n">addr_temp</span><span class="p">.</span><span class="n">high_part</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">xfr_sz</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">xfr_sz</span> <span class="o">-</span> <span class="n">count</span><span class="p">;</span>

		<span class="cm">/* Debug.. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">crystalhd_get_sgle_len</span><span class="p">(</span><span class="n">ioreq</span><span class="p">,</span> <span class="n">sg_ix</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;inv-len(%x) Ix(%d) count:%x xfr_sz:%x sg_cnt:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">len</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">xfr_sz</span><span class="p">,</span> <span class="n">sg_cnt</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Length expects Multiple of 4 */</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">xfer_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">crystalhd_hw_dump_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">ix</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">count</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">desc_phy_addr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_descriptor</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">last_desc_ix</span> <span class="o">=</span> <span class="n">ix</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">fb_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">]));</span>
		<span class="n">addr_temp</span><span class="p">.</span><span class="n">full_addr</span>     <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">fb_pa</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">buff_addr_low</span>  <span class="o">=</span> <span class="n">addr_temp</span><span class="p">.</span><span class="n">low_part</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">buff_addr_high</span> <span class="o">=</span> <span class="n">addr_temp</span><span class="p">.</span><span class="n">high_part</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">dma_dir</span>        <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">dir_tx</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">xfer_size</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">desc</span><span class="p">[</span><span class="n">ix</span><span class="p">].</span><span class="n">fill_bytes</span>	<span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">fb_size</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">fb_size</span><span class="p">;</span>
		<span class="n">last_desc_ix</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* setup last descriptor..*/</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">last_desc_ix</span><span class="p">].</span><span class="n">last_rec_indicator</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">last_desc_ix</span><span class="p">].</span><span class="n">next_desc_addr_low</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">last_desc_ix</span><span class="p">].</span><span class="n">next_desc_addr_high</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">desc</span><span class="p">[</span><span class="n">last_desc_ix</span><span class="p">].</span><span class="n">intr_enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">crystalhd_hw_dump_desc</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">last_desc_ix</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">xfr_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;internal error sz curr:%x exp:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">xfr_sz</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_xlat_sgl_to_dma_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">ioreq</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">dma_desc_mem</span> <span class="o">*</span><span class="n">pdesc_mem</span><span class="p">,</span>
					      <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">uv_desc_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dma_descriptor</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">desc_paddr_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sg_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sg_st_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sg_st_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">xfr_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Check params.. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioreq</span> <span class="o">||</span> <span class="o">!</span><span class="n">pdesc_mem</span> <span class="o">||</span> <span class="o">!</span><span class="n">uv_desc_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdesc_mem</span><span class="o">-&gt;</span><span class="n">sz</span> <span class="o">||</span> <span class="o">!</span><span class="n">pdesc_mem</span><span class="o">-&gt;</span><span class="n">pdma_desc_start</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">sg</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">sg_cnt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">dir_tx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">dir_tx</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_offset</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;UV offset for TX??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">pdesc_mem</span><span class="o">-&gt;</span><span class="n">pdma_desc_start</span><span class="p">;</span>
	<span class="n">desc_paddr_base</span> <span class="o">=</span> <span class="n">pdesc_mem</span><span class="o">-&gt;</span><span class="n">phy_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">dir_tx</span> <span class="o">||</span> <span class="p">(</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sg_cnt</span> <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">sg_cnt</span><span class="p">;</span>
		<span class="n">xfr_sz</span> <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">xfr_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sg_cnt</span> <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_sg_ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xfr_sz</span> <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_fill_desc</span><span class="p">(</span><span class="n">ioreq</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">desc_paddr_base</span><span class="p">,</span> <span class="n">sg_cnt</span><span class="p">,</span>
				   <span class="n">sg_st_ix</span><span class="p">,</span> <span class="n">sg_st_off</span><span class="p">,</span> <span class="n">xfr_sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>

	<span class="cm">/* Prepare for UV mapping.. */</span>
	<span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdesc_mem</span><span class="o">-&gt;</span><span class="n">pdma_desc_start</span><span class="p">[</span><span class="n">sg_cnt</span><span class="p">];</span>
	<span class="n">desc_paddr_base</span> <span class="o">=</span> <span class="n">pdesc_mem</span><span class="o">-&gt;</span><span class="n">phy_addr</span> <span class="o">+</span>
			  <span class="p">(</span><span class="n">sg_cnt</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_descriptor</span><span class="p">));</span>

	<span class="cm">/* Done with desc addr.. now update sg stuff.*/</span>
	<span class="n">sg_cnt</span>    <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">sg_cnt</span> <span class="o">-</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_sg_ix</span><span class="p">;</span>
	<span class="n">xfr_sz</span>    <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">xfr_len</span> <span class="o">-</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_offset</span><span class="p">;</span>
	<span class="n">sg_st_ix</span>  <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_sg_ix</span><span class="p">;</span>
	<span class="n">sg_st_off</span> <span class="o">=</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_sg_off</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_fill_desc</span><span class="p">(</span><span class="n">ioreq</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">desc_paddr_base</span><span class="p">,</span> <span class="n">sg_cnt</span><span class="p">,</span>
				   <span class="n">sg_st_ix</span><span class="p">,</span> <span class="n">sg_st_off</span><span class="p">,</span> <span class="n">xfr_sz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>

	<span class="o">*</span><span class="n">uv_desc_index</span> <span class="o">=</span> <span class="n">sg_st_ix</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_start_tx_dma_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dma_cntrl</span><span class="p">;</span>

	<span class="n">dma_cntrl</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_SW_DESC_LIST_CTRL_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dma_cntrl</span> <span class="o">&amp;</span> <span class="n">DMA_START_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_cntrl</span> <span class="o">|=</span> <span class="n">DMA_START_BIT</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_SW_DESC_LIST_CTRL_STS</span><span class="p">,</span>
			       <span class="n">dma_cntrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* _CHECK_THIS_</span>
<span class="cm"> *</span>
<span class="cm"> * Verify if the Stop generates a completion interrupt or not.</span>
<span class="cm"> * if it does not generate an interrupt, then add polling here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_stop_tx_dma_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dma_cntrl</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">l1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dma_cntrl</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_SW_DESC_LIST_CTRL_STS</span><span class="p">);</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Stopping TX DMA Engine..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dma_cntrl</span> <span class="o">&amp;</span> <span class="n">DMA_START_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Already Stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crystalhd_disable_interrupts</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">);</span>

	<span class="cm">/* Issue stop to HW */</span>
	<span class="cm">/* This bit when set gave problems. Please check*/</span>
	<span class="n">dma_cntrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_START_BIT</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_SW_DESC_LIST_CTRL_STS</span><span class="p">,</span> <span class="n">dma_cntrl</span><span class="p">);</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Cleared the DMA Start bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Poll for 3seconds (30 * 100ms) on both the lists..*/</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">l1</span> <span class="o">||</span> <span class="n">l2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l1</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_FIRST_DESC_L_ADDR_LIST0</span><span class="p">);</span>
			<span class="n">l1</span> <span class="o">&amp;=</span> <span class="n">DMA_START_BIT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l2</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_TX_FIRST_DESC_L_ADDR_LIST1</span><span class="p">);</span>
			<span class="n">l2</span> <span class="o">&amp;=</span> <span class="n">DMA_START_BIT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to stop TX DMA.. l1 %d, l2 %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">);</span>
		<span class="n">crystalhd_enable_interrupts</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_list_post_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;stopped TX DMA..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">crystalhd_enable_interrupts</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">crystalhd_get_pib_avail_cnt</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	* Position of the PIB Entries can be found at</span>
<span class="cm">	* 0th and the 1st location of the Circular list.</span>
<span class="cm">	*/</span>
	<span class="kt">uint32_t</span> <span class="n">Q_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pib_cnt</span><span class="p">,</span> <span class="n">r_offset</span><span class="p">,</span> <span class="n">w_offset</span><span class="p">;</span>

	<span class="n">Q_addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pib_del_Q_addr</span><span class="p">;</span>

	<span class="cm">/* Get the Read Pointer */</span>
	<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_offset</span><span class="p">);</span>

	<span class="cm">/* Get the Write Pointer */</span>
	<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_offset</span> <span class="o">==</span> <span class="n">w_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Queue is empty */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w_offset</span> <span class="o">&gt;</span> <span class="n">r_offset</span><span class="p">)</span>
		<span class="n">pib_cnt</span> <span class="o">=</span> <span class="n">w_offset</span> <span class="o">-</span> <span class="n">r_offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pib_cnt</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_offset</span> <span class="o">+</span> <span class="n">MAX_PIB_Q_DEPTH</span><span class="p">)</span> <span class="o">-</span>
			  <span class="p">(</span><span class="n">r_offset</span> <span class="o">+</span> <span class="n">MIN_PIB_Q_DEPTH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pib_cnt</span> <span class="o">&gt;</span> <span class="n">MAX_PIB_Q_DEPTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid PIB Count (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pib_cnt</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">pib_cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">uint32_t</span> <span class="nf">crystalhd_get_addr_from_pib_Q</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">Q_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">addr_entry</span><span class="p">,</span> <span class="n">r_offset</span><span class="p">,</span> <span class="n">w_offset</span><span class="p">;</span>

	<span class="n">Q_addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pib_del_Q_addr</span><span class="p">;</span>

	<span class="cm">/* Get the Read Pointer 0Th Location is Read Pointer */</span>
	<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_offset</span><span class="p">);</span>

	<span class="cm">/* Get the Write Pointer 1st Location is Write pointer */</span>
	<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_offset</span><span class="p">);</span>

	<span class="cm">/* Queue is empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r_offset</span> <span class="o">==</span> <span class="n">w_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r_offset</span> <span class="o">&lt;</span> <span class="n">MIN_PIB_Q_DEPTH</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">r_offset</span> <span class="o">&gt;=</span> <span class="n">MAX_PIB_Q_DEPTH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get the Actual Address of the PIB */</span>
	<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">r_offset</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)),</span>
		       <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_entry</span><span class="p">);</span>

	<span class="cm">/* Increment the Read Pointer */</span>
	<span class="n">r_offset</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MAX_PIB_Q_DEPTH</span> <span class="o">==</span> <span class="n">r_offset</span><span class="p">)</span>
		<span class="n">r_offset</span> <span class="o">=</span> <span class="n">MIN_PIB_Q_DEPTH</span><span class="p">;</span>

	<span class="cm">/* Write back the read pointer to It&#39;s Location */</span>
	<span class="n">crystalhd_mem_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">addr_entry</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_rel_addr_to_pib_Q</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">addr_to_rel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">Q_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">r_offset</span><span class="p">,</span> <span class="n">w_offset</span><span class="p">,</span> <span class="n">n_offset</span><span class="p">;</span>

	<span class="n">Q_addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pib_rel_Q_addr</span><span class="p">;</span>

	<span class="cm">/* Get the Read Pointer */</span>
	<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r_offset</span><span class="p">);</span>

	<span class="cm">/* Get the Write Pointer */</span>
	<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">r_offset</span> <span class="o">&lt;</span> <span class="n">MIN_PIB_Q_DEPTH</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">r_offset</span> <span class="o">&gt;=</span> <span class="n">MAX_PIB_Q_DEPTH</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">n_offset</span> <span class="o">=</span> <span class="n">w_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MAX_PIB_Q_DEPTH</span> <span class="o">==</span> <span class="n">n_offset</span><span class="p">)</span>
		<span class="n">n_offset</span> <span class="o">=</span> <span class="n">MIN_PIB_Q_DEPTH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r_offset</span> <span class="o">==</span> <span class="n">n_offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="cm">/* should never happen */</span>

	<span class="cm">/* Write the DRAM ADDR to the Queue at Next Offset */</span>
	<span class="n">crystalhd_mem_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">w_offset</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)),</span>
		       <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_to_rel</span><span class="p">);</span>

	<span class="cm">/* Put the New value of the write pointer in Queue */</span>
	<span class="n">crystalhd_mem_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Q_addr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cpy_pib_to_app</span><span class="p">(</span><span class="k">struct</span> <span class="n">c011_pib</span> <span class="o">*</span><span class="n">src_pib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">BC_PIC_INFO_BLOCK</span> <span class="o">*</span><span class="n">dst_pib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src_pib</span> <span class="o">||</span> <span class="o">!</span><span class="n">dst_pib</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">timeStamp</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">picture_number</span>      <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ppb</span><span class="p">.</span><span class="n">picture_number</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">width</span>               <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ppb</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">height</span>              <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ppb</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">chroma_format</span>       <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ppb</span><span class="p">.</span><span class="n">chroma_format</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">pulldown</span>            <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ppb</span><span class="p">.</span><span class="n">pulldown</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">flags</span>               <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ppb</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">sess_num</span>            <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ptsStcOffset</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">aspect_ratio</span>        <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ppb</span><span class="p">.</span><span class="n">aspect_ratio</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">colour_primaries</span>     <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ppb</span><span class="p">.</span><span class="n">colour_primaries</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">picture_meta_payload</span> <span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">ppb</span><span class="p">.</span><span class="n">picture_meta_payload</span><span class="p">;</span>
	<span class="n">dst_pib</span><span class="o">-&gt;</span><span class="n">frame_rate</span>		<span class="o">=</span> <span class="n">src_pib</span><span class="o">-&gt;</span><span class="n">resolution</span> <span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_hw_proc_pib</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">c011_pib</span> <span class="n">src_pib</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">pib_addr</span><span class="p">,</span> <span class="n">pib_cnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BC_PIC_INFO_BLOCK</span> <span class="o">*</span><span class="n">AppPib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">rx_pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pib_cnt</span> <span class="o">=</span> <span class="n">crystalhd_get_pib_avail_cnt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pib_cnt</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="n">pib_cnt</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pib_addr</span> <span class="o">=</span> <span class="n">crystalhd_get_addr_from_pib_Q</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">pib_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">c011_pib</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">src_pib</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">src_pib</span><span class="p">.</span><span class="n">bFormatChange</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="p">)</span><span class="n">crystalhd_dioq_fetch</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_freeq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_pkt</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">COMP_FLAG_PIB_VALID</span> <span class="o">|</span> <span class="n">COMP_FLAG_FMT_CHANGE</span><span class="p">;</span>
			<span class="n">AppPib</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">;</span>
			<span class="n">cpy_pib_to_app</span><span class="p">(</span><span class="o">&amp;</span><span class="n">src_pib</span><span class="p">,</span> <span class="n">AppPib</span><span class="p">);</span>

			<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span>
			       <span class="s">&quot;App PIB:%x %x %x %x %x %x %x %x %x %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">picture_number</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">aspect_ratio</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">chroma_format</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">colour_primaries</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">frame_rate</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">n_drop</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">pulldown</span><span class="p">,</span>
			       <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">.</span><span class="n">ycom</span><span class="p">);</span>

			<span class="n">crystalhd_dioq_add</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_rdyq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_pkt</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pkt_tag</span><span class="p">);</span>

		<span class="p">}</span>

		<span class="n">crystalhd_rel_addr_to_pib_Q</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">pib_addr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_start_rx_dma_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span>        <span class="n">dma_cntrl</span><span class="p">;</span>

	<span class="n">dma_cntrl</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dma_cntrl</span> <span class="o">&amp;</span> <span class="n">DMA_START_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_cntrl</span> <span class="o">|=</span> <span class="n">DMA_START_BIT</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">,</span> <span class="n">dma_cntrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_cntrl</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dma_cntrl</span> <span class="o">&amp;</span> <span class="n">DMA_START_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_cntrl</span> <span class="o">|=</span> <span class="n">DMA_START_BIT</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">,</span> <span class="n">dma_cntrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_stop_rx_dma_engine</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dma_cntrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">l0y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l0uv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l1y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">l1uv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dma_cntrl</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dma_cntrl</span> <span class="o">&amp;</span> <span class="n">DMA_START_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_cntrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_START_BIT</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">,</span> <span class="n">dma_cntrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_cntrl</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dma_cntrl</span> <span class="o">&amp;</span> <span class="n">DMA_START_BIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dma_cntrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_START_BIT</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">,</span> <span class="n">dma_cntrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Poll for 3seconds (30 * 100ms) on both the lists..*/</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">l0y</span> <span class="o">||</span> <span class="n">l0uv</span> <span class="o">||</span> <span class="n">l1y</span> <span class="o">||</span> <span class="n">l1uv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l0y</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l0y</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_FIRST_DESC_L_ADDR_LIST0</span><span class="p">);</span>
			<span class="n">l0y</span> <span class="o">&amp;=</span> <span class="n">DMA_START_BIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l0y</span><span class="p">)</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_y_intr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l1y</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l1y</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_FIRST_DESC_L_ADDR_LIST1</span><span class="p">);</span>
			<span class="n">l1y</span> <span class="o">&amp;=</span> <span class="n">DMA_START_BIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l1y</span><span class="p">)</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_y_intr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l0uv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l0uv</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_FIRST_DESC_L_ADDR_LIST0</span><span class="p">);</span>
			<span class="n">l0uv</span> <span class="o">&amp;=</span> <span class="n">DMA_START_BIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l0uv</span><span class="p">)</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_uv_intr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">l1uv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">l1uv</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_FIRST_DESC_L_ADDR_LIST1</span><span class="p">);</span>
			<span class="n">l1uv</span> <span class="o">&amp;=</span> <span class="n">DMA_START_BIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">l1uv</span><span class="p">)</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_uv_intr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_SSTEP</span><span class="p">,</span> <span class="s">&quot;Capture Stop: %d List0:Sts:%x List1:Sts:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">count</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_prog_rxdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">rx_pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">y_low_addr_reg</span><span class="p">,</span> <span class="n">y_high_addr_reg</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">uv_low_addr_reg</span><span class="p">,</span> <span class="n">uv_high_addr_reg</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">addr_64</span> <span class="n">desc_addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">rx_pkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span> <span class="o">&gt;=</span> <span class="n">DMA_ENGINE_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;List Out Of bounds %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* FIXME: jarod: sts_free is an enum for 0, in crystalhd_hw.h... yuk... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts_free</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">y_low_addr_reg</span>   <span class="o">=</span> <span class="n">MISC1_Y_RX_FIRST_DESC_L_ADDR_LIST0</span><span class="p">;</span>
		<span class="n">y_high_addr_reg</span>  <span class="o">=</span> <span class="n">MISC1_Y_RX_FIRST_DESC_U_ADDR_LIST0</span><span class="p">;</span>
		<span class="n">uv_low_addr_reg</span>  <span class="o">=</span> <span class="n">MISC1_UV_RX_FIRST_DESC_L_ADDR_LIST0</span><span class="p">;</span>
		<span class="n">uv_high_addr_reg</span> <span class="o">=</span> <span class="n">MISC1_UV_RX_FIRST_DESC_U_ADDR_LIST0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">y_low_addr_reg</span>   <span class="o">=</span> <span class="n">MISC1_Y_RX_FIRST_DESC_L_ADDR_LIST1</span><span class="p">;</span>
		<span class="n">y_high_addr_reg</span>  <span class="o">=</span> <span class="n">MISC1_Y_RX_FIRST_DESC_U_ADDR_LIST1</span><span class="p">;</span>
		<span class="n">uv_low_addr_reg</span>  <span class="o">=</span> <span class="n">MISC1_UV_RX_FIRST_DESC_L_ADDR_LIST1</span><span class="p">;</span>
		<span class="n">uv_high_addr_reg</span> <span class="o">=</span> <span class="n">MISC1_UV_RX_FIRST_DESC_U_ADDR_LIST1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pkt_tag</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_tag_seed</span> <span class="o">+</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_waiting_y_intr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">uv_phy_addr</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_waiting_uv_intr</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DMA_ENGINE_CNT</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">crystalhd_dioq_add</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_actq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_pkt</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pkt_tag</span><span class="p">);</span>

	<span class="n">crystalhd_start_rx_dma_engine</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="cm">/* Program the Y descriptor */</span>
	<span class="n">desc_addr</span><span class="p">.</span><span class="n">full_addr</span> <span class="o">=</span> <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">y_high_addr_reg</span><span class="p">,</span> <span class="n">desc_addr</span><span class="p">.</span><span class="n">high_part</span><span class="p">);</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">y_low_addr_reg</span><span class="p">,</span> <span class="n">desc_addr</span><span class="p">.</span><span class="n">low_part</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">uv_phy_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Program the UV descriptor */</span>
		<span class="n">desc_addr</span><span class="p">.</span><span class="n">full_addr</span> <span class="o">=</span> <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">uv_phy_addr</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">uv_high_addr_reg</span><span class="p">,</span> <span class="n">desc_addr</span><span class="p">.</span><span class="n">high_part</span><span class="p">);</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">uv_low_addr_reg</span><span class="p">,</span> <span class="n">desc_addr</span><span class="p">.</span><span class="n">low_part</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_post_cap_buff</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">rx_pkt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_prog_rxdma</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rx_pkt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">==</span> <span class="n">BC_STS_BUSY</span><span class="p">)</span>
		<span class="n">crystalhd_dioq_add</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_freeq</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_pkt</span><span class="p">,</span>
				 <span class="nb">false</span><span class="p">,</span> <span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">pkt_tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_get_dnsz</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">list_index</span><span class="p">,</span>
			     <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">y_dw_dnsz</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">uv_dw_dnsz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">y_dn_sz_reg</span><span class="p">,</span> <span class="n">uv_dn_sz_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">y_dn_sz_reg</span>  <span class="o">=</span> <span class="n">MISC1_Y_RX_LIST0_CUR_BYTE_CNT</span><span class="p">;</span>
		<span class="n">uv_dn_sz_reg</span> <span class="o">=</span> <span class="n">MISC1_UV_RX_LIST0_CUR_BYTE_CNT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">y_dn_sz_reg</span>  <span class="o">=</span> <span class="n">MISC1_Y_RX_LIST1_CUR_BYTE_CNT</span><span class="p">;</span>
		<span class="n">uv_dn_sz_reg</span> <span class="o">=</span> <span class="n">MISC1_UV_RX_LIST1_CUR_BYTE_CNT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">y_dw_dnsz</span>  <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">y_dn_sz_reg</span><span class="p">);</span>
	<span class="o">*</span><span class="n">uv_dw_dnsz</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">uv_dn_sz_reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This function should be called only after making sure that the two DMA</span>
<span class="cm"> * lists are free. This function does not check if DMA&#39;s are active, before</span>
<span class="cm"> * turning off the DMA.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_hw_finalize_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">dma_cntrl</span><span class="p">,</span> <span class="n">aspm</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stop_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dma_cntrl</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_cntrl</span> <span class="o">&amp;</span> <span class="n">DMA_START_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_cntrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_START_BIT</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">,</span> <span class="n">dma_cntrl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dma_cntrl</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_cntrl</span> <span class="o">&amp;</span> <span class="n">DMA_START_BIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_cntrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DMA_START_BIT</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_SW_DESC_LIST_CTRL_STS</span><span class="p">,</span> <span class="n">dma_cntrl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aspm</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_DLL_DATA_LINK_CONTROL</span><span class="p">);</span>
	<span class="n">aspm</span> <span class="o">|=</span> <span class="n">ASPM_L1_ENABLE</span><span class="p">;</span>
	<span class="cm">/* NAREN BCMLOG(BCMLOG_INFO, &quot;aspm on\n&quot;); */</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_DLL_DATA_LINK_CONTROL</span><span class="p">,</span> <span class="n">aspm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_rx_pkt_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">list_index</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">comp_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">rx_pkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">y_dw_dnsz</span><span class="p">,</span> <span class="n">uv_dw_dnsz</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="n">list_index</span> <span class="o">&gt;=</span> <span class="n">DMA_ENGINE_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx_pkt</span> <span class="o">=</span> <span class="n">crystalhd_dioq_find_and_fetch</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_actq</span><span class="p">,</span>
					     <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_tag_seed</span> <span class="o">+</span> <span class="n">list_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_pkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Act-Q:PostIx:%x L0Sts:%x L1Sts:%x current L:%x tag:%x comp:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">list_index</span><span class="p">,</span>
			   <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_tag_seed</span> <span class="o">+</span> <span class="n">list_index</span><span class="p">,</span> <span class="n">comp_sts</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comp_sts</span> <span class="o">==</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crystalhd_get_dnsz</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">list_index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y_dw_dnsz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uv_dw_dnsz</span><span class="p">);</span>
		<span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">dio_req</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">y_done_sz</span> <span class="o">=</span> <span class="n">y_dw_dnsz</span><span class="p">;</span>
		<span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">COMP_FLAG_DATA_VALID</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">uv_phy_addr</span><span class="p">)</span>
			<span class="n">rx_pkt</span><span class="o">-&gt;</span><span class="n">dio_req</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_done_sz</span> <span class="o">=</span> <span class="n">uv_dw_dnsz</span><span class="p">;</span>
		<span class="n">crystalhd_dioq_add</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_rdyq</span><span class="p">,</span> <span class="n">rx_pkt</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_tag_seed</span> <span class="o">+</span> <span class="n">list_index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if we can post this DIO again. */</span>
	<span class="k">return</span> <span class="n">crystalhd_hw_post_cap_buff</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rx_pkt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_rx_list0_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">int_sts</span><span class="p">,</span>
				     <span class="kt">uint32_t</span> <span class="n">y_err_sts</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">uv_err_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">list_sts</span> <span class="n">tmp_lsts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_Y0_ERR_MSK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_UV0_ERR_MSK</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">tmp_lsts</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Y0 - DMA */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_Y0_ERR_MSK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_sts</span> <span class="o">&amp;</span> <span class="n">INTR_INTR_STATUS_L0_Y_RX_DMA_DONE_INTR_MASK</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_y_intr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_Y_RX_ERROR_STATUS_RX_L0_UNDERRUN_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_y_intr</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_Y_RX_ERROR_STATUS_RX_L0_UNDERRUN_ERROR_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_Y_RX_ERROR_STATUS_RX_L0_FIFO_FULL_ERRORS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_y_mask</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_y_error</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_Y_RX_ERROR_STATUS_RX_L0_FIFO_FULL_ERRORS_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_y_mask</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_y_error</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* UV0 - DMA */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_UV0_ERR_MSK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_sts</span> <span class="o">&amp;</span> <span class="n">INTR_INTR_STATUS_L0_UV_RX_DMA_DONE_INTR_MASK</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_uv_intr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_UV_RX_ERROR_STATUS_RX_L0_UNDERRUN_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_uv_intr</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_UV_RX_ERROR_STATUS_RX_L0_UNDERRUN_ERROR_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_UV_RX_ERROR_STATUS_RX_L0_FIFO_FULL_ERRORS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_uv_mask</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_uv_error</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_UV_RX_ERROR_STATUS_RX_L0_FIFO_FULL_ERRORS_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_uv_mask</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_uv_error</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_Y0_ERR_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_Y0_ERR_MSK</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_ERROR_STATUS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_UV0_ERR_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_UV0_ERR_MSK</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_ERROR_STATUS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">tmp_lsts</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">crystalhd_rx_list1_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">int_sts</span><span class="p">,</span>
				     <span class="kt">uint32_t</span> <span class="n">y_err_sts</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">uv_err_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">list_sts</span> <span class="n">tmp_lsts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_Y1_ERR_MSK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_UV1_ERR_MSK</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">tmp_lsts</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Y1 - DMA */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_Y1_ERR_MSK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_sts</span> <span class="o">&amp;</span> <span class="n">INTR_INTR_STATUS_L1_Y_RX_DMA_DONE_INTR_MASK</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_y_intr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_Y_RX_ERROR_STATUS_RX_L1_UNDERRUN_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_y_intr</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_Y_RX_ERROR_STATUS_RX_L1_UNDERRUN_ERROR_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_Y_RX_ERROR_STATUS_RX_L1_FIFO_FULL_ERRORS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add retry-support..*/</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_y_mask</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_y_error</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_Y_RX_ERROR_STATUS_RX_L1_FIFO_FULL_ERRORS_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_y_mask</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_y_error</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* UV1 - DMA */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_UV1_ERR_MSK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_sts</span> <span class="o">&amp;</span> <span class="n">INTR_INTR_STATUS_L1_UV_RX_DMA_DONE_INTR_MASK</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_uv_intr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_UV_RX_ERROR_STATUS_RX_L1_UNDERRUN_ERROR_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_waiting_uv_intr</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_UV_RX_ERROR_STATUS_RX_L1_UNDERRUN_ERROR_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">MISC1_UV_RX_ERROR_STATUS_RX_L1_FIFO_FULL_ERRORS_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Add retry-support*/</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_uv_mask</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_uv_error</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MISC1_UV_RX_ERROR_STATUS_RX_L1_FIFO_FULL_ERRORS_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">rx_uv_mask</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">rx_uv_error</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_post_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_Y1_ERR_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">y_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_Y1_ERR_MSK</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_ERROR_STATUS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_UV1_ERR_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">uv_err_sts</span> <span class="o">&amp;</span> <span class="n">GET_UV1_ERR_MSK</span><span class="p">;</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_ERROR_STATUS</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">tmp_lsts</span> <span class="o">!=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">crystalhd_rx_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">intr_sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">list_avail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">comp_sts</span> <span class="o">=</span> <span class="n">BC_STS_NO_DATA</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">y_err_sts</span><span class="p">,</span> <span class="n">uv_err_sts</span><span class="p">,</span> <span class="n">y_dn_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">uv_dn_sz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intr_sts</span> <span class="o">&amp;</span> <span class="n">GET_RX_INTR_MASK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">y_err_sts</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_Y_RX_ERROR_STATUS</span><span class="p">);</span>
	<span class="n">uv_err_sts</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC1_UV_RX_ERROR_STATUS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DMA_ENGINE_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Update States..*/</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">crystalhd_rx_list0_handler</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">intr_sts</span><span class="p">,</span> <span class="n">y_err_sts</span><span class="p">,</span> <span class="n">uv_err_sts</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">crystalhd_rx_list1_handler</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">intr_sts</span><span class="p">,</span> <span class="n">y_err_sts</span><span class="p">,</span> <span class="n">uv_err_sts</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">sts_free</span>:
				<span class="n">comp_sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
				<span class="n">list_avail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">rx_y_error</span>:
			<span class="k">case</span> <span class="n">rx_uv_error</span>:
			<span class="k">case</span> <span class="n">rx_sts_error</span>:
				<span class="cm">/* We got error on both or Y or uv. */</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">crystalhd_get_dnsz</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y_dn_sz</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uv_dn_sz</span><span class="p">);</span>
				<span class="cm">/* FIXME: jarod: this is where my mini pci-e card is tripping up */</span>
				<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;list_index:%x rx[%d] Y:%x &quot;</span>
				       <span class="s">&quot;UV:%x Int:%x YDnSz:%x UVDnSz:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">i</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">,</span> <span class="n">y_err_sts</span><span class="p">,</span>
				       <span class="n">uv_err_sts</span><span class="p">,</span> <span class="n">intr_sts</span><span class="p">,</span> <span class="n">y_dn_sz</span><span class="p">,</span> <span class="n">uv_dn_sz</span><span class="p">);</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sts_free</span><span class="p">;</span>
				<span class="n">comp_sts</span> <span class="o">=</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="cm">/* Wait for completion..*/</span>
				<span class="n">comp_sts</span> <span class="o">=</span> <span class="n">BC_STS_NO_DATA</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* handle completion...*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comp_sts</span> <span class="o">!=</span> <span class="n">BC_STS_NO_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crystalhd_rx_pkt_done</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">comp_sts</span><span class="p">);</span>
			<span class="n">comp_sts</span> <span class="o">=</span> <span class="n">BC_STS_NO_DATA</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_avail</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">stop_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sts_free</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sts_free</span><span class="p">))</span>
				<span class="n">crystalhd_hw_finalize_pause</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">crystalhd_hw_start_capture</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_fw_cmd_post_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">BC_FW_CMD</span> <span class="o">*</span><span class="n">fw_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dec_rsp_channel_start_video</span> <span class="o">*</span><span class="n">st_rsp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fw_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">eCMD_C011_DEC_CHAN_START_VIDEO</span>:
		<span class="n">st_rsp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dec_rsp_channel_start_video</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pib_del_Q_addr</span> <span class="o">=</span> <span class="n">st_rsp</span><span class="o">-&gt;</span><span class="n">picInfoDeliveryQ</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pib_rel_Q_addr</span> <span class="o">=</span> <span class="n">st_rsp</span><span class="o">-&gt;</span><span class="n">picInfoReleaseQ</span><span class="p">;</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;DelQAddr:%x RelQAddr:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pib_del_Q_addr</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">pib_rel_Q_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">eCMD_C011_INIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">crystalhd_load_firmware_config</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Params.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_FW_AUTH_FAILED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_put_ddr2sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">link_misc_perst_decoder_ctrl</span> <span class="n">rst_cntrl_reg</span><span class="p">;</span>

	<span class="cm">/* Pulse reset pin of 7412 (MISC_PERST_DECODER_CTRL) */</span>
	<span class="n">rst_cntrl_reg</span><span class="p">.</span><span class="n">whole_reg</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_DECODER_CTRL</span><span class="p">);</span>

	<span class="n">rst_cntrl_reg</span><span class="p">.</span><span class="n">bcm_7412_rst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_DECODER_CTRL</span><span class="p">,</span> <span class="n">rst_cntrl_reg</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">rst_cntrl_reg</span><span class="p">.</span><span class="n">bcm_7412_rst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">MISC_PERST_DECODER_CTRL</span><span class="p">,</span> <span class="n">rst_cntrl_reg</span><span class="p">.</span><span class="n">whole_reg</span><span class="p">);</span>

	<span class="cm">/* Close all banks, put DDR in idle */</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_PRECHARGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set bit 25 (drop CKE pin of DDR) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_PARAM</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x02000000</span><span class="p">;</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_PARAM</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Reset the audio block */</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">AUD_DSP_MISC_SOFT_RESET</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* Power down Raptor PLL */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllCCtl</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x00008000</span><span class="p">;</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllCCtl</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Power down all Audio PLL */</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">AIO_MISC_PLL_RESET</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="cm">/* Power down video clock (75MHz) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllECtl</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x00008000</span><span class="p">;</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllECtl</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Power down video clock (75MHz) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllDCtl</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x00008000</span><span class="p">;</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllDCtl</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Power down core clock (200MHz) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllACtl</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x00008000</span><span class="p">;</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllACtl</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/* Power down core clock (200MHz) */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllBCtl</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x00008000</span><span class="p">;</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllBCtl</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************************************</span>
<span class="cm">**</span>
<span class="cm">*************************************************/</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_download_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg_data</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="o">*</span><span class="n">temp_buff</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">fw_sig_len</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dram_offset</span> <span class="o">=</span> <span class="n">BC_FWIMG_ST_ADDR</span><span class="p">,</span> <span class="n">sig_reg</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adp</span> <span class="o">||</span> <span class="o">!</span><span class="n">buffer</span> <span class="o">||</span> <span class="o">!</span><span class="n">sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Params.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg_data</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">OTP_CMD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reg_data</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid hw config.. otp not programmed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">reg_data</span> <span class="o">|=</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_CMD</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">);</span>

	<span class="n">reg_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">reg_data</span> <span class="o">!=</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg_data</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_STATUS</span><span class="p">);</span>
		<span class="n">reg_data</span> <span class="o">&amp;=</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Firmware Download RDY Timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BC_STS_TIMEOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="cm">/*  Load the FW to the FW_ADDR field in the DCI_FIRMWARE_ADDR */</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_FIRMWARE_ADDR</span><span class="p">,</span> <span class="n">dram_offset</span><span class="p">);</span>
	<span class="n">temp_buff</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">sz</span> <span class="o">-</span> <span class="n">fw_sig_len</span><span class="p">);</span> <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_DRAM_BASE_ADDR</span><span class="p">,</span> <span class="p">(</span><span class="n">dram_offset</span> <span class="o">&gt;&gt;</span> <span class="mi">19</span><span class="p">));</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_FIRMWARE_DATA</span><span class="p">,</span> <span class="o">*</span><span class="n">temp_buff</span><span class="p">);</span>
		<span class="n">dram_offset</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">temp_buff</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">temp_buff</span><span class="o">++</span><span class="p">;</span>

	<span class="n">sig_reg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">DCI_SIGNATURE_DATA_7</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cnt</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint32_t</span> <span class="n">swapped_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp_buff</span><span class="p">;</span>
		<span class="n">swapped_data</span> <span class="o">=</span> <span class="n">bswap_32_1</span><span class="p">(</span><span class="n">swapped_data</span><span class="p">);</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">sig_reg</span><span class="p">,</span> <span class="n">swapped_data</span><span class="p">);</span>
		<span class="n">sig_reg</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">temp_buff</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">reg_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg_data</span> <span class="o">|=</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_CMD</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">reg_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg_data</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reg_data</span> <span class="o">&amp;</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span> <span class="o">==</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">reg_data</span> <span class="o">&amp;</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg_data</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_STATUS</span><span class="p">);</span>
			<span class="n">reg_data</span> <span class="o">&amp;=</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">--</span><span class="n">cnt</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">reg_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">reg_data</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_CMD</span><span class="p">);</span>
		<span class="n">reg_data</span> <span class="o">|=</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">DCI_CMD</span><span class="p">,</span> <span class="n">reg_data</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;F/w Signature mismatch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_FW_AUTH_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;Firmware Downloaded Successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_do_fw_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">BC_FW_CMD</span> <span class="o">*</span><span class="n">fw_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd_res_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">cmd_buff</span><span class="p">,</span> <span class="o">*</span><span class="n">res_buff</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">fw_cmd_event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span><span class="p">;</span>

	<span class="n">crystalhd_create_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_cmd_event</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">fw_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd_buff</span> <span class="o">=</span> <span class="n">fw_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
	<span class="n">res_buff</span> <span class="o">=</span> <span class="n">fw_cmd</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_buff</span> <span class="o">||</span> <span class="o">!</span><span class="n">res_buff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Parameters for F/W Command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pwr_lock</span><span class="o">++</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fwcmd_evt_sts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pfw_cmd_event</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fw_cmd_event</span><span class="p">;</span>

	<span class="cm">/*Write the command to the memory*/</span>
	<span class="n">crystalhd_mem_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">TS_Host2CpuSnd</span><span class="p">,</span> <span class="n">FW_CMD_BUFF_SZ</span><span class="p">,</span> <span class="n">cmd_buff</span><span class="p">);</span>

	<span class="cm">/*Memory Read for memory arbitrator flush*/</span>
	<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">TS_Host2CpuSnd</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cnt</span><span class="p">);</span>

	<span class="cm">/* Write the command address to mailbox */</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Hst2CpuMbx1</span><span class="p">,</span> <span class="n">TS_Host2CpuSnd</span><span class="p">);</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">crystalhd_wait_on_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_cmd_event</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">fwcmd_evt_sts</span><span class="p">,</span> <span class="mi">20000</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Firmware command T/O</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;FwCmd Wait Signal int.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_IO_USER_ABORT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;FwCmd IO Error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_IO_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;FwCmd Failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pwr_lock</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*Get the Response Address*/</span>
	<span class="n">cmd_res_addr</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">Cpu2HstMbx1</span><span class="p">);</span>

	<span class="cm">/*Read the Response*/</span>
	<span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">cmd_res_addr</span><span class="p">,</span> <span class="n">FW_CMD_BUFF_SZ</span><span class="p">,</span> <span class="n">res_buff</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pwr_lock</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_buff</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">C011_RET_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;res_buff[2] != C011_RET_SUCCESS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_FW_CMD_ERR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_fw_cmd_post_proc</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">fw_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;crystalhd_fw_cmd_post_proc Failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">bool</span> <span class="nf">crystalhd_hw_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">intr_sts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">deco_intr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adp</span> <span class="o">||</span> <span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_started</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">num_interrupts</span><span class="o">++</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pwr_lock</span><span class="o">++</span><span class="p">;</span>

	<span class="n">deco_intr</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">Stream2Host_Intr_Sts</span><span class="p">);</span>
	<span class="n">intr_sts</span>  <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_INTR_STATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intr_sts</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* let system know we processed interrupt..*/</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">dev_interrupts</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">deco_intr</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">deco_intr</span> <span class="o">!=</span> <span class="mh">0xdeaddead</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">deco_intr</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*Set the Event and the status flag*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pfw_cmd_event</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">fwcmd_evt_sts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">crystalhd_set_event</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pfw_cmd_event</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">deco_intr</span> <span class="o">&amp;</span> <span class="n">BC_BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
			<span class="n">crystalhd_hw_proc_pib</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">Stream2Host_Intr_Sts</span><span class="p">,</span> <span class="n">deco_intr</span><span class="p">);</span>
		<span class="cm">/* FIXME: jarod: No udelay? might this be the real reason mini pci-e cards were stalling out? */</span>
		<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">Stream2Host_Intr_Sts</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Rx interrupts */</span>
	<span class="n">crystalhd_rx_isr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">intr_sts</span><span class="p">);</span>

	<span class="cm">/* Tx interrupts*/</span>
	<span class="n">crystalhd_tx_isr</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">intr_sts</span><span class="p">);</span>

	<span class="cm">/* Clear interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr_sts</span><span class="p">)</span>
			<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_INTR_CLR_REG</span><span class="p">,</span> <span class="n">intr_sts</span><span class="p">);</span>

		<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">adp</span><span class="p">,</span> <span class="n">INTR_EOI_CTRL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pwr_lock</span><span class="o">--</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">adp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_started</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span><span class="p">));</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span> <span class="o">=</span> <span class="n">adp</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">);</span>
	<span class="cm">/* FIXME: jarod: what are these magic numbers?!? */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_ioq_tag_seed</span> <span class="o">=</span> <span class="mh">0x70023070</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_tag_seed</span> <span class="o">=</span> <span class="mh">0x70029070</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stop_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crystalhd_start_device</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_started</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* set initial core clock  */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">core_clock_mhz</span> <span class="o">=</span> <span class="n">CLOCK_PRESET</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">prev_n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pwr_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crystalhd_hw_set_core_clock</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_started</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Stop and DDR sleep will happen in here */</span>
	<span class="n">crystalhd_hw_suspend</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dev_started</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_setup_dma_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">mem_len</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phy_addr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">rpkt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_create_ioqs</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to create IOQs..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mem_len</span> <span class="o">=</span> <span class="n">BC_LINK_MAX_SGLS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_descriptor</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BC_TX_LIST_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem</span> <span class="o">=</span> <span class="n">bc_kern_dma_alloc</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Insufficient Memory For TX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">crystalhd_hw_free_dma_rings</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BC_STS_INSUFF_RES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* rx_pkt_pool -- static memory allocation  */</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">pdma_desc_start</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">phy_addr</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">sz</span> <span class="o">=</span> <span class="n">BC_LINK_MAX_SGLS</span> <span class="o">*</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_descriptor</span><span class="p">);</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list_tag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Add TX dma requests to Free Queue..*/</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_dioq_add</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_freeq</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">crystalhd_hw_free_dma_rings</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BC_RX_LIST_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpkt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rpkt</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpkt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Insufficient Memory For RX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">crystalhd_hw_free_dma_rings</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BC_STS_INSUFF_RES</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mem</span> <span class="o">=</span> <span class="n">bc_kern_dma_alloc</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">phy_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Insufficient Memory For RX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">crystalhd_hw_free_dma_rings</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rpkt</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BC_STS_INSUFF_RES</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">pdma_desc_start</span> <span class="o">=</span> <span class="n">mem</span><span class="p">;</span>
		<span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="n">phy_addr</span><span class="p">;</span>
		<span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">sz</span>  <span class="o">=</span> <span class="n">BC_LINK_MAX_SGLS</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_descriptor</span><span class="p">);</span>
		<span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">pkt_tag</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_pkt_tag_seed</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">crystalhd_hw_free_rx_pkt</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rpkt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_free_dma_rings</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">rpkt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Delete all IOQs.. */</span>
	<span class="n">crystalhd_hw_delete_ioqs</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BC_TX_LIST_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">pdma_desc_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bc_kern_dma_free</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">sz</span><span class="p">,</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">pdma_desc_start</span><span class="p">,</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">phy_addr</span><span class="p">);</span>

			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_pkt_pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">pdma_desc_start</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Releasing RX Pkt pool</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rpkt</span> <span class="o">=</span> <span class="n">crystalhd_hw_alloc_rx_pkt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpkt</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">bc_kern_dma_free</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">sz</span><span class="p">,</span>
				 <span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">pdma_desc_start</span><span class="p">,</span>
				 <span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">phy_addr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">rpkt</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">rpkt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_post_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">ioreq</span><span class="p">,</span>
			     <span class="n">hw_comp_callback</span> <span class="n">call_back</span><span class="p">,</span>
			     <span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">cb_event</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">list_id</span><span class="p">,</span>
			     <span class="kt">uint8_t</span> <span class="n">data_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tx_dma_pkt</span> <span class="o">*</span><span class="n">tx_dma_packet</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">first_desc_u_addr</span><span class="p">,</span> <span class="n">first_desc_l_addr</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">low_addr</span><span class="p">,</span> <span class="n">high_addr</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">addr_64</span> <span class="n">desc_addr</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span><span class="p">,</span> <span class="n">add_sts</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">dummy_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioreq</span> <span class="o">||</span> <span class="o">!</span><span class="n">call_back</span> <span class="o">||</span> <span class="o">!</span><span class="n">cb_event</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Since we hit code in busy condition very frequently,</span>
<span class="cm">	 * we will check the code in status first before</span>
<span class="cm">	 * checking the availability of free elem.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This will avoid the Q fetch/add in normal condition.</span>
<span class="cm">	 */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crystalhd_code_in_full</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">ioreq</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">xfr_len</span><span class="p">,</span>
				  <span class="nb">false</span><span class="p">,</span> <span class="n">data_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">cin_busy</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BC_STS_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get a list from TxFreeQ */</span>
	<span class="n">tx_dma_packet</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_dma_pkt</span> <span class="o">*</span><span class="p">)</span><span class="n">crystalhd_dioq_fetch</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_freeq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_dma_packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;No empty elements..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERR_USAGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_xlat_sgl_to_dma_desc</span><span class="p">(</span><span class="n">ioreq</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">tx_dma_packet</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dummy_index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">add_sts</span> <span class="o">=</span> <span class="n">crystalhd_dioq_add</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_freeq</span><span class="p">,</span> <span class="n">tx_dma_packet</span><span class="p">,</span>
					   <span class="nb">false</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">add_sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;double fault..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">pwr_lock</span><span class="o">++</span><span class="p">;</span>

	<span class="n">desc_addr</span><span class="p">.</span><span class="n">full_addr</span> <span class="o">=</span> <span class="n">tx_dma_packet</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">phy_addr</span><span class="p">;</span>
	<span class="n">low_addr</span> <span class="o">=</span> <span class="n">desc_addr</span><span class="p">.</span><span class="n">low_part</span><span class="p">;</span>
	<span class="n">high_addr</span> <span class="o">=</span> <span class="n">desc_addr</span><span class="p">.</span><span class="n">high_part</span><span class="p">;</span>

	<span class="n">tx_dma_packet</span><span class="o">-&gt;</span><span class="n">call_back</span> <span class="o">=</span> <span class="n">call_back</span><span class="p">;</span>
	<span class="n">tx_dma_packet</span><span class="o">-&gt;</span><span class="n">cb_event</span>  <span class="o">=</span> <span class="n">cb_event</span><span class="p">;</span>
	<span class="n">tx_dma_packet</span><span class="o">-&gt;</span><span class="n">dio_req</span>   <span class="o">=</span> <span class="n">ioreq</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_list_post_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first_desc_u_addr</span> <span class="o">=</span> <span class="n">MISC1_TX_FIRST_DESC_U_ADDR_LIST0</span><span class="p">;</span>
		<span class="n">first_desc_l_addr</span> <span class="o">=</span> <span class="n">MISC1_TX_FIRST_DESC_L_ADDR_LIST0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">first_desc_u_addr</span> <span class="o">=</span> <span class="n">MISC1_TX_FIRST_DESC_U_ADDR_LIST1</span><span class="p">;</span>
		<span class="n">first_desc_l_addr</span> <span class="o">=</span> <span class="n">MISC1_TX_FIRST_DESC_L_ADDR_LIST1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">list_id</span> <span class="o">=</span> <span class="n">tx_dma_packet</span><span class="o">-&gt;</span><span class="n">list_tag</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_ioq_tag_seed</span> <span class="o">+</span>
					     <span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_list_post_index</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_list_post_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_list_post_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">DMA_ENGINE_CNT</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>


	<span class="cm">/* Insert in Active Q..*/</span>
	<span class="n">crystalhd_dioq_add</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_actq</span><span class="p">,</span> <span class="n">tx_dma_packet</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span>
			 <span class="n">tx_dma_packet</span><span class="o">-&gt;</span><span class="n">list_tag</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Interrupt will come as soon as you write</span>
<span class="cm">	 * the valid bit. So be ready for that. All</span>
<span class="cm">	 * the initialization should happen before that.</span>
<span class="cm">	 */</span>
	<span class="n">crystalhd_start_tx_dma_engine</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">first_desc_u_addr</span><span class="p">,</span> <span class="n">desc_addr</span><span class="p">.</span><span class="n">high_part</span><span class="p">);</span>

	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">first_desc_l_addr</span><span class="p">,</span> <span class="n">desc_addr</span><span class="p">.</span><span class="n">low_part</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
					<span class="cm">/* Be sure we set the valid bit ^^^^ */</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This is a force cancel and we are racing with ISR.</span>
<span class="cm"> *</span>
<span class="cm"> * Will try to remove the req from ActQ before ISR gets it.</span>
<span class="cm"> * If ISR gets it first then the completion happens in the</span>
<span class="cm"> * normal path and we will return _STS_NO_DATA from here.</span>
<span class="cm"> *</span>
<span class="cm"> * FIX_ME: Not Tested the actual condition..</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_cancel_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">list_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">list_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crystalhd_stop_tx_dma_engine</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">crystalhd_hw_tx_req_complete</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">list_id</span><span class="p">,</span> <span class="n">BC_STS_IO_USER_ABORT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_add_cap_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">ioreq</span><span class="p">,</span> <span class="n">bool</span> <span class="n">en_post</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">rpkt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">tag</span><span class="p">,</span> <span class="n">uv_desc_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioreq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpkt</span> <span class="o">=</span> <span class="n">crystalhd_hw_alloc_rx_pkt</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Insufficient resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INSUFF_RES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">dio_req</span> <span class="o">=</span> <span class="n">ioreq</span><span class="p">;</span>
	<span class="n">tag</span> <span class="o">=</span> <span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">pkt_tag</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_xlat_sgl_to_dma_desc</span><span class="p">(</span><span class="n">ioreq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uv_desc_ix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>

	<span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">uv_phy_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Store the address of UV in the rx packet for post*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uv_desc_ix</span><span class="p">)</span>
		<span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">uv_phy_addr</span> <span class="o">=</span> <span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">desc_mem</span><span class="p">.</span><span class="n">phy_addr</span> <span class="o">+</span>
				    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dma_descriptor</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">uv_desc_ix</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">en_post</span><span class="p">)</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_post_cap_buff</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rpkt</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_dioq_add</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_freeq</span><span class="p">,</span> <span class="n">rpkt</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_get_cap_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">BC_PIC_INFO_BLOCK</span> <span class="o">*</span><span class="n">pib</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">**</span><span class="n">ioreq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">rpkt</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">BC_PROC_OUTPUT_TIMEOUT</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">sig_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span> <span class="o">||</span> <span class="o">!</span><span class="n">ioreq</span> <span class="o">||</span> <span class="o">!</span><span class="n">pib</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rpkt</span> <span class="o">=</span> <span class="n">crystalhd_dioq_fetch_wait</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_rdyq</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig_pending</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rpkt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sig_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;wait on frame time out %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sig_pending</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BC_STS_IO_USER_ABORT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">BC_STS_TIMEOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">dio_req</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">comp_flags</span> <span class="o">=</span> <span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">COMP_FLAG_PIB_VALID</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">pib</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pib</span><span class="p">));</span>

	<span class="o">*</span><span class="n">ioreq</span> <span class="o">=</span> <span class="n">rpkt</span><span class="o">-&gt;</span><span class="n">dio_req</span><span class="p">;</span>

	<span class="n">crystalhd_hw_free_rx_pkt</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rpkt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_start_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crystalhd_rx_dma_pkt</span> <span class="o">*</span><span class="n">rx_pkt</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This is start of capture.. Post to both the lists.. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">DMA_ENGINE_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx_pkt</span> <span class="o">=</span> <span class="n">crystalhd_dioq_fetch</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_freeq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_pkt</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">BC_STS_NO_DATA</span><span class="p">;</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_post_cap_buff</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">rx_pkt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BC_STS_SUCCESS</span> <span class="o">!=</span> <span class="n">sts</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_stop_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">temp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crystalhd_stop_rx_dma_engine</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">crystalhd_dioq_fetch</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_freeq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
			<span class="n">crystalhd_rx_pkt_rel_call_back</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">temp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_pause</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">pause_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stop_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">sts_free</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_list_sts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">sts_free</span><span class="p">))</span>
		<span class="n">crystalhd_hw_finalize_pause</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_unpause</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">aspm</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stop_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">aspm</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_DLL_DATA_LINK_CONTROL</span><span class="p">);</span>
	<span class="n">aspm</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ASPM_L1_ENABLE</span><span class="p">;</span>
<span class="cm">/* NAREN BCMLOG(BCMLOG_INFO, &quot;aspm off\n&quot;); */</span>
	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">PCIE_DLL_DATA_LINK_CONTROL</span><span class="p">,</span> <span class="n">aspm</span><span class="p">);</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_start_capture</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_put_ddr2sleep</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to Put DDR To Sleep!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crystalhd_stop_device</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Failed to Stop Device!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">crystalhd_hw_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crystalhd_hw_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if called w/NULL stats, its a req to zero out the stats */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stats</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">freeq_count</span> <span class="o">=</span> <span class="n">crystalhd_dioq_count</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_freeq</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rdyq_count</span>  <span class="o">=</span> <span class="n">crystalhd_dioq_count</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_rdyq</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_hw_set_core_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">reg</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">vco_mg</span><span class="p">,</span> <span class="n">refresh_reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arguments</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: jarod: wha? */</span>
	<span class="cm">/*n = (hw-&gt;core_clock_mhz * 3) / 20 + 1; */</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">core_clock_mhz</span><span class="o">/</span><span class="mi">5</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">prev_n</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_CLK_NOCHG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">pwr_lock</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BCMLOG(BCMLOG_INFO,&quot;pwr_lock is %u\n&quot;, hw-&gt;pwr_lock) */</span>
		<span class="k">return</span> <span class="n">BC_STS_CLK_NOCHG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">27</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">560</span><span class="p">)</span>
		<span class="n">vco_mg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">900</span><span class="p">)</span>
		<span class="n">vco_mg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1030</span><span class="p">)</span>
		<span class="n">vco_mg</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vco_mg</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllACtl</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xFFFFCFC0</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">vco_mg</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;clock is moving to %d with n %d with vco_mg %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">core_clock_mhz</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">vco_mg</span><span class="p">);</span>

	<span class="cm">/* Change the DRAM refresh rate to accommodate the new frequency */</span>
	<span class="cm">/* refresh reg = ((refresh_rate * clock_rate)/16) - 1; rounding up*/</span>
	<span class="n">refresh_reg</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span> <span class="o">*</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">core_clock_mhz</span> <span class="o">/</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">SDRAM_REF_PARAM</span><span class="p">,</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">refresh_reg</span><span class="p">));</span>

	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllACtl</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">DecHt_PllACtl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x00020000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">prev_n</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="cm">/* FIXME: jarod: outputting a random &quot;C&quot; is... confusing... */</span>
			<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;C&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;clk change failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BC_STS_CLK_NOCHG</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
