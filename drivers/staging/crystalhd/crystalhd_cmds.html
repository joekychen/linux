<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › crystalhd › crystalhd_cmds.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>crystalhd_cmds.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/***************************************************************************</span>
<span class="cm"> * Copyright (c) 2005-2009, Broadcom Corporation.</span>
<span class="cm"> *</span>
<span class="cm"> *  Name: crystalhd_cmds . c</span>
<span class="cm"> *</span>
<span class="cm"> *  Description:</span>
<span class="cm"> *		BCM70010 Linux driver user command interfaces.</span>
<span class="cm"> *</span>
<span class="cm"> *  HISTORY:</span>
<span class="cm"> *</span>
<span class="cm"> **********************************************************************</span>
<span class="cm"> * This file is part of the crystalhd device driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation, version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this driver.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> **********************************************************************/</span>

<span class="cp">#include &quot;crystalhd.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">crystalhd_user</span> <span class="o">*</span><span class="nf">bc_cproc_get_uid</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crystalhd_user</span> <span class="o">*</span><span class="n">user</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BC_LINK_MAX_OPENS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_use</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">user</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">user</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bc_cproc_get_user_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BC_LINK_MAX_OPENS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_use</span><span class="p">)</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bc_cproc_mark_pwr_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BC_LINK_MAX_OPENS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_use</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DTS_DIAG_MODE</span> <span class="o">||</span>
		    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DTS_PLAYBACK_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pwr_state_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_notify_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">u_id</span><span class="p">].</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">DTS_MODE_INV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Close the handle first..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERR_USAGE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">NotifyMode</span><span class="p">.</span><span class="n">Mode</span> <span class="o">==</span> <span class="n">DTS_MONITOR_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">u_id</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">NotifyMode</span><span class="p">.</span><span class="n">Mode</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BC_LINK_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Link invalid state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERR_USAGE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Check for duplicate playback sessions..*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BC_LINK_MAX_OPENS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DTS_DIAG_MODE</span> <span class="o">||</span>
		    <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DTS_PLAYBACK_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;multiple playback sessions are not &quot;</span>
				   <span class="s">&quot;supported..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">BC_STS_ERR_USAGE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cin_wait_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">u_id</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">NotifyMode</span><span class="p">.</span><span class="n">Mode</span><span class="p">;</span>
	<span class="cm">/* Setup mmap pool for uaddr sgl mapping..*/</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">crystalhd_create_dio_pool</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">BC_LINK_MAX_SGLS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>

	<span class="cm">/* Setup Hardware DMA rings */</span>
	<span class="k">return</span> <span class="n">crystalhd_hw_setup_dma_rings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_get_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">VerInfo</span><span class="p">.</span><span class="n">DriverMajor</span> <span class="o">=</span> <span class="n">crystalhd_kmod_major</span><span class="p">;</span>
	<span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">VerInfo</span><span class="p">.</span><span class="n">DriverMinor</span> <span class="o">=</span> <span class="n">crystalhd_kmod_minor</span><span class="p">;</span>
	<span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">VerInfo</span><span class="p">.</span><span class="n">DriverRevision</span>	<span class="o">=</span> <span class="n">crystalhd_kmod_rev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_get_hwtype</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crystalhd_pci_cfg_rd</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">hwType</span><span class="p">.</span><span class="n">PciVenId</span><span class="p">);</span>
	<span class="n">crystalhd_pci_cfg_rd</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">hwType</span><span class="p">.</span><span class="n">PciDevId</span><span class="p">);</span>
	<span class="n">crystalhd_pci_cfg_rd</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">hwType</span><span class="p">.</span><span class="n">HwRev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_reg_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regAcc</span><span class="p">.</span><span class="n">Value</span> <span class="o">=</span> <span class="n">bc_dec_reg_rd</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span>
					<span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regAcc</span><span class="p">.</span><span class="n">Offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_reg_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>

	<span class="n">bc_dec_reg_wr</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regAcc</span><span class="p">.</span><span class="n">Offset</span><span class="p">,</span>
		      <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regAcc</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_link_reg_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>

	<span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regAcc</span><span class="p">.</span><span class="n">Value</span> <span class="o">=</span> <span class="n">crystalhd_reg_rd</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span>
					<span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regAcc</span><span class="p">.</span><span class="n">Offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_link_reg_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>

	<span class="n">crystalhd_reg_wr</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regAcc</span><span class="p">.</span><span class="n">Offset</span><span class="p">,</span>
		       <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">regAcc</span><span class="p">.</span><span class="n">Value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_mem_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">devMem</span><span class="p">.</span><span class="n">NumDwords</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata_sz</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;insufficient buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_mem_rd</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">devMem</span><span class="p">.</span><span class="n">StartOff</span><span class="p">,</span>
			     <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">devMem</span><span class="p">.</span><span class="n">NumDwords</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_mem_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">devMem</span><span class="p">.</span><span class="n">NumDwords</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata_sz</span> <span class="o">/</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;insufficient buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_mem_wr</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">devMem</span><span class="p">.</span><span class="n">StartOff</span><span class="p">,</span>
			     <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">devMem</span><span class="p">.</span><span class="n">NumDwords</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_cfg_rd</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pciCfg</span><span class="p">.</span><span class="n">pci_cfg_space</span><span class="p">;</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pciCfg</span><span class="p">.</span><span class="n">Offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pciCfg</span><span class="p">.</span><span class="n">Size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">crystalhd_pci_cfg_rd</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* Truncate to dword alignment..*/</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pciCfg</span><span class="p">.</span><span class="n">Size</span> <span class="o">/</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_pci_cfg_rd</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;config read : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sts</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_cfg_wr</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">ix</span><span class="p">,</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pciCfg</span><span class="p">.</span><span class="n">pci_cfg_space</span><span class="p">;</span>
	<span class="n">off</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pciCfg</span><span class="p">.</span><span class="n">Offset</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pciCfg</span><span class="p">.</span><span class="n">Size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">crystalhd_pci_cfg_wr</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Truncate to dword alignment..*/</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">cnt</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">pciCfg</span><span class="p">.</span><span class="n">Size</span> <span class="o">/</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ix</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">ix</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_pci_cfg_wr</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">temp</span><span class="p">[</span><span class="n">ix</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;config write : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sts</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">off</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_download_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">BC_LINK_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Link invalid state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERR_USAGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_download_fw</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata</span><span class="p">,</span>
				  <span class="n">idata</span><span class="o">-&gt;</span><span class="n">add_cdata_sz</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Firmware Download Failure!! - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sts</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">BC_LINK_INIT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We use the FW_CMD interface to sync up playback state with application</span>
<span class="cm"> * and  firmware. This function will perform the required pre and post</span>
<span class="cm"> * processing of the Firmware commands.</span>
<span class="cm"> *</span>
<span class="cm"> * Pause -</span>
<span class="cm"> *	Disable capture after decoder pause.</span>
<span class="cm"> * Resume -</span>
<span class="cm"> *	First enable capture and issue decoder resume command.</span>
<span class="cm"> * Flush -</span>
<span class="cm"> *	Abort pending input transfers and issue decoder flush command.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_do_fw_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_INIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Link invalid state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERR_USAGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">fwCmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">;</span>

	<span class="cm">/* Pre-Process */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">eCMD_C011_DEC_CHAN_PAUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BC_LINK_PAUSED</span><span class="p">;</span>
			<span class="n">crystalhd_hw_unpause</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">eCMD_C011_DEC_CHAN_FLUSH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;Flush issued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cin_wait_exit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_do_fw_cmd</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">fwCmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;fw cmd %x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Post-Process */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">eCMD_C011_DEC_CHAN_PAUSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">BC_LINK_PAUSED</span><span class="p">;</span>
			<span class="n">crystalhd_hw_pause</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bc_proc_in_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">dio_hnd</span><span class="p">,</span>
				  <span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dio_hnd</span> <span class="o">||</span> <span class="o">!</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">==</span> <span class="n">BC_STS_IO_USER_ABORT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dio_hnd</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">comp_sts</span> <span class="o">=</span> <span class="n">sts</span><span class="p">;</span>
	<span class="n">dio_hnd</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">ev_sts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">crystalhd_set_event</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_codein_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_queue_head_t</span> <span class="n">sleep_ev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_SUSPEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_IO_USER_ABORT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cin_wait_exit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cin_wait_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">BC_STS_CMD_CANCELLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">crystalhd_create_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sleep_ev</span><span class="p">);</span>
	<span class="n">crystalhd_wait_on_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sleep_ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_IO_USER_ABORT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_hw_txdma</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">dio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">tx_listid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span> <span class="o">||</span> <span class="o">!</span><span class="n">dio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crystalhd_create_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_list_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* msleep_interruptible(2000); */</span>
	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_post_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="n">dio</span><span class="p">,</span> <span class="n">bc_proc_in_completion</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_listid</span><span class="p">,</span>
				 <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ProcInput</span><span class="p">.</span><span class="n">Encrypted</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">sts</span> <span class="o">==</span> <span class="n">BC_STS_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">bc_cproc_codein_sleep</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_post_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="n">dio</span><span class="p">,</span>
					 <span class="n">bc_proc_in_completion</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_listid</span><span class="p">,</span>
					 <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ProcInput</span><span class="p">.</span><span class="n">Encrypted</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;_hw_txdma returning sts:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sts</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cin_wait_exit</span><span class="p">)</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cin_wait_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_list_id</span> <span class="o">=</span> <span class="n">tx_listid</span><span class="p">;</span>

	<span class="cm">/* _post() succeeded.. wait for the completion. */</span>
	<span class="n">crystalhd_wait_on_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="p">(</span><span class="n">dio</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">ev_sts</span><span class="p">),</span> <span class="mi">3000</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_list_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">dio</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">comp_sts</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;_tx_post() T/O</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Tx Wait Signal int.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_IO_USER_ABORT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_IO_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We are cancelling the IO from the same context as the _post().</span>
<span class="cm">	 * so no need to wait on the event again.. the return itself</span>
<span class="cm">	 * ensures the release of our resources.</span>
<span class="cm">	 */</span>
	<span class="n">crystalhd_hw_cancel_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="n">tx_listid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Helper function to check on user buffers */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_check_inbuffs</span><span class="p">(</span><span class="n">bool</span> <span class="n">pin</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ubuff</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">ub_sz</span><span class="p">,</span>
					<span class="kt">uint32_t</span> <span class="n">uv_off</span><span class="p">,</span> <span class="n">bool</span> <span class="n">en_422</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ubuff</span> <span class="o">||</span> <span class="o">!</span><span class="n">ub_sz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;%s-&gt;Invalid Arg %p %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">((</span><span class="n">pin</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;TX&quot;</span> <span class="o">:</span> <span class="s">&quot;RX&quot;</span><span class="p">),</span> <span class="n">ubuff</span><span class="p">,</span> <span class="n">ub_sz</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for alignment */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="kt">uintptr_t</span><span class="p">)</span><span class="n">ubuff</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;%s--&gt;Un-aligned address not implemented yet.. %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">((</span><span class="n">pin</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;TX&quot;</span> <span class="o">:</span> <span class="s">&quot;RX&quot;</span><span class="p">),</span> <span class="n">ubuff</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_NOT_IMPL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">en_422</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">uv_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Need UV offset for 420 mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">en_422</span> <span class="o">&amp;&amp;</span> <span class="n">uv_off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;UV offset in 422 mode ??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_proc_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ubuff</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ub_sz</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">dio_hnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ubuff</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ProcInput</span><span class="p">.</span><span class="n">pDmaBuff</span><span class="p">;</span>
	<span class="n">ub_sz</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ProcInput</span><span class="p">.</span><span class="n">BuffSz</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">bc_cproc_check_inbuffs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ubuff</span><span class="p">,</span> <span class="n">ub_sz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_map_dio</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">ubuff</span><span class="p">,</span> <span class="n">ub_sz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dio_hnd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;dio map - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sts</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dio_hnd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">bc_cproc_hw_txdma</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">idata</span><span class="p">,</span> <span class="n">dio_hnd</span><span class="p">);</span>

	<span class="n">crystalhd_unmap_dio</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">dio_hnd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_add_cap_buff</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ubuff</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">ub_sz</span><span class="p">,</span> <span class="n">uv_off</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">en_422</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">dio_hnd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ubuff</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">RxBuffs</span><span class="p">.</span><span class="n">YuvBuff</span><span class="p">;</span>
	<span class="n">ub_sz</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">RxBuffs</span><span class="p">.</span><span class="n">YuvBuffSz</span><span class="p">;</span>
	<span class="n">uv_off</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">RxBuffs</span><span class="p">.</span><span class="n">UVbuffOffset</span><span class="p">;</span>
	<span class="n">en_422</span> <span class="o">=</span> <span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">RxBuffs</span><span class="p">.</span><span class="n">b422Mode</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">bc_cproc_check_inbuffs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ubuff</span><span class="p">,</span> <span class="n">ub_sz</span><span class="p">,</span> <span class="n">uv_off</span><span class="p">,</span> <span class="n">en_422</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_map_dio</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">ubuff</span><span class="p">,</span> <span class="n">ub_sz</span><span class="p">,</span> <span class="n">uv_off</span><span class="p">,</span>
			      <span class="n">en_422</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dio_hnd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;dio map - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sts</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dio_hnd</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_add_cap_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="n">dio_hnd</span><span class="p">,</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BC_LINK_READY</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_BUSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">crystalhd_unmap_dio</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">dio_hnd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_fmt_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">dio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_add_cap_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="n">dio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">BC_LINK_FMT_CHG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BC_LINK_READY</span><span class="p">)</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_start_capture</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_fetch_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">dio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BC_DEC_OUT_BUFF</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_CAP_EN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Capture not enabled..%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERR_USAGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">DecOutData</span><span class="p">;</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_get_cap_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">PibInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_SUSPEND</span><span class="p">)</span> <span class="o">?</span> <span class="n">BC_STS_IO_USER_ABORT</span> <span class="o">:</span> <span class="n">sts</span><span class="p">;</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">=</span> <span class="n">dio</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">comp_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">&amp;</span> <span class="n">COMP_FLAG_FMT_CHANGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">bc_cproc_fmt_change</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">dio</span><span class="p">);</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">OutPutBuffs</span><span class="p">.</span><span class="n">YuvBuff</span> <span class="o">=</span> <span class="n">dio</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">xfr_buff</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">OutPutBuffs</span><span class="p">.</span><span class="n">YuvBuffSz</span> <span class="o">=</span> <span class="n">dio</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">xfr_len</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">OutPutBuffs</span><span class="p">.</span><span class="n">UVbuffOffset</span> <span class="o">=</span> <span class="n">dio</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_offset</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">OutPutBuffs</span><span class="p">.</span><span class="n">b422Mode</span> <span class="o">=</span> <span class="n">dio</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">b422mode</span><span class="p">;</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">OutPutBuffs</span><span class="p">.</span><span class="n">YBuffDoneSz</span> <span class="o">=</span> <span class="n">dio</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">y_done_sz</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">OutPutBuffs</span><span class="p">.</span><span class="n">UVBuffDoneSz</span> <span class="o">=</span> <span class="n">dio</span><span class="o">-&gt;</span><span class="n">uinfo</span><span class="p">.</span><span class="n">uv_done_sz</span><span class="p">;</span>

	<span class="n">crystalhd_unmap_dio</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">dio</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_start_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">BC_LINK_CAP_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BC_LINK_READY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">crystalhd_hw_start_capture</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_flush_cap_buffs</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crystalhd_dio_req</span> <span class="o">*</span><span class="n">dio</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">BC_DEC_OUT_BUFF</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_CAP_EN</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">BC_STS_ERR_USAGE</span><span class="p">;</span>

	<span class="cm">/* We should ack flush even when we are in paused/suspend state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_READY</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">crystalhd_hw_stop_capture</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BC_LINK_CAP_EN</span><span class="o">|</span><span class="n">BC_LINK_FMT_CHG</span><span class="p">);</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">DecOutData</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">BC_RX_LIST_CNT</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_get_cap_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">PibInfo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">crystalhd_unmap_dio</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="n">dio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">crystalhd_hw_stop_capture</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BC_DTS_STATS</span> <span class="o">*</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">crystalhd_hw_stats</span>	<span class="n">hw_stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crystalhd_hw_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hw_stats</span><span class="p">);</span>

	<span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">drvStat</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">drvRLL</span> <span class="o">=</span> <span class="n">hw_stats</span><span class="p">.</span><span class="n">rdyq_count</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">drvFLL</span> <span class="o">=</span> <span class="n">hw_stats</span><span class="p">.</span><span class="n">freeq_count</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">DrvTotalFrmDropped</span> <span class="o">=</span> <span class="n">hw_stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">DrvTotalHWErrs</span> <span class="o">=</span> <span class="n">hw_stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">+</span> <span class="n">hw_stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">intCount</span> <span class="o">=</span> <span class="n">hw_stats</span><span class="p">.</span><span class="n">num_interrupts</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">DrvIgnIntrCnt</span> <span class="o">=</span> <span class="n">hw_stats</span><span class="p">.</span><span class="n">num_interrupts</span> <span class="o">-</span>
				<span class="n">hw_stats</span><span class="p">.</span><span class="n">dev_interrupts</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">TxFifoBsyCnt</span> <span class="o">=</span> <span class="n">hw_stats</span><span class="p">.</span><span class="n">cin_busy</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">pauseCount</span> <span class="o">=</span> <span class="n">hw_stats</span><span class="p">.</span><span class="n">pause_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pwr_state_change</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">pwr_state_change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_PAUSED</span><span class="p">)</span>
		<span class="n">stats</span><span class="o">-&gt;</span><span class="n">DrvPauseTime</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_reset_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crystalhd_hw_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">bc_cproc_chg_clk</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">BC_CLOCK</span> <span class="o">*</span><span class="n">clock</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">oldClk</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idata</span><span class="o">-&gt;</span><span class="n">udata</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">clockValue</span><span class="p">;</span>
	<span class="n">oldClk</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">.</span><span class="n">core_clock_mhz</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">.</span><span class="n">core_clock_mhz</span> <span class="o">=</span> <span class="n">clock</span><span class="o">-&gt;</span><span class="n">clk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_set_core_clock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">==</span> <span class="n">BC_STS_CLK_NOCHG</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">.</span><span class="n">core_clock_mhz</span> <span class="o">=</span> <span class="n">oldClk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clock</span><span class="o">-&gt;</span><span class="n">clk</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">.</span><span class="n">core_clock_mhz</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*=============== Cmd Proc Table.. ======================================*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">crystalhd_cmd_tbl</span>	<span class="n">g_crystalhd_cproc_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">BCM_IOC_GET_VERSION</span><span class="p">,</span>		<span class="n">bc_cproc_get_version</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_GET_HWTYPE</span><span class="p">,</span>		<span class="n">bc_cproc_get_hwtype</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_REG_RD</span><span class="p">,</span>		<span class="n">bc_cproc_reg_rd</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_REG_WR</span><span class="p">,</span>		<span class="n">bc_cproc_reg_wr</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_FPGA_RD</span><span class="p">,</span>		<span class="n">bc_cproc_link_reg_rd</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_FPGA_WR</span><span class="p">,</span>		<span class="n">bc_cproc_link_reg_wr</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_MEM_RD</span><span class="p">,</span>		<span class="n">bc_cproc_mem_rd</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_MEM_WR</span><span class="p">,</span>		<span class="n">bc_cproc_mem_wr</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_RD_PCI_CFG</span><span class="p">,</span>		<span class="n">bc_cproc_cfg_rd</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_WR_PCI_CFG</span><span class="p">,</span>		<span class="n">bc_cproc_cfg_wr</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_FW_DOWNLOAD</span><span class="p">,</span>		<span class="n">bc_cproc_download_fw</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_FW_CMD</span><span class="p">,</span>		<span class="n">bc_cproc_do_fw_cmd</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_PROC_INPUT</span><span class="p">,</span>		<span class="n">bc_cproc_proc_input</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_ADD_RXBUFFS</span><span class="p">,</span>		<span class="n">bc_cproc_add_cap_buff</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_FETCH_RXBUFF</span><span class="p">,</span>		<span class="n">bc_cproc_fetch_frame</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_START_RX_CAP</span><span class="p">,</span>		<span class="n">bc_cproc_start_capture</span><span class="p">,</span>	<span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_FLUSH_RX_CAP</span><span class="p">,</span>		<span class="n">bc_cproc_flush_cap_buffs</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_GET_DRV_STAT</span><span class="p">,</span>		<span class="n">bc_cproc_get_stats</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_RST_DRV_STAT</span><span class="p">,</span>		<span class="n">bc_cproc_reset_stats</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_NOTIFY_MODE</span><span class="p">,</span>		<span class="n">bc_cproc_notify_mode</span><span class="p">,</span>	<span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_CHG_CLK</span><span class="p">,</span>		<span class="n">bc_cproc_chg_clk</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span> <span class="n">BCM_IOC_END</span><span class="p">,</span>			<span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*=============== Cmd Proc Functions.. ===================================*/</span>

<span class="cm">/**</span>
<span class="cm"> * crystalhd_suspend - Power management suspend request.</span>
<span class="cm"> * @ctx: Command layer context.</span>
<span class="cm"> * @idata: Iodata - required for internal use.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	status</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Set the state to Suspend.</span>
<span class="cm"> * 2. Flush the Rx Buffers it will unmap all the buffers and</span>
<span class="cm"> *    stop the RxDMA engine.</span>
<span class="cm"> * 3. Cancel The TX Io and Stop Dma Engine.</span>
<span class="cm"> * 4. Put the DDR in to deep sleep.</span>
<span class="cm"> * 5. Stop the hardware putting it in to Reset State.</span>
<span class="cm"> *</span>
<span class="cm"> * Current gstreamer frame work does not provide any power management</span>
<span class="cm"> * related notification to user mode decoder plug-in. As a work-around</span>
<span class="cm"> * we pass on the power mangement notification to our plug-in by completing</span>
<span class="cm"> * all outstanding requests with BC_STS_IO_USER_ABORT return code.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">crystalhd_ioctl_data</span> <span class="o">*</span><span class="n">idata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">sts</span> <span class="o">=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">idata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid Parameters</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_SUSPEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">BC_LINK_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Nothing To Do Suspend Success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">BC_LINK_SUSPEND</span><span class="p">;</span>

	<span class="n">bc_cproc_mark_pwr_state</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_CAP_EN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">bc_cproc_flush_cap_buffs</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">idata</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_list_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_cancel_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_list_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sts</span> <span class="o">=</span> <span class="n">crystalhd_hw_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sts</span> <span class="o">!=</span> <span class="n">BC_STS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sts</span><span class="p">;</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;BCM70012 suspend success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * crystalhd_resume - Resume frame capture.</span>
<span class="cm"> * @ctx: Command layer contextx.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	status</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Resume frame capture.</span>
<span class="cm"> *</span>
<span class="cm"> * PM_Resume can&#39;t resume the playback state back to pre-suspend state</span>
<span class="cm"> * because we don&#39;t keep video clip related information within driver.</span>
<span class="cm"> * To get back to the pre-suspend state App will re-open the device and</span>
<span class="cm"> * start a new playback session from the pre-suspend clip position.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;crystalhd_resume Success %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">bc_cproc_mark_pwr_state</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * crystalhd_user_open - Create application handle.</span>
<span class="cm"> * @ctx: Command layer contextx.</span>
<span class="cm"> * @user_ctx: User ID context.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	status</span>
<span class="cm"> *</span>
<span class="cm"> * Creates an application specific UID and allocates</span>
<span class="cm"> * application specific resources. HW layer initialization</span>
<span class="cm"> * is done for the first open request.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_user_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">crystalhd_user</span> <span class="o">**</span><span class="n">user_ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">crystalhd_user</span> <span class="o">*</span><span class="n">uc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">user_ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid arg..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uc</span> <span class="o">=</span> <span class="n">bc_cproc_get_uid</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;No free user context...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;Opening new user[%x] handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uc</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">);</span>

	<span class="n">crystalhd_hw_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">);</span>

	<span class="n">uc</span><span class="o">-&gt;</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">user_ctx</span> <span class="o">=</span> <span class="n">uc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * crystalhd_user_close - Close application handle.</span>
<span class="cm"> * @ctx: Command layer contextx.</span>
<span class="cm"> * @uc: User ID context.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	status</span>
<span class="cm"> *</span>
<span class="cm"> * Closer application handle and release app specific</span>
<span class="cm"> * resources.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="nf">crystalhd_user_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">crystalhd_user</span> <span class="o">*</span><span class="n">uc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">uc</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">DTS_MODE_INV</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">cin_wait_exit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pwr_state_change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;Closing user[%x] handle</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">uc</span><span class="o">-&gt;</span><span class="n">uid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DTS_DIAG_MODE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DTS_PLAYBACK_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">crystalhd_hw_free_dma_rings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>
		<span class="n">crystalhd_destroy_dio_pool</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bc_cproc_get_user_count</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crystalhd_hw_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">BC_LINK_INVALID</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * crystalhd_setup_cmd_context - Setup Command layer resources.</span>
<span class="cm"> * @ctx: Command layer contextx.</span>
<span class="cm"> * @adp: Adapter context</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	status</span>
<span class="cm"> *</span>
<span class="cm"> * Called at the time of driver load.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">__devinit</span> <span class="nf">crystalhd_setup_cmd_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">crystalhd_adp</span> <span class="o">*</span><span class="n">adp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span> <span class="o">||</span> <span class="o">!</span><span class="n">adp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid arg!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">BC_STS_INV_ARG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">)</span>
		<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Resetting Cmd context delete missing..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span> <span class="o">=</span> <span class="n">adp</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BC_LINK_MAX_OPENS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">uid</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">in_use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mode</span> <span class="o">=</span> <span class="n">DTS_MODE_INV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*Open and Close the Hardware to put it in to sleep state*/</span>
	<span class="n">crystalhd_hw_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">);</span>
	<span class="n">crystalhd_hw_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * crystalhd_delete_cmd_context - Release Command layer resources.</span>
<span class="cm"> * @ctx: Command layer contextx.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	status</span>
<span class="cm"> *</span>
<span class="cm"> * Called at the time of driver un-load.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">BC_STATUS</span> <span class="n">__devexit</span> <span class="nf">crystalhd_delete_cmd_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_DBG</span><span class="p">,</span> <span class="s">&quot;Deleting Command context..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">BC_STS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * crystalhd_get_cmd_proc  - Cproc table lookup.</span>
<span class="cm"> * @ctx: Command layer contextx.</span>
<span class="cm"> * @cmd: IOCTL command code.</span>
<span class="cm"> * @uc: User ID context.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	command proc function pointer</span>
<span class="cm"> *</span>
<span class="cm"> * This function checks the process context, application&#39;s</span>
<span class="cm"> * mode of operation and returns the function pointer</span>
<span class="cm"> * from the cproc table.</span>
<span class="cm"> */</span>
<span class="n">crystalhd_cmd_proc</span> <span class="nf">crystalhd_get_cmd_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">cmd</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">crystalhd_user</span> <span class="o">*</span><span class="n">uc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">crystalhd_cmd_proc</span> <span class="n">cproc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">tbl_sz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid arg.. Cmd[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">BCM_IOC_GET_DRV_STAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">BC_LINK_SUSPEND</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid State [suspend Set].. Cmd[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tbl_sz</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">g_crystalhd_cproc_tbl</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd_tbl</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">tbl_sz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">g_crystalhd_cproc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd_id</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">uc</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">DTS_MONITOR_MODE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">g_crystalhd_cproc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">block_mon</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">BCMLOG</span><span class="p">(</span><span class="n">BCMLOG_INFO</span><span class="p">,</span> <span class="s">&quot;Blocking cmd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">cproc</span> <span class="o">=</span> <span class="n">g_crystalhd_cproc_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd_proc</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">cproc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * crystalhd_cmd_interrupt - ISR entry point</span>
<span class="cm"> * @ctx: Command layer contextx.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:</span>
<span class="cm"> *	TRUE: If interrupt from bcm70012 device.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * ISR entry point from OS layer.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">crystalhd_cmd_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">crystalhd_cmd</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BCMLOG_ERR</span><span class="p">(</span><span class="s">&quot;Invalid arg..</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">crystalhd_hw_interrupt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">adp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hw_ctx</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
