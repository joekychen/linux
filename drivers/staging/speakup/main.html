<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › speakup › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* speakup.c</span>
<span class="cm"> * review functions for the speakup screen review package.</span>
<span class="cm"> * originally written by: Kirk Reiser and Andy Berdan.</span>
<span class="cm"> *</span>
<span class="cm"> * extensively modified by David Borowski.</span>
<span class="cm"> *</span>
<span class="cm"> ** Copyright (C) 1998  Kirk Reiser.</span>
<span class="cm"> *  Copyright (C) 2003  David Borowski.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/vt.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;		</span><span class="cm">/* __get_free_page() and friends */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/vt_kern.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/selection.h&gt;</span>
<span class="cp">#include &lt;linux/unistd.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/keyboard.h&gt;	</span><span class="cm">/* for KT_SHIFT */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/kbd_kern.h&gt;	</span><span class="cm">/* for vc_kbd_* and friends */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/input.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>

<span class="cp">#include &lt;linux/bootmem.h&gt;	</span><span class="cm">/* for alloc_bootmem */</span><span class="cp"></span>

<span class="cm">/* speakup_*_selection */</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/consolemap.h&gt;</span>

<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>

<span class="cp">#include &lt;linux/uaccess.h&gt;	</span><span class="cm">/* copy_from|to|user() and others */</span><span class="cp"></span>

<span class="cp">#include &quot;spk_priv.h&quot;</span>
<span class="cp">#include &quot;speakup.h&quot;</span>

<span class="cp">#define MAX_DELAY msecs_to_jiffies(500)</span>
<span class="cp">#define MINECHOCHAR SPACE</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kirk Reiser &lt;kirk@braille.uwo.ca&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Daniel Drake &lt;dsd@gentoo.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Speakup console speech&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">SPEAKUP_VERSION</span><span class="p">);</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">synth_name</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">synth</span><span class="p">,</span> <span class="n">synth_name</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">quiet</span><span class="p">,</span> <span class="n">quiet_boot</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">synth</span><span class="p">,</span> <span class="s">&quot;Synth to start if speakup is built in.&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">quiet</span><span class="p">,</span> <span class="s">&quot;Do not announce when the synthesizer is found.&quot;</span><span class="p">);</span>

<span class="n">special_func</span> <span class="n">special_handler</span><span class="p">;</span>

<span class="kt">short</span> <span class="n">pitch_shift</span><span class="p">,</span> <span class="n">synth_flags</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="kt">int</span> <span class="n">attrib_bleep</span><span class="p">,</span> <span class="n">bleeps</span><span class="p">,</span> <span class="n">bleep_time</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">no_intr</span><span class="p">,</span> <span class="n">spell_delay</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">key_echo</span><span class="p">,</span> <span class="n">say_word_ctl</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">say_ctrl</span><span class="p">,</span> <span class="n">bell_pos</span><span class="p">;</span>
<span class="kt">short</span> <span class="n">punc_mask</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">punc_level</span><span class="p">,</span> <span class="n">reading_punc</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">str_caps_start</span><span class="p">[</span><span class="n">MAXVARLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">str_caps_stop</span><span class="p">[</span><span class="n">MAXVARLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">st_bits_data</span> <span class="n">punc_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;some&quot;</span><span class="p">,</span> <span class="s">&quot;/$%&amp;@&quot;</span><span class="p">,</span> <span class="n">SOME</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;most&quot;</span><span class="p">,</span> <span class="s">&quot;$%&amp;#()=+*/@^&lt;&gt;|</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">MOST</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;all&quot;</span><span class="p">,</span> <span class="s">&quot;!</span><span class="se">\&quot;</span><span class="s">#$%&amp;&#39;()*+,-./:;&lt;=&gt;?@[</span><span class="se">\\</span><span class="s">]^_`{|}~&quot;</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;delimiters&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">B_WDLM</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;repeats&quot;</span><span class="p">,</span> <span class="s">&quot;()&quot;</span><span class="p">,</span> <span class="n">CH_RPT</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;extended numeric&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">B_EXNUM</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;symbols&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">mark_cut_flag</span><span class="p">;</span>
<span class="cp">#define MAX_KEY 160</span>
<span class="n">u_char</span> <span class="o">*</span><span class="n">our_keys</span><span class="p">[</span><span class="n">MAX_KEY</span><span class="p">],</span> <span class="o">*</span><span class="n">shift_table</span><span class="p">;</span>
<span class="n">u_char</span> <span class="n">key_buf</span><span class="p">[</span><span class="mi">600</span><span class="p">];</span>
<span class="k">const</span> <span class="n">u_char</span> <span class="n">key_defaults</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#include &quot;speakupmap.h&quot;</span>
<span class="p">};</span>

<span class="cm">/* Speakup Cursor Track Variables */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cursor_track</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prev_cursor_track</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/* cursor track modes, must be ordered same as cursor_msgs */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">CT_Off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">CT_On</span><span class="p">,</span>
	<span class="n">CT_Highlight</span><span class="p">,</span>
	<span class="n">CT_Window</span><span class="p">,</span>
	<span class="n">CT_Max</span>
<span class="p">};</span>
<span class="cp">#define read_all_mode CT_Max</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">tty_struct</span> <span class="o">*</span><span class="n">tty</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">spkup_write</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phonetic</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;alfa&quot;</span><span class="p">,</span> <span class="s">&quot;bravo&quot;</span><span class="p">,</span> <span class="s">&quot;charlie&quot;</span><span class="p">,</span> <span class="s">&quot;delta&quot;</span><span class="p">,</span> <span class="s">&quot;echo&quot;</span><span class="p">,</span> <span class="s">&quot;foxtrot&quot;</span><span class="p">,</span> <span class="s">&quot;golf&quot;</span><span class="p">,</span> <span class="s">&quot;hotel&quot;</span><span class="p">,</span>
	<span class="s">&quot;india&quot;</span><span class="p">,</span> <span class="s">&quot;juliett&quot;</span><span class="p">,</span> <span class="s">&quot;keelo&quot;</span><span class="p">,</span> <span class="s">&quot;leema&quot;</span><span class="p">,</span> <span class="s">&quot;mike&quot;</span><span class="p">,</span> <span class="s">&quot;november&quot;</span><span class="p">,</span> <span class="s">&quot;oscar&quot;</span><span class="p">,</span>
	    <span class="s">&quot;papa&quot;</span><span class="p">,</span>
	<span class="s">&quot;keh beck&quot;</span><span class="p">,</span> <span class="s">&quot;romeo&quot;</span><span class="p">,</span> <span class="s">&quot;sierra&quot;</span><span class="p">,</span> <span class="s">&quot;tango&quot;</span><span class="p">,</span> <span class="s">&quot;uniform&quot;</span><span class="p">,</span> <span class="s">&quot;victer&quot;</span><span class="p">,</span> <span class="s">&quot;whiskey&quot;</span><span class="p">,</span>
	<span class="s">&quot;x ray&quot;</span><span class="p">,</span> <span class="s">&quot;yankee&quot;</span><span class="p">,</span> <span class="s">&quot;zulu&quot;</span>
<span class="p">};</span>

<span class="cm">/* array of 256 char pointers (one for each character description)</span>
<span class="cm"> * initialized to default_chars and user selectable via</span>
<span class="cm"> * /proc/speakup/characters */</span>
<span class="kt">char</span> <span class="o">*</span><span class="n">characters</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="kt">char</span> <span class="o">*</span><span class="n">default_chars</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*000*/</span> <span class="s">&quot;null&quot;</span><span class="p">,</span> <span class="s">&quot;^a&quot;</span><span class="p">,</span> <span class="s">&quot;^b&quot;</span><span class="p">,</span> <span class="s">&quot;^c&quot;</span><span class="p">,</span> <span class="s">&quot;^d&quot;</span><span class="p">,</span> <span class="s">&quot;^e&quot;</span><span class="p">,</span> <span class="s">&quot;^f&quot;</span><span class="p">,</span> <span class="s">&quot;^g&quot;</span><span class="p">,</span>
<span class="cm">/*008*/</span> <span class="s">&quot;^h&quot;</span><span class="p">,</span> <span class="s">&quot;^i&quot;</span><span class="p">,</span> <span class="s">&quot;^j&quot;</span><span class="p">,</span> <span class="s">&quot;^k&quot;</span><span class="p">,</span> <span class="s">&quot;^l&quot;</span><span class="p">,</span> <span class="s">&quot;^m&quot;</span><span class="p">,</span> <span class="s">&quot;^n&quot;</span><span class="p">,</span> <span class="s">&quot;^o&quot;</span><span class="p">,</span>
<span class="cm">/*016*/</span> <span class="s">&quot;^p&quot;</span><span class="p">,</span> <span class="s">&quot;^q&quot;</span><span class="p">,</span> <span class="s">&quot;^r&quot;</span><span class="p">,</span> <span class="s">&quot;^s&quot;</span><span class="p">,</span> <span class="s">&quot;^t&quot;</span><span class="p">,</span> <span class="s">&quot;^u&quot;</span><span class="p">,</span> <span class="s">&quot;^v&quot;</span><span class="p">,</span> <span class="s">&quot;^w&quot;</span><span class="p">,</span>
<span class="cm">/*024*/</span> <span class="s">&quot;^x&quot;</span><span class="p">,</span> <span class="s">&quot;^y&quot;</span><span class="p">,</span> <span class="s">&quot;^z&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span>
	    <span class="s">&quot;control&quot;</span><span class="p">,</span>
<span class="cm">/*032*/</span> <span class="s">&quot;space&quot;</span><span class="p">,</span> <span class="s">&quot;bang!&quot;</span><span class="p">,</span> <span class="s">&quot;quote&quot;</span><span class="p">,</span> <span class="s">&quot;number&quot;</span><span class="p">,</span> <span class="s">&quot;dollar&quot;</span><span class="p">,</span> <span class="s">&quot;percent&quot;</span><span class="p">,</span> <span class="s">&quot;and&quot;</span><span class="p">,</span>
	    <span class="s">&quot;tick&quot;</span><span class="p">,</span>
<span class="cm">/*040*/</span> <span class="s">&quot;left paren&quot;</span><span class="p">,</span> <span class="s">&quot;right paren&quot;</span><span class="p">,</span> <span class="s">&quot;star&quot;</span><span class="p">,</span> <span class="s">&quot;plus&quot;</span><span class="p">,</span> <span class="s">&quot;comma&quot;</span><span class="p">,</span> <span class="s">&quot;dash&quot;</span><span class="p">,</span>
	    <span class="s">&quot;dot&quot;</span><span class="p">,</span>
	<span class="s">&quot;slash&quot;</span><span class="p">,</span>
<span class="cm">/*048*/</span> <span class="s">&quot;zero&quot;</span><span class="p">,</span> <span class="s">&quot;one&quot;</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">,</span> <span class="s">&quot;four&quot;</span><span class="p">,</span> <span class="s">&quot;five&quot;</span><span class="p">,</span> <span class="s">&quot;six&quot;</span><span class="p">,</span> <span class="s">&quot;seven&quot;</span><span class="p">,</span>
	<span class="s">&quot;eight&quot;</span><span class="p">,</span> <span class="s">&quot;nine&quot;</span><span class="p">,</span>
<span class="cm">/*058*/</span> <span class="s">&quot;colon&quot;</span><span class="p">,</span> <span class="s">&quot;semmy&quot;</span><span class="p">,</span> <span class="s">&quot;less&quot;</span><span class="p">,</span> <span class="s">&quot;equals&quot;</span><span class="p">,</span> <span class="s">&quot;greater&quot;</span><span class="p">,</span> <span class="s">&quot;question&quot;</span><span class="p">,</span> <span class="s">&quot;at&quot;</span><span class="p">,</span>
<span class="cm">/*065*/</span> <span class="s">&quot;EIGH&quot;</span><span class="p">,</span> <span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="s">&quot;C&quot;</span><span class="p">,</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;E&quot;</span><span class="p">,</span> <span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;G&quot;</span><span class="p">,</span>
<span class="cm">/*072*/</span> <span class="s">&quot;H&quot;</span><span class="p">,</span> <span class="s">&quot;I&quot;</span><span class="p">,</span> <span class="s">&quot;J&quot;</span><span class="p">,</span> <span class="s">&quot;K&quot;</span><span class="p">,</span> <span class="s">&quot;L&quot;</span><span class="p">,</span> <span class="s">&quot;M&quot;</span><span class="p">,</span> <span class="s">&quot;N&quot;</span><span class="p">,</span> <span class="s">&quot;O&quot;</span><span class="p">,</span>
<span class="cm">/*080*/</span> <span class="s">&quot;P&quot;</span><span class="p">,</span> <span class="s">&quot;Q&quot;</span><span class="p">,</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="s">&quot;S&quot;</span><span class="p">,</span> <span class="s">&quot;T&quot;</span><span class="p">,</span> <span class="s">&quot;U&quot;</span><span class="p">,</span> <span class="s">&quot;V&quot;</span><span class="p">,</span> <span class="s">&quot;W&quot;</span><span class="p">,</span> <span class="s">&quot;X&quot;</span><span class="p">,</span>
<span class="cm">/*089*/</span> <span class="s">&quot;Y&quot;</span><span class="p">,</span> <span class="s">&quot;ZED&quot;</span><span class="p">,</span> <span class="s">&quot;left bracket&quot;</span><span class="p">,</span> <span class="s">&quot;backslash&quot;</span><span class="p">,</span> <span class="s">&quot;right bracket&quot;</span><span class="p">,</span>
	    <span class="s">&quot;caret&quot;</span><span class="p">,</span>
	<span class="s">&quot;line&quot;</span><span class="p">,</span>
<span class="cm">/*096*/</span> <span class="s">&quot;accent&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">,</span> <span class="s">&quot;b&quot;</span><span class="p">,</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;d&quot;</span><span class="p">,</span> <span class="s">&quot;e&quot;</span><span class="p">,</span> <span class="s">&quot;f&quot;</span><span class="p">,</span> <span class="s">&quot;g&quot;</span><span class="p">,</span>
<span class="cm">/*104*/</span> <span class="s">&quot;h&quot;</span><span class="p">,</span> <span class="s">&quot;i&quot;</span><span class="p">,</span> <span class="s">&quot;j&quot;</span><span class="p">,</span> <span class="s">&quot;k&quot;</span><span class="p">,</span> <span class="s">&quot;l&quot;</span><span class="p">,</span> <span class="s">&quot;m&quot;</span><span class="p">,</span> <span class="s">&quot;n&quot;</span><span class="p">,</span> <span class="s">&quot;o&quot;</span><span class="p">,</span>
<span class="cm">/*112*/</span> <span class="s">&quot;p&quot;</span><span class="p">,</span> <span class="s">&quot;q&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;t&quot;</span><span class="p">,</span> <span class="s">&quot;u&quot;</span><span class="p">,</span> <span class="s">&quot;v&quot;</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span>
<span class="cm">/*120*/</span> <span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="s">&quot;y&quot;</span><span class="p">,</span> <span class="s">&quot;zed&quot;</span><span class="p">,</span> <span class="s">&quot;left brace&quot;</span><span class="p">,</span> <span class="s">&quot;bar&quot;</span><span class="p">,</span> <span class="s">&quot;right brace&quot;</span><span class="p">,</span> <span class="s">&quot;tihlduh&quot;</span><span class="p">,</span>
<span class="cm">/*127*/</span> <span class="s">&quot;del&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span>
	    <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span>
<span class="cm">/*138*/</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span>
	    <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span>
	    <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span>
<span class="cm">/*150*/</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span>
	    <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span> <span class="s">&quot;control&quot;</span><span class="p">,</span>
<span class="cm">/*160*/</span> <span class="s">&quot;nbsp&quot;</span><span class="p">,</span> <span class="s">&quot;inverted bang&quot;</span><span class="p">,</span>
<span class="cm">/*162*/</span> <span class="s">&quot;cents&quot;</span><span class="p">,</span> <span class="s">&quot;pounds&quot;</span><span class="p">,</span> <span class="s">&quot;currency&quot;</span><span class="p">,</span> <span class="s">&quot;yen&quot;</span><span class="p">,</span> <span class="s">&quot;broken bar&quot;</span><span class="p">,</span> <span class="s">&quot;section&quot;</span><span class="p">,</span>
<span class="cm">/*168*/</span> <span class="s">&quot;diaeresis&quot;</span><span class="p">,</span> <span class="s">&quot;copyright&quot;</span><span class="p">,</span> <span class="s">&quot;female ordinal&quot;</span><span class="p">,</span> <span class="s">&quot;double left angle&quot;</span><span class="p">,</span>
<span class="cm">/*172*/</span> <span class="s">&quot;not&quot;</span><span class="p">,</span> <span class="s">&quot;soft hyphen&quot;</span><span class="p">,</span> <span class="s">&quot;registered&quot;</span><span class="p">,</span> <span class="s">&quot;macron&quot;</span><span class="p">,</span>
<span class="cm">/*176*/</span> <span class="s">&quot;degrees&quot;</span><span class="p">,</span> <span class="s">&quot;plus or minus&quot;</span><span class="p">,</span> <span class="s">&quot;super two&quot;</span><span class="p">,</span> <span class="s">&quot;super three&quot;</span><span class="p">,</span>
<span class="cm">/*180*/</span> <span class="s">&quot;acute accent&quot;</span><span class="p">,</span> <span class="s">&quot;micro&quot;</span><span class="p">,</span> <span class="s">&quot;pilcrow&quot;</span><span class="p">,</span> <span class="s">&quot;middle dot&quot;</span><span class="p">,</span>
<span class="cm">/*184*/</span> <span class="s">&quot;cedilla&quot;</span><span class="p">,</span> <span class="s">&quot;super one&quot;</span><span class="p">,</span> <span class="s">&quot;male ordinal&quot;</span><span class="p">,</span> <span class="s">&quot;double right angle&quot;</span><span class="p">,</span>
<span class="cm">/*188*/</span> <span class="s">&quot;one quarter&quot;</span><span class="p">,</span> <span class="s">&quot;one half&quot;</span><span class="p">,</span> <span class="s">&quot;three quarters&quot;</span><span class="p">,</span>
	    <span class="s">&quot;inverted question&quot;</span><span class="p">,</span>
<span class="cm">/*192*/</span> <span class="s">&quot;A GRAVE&quot;</span><span class="p">,</span> <span class="s">&quot;A ACUTE&quot;</span><span class="p">,</span> <span class="s">&quot;A CIRCUMFLEX&quot;</span><span class="p">,</span> <span class="s">&quot;A TILDE&quot;</span><span class="p">,</span> <span class="s">&quot;A OOMLAUT&quot;</span><span class="p">,</span>
	    <span class="s">&quot;A RING&quot;</span><span class="p">,</span>
<span class="cm">/*198*/</span> <span class="s">&quot;AE&quot;</span><span class="p">,</span> <span class="s">&quot;C CIDELLA&quot;</span><span class="p">,</span> <span class="s">&quot;E GRAVE&quot;</span><span class="p">,</span> <span class="s">&quot;E ACUTE&quot;</span><span class="p">,</span> <span class="s">&quot;E CIRCUMFLEX&quot;</span><span class="p">,</span>
	    <span class="s">&quot;E OOMLAUT&quot;</span><span class="p">,</span>
<span class="cm">/*204*/</span> <span class="s">&quot;I GRAVE&quot;</span><span class="p">,</span> <span class="s">&quot;I ACUTE&quot;</span><span class="p">,</span> <span class="s">&quot;I CIRCUMFLEX&quot;</span><span class="p">,</span> <span class="s">&quot;I OOMLAUT&quot;</span><span class="p">,</span> <span class="s">&quot;ETH&quot;</span><span class="p">,</span>
	    <span class="s">&quot;N TILDE&quot;</span><span class="p">,</span>
<span class="cm">/*210*/</span> <span class="s">&quot;O GRAVE&quot;</span><span class="p">,</span> <span class="s">&quot;O ACUTE&quot;</span><span class="p">,</span> <span class="s">&quot;O CIRCUMFLEX&quot;</span><span class="p">,</span> <span class="s">&quot;O TILDE&quot;</span><span class="p">,</span> <span class="s">&quot;O OOMLAUT&quot;</span><span class="p">,</span>
<span class="cm">/*215*/</span> <span class="s">&quot;multiplied by&quot;</span><span class="p">,</span> <span class="s">&quot;O STROKE&quot;</span><span class="p">,</span> <span class="s">&quot;U GRAVE&quot;</span><span class="p">,</span> <span class="s">&quot;U ACUTE&quot;</span><span class="p">,</span>
	    <span class="s">&quot;U CIRCUMFLEX&quot;</span><span class="p">,</span>
<span class="cm">/*220*/</span> <span class="s">&quot;U OOMLAUT&quot;</span><span class="p">,</span> <span class="s">&quot;Y ACUTE&quot;</span><span class="p">,</span> <span class="s">&quot;THORN&quot;</span><span class="p">,</span> <span class="s">&quot;sharp s&quot;</span><span class="p">,</span> <span class="s">&quot;a grave&quot;</span><span class="p">,</span>
<span class="cm">/*225*/</span> <span class="s">&quot;a acute&quot;</span><span class="p">,</span> <span class="s">&quot;a circumflex&quot;</span><span class="p">,</span> <span class="s">&quot;a tilde&quot;</span><span class="p">,</span> <span class="s">&quot;a oomlaut&quot;</span><span class="p">,</span> <span class="s">&quot;a ring&quot;</span><span class="p">,</span>
<span class="cm">/*230*/</span> <span class="s">&quot;ae&quot;</span><span class="p">,</span> <span class="s">&quot;c cidella&quot;</span><span class="p">,</span> <span class="s">&quot;e grave&quot;</span><span class="p">,</span> <span class="s">&quot;e acute&quot;</span><span class="p">,</span>
<span class="cm">/*234*/</span> <span class="s">&quot;e circumflex&quot;</span><span class="p">,</span> <span class="s">&quot;e oomlaut&quot;</span><span class="p">,</span> <span class="s">&quot;i grave&quot;</span><span class="p">,</span> <span class="s">&quot;i acute&quot;</span><span class="p">,</span>
	    <span class="s">&quot;i circumflex&quot;</span><span class="p">,</span>
<span class="cm">/*239*/</span> <span class="s">&quot;i oomlaut&quot;</span><span class="p">,</span> <span class="s">&quot;eth&quot;</span><span class="p">,</span> <span class="s">&quot;n tilde&quot;</span><span class="p">,</span> <span class="s">&quot;o grave&quot;</span><span class="p">,</span> <span class="s">&quot;o acute&quot;</span><span class="p">,</span>
	    <span class="s">&quot;o circumflex&quot;</span><span class="p">,</span>
<span class="cm">/*245*/</span> <span class="s">&quot;o tilde&quot;</span><span class="p">,</span> <span class="s">&quot;o oomlaut&quot;</span><span class="p">,</span> <span class="s">&quot;divided by&quot;</span><span class="p">,</span> <span class="s">&quot;o stroke&quot;</span><span class="p">,</span> <span class="s">&quot;u grave&quot;</span><span class="p">,</span>
	    <span class="s">&quot;u acute&quot;</span><span class="p">,</span>
<span class="cm">/* 251 */</span> <span class="s">&quot;u circumflex&quot;</span><span class="p">,</span> <span class="s">&quot;u oomlaut&quot;</span><span class="p">,</span> <span class="s">&quot;y acute&quot;</span><span class="p">,</span> <span class="s">&quot;thorn&quot;</span><span class="p">,</span> <span class="s">&quot;y oomlaut&quot;</span>
<span class="p">};</span>

<span class="cm">/* array of 256 u_short (one for each character)</span>
<span class="cm"> * initialized to default_chartab and user selectable via</span>
<span class="cm"> * /sys/module/speakup/parameters/chartab */</span>
<span class="n">u_short</span> <span class="n">spk_chartab</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="n">default_chartab</span><span class="p">[</span><span class="mi">256</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span>	<span class="cm">/* 0-7 */</span>
	<span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">A_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span>	<span class="cm">/* 8-15 */</span>
	<span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span>	<span class="cm">/*16-23 */</span>
	<span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span> <span class="n">B_CTL</span><span class="p">,</span>	<span class="cm">/* 24-31 */</span>
	<span class="n">WDLM</span><span class="p">,</span> <span class="n">A_PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">A_PUNC</span><span class="p">,</span>	<span class="cm">/*  !&quot;#$%&amp;&#39; */</span>
	<span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">A_PUNC</span><span class="p">,</span> <span class="n">A_PUNC</span><span class="p">,</span> <span class="n">A_PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span>	<span class="cm">/* ()*+, -./ */</span>
	<span class="n">NUM</span><span class="p">,</span> <span class="n">NUM</span><span class="p">,</span> <span class="n">NUM</span><span class="p">,</span> <span class="n">NUM</span><span class="p">,</span> <span class="n">NUM</span><span class="p">,</span> <span class="n">NUM</span><span class="p">,</span> <span class="n">NUM</span><span class="p">,</span> <span class="n">NUM</span><span class="p">,</span>	<span class="cm">/* 01234567 */</span>
	<span class="n">NUM</span><span class="p">,</span> <span class="n">NUM</span><span class="p">,</span> <span class="n">A_PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">A_PUNC</span><span class="p">,</span>	<span class="cm">/* 89:;&lt;=&gt;? */</span>
	<span class="n">PUNC</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span>	<span class="cm">/* @ABCDEFG */</span>
	<span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span>	<span class="cm">/* HIJKLMNO */</span>
	<span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span>	<span class="cm">/* PQRSTUVW */</span>
	<span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span>	<span class="cm">/* XYZ[\]^_ */</span>
	<span class="n">PUNC</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span>	<span class="cm">/* `abcdefg */</span>
	<span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span>	<span class="cm">/* hijklmno */</span>
	<span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span>	<span class="cm">/* pqrstuvw */</span>
	<span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="n">PUNC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* xyz{|}~ */</span>
	<span class="n">B_CAPSYM</span><span class="p">,</span> <span class="n">B_CAPSYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="cm">/* 128-134 */</span>
	<span class="n">B_SYM</span><span class="p">,</span>	<span class="cm">/* 135 */</span>
	<span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="cm">/* 136-142 */</span>
	<span class="n">B_CAPSYM</span><span class="p">,</span>	<span class="cm">/* 143 */</span>
	<span class="n">B_CAPSYM</span><span class="p">,</span> <span class="n">B_CAPSYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_CAPSYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="cm">/* 144-150 */</span>
	<span class="n">B_SYM</span><span class="p">,</span>	<span class="cm">/* 151 */</span>
	<span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_CAPSYM</span><span class="p">,</span> <span class="n">B_CAPSYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="cm">/*152-158 */</span>
	<span class="n">B_SYM</span><span class="p">,</span>	<span class="cm">/* 159 */</span>
	<span class="n">WDLM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_CAPSYM</span><span class="p">,</span> <span class="cm">/* 160-166 */</span>
	<span class="n">B_SYM</span><span class="p">,</span>	<span class="cm">/* 167 */</span>
	<span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span>	<span class="cm">/* 168-175 */</span>
	<span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span>	<span class="cm">/* 176-183 */</span>
	<span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span>	<span class="cm">/* 184-191 */</span>
	<span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span>	<span class="cm">/* 192-199 */</span>
	<span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span>	<span class="cm">/* 200-207 */</span>
	<span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span>	<span class="cm">/* 208-215 */</span>
	<span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">A_CAP</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span>	<span class="cm">/* 216-223 */</span>
	<span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span>	<span class="cm">/* 224-231 */</span>
	<span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span>	<span class="cm">/* 232-239 */</span>
	<span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">B_SYM</span><span class="p">,</span>	<span class="cm">/* 240-247 */</span>
	<span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span><span class="p">,</span> <span class="n">ALPHA</span>	<span class="cm">/* 248-255 */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">speakup_task</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">bleep</span> <span class="n">unprocessed_sound</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">spk_keydown</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">spk_lastkey</span><span class="p">,</span> <span class="n">spk_close_press</span><span class="p">,</span> <span class="n">keymap_flags</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u_char</span> <span class="n">last_keycode</span><span class="p">,</span> <span class="n">this_speakup_key</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u_long</span> <span class="n">last_spk_jiffy</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">st_spk_t</span> <span class="o">*</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">MAX_NR_CONSOLES</span><span class="p">];</span>

<span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">spk_mutex</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">keyboard_notifier_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">keyboard_notifier_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">keyboard_notifier_call</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">vt_notifier_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">vt_notifier_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span> <span class="o">=</span> <span class="n">vt_notifier_call</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">get_attributes</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="p">(</span><span class="n">scr_readw</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_date</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spk_x</span> <span class="o">=</span> <span class="n">spk_cx</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
	<span class="n">spk_y</span> <span class="o">=</span> <span class="n">spk_cy</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">;</span>
	<span class="n">spk_pos</span> <span class="o">=</span> <span class="n">spk_cp</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>
	<span class="n">spk_old_attr</span> <span class="o">=</span> <span class="n">spk_attr</span><span class="p">;</span>
	<span class="n">spk_attr</span> <span class="o">=</span> <span class="n">get_attributes</span><span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">spk_pos</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bleep</span><span class="p">(</span><span class="n">u_short</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">vals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">350</span><span class="p">,</span> <span class="mi">370</span><span class="p">,</span> <span class="mi">392</span><span class="p">,</span> <span class="mi">414</span><span class="p">,</span> <span class="mi">440</span><span class="p">,</span> <span class="mi">466</span><span class="p">,</span> <span class="mi">491</span><span class="p">,</span> <span class="mi">523</span><span class="p">,</span> <span class="mi">554</span><span class="p">,</span> <span class="mi">587</span><span class="p">,</span> <span class="mi">619</span><span class="p">,</span> <span class="mi">659</span>
	<span class="p">};</span>
	<span class="kt">short</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="n">bleep_time</span><span class="p">;</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">val</span> <span class="o">%</span> <span class="mi">12</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">val</span> <span class="o">/</span> <span class="mi">12</span><span class="p">));</span>
	<span class="n">unprocessed_sound</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">unprocessed_sound</span><span class="p">.</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
	<span class="n">unprocessed_sound</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* We can only have 1 active sound at a time. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_shut_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_killed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spk_shut_up</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">spk_parked</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">speakup_date</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synth</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">do_flush</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speech_kill</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">synth</span><span class="o">-&gt;</span><span class="n">is_alive</span><span class="p">(</span><span class="n">synth</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* re-enables synth, if disabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">spk_killed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* dead */</span>
		<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_IAM_ALIVE</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_YOU_KILLED_SPEAKUP</span><span class="p">));</span>
		<span class="n">spk_shut_up</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_shut_up</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_HEY_THATS_BETTER</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spk_shut_up</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_YOU_TURNED_ME_OFF</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">speakup_date</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_parked</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_parked</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spk_parked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_UNPARKED</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_PARKED</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_cut</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">err_buf</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;set selection failed&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mark_cut_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mark_cut_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">xs</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">spk_x</span><span class="p">;</span>
		<span class="n">ys</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">spk_y</span><span class="p">;</span>
		<span class="n">spk_sel_cons</span> <span class="o">=</span> <span class="n">vc</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_MARK</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">xe</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">spk_x</span><span class="p">;</span>
	<span class="n">ye</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">spk_y</span><span class="p">;</span>
	<span class="n">mark_cut_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_CUT</span><span class="p">));</span>

	<span class="n">speakup_clear_selection</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">speakup_set_selection</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>		<span class="cm">/* no error */</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EFAULT</span>:
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%sEFAULT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">EINVAL</span>:
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%sEINVAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOMEM</span>:
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%sENOMEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err_buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_paste</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mark_cut_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mark_cut_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_MARK_CLEARED</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_PASTE</span><span class="p">));</span>
		<span class="n">speakup_paste_selection</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fg</span> <span class="o">=</span> <span class="n">spk_attr</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bg</span> <span class="o">=</span> <span class="n">spk_attr</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fg</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_BRIGHT</span><span class="p">));</span>
		<span class="n">fg</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_COLORS_START</span> <span class="o">+</span> <span class="n">fg</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bg</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot; %s &quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_ON_BLINKING</span><span class="p">));</span>
		<span class="n">bg</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot; %s &quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_ON</span><span class="p">));</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_COLORS_START</span> <span class="o">+</span> <span class="n">bg</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">edge_top</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">edge_bottom</span><span class="p">,</span>
	<span class="n">edge_left</span><span class="p">,</span>
	<span class="n">edge_right</span><span class="p">,</span>
	<span class="n">edge_quiet</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">announce_edge</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msg_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bleeps</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">bleep</span><span class="p">(</span><span class="n">spk_y</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">bleeps</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">msg_id</span> <span class="o">&lt;</span> <span class="n">edge_quiet</span><span class="p">))</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_EDGE_MSGS_START</span> <span class="o">+</span> <span class="n">msg_id</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speak_char</span><span class="p">(</span><span class="n">u_char</span> <span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">characters</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">var_t</span> <span class="o">*</span><span class="n">direct</span> <span class="o">=</span> <span class="n">get_var</span><span class="p">(</span><span class="n">DIRECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">direct</span> <span class="o">&amp;&amp;</span> <span class="n">direct</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">n</span><span class="p">.</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">B_CAP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pitch_shift</span><span class="o">++</span><span class="p">;</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">str_caps_start</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">B_CAP</span><span class="p">))</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">str_caps_stop</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;speak_char: cp == NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">synth_buffer_add</span><span class="p">(</span><span class="n">SPACE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">B_CAP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pitch_shift</span><span class="o">++</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">str_caps_start</span><span class="p">);</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">str_caps_stop</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;^&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_CTRL</span><span class="p">));</span>
			<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">cp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">synth_buffer_add</span><span class="p">(</span><span class="n">SPACE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">get_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">pos</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span> <span class="n">attribs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">w</span> <span class="o">=</span> <span class="n">scr_readw</span><span class="p">(</span><span class="n">pos</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">c</span> <span class="o">=</span> <span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_hi_font_mask</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>

		<span class="n">ch</span> <span class="o">=</span> <span class="n">inverse_translate</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="o">*</span><span class="n">attribs</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">spk_old_attr</span> <span class="o">=</span> <span class="n">spk_attr</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">spk_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spk_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_attr</span> <span class="o">!=</span> <span class="n">spk_old_attr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attrib_bleep</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">bleep</span><span class="p">(</span><span class="n">spk_y</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">attrib_bleep</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">say_attributes</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">speak_char</span><span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_phonetic_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">spk_old_attr</span> <span class="o">=</span> <span class="n">spk_attr</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">spk_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spk_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isascii</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isalpha</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">&amp;=</span> <span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phonetic</span><span class="p">[</span><span class="o">--</span><span class="n">ch</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">B_NUM</span><span class="p">))</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_NUMBER</span><span class="p">));</span>
		<span class="n">speak_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_prev_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">announce_edge</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">edge_left</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spk_x</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spk_pos</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">say_char</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_next_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">announce_edge</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">edge_right</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spk_x</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spk_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">say_char</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* get_word - will first check to see if the character under the</span>
<span class="cm"> * reading cursor is a space and if say_word_ctl is true it will</span>
<span class="cm"> * return the word space.  If say_word_ctl is not set it will check to</span>
<span class="cm"> * see if there is a word starting on the next position to the right</span>
<span class="cm"> * and return that word if it exists.  If it does not exist it will</span>
<span class="cm"> * move left to the beginning of any previous word on the line or the</span>
<span class="cm"> * beginning off the line whichever comes first.. */</span>

<span class="k">static</span> <span class="n">u_long</span> <span class="nf">get_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmpx</span> <span class="o">=</span> <span class="n">spk_x</span><span class="p">,</span> <span class="n">tmp_pos</span> <span class="o">=</span> <span class="n">spk_pos</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">attr_ch</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">spk_old_attr</span> <span class="o">=</span> <span class="n">spk_attr</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>

<span class="cm">/* decided to take out the sayword if on a space (mis-information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">say_word_ctl</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">SPACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_SPACE</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tmpx</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>
		   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">SPACE</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">IS_WDLM</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
		   <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tmp_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">)</span> <span class="o">&gt;</span>
		       <span class="n">SPACE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">tmpx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tmpx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">==</span> <span class="n">SPACE</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">IS_WDLM</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
			    <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="kt">char</span><span class="p">)</span><span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">)</span> <span class="o">&gt;</span>
				<span class="n">SPACE</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">tmp_pos</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">tmpx</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="n">attr_ch</span> <span class="o">=</span> <span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">spk_attr</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_ch</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmpx</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">tmpx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">==</span> <span class="n">SPACE</span><span class="p">)</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">IS_WDLM</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="n">SPACE</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">get_word</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">u_short</span> <span class="n">saved_punc_mask</span> <span class="o">=</span> <span class="n">punc_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">punc_mask</span> <span class="o">=</span> <span class="n">PUNC</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">cnt</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
	<span class="n">spkup_write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="n">punc_mask</span> <span class="o">=</span> <span class="n">saved_punc_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_prev_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">edge_said</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">last_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spk_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">announce_edge</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">edge_top</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spk_y</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spk_x</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
		<span class="n">edge_said</span> <span class="o">=</span> <span class="n">edge_quiet</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spk_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">edge_said</span> <span class="o">=</span> <span class="n">edge_top</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">edge_said</span> <span class="o">!=</span> <span class="n">edge_quiet</span><span class="p">)</span>
				<span class="n">edge_said</span> <span class="o">=</span> <span class="n">edge_left</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">spk_y</span><span class="o">--</span><span class="p">;</span>
			<span class="n">spk_x</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spk_x</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spk_pos</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">spk_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">SPACE</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_WDLM</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&lt;</span> <span class="n">last_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spk_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">spk_x</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">edge_said</span> <span class="o">==</span> <span class="n">edge_quiet</span><span class="p">)</span>
		<span class="n">edge_said</span> <span class="o">=</span> <span class="n">edge_left</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_said</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">edge_said</span> <span class="o">&lt;</span> <span class="n">edge_quiet</span><span class="p">)</span>
		<span class="n">announce_edge</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">edge_said</span><span class="p">);</span>
	<span class="n">say_word</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_next_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">edge_said</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">last_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">spk_y</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">announce_edge</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">edge_bottom</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">spk_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">SPACE</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">IS_WDLM</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="n">last_state</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">&gt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">spk_y</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">edge_said</span> <span class="o">=</span> <span class="n">edge_bottom</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spk_y</span><span class="o">++</span><span class="p">;</span>
			<span class="n">spk_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">edge_said</span> <span class="o">=</span> <span class="n">edge_right</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">spk_x</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spk_pos</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">last_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">edge_said</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">announce_edge</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">edge_said</span><span class="p">);</span>
	<span class="n">say_word</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spell_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">delay_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="s">&quot;. .&quot;</span><span class="p">,</span> <span class="s">&quot;. . .&quot;</span> <span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">str_cap</span> <span class="o">=</span> <span class="n">str_caps_stop</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp1</span><span class="p">,</span> <span class="o">*</span><span class="n">last_cap</span> <span class="o">=</span> <span class="n">str_caps_stop</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_word</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="o">*</span><span class="n">cp</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp</span> <span class="o">!=</span> <span class="n">buf</span><span class="p">)</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot; %s &quot;</span><span class="p">,</span> <span class="n">delay_str</span><span class="p">[</span><span class="n">spell_delay</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_CHAR</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">B_CAP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">str_cap</span> <span class="o">=</span> <span class="n">str_caps_start</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">str_caps_stop</span><span class="p">)</span>
				<span class="n">pitch_shift</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>	<span class="cm">/* synth has no pitch */</span>
				<span class="n">last_cap</span> <span class="o">=</span> <span class="n">str_caps_stop</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">str_cap</span> <span class="o">=</span> <span class="n">str_caps_stop</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">str_cap</span> <span class="o">!=</span> <span class="n">last_cap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">str_cap</span><span class="p">);</span>
			<span class="n">last_cap</span> <span class="o">=</span> <span class="n">str_cap</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this_speakup_key</span> <span class="o">==</span> <span class="n">SPELL_PHONETIC</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">isascii</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">isalpha</span><span class="p">(</span><span class="n">ch</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">&amp;=</span> <span class="mi">31</span><span class="p">;</span>
			<span class="n">cp1</span> <span class="o">=</span> <span class="n">phonetic</span><span class="p">[</span><span class="o">--</span><span class="n">ch</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cp1</span> <span class="o">=</span> <span class="n">characters</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp1</span> <span class="o">==</span> <span class="sc">&#39;^&#39;</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_CTRL</span><span class="p">));</span>
				<span class="n">cp1</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">cp1</span><span class="p">);</span>
		<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str_cap</span> <span class="o">!=</span> <span class="n">str_caps_stop</span><span class="p">)</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">str_caps_stop</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">spk_pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp2</span><span class="p">;</span>

	<span class="n">spk_old_attr</span> <span class="o">=</span> <span class="n">spk_attr</span><span class="p">;</span>
	<span class="n">spk_attr</span> <span class="o">=</span> <span class="n">get_attributes</span><span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">spk_pos</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp2</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SPACE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">++</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">saved_punc_mask</span> <span class="o">=</span> <span class="n">punc_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_BLANK</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this_speakup_key</span> <span class="o">==</span> <span class="n">SAY_LINE_INDENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="n">SPACE</span><span class="p">)</span>
			<span class="n">cp</span><span class="o">++</span><span class="p">;</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%d, &quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cp</span> <span class="o">-</span> <span class="n">buf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">punc_mask</span> <span class="o">=</span> <span class="n">punc_masks</span><span class="p">[</span><span class="n">reading_punc</span><span class="p">];</span>
	<span class="n">spkup_write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">punc_mask</span> <span class="o">=</span> <span class="n">saved_punc_mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_prev_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">announce_edge</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">edge_top</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spk_y</span><span class="o">--</span><span class="p">;</span>
	<span class="n">spk_pos</span> <span class="o">-=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
	<span class="n">say_line</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_next_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_y</span> <span class="o">==</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">announce_edge</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">edge_bottom</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spk_y</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spk_pos</span> <span class="o">+=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
	<span class="n">say_line</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">say_from_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">from</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">to</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">read_punc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">saved_punc_mask</span> <span class="o">=</span> <span class="n">punc_mask</span><span class="p">;</span>
	<span class="n">spk_old_attr</span> <span class="o">=</span> <span class="n">spk_attr</span><span class="p">;</span>
	<span class="n">spk_attr</span> <span class="o">=</span> <span class="n">get_attributes</span><span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">from</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">from</span> <span class="o">&lt;</span> <span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">from</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">from</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SPACE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_punc</span><span class="p">)</span>
		<span class="n">punc_mask</span> <span class="o">=</span> <span class="n">punc_info</span><span class="p">[</span><span class="n">reading_punc</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">spkup_write</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_punc</span><span class="p">)</span>
		<span class="n">punc_mask</span> <span class="o">=</span> <span class="n">saved_punc_mask</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_line_from_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">from</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">to</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">read_punc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="p">(</span><span class="n">spk_y</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="n">u_long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">to</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">start</span> <span class="o">+=</span> <span class="n">from</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">say_from_to</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">read_punc</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">!=</span> <span class="n">read_all_mode</span><span class="p">)</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_BLANK</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Sentence Reading Commands */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">currsentence</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">numsentences</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sentbufend</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sentmarks</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">10</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">currbuf</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bn</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">sentbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">256</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">say_sentence_num</span><span class="p">(</span><span class="kt">int</span> <span class="n">num</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bn</span> <span class="o">=</span> <span class="n">currbuf</span><span class="p">;</span>
	<span class="n">currsentence</span> <span class="o">=</span> <span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">bn</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">bn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">numsentences</span><span class="p">[</span><span class="n">bn</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spkup_write</span><span class="p">(</span><span class="n">sentmarks</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">num</span><span class="p">],</span> <span class="n">sentbufend</span><span class="p">[</span><span class="n">bn</span><span class="p">]</span> <span class="o">-</span> <span class="n">sentmarks</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">num</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_sentence_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">read_punc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bn</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">currbuf</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currbuf</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">currbuf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bn</span> <span class="o">=</span> <span class="n">currbuf</span><span class="p">;</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="p">((</span><span class="n">spk_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="p">((</span><span class="n">spk_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">)</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">numsentences</span><span class="p">[</span><span class="n">bn</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sentmarks</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sentbuf</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spk_old_attr</span> <span class="o">=</span> <span class="n">spk_attr</span><span class="p">;</span>
	<span class="n">spk_attr</span> <span class="o">=</span> <span class="n">get_attributes</span><span class="p">((</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">start</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sentbuf</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sentbuf</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">SPACE</span> <span class="o">&amp;&amp;</span> <span class="n">sentbuf</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span>
			    <span class="o">&amp;&amp;</span> <span class="n">numsentences</span><span class="p">[</span><span class="n">bn</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Sentence Marker */</span>
				<span class="n">numsentences</span><span class="p">[</span><span class="n">bn</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
				<span class="n">sentmarks</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">numsentences</span><span class="p">[</span><span class="n">bn</span><span class="p">]]</span> <span class="o">=</span>
				    <span class="o">&amp;</span><span class="n">sentbuf</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sentbuf</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SPACE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">sentbuf</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
	<span class="n">sentbuf</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="o">++</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">sentbufend</span><span class="p">[</span><span class="n">bn</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sentbuf</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">numsentences</span><span class="p">[</span><span class="n">bn</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_screen_from_to</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">from</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">to</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">from</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">from</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">to</span> <span class="o">&gt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">)</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="p">(</span><span class="n">to</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">from</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">from</span> <span class="o">=</span> <span class="n">to</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">from</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
		<span class="n">say_from_to</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_screen</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">say_screen_from_to</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_win_say</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_start</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_NO_WINDOW</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">start</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="p">(</span><span class="n">win_top</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="p">(</span><span class="n">win_bottom</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">from</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">win_left</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">to</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="p">(</span><span class="n">win_right</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">say_from_to</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">top_edge</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">spk_pos</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">spk_x</span><span class="p">;</span>
	<span class="n">spk_y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">say_line</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bottom_edge</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">spk_pos</span> <span class="o">+=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="n">spk_y</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
	<span class="n">spk_y</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">say_line</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">left_edge</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">spk_pos</span> <span class="o">-=</span> <span class="n">spk_x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spk_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">say_char</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">right_edge</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">spk_pos</span> <span class="o">+=</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="n">spk_x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spk_x</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">say_char</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_first_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">u_char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_BLANK</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">SPACE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">spk_pos</span> <span class="o">-=</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spk_x</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%d, &quot;</span><span class="p">,</span> <span class="o">++</span><span class="n">i</span><span class="p">);</span>
	<span class="n">speak_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_last_char</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">get_line</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">u_char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_BLANK</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ch</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="o">--</span><span class="n">len</span><span class="p">];</span>
	<span class="n">spk_pos</span> <span class="o">-=</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">spk_x</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%d, &quot;</span><span class="p">,</span> <span class="o">++</span><span class="n">len</span><span class="p">);</span>
	<span class="n">speak_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_position</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_POS_INFO</span><span class="p">),</span> <span class="n">spk_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">spk_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		     <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Added by brianb */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_char_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u_short</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">get_char</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)</span> <span class="n">spk_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">ch</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_CHAR_INFO</span><span class="p">),</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* these are stub functions to keep keyboard.c happy. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_from_top</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">say_screen_from_to</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">spk_y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_to_bottom</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">say_screen_from_to</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">spk_y</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_from_left</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">say_line_from_to</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">spk_x</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">say_to_right</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">say_line_from_to</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">spk_x</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* end of stub functions. */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">spkup_write</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">in_buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">rep_count</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u_char</span> <span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">old_ch</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u_short</span> <span class="n">char_type</span><span class="p">,</span> <span class="n">last_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">in_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">spk_keydown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">read_all_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Insert Sentence Index */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">in_buf</span> <span class="o">==</span> <span class="n">sentmarks</span><span class="p">[</span><span class="n">bn</span><span class="p">][</span><span class="n">currsentence</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">currsentence</span> <span class="o">&lt;=</span> <span class="n">numsentences</span><span class="p">[</span><span class="n">bn</span><span class="p">]))</span>
				<span class="n">synth_insert_next_index</span><span class="p">(</span><span class="n">currsentence</span><span class="o">++</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="o">*</span><span class="n">in_buf</span><span class="o">++</span><span class="p">;</span>
		<span class="n">char_type</span> <span class="o">=</span> <span class="n">spk_chartab</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">old_ch</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">char_type</span> <span class="o">&amp;</span> <span class="n">B_NUM</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rep_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">last_type</span> <span class="o">&amp;</span> <span class="n">CH_RPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">rep_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
				<span class="n">synth_printf</span><span class="p">(</span><span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_REPEAT_DESC</span><span class="p">),</span>
					     <span class="o">++</span><span class="n">rep_count</span><span class="p">);</span>
				<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">rep_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">spk_lastkey</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rep_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key_echo</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&gt;=</span> <span class="n">MINECHOCHAR</span><span class="p">)</span>
				<span class="n">speak_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">char_type</span> <span class="o">&amp;</span> <span class="n">B_ALPHA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">synth_flags</span> <span class="o">&amp;</span> <span class="n">SF_DEC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">last_type</span> <span class="o">&amp;</span> <span class="n">PUNC</span><span class="p">))</span>
				<span class="n">synth_buffer_add</span><span class="p">(</span><span class="n">SPACE</span><span class="p">);</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">char_type</span> <span class="o">&amp;</span> <span class="n">B_NUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rep_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">char_type</span> <span class="o">&amp;</span> <span class="n">punc_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">speak_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
			<span class="n">char_type</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PUNC</span><span class="p">;</span>	<span class="cm">/* for dec nospell processing */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">char_type</span> <span class="o">&amp;</span> <span class="n">SYNTH_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* these are usually puncts like . and , which synth</span>
<span class="cm">			 * needs for expression.</span>
<span class="cm">			 * suppress multiple to get rid of long pauses and</span>
<span class="cm">			 * clear repeat count</span>
<span class="cm">			 * so if someone has</span>
<span class="cm">			 * repeats on you don&#39;t get nothing repeated count */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">!=</span> <span class="n">old_ch</span><span class="p">)</span>
				<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rep_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cm">/* send space and record position, if next is num overwrite space */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">old_ch</span> <span class="o">!=</span> <span class="n">ch</span><span class="p">)</span>
				<span class="n">synth_buffer_add</span><span class="p">(</span><span class="n">SPACE</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rep_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">old_ch</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">last_type</span> <span class="o">=</span> <span class="n">char_type</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spk_lastkey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_count</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">rep_count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">last_type</span> <span class="o">&amp;</span> <span class="n">CH_RPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_REPEAT_DESC2</span><span class="p">),</span> <span class="o">++</span><span class="n">rep_count</span><span class="p">);</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rep_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">NUM_CTL_LABELS</span> <span class="o">=</span> <span class="p">(</span><span class="n">MSG_CTL_END</span> <span class="o">-</span> <span class="n">MSG_CTL_START</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">read_all_doc</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cursor_done</span><span class="p">(</span><span class="n">u_long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">cursor_timer</span><span class="p">,</span> <span class="n">cursor_done</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_handle_shift</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synth</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">up_flag</span> <span class="o">||</span> <span class="n">spk_killed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spk_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">read_all_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_SHIFT</span><span class="p">)</span>:
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">);</span>
			<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
			<span class="n">do_flush</span><span class="p">();</span>
			<span class="n">read_all_doc</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_CTRL</span><span class="p">)</span>:
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">);</span>
			<span class="n">cursor_track</span> <span class="o">=</span> <span class="n">prev_cursor_track</span><span class="p">;</span>
			<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
			<span class="n">do_flush</span><span class="p">();</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="n">do_flush</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">say_ctrl</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">NUM_CTL_LABELS</span><span class="p">)</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_CTL_START</span> <span class="o">+</span> <span class="n">value</span><span class="p">));</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_handle_latin</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spk_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spk_lastkey</span> <span class="o">=</span> <span class="n">spk_keydown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synth</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">spk_killed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">spk_lastkey</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">spk_keydown</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spk_parked</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_echo</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="n">MINECHOCHAR</span><span class="p">)</span>
		<span class="n">speak_char</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">set_key_info</span><span class="p">(</span><span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">key_info</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">k_buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">states</span><span class="p">,</span> <span class="n">key_data_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">key_info</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">cp1</span> <span class="o">=</span> <span class="n">k_buffer</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">ch</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">num_keys</span><span class="p">;</span>
	<span class="n">version</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">!=</span> <span class="n">KEY_MAP_VER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">num_keys</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="n">states</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">key_data_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_keys</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_data_len</span> <span class="o">+</span> <span class="n">SHIFT_TBL_SIZE</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key_buf</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">k_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SHIFT_TBL_SIZE</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">our_keys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">our_keys</span><span class="p">));</span>
	<span class="n">shift_table</span> <span class="o">=</span> <span class="n">k_buffer</span><span class="p">;</span>
	<span class="n">our_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">shift_table</span><span class="p">;</span>
	<span class="n">cp1</span> <span class="o">+=</span> <span class="n">SHIFT_TBL_SIZE</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cp1</span><span class="p">,</span> <span class="n">cp</span><span class="p">,</span> <span class="n">key_data_len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="cm">/* get num_keys, states and data */</span>
	<span class="n">cp1</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>		<span class="cm">/* now pointing at shift states */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">states</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp1</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="n">SHIFT_TBL_SIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">shift_table</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">keymap_flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp1</span><span class="o">++</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="o">*</span><span class="n">cp1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="n">MAX_KEY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
		<span class="n">our_keys</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp1</span><span class="p">;</span>
		<span class="n">cp1</span> <span class="o">+=</span> <span class="n">states</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">var_t</span> <span class="n">spk_vars</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* bell must be first to set high limit */</span>
	<span class="p">{</span><span class="n">BELL_POS</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">SPELL_DELAY</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">ATTRIB_BLEEP</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">BLEEPS</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">BLEEP_TIME</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">PUNC_LEVEL</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">READING_PUNC</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">CURSOR_TIME</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span> <span class="p">},</span>
	<span class="p">{</span><span class="n">SAY_CONTROL</span><span class="p">,</span> <span class="n">TOGGLE_0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SAY_WORD_CTL</span><span class="p">,</span> <span class="n">TOGGLE_0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">NO_INTERRUPT</span><span class="p">,</span> <span class="n">TOGGLE_0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">KEY_ECHO</span><span class="p">,</span> <span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="p">{</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span> <span class="p">},</span>
	<span class="n">V_LAST_VAR</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">toggle_cursoring</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">read_all_mode</span><span class="p">)</span>
		<span class="n">cursor_track</span> <span class="o">=</span> <span class="n">prev_cursor_track</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">cursor_track</span> <span class="o">&gt;=</span> <span class="n">CT_Max</span><span class="p">)</span>
		<span class="n">cursor_track</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_CURSOR_MSGS_START</span> <span class="o">+</span> <span class="n">cursor_track</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reset_default_chars</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* First, free any non-default */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">characters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">default_chars</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">characters</span><span class="p">,</span> <span class="n">default_chars</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">default_chars</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">reset_default_chartab</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">spk_chartab</span><span class="p">,</span> <span class="n">default_chartab</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">default_chartab</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">st_bits_data</span> <span class="o">*</span><span class="n">pb_edit</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">edit_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">type</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">ch</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">pb_edit</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">,</span> <span class="n">ch_type</span> <span class="o">=</span> <span class="n">spk_chartab</span><span class="p">[</span><span class="n">ch</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">KT_LATIN</span> <span class="o">||</span> <span class="p">(</span><span class="n">ch_type</span> <span class="o">&amp;</span> <span class="n">B_NUM</span><span class="p">)</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">SPACE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="n">SPACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_EDIT_DONE</span><span class="p">));</span>
		<span class="n">special_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&lt;</span> <span class="n">PUNC</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ch_type</span> <span class="o">&amp;</span> <span class="n">PUNC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">spk_chartab</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">^=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">speak_char</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="n">spk_chartab</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">?</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_ON</span><span class="p">)</span> <span class="o">:</span>
		     <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_OFF</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Allocation concurrency is protected by the console semaphore */</span>
<span class="kt">int</span> <span class="nf">speakup_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vc_num</span><span class="p">;</span>

	<span class="n">vc_num</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">speakup_console</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
						  <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">speakup_date</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spk_parked</span><span class="p">)</span>
		<span class="n">speakup_date</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">speakup_deallocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">vc_num</span><span class="p">;</span>

	<span class="n">vc_num</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]);</span>
	<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">is_cursor</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u_long</span> <span class="n">old_cursor_pos</span><span class="p">,</span> <span class="n">old_cursor_x</span><span class="p">,</span> <span class="n">old_cursor_y</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cursor_con</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_highlight_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">read_all_key</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">start_read_all_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">);</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">RA_NOTHING</span><span class="p">,</span>
	<span class="n">RA_NEXT_SENT</span><span class="p">,</span>
	<span class="n">RA_PREV_LINE</span><span class="p">,</span>
	<span class="n">RA_NEXT_LINE</span><span class="p">,</span>
	<span class="n">RA_PREV_SENT</span><span class="p">,</span>
	<span class="n">RA_DOWN_ARROW</span><span class="p">,</span>
	<span class="n">RA_TIMER</span><span class="p">,</span>
	<span class="n">RA_FIND_NEXT_SENT</span><span class="p">,</span>
	<span class="n">RA_FIND_PREV_SENT</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kbd_fakekey2</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">);</span>
	<span class="n">speakup_fake_down_arrow</span><span class="p">();</span>
	<span class="n">start_read_all_timer</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">read_all_doc</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span> <span class="o">!=</span> <span class="n">fg_console</span><span class="p">)</span> <span class="o">||</span> <span class="n">synth</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">spk_shut_up</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">synth_supports_indexing</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">!=</span> <span class="n">read_all_mode</span><span class="p">)</span>
		<span class="n">prev_cursor_track</span> <span class="o">=</span> <span class="n">cursor_track</span><span class="p">;</span>
	<span class="n">cursor_track</span> <span class="o">=</span> <span class="n">read_all_mode</span><span class="p">;</span>
	<span class="n">reset_index_count</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get_sentence_buf</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">kbd_fakekey2</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_DOWN_ARROW</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">say_sentence_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">synth_insert_next_index</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">start_read_all_timer</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_TIMER</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_read_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">);</span>
	<span class="n">cursor_track</span> <span class="o">=</span> <span class="n">prev_cursor_track</span><span class="p">;</span>
	<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">do_flush</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_read_all_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">var_t</span> <span class="o">*</span><span class="n">cursor_timeout</span><span class="p">;</span>

	<span class="n">cursor_con</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
	<span class="n">read_all_key</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">cursor_timeout</span> <span class="o">=</span> <span class="n">get_var</span><span class="p">(</span><span class="n">CURSOR_TIME</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">cursor_timeout</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">n</span><span class="p">.</span><span class="n">value</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_cursor_read_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">indcount</span><span class="p">,</span> <span class="n">sentcount</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">sn</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RA_NEXT_SENT</span>:
		<span class="cm">/* Get Current Sentence */</span>
		<span class="n">get_index_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">indcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sentcount</span><span class="p">);</span>
		<span class="cm">/*printk(&quot;%d %d  &quot;, indcount, sentcount); */</span>
		<span class="n">reset_index_count</span><span class="p">(</span><span class="n">sentcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">indcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">say_sentence_num</span><span class="p">(</span><span class="n">sentcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kbd_fakekey2</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_FIND_NEXT_SENT</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">synth_insert_next_index</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">say_sentence_num</span><span class="p">(</span><span class="n">sentcount</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sn</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">reset_index_count</span><span class="p">(</span><span class="n">sn</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">synth_insert_next_index</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">say_sentence_num</span><span class="p">(</span><span class="n">sn</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kbd_fakekey2</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_FIND_NEXT_SENT</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">synth_insert_next_index</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">start_read_all_timer</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_TIMER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RA_PREV_SENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RA_NEXT_LINE</span>:
		<span class="n">read_all_doc</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RA_PREV_LINE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RA_DOWN_ARROW</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">get_sentence_buf</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kbd_fakekey2</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_DOWN_ARROW</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">say_sentence_num</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">synth_insert_next_index</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">start_read_all_timer</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_TIMER</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RA_FIND_NEXT_SENT</span>:
		<span class="n">rv</span> <span class="o">=</span> <span class="n">get_sentence_buf</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">read_all_doc</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">kbd_fakekey2</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_FIND_NEXT_SENT</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">say_sentence_num</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">synth_insert_next_index</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">start_read_all_timer</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_TIMER</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RA_FIND_PREV_SENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RA_TIMER</span>:
		<span class="n">get_index_count</span><span class="p">(</span><span class="o">&amp;</span><span class="n">indcount</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sentcount</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">indcount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">kbd_fakekey2</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_DOWN_ARROW</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">start_read_all_timer</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">RA_TIMER</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pre_handle_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spk_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">read_all_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spk_parked</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">synth</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">up_flag</span> <span class="o">||</span> <span class="n">spk_shut_up</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NOTIFY_STOP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">);</span>
		<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="n">do_flush</span><span class="p">();</span>
		<span class="n">start_read_all_timer</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NOTIFY_STOP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_handle_cursor</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">var_t</span> <span class="o">*</span><span class="n">cursor_timeout</span><span class="p">;</span>

	<span class="n">spk_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spk_parked</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synth</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">up_flag</span> <span class="o">||</span> <span class="n">spk_shut_up</span> <span class="o">||</span> <span class="n">cursor_track</span> <span class="o">==</span> <span class="n">CT_Off</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_intr</span><span class="p">)</span>
		<span class="n">do_flush</span><span class="p">();</span>
<span class="cm">/* the key press flushes if !no_inter but we want to flush on cursor</span>
<span class="cm"> * moves regardless of no_inter state */</span>
	<span class="n">is_cursor</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">old_cursor_pos</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>
	<span class="n">old_cursor_x</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
	<span class="n">old_cursor_y</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">;</span>
	<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">cy</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">;</span>
	<span class="n">cursor_con</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">CT_Highlight</span><span class="p">)</span>
		<span class="n">reset_highlight_buffers</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">cursor_timeout</span> <span class="o">=</span> <span class="n">get_var</span><span class="p">(</span><span class="n">CURSOR_TIME</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">cursor_timeout</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">n</span><span class="p">.</span><span class="n">value</span><span class="p">));</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_color_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bi</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vc_num</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>

	<span class="n">bi</span> <span class="o">=</span> <span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_attr</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highsize</span><span class="p">[</span><span class="n">bi</span><span class="p">];</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highsize</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">rpos</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_pos</span><span class="p">;</span>
		<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span><span class="p">;</span>
		<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">ry</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">hi</span> <span class="o">&lt;</span> <span class="n">COLOR_BUFFER_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highbuf</span><span class="p">[</span><span class="n">bi</span><span class="p">][</span><span class="n">hi</span><span class="p">]</span> <span class="o">=</span> <span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">hi</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highbuf</span><span class="p">[</span><span class="n">bi</span><span class="p">][</span><span class="n">hi</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span>
			    <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highbuf</span><span class="p">[</span><span class="n">bi</span><span class="p">][</span><span class="n">hi</span><span class="p">]</span> <span class="o">=</span>
				    <span class="n">ic</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">hi</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highsize</span><span class="p">[</span><span class="n">bi</span><span class="p">]</span> <span class="o">=</span> <span class="n">hi</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_highlight_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vc_num</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highsize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">count_highlight_color</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">bg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vc_num</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">bgcount</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">get_attributes</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">bg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">bgcount</span><span class="p">[</span><span class="n">bg</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">bgcount</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cc</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_highlight_color</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cptr</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vc_num</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">bgcount</span><span class="p">[</span><span class="n">cptr</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;</span>
			    <span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">bgcount</span><span class="p">[</span><span class="n">cptr</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">cptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">cptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cptr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">cptr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">bgcount</span><span class="p">[</span><span class="n">cptr</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highsize</span><span class="p">[</span><span class="n">cptr</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">cptr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">speak_highlight</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">hc</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vc_num</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count_highlight_color</span><span class="p">(</span><span class="n">vc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hc</span> <span class="o">=</span> <span class="n">get_highlight_color</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">-</span> <span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">cy</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">ry</span><span class="p">[</span><span class="n">hc</span><span class="p">]</span> <span class="o">!=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">do_flush</span><span class="p">();</span>
		<span class="n">spkup_write</span><span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highbuf</span><span class="p">[</span><span class="n">hc</span><span class="p">],</span>
			    <span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">highsize</span><span class="p">[</span><span class="n">hc</span><span class="p">]);</span>
		<span class="n">spk_pos</span> <span class="o">=</span> <span class="n">spk_cp</span> <span class="o">=</span> <span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">rpos</span><span class="p">[</span><span class="n">hc</span><span class="p">];</span>
		<span class="n">spk_x</span> <span class="o">=</span> <span class="n">spk_cx</span> <span class="o">=</span> <span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">hc</span><span class="p">];</span>
		<span class="n">spk_y</span> <span class="o">=</span> <span class="n">spk_cy</span> <span class="o">=</span> <span class="n">speakup_console</span><span class="p">[</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">ry</span><span class="p">[</span><span class="n">hc</span><span class="p">];</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cursor_done</span><span class="p">(</span><span class="n">u_long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">cursor_con</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">);</span>
	<span class="n">spk_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_con</span> <span class="o">!=</span> <span class="n">fg_console</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">is_cursor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">speakup_date</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&gt;=</span> <span class="n">win_left</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&lt;=</span> <span class="n">win_right</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">&gt;=</span> <span class="n">win_top</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">&lt;=</span> <span class="n">win_bottom</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spk_keydown</span> <span class="o">=</span> <span class="n">is_cursor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">read_all_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle_cursor_read_all</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">read_all_key</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">CT_Highlight</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speak_highlight</span><span class="p">(</span><span class="n">vc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spk_keydown</span> <span class="o">=</span> <span class="n">is_cursor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">CT_Window</span><span class="p">)</span>
		<span class="n">speakup_win_say</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_cursor</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">is_cursor</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">say_line_from_to</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">say_char</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">spk_keydown</span> <span class="o">=</span> <span class="n">is_cursor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called by: vt_notifier_call() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_bs</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spk_trylock</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
		<span class="cm">/* Speakup output, discard */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spk_parked</span><span class="p">)</span>
		<span class="n">speakup_date</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_shut_up</span> <span class="o">||</span> <span class="n">synth</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span> <span class="o">==</span> <span class="n">fg_console</span> <span class="o">&amp;&amp;</span> <span class="n">spk_keydown</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spk_keydown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cursor</span><span class="p">)</span>
			<span class="n">say_char</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* called by: vt_notifier_call() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_con_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span> <span class="o">!=</span> <span class="n">fg_console</span><span class="p">)</span> <span class="o">||</span> <span class="n">spk_shut_up</span> <span class="o">||</span> <span class="n">synth</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spk_trylock</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
		<span class="cm">/* Speakup output, discard */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bell_pos</span> <span class="o">&amp;&amp;</span> <span class="n">spk_keydown</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">==</span> <span class="n">bell_pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">bleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">is_cursor</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">read_all_mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">CT_Highlight</span><span class="p">)</span>
			<span class="n">update_color_buffer</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&gt;=</span> <span class="n">win_left</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_x</span> <span class="o">&lt;=</span> <span class="n">win_right</span> <span class="o">&amp;&amp;</span>
		    <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">&gt;=</span> <span class="n">win_top</span> <span class="o">&amp;&amp;</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_y</span> <span class="o">&lt;=</span> <span class="n">win_bottom</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spkup_write</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">speakup_con_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">spk_parked</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spk_trylock</span><span class="p">(</span><span class="n">flags</span><span class="p">))</span>
		<span class="cm">/* Speakup output, discard */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">speakup_date</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_handle_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">,</span> <span class="kt">char</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">on_off</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">label</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synth</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">up_flag</span> <span class="o">||</span> <span class="n">spk_killed</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spk_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_intr</span><span class="p">)</span>
		<span class="n">do_flush</span><span class="p">();</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_CAPS</span><span class="p">)</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_KEYNAME_CAPSLOCK</span><span class="p">);</span>
		<span class="n">on_off</span> <span class="o">=</span> <span class="n">vt_get_leds</span><span class="p">(</span><span class="n">fg_console</span><span class="p">,</span> <span class="n">VC_CAPSLOCK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_NUM</span><span class="p">)</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_KEYNAME_NUMLOCK</span><span class="p">);</span>
		<span class="n">on_off</span> <span class="o">=</span> <span class="n">vt_get_leds</span><span class="p">(</span><span class="n">fg_console</span><span class="p">,</span> <span class="n">VC_NUMLOCK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_HOLD</span><span class="p">)</span>:
		<span class="n">label</span> <span class="o">=</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_KEYNAME_SCROLLLOCK</span><span class="p">);</span>
		<span class="n">on_off</span> <span class="o">=</span> <span class="n">vt_get_leds</span><span class="p">(</span><span class="n">fg_console</span><span class="p">,</span> <span class="n">VC_SCROLLOCK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">])</span>
			<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">tty_stopped</span> <span class="o">=</span> <span class="n">on_off</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">spk_parked</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on_off</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">label</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_STATUS_START</span> <span class="o">+</span> <span class="n">on_off</span><span class="p">));</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inc_dec_var</span><span class="p">(</span><span class="n">u_char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_var_header</span> <span class="o">*</span><span class="n">p_header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">var_t</span> <span class="o">*</span><span class="n">var_data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">num_buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">num_buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">var_id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">value</span> <span class="o">-</span> <span class="n">VAR_START</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">how</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_id</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">E_INC</span> <span class="o">:</span> <span class="n">E_DEC</span><span class="p">;</span>
	<span class="n">var_id</span> <span class="o">=</span> <span class="n">var_id</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">FIRST_SET_VAR</span><span class="p">;</span>
	<span class="n">p_header</span> <span class="o">=</span> <span class="n">get_var_header</span><span class="p">(</span><span class="n">var_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_header</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_header</span><span class="o">-&gt;</span><span class="n">var_type</span> <span class="o">!=</span> <span class="n">VAR_NUM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">var_data</span> <span class="o">=</span> <span class="n">p_header</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set_num_var</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p_header</span><span class="p">,</span> <span class="n">how</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spk_close_press</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pn</span> <span class="o">=</span> <span class="n">p_header</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span> <span class="o">*</span><span class="n">pn</span><span class="p">;</span> <span class="n">pn</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pn</span> <span class="o">==</span> <span class="sc">&#39;_&#39;</span><span class="p">)</span>
				<span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="n">SPACE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">cp</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">pn</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">num_buf</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">cp</span> <span class="o">-</span> <span class="n">num_buf</span><span class="p">),</span> <span class="s">&quot; %d &quot;</span><span class="p">,</span>
		 <span class="n">var_data</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">n</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">num_buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_win_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">info</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_start</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_WINDOW_ALREADY_SET</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_x</span> <span class="o">&lt;</span> <span class="n">win_left</span> <span class="o">||</span> <span class="n">spk_y</span> <span class="o">&lt;</span> <span class="n">win_top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_END_BEFORE_START</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_start</span> <span class="o">&amp;&amp;</span> <span class="n">spk_x</span> <span class="o">==</span> <span class="n">win_left</span> <span class="o">&amp;&amp;</span> <span class="n">spk_y</span> <span class="o">==</span> <span class="n">win_top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">win_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">win_right</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">win_bottom</span> <span class="o">=</span> <span class="n">spk_y</span><span class="p">;</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_WINDOW_LINE</span><span class="p">),</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">win_top</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">win_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">win_top</span> <span class="o">=</span> <span class="n">spk_y</span><span class="p">;</span>
			<span class="n">win_left</span> <span class="o">=</span> <span class="n">spk_x</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">win_bottom</span> <span class="o">=</span> <span class="n">spk_y</span><span class="p">;</span>
			<span class="n">win_right</span> <span class="o">=</span> <span class="n">spk_x</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">),</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_WINDOW_BOUNDARY</span><span class="p">),</span>
			 <span class="p">(</span><span class="n">win_start</span><span class="p">)</span> <span class="o">?</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_END</span><span class="p">)</span> <span class="o">:</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_START</span><span class="p">),</span>
			 <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">spk_y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">spk_x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">win_start</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_win_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">win_top</span> <span class="o">=</span> <span class="n">win_bottom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win_left</span> <span class="o">=</span> <span class="n">win_right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_WINDOW_CLEARED</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_win_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_start</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_NO_WINDOW</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">win_enabled</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win_enabled</span><span class="p">)</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_WINDOW_SILENCED</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_WINDOW_SILENCE_DISABLED</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">this_speakup_key</span> <span class="o">-</span> <span class="p">(</span><span class="n">FIRST_EDIT_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">special_handler</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_ERROR</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pb_edit</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">punc_info</span><span class="p">[</span><span class="n">val</span><span class="p">];</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_EDIT_PROMPT</span><span class="p">),</span> <span class="n">pb_edit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">special_handler</span> <span class="o">=</span> <span class="n">edit_bits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">handle_goto</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">type</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">ch</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">goto_buf</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\0\0\0\0\0\0</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">go_pos</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">cp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">KT_SPKUP</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">==</span> <span class="n">SPEAKUP_GOTO</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_goto</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">KT_LATIN</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">do_goto</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">oops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">goto_buf</span><span class="p">[</span><span class="o">--</span><span class="n">num</span><span class="p">];</span>
		<span class="n">goto_buf</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">spkup_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="sc">&#39;+&#39;</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">&gt;</span> <span class="sc">&#39;y&#39;</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">oops</span><span class="p">;</span>
	<span class="n">goto_buf</span><span class="p">[</span><span class="n">num</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
	<span class="n">goto_buf</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">spkup_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">maxlen</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">goto_buf</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="n">maxlen</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="n">maxlen</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="n">maxlen</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">oops</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="sc">&#39;x&#39;</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">&gt;</span> <span class="sc">&#39;y&#39;</span><span class="p">)</span> <span class="p">{</span>
<span class="nl">oops:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spk_killed</span><span class="p">)</span>
			<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_GOTO_CANCELED</span><span class="p">));</span>
		<span class="n">goto_buf</span><span class="p">[</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">special_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cp</span> <span class="o">=</span> <span class="n">speakup_s2i</span><span class="p">(</span><span class="n">goto_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">go_pos</span><span class="p">);</span>
	<span class="n">goto_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">go_pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cp</span> <span class="o">==</span> <span class="sc">&#39;x&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">goto_buf</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
			<span class="n">goto_pos</span> <span class="o">+=</span> <span class="n">spk_x</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">goto_pos</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">goto_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">goto_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">goto_pos</span> <span class="o">&gt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">)</span>
			<span class="n">goto_pos</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">goto_x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">goto_buf</span> <span class="o">&lt;</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
			<span class="n">goto_pos</span> <span class="o">+=</span> <span class="n">spk_y</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">goto_pos</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">goto_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">goto_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">goto_pos</span> <span class="o">&gt;=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span><span class="p">)</span>
			<span class="n">goto_pos</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">goto_x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">goto_buf</span><span class="p">[</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="nl">do_goto:</span>
	<span class="n">special_handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spk_parked</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">goto_x</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spk_pos</span> <span class="o">-=</span> <span class="n">spk_x</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">spk_x</span> <span class="o">=</span> <span class="n">goto_pos</span><span class="p">;</span>
		<span class="n">spk_pos</span> <span class="o">+=</span> <span class="n">goto_pos</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">say_word</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spk_y</span> <span class="o">=</span> <span class="n">goto_pos</span><span class="p">;</span>
		<span class="n">spk_pos</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_origin</span> <span class="o">+</span> <span class="p">(</span><span class="n">goto_pos</span> <span class="o">*</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_size_row</span><span class="p">);</span>
		<span class="n">say_line</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_goto</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">special_handler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_ERROR</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">synth_printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_get</span><span class="p">(</span><span class="n">MSG_GOTO</span><span class="p">));</span>
	<span class="n">special_handler</span> <span class="o">=</span> <span class="n">handle_goto</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_help</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">handle_help</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KT_SPKUP</span><span class="p">,</span> <span class="n">SPEAKUP_HELP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_nothing</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>			<span class="cm">/* flush done in do_spkup */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="n">key_speakup</span><span class="p">,</span> <span class="n">spk_key_locked</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">speakup_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spk_key_locked</span><span class="p">)</span>
		<span class="n">spk_key_locked</span> <span class="o">=</span> <span class="n">key_speakup</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">spk_key_locked</span> <span class="o">=</span> <span class="n">key_speakup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">spkup_hand</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="p">);</span>
<span class="n">spkup_hand</span> <span class="n">spkup_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* must be ordered same as defines in speakup.h */</span>
	<span class="n">do_nothing</span><span class="p">,</span> <span class="n">speakup_goto</span><span class="p">,</span> <span class="n">speech_kill</span><span class="p">,</span> <span class="n">speakup_shut_up</span><span class="p">,</span>
	<span class="n">speakup_cut</span><span class="p">,</span> <span class="n">speakup_paste</span><span class="p">,</span> <span class="n">say_first_char</span><span class="p">,</span> <span class="n">say_last_char</span><span class="p">,</span>
	<span class="n">say_char</span><span class="p">,</span> <span class="n">say_prev_char</span><span class="p">,</span> <span class="n">say_next_char</span><span class="p">,</span>
	<span class="n">say_word</span><span class="p">,</span> <span class="n">say_prev_word</span><span class="p">,</span> <span class="n">say_next_word</span><span class="p">,</span>
	<span class="n">say_line</span><span class="p">,</span> <span class="n">say_prev_line</span><span class="p">,</span> <span class="n">say_next_line</span><span class="p">,</span>
	<span class="n">top_edge</span><span class="p">,</span> <span class="n">bottom_edge</span><span class="p">,</span> <span class="n">left_edge</span><span class="p">,</span> <span class="n">right_edge</span><span class="p">,</span>
	<span class="n">spell_word</span><span class="p">,</span> <span class="n">spell_word</span><span class="p">,</span> <span class="n">say_screen</span><span class="p">,</span>
	<span class="n">say_position</span><span class="p">,</span> <span class="n">say_attributes</span><span class="p">,</span>
	<span class="n">speakup_off</span><span class="p">,</span> <span class="n">speakup_parked</span><span class="p">,</span> <span class="n">say_line</span><span class="p">,</span>	<span class="cm">/* this is for indent */</span>
	<span class="n">say_from_top</span><span class="p">,</span> <span class="n">say_to_bottom</span><span class="p">,</span>
	<span class="n">say_from_left</span><span class="p">,</span> <span class="n">say_to_right</span><span class="p">,</span>
	<span class="n">say_char_num</span><span class="p">,</span> <span class="n">speakup_bits</span><span class="p">,</span> <span class="n">speakup_bits</span><span class="p">,</span> <span class="n">say_phonetic_char</span><span class="p">,</span>
	<span class="n">speakup_bits</span><span class="p">,</span> <span class="n">speakup_bits</span><span class="p">,</span> <span class="n">speakup_bits</span><span class="p">,</span>
	<span class="n">speakup_win_set</span><span class="p">,</span> <span class="n">speakup_win_clear</span><span class="p">,</span> <span class="n">speakup_win_enable</span><span class="p">,</span> <span class="n">speakup_win_say</span><span class="p">,</span>
	<span class="n">speakup_lock</span><span class="p">,</span> <span class="n">speakup_help</span><span class="p">,</span> <span class="n">toggle_cursoring</span><span class="p">,</span> <span class="n">read_all_doc</span><span class="p">,</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_spkup</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">spk_killed</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">SPEECH_KILL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">spk_keydown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spk_lastkey</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">this_speakup_key</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">SPKUP_MAX_FUNC</span> <span class="o">&amp;&amp;</span> <span class="n">spkup_handler</span><span class="p">[</span><span class="n">value</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">do_flush</span><span class="p">();</span>
		<span class="p">(</span><span class="o">*</span><span class="n">spkup_handler</span><span class="p">[</span><span class="n">value</span><span class="p">])</span> <span class="p">(</span><span class="n">vc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inc_dec_var</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bleep</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pad_chars</span> <span class="o">=</span> <span class="s">&quot;0123456789+-*/</span><span class="se">\015</span><span class="s">,.?()&quot;</span><span class="p">;</span>

<span class="kt">int</span>
<span class="nf">speakup_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">shift_state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">keysym</span><span class="p">,</span>
	    <span class="kt">int</span> <span class="n">up_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">kh</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="o">*</span><span class="n">key_info</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">type</span> <span class="o">=</span> <span class="n">KTYP</span><span class="p">(</span><span class="n">keysym</span><span class="p">),</span> <span class="n">value</span> <span class="o">=</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">keysym</span><span class="p">),</span> <span class="n">new_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">shift_info</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synth</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spk_lock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">tty</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">.</span><span class="n">tty</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="mh">0xf0</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">-=</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">KT_PAD</span>
		<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vt_get_leds</span><span class="p">(</span><span class="n">fg_console</span><span class="p">,</span> <span class="n">VC_NUMLOCK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spk_keydown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">spk_lastkey</span> <span class="o">=</span> <span class="n">pad_chars</span><span class="p">[</span><span class="n">value</span><span class="p">];</span>
		<span class="n">spk_keydown</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spk_parked</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">no_map</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">&gt;=</span> <span class="n">MAX_KEY</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_map</span><span class="p">;</span>
	<span class="n">key_info</span> <span class="o">=</span> <span class="n">our_keys</span><span class="p">[</span><span class="n">keycode</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_info</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_map</span><span class="p">;</span>
	<span class="cm">/* Check valid read all mode keys */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cursor_track</span> <span class="o">==</span> <span class="n">read_all_mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">up_flag</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_DOWN</span><span class="p">)</span>:
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_UP</span><span class="p">)</span>:
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_LEFT</span><span class="p">)</span>:
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_RIGHT</span><span class="p">)</span>:
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_PGUP</span><span class="p">)</span>:
		<span class="k">case</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_PGDN</span><span class="p">)</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">stop_read_all</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">shift_info</span> <span class="o">=</span> <span class="p">(</span><span class="n">shift_state</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_speakup</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">shift_table</span><span class="p">[</span><span class="n">shift_info</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">new_key</span> <span class="o">=</span> <span class="n">key_info</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_key</span> <span class="o">==</span> <span class="n">SPK_KEY</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">spk_key_locked</span><span class="p">)</span>
					<span class="n">key_speakup</span> <span class="o">=</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span> <span class="o">||</span> <span class="n">spk_killed</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
				<span class="n">do_flush</span><span class="p">();</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">last_keycode</span> <span class="o">==</span> <span class="n">keycode</span> <span class="o">&amp;&amp;</span>
			    <span class="n">last_spk_jiffy</span> <span class="o">+</span> <span class="n">MAX_DELAY</span> <span class="o">&gt;</span> <span class="n">jiffies</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spk_close_press</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">shift_table</span><span class="p">[</span><span class="n">shift_info</span> <span class="o">+</span> <span class="mi">32</span><span class="p">];</span>
				<span class="cm">/* double press? */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">key_info</span><span class="p">[</span><span class="n">offset</span><span class="p">])</span>
					<span class="n">new_key</span> <span class="o">=</span> <span class="n">key_info</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">last_keycode</span> <span class="o">=</span> <span class="n">keycode</span><span class="p">;</span>
			<span class="n">last_spk_jiffy</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">KT_SPKUP</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">new_key</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">no_map:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">KT_SPKUP</span> <span class="o">&amp;&amp;</span> <span class="n">special_handler</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_spkup</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">new_key</span><span class="p">);</span>
		<span class="n">spk_close_press</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span> <span class="o">||</span> <span class="n">spk_killed</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">KT_SHIFT</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">spk_shut_up</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span>
	<span class="n">kh</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_DOWN</span><span class="p">))</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_UP</span><span class="p">))</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_LEFT</span><span class="p">))</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">K_RIGHT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cursor_track</span> <span class="o">!=</span> <span class="n">read_all_mode</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">kh</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">no_intr</span><span class="p">)</span>
			<span class="n">do_flush</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">special_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">KT_SPEC</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">value</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">KT_LATIN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">KT_LETTER</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">KT_LATIN</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mh">0x7f</span><span class="p">)</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* make del = backspace */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">special_handler</span><span class="p">)</span> <span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">keycode</span><span class="p">);</span>
		<span class="n">spk_close_press</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">bleep</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">last_keycode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spk_unlock</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">keyboard_notifier_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">keyboard_notifier_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">_param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">up</span> <span class="o">=</span> <span class="o">!</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">down</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">keycode</span><span class="p">;</span>	<span class="cm">/* to hold the current keycode */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">==</span> <span class="n">KD_GRAPHICS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * First, determine whether we are handling a fake keypress on</span>
<span class="cm">	 * the current processor.  If we are, then return NOTIFY_OK,</span>
<span class="cm">	 * to pass the keystroke up the chain.  This prevents us from</span>
<span class="cm">	 * trying to take the Speakup lock while it is held by the</span>
<span class="cm">	 * processor on which the simulated keystroke was generated.</span>
<span class="cm">	 * Also, the simulated keystrokes should be ignored by Speakup.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speakup_fake_key_pressed</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KBD_KEYCODE</span>:
		<span class="cm">/* speakup requires keycode and keysym currently */</span>
		<span class="n">keycode</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KBD_UNBOUND_KEYCODE</span>:
		<span class="cm">/* not used yet */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KBD_UNICODE</span>:
		<span class="cm">/* not used yet */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KBD_KEYSYM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">speakup_key</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">up</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">NOTIFY_STOP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">KTYP</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="n">KT_CUR</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">pre_handle_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">),</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KBD_POST_KEYSYM</span>:<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">type</span> <span class="o">=</span> <span class="n">KTYP</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0xf0</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">KVAL</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">KT_SHIFT</span>:
				<span class="n">do_handle_shift</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KT_LATIN</span>:
			<span class="k">case</span> <span class="n">KT_LETTER</span>:
				<span class="n">do_handle_latin</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KT_CUR</span>:
				<span class="n">do_handle_cursor</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">KT_SPEC</span>:
				<span class="n">do_handle_spec</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vt_notifier_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vt_notifier_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">_param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">vc</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VT_ALLOCATE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_mode</span> <span class="o">==</span> <span class="n">KD_TEXT</span><span class="p">)</span>
			<span class="n">speakup_allocate</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VT_DEALLOCATE</span>:
		<span class="n">speakup_deallocate</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VT_WRITE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\b&#39;</span><span class="p">)</span>
			<span class="n">speakup_bs</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">d</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
			<span class="n">speakup_con_write</span><span class="p">(</span><span class="n">vc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VT_UPDATE</span>:
		<span class="n">speakup_con_update</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* called by: module_exit() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">speakup_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">unregister_keyboard_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_block</span><span class="p">);</span>
	<span class="n">unregister_vt_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_block</span><span class="p">);</span>
	<span class="n">speakup_unregister_devsynth</span><span class="p">();</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">);</span>
	<span class="n">kthread_stop</span><span class="p">(</span><span class="n">speakup_task</span><span class="p">);</span>
	<span class="n">speakup_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spk_mutex</span><span class="p">);</span>
	<span class="n">synth_release</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spk_mutex</span><span class="p">);</span>

	<span class="n">speakup_kobj_exit</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">speakup_remove_virtual_keyboard</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXVARS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">speakup_unregister_var</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">default_chars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">free_user_msgs</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* call by: module_init() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">speakup_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">st_spk_t</span> <span class="o">*</span><span class="n">first_console</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vc_data</span> <span class="o">*</span><span class="n">vc</span> <span class="o">=</span> <span class="n">vc_cons</span><span class="p">[</span><span class="n">fg_console</span><span class="p">].</span><span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">var_t</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>

	<span class="cm">/* These first few initializations cannot fail. */</span>
	<span class="n">initialize_msgs</span><span class="p">();</span>	<span class="cm">/* Initialize arrays for i18n. */</span>
	<span class="n">reset_default_chars</span><span class="p">();</span>
	<span class="n">reset_default_chartab</span><span class="p">();</span>
	<span class="n">strlwr</span><span class="p">(</span><span class="n">synth_name</span><span class="p">);</span>
	<span class="n">spk_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">n</span><span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_cols</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="o">=</span> <span class="n">spk_vars</span><span class="p">;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">var_id</span> <span class="o">!=</span> <span class="n">MAXVARS</span><span class="p">;</span> <span class="n">var</span><span class="o">++</span><span class="p">)</span>
		<span class="n">speakup_register_var</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="o">=</span> <span class="n">synth_time_vars</span><span class="p">;</span>
	     <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">var_id</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">var_id</span> <span class="o">&lt;</span> <span class="n">MAXVARS</span><span class="p">);</span> <span class="n">var</span><span class="o">++</span><span class="p">)</span>
		<span class="n">speakup_register_var</span><span class="p">(</span><span class="n">var</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">punc_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">set_mask_bits</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">set_key_info</span><span class="p">(</span><span class="n">key_defaults</span><span class="p">,</span> <span class="n">key_buf</span><span class="p">);</span>

	<span class="cm">/* From here on out, initializations can fail. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">speakup_add_virtual_keyboard</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_virtkeyboard</span><span class="p">;</span>

	<span class="n">first_console</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">first_console</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">first_console</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">speakup_console</span><span class="p">[</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">vc_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_console</span><span class="p">;</span>
	<span class="n">speakup_date</span><span class="p">(</span><span class="n">vc</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">speakup_allocate</span><span class="p">(</span><span class="n">vc_cons</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">d</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_kobjects</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">quiet_boot</span><span class="p">)</span>
		<span class="n">spk_shut_up</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">speakup_kobj_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_kobjects</span><span class="p">;</span>

	<span class="n">synth_init</span><span class="p">(</span><span class="n">synth_name</span><span class="p">);</span>
	<span class="n">speakup_register_devsynth</span><span class="p">();</span>
	<span class="cm">/*</span>
<span class="cm">	 * register_devsynth might fail, but this error is not fatal.</span>
<span class="cm">	 * /dev/synth is an extra feature; the rest of Speakup</span>
<span class="cm">	 * will work fine without it.</span>
<span class="cm">	 */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_keyboard_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_block</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_kbdnotifier</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_vt_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_block</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_vtnotifier</span><span class="p">;</span>

	<span class="n">speakup_task</span> <span class="o">=</span> <span class="n">kthread_create</span><span class="p">(</span><span class="n">speakup_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;speakup&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">speakup_task</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">speakup_task</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_task</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_user_nice</span><span class="p">(</span><span class="n">speakup_task</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">speakup_task</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;speakup %s: initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SPEAKUP_VERSION</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;synth name on entry is: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">synth_name</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">error_task:</span>
	<span class="n">unregister_vt_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt_notifier_block</span><span class="p">);</span>

<span class="nl">error_vtnotifier:</span>
	<span class="n">unregister_keyboard_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">keyboard_notifier_block</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cursor_timer</span><span class="p">);</span>

<span class="nl">error_kbdnotifier:</span>
	<span class="n">speakup_unregister_devsynth</span><span class="p">();</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spk_mutex</span><span class="p">);</span>
	<span class="n">synth_release</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spk_mutex</span><span class="p">);</span>
	<span class="n">speakup_kobj_exit</span><span class="p">();</span>

<span class="nl">error_kobjects:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NR_CONSOLES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">speakup_console</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="nl">error_alloc:</span>
	<span class="n">speakup_remove_virtual_keyboard</span><span class="p">();</span>

<span class="nl">error_virtkeyboard:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAXVARS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">speakup_unregister_var</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">default_chars</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">characters</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">free_user_msgs</span><span class="p">();</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">speakup_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">speakup_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
