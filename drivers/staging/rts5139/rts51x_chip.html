<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rts5139 › rts51x_chip.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rts51x_chip.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Driver for Realtek RTS51xx USB card reader</span>
<span class="cm"> * Header file</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009 Realtek Semiconductor Corp. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *   wwang (wei_wang@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> * Maintainer:</span>
<span class="cm"> *   Edwin Rong (edwin_rong@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __RTS51X_CHIP_H</span>
<span class="cp">#define __RTS51X_CHIP_H</span>

<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb_usual.h&gt;</span>
<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_host.h&gt;</span>

<span class="cp">#include &quot;trace.h&quot;</span>

<span class="cp">#define SUPPORT_CPRM</span>
<span class="cp">#define SUPPORT_MAGIC_GATE</span>
<span class="cp">#define SUPPORT_MSXC</span>
<span class="cp">#define USING_POLLING_CYCLE_DELINK</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GA</span>
<span class="cm">/* Using NORMAL_WRITE instead of AUTO_WRITE to set ICVTE */</span>
<span class="cp">#define MG_SET_ICV_SLOW</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_MSXC</span>
<span class="cp">#define XC_POWERCLASS</span>
<span class="cp">#define SUPPORT_PCGL_1P18</span>
<span class="cp">#endif</span>

<span class="cp">#define GET_CARD_STATUS_USING_EPC</span>

<span class="cp">#define CLOSE_SSC_POWER</span>

<span class="cp">#define SUPPORT_OCP</span>

<span class="cp">#define MS_SPEEDUP</span>

<span class="cp">#define SD_XD_IO_FOLLOW_PWR</span>

<span class="cp">#define SD_NR		2</span>
<span class="cp">#define MS_NR		3</span>
<span class="cp">#define XD_NR		4</span>
<span class="cp">#define SD_CARD		(1 &lt;&lt; SD_NR)</span>
<span class="cp">#define MS_CARD		(1 &lt;&lt; MS_NR)</span>
<span class="cp">#define XD_CARD		(1 &lt;&lt; XD_NR)</span>

<span class="cp">#define SD_CD		0x01</span>
<span class="cp">#define MS_CD		0x02</span>
<span class="cp">#define XD_CD		0x04</span>
<span class="cp">#define SD_WP		0x08</span>

<span class="cp">#define MAX_ALLOWED_LUN_CNT	8</span>
<span class="cp">#define CMD_BUF_LEN		1024</span>
<span class="cp">#define POLLING_INTERVAL	50	</span><span class="cm">/* 50ms */</span><span class="cp"></span>

<span class="cp">#define XD_FREE_TABLE_CNT	1200</span>
<span class="cp">#define MS_FREE_TABLE_CNT	512</span>

<span class="cm">/* Bit Operation */</span>
<span class="cp">#define SET_BIT(data, idx)	((data) |= 1 &lt;&lt; (idx))</span>
<span class="cp">#define CLR_BIT(data, idx)	((data) &amp;= ~(1 &lt;&lt; (idx)))</span>
<span class="cp">#define CHK_BIT(data, idx)	((data) &amp; (1 &lt;&lt; (idx)))</span>

<span class="cm">/* Command type */</span>
<span class="cp">#define READ_REG_CMD		0</span>
<span class="cp">#define WRITE_REG_CMD		1</span>
<span class="cp">#define CHECK_REG_CMD		2</span>

<span class="cp">#define PACKET_TYPE		4</span>
<span class="cp">#define CNT_H			5</span>
<span class="cp">#define CNT_L			6</span>
<span class="cp">#define STAGE_FLAG		7</span>
<span class="cp">#define CMD_OFFSET		8</span>

<span class="cm">/* Packet type */</span>
<span class="cp">#define BATCH_CMD		0</span>
<span class="cp">#define SEQ_READ		1</span>
<span class="cp">#define SEQ_WRITE		2</span>

<span class="cm">/* Stage flag */</span>
<span class="cp">#define STAGE_R			0x01</span>
<span class="cp">#define STAGE_DI		0x02</span>
<span class="cp">#define STAGE_DO		0x04</span>
<span class="cm">/* Return MS_TRANS_CFG, GET_INT */</span>
<span class="cp">#define STAGE_MS_STATUS		0x08</span>
<span class="cm">/* Return XD_CFG, XD_CTL, XD_PAGE_STATUS */</span>
<span class="cp">#define STAGE_XD_STATUS		0x10</span>
<span class="cm">/* Command stage mode */</span>
<span class="cp">#define MODE_C			0x00</span>
<span class="cp">#define MODE_CR			(STAGE_R)</span>
<span class="cp">#define MODE_CDIR		(STAGE_R | STAGE_DI)</span>
<span class="cp">#define MODE_CDOR		(STAGE_R | STAGE_DO)</span>

<span class="cm">/* Function return code */</span>
<span class="cp">#ifndef STATUS_SUCCESS</span>
<span class="cp">#define STATUS_SUCCESS		0</span>
<span class="cp">#endif</span>

<span class="cp">#define STATUS_FAIL		1</span>
<span class="cp">#define STATUS_TIMEDOUT		4</span>
<span class="cp">#define STATUS_NOMEM		5</span>
<span class="cp">#define STATUS_TRANS_SHORT	6</span>
<span class="cp">#define STATUS_TRANS_LONG	7</span>
<span class="cp">#define STATUS_STALLED		8</span>
<span class="cp">#define STATUS_ERROR		10</span>

<span class="cp">#define IDLE_MAX_COUNT		10</span>
<span class="cp">#define POLLING_WAIT_CNT	1</span>
<span class="cp">#define LED_GPIO		0</span>

<span class="cm">/* package */</span>
<span class="cp">#define QFN24			0</span>
<span class="cp">#define LQFP48			1</span>

<span class="cp">#define USB_11			0</span>
<span class="cp">#define USB_20			1</span>

<span class="cm">/*</span>
<span class="cm"> * Transport return codes</span>
<span class="cm"> */</span>
<span class="cm">/* Transport good, command good */</span>
<span class="cp">#define TRANSPORT_GOOD		0</span>
<span class="cm">/* Transport good, command failed */</span>
<span class="cp">#define TRANSPORT_FAILED	1</span>
<span class="cm">/* Transport bad (i.e. device dead) */</span>
<span class="cp">#define TRANSPORT_ERROR		3</span>

<span class="cm">/* Supported Clock */</span>
<span class="k">enum</span> <span class="n">card_clock</span> <span class="p">{</span> <span class="n">CLK_20</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CLK_30</span><span class="p">,</span> <span class="n">CLK_40</span><span class="p">,</span> <span class="n">CLK_50</span><span class="p">,</span> <span class="n">CLK_60</span><span class="p">,</span> <span class="n">CLK_80</span><span class="p">,</span> <span class="n">CLK_100</span> <span class="p">};</span>

<span class="cp">#ifdef _MSG_TRACE</span>

<span class="cp">#define TRACE_ITEM_CNT		64</span>

<span class="k">struct</span> <span class="n">trace_msg_t</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">line</span><span class="p">;</span>
<span class="cp">#define MSG_FUNC_LEN 64</span>
	<span class="kt">char</span> <span class="n">func</span><span class="p">[</span><span class="n">MSG_FUNC_LEN</span><span class="p">];</span>
<span class="cp">#define MSG_FILE_LEN 32</span>
	<span class="kt">char</span> <span class="n">file</span><span class="p">[</span><span class="n">MSG_FILE_LEN</span><span class="p">];</span>
<span class="cp">#define TIME_VAL_LEN 16</span>
	<span class="n">u8</span> <span class="n">timeval_buf</span><span class="p">[</span><span class="n">TIME_VAL_LEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">valid</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#endif </span><span class="cm">/* _MSG_TRACE */</span><span class="cp"></span>

<span class="cm">/* Size of the autosense data buffer */</span>
<span class="cp">#define SENSE_SIZE		18</span>

<span class="cm">/* Sense type */</span>
<span class="cp">#define	SENSE_TYPE_NO_SENSE				0</span>
<span class="cp">#define	SENSE_TYPE_MEDIA_CHANGE				1</span>
<span class="cp">#define	SENSE_TYPE_MEDIA_NOT_PRESENT			2</span>
<span class="cp">#define	SENSE_TYPE_MEDIA_LBA_OVER_RANGE			3</span>
<span class="cp">#define	SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT		4</span>
<span class="cp">#define	SENSE_TYPE_MEDIA_WRITE_PROTECT			5</span>
<span class="cp">#define	SENSE_TYPE_MEDIA_INVALID_CMD_FIELD		6</span>
<span class="cp">#define	SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR		7</span>
<span class="cp">#define	SENSE_TYPE_MEDIA_WRITE_ERR			8</span>
<span class="cp">#define SENSE_TYPE_FORMAT_CMD_FAILED			10</span>
<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
<span class="cm">/* COPY PROTECTION KEY EXCHANGE FAILURE - KEY NOT ESTABLISHED */</span>
<span class="cp">#define SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB		0x0b</span>
<span class="cm">/* COPY PROTECTION KEY EXCHANGE FAILURE - AUTHENTICATION FAILURE */</span>
<span class="cp">#define SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN		0x0c</span>
<span class="cm">/* INCOMPATIBLE MEDIUM INSTALLED */</span>
<span class="cp">#define SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM		0x0d</span>
<span class="cm">/* WRITE ERROR */</span>
<span class="cp">#define SENSE_TYPE_MG_WRITE_ERR				0x0e</span>
<span class="cp">#endif</span>

<span class="cm">/*---- sense key ----*/</span>
<span class="cp">#define ILGAL_REQ               0x05	</span><span class="cm">/* CDB/parameter/identify msg error */</span><span class="cp"></span>

<span class="cm">/*-----------------------------------</span>
<span class="cm">    SENSE_DATA</span>
<span class="cm">-----------------------------------*/</span>

<span class="cm">/*---- error code ----*/</span>
<span class="cp">#define CUR_ERR                 0x70	</span><span class="cm">/* current error                    */</span><span class="cp"></span>

<span class="cm">/*---- sense key Infomation ----*/</span>

<span class="cp">#define SKSV                    0x80</span>
<span class="cp">#define CDB_ILLEGAL             0x40</span>

<span class="cm">/*---- ASC ----*/</span>
<span class="cp">#define ASC_INVLD_CDB           0x24</span>

<span class="cm">/*---- ASQC ----*/</span>
<span class="cp">#define ASCQ_INVLD_CDB          0x00</span>

<span class="k">struct</span> <span class="n">sense_data_t</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">err_code</span><span class="p">;</span>	<span class="cm">/* error code */</span>
	<span class="cm">/* bit7 : valid                    */</span>
	<span class="cm">/*   (1 : SCSI2)                    */</span>
	<span class="cm">/*   (0 : Vendor specific)          */</span>
	<span class="cm">/* bit6-0 : error code             */</span>
	<span class="cm">/*  (0x70 : current error)          */</span>
	<span class="cm">/*  (0x71 : specific command error) */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">seg_no</span><span class="p">;</span>	<span class="cm">/* segment No.                      */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sense_key</span><span class="p">;</span>	<span class="cm">/* byte5 : ILI                      */</span>
	<span class="cm">/* bit3-0 : sense key              */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">info</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* information                       */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ad_sense_len</span><span class="p">;</span>	<span class="cm">/* additional sense data length     */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cmd_info</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* command specific information      */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">asc</span><span class="p">;</span>	<span class="cm">/* ASC                              */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ascq</span><span class="p">;</span>	<span class="cm">/* ASCQ                             */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rfu</span><span class="p">;</span>	<span class="cm">/* FRU                              */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sns_key_info</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>	<span class="cm">/* sense key specific information    */</span>
<span class="p">};</span>

<span class="cm">/* sd_ctl bit map */</span>
<span class="cm">/* SD push point control, bit 0, 1 */</span>
<span class="cp">#define SD_PUSH_POINT_CTL_MASK		0x03</span>
<span class="cp">#define SD_PUSH_POINT_DELAY		0x01</span>
<span class="cp">#define SD_PUSH_POINT_AUTO		0x02</span>
<span class="cm">/* SD sample point control, bit 2, 3 */</span>
<span class="cp">#define SD_SAMPLE_POINT_CTL_MASK	0x0C</span>
<span class="cp">#define SD_SAMPLE_POINT_DELAY		0x04</span>
<span class="cp">#define SD_SAMPLE_POINT_AUTO		0x08</span>
<span class="cm">/* SD DDR Tx phase set by user, bit 4 */</span>
<span class="cp">#define SD_DDR_TX_PHASE_SET_BY_USER	0x10</span>
<span class="cm">/* MMC DDR Tx phase set by user, bit 5 */</span>
<span class="cp">#define MMC_DDR_TX_PHASE_SET_BY_USER	0x20</span>
<span class="cm">/* Support MMC DDR mode, bit 6 */</span>
<span class="cm">/*#define SUPPORT_MMC_DDR_MODE          0x40 */</span>
<span class="cp">#define SUPPORT_UHS50_MMC44		0x40</span>

<span class="k">struct</span> <span class="n">rts51x_option</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">mspro_formatter_enable</span><span class="p">;</span>

	<span class="cm">/* card clock expected by user for fpga platform */</span>
	<span class="kt">int</span> <span class="n">fpga_sd_sdr104_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fpga_sd_ddr50_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fpga_sd_sdr50_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fpga_sd_hs_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fpga_mmc_52m_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fpga_ms_hg_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fpga_ms_4bit_clk</span><span class="p">;</span>

	<span class="cm">/* card clock expected by user for asic platform */</span>
	<span class="kt">int</span> <span class="n">asic_sd_sdr104_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">asic_sd_ddr50_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">asic_sd_sdr50_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">asic_sd_hs_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">asic_mmc_52m_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">asic_ms_hg_clk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">asic_ms_4bit_clk</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">ssc_depth_sd_sdr104</span><span class="p">;</span>	<span class="cm">/* sw */</span>
	<span class="n">u8</span> <span class="n">ssc_depth_sd_ddr50</span><span class="p">;</span>	<span class="cm">/* sw */</span>
	<span class="n">u8</span> <span class="n">ssc_depth_sd_sdr50</span><span class="p">;</span>	<span class="cm">/* sw */</span>
	<span class="n">u8</span> <span class="n">ssc_depth_sd_hs</span><span class="p">;</span>	<span class="cm">/* sw */</span>
	<span class="n">u8</span> <span class="n">ssc_depth_mmc_52m</span><span class="p">;</span>	<span class="cm">/* sw */</span>
	<span class="n">u8</span> <span class="n">ssc_depth_ms_hg</span><span class="p">;</span>	<span class="cm">/* sw */</span>
	<span class="n">u8</span> <span class="n">ssc_depth_ms_4bit</span><span class="p">;</span>	<span class="cm">/* sw */</span>
	<span class="n">u8</span> <span class="n">ssc_depth_low_speed</span><span class="p">;</span>	<span class="cm">/* sw */</span>

	<span class="cm">/* SD/MMC Tx phase */</span>
	<span class="kt">int</span> <span class="n">sd_ddr_tx_phase</span><span class="p">;</span>	<span class="cm">/* Enabled by bit 4 of sd_ctl */</span>
	<span class="kt">int</span> <span class="n">mmc_ddr_tx_phase</span><span class="p">;</span>	<span class="cm">/* Enabled by bit 5 of sd_ctl */</span>

	<span class="cm">/* priority of choosing sd speed funciton */</span>
	<span class="n">u32</span> <span class="n">sd_speed_prior</span><span class="p">;</span>

	<span class="cm">/* sd card control */</span>
	<span class="n">u32</span> <span class="n">sd_ctl</span><span class="p">;</span>

	<span class="cm">/* Enable Selective Suspend */</span>
	<span class="kt">int</span> <span class="n">ss_en</span><span class="p">;</span>
	<span class="cm">/* Interval to enter SS from IDLE state (second) */</span>
	<span class="kt">int</span> <span class="n">ss_delay</span><span class="p">;</span>

	<span class="cm">/* Enable SSC clock */</span>
	<span class="kt">int</span> <span class="n">ssc_en</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">auto_delink_en</span><span class="p">;</span>

	<span class="cm">/* sangdy2010-07-13:add FT2 fast mode */</span>
	<span class="kt">int</span> <span class="n">FT2_fast_mode</span><span class="p">;</span>
	<span class="cm">/* sangdy2010-07-15:</span>
<span class="cm">	 * add for config delay between 1/4 PMOS and 3/4 PMOS */</span>
	<span class="kt">int</span> <span class="n">pwr_delay</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">xd_rw_step</span><span class="p">;</span>		<span class="cm">/* add to tune xd tRP */</span>
	<span class="kt">int</span> <span class="n">D3318_off_delay</span><span class="p">;</span>	<span class="cm">/* add to tune D3318 off delay time */</span>
	<span class="kt">int</span> <span class="n">delink_delay</span><span class="p">;</span>	<span class="cm">/* add to tune delink delay time */</span>
	<span class="cm">/* add for rts5129 to enable/disable D3318 off */</span>
	<span class="n">u8</span> <span class="n">rts5129_D3318_off_enable</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sd20_pad_drive</span><span class="p">;</span>	<span class="cm">/* add to config SD20 PAD drive */</span>
	<span class="n">u8</span> <span class="n">sd30_pad_drive</span><span class="p">;</span>	<span class="cm">/* add to config SD30 pad drive */</span>
	<span class="cm">/*if reset or rw fail,then set SD20 pad drive again */</span>
	<span class="n">u8</span> <span class="n">reset_or_rw_fail_set_pad_drive</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">debounce_num</span><span class="p">;</span>	<span class="cm">/* debounce number */</span>
	<span class="n">u8</span> <span class="n">led_toggle_interval</span><span class="p">;</span>	<span class="cm">/* used to control led toggle speed */</span>
	<span class="kt">int</span> <span class="n">xd_rwn_step</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sd_send_status_en</span><span class="p">;</span>
	<span class="cm">/* used to store default phase which is</span>
<span class="cm">	 * used when phase tune all pass. */</span>
	<span class="n">u8</span> <span class="n">ddr50_tx_phase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ddr50_rx_phase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sdr50_tx_phase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sdr50_rx_phase</span><span class="p">;</span>
	<span class="cm">/* used to enable select sdr50 tx phase according to proportion. */</span>
	<span class="n">u8</span> <span class="n">sdr50_phase_sel</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ms_errreg_fix</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reset_mmc_first</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">speed_mmc</span><span class="p">;</span>		<span class="cm">/* when set, then try CMD55 only twice */</span>
	<span class="n">u8</span> <span class="n">led_always_on</span><span class="p">;</span>	<span class="cm">/* if set, then led always on when card exist */</span>
	<span class="n">u8</span> <span class="n">dv18_voltage</span><span class="p">;</span>	<span class="cm">/* add to tune dv18 voltage */</span>
<span class="p">};</span>

<span class="cp">#define MS_FORMATTER_ENABLED(chip)	((chip)-&gt;option.mspro_formatter_enable)</span>

<span class="k">struct</span> <span class="n">rts51x_chip</span><span class="p">;</span>

<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">card_rw_func</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">sec_addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sec_cnt</span><span class="p">);</span>

<span class="cm">/* For MS Card */</span>
<span class="cp">#define    MAX_DEFECTIVE_BLOCK     10</span>

<span class="k">struct</span> <span class="n">zone_entry</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">l2p_table</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">free_table</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">defect_list</span><span class="p">[</span><span class="n">MAX_DEFECTIVE_BLOCK</span><span class="p">];</span>	<span class="cm">/* For MS card only */</span>
	<span class="kt">int</span> <span class="n">set_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">get_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unused_blk_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disable_count</span><span class="p">;</span>
	<span class="cm">/* To indicate whether the L2P table of this zone has been built. */</span>
	<span class="kt">int</span> <span class="n">build_flag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">xd_delay_write_tag</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">old_phyblock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_phyblock</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">logblock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pageoff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">delay_write_flag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">xd_info</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">maker_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">device_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">block_shift</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">page_off</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr_cycle</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cis_block</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">multi_flag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">capacity</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">zone</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">zone_cnt</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">xd_delay_write_tag</span> <span class="n">delay_write</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">counter</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">xd_clock</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define TYPE_SD			0x0000</span>
<span class="cp">#define TYPE_MMC		0x0001</span>

<span class="cm">/* TYPE_SD */</span>
<span class="cp">#define SD_HS			0x0100</span>
<span class="cp">#define SD_SDR50		0x0200</span>
<span class="cp">#define SD_DDR50		0x0400</span>
<span class="cp">#define SD_SDR104		0x0800</span>
<span class="cp">#define SD_HCXC			0x1000</span>

<span class="cm">/* TYPE_MMC */</span>
<span class="cp">#define MMC_26M			0x0100</span>
<span class="cp">#define MMC_52M			0x0200</span>
<span class="cp">#define MMC_4BIT		0x0400</span>
<span class="cp">#define MMC_8BIT		0x0800</span>
<span class="cp">#define MMC_SECTOR_MODE		0x1000</span>
<span class="cp">#define MMC_DDR52		0x2000</span>

<span class="cm">/* SD card */</span>
<span class="cp">#define CHK_SD(sd_card)			(((sd_card)-&gt;sd_type &amp; 0xFF) == TYPE_SD)</span>
<span class="cp">#define CHK_SD_HS(sd_card)	\</span>
<span class="cp">	(CHK_SD(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; SD_HS))</span>
<span class="cp">#define CHK_SD_SDR50(sd_card)		\</span>
<span class="cp">	(CHK_SD(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; SD_SDR50))</span>
<span class="cp">#define CHK_SD_DDR50(sd_card)	\</span>
<span class="cp">	(CHK_SD(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; SD_DDR50))</span>
<span class="cp">#define CHK_SD_SDR104(sd_card)	\</span>
<span class="cp">	(CHK_SD(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; SD_SDR104))</span>
<span class="cp">#define CHK_SD_HCXC(sd_card)	\</span>
<span class="cp">	(CHK_SD(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; SD_HCXC))</span>
<span class="cp">#define CHK_SD30_SPEED(sd_card)	\</span>
<span class="cp">	(CHK_SD_SDR50(sd_card) || CHK_SD_DDR50(sd_card) ||\</span>
<span class="cp">	 CHK_SD_SDR104(sd_card))</span>

<span class="cp">#define SET_SD(sd_card)			((sd_card)-&gt;sd_type = TYPE_SD)</span>
<span class="cp">#define SET_SD_HS(sd_card)		((sd_card)-&gt;sd_type |= SD_HS)</span>
<span class="cp">#define SET_SD_SDR50(sd_card)		((sd_card)-&gt;sd_type |= SD_SDR50)</span>
<span class="cp">#define SET_SD_DDR50(sd_card)		((sd_card)-&gt;sd_type |= SD_DDR50)</span>
<span class="cp">#define SET_SD_SDR104(sd_card)		((sd_card)-&gt;sd_type |= SD_SDR104)</span>
<span class="cp">#define SET_SD_HCXC(sd_card)		((sd_card)-&gt;sd_type |= SD_HCXC)</span>

<span class="cp">#define CLR_SD_HS(sd_card)		((sd_card)-&gt;sd_type &amp;= ~SD_HS)</span>
<span class="cp">#define CLR_SD_SDR50(sd_card)		((sd_card)-&gt;sd_type &amp;= ~SD_SDR50)</span>
<span class="cp">#define CLR_SD_DDR50(sd_card)		((sd_card)-&gt;sd_type &amp;= ~SD_DDR50)</span>
<span class="cp">#define CLR_SD_SDR104(sd_card)		((sd_card)-&gt;sd_type &amp;= ~SD_SDR104)</span>
<span class="cp">#define CLR_SD_HCXC(sd_card)		((sd_card)-&gt;sd_type &amp;= ~SD_HCXC)</span>
<span class="cp">#define CLR_SD30_SPEED(sd_card)	\</span>
<span class="cp">	((sd_card)-&gt;sd_type &amp;= ~(SD_SDR50|SD_DDR50|SD_SDR104))</span>

<span class="cm">/* MMC card */</span>
<span class="cp">#define CHK_MMC(sd_card)	\</span>
<span class="cp">	(((sd_card)-&gt;sd_type &amp; 0xFF) == TYPE_MMC)</span>
<span class="cp">#define CHK_MMC_26M(sd_card)	\</span>
<span class="cp">	(CHK_MMC(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; MMC_26M))</span>
<span class="cp">#define CHK_MMC_52M(sd_card)	\</span>
<span class="cp">	(CHK_MMC(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; MMC_52M))</span>
<span class="cp">#define CHK_MMC_4BIT(sd_card)	\</span>
<span class="cp">	(CHK_MMC(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; MMC_4BIT))</span>
<span class="cp">#define CHK_MMC_8BIT(sd_card)	\</span>
<span class="cp">	(CHK_MMC(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; MMC_8BIT))</span>
<span class="cp">#define CHK_MMC_SECTOR_MODE(sd_card)\</span>
<span class="cp">	(CHK_MMC(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; MMC_SECTOR_MODE))</span>
<span class="cp">#define CHK_MMC_DDR52(sd_card)	\</span>
<span class="cp">	(CHK_MMC(sd_card) &amp;&amp; ((sd_card)-&gt;sd_type &amp; MMC_DDR52))</span>

<span class="cp">#define SET_MMC(sd_card)		((sd_card)-&gt;sd_type = TYPE_MMC)</span>
<span class="cp">#define SET_MMC_26M(sd_card)		((sd_card)-&gt;sd_type |= MMC_26M)</span>
<span class="cp">#define SET_MMC_52M(sd_card)		((sd_card)-&gt;sd_type |= MMC_52M)</span>
<span class="cp">#define SET_MMC_4BIT(sd_card)		((sd_card)-&gt;sd_type |= MMC_4BIT)</span>
<span class="cp">#define SET_MMC_8BIT(sd_card)		((sd_card)-&gt;sd_type |= MMC_8BIT)</span>
<span class="cp">#define SET_MMC_SECTOR_MODE(sd_card)	((sd_card)-&gt;sd_type |= MMC_SECTOR_MODE)</span>
<span class="cp">#define SET_MMC_DDR52(sd_card)		((sd_card)-&gt;sd_type |= MMC_DDR52)</span>

<span class="cp">#define CLR_MMC_26M(sd_card)		((sd_card)-&gt;sd_type &amp;= ~MMC_26M)</span>
<span class="cp">#define CLR_MMC_52M(sd_card)		((sd_card)-&gt;sd_type &amp;= ~MMC_52M)</span>
<span class="cp">#define CLR_MMC_4BIT(sd_card)		((sd_card)-&gt;sd_type &amp;= ~MMC_4BIT)</span>
<span class="cp">#define CLR_MMC_8BIT(sd_card)		((sd_card)-&gt;sd_type &amp;= ~MMC_8BIT)</span>
<span class="cp">#define CLR_MMC_SECTOR_MODE(sd_card)	((sd_card)-&gt;sd_type &amp;= ~MMC_SECTOR_MODE)</span>
<span class="cp">#define CLR_MMC_DDR52(sd_card)		((sd_card)-&gt;sd_type &amp;= ~MMC_DDR52)</span>

<span class="cp">#define CHK_MMC_HS(sd_card)	\</span>
<span class="cp">	(CHK_MMC_52M(sd_card) &amp;&amp; CHK_MMC_26M(sd_card))</span>
<span class="cp">#define CLR_MMC_HS(sd_card)			\</span>
<span class="cp">do {						\</span>
<span class="cp">	CLR_MMC_DDR52(sd_card);			\</span>
<span class="cp">	CLR_MMC_52M(sd_card);			\</span>
<span class="cp">	CLR_MMC_26M(sd_card);			\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define SD_SUPPORT_CLASS_TEN		0x01</span>
<span class="cp">#define SD_SUPPORT_1V8			0x02</span>

<span class="cp">#define SD_SET_CLASS_TEN(sd_card)	\</span>
<span class="cp">	((sd_card)-&gt;sd_setting |= SD_SUPPORT_CLASS_TEN)</span>
<span class="cp">#define SD_CHK_CLASS_TEN(sd_card)	\</span>
<span class="cp">	((sd_card)-&gt;sd_setting &amp; SD_SUPPORT_CLASS_TEN)</span>
<span class="cp">#define SD_CLR_CLASS_TEN(sd_card)	\</span>
<span class="cp">	((sd_card)-&gt;sd_setting &amp;= ~SD_SUPPORT_CLASS_TEN)</span>
<span class="cp">#define SD_SET_1V8(sd_card)		\</span>
<span class="cp">	((sd_card)-&gt;sd_setting |= SD_SUPPORT_1V8)</span>
<span class="cp">#define SD_CHK_1V8(sd_card)		\</span>
<span class="cp">	((sd_card)-&gt;sd_setting &amp; SD_SUPPORT_1V8)</span>
<span class="cp">#define SD_CLR_1V8(sd_card)		\</span>
<span class="cp">	((sd_card)-&gt;sd_setting &amp;= ~SD_SUPPORT_1V8)</span>
<span class="cp">#define CLR_RETRY_SD20_MODE(sd_card)		\</span>
<span class="cp">	((sd_card)-&gt;retry_SD20_mode = 0)</span>
<span class="cp">#define SET_RETRY_SD20_MODE(sd_card)		\</span>
<span class="cp">	((sd_card)-&gt;retry_SD20_mode = 1)</span>
<span class="cp">#define CHK_RETRY_SD20_MODE(sd_card)		\</span>
<span class="cp">	((sd_card)-&gt;retry_SD20_mode == 1)</span>

<span class="k">struct</span> <span class="n">sd_info</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">sd_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sd_data_buf_ready</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sd_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">capacity</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">raw_csd</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">raw_scr</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* Sequential RW */</span>
	<span class="kt">int</span> <span class="n">seq_mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">pre_dir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pre_sec_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pre_sec_cnt</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">counter</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">sd_clock</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_CPRM</span>
	<span class="kt">int</span> <span class="n">sd_pass_thru_en</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pre_cmd_err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">last_rsp_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="n">u8</span> <span class="n">func_group1_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">func_group2_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">func_group3_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">func_group4_mask</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">sd_switch_fail</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sd_read_phase</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retry_SD20_mode</span><span class="p">;</span>	<span class="cm">/* sangdy2010-06-10 */</span>
	<span class="n">u8</span> <span class="n">sd_reset_fail</span><span class="p">;</span>	<span class="cm">/* sangdy2010-07-01 */</span>
	<span class="n">u8</span> <span class="n">sd_send_status_en</span><span class="p">;</span>

<span class="p">};</span>

<span class="cp">#define MODE_512_SEQ		0x01</span>
<span class="cp">#define MODE_2K_SEQ		0x02</span>

<span class="cp">#define TYPE_MS			0x0000</span>
<span class="cp">#define TYPE_MSPRO		0x0001</span>

<span class="cp">#define MS_4BIT			0x0100</span>
<span class="cp">#define MS_8BIT			0x0200</span>
<span class="cp">#define MS_HG			0x0400</span>
<span class="cp">#define MS_XC			0x0800</span>

<span class="cp">#define HG8BIT			(MS_HG | MS_8BIT)</span>

<span class="cp">#define CHK_MSPRO(ms_card)	\</span>
<span class="cp">	(((ms_card)-&gt;ms_type &amp; 0xFF) == TYPE_MSPRO)</span>
<span class="cp">#define CHK_HG8BIT(ms_card)	\</span>
<span class="cp">	(CHK_MSPRO(ms_card) &amp;&amp; (((ms_card)-&gt;ms_type &amp; HG8BIT) == HG8BIT))</span>
<span class="cp">#define CHK_MSXC(ms_card)	\</span>
<span class="cp">	(CHK_MSPRO(ms_card) &amp;&amp; ((ms_card)-&gt;ms_type &amp; MS_XC))</span>
<span class="cp">#define CHK_MSHG(ms_card)	\</span>
<span class="cp">	(CHK_MSPRO(ms_card) &amp;&amp; ((ms_card)-&gt;ms_type &amp; MS_HG))</span>

<span class="cp">#define CHK_MS8BIT(ms_card)	(((ms_card)-&gt;ms_type &amp; MS_8BIT))</span>
<span class="cp">#define CHK_MS4BIT(ms_card)	(((ms_card)-&gt;ms_type &amp; MS_4BIT))</span>

<span class="k">struct</span> <span class="n">ms_delay_write_tag</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">old_phyblock</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">new_phyblock</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">logblock</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pageoff</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">delay_write_flag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ms_info</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">ms_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">block_shift</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">page_off</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">total_block</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">boot_block</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">capacity</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">check_ms_flow</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">switch_8bit_fail</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">err_code</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">zone_entry</span> <span class="o">*</span><span class="n">segment</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">segment_cnt</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">pro_under_formatting</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">format_status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">progress</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">raw_sys_info</span><span class="p">[</span><span class="mi">96</span><span class="p">];</span>
<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
	<span class="n">u8</span> <span class="n">raw_model_name</span><span class="p">[</span><span class="mi">48</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="n">u8</span> <span class="n">multi_flag</span><span class="p">;</span>

	<span class="cm">/* Sequential RW */</span>
	<span class="n">u8</span> <span class="n">seq_mode</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="n">pre_dir</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pre_sec_addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pre_sec_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total_sec_cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">last_rw_int</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ms_delay_write_tag</span> <span class="n">delay_write</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">counter</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ms_clock</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="n">u8</span> <span class="n">magic_gate_id</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">mg_entry_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mg_auth</span><span class="p">;</span>		<span class="cm">/* flag to indicate authentication process */</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#define PRO_UNDER_FORMATTING(ms_card)		\</span>
<span class="cp">	((ms_card)-&gt;pro_under_formatting)</span>
<span class="cp">#define SET_FORMAT_STATUS(ms_card, status)	\</span>
<span class="cp">	((ms_card)-&gt;format_status = (status))</span>
<span class="cp">#define CHK_FORMAT_STATUS(ms_card, status)	\</span>
<span class="cp">	((ms_card)-&gt;format_status == (status))</span>

<span class="k">struct</span> <span class="n">scsi_cmnd</span><span class="p">;</span>

<span class="k">enum</span> <span class="n">CHIP_STAT</span> <span class="p">{</span> <span class="n">STAT_INIT</span><span class="p">,</span> <span class="n">STAT_IDLE</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">,</span> <span class="n">STAT_SS_PRE</span><span class="p">,</span> <span class="n">STAT_SS</span><span class="p">,</span>
	    <span class="n">STAT_SUSPEND</span> <span class="p">};</span>

<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">vendor_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">product_id</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">max_lun</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sense_data_t</span> <span class="n">sense_buffer</span><span class="p">[</span><span class="n">MAX_ALLOWED_LUN_CNT</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">led_toggle_counter</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ss_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idle_counter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">auto_delink_counter</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">CHIP_STAT</span> <span class="n">chip_stat</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">resume_from_scsi</span><span class="p">;</span>

	<span class="cm">/* Card information */</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="n">xd_card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="n">sd_card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="n">ms_card</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">cur_clk</span><span class="p">;</span>		<span class="cm">/* current card clock */</span>
	<span class="kt">int</span> <span class="n">cur_card</span><span class="p">;</span>		<span class="cm">/* Current card module */</span>

	<span class="n">u8</span> <span class="n">card_exist</span><span class="p">;</span>		<span class="cm">/* card exist bit map (physical exist) */</span>
	<span class="n">u8</span> <span class="n">card_ready</span><span class="p">;</span>		<span class="cm">/* card ready bit map (reset successfully) */</span>
	<span class="n">u8</span> <span class="n">card_fail</span><span class="p">;</span>		<span class="cm">/* card reset fail bit map */</span>
	<span class="n">u8</span> <span class="n">card_ejected</span><span class="p">;</span>	<span class="cm">/* card ejected bit map */</span>
	<span class="n">u8</span> <span class="n">card_wp</span><span class="p">;</span>		<span class="cm">/* card write protected bit map */</span>

	<span class="n">u8</span> <span class="n">fake_card_ready</span><span class="p">;</span>
	<span class="cm">/* flag to indicate whether to answer MediaChange */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lun_mc</span><span class="p">;</span>

	<span class="cm">/* card bus width */</span>
	<span class="n">u8</span> <span class="n">card_bus_width</span><span class="p">[</span><span class="n">MAX_ALLOWED_LUN_CNT</span><span class="p">];</span>
	<span class="cm">/* card capacity */</span>
	<span class="n">u32</span> <span class="n">capacity</span><span class="p">[</span><span class="n">MAX_ALLOWED_LUN_CNT</span><span class="p">];</span>

	<span class="cm">/* read/write card function pointer */</span>
	<span class="n">card_rw_func</span> <span class="n">rw_card</span><span class="p">[</span><span class="n">MAX_ALLOWED_LUN_CNT</span><span class="p">];</span>
	<span class="cm">/* read/write capacity, used for GPIO Toggle */</span>
	<span class="n">u32</span> <span class="n">rw_cap</span><span class="p">[</span><span class="n">MAX_ALLOWED_LUN_CNT</span><span class="p">];</span>
	<span class="cm">/* card to lun mapping table */</span>
	<span class="n">u8</span> <span class="n">card2lun</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="cm">/* lun to card mapping table */</span>
	<span class="n">u8</span> <span class="n">lun2card</span><span class="p">[</span><span class="n">MAX_ALLOWED_LUN_CNT</span><span class="p">];</span>

<span class="cp">#ifdef _MSG_TRACE</span>
	<span class="k">struct</span> <span class="n">trace_msg_t</span> <span class="n">trace_msg</span><span class="p">[</span><span class="n">TRACE_ITEM_CNT</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">msg_idx</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="kt">int</span> <span class="n">rw_need_retry</span><span class="p">;</span>

	<span class="cm">/* ASIC or FPGA */</span>
	<span class="kt">int</span> <span class="n">asic_code</span><span class="p">;</span>

	<span class="cm">/* QFN24 or LQFP48 */</span>
	<span class="kt">int</span> <span class="n">package</span><span class="p">;</span>

	<span class="cm">/* Full Speed or High Speed */</span>
	<span class="kt">int</span> <span class="n">usb_speed</span><span class="p">;</span>

	<span class="cm">/*sangdy:enable or disable UHS50 and MMC4.4 */</span>
	<span class="kt">int</span> <span class="n">uhs50_mmc44_en</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">ic_version</span><span class="p">;</span>

	<span class="cm">/* Command buffer */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cmd_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd_idx</span><span class="p">;</span>
	<span class="cm">/* Response buffer */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">rsp_buf</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">card_status</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="n">u16</span> <span class="n">ocp_stat</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">struct</span> <span class="n">rts51x_option</span> <span class="n">option</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rts51x_usb</span> <span class="o">*</span><span class="n">usb</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">rcc_read_response</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset_need_retry</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rts5179</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define UHS50_EN 0x0001</span>
<span class="cp">#define UHS50_DIS 0x0000</span>
<span class="cp">#define SET_UHS50(chip)   ((chip)-&gt;uhs50_mmc44_en = UHS50_EN)</span>
<span class="cp">#define CLEAR_UHS50(chip)  ((chip)-&gt;uhs50_mmc44_en = UHS50_DIS)</span>
<span class="cp">#define CHECK_UHS50(chip)  (((chip)-&gt;uhs50_mmc44_en&amp;0xff) == UHS50_EN)</span>

<span class="cp">#define RTS51X_GET_VID(chip)		((chip)-&gt;vendor_id)</span>
<span class="cp">#define RTS51X_GET_PID(chip)		((chip)-&gt;product_id)</span>

<span class="cp">#define RTS51X_SET_STAT(chip, stat)			\</span>
<span class="cp">do {							\</span>
<span class="cp">	if ((stat) != STAT_IDLE) {			\</span>
<span class="cp">		(chip)-&gt;idle_counter = 0;		\</span>
<span class="cp">	}						\</span>
<span class="cp">	(chip)-&gt;chip_stat = (enum CHIP_STAT)(stat);	\</span>
<span class="cp">} while (0)</span>
<span class="cp">#define RTS51X_CHK_STAT(chip, stat)	((chip)-&gt;chip_stat == (stat))</span>
<span class="cp">#define RTS51X_GET_STAT(chip)		((chip)-&gt;chip_stat)</span>

<span class="cp">#define CHECK_PID(chip, pid)		(RTS51X_GET_PID(chip) == (pid))</span>
<span class="cp">#define CHECK_PKG(chip, pkg)		((chip)-&gt;package == (pkg))</span>
<span class="cp">#define CHECK_USB(chip, speed)		((chip)-&gt;usb_speed == (speed))</span>

<span class="kt">int</span> <span class="n">rts51x_reset_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_init_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_release_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rts51x_polling_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rts51x_init_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;T&#39;</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;C&#39;</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;R&#39;</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">[</span><span class="n">PACKET_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="n">BATCH_CMD</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">rts51x_add_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_get_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rts51x_read_rsp_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsp_buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">rts51x_get_rsp_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsp_buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">rts51x_get_card_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_ep0_write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="n">data</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_ep0_read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_seq_write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_seq_read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_read_ppbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_write_ppbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_write_phy_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_read_phy_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rts51x_do_before_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rts51x_clear_hw_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rts51x_trace_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">clear</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rts51x_pp_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">status</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">status_len</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">rts51x_read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">rts51x_status</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status_len</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">rts51x_transfer_data_rcc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use_sg</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">act_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">u8</span> <span class="n">stage_flag</span><span class="p">);</span>

<span class="cp">#define RTS51X_WRITE_REG(chip, addr, mask, data)	\</span>
<span class="cp">do {							\</span>
<span class="cp">	int _retval = rts51x_write_register((chip),	\</span>
<span class="cp">			(addr), (mask), (data));	\</span>
<span class="cp">	if (_retval != STATUS_SUCCESS) {		\</span>
<span class="cp">		TRACE_RET((chip), _retval);		\</span>
<span class="cp">	}						\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define RTS51X_READ_REG(chip, addr, data)		\</span>
<span class="cp">do {							\</span>
<span class="cp">	int _retval = rts51x_read_register((chip),	\</span>
<span class="cp">			(addr), (data));		\</span>
<span class="cp">	if (_retval != STATUS_SUCCESS) {		\</span>
<span class="cp">		TRACE_RET((chip), _retval);		\</span>
<span class="cp">	}						\</span>
<span class="cp">} while (0)</span>

<span class="cp">#endif </span><span class="cm">/* __RTS51X_CHIP_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
