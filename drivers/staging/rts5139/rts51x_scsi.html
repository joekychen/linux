<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rts5139 › rts51x_scsi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rts51x_scsi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Driver for Realtek RTS51xx USB card reader</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009 Realtek Semiconductor Corp. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *   wwang (wei_wang@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> * Maintainer:</span>
<span class="cm"> *   Edwin Rong (edwin_rong@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &lt;scsi/scsi.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_eh.h&gt;</span>
<span class="cp">#include &lt;scsi/scsi_device.h&gt;</span>

<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;rts51x.h&quot;</span>
<span class="cp">#include &quot;rts51x_chip.h&quot;</span>
<span class="cp">#include &quot;rts51x_scsi.h&quot;</span>
<span class="cp">#include &quot;rts51x_card.h&quot;</span>
<span class="cp">#include &quot;rts51x_transport.h&quot;</span>
<span class="cp">#include &quot;sd_cprm.h&quot;</span>
<span class="cp">#include &quot;ms_mg.h&quot;</span>
<span class="cp">#include &quot;trace.h&quot;</span>

<span class="kt">void</span> <span class="nf">scsi_show_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">what</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">unknown_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;TEST_UNIT_READY&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REZERO_UNIT</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;REZERO_UNIT&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;REQUEST_SENSE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FORMAT_UNIT</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;FORMAT_UNIT&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_BLOCK_LIMITS</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_BLOCK_LIMITS&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;REASSIGN_BLOCKS&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_6</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_6&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_6</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_6&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEEK_6</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEEK_6&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_REVERSE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_REVERSE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_FILEMARKS</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_FILEMARKS&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SPACE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SPACE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INQUIRY</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;INQUIRY&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RECOVER_BUFFERED_DATA</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;RECOVER_BUFFERED_DATA&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SELECT</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;MODE_SELECT&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RESERVE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;RESERVE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RELEASE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;RELEASE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COPY</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;COPY&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ERASE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;ERASE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SENSE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;MODE_SENSE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">START_STOP</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;START_STOP&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RECEIVE_DIAGNOSTIC</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;RECEIVE_DIAGNOSTIC&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEND_DIAGNOSTIC</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEND_DIAGNOSTIC&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;ALLOW_MEDIUM_REMOVAL&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SET_WINDOW</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SET_WINDOW&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_CAPACITY&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_10</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_10&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_10</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_10&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEEK_10</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEEK_10&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_VERIFY</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_VERIFY&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VERIFY</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;VERIFY&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_HIGH</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEARCH_HIGH&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_EQUAL</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEARCH_EQUAL&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_LOW</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEARCH_LOW&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SET_LIMITS</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SET_LIMITS&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_POSITION</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_POSITION&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SYNCHRONIZE_CACHE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SYNCHRONIZE_CACHE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOCK_UNLOCK_CACHE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;LOCK_UNLOCK_CACHE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_DEFECT_DATA</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_DEFECT_DATA&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MEDIUM_SCAN</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;MEDIUM_SCAN&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COMPARE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;COMPARE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">COPY_VERIFY</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;COPY_VERIFY&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_BUFFER</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_BUFFER&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_BUFFER</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_BUFFER&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UPDATE_BLOCK</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;UPDATE_BLOCK&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_LONG</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_LONG&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_LONG</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_LONG&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHANGE_DEFINITION</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;CHANGE_DEFINITION&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_SAME</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_SAME&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_SUBCHANNEL</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ SUBCHANNEL&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_TOC</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_TOC&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_HEADER</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ HEADER&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_PLAY_AUDIO_10</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;PLAY AUDIO (10)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_PLAY_AUDIO_MSF</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;PLAY AUDIO MSF&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_GET_EVENT_STATUS_NOTIFICATION</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;GET EVENT/STATUS NOTIFICATION&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_PAUSE_RESUME</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;PAUSE/RESUME&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOG_SELECT</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;LOG_SELECT&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LOG_SENSE</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;LOG_SENSE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_STOP_PLAY_SCAN</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;STOP PLAY/SCAN&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_DISC_INFO</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ DISC INFORMATION&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_TRACK_RZONE_INFO</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ TRACK INFORMATION&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_RESERVE_RZONE_TRACK</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;RESERVE TRACK&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_SEND_OPC</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEND OPC&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SELECT_10</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;MODE_SELECT_10&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_REPAIR_RZONE_TRACK</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;REPAIR TRACK&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x59</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ MASTER CUE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MODE_SENSE_10</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;MODE_SENSE_10&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_CLOSE_TRACK</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;CLOSE TRACK/SESSION&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5C</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ BUFFER CAPACITY&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x5D</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEND CUE SHEET&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_BLANK</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;BLANK&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">REPORT_LUNS</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;REPORT LUNS&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MOVE_MEDIUM</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;MOVE_MEDIUM or PLAY AUDIO (12)&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_12</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_12&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_12</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_12&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_VERIFY_12</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_VERIFY_12&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_HIGH_12</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEARCH_HIGH_12&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_EQUAL_12</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEARCH_EQUAL_12&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEARCH_LOW_12</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEARCH_LOW_12&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SEND_VOLUME_TAG</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SEND_VOLUME_TAG&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">READ_ELEMENT_STATUS</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ_ELEMENT_STATUS&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_CD_MSF</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ CD MSF&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_SCAN</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SCAN&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_SET_SPEED</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;SET CD SPEED&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_MECHANISM_STATUS</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;MECHANISM STATUS&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">GPCMD_READ_CD</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;READ CD&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xE1</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE CONTINUE&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WRITE_LONG_2</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;WRITE_LONG_2&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VENDOR_CMND</span>:
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;Realtek&#39;s vendor command&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">what</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;(unknown command)&quot;</span><span class="p">;</span>
		<span class="n">unknown_cmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">TEST_UNIT_READY</span><span class="p">)</span>
		<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;Command %s (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">what</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unknown_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmd_len</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">RTS51X_DEBUGPN</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">RTS51X_DEBUGPN</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_sense_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sense_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sense_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3A</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_LBA_OVER_RANGE</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_PROTECT</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="n">ILGAL_REQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">ASC_INVLD_CDB</span><span class="p">,</span> <span class="n">ASCQ_INVLD_CDB</span><span class="p">,</span> <span class="n">CDB_ILLEGAL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_FORMAT_CMD_FAILED</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="k">case</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6F</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_MG_WRITE_ERR</span>:
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">SENSE_TYPE_NO_SENSE</span>:
	<span class="nl">default:</span>
		<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">set_sense_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err_code</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">sense_key</span><span class="p">,</span> <span class="n">u32</span> <span class="n">info</span><span class="p">,</span> <span class="n">u8</span> <span class="n">asc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ascq</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sns_key_info0</span><span class="p">,</span>
		    <span class="n">u16</span> <span class="n">sns_key_info1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sense_data_t</span> <span class="o">*</span><span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="n">lun</span><span class="p">]);</span>

	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">err_code</span> <span class="o">=</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">sense_key</span> <span class="o">=</span> <span class="n">sense_key</span><span class="p">;</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">info</span><span class="p">;</span>

	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">ad_sense_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sense_data_t</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">asc</span> <span class="o">=</span> <span class="n">asc</span><span class="p">;</span>
	<span class="n">sense</span><span class="o">-&gt;</span><span class="n">ascq</span> <span class="o">=</span> <span class="n">ascq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sns_key_info0</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sense</span><span class="o">-&gt;</span><span class="n">sns_key_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SKSV</span> <span class="o">|</span> <span class="n">sns_key_info0</span><span class="p">;</span>
		<span class="n">sense</span><span class="o">-&gt;</span><span class="n">sns_key_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sns_key_info1</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sense</span><span class="o">-&gt;</span><span class="n">sns_key_info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">sns_key_info1</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">test_unit_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="n">rts51x_init_cards</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_lun_mc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_lun_mc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">formatter_inquiry_str</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="sc">&#39;E&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="sc">&#39;O&#39;</span><span class="p">,</span> <span class="sc">&#39;R&#39;</span><span class="p">,</span> <span class="sc">&#39;Y&#39;</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">,</span> <span class="sc">&#39;T&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;C&#39;</span><span class="p">,</span> <span class="sc">&#39;K&#39;</span><span class="p">,</span>
	<span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="sc">&#39;M&#39;</span><span class="p">,</span> <span class="sc">&#39;G&#39;</span><span class="p">,</span>		<span class="cm">/* Byte[47:49] */</span>
	<span class="mh">0x0B</span><span class="p">,</span>			<span class="cm">/* Byte[50]: MG, MS, MSPro, MSXC */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* Byte[51]: Category Specific Commands */</span>
	<span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* Byte[52]: Access Control and feature */</span>
	<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>	<span class="cm">/* Byte[53:55] */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">inquiry</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">inquiry_default</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;Generic-xD/SD/M.S.      1.00 &quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">inquiry_string</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">sendbytes</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">card</span> <span class="o">=</span> <span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pro_formatter_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">inquiry_buf</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">QULIFIRE</span> <span class="o">|</span> <span class="n">DRCT_ACCESS_DEV</span><span class="p">,</span>
		<span class="n">RMB_DISC</span> <span class="o">|</span> <span class="mh">0x0D</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x01</span><span class="p">,</span>
		<span class="mh">0x1f</span><span class="p">,</span>
		<span class="mh">0x02</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">REL_ADR</span> <span class="o">|</span> <span class="n">WBUS_32</span> <span class="o">|</span> <span class="n">WBUS_16</span> <span class="o">|</span> <span class="n">SYNC</span> <span class="o">|</span> <span class="n">LINKED</span> <span class="o">|</span> <span class="n">CMD_QUE</span> <span class="o">|</span> <span class="n">SFT_RE</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">inquiry_string</span> <span class="o">=</span> <span class="n">inquiry_default</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">MS_FORMATTER_ENABLED</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">get_lun2card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">))</span>
			<span class="n">pro_formatter_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pro_formatter_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">56</span><span class="p">)</span>
			<span class="n">sendbytes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">sendbytes</span> <span class="o">=</span> <span class="mi">56</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">36</span><span class="p">)</span>
			<span class="n">sendbytes</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">sendbytes</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sendbytes</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">inquiry_buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">inquiry_string</span><span class="p">,</span> <span class="n">sendbytes</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pro_formatter_flag</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>	<span class="cm">/* Additional Length */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">inquiry_buf</span><span class="p">,</span> <span class="n">sendbytes</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pro_formatter_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sendbytes</span> <span class="o">&gt;</span> <span class="mi">36</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">36</span><span class="p">,</span> <span class="n">formatter_inquiry_str</span><span class="p">,</span> <span class="n">sendbytes</span> <span class="o">-</span> <span class="mi">36</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_stop_unit</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mh">0x4</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STOP_MEDIUM</span>:
		<span class="cm">/* Media disabled */</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UNLOAD_MEDIUM</span>:
		<span class="cm">/* Media shall be unload */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span>
			<span class="n">eject_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MAKE_MEDIUM_READY</span>:
	<span class="k">case</span> <span class="n">LOAD_MEDIUM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">allow_medium_removal</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">prevent</span><span class="p">;</span>

	<span class="n">prevent</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prevent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span>
			       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ms_mode_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">lun</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sys_info_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">data_size</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">support_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MODE_SENSE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sys_info_offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="mh">0x68</span><span class="p">)</span>
			<span class="n">data_size</span> <span class="o">=</span> <span class="mh">0x68</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x67</span><span class="p">;</span>	<span class="cm">/* Mode Data Length */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sys_info_offset</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="mh">0x6C</span><span class="p">)</span>
			<span class="n">data_size</span> <span class="o">=</span> <span class="mh">0x6C</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Mode Data Length (MSB) */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x6A</span><span class="p">;</span>	<span class="cm">/* Mode Data Length (LSB) */</span>
	<span class="p">}</span>

	<span class="cm">/* Medium Type Code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">support_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">support_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* WP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* MediaType */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* WP */</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Reserved */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">MODE_SENSE_10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Reserved */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Block descriptor length(MSB) */</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Block descriptor length(LSB) */</span>

		<span class="cm">/* The Following Data is the content of &quot;Page 0x20&quot; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* Page Code */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x62</span><span class="p">;</span>	<span class="cm">/* Page Length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* No Access Control */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">support_format</span><span class="p">)</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>	<span class="cm">/* SF, SGM */</span>
			<span class="k">else</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* The Following Data is the content of &quot;Page 0x20&quot; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>	<span class="cm">/* Page Code */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x62</span><span class="p">;</span>	<span class="cm">/* Page Length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* No Access Control */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">support_format</span><span class="p">)</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>	<span class="cm">/* SF, SGM */</span>
			<span class="k">else</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="n">sys_info_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 96 Bytes Attribute Data */</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">-</span> <span class="n">sys_info_offset</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">96</span><span class="p">)</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="mi">96</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">sys_info_offset</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_sys_info</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mode_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dataSize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pro_formatter_flag</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pageCode</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">card</span> <span class="o">=</span> <span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pro_formatter_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dataSize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="cm">/* In Combo mode, device responses ModeSense command as a MS LUN</span>
<span class="cm">	 * when no card is inserted */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun2card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dataSize</span> <span class="o">=</span> <span class="mi">108</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">option</span><span class="p">.</span><span class="n">mspro_formatter_enable</span><span class="p">)</span>
				<span class="n">pro_formatter_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">dataSize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

	<span class="n">pageCode</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x1C</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pro_formatter_flag</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">MODE_SENSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_mode_sense</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lun</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
					      <span class="n">dataSize</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dataSize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="k">else</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pageCode</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ms_mode_sense</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lun</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
					      <span class="n">dataSize</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dataSize</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TRANSPORT_GOOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">dataSize</span><span class="p">);</span>
		<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">request_sense</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sense_data_t</span> <span class="o">*</span><span class="n">sense</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">,</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">sense</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sense_buffer</span><span class="p">[</span><span class="n">lun</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">PRO_UNDER_FORMATTING</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mspro_format_sense</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sense</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>

	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Reset Sense Data */</span>
	<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_NO_SENSE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">start_sec</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sec_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_lun_mc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_lun_mc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_10</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_sec</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">sec_cnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">READ_6</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WRITE_6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">start_sec</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		    <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">sec_cnt</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">VENDOR_CMND</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">SCSI_APP_CMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">PP_READ10</span><span class="p">)</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">PP_WRITE10</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">start_sec</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">sec_cnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">start_sec</span> <span class="o">&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">])</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">start_sec</span> <span class="o">+</span> <span class="n">sec_cnt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LBA_OVER_RANGE</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sec_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_TO_DEVICE</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;Write protected card!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_PROTECT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">card_rw</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">start_sec</span><span class="p">,</span> <span class="n">sec_cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_format_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">card</span> <span class="o">=</span> <span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">desc_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">option</span><span class="p">.</span><span class="n">mspro_formatter_enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x14</span> <span class="o">:</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Capacity List Length */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">option</span><span class="p">.</span><span class="n">mspro_formatter_enable</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">desc_cnt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="n">desc_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">desc_cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">])</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">desc_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="cm">/* Byte[8]: Descriptor Type: Formatted medium */</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Byte[16] */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">desc_cnt</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="cm">/* Byte[8]: Descriptor Type: No medium */</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*Byte[16] */</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

		<span class="n">desc_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_capacity</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_lun_mc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_lun_mc</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">lun</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_dev_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">rts51x_pp_status</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>
	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rts51x_status</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="n">rts51x_read_status</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">rts51x_status</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rts51x_status</span><span class="p">));</span>
	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">rts51x_status</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;filter!addr=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_ep0_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;filter!addr=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

	<span class="n">rts51x_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span>
		    <span class="n">rts51x_ep0_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_sd_csd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_csd</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_phy_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span>
			    <span class="n">rts51x_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span>
					<span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
		<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_phy_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

		<span class="n">rts51x_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span>
			    <span class="n">rts51x_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span>
					       <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_card_bus_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">card</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">card</span> <span class="o">==</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">lun</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus_width</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef _MSG_TRACE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">trace_msg_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">clear</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">buf_len</span> <span class="o">=</span>
	    <span class="mi">4</span> <span class="o">+</span>
	    <span class="p">((</span><span class="mi">2</span> <span class="o">+</span> <span class="n">MSG_FUNC_LEN</span> <span class="o">+</span> <span class="n">MSG_FILE_LEN</span> <span class="o">+</span> <span class="n">TIME_VAL_LEN</span><span class="p">)</span> <span class="o">*</span> <span class="n">TRACE_ITEM_CNT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span>
			       <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">clear</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

	<span class="n">rts51x_trace_msg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">clear</span><span class="p">);</span>

	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rw_mem_cmd_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INIT_BATCHCMD</span>:
		<span class="n">rts51x_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ADD_BATCHCMD</span>:
		<span class="n">cmd_type</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_type</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">rts51x_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SEND_BATCHCMD</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">timeout</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span>
						  <span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">srb</span><span class="o">-&gt;</span>
								    <span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span>
								    <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span>
									  <span class="n">srb</span><span class="o">-&gt;</span>
									  <span class="n">cmnd</span>
									  <span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">STAGE_R</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rts51x_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
					<span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GET_BATCHRSP</span>:
		<span class="n">idx</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">rsp_buf</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">suit_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INIT_BATCHCMD</span>:
	<span class="k">case</span> <span class="n">ADD_BATCHCMD</span>:
	<span class="k">case</span> <span class="n">SEND_BATCHCMD</span>:
	<span class="k">case</span> <span class="n">GET_BATCHRSP</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">rw_mem_cmd_buf</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">app_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PP_READ10</span>:
	<span class="k">case</span> <span class="n">PP_WRITE10</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_write</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SUIT_CMD</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">suit_cmd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_PHY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_phy_register</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_PHY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">write_phy_register</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GET_DEV_STATUS</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">get_dev_status</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span>
			       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vendor_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">READ_STATUS</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_status</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_MEM</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_mem</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WRITE_MEM</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">write_mem</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GET_BUS_WIDTH</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">get_card_bus_width</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">GET_SD_CSD</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">get_sd_csd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef _MSG_TRACE</span>
	<span class="k">case</span> <span class="n">TRACE_MSG</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">trace_msg_cmd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">SCSI_APP_CMD</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">app_cmd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span>
			       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_format_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">quick_format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x4D</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x47</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x66</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x6D</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x74</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
		<span class="n">quick_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">quick_format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_PROTECT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">mspro_format</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">MS_SHORT_DATA_LEN</span><span class="p">,</span> <span class="n">quick_format</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_FORMAT_CMD_FAILED</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_ms_information</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">dev_info_id</span><span class="p">,</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xB0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x4D</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x53</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x49</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x44</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_info_id</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x3A</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x6A</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* GET Memory Stick Media Information Response Header */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Data length MSB */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>	<span class="cm">/* Data length LSB */</span>
	<span class="cm">/* Device Information Type Code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MSXC</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="cm">/* SGM bit */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="cm">/* Reserved */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="cm">/* Number of Device Information */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="cm">/*  Device Information Body</span>
<span class="cm">	 *  Device Information ID Number */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev_info_id</span><span class="p">;</span>
	<span class="cm">/* Device Information Length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x31</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data_len</span> <span class="o">=</span> <span class="mh">0x61</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* Data length MSB */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>	<span class="cm">/* Data length LSB */</span>
	<span class="cm">/* Valid Bit */</span>
	<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x13</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* System Information */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_sys_info</span><span class="p">,</span> <span class="mi">96</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Model Name */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">raw_model_name</span><span class="p">,</span> <span class="mi">48</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rts51x_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_info_id</span> <span class="o">==</span> <span class="mh">0x15</span><span class="p">)</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x3C</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x6C</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ms_sp_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">TRANSPORT_ERROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">MS_FORMAT</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ms_format_cmnd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="cp">#ifdef SUPPORT_PCGL_1P18</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">GET_MS_INFORMATION</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">get_ms_information</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_CPRM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_extention_cmnd</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="n">sd_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SD_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SD_PASS_THRU_MODE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_pass_thru_mode</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_EXECUTE_NO_DATA</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_execute_no_data</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_EXECUTE_READ</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_execute_read_data</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_EXECUTE_WRITE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_execute_write_data</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_GET_RSP</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_get_cmd_rsp</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SD_HW_RST</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_hw_rst</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mg_report_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_format</span><span class="p">;</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="n">KC_MG_R_PRO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">key_format</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KF_GET_LOC_EKB</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x41C</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_get_local_EKB</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_RSP_CHG</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x24</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x24</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_get_rsp_chg</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_GET_ICV</span>:
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_entry_num</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x404</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_get_ICV</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mg_send_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key_format</span><span class="p">;</span>

	<span class="n">rts51x_prepare_run</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">RTS51X_SET_STAT</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STAT_RUN</span><span class="p">);</span>

	<span class="n">ms_cleanup_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_card_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_card_wp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_PROTECT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MS_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="n">KC_MG_R_PRO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_MSPRO</span><span class="p">(</span><span class="n">ms_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">key_format</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">key_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KF_SET_LEAF_ID</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_set_leaf_id</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_CHG_HOST</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_chg</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_RSP_HOST</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_rsp</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">KF_SET_ICV</span>:
		<span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">mg_entry_num</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x404</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mg_set_ICV</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span>
				       <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">rts51x_scsi_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">get_lun_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">)</span> <span class="o">==</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">format_status</span> <span class="o">==</span> <span class="n">FORMAT_IN_PROGRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">REQUEST_SENSE</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">INQUIRY</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Logical Unit Not Ready Format in Progress */</span>
			<span class="n">set_sense_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">CUR_ERR</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">ms_card</span><span class="o">-&gt;</span><span class="n">progress</span><span class="p">));</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">READ_10</span>:
	<span class="k">case</span> <span class="n">WRITE_10</span>:
	<span class="k">case</span> <span class="n">READ_6</span>:
	<span class="k">case</span> <span class="n">WRITE_6</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_write</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">TEST_UNIT_READY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">test_unit_ready</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">INQUIRY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">inquiry</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">READ_CAPACITY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_capacity</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">START_STOP</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">start_stop_unit</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ALLOW_MEDIUM_REMOVAL</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">allow_medium_removal</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">REQUEST_SENSE</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">request_sense</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MODE_SENSE</span>:
	<span class="k">case</span> <span class="n">MODE_SENSE_10</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">mode_sense</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x23</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">read_format_capacity</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VENDOR_CMND</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">vendor_cmnd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">MS_SP_CMND</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">ms_sp_cmnd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_CPRM</span>
	<span class="k">case</span> <span class="n">SD_PASS_THRU_MODE</span>:
	<span class="k">case</span> <span class="n">SD_EXECUTE_NO_DATA</span>:
	<span class="k">case</span> <span class="n">SD_EXECUTE_READ</span>:
	<span class="k">case</span> <span class="n">SD_EXECUTE_WRITE</span>:
	<span class="k">case</span> <span class="n">SD_GET_RSP</span>:
	<span class="k">case</span> <span class="n">SD_HW_RST</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">sd_extention_cmnd</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_MAGIC_GATE</span>
	<span class="k">case</span> <span class="n">CMD_MSPRO_MG_RKEY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">mg_report_key</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CMD_MSPRO_MG_SKEY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">mg_send_key</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">case</span> <span class="n">FORMAT_UNIT</span>:
	<span class="k">case</span> <span class="n">MODE_SELECT</span>:
	<span class="k">case</span> <span class="n">VERIFY</span>:
		<span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">TRANSPORT_FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * Host functions</span>
<span class="cm"> ***********************************************************************/</span>

<span class="kt">int</span> <span class="nf">slave_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Set the INQUIRY transfer length to 36.  We don&#39;t use any of</span>
<span class="cm">	 * the extra data and many devices choke if asked for more or</span>
<span class="cm">	 * less than 36 bytes.</span>
<span class="cm">	 */</span>
	<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">inquiry_len</span> <span class="o">=</span> <span class="mi">36</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">slave_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Scatter-gather buffers (all but the last) must have a length</span>
<span class="cm">	 * divisible by the bulk maxpacket size.  Otherwise a data packet</span>
<span class="cm">	 * would end up being short, causing a premature end to the data</span>
<span class="cm">	 * transfer.  Since high-speed bulk pipes have a maxpacket size</span>
<span class="cm">	 * of 512, we&#39;ll use that as the scsi device queue&#39;s DMA alignment</span>
<span class="cm">	 * mask.  Guaranteeing proper alignment of the first buffer will</span>
<span class="cm">	 * have the desired effect because, except at the beginning and</span>
<span class="cm">	 * the end, scatter-gather buffers follow page boundaries. */</span>
	<span class="n">blk_queue_dma_alignment</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">request_queue</span><span class="p">,</span> <span class="p">(</span><span class="mi">512</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Set the SCSI level to at least 2.  We&#39;ll leave it at 3 if that&#39;s</span>
<span class="cm">	 * what is originally reported.  We need this to avoid confusing</span>
<span class="cm">	 * the SCSI layer with devices that report 0 or 1, but need 10-byte</span>
<span class="cm">	 * commands (ala ATAPI devices behind certain bridges, or devices</span>
<span class="cm">	 * which simply have broken INQUIRY data).</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: This means /dev/sg programs (ala cdrecord) will get the</span>
<span class="cm">	 * actual information.  This seems to be the preference for</span>
<span class="cm">	 * programs like that.</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: This also means that /proc/scsi/scsi and sysfs may report</span>
<span class="cm">	 * the actual value or the modified one, depending on where the</span>
<span class="cm">	 * data comes from.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">&lt;</span> <span class="n">SCSI_2</span><span class="p">)</span>
		<span class="n">sdev</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">=</span> <span class="n">sdev</span><span class="o">-&gt;</span><span class="n">sdev_target</span><span class="o">-&gt;</span><span class="n">scsi_level</span> <span class="o">=</span> <span class="n">SCSI_2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> * /proc/scsi/ functions</span>
<span class="cm"> ***********************************************************************/</span>

<span class="cm">/* we use this macro to help us write into the buffer */</span>
<span class="cp">#undef SPRINTF</span>
<span class="cp">#define SPRINTF(args...) \</span>
<span class="cp">	do { if (pos &lt; buffer+length) pos += sprintf(pos, ## args); } while (0)</span>

<span class="kt">int</span> <span class="nf">proc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
	      <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">inout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="cm">/* if someone is sending us data, just throw it away */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inout</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* print the controller name */</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;   Host scsi%d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">host_no</span><span class="p">,</span> <span class="n">RTS51X_NAME</span><span class="p">);</span>

	<span class="cm">/* print product, vendor, and driver version strings */</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;       Vendor: Realtek Corp.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;      Product: RTS51xx USB Card Reader</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;      Version: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>
	<span class="n">SPRINTF</span><span class="p">(</span><span class="s">&quot;        Build: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__TIME__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Calculate start of next buffer, and return value.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">offset</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">pos</span> <span class="o">-</span> <span class="n">buffer</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">buffer</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* queue a command */</span>
<span class="cm">/* This is always called with scsi_lock(host) held */</span>
<span class="kt">int</span> <span class="nf">queuecommand_lck</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">host_to_rts51x</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="cm">/* check for state-transition errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;Error in %s: chip-&gt;srb = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SCSI_MLQUEUE_HOST_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fail the command if we are disconnecting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLIDX_DISCONNECTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;Fail command during disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">srb</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">DID_NO_CONNECT</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">done</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* enqueue the command and wake up the control thread */</span>
	<span class="n">srb</span><span class="o">-&gt;</span><span class="n">scsi_done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span> <span class="o">=</span> <span class="n">srb</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">cmnd_ready</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">DEF_SCSI_QCMD</span><span class="p">(</span><span class="n">queuecommand</span><span class="p">)</span>
<span class="cm">/***********************************************************************</span>
<span class="cm"> * Error handling functions</span>
<span class="cm"> ***********************************************************************/</span>
<span class="cm">/* Command timeout and abort */</span>
<span class="kt">int</span> <span class="n">command_abort</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rts51x_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">host_to_rts51x</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">host</span><span class="p">);</span>

	<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* us-&gt;srb together with the TIMED_OUT, RESETTING, and ABORTING</span>
<span class="cm">	 * bits are protected by the host lock. */</span>
	<span class="n">scsi_lock</span><span class="p">(</span><span class="n">rts51x_to_host</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>

	<span class="cm">/* Is this command still active? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">srb</span> <span class="o">!=</span> <span class="n">srb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_unlock</span><span class="p">(</span><span class="n">rts51x_to_host</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
		<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;-- nothing to abort</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">FAILED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the TIMED_OUT bit.  Also set the ABORTING bit, but only if</span>
<span class="cm">	 * a device reset isn&#39;t already in progress (to avoid interfering</span>
<span class="cm">	 * with the reset).  Note that we must retain the host lock while</span>
<span class="cm">	 * calling usb_stor_stop_transport(); otherwise it might interfere</span>
<span class="cm">	 * with an auto-reset that begins as soon as we release the lock. */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLIDX_TIMED_OUT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLIDX_RESETTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLIDX_ABORTING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">dflags</span><span class="p">);</span>
		<span class="cm">/* rts51x_stop_transport(us); */</span>
	<span class="p">}</span>
	<span class="n">scsi_unlock</span><span class="p">(</span><span class="n">rts51x_to_host</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>

	<span class="cm">/* Wait for the aborted command to finish */</span>
	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">notify</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This invokes the transport reset mechanism to reset the state of the</span>
<span class="cm"> * device */</span>
<span class="kt">int</span> <span class="n">device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">FAILED</span> <span class="o">:</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Simulate a SCSI bus reset by resetting the device&#39;s USB port. */</span>
<span class="kt">int</span> <span class="n">bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTS51X_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">FAILED</span> <span class="o">:</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rts5139_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">Scsi_Host</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;SCSI emulation for RTS5139 USB card reader&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">scsi_host_template</span> <span class="n">rts51x_host_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* basic userland interface stuff */</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">RTS51X_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_name</span> <span class="o">=</span> <span class="n">RTS51X_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">proc_info</span> <span class="o">=</span> <span class="n">proc_info</span><span class="p">,</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">rts5139_info</span><span class="p">,</span>

	<span class="cm">/* command interface -- queued only */</span>
	<span class="p">.</span><span class="n">queuecommand</span> <span class="o">=</span> <span class="n">queuecommand</span><span class="p">,</span>

	<span class="cm">/* error and abort handlers */</span>
	<span class="p">.</span><span class="n">eh_abort_handler</span> <span class="o">=</span> <span class="n">command_abort</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_device_reset_handler</span> <span class="o">=</span> <span class="n">device_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">eh_bus_reset_handler</span> <span class="o">=</span> <span class="n">bus_reset</span><span class="p">,</span>

	<span class="cm">/* queue commands only, only one command per LUN */</span>
	<span class="p">.</span><span class="n">can_queue</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cmd_per_lun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* unknown initiator id */</span>
	<span class="p">.</span><span class="n">this_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>

	<span class="p">.</span><span class="n">slave_alloc</span> <span class="o">=</span> <span class="n">slave_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">slave_configure</span> <span class="o">=</span> <span class="n">slave_configure</span><span class="p">,</span>

	<span class="cm">/* lots of sg segments can be handled */</span>
	<span class="p">.</span><span class="n">sg_tablesize</span> <span class="o">=</span> <span class="n">SG_ALL</span><span class="p">,</span>

	<span class="cm">/* limit the total size of a transfer to 120 KB */</span>
	<span class="p">.</span><span class="n">max_sectors</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>

	<span class="cm">/* merge commands... this seems to help performance, but</span>
<span class="cm">	 * periodically someone should test to see which setting is more</span>
<span class="cm">	 * optimal.</span>
<span class="cm">	 */</span>
	<span class="p">.</span><span class="n">use_clustering</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* emulated HBA */</span>
	<span class="p">.</span><span class="n">emulated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* we do our own delay after a device or bus reset */</span>
	<span class="p">.</span><span class="n">skip_settle_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>

	<span class="cm">/* sysfs device attributes */</span>
	<span class="cm">/* .sdev_attrs = sysfs_device_attr_list, */</span>

	<span class="cm">/* module management */</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
