<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › sm7xx › smtcfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>smtcfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Silicon Motion SM7XX frame buffer device</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006 Silicon Motion Technology Corp.</span>
<span class="cm"> * Authors:  Ge Wang, gewang@siliconmotion.com</span>
<span class="cm"> *	     Boyod boyod.yang@siliconmotion.com.cn</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Lemote, Inc.</span>
<span class="cm"> * Author:   Wu Zhangjin, wuzhangjin@gmail.com</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Igalia, S.L.</span>
<span class="cm"> * Author:   Javier M. Mellid &lt;jmunhoz@igalia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License. See the file COPYING in the main directory of this archive for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/console.h&gt;</span>
<span class="cp">#include &lt;linux/screen_info.h&gt;</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;smtcfb.h&quot;</span>

<span class="k">struct</span> <span class="n">screen_info</span> <span class="n">smtc_screen_info</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">* Private structure</span>
<span class="cm">*/</span>
<span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="n">fb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">palette</span><span class="p">[</span><span class="n">NR_RGB</span><span class="p">];</span>
	<span class="n">u_int</span> <span class="n">palette_size</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">chipID</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">m_pMMIO</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">m_pLFB</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">m_pDPR</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">m_pVPR</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">m_pCPR</span><span class="p">;</span>

	<span class="n">u_int</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">u_int</span> <span class="n">hz</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">BaseAddressInVRAM</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">chipRevID</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vesa_mode_table</span>	<span class="p">{</span>
	<span class="kt">char</span> <span class="n">mode_index</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">lfb_width</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lfb_height</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lfb_depth</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vesa_mode_table</span> <span class="n">vesa_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;0x301&quot;</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span>  <span class="mi">480</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;0x303&quot;</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span>  <span class="mi">600</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;0x305&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>  <span class="mi">8</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;0x307&quot;</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">8</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;0x311&quot;</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span>  <span class="mi">480</span><span class="p">,</span>  <span class="mi">16</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;0x314&quot;</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span>  <span class="mi">600</span><span class="p">,</span>  <span class="mi">16</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;0x317&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>  <span class="mi">16</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;0x31A&quot;</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">16</span><span class="p">},</span>

	<span class="p">{</span><span class="s">&quot;0x312&quot;</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span>  <span class="mi">480</span><span class="p">,</span>  <span class="mi">24</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;0x315&quot;</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span>  <span class="mi">600</span><span class="p">,</span>  <span class="mi">24</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;0x318&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">768</span><span class="p">,</span>  <span class="mi">24</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;0x31B&quot;</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">24</span><span class="p">},</span>
<span class="p">};</span>

<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smtc_RegBaseAddress</span><span class="p">;</span>	<span class="cm">/* Memory Map IO starting address */</span>
<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">smtc_VRAMBaseAddress</span><span class="p">;</span>	<span class="cm">/* video memory starting address */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">colreg</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">smtcfb_var</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">xres</span>           <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres</span>           <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xres_virtual</span>   <span class="o">=</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">.</span><span class="n">yres_virtual</span>   <span class="o">=</span> <span class="mi">600</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">red</span>            <span class="o">=</span> <span class="p">{</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">green</span>          <span class="o">=</span> <span class="p">{</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">blue</span>           <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">.</span><span class="n">activate</span>       <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span>         <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span>          <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vmode</span>          <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">smtcfb_fix</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">id</span>             <span class="o">=</span> <span class="s">&quot;sm712fb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">type</span>           <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">visual</span>         <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">,</span>
	<span class="p">.</span><span class="n">line_length</span>    <span class="o">=</span> <span class="mi">800</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">.</span><span class="n">accel</span>          <span class="o">=</span> <span class="n">FB_ACCEL_SMI_LYNX</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm712_set_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">m_nScreenStride</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;sfb-&gt;width=%d sfb-&gt;height=%d &quot;</span>
		<span class="s">&quot;sfb-&gt;fb.var.bits_per_pixel=%d sfb-&gt;hz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">hz</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numVGAModes</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mmSizeX</span> <span class="o">==</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&amp;&amp;</span>
		    <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mmSizeY</span> <span class="o">==</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&amp;&amp;</span>
		    <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bpp</span> <span class="o">==</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&amp;&amp;</span>
		    <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">hz</span> <span class="o">==</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">hz</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;VGAMode[j].mmSizeX=%d VGAMode[j].mmSizeY=%d &quot;</span>
				<span class="s">&quot;VGAMode[j].bpp=%d VGAMode[j].hz=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mmSizeX</span><span class="p">,</span> <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mmSizeY</span><span class="p">,</span>
				<span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">bpp</span><span class="p">,</span> <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">hz</span><span class="p">);</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VGAMode index=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

			<span class="n">smtc_mmiowb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x3c6</span><span class="p">);</span>

			<span class="n">smtc_seqw</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

			<span class="n">smtc_mmiowb</span><span class="p">(</span><span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_MISC</span><span class="p">,</span> <span class="mh">0x3c2</span><span class="p">);</span>

			<span class="cm">/* init SEQ register SR00 - SR04 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_SR00_SR04</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">smtc_seqw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_SR00_SR04</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* init SEQ register SR10 - SR24 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_SR10_SR24</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">smtc_seqw</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">,</span>
					  <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_SR10_SR24</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* init SEQ register SR30 - SR75 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_SR30_SR75</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(((</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x62</span><span class="p">)</span> \
					<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x6a</span><span class="p">)</span> \
					<span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x6b</span><span class="p">))</span>
					<span class="n">smtc_seqw</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">,</span>
						<span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_SR30_SR75</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* init SEQ register SR80 - SR93 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_SR80_SR93</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">smtc_seqw</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">,</span>
					  <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_SR80_SR93</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* init SEQ register SRA0 - SRAF */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_SRA0_SRAF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">smtc_seqw</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0xa0</span><span class="p">,</span>
					  <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_SRA0_SRAF</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* init Graphic register GR00 - GR08 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_GR00_GR08</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">smtc_grphw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_GR00_GR08</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* init Attribute register AR00 - AR14 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_AR00_AR14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">smtc_attrw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_AR00_AR14</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* init CRTC register CR00 - CR18 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_CR00_CR18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">smtc_crtcw</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_CR00_CR18</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* init CRTC register CR30 - CR4D */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_CR30_CR4D</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">smtc_crtcw</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">,</span>
					   <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_CR30_CR4D</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

			<span class="cm">/* init CRTC register CR90 - CRA7 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SIZE_CR90_CRA7</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">smtc_crtcw</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">,</span>
					   <span class="n">VGAMode</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">Init_CR90_CRA7</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">smtc_mmiowb</span><span class="p">(</span><span class="mh">0x67</span><span class="p">,</span> <span class="mh">0x3c2</span><span class="p">);</span>

	<span class="cm">/* set VPR registers */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pVPR</span> <span class="o">+</span> <span class="mh">0x0C</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pVPR</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">);</span>

	<span class="cm">/* set data width */</span>
	<span class="n">m_nScreenStride</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="o">/</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pVPR</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x00020000</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pVPR</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x00040000</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pVPR</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">writel</span><span class="p">(</span><span class="mh">0x00030000</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pVPR</span> <span class="o">+</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(((</span><span class="n">m_nScreenStride</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">m_nScreenStride</span><span class="p">),</span>
	       <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pVPR</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm712_setpalette</span><span class="p">(</span><span class="kt">int</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">BaseAddressInVRAM</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * second display palette for dual head. Enable CRT RAM, 6-bit</span>
<span class="cm">		 * RAM</span>
<span class="cm">		 */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x66</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x66</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* primary display palette. Enable LCD RAM only, 6-bit RAM */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x66</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x66</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC3</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">smtc_mmiowb</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">dac_reg</span><span class="p">);</span>
	<span class="n">smtc_mmiowb</span><span class="p">(</span><span class="n">red</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dac_val</span><span class="p">);</span>
	<span class="n">smtc_mmiowb</span><span class="p">(</span><span class="n">green</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dac_val</span><span class="p">);</span>
	<span class="n">smtc_mmiowb</span><span class="p">(</span><span class="n">blue</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">dac_val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smtc_set_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">chipID</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x710</span>:
	<span class="k">case</span> <span class="mh">0x712</span>:
	<span class="k">case</span> <span class="mh">0x720</span>:
		<span class="n">sm712_set_timing</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* chan_to_field</span>
<span class="cm"> *</span>
<span class="cm"> * convert a colour value into a field position</span>
<span class="cm"> *</span>
<span class="cm"> * from pxafb.c</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">chan_to_field</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chan</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">fb_bitfield</span> <span class="o">*</span><span class="n">bf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chan</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">chan</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span> <span class="o">-</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">chan</span> <span class="o">&lt;&lt;</span> <span class="n">bf</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smtc_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clear DPMS setting */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="cm">/* Screen On: HSync: On, VSync : On */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x20</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x77</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x22</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x30</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xc0</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x24</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x31</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x03</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
		<span class="cm">/* Screen Off: HSync: On, VSync : On   Soft blank */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x20</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x22</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x30</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xc0</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x24</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x31</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x07</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="cm">/* Screen On: HSync: On, VSync : Off */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xB0</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x88</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x22</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x30</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xc0</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x01</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x31</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x07</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x34</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x34</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
		<span class="cm">/* Screen On: HSync: Off, VSync : On */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xB0</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x88</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x22</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x30</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xc0</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0xD8</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x01</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x31</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x07</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x34</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x34</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="cm">/* Screen On: HSync: Off, VSync : Off */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x01</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xB0</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x21</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x88</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x22</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x22</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x30</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x30</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x23</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xc0</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0xD8</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x24</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x01</span><span class="p">)));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x31</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mh">0x07</span><span class="p">))</span> <span class="o">|</span> <span class="mh">0x00</span><span class="p">));</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x34</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x34</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smtc_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">trans</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_VISUAL_DIRECTCOLOR</span>:
	<span class="k">case</span> <span class="n">FB_VISUAL_TRUECOLOR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * 16/32 bit true-colour, use pseuo-palette for 16 base color</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> \
						<span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
				<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xe000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0x1c00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
<span class="cp">#else</span>
				<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">pal</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">red</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">green</span><span class="p">,</span> \
						<span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">);</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">chan_to_field</span><span class="p">(</span><span class="n">blue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
				<span class="n">val</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff00ff00</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x00ff00ff</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="cp">#endif</span>
				<span class="n">pal</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span>:
		<span class="cm">/* color depth 8 bit */</span>
		<span class="n">sm712_setpalette</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="n">red</span><span class="p">,</span> <span class="n">green</span><span class="p">,</span> <span class="n">blue</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* unknown type */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">smtcfb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span>
				<span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>

	<span class="n">u32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;=</span> <span class="n">total_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">total_size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="n">fb_readl</span><span class="p">(</span><span class="n">src</span><span class="o">++</span><span class="p">);</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">=</span>
			    <span class="p">(</span><span class="o">*</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="mh">0xff00ff00</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			    <span class="p">(</span><span class="o">*</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="mh">0x00ff00ff</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">dst8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">src8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">src</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">dst8</span><span class="o">++</span> <span class="o">=</span> <span class="n">fb_readb</span><span class="p">(</span><span class="o">++</span><span class="n">src8</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="o">*</span><span class="n">dst8</span><span class="o">++</span> <span class="o">=</span> <span class="n">fb_readb</span><span class="p">(</span><span class="o">--</span><span class="n">src8</span><span class="p">);</span>
					<span class="n">src8</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">src</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">src8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">smtcfb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
	     <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>

	<span class="n">u32</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span> <span class="o">||</span> <span class="o">!</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>

		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">?</span> <span class="n">PAGE_SIZE</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
			<span class="n">fb_writel</span><span class="p">((</span><span class="o">*</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0xff00ff00</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="o">*</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x00ff00ff</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="n">dst</span><span class="o">++</span><span class="p">);</span>
			<span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">src8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">src</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">dst8</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">fb_writeb</span><span class="p">(</span><span class="o">*</span><span class="n">src8</span><span class="o">++</span><span class="p">,</span> <span class="o">++</span><span class="n">dst8</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">fb_writeb</span><span class="p">(</span><span class="o">*</span><span class="n">src8</span><span class="o">++</span><span class="p">,</span> <span class="o">--</span><span class="n">dst8</span><span class="p">);</span>
					<span class="n">dst8</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="n">dst8</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">cnt</span> <span class="o">+=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">-=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">cnt</span><span class="p">)</span> <span class="o">?</span> <span class="n">cnt</span> <span class="o">:</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* ! __BIG_ENDIAN */</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">smtcfb_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
	<span class="nl">default:</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">visual</span> <span class="o">=</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">hz</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">smtc_set_timing</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smtc_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* sanity checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="cm">/* set valid default bpp */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span>  <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smtc_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="p">;</span>

	<span class="n">smtcfb_setmode</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">smtcfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>        <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span> <span class="o">=</span> <span class="n">smtc_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>   <span class="o">=</span> <span class="n">smtc_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span> <span class="o">=</span> <span class="n">smtc_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>     <span class="o">=</span> <span class="n">smtc_blank</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>  <span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span> <span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>  <span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="p">.</span><span class="n">fb_read</span>      <span class="o">=</span> <span class="n">smtcfb_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_write</span>     <span class="o">=</span> <span class="n">smtcfb_write</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Alloc struct smtcfb_info and assign the default value</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="nf">smtc_alloc_fb_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">;</span>

	<span class="n">sfb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sfb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/*** Init sfb-&gt;fb with default value ***/</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smtcfb_ops</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">smtcfb_var</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span> <span class="o">=</span> <span class="n">smtcfb_fix</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">type_aux</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_SMI_LYNX</span><span class="p">;</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">FB_ACTIVATE_NOW</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* text mode acceleration */</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCELF_TEXT</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">vmode</span> <span class="o">=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">;</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">sfb</span><span class="p">;</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">pseudo_palette</span> <span class="o">=</span> <span class="n">colreg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sfb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unmap in the memory mapped IO registers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smtc_unmap_mmio</span><span class="p">(</span><span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span> <span class="o">&amp;&amp;</span> <span class="n">smtc_RegBaseAddress</span><span class="p">)</span>
		<span class="n">smtc_RegBaseAddress</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Map in the screen memory</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smtc_map_smem</span><span class="p">(</span><span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">smem_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">+</span> <span class="mh">0x800000</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">smem_len</span><span class="p">;</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">=</span> <span class="n">smtc_VRAMBaseAddress</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: unable to map screen memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unmap in the screen memory</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smtc_unmap_smem</span><span class="p">(</span><span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span> <span class="o">&amp;&amp;</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">screen_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">screen_base</span><span class="p">);</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We need to wake up the LynxEM+, and make sure its in linear memory mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sm7xx_init_hw</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x3c4</span><span class="p">);</span>
	<span class="n">outb_p</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x3c5</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smtc_free_fb_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	sm712vga_setup - process command line options, get vga parameter</span>
<span class="cm"> *	@options: string of options</span>
<span class="cm"> *	Returns zero.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sm712vga_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">options</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span> <span class="o">||</span> <span class="o">!*</span><span class="n">options</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sm712vga_setup = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">options</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">index</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vesa_mode</span><span class="p">);</span>
	     <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">vesa_mode</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">mode_index</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_width</span> <span class="o">=</span> <span class="n">vesa_mode</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">lfb_width</span><span class="p">;</span>
			<span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_height</span> <span class="o">=</span>
					<span class="n">vesa_mode</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">lfb_height</span><span class="p">;</span>
			<span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_depth</span> <span class="o">=</span> <span class="n">vesa_mode</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">lfb_depth</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;vga=&quot;</span><span class="p">,</span> <span class="n">sm712vga_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">smtcfb_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">;</span>
	<span class="n">u_long</span> <span class="n">smem_size</span> <span class="o">=</span> <span class="mh">0x00800000</span><span class="p">;</span>	<span class="cm">/* default 8MB */</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pFramebufferPhysical</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Silicon Motion display driver.&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>	<span class="cm">/* enable SMTC chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sfb</span> <span class="o">=</span> <span class="n">smtc_alloc_fb_info</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sfb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed_free</span><span class="p">;</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">chipID</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;sm%Xfb&quot;</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">chipID</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sfb</span><span class="p">);</span>

	<span class="n">sm7xx_init_hw</span><span class="p">();</span>

	<span class="cm">/*get mode parameter from smtc_screen_info */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_width</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_width</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_height</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_depth</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* default resolution 1024x600 16bit mode */</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">SCREEN_X_RES</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">SCREEN_Y_RES</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">SCREEN_BPP</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef __BIG_ENDIAN</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="p">(</span><span class="n">smtc_screen_info</span><span class="p">.</span><span class="n">lfb_depth</span> <span class="o">=</span> <span class="mi">32</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Map address and memory detection */</span>
	<span class="n">pFramebufferPhysical</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_REVISION_ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">chipRevID</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">chipID</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x710</span>:
	<span class="k">case</span> <span class="mh">0x712</span>:
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pFramebufferPhysical</span> <span class="o">+</span> <span class="mh">0x00400000</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="mh">0x00400000</span><span class="p">;</span>
		<span class="n">smem_size</span> <span class="o">=</span> <span class="n">SM712_VIDEOMEMORYSIZE</span><span class="p">;</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pLFB</span> <span class="o">=</span> <span class="p">(</span><span class="n">smtc_VRAMBaseAddress</span> <span class="o">=</span>
		    <span class="n">ioremap</span><span class="p">(</span><span class="n">pFramebufferPhysical</span><span class="p">,</span> <span class="mh">0x00c00000</span><span class="p">));</span>
<span class="cp">#else</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pLFB</span> <span class="o">=</span> <span class="p">(</span><span class="n">smtc_VRAMBaseAddress</span> <span class="o">=</span>
		    <span class="n">ioremap</span><span class="p">(</span><span class="n">pFramebufferPhysical</span><span class="p">,</span> <span class="mh">0x00800000</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pMMIO</span> <span class="o">=</span> <span class="p">(</span><span class="n">smtc_RegBaseAddress</span> <span class="o">=</span>
		    <span class="n">smtc_VRAMBaseAddress</span> <span class="o">+</span> <span class="mh">0x00700000</span><span class="p">);</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pDPR</span> <span class="o">=</span> <span class="n">smtc_VRAMBaseAddress</span> <span class="o">+</span> <span class="mh">0x00408000</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pVPR</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pLFB</span> <span class="o">+</span> <span class="mh">0x0040c000</span><span class="p">;</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smtc_VRAMBaseAddress</span> <span class="o">+=</span> <span class="mh">0x800000</span><span class="p">;</span>
			<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pLFB</span> <span class="o">+=</span> <span class="mh">0x800000</span><span class="p">;</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;smtc_VRAMBaseAddress=%p sfb-&gt;m_pLFB=%p&quot;</span><span class="p">,</span>
				  <span class="n">smtc_VRAMBaseAddress</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pLFB</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smtc_RegBaseAddress</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: unable to map memory mapped IO!&quot;</span><span class="p">,</span>
				<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">failed_fb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set MCLK = 14.31818 * (0x16 / 0x2) */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">);</span>
		<span class="cm">/* enable PCI burst */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="cm">/* enable word swap */</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x720</span>:
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pFramebufferPhysical</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">fix</span><span class="p">.</span><span class="n">mmio_len</span> <span class="o">=</span> <span class="mh">0x00200000</span><span class="p">;</span>
		<span class="n">smem_size</span> <span class="o">=</span> <span class="n">SM722_VIDEOMEMORYSIZE</span><span class="p">;</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pDPR</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pFramebufferPhysical</span><span class="p">,</span> <span class="mh">0x00a00000</span><span class="p">);</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pLFB</span> <span class="o">=</span> <span class="p">(</span><span class="n">smtc_VRAMBaseAddress</span> <span class="o">=</span>
		    <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pDPR</span> <span class="o">+</span> <span class="mh">0x00200000</span><span class="p">);</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pMMIO</span> <span class="o">=</span> <span class="p">(</span><span class="n">smtc_RegBaseAddress</span> <span class="o">=</span>
		    <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pDPR</span> <span class="o">+</span> <span class="mh">0x000c0000</span><span class="p">);</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pVPR</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">m_pDPR</span> <span class="o">+</span> <span class="mh">0x800</span><span class="p">;</span>

		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;No valid Silicon Motion display chip was detected!&quot;</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">failed_fb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* can support 32 bpp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">15</span> <span class="o">==</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">)</span>
		<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">smtc_map_smem</span><span class="p">(</span><span class="n">sfb</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">smem_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">smtcfb_setmode</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
	<span class="cm">/* Primary display starting from 0 position */</span>
	<span class="n">sfb</span><span class="o">-&gt;</span><span class="n">BaseAddressInVRAM</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;Silicon Motion SM%X Rev%X primary display mode %dx%d-%d Init Complete.&quot;</span><span class="p">,</span>
		 <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">chipID</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">chipRevID</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span><span class="p">,</span>
		 <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span><span class="p">,</span> <span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Silicon Motion, Inc. primary display init fail.&quot;</span><span class="p">);</span>

	<span class="n">smtc_unmap_smem</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
	<span class="n">smtc_unmap_mmio</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
<span class="nl">failed_fb:</span>
	<span class="n">smtc_free_fb_info</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>

<span class="nl">failed_free:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">smtcfb_pci_table</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x126f</span><span class="p">,</span> <span class="mh">0x710</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x126f</span><span class="p">,</span> <span class="mh">0x712</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="mh">0x126f</span><span class="p">,</span> <span class="mh">0x720</span><span class="p">),</span> <span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">smtcfb_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">;</span>

	<span class="n">sfb</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">smtc_unmap_smem</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
	<span class="n">smtc_unmap_mmio</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
	<span class="n">unregister_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">);</span>
	<span class="n">smtc_free_fb_info</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smtcfb_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">;</span>

	<span class="n">sfb</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* set the hw in sleep mode use externel clock and self memory refresh</span>
<span class="cm">	 * so that we can turn off internal PLLs later on</span>
<span class="cm">	 */</span>
	<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x20</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xc0</span><span class="p">));</span>
	<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x69</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x69</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf7</span><span class="p">));</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="cm">/* additionally turn off all function blocks including internal PLLs */</span>
	<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smtcfb_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_pci_dev</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smtcfb_info</span> <span class="o">*</span><span class="n">sfb</span><span class="p">;</span>

	<span class="n">sfb</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* reinit hardware */</span>
	<span class="n">sm7xx_init_hw</span><span class="p">();</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">chipID</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x710</span>:
	<span class="k">case</span> <span class="mh">0x712</span>:
		<span class="cm">/* set MCLK = 14.31818 *  (0x16 / 0x2) */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">);</span>
		<span class="cm">/* enable PCI burst */</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x17</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x720</span>:
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x62</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6a</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">);</span>
		<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x34</span><span class="p">,</span> <span class="p">(</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x34</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xc0</span><span class="p">));</span>
	<span class="n">smtc_seqw</span><span class="p">(</span><span class="mh">0x33</span><span class="p">,</span> <span class="p">((</span><span class="n">smtc_seqr</span><span class="p">(</span><span class="mh">0x33</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfb</span><span class="p">));</span>

	<span class="n">smtcfb_setmode</span><span class="p">(</span><span class="n">sfb</span><span class="p">);</span>

	<span class="n">console_lock</span><span class="p">();</span>
	<span class="n">fb_set_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sfb</span><span class="o">-&gt;</span><span class="n">fb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">console_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">sm7xx_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">smtcfb_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">smtcfb_pci_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">freeze</span> <span class="o">=</span> <span class="n">smtcfb_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">thaw</span> <span class="o">=</span> <span class="n">smtcfb_pci_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poweroff</span> <span class="o">=</span> <span class="n">smtcfb_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restore</span> <span class="o">=</span> <span class="n">smtcfb_pci_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define SM7XX_PM_OPS (&amp;sm7xx_pm_ops)</span>

<span class="cp">#else  </span><span class="cm">/* !CONFIG_PM */</span><span class="cp"></span>

<span class="cp">#define SM7XX_PM_OPS NULL</span>

<span class="cp">#endif </span><span class="cm">/* !CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">smtcfb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;smtcfb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">smtcfb_pci_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">smtcfb_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">smtcfb_pci_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span>  <span class="o">=</span> <span class="n">SM7XX_PM_OPS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">smtcfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smtcfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">smtcfb_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smtcfb_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">smtcfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">smtcfb_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Siliconmotion &quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Framebuffer driver for SMI Graphic Cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
