<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › slicoss › slicoss.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>slicoss.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright  2000-2006 Alacritech, Inc.  All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above</span>
<span class="cm"> *    copyright notice, this list of conditions and the following</span>
<span class="cm"> *    disclaimer in the documentation and/or other materials provided</span>
<span class="cm"> *    with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, this software may be distributed under the terms of the</span>
<span class="cm"> * GNU General Public License (&quot;GPL&quot;) version 2 as published by the Free</span>
<span class="cm"> * Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY ALACRITECH, INC. ``AS IS&#39;&#39; AND ANY</span>
<span class="cm"> * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<span class="cm"> * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL ALACRITECH, INC. OR</span>
<span class="cm"> * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF</span>
<span class="cm"> * USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND</span>
<span class="cm"> * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,</span>
<span class="cm"> * OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT</span>
<span class="cm"> * OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="cm"> * SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> * The views and conclusions contained in the software and documentation</span>
<span class="cm"> * are those of the authors and should not be interpreted as representing</span>
<span class="cm"> * official policies, either expressed or implied, of Alacritech, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> **************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * FILENAME: slicoss.c</span>
<span class="cm"> *</span>
<span class="cm"> * The SLICOSS driver for Alacritech&#39;s IS-NIC products.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is supposed to support:</span>
<span class="cm"> *</span>
<span class="cm"> *      Mojave cards (single port PCI Gigabit) both copper and fiber</span>
<span class="cm"> *      Oasis cards (single and dual port PCI-x Gigabit) copper and fiber</span>
<span class="cm"> *      Kalahari cards (dual and quad port PCI-e Gigabit) copper and fiber</span>
<span class="cm"> *</span>
<span class="cm"> * The driver was acutally tested on Oasis and Kalahari cards.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: This is the standard, non-accelerated version of Alacritech&#39;s</span>
<span class="cm"> *       IS-NIC driver.</span>
<span class="cm"> */</span>


<span class="cp">#define KLUDGE_FOR_4GB_BOUNDARY         1</span>
<span class="cp">#define DEBUG_MICROCODE                 1</span>
<span class="cp">#define DBG                             1</span>
<span class="cp">#define SLIC_INTERRUPT_PROCESS_LIMIT	1</span>
<span class="cp">#define SLIC_OFFLOAD_IP_CHECKSUM		1</span>
<span class="cp">#define STATS_TIMER_INTERVAL			2</span>
<span class="cp">#define PING_TIMER_INTERVAL			    1</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/if_vlan.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &quot;slichw.h&quot;</span>
<span class="cp">#include &quot;slic.h&quot;</span>

<span class="k">static</span> <span class="n">uint</span> <span class="n">slic_first_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slic_banner</span> <span class="o">=</span> <span class="s">&quot;Alacritech SLIC Technology(tm) Server &quot;</span>\
		<span class="s">&quot;and Storage Accelerator (Non-Accelerated)&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slic_proc_version</span> <span class="o">=</span> <span class="s">&quot;2.0.351  2006/07/14 12:26:00&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slic_product_name</span> <span class="o">=</span> <span class="s">&quot;SLIC Technology(tm) Server &quot;</span>\
		<span class="s">&quot;and Storage Accelerator (Non-Accelerated)&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">slic_vendor</span> <span class="o">=</span> <span class="s">&quot;Alacritech, Inc.&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">slic_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">head_netdevice</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">base_driver</span> <span class="n">slic_global</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{},</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">intagg_delay</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">dynamic_intagg</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rcv_count</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">slic_debugfs</span><span class="p">;</span>

<span class="cp">#define DRV_NAME          &quot;slicoss&quot;</span>
<span class="cp">#define DRV_VERSION       &quot;2.0.1&quot;</span>
<span class="cp">#define DRV_AUTHOR        &quot;Alacritech, Inc. Engineering&quot;</span>
<span class="cp">#define DRV_DESCRIPTION   &quot;Alacritech SLIC Techonology(tm) &quot;\</span>
<span class="cp">		&quot;Non-Accelerated Driver&quot;</span>
<span class="cp">#define DRV_COPYRIGHT     &quot;Copyright  2000-2006 Alacritech, Inc. &quot;\</span>
<span class="cp">		&quot;All rights reserved.&quot;</span>
<span class="cp">#define PFX		   DRV_NAME &quot; &quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">dynamic_intagg</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dynamic_intagg</span><span class="p">,</span> <span class="s">&quot;Dynamic Interrupt Aggregation Setting&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">intagg_delay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">intagg_delay</span><span class="p">,</span> <span class="s">&quot;uSec Interrupt Aggregation Delay&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">slic_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ALACRITECH</span><span class="p">,</span> <span class="n">SLIC_1GB_DEVICE_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_ALACRITECH</span><span class="p">,</span> <span class="n">SLIC_2GB_DEVICE_ID</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">slic_pci_tbl</span><span class="p">);</span>

<span class="cp">#ifdef ASSERT</span>
<span class="cp">#undef ASSERT</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_assert_fail</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cpuid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">curr_pid</span><span class="p">;</span>
	<span class="n">cpuid</span> <span class="o">=</span> <span class="n">smp_processor_id</span><span class="p">();</span>
	<span class="n">curr_pid</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s CPU # %d ---- PID # %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">__func__</span><span class="p">,</span> <span class="n">cpuid</span><span class="p">,</span> <span class="n">curr_pid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef ASSERT</span>
<span class="cp">#define ASSERT(a) do {							\</span>
<span class="cp">	if (!(a)) {							\</span>
<span class="cp">		printk(KERN_ERR &quot;slicoss ASSERT() Failure: function %s&quot;	\</span>
<span class="cp">			&quot;line %d\n&quot;, __func__, __LINE__);		\</span>
<span class="cp">		slic_assert_fail();					\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>
<span class="cp">#endif</span>


<span class="cp">#define SLIC_GET_SLIC_HANDLE(_adapter, _pslic_handle)                   \</span>
<span class="cp">{                                                                       \</span>
<span class="cp">    spin_lock_irqsave(&amp;_adapter-&gt;handle_lock.lock,                      \</span>
<span class="cp">			_adapter-&gt;handle_lock.flags);                   \</span>
<span class="cp">    _pslic_handle  =  _adapter-&gt;pfree_slic_handles;                     \</span>
<span class="cp">    if (_pslic_handle) {                                                \</span>
<span class="cp">	ASSERT(_pslic_handle-&gt;type == SLIC_HANDLE_FREE);                \</span>
<span class="cp">	_adapter-&gt;pfree_slic_handles = _pslic_handle-&gt;next;             \</span>
<span class="cp">    }                                                                   \</span>
<span class="cp">    spin_unlock_irqrestore(&amp;_adapter-&gt;handle_lock.lock,                 \</span>
<span class="cp">			_adapter-&gt;handle_lock.flags);                   \</span>
<span class="cp">}</span>

<span class="cp">#define SLIC_FREE_SLIC_HANDLE(_adapter, _pslic_handle)                  \</span>
<span class="cp">{                                                                       \</span>
<span class="cp">    _pslic_handle-&gt;type = SLIC_HANDLE_FREE;                             \</span>
<span class="cp">    spin_lock_irqsave(&amp;_adapter-&gt;handle_lock.lock,                      \</span>
<span class="cp">			_adapter-&gt;handle_lock.flags);                   \</span>
<span class="cp">    _pslic_handle-&gt;next = _adapter-&gt;pfree_slic_handles;                 \</span>
<span class="cp">    _adapter-&gt;pfree_slic_handles = _pslic_handle;                       \</span>
<span class="cp">    spin_unlock_irqrestore(&amp;_adapter-&gt;handle_lock.lock,                 \</span>
<span class="cp">			_adapter-&gt;handle_lock.flags);                   \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">slic_reg32_write</span><span class="p">(</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">bool</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">mb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">slic_reg64_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">regh</span><span class="p">,</span> <span class="n">u32</span> <span class="n">paddrh</span><span class="p">,</span>
				    <span class="n">bool</span> <span class="n">flush</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paddrh</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curaddrupper</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">curaddrupper</span> <span class="o">=</span> <span class="n">paddrh</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">paddrh</span><span class="p">,</span> <span class="n">regh</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flush</span><span class="p">)</span>
		<span class="n">mb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Functions to obtain the CRC corresponding to the destination mac address.</span>
<span class="cm"> * This is a standard ethernet CRC in that it is a 32-bit, reflected CRC using</span>
<span class="cm"> * the polynomial:</span>
<span class="cm"> *   x^32 + x^26 + x^23 + x^22 + x^16 + x^12 + x^11 + x^10 + x^8 + x^7 + x^5 +</span>
<span class="cm"> *   x^4 + x^2 + x^1.</span>
<span class="cm"> *</span>
<span class="cm"> * After the CRC for the 6 bytes is generated (but before the value is</span>
<span class="cm"> * complemented),</span>
<span class="cm"> * we must then transpose the value and return bits 30-23.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">slic_crc_table</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>	<span class="cm">/* Table of CRCs for all possible byte values */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">slic_crc_init</span><span class="p">;</span>	<span class="cm">/* Is table initialized */</span>

<span class="cm">/*</span>
<span class="cm"> *  Contruct the CRC32 table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_mcast_init_crc32</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">c</span><span class="p">;</span>		<span class="cm">/*  CRC shit reg                 */</span>
	<span class="n">u32</span> <span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/*  Poly X-or pattern            */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>			<span class="cm">/*  counter                      */</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">;</span>			<span class="cm">/*  byte being shifted into crc  */</span>

	<span class="k">static</span> <span class="kt">int</span> <span class="n">p</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">26</span> <span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">e</span> <span class="o">|=</span> <span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">k</span><span class="p">;</span> <span class="n">k</span><span class="o">--</span><span class="p">)</span>
			<span class="n">c</span> <span class="o">=</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">e</span> <span class="o">:</span> <span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">slic_crc_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Return the MAC hast as described above.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="nf">slic_mcast_get_mac_hash</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">macaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">crc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">machash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slic_crc_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slic_mcast_init_crc32</span><span class="p">();</span>
		<span class="n">slic_crc_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="mh">0xFFFFFFFF</span><span class="p">;</span>	<span class="cm">/* Preload shift register, per crc-32 spec */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">macaddr</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">p</span><span class="p">,</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="p">(</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">^</span> <span class="n">slic_crc_table</span><span class="p">[(</span><span class="n">crc</span> <span class="o">^</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">];</span>

	<span class="cm">/* Return bits 1-8, transposed */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">machash</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">crc</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">machash</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_mcast_set_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">crcpoly</span><span class="p">;</span>

	<span class="cm">/* Get the CRC polynomial for the mac address */</span>
	<span class="n">crcpoly</span> <span class="o">=</span> <span class="n">slic_mcast_get_mac_hash</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>

	<span class="cm">/* We only have space on the SLIC for 64 entries.  Lop</span>
<span class="cm">	 * off the top two bits. (2^6 = 64)</span>
<span class="cm">	 */</span>
	<span class="n">crcpoly</span> <span class="o">&amp;=</span> <span class="mh">0x3F</span><span class="p">;</span>

	<span class="cm">/* OR in the new bit into our 64 bit mask. */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcastmask</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">crcpoly</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_mcast_set_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MAC_ALLMCAST</span> <span class="o">|</span> <span class="n">MAC_PROMISC</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Turn on all multicast addresses. We have to do this for</span>
<span class="cm">		 * promiscuous mode as well as ALLMCAST mode.  It saves the</span>
<span class="cm">		 * Microcode from having to keep state about the MAC</span>
<span class="cm">		 * configuration.</span>
<span class="cm">		 */</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_mcastlow</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_mcasthigh</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">,</span>
				 <span class="n">FLUSH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Commit our multicast mast to the SLIC by writing to the</span>
<span class="cm">		 * multicast address mask registers</span>
<span class="cm">		 */</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_mcastlow</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcastmask</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">),</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_mcasthigh</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcastmask</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span><span class="p">),</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_timer_ping</span><span class="p">(</span><span class="n">ulong</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">((</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">PING_TIMER_INTERVAL</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_unmap_mmio_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  slic_link_config</span>
<span class="cm"> *</span>
<span class="cm"> *  Write phy control to configure link duplex/speed</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_link_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">linkspeed</span><span class="p">,</span> <span class="n">u32</span> <span class="n">linkduplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">wphy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">duplex</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_advreg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_gctlreg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ADAPT_UP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">==</span> <span class="n">SLIC_1GB_DEVICE_ID</span><span class="p">)</span>
	       <span class="o">||</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">==</span> <span class="n">SLIC_2GB_DEVICE_ID</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">linkspeed</span> <span class="o">&gt;</span> <span class="n">LINK_1000MB</span><span class="p">)</span>
		<span class="n">linkspeed</span> <span class="o">=</span> <span class="n">LINK_AUTOSPEED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linkduplex</span> <span class="o">&gt;</span> <span class="n">LINK_AUTOD</span><span class="p">)</span>
		<span class="n">linkduplex</span> <span class="o">=</span> <span class="n">LINK_AUTOD</span><span class="p">;</span>

	<span class="n">wphy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wphy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_AUTOSPEED</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_1000MB</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ADAPT_FLAGS_FIBERMEDIA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  We&#39;ve got a fiber gigabit interface, and register</span>
<span class="cm">			 *  4 is different in fiber mode than in copper mode</span>
<span class="cm">			 */</span>

			<span class="cm">/* advertise FD only @1000 Mb */</span>
			<span class="n">phy_advreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIICR_REG_4</span> <span class="o">|</span> <span class="p">(</span><span class="n">PAR_ADV1000XFD</span><span class="p">));</span>
			<span class="cm">/* enable PAUSE frames        */</span>
			<span class="n">phy_advreg</span> <span class="o">|=</span> <span class="n">PAR_ASYMPAUSE_FIBER</span><span class="p">;</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_advreg</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_AUTOSPEED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* reset phy, enable auto-neg  */</span>
				<span class="n">phy_config</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">MIICR_REG_PCR</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">PCR_RESET</span> <span class="o">|</span> <span class="n">PCR_AUTONEG</span> <span class="o">|</span>
				      <span class="n">PCR_AUTONEG_RST</span><span class="p">));</span>
				<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* forced 1000 Mb FD*/</span>
				<span class="cm">/* power down phy to break link</span>
<span class="cm">				   this may not work) */</span>
				<span class="n">phy_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIICR_REG_PCR</span> <span class="o">|</span> <span class="n">PCR_POWERDOWN</span><span class="p">);</span>
				<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
				<span class="cm">/* wait, Marvell says 1 sec,</span>
<span class="cm">				   try to get away with 10 ms  */</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

				<span class="cm">/* disable auto-neg, set speed/duplex,</span>
<span class="cm">				   soft reset phy, powerup */</span>
				<span class="n">phy_config</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">MIICR_REG_PCR</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">PCR_RESET</span> <span class="o">|</span> <span class="n">PCR_SPEED_1000</span> <span class="o">|</span>
				      <span class="n">PCR_DUPLEX_FULL</span><span class="p">));</span>
				<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* copper gigabit */</span>

			<span class="cm">/* Auto-Negotiate or 1000 Mb must be auto negotiated</span>
<span class="cm">			 * We&#39;ve got a copper gigabit interface, and</span>
<span class="cm">			 * register 4 is different in copper mode than</span>
<span class="cm">			 * in fiber mode</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_AUTOSPEED</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* advertise 10/100 Mb modes   */</span>
				<span class="n">phy_advreg</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">MIICR_REG_4</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">PAR_ADV100FD</span> <span class="o">|</span> <span class="n">PAR_ADV100HD</span> <span class="o">|</span> <span class="n">PAR_ADV10FD</span>
				      <span class="o">|</span> <span class="n">PAR_ADV10HD</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* linkspeed == LINK_1000MB -</span>
<span class="cm">			   don&#39;t advertise 10/100 Mb modes  */</span>
				<span class="n">phy_advreg</span> <span class="o">=</span> <span class="n">MIICR_REG_4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* enable PAUSE frames  */</span>
			<span class="n">phy_advreg</span> <span class="o">|=</span> <span class="n">PAR_ASYMPAUSE</span><span class="p">;</span>
			<span class="cm">/* required by the Cicada PHY  */</span>
			<span class="n">phy_advreg</span> <span class="o">|=</span> <span class="n">PAR_802_3</span><span class="p">;</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_advreg</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="cm">/* advertise FD only @1000 Mb  */</span>
			<span class="n">phy_gctlreg</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIICR_REG_9</span> <span class="o">|</span> <span class="p">(</span><span class="n">PGC_ADV1000FD</span><span class="p">));</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_gctlreg</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">subsysid</span> <span class="o">!=</span> <span class="n">SLIC_1GB_CICADA_SUBSYS_ID</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* if a Marvell PHY</span>
<span class="cm">				   enable auto crossover */</span>
				<span class="n">phy_config</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">MIICR_REG_16</span> <span class="o">|</span> <span class="p">(</span><span class="n">MRV_REG16_XOVERON</span><span class="p">));</span>
				<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

				<span class="cm">/* reset phy, enable auto-neg  */</span>
				<span class="n">phy_config</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">MIICR_REG_PCR</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">PCR_RESET</span> <span class="o">|</span> <span class="n">PCR_AUTONEG</span> <span class="o">|</span>
				      <span class="n">PCR_AUTONEG_RST</span><span class="p">));</span>
				<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* it&#39;s a Cicada PHY  */</span>
				<span class="cm">/* enable and restart auto-neg (don&#39;t reset)  */</span>
				<span class="n">phy_config</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">MIICR_REG_PCR</span> <span class="o">|</span>
				     <span class="p">(</span><span class="n">PCR_AUTONEG</span> <span class="o">|</span> <span class="n">PCR_AUTONEG_RST</span><span class="p">));</span>
				<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Forced 10/100  */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_10MB</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">PCR_SPEED_100</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">linkduplex</span> <span class="o">==</span> <span class="n">LINK_HALFD</span><span class="p">)</span>
			<span class="n">duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">duplex</span> <span class="o">=</span> <span class="n">PCR_DUPLEX_FULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">subsysid</span> <span class="o">!=</span> <span class="n">SLIC_1GB_CICADA_SUBSYS_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if a Marvell PHY</span>
<span class="cm">			   disable auto crossover  */</span>
			<span class="n">phy_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIICR_REG_16</span> <span class="o">|</span> <span class="p">(</span><span class="n">MRV_REG16_XOVEROFF</span><span class="p">));</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* power down phy to break link (this may not work)  */</span>
		<span class="n">phy_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIICR_REG_PCR</span> <span class="o">|</span> <span class="p">(</span><span class="n">PCR_POWERDOWN</span> <span class="o">|</span> <span class="n">speed</span> <span class="o">|</span> <span class="n">duplex</span><span class="p">));</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

		<span class="cm">/* wait, Marvell says 1 sec, try to get away with 10 ms */</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">subsysid</span> <span class="o">!=</span> <span class="n">SLIC_1GB_CICADA_SUBSYS_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* if a Marvell PHY</span>
<span class="cm">			   disable auto-neg, set speed,</span>
<span class="cm">			   soft reset phy, powerup */</span>
			<span class="n">phy_config</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">MIICR_REG_PCR</span> <span class="o">|</span> <span class="p">(</span><span class="n">PCR_RESET</span> <span class="o">|</span> <span class="n">speed</span> <span class="o">|</span> <span class="n">duplex</span><span class="p">));</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* it&#39;s a Cicada PHY  */</span>
			<span class="cm">/* disable auto-neg, set speed, powerup  */</span>
			<span class="n">phy_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIICR_REG_PCR</span> <span class="o">|</span> <span class="p">(</span><span class="n">speed</span> <span class="o">|</span> <span class="n">duplex</span><span class="p">));</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_card_download_gbrcv</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">codeaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">instruction</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcvucodelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLIC_2GB_DEVICE_ID</span>:
		<span class="n">file</span> <span class="o">=</span> <span class="s">&quot;slicoss/oasisrcvucode.sys&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_1GB_DEVICE_ID</span>:
		<span class="n">file</span> <span class="o">=</span> <span class="s">&quot;slicoss/gbrcvucode.sys&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;SLICOSS: Failed to load firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rcvucodelen</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLIC_2GB_DEVICE_ID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rcvucodelen</span> <span class="o">!=</span> <span class="n">OasisRcvUCodeLen</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_1GB_DEVICE_ID</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rcvucodelen</span> <span class="o">!=</span> <span class="n">GBRcvUCodeLen</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* start download */</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rcv_wcs</span><span class="p">,</span> <span class="n">SLIC_RCVWCS_BEGIN</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="cm">/* download the rcv sequencer ucode */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">codeaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">codeaddr</span> <span class="o">&lt;</span> <span class="n">rcvucodelen</span><span class="p">;</span> <span class="n">codeaddr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* write out instruction address */</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rcv_wcs</span><span class="p">,</span> <span class="n">codeaddr</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

		<span class="n">instruction</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="cm">/* write out the instruction data low addr */</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rcv_wcs</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

		<span class="n">instruction</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* write out the instruction data high addr */</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rcv_wcs</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">instruction</span><span class="p">,</span>
				 <span class="n">FLUSH</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* download finished */</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rcv_wcs</span><span class="p">,</span> <span class="n">SLIC_RCVWCS_FINISH</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;slicoss/oasisrcvucode.sys&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;slicoss/gbrcvucode.sys&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_card_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">section</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">thissectionsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">codeaddr</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">instruction</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">baseaddress</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">numsects</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sectsize</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">sectstart</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ucode_start</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLIC_2GB_DEVICE_ID</span>:
		<span class="n">file</span> <span class="o">=</span> <span class="s">&quot;slicoss/oasisdownload.sys&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_1GB_DEVICE_ID</span>:
		<span class="n">file</span> <span class="o">=</span> <span class="s">&quot;slicoss/gbdownload.sys&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;SLICOSS: Failed to load firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">numsects</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">numsects</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numsects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sectsize</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">numsects</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sectstart</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ucode_start</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">instruction</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">section</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">section</span> <span class="o">&lt;</span> <span class="n">numsects</span><span class="p">;</span> <span class="n">section</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">baseaddress</span> <span class="o">=</span> <span class="n">sectstart</span><span class="p">[</span><span class="n">section</span><span class="p">];</span>
		<span class="n">thissectionsize</span> <span class="o">=</span> <span class="n">sectsize</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">codeaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">codeaddr</span> <span class="o">&lt;</span> <span class="n">thissectionsize</span><span class="p">;</span> <span class="n">codeaddr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Write out instruction address */</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wcs</span><span class="p">,</span>
					 <span class="n">baseaddress</span> <span class="o">+</span> <span class="n">codeaddr</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="cm">/* Write out instruction to low addr */</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wcs</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="n">instruction</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="cm">/* Write out instruction to high addr */</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wcs</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="n">instruction</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">ucode_start</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">section</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">section</span> <span class="o">&lt;</span> <span class="n">numsects</span><span class="p">;</span> <span class="n">section</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">instruction</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">baseaddress</span> <span class="o">=</span> <span class="n">sectstart</span><span class="p">[</span><span class="n">section</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">baseaddress</span> <span class="o">&lt;</span> <span class="mh">0x8000</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">thissectionsize</span> <span class="o">=</span> <span class="n">sectsize</span><span class="p">[</span><span class="n">section</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">codeaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">codeaddr</span> <span class="o">&lt;</span> <span class="n">thissectionsize</span><span class="p">;</span> <span class="n">codeaddr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Write out instruction address */</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wcs</span><span class="p">,</span>
				<span class="n">SLIC_WCS_COMPARE</span> <span class="o">|</span> <span class="p">(</span><span class="n">baseaddress</span> <span class="o">+</span> <span class="n">codeaddr</span><span class="p">),</span>
				<span class="n">FLUSH</span><span class="p">);</span>
			<span class="cm">/* Write out instruction to low addr */</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wcs</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span>
					 <span class="n">FLUSH</span><span class="p">);</span>
			<span class="n">instruction</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="cm">/* Write out instruction to high addr */</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wcs</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span>
					 <span class="n">FLUSH</span><span class="p">);</span>
			<span class="n">instruction</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">index</span><span class="p">);</span>
			<span class="n">index</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

			<span class="cm">/* Check SRAM location zero. If it is non-zero. Abort.*/</span>
<span class="cm">/*			failure = readl((u32 __iomem *)&amp;slic_regs-&gt;slic_reset);</span>
<span class="cm">			if (failure) {</span>
<span class="cm">				release_firmware(fw);</span>
<span class="cm">				return -EIO;</span>
<span class="cm">			}*/</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="cm">/* Everything OK, kick off the card */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wcs</span><span class="p">,</span> <span class="n">SLIC_WCS_START</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

	<span class="cm">/* stall for 20 ms, long enough for ucode to init card</span>
<span class="cm">	   and reach mainloop */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;slicoss/oasisdownload.sys&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;slicoss/gbdownload.sys&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_adapter_set_hwaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">config_set</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">MacInfo</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">functionnumber</span><span class="p">].</span><span class="n">macaddrA</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_config_mac</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span>
		      <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span>
		      <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">||</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macaddr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">,</span>
			       <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_intagg_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_intagg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadlevel_current</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_soft_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_quiesce</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_reset</span><span class="p">,</span> <span class="n">SLIC_RESET_MAGIC</span><span class="p">,</span>
			 <span class="n">FLUSH</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_mac_address_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value2</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wraddral</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wraddrbl</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

	<span class="n">value2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			     <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wraddrah</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wraddrbh</span><span class="p">,</span> <span class="n">value2</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

	<span class="cm">/* Write our multicast mask out to the card.  This is done */</span>
	<span class="cm">/* here in addition to the slic_mcast_addr_set routine     */</span>
	<span class="cm">/* because ALL_MCAST may have been enabled or disabled     */</span>
	<span class="n">slic_mcast_set_mask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_mac_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>

	<span class="cm">/* Setup GMAC gaps */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_1000MB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">GMCR_GAPBB_1000</span> <span class="o">&lt;&lt;</span> <span class="n">GMCR_GAPBB_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">GMCR_GAPR1_1000</span> <span class="o">&lt;&lt;</span> <span class="n">GMCR_GAPR1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">GMCR_GAPR2_1000</span> <span class="o">&lt;&lt;</span> <span class="n">GMCR_GAPR2_SHIFT</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">GMCR_GAPBB_100</span> <span class="o">&lt;&lt;</span> <span class="n">GMCR_GAPBB_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">GMCR_GAPR1_100</span> <span class="o">&lt;&lt;</span> <span class="n">GMCR_GAPR1_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">GMCR_GAPR2_100</span> <span class="o">&lt;&lt;</span> <span class="n">GMCR_GAPR2_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* enable GMII */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_1000MB</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">GMCR_GBIT</span><span class="p">;</span>

	<span class="cm">/* enable fullduplex */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkduplex</span> <span class="o">==</span> <span class="n">LINK_FULLD</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">&amp;</span> <span class="n">MAC_LOOPBACK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">GMCR_FULLD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write mac config */</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wmcfg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

	<span class="cm">/* setup mac addresses */</span>
	<span class="n">slic_mac_address_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_config_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">bool</span> <span class="n">linkchange</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">RcrReset</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">linkchange</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setup MAC */</span>
		<span class="n">slic_mac_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">RcrReset</span> <span class="o">=</span> <span class="n">GRCR_RESET</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">slic_mac_address_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">RcrReset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkduplex</span> <span class="o">==</span> <span class="n">LINK_FULLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* setup xmtcfg */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">GXCR_RESET</span> <span class="o">|</span>	<span class="cm">/* Always reset     */</span>
			 <span class="n">GXCR_XMTEN</span> <span class="o">|</span>	<span class="cm">/* Enable transmit  */</span>
			 <span class="n">GXCR_PAUSEEN</span><span class="p">);</span>	<span class="cm">/* Enable pause     */</span>

		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wxcfg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

		<span class="cm">/* Setup rcvcfg last */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">RcrReset</span> <span class="o">|</span>	<span class="cm">/* Reset, if linkchange */</span>
			 <span class="n">GRCR_CTLEN</span> <span class="o">|</span>	<span class="cm">/* Enable CTL frames    */</span>
			 <span class="n">GRCR_ADDRAEN</span> <span class="o">|</span>	<span class="cm">/* Address A enable     */</span>
			 <span class="n">GRCR_RCVBAD</span> <span class="o">|</span>	<span class="cm">/* Rcv bad frames       */</span>
			 <span class="p">(</span><span class="n">GRCR_HASHSIZE</span> <span class="o">&lt;&lt;</span> <span class="n">GRCR_HASHSIZE_SHIFT</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* setup xmtcfg */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">GXCR_RESET</span> <span class="o">|</span>	<span class="cm">/* Always reset     */</span>
			 <span class="n">GXCR_XMTEN</span><span class="p">);</span>	<span class="cm">/* Enable transmit  */</span>

		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wxcfg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

		<span class="cm">/* Setup rcvcfg last */</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">RcrReset</span> <span class="o">|</span>	<span class="cm">/* Reset, if linkchange */</span>
			 <span class="n">GRCR_ADDRAEN</span> <span class="o">|</span>	<span class="cm">/* Address A enable     */</span>
			 <span class="n">GRCR_RCVBAD</span> <span class="o">|</span>	<span class="cm">/* Rcv bad frames       */</span>
			 <span class="p">(</span><span class="n">GRCR_HASHSIZE</span> <span class="o">&lt;&lt;</span> <span class="n">GRCR_HASHSIZE_SHIFT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ADAPT_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only enable receive if we are restarting or running */</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">GRCR_RCVEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">&amp;</span> <span class="n">MAC_PROMISC</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">GRCR_RCVALL</span><span class="p">;</span>

	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wrcfg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Turn off RCV and XMT, power down PHY</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_config_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phy_config</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>

	<span class="cm">/* Setup xmtcfg */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">GXCR_RESET</span> <span class="o">|</span>	<span class="cm">/* Always reset */</span>
		 <span class="n">GXCR_PAUSEEN</span><span class="p">);</span>	<span class="cm">/* Enable pause */</span>

	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wxcfg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">GRCR_RESET</span> <span class="o">|</span>	<span class="cm">/* Always reset      */</span>
		 <span class="n">GRCR_CTLEN</span> <span class="o">|</span>	<span class="cm">/* Enable CTL frames */</span>
		 <span class="n">GRCR_ADDRAEN</span> <span class="o">|</span>	<span class="cm">/* Address A enable  */</span>
		 <span class="p">(</span><span class="n">GRCR_HASHSIZE</span> <span class="o">&lt;&lt;</span> <span class="n">GRCR_HASHSIZE_SHIFT</span><span class="p">));</span>

	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wrcfg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

	<span class="cm">/* power down phy */</span>
	<span class="n">phy_config</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIICR_REG_PCR</span> <span class="o">|</span> <span class="p">(</span><span class="n">PCR_POWERDOWN</span><span class="p">));</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_wphy</span><span class="p">,</span> <span class="n">phy_config</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">slic_mac_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ether_header</span> <span class="o">*</span><span class="n">ether_frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dhost4</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ether_frame</span><span class="o">-&gt;</span><span class="n">ether_dhost</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">dhost2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ether_frame</span><span class="o">-&gt;</span><span class="n">ether_dhost</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="n">MAC_PROMISC</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">dhost4</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">dhost2</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="n">MAC_BCAST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_broadcasts</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ether_frame</span><span class="o">-&gt;</span><span class="n">ether_dhost</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="n">MAC_ALLMCAST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_multicasts</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="n">MAC_MCAST</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">mcast_address</span> <span class="o">*</span><span class="n">mcaddr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcastaddrs</span><span class="p">;</span>

			<span class="k">while</span> <span class="p">(</span><span class="n">mcaddr</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">mcaddr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
							<span class="n">ether_frame</span><span class="o">-&gt;</span><span class="n">ether_dhost</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_multicasts</span><span class="o">++</span><span class="p">;</span>
					<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="o">++</span><span class="p">;</span>
					<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mcaddr</span> <span class="o">=</span> <span class="n">mcaddr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opts</span> <span class="o">&amp;</span> <span class="n">MAC_DIRECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_unicasts</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_mac_set_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">currmacaddr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="n">slic_config_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_timer_load_check</span><span class="p">(</span><span class="n">ulong</span> <span class="n">cardaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="p">)</span><span class="n">cardaddr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">intagg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">load</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">intagg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_intagg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ADAPT_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">CARD_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">slic_global</span><span class="p">.</span><span class="n">dynamic_intagg</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">==</span> <span class="n">SLIC_1GB_DEVICE_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_1000MB</span><span class="p">)</span>
				<span class="n">level</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_5</span><span class="p">)</span>
					<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_5</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_4</span><span class="p">)</span>
					<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_4</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_3</span><span class="p">)</span>
					<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_3</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_2</span><span class="p">)</span>
					<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_2</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_1</span><span class="p">)</span>
					<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_1</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadlevel_current</span> <span class="o">!=</span> <span class="n">level</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">loadlevel_current</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
				<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">intagg</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_5</span><span class="p">)</span>
				<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_5</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_4</span><span class="p">)</span>
				<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_4</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_3</span><span class="p">)</span>
				<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_3</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_2</span><span class="p">)</span>
				<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_2</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">SLIC_LOAD_1</span><span class="p">)</span>
				<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">level</span> <span class="o">=</span> <span class="n">SLIC_INTAGG_0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadlevel_current</span> <span class="o">!=</span> <span class="n">level</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">loadlevel_current</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
				<span class="n">slic_reg32_write</span><span class="p">(</span><span class="n">intagg</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">SLIC_LOADTIMER_PERIOD</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_upr_queue_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">upr_request</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">upr_data</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">upr_data_h</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">upr_buffer</span><span class="p">,</span> <span class="n">u32</span> <span class="n">upr_buffer_h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_upr</span> <span class="o">*</span><span class="n">upr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_upr</span> <span class="o">*</span><span class="n">uprqueue</span><span class="p">;</span>

	<span class="n">upr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_upr</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">upr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">upr</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_request</span> <span class="o">=</span> <span class="n">upr_request</span><span class="p">;</span>
	<span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data</span> <span class="o">=</span> <span class="n">upr_data</span><span class="p">;</span>
	<span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_buffer</span> <span class="o">=</span> <span class="n">upr_buffer</span><span class="p">;</span>
	<span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data_h</span> <span class="o">=</span> <span class="n">upr_data_h</span><span class="p">;</span>
	<span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_buffer_h</span> <span class="o">=</span> <span class="n">upr_buffer_h</span><span class="p">;</span>
	<span class="n">upr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uprqueue</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_list</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">uprqueue</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="n">uprqueue</span> <span class="o">=</span> <span class="n">uprqueue</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">uprqueue</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">upr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_list</span> <span class="o">=</span> <span class="n">upr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_upr_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_upr</span> <span class="o">*</span><span class="n">upr</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">    char * ptr1;</span>
<span class="cm">    char * ptr2;</span>
<span class="cm">    uint cmdoffset;</span>
<span class="cm">*/</span>
	<span class="n">upr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_list</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">upr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_busy</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_request</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_STATS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data_h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">,</span> <span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data</span><span class="p">,</span>
					 <span class="n">FLUSH</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_stats64</span><span class="p">,</span>
					 <span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
					 <span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data_h</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLIC_UPR_RLSR</span>:
		<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rlsr</span><span class="p">,</span> <span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span> <span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data_h</span><span class="p">,</span>
				 <span class="n">FLUSH</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SLIC_UPR_RCONFIG</span>:
		<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rconfig</span><span class="p">,</span>
				 <span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
				 <span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_data_h</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_PING</span>:
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_ping</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_upr_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">upr_request</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">upr_data</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">upr_data_h</span><span class="p">,</span>
		     <span class="n">u32</span> <span class="n">upr_buffer</span><span class="p">,</span> <span class="n">u32</span> <span class="n">upr_buffer_h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">slic_upr_queue_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="n">upr_request</span><span class="p">,</span>
					<span class="n">upr_data</span><span class="p">,</span>
					<span class="n">upr_data_h</span><span class="p">,</span> <span class="n">upr_buffer</span><span class="p">,</span> <span class="n">upr_buffer_h</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock_irq</span><span class="p">;</span>

	<span class="n">slic_upr_start</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="nl">err_unlock_irq:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_link_upr_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">linkstatus</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">linkstatus</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">linkup</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">linkspeed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">linkduplex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPCERR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPCBSY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">slic_shmem</span> <span class="o">*</span><span class="n">pshmem</span><span class="p">;</span>

		<span class="n">pshmem</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_shmem</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phys_shmem</span><span class="p">;</span>
<span class="cp">#if BITS_PER_LONG == 64</span>
		<span class="n">slic_upr_queue_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				       <span class="n">SLIC_UPR_RLSR</span><span class="p">,</span>
				       <span class="n">SLIC_GET_ADDR_LOW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">linkstatus</span><span class="p">),</span>
				       <span class="n">SLIC_GET_ADDR_HIGH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">linkstatus</span><span class="p">),</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">slic_upr_queue_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				       <span class="n">SLIC_UPR_RLSR</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">linkstatus</span><span class="p">,</span>
				       <span class="n">SLIC_GET_ADDR_HIGH</span><span class="p">(</span><span class="n">pshmem</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ADAPT_UP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">==</span> <span class="n">SLIC_1GB_DEVICE_ID</span><span class="p">)</span>
	       <span class="o">||</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">==</span> <span class="n">SLIC_2GB_DEVICE_ID</span><span class="p">));</span>

	<span class="n">linkup</span> <span class="o">=</span> <span class="n">linkstatus</span> <span class="o">&amp;</span> <span class="n">GIG_LINKUP</span> <span class="o">?</span> <span class="n">LINK_UP</span> <span class="o">:</span> <span class="n">LINK_DOWN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linkstatus</span> <span class="o">&amp;</span> <span class="n">GIG_SPEED_1000</span><span class="p">)</span>
		<span class="n">linkspeed</span> <span class="o">=</span> <span class="n">LINK_1000MB</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">linkstatus</span> <span class="o">&amp;</span> <span class="n">GIG_SPEED_100</span><span class="p">)</span>
		<span class="n">linkspeed</span> <span class="o">=</span> <span class="n">LINK_100MB</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">linkspeed</span> <span class="o">=</span> <span class="n">LINK_10MB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">linkstatus</span> <span class="o">&amp;</span> <span class="n">GIG_FULLDUPLEX</span><span class="p">)</span>
		<span class="n">linkduplex</span> <span class="o">=</span> <span class="n">LINK_FULLD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">linkduplex</span> <span class="o">=</span> <span class="n">LINK_HALFD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">==</span> <span class="n">LINK_DOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">linkup</span> <span class="o">==</span> <span class="n">LINK_DOWN</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* link up event, but nothing has changed */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">==</span> <span class="n">LINK_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">linkup</span> <span class="o">==</span> <span class="n">LINK_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">linkspeed</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkduplex</span> <span class="o">==</span> <span class="n">linkduplex</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* link has changed at this point */</span>

	<span class="cm">/* link has gone from up to down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">linkup</span> <span class="o">==</span> <span class="n">LINK_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">=</span> <span class="n">LINK_DOWN</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* link has gone from down to up */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">=</span> <span class="n">linkspeed</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkduplex</span> <span class="o">=</span> <span class="n">linkduplex</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">!=</span> <span class="n">LINK_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* setup the mac */</span>
		<span class="n">slic_config_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">=</span> <span class="n">LINK_UP</span><span class="p">;</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_upr_request_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">isr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_upr</span> <span class="o">*</span><span class="n">upr</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">upr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_list</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">upr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_list</span> <span class="o">=</span> <span class="n">upr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">upr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">==</span> <span class="n">upr</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">upr</span><span class="o">-&gt;</span><span class="n">upr_request</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_STATS</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">slic_stats</span> <span class="o">*</span><span class="n">slicstats</span> <span class="o">=</span>
			    <span class="p">(</span><span class="k">struct</span> <span class="n">slic_stats</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">inicstats</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">slic_stats</span> <span class="o">*</span><span class="n">newstats</span> <span class="o">=</span> <span class="n">slicstats</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">slic_stats</span>  <span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">inicstats_prev</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">slicnet_stats</span> <span class="o">*</span><span class="n">stst</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPCERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;SLIC_UPR_STATS command failed isr[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">isr</span><span class="p">);</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">tcp</span><span class="p">.</span><span class="n">xmit_tcp_segs</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">xmit_tcp_segs_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">xmit_tcp_segs_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">tcp</span><span class="p">.</span><span class="n">xmit_tcp_bytes</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">xmit_tcp_bytes_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">xmit_tcp_bytes_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">tcp</span><span class="p">.</span><span class="n">rcv_tcp_segs</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">rcv_tcp_segs_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">rcv_tcp_segs_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">tcp</span><span class="p">.</span><span class="n">rcv_tcp_bytes</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">rcv_tcp_bytes_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">rcv_tcp_bytes_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">.</span><span class="n">xmt_bytes</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">xmit_bytes_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">xmit_bytes_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">.</span><span class="n">xmt_ucast</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">xmit_unicasts_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">xmit_unicasts_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">.</span><span class="n">rcv_bytes</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">rcv_bytes_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">rcv_bytes_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">.</span><span class="n">rcv_ucast</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">rcv_unicasts_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">rcv_unicasts_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">.</span><span class="n">xmt_errors</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">xmit_collisions_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">xmit_collisions_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">.</span><span class="n">xmt_errors</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">xmit_excess_collisions_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">xmit_excess_collisions_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">.</span><span class="n">xmt_errors</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">xmit_other_error_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">xmit_other_error_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">.</span><span class="n">rcv_errors</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">rcv_other_error_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">rcv_other_error_gb</span><span class="p">);</span>

			<span class="n">UPDATE_STATS_GB</span><span class="p">(</span><span class="n">stst</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">.</span><span class="n">rcv_discards</span><span class="p">,</span>
					<span class="n">newstats</span><span class="o">-&gt;</span><span class="n">rcv_drops_gb</span><span class="p">,</span>
					<span class="n">old</span><span class="o">-&gt;</span><span class="n">rcv_drops_gb</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">newstats</span><span class="o">-&gt;</span><span class="n">rcv_drops_gb</span> <span class="o">&gt;</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">rcv_drops_gb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_drops</span> <span class="o">+=</span>
				    <span class="p">(</span><span class="n">newstats</span><span class="o">-&gt;</span><span class="n">rcv_drops_gb</span> <span class="o">-</span>
				     <span class="n">old</span><span class="o">-&gt;</span><span class="n">rcv_drops_gb</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">newstats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_stats</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_RLSR</span>:
		<span class="n">slic_link_upr_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_RCONFIG</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_RPHY</span>:
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_ENLB</span>:
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_ENCT</span>:
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_PDWN</span>:
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_UPR_PING</span>:
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">pingstatus</span> <span class="o">|=</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_PINGDSMASK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">upr</span><span class="p">);</span>
	<span class="n">slic_upr_start</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_config_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">,</span>
							<span class="n">u32</span> <span class="n">config_h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">slic_upr_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				  <span class="n">SLIC_UPR_RCONFIG</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">config_h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  this is here to checksum the eeprom, there is some ucode bug</span>
<span class="cm"> *  which prevens us from using the ucode result.</span>
<span class="cm"> *  remove this once ucode is fixed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">ushort</span> <span class="nf">slic_eeprom_cksum</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define ADDCARRY(x)  (x &gt; 65535 ? x -= 65535 : x)</span>
<span class="cp">#define REDUCE {l_util.l = sum; sum = l_util.s[0] + l_util.s[1]; ADDCARRY(sum);\</span>
<span class="cp">		}</span>

	<span class="n">u16</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">byte_swapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">w_int</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">ushort</span> <span class="n">s</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">s_util</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="n">ushort</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">l_util</span><span class="p">;</span>

	<span class="n">l_util</span><span class="p">.</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s_util</span><span class="p">.</span><span class="n">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">m</span><span class="p">;</span>
<span class="cp">#if BITS_PER_LONG == 64</span>
	<span class="n">w_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((</span><span class="n">ulong</span><span class="p">)</span> <span class="n">w</span> <span class="o">&amp;</span> <span class="mh">0x00000000FFFFFFFF</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">w_int</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">w</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&amp;</span> <span class="n">w_int</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REDUCE</span><span class="p">;</span>
		<span class="n">sum</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">s_util</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span><span class="p">;</span>
		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">w</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
		<span class="n">byte_swapped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Unroll the loop to make overhead from branches &amp;c small. */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="o">-=</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">14</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">15</span><span class="p">];</span>
		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span>	<span class="cm">/* verify */</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">sum</span> <span class="o">+=</span> <span class="n">w</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)((</span><span class="n">ulong</span><span class="p">)</span> <span class="n">w</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>	<span class="cm">/* verify */</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">byte_swapped</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">REDUCE</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sum</span> <span class="o">+=</span> <span class="o">*</span><span class="n">w</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* verify */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">byte_swapped</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">REDUCE</span><span class="p">;</span>
			<span class="n">sum</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">byte_swapped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s_util</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
				<span class="n">sum</span> <span class="o">+=</span> <span class="n">s_util</span><span class="p">.</span><span class="n">s</span><span class="p">;</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">len</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s_util</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">w</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s_util</span><span class="p">.</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sum</span> <span class="o">+=</span> <span class="n">s_util</span><span class="p">.</span><span class="n">s</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">REDUCE</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_rspqueue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_rspqueue</span> <span class="o">*</span><span class="n">rspq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rspqueue</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
					    <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">pageindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_rspqueue_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_rspqueue</span> <span class="o">*</span><span class="n">rspq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rspqueue</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">paddrh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ADAPT_DOWN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">rspq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_rspqueue</span><span class="p">));</span>

	<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">num_pages</span> <span class="o">=</span> <span class="n">SLIC_RSPQ_PAGES_GB</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
						      <span class="n">PAGE_SIZE</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;pci_alloc_consistent failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">slic_rspqueue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* FIXME:</span>
<span class="cm">		 * do we really need this assertions (4K PAGE_SIZE aligned addr)? */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="cp">#ifndef CONFIG_X86_64</span>
<span class="c">		ASSERT(((u32) rspq-&gt;vaddr[i] &amp; 0xFFFFF000) ==</span>
<span class="c">		       (u32) rspq-&gt;vaddr[i]);</span>
<span class="c">		ASSERT(((u32) rspq-&gt;paddr[i] &amp; 0xFFFFF000) ==</span>
<span class="c">		       (u32) rspq-&gt;paddr[i]);</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">paddrh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rbar</span><span class="p">,</span>
				<span class="p">(</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">SLIC_RSPQ_BUFSINPAGE</span><span class="p">),</span>
				<span class="n">DONT_FLUSH</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rbar64</span><span class="p">,</span>
				<span class="p">(</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">SLIC_RSPQ_BUFSINPAGE</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
				<span class="n">paddrh</span><span class="p">,</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">pageindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_rspbuf</span> <span class="o">*</span><span class="p">)</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">slic_rspbuf</span> <span class="o">*</span><span class="nf">slic_rspqueue_getnext</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_rspqueue</span> <span class="o">*</span><span class="n">rspq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rspqueue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_rspbuf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span><span class="p">;</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
	<span class="n">ASSERT</span><span class="p">((</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFE0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">hosthandle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">SLIC_RSPQ_BUFSINPAGE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
		<span class="n">ASSERT</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFE0</span><span class="p">)</span> <span class="o">==</span>
		       <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="n">SLIC_RSPQ_BUFSINPAGE</span><span class="p">);</span>
		<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_rbar64</span><span class="p">,</span>
			<span class="p">(</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">paddr</span><span class="p">[</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">pageindex</span><span class="p">]</span> <span class="o">|</span> <span class="n">SLIC_RSPQ_BUFSINPAGE</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
		<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">pageindex</span> <span class="o">=</span> <span class="p">(</span><span class="o">++</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">pageindex</span><span class="p">)</span> <span class="o">%</span> <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">num_pages</span><span class="p">;</span>
		<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_rspbuf</span> <span class="o">*</span><span class="p">)</span>
						<span class="n">rspq</span><span class="o">-&gt;</span><span class="n">vaddr</span><span class="p">[</span><span class="n">rspq</span><span class="o">-&gt;</span><span class="n">pageindex</span><span class="p">];</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
		<span class="n">ASSERT</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF000</span><span class="p">)</span> <span class="o">==</span>
		       <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rspq</span><span class="o">-&gt;</span><span class="n">rspbuf</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
	<span class="n">ASSERT</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFE0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_cmdqmem_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_cmdqmem</span> <span class="o">*</span><span class="n">cmdqmem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdqmem</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmdqmem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_cmdqmem</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_cmdqmem_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_cmdqmem</span> <span class="o">*</span><span class="n">cmdqmem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdqmem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SLIC_CMDQ_MAXPAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmdqmem</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					    <span class="n">PAGE_SIZE</span><span class="p">,</span>
					    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdqmem</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					    <span class="n">cmdqmem</span><span class="o">-&gt;</span><span class="n">dma_pages</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cmdqmem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_cmdqmem</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="nf">slic_cmdqmem_addpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_cmdqmem</span> <span class="o">*</span><span class="n">cmdqmem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdqmem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pageaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdqmem</span><span class="o">-&gt;</span><span class="n">pagecnt</span> <span class="o">&gt;=</span> <span class="n">SLIC_CMDQ_MAXPAGES</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pageaddr</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					<span class="n">PAGE_SIZE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">cmdqmem</span><span class="o">-&gt;</span><span class="n">dma_pages</span><span class="p">[</span><span class="n">cmdqmem</span><span class="o">-&gt;</span><span class="n">pagecnt</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pageaddr</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
	<span class="n">ASSERT</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">pageaddr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF000</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">pageaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">cmdqmem</span><span class="o">-&gt;</span><span class="n">pages</span><span class="p">[</span><span class="n">cmdqmem</span><span class="o">-&gt;</span><span class="n">pagecnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">pageaddr</span><span class="p">;</span>
	<span class="n">cmdqmem</span><span class="o">-&gt;</span><span class="n">pagecnt</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pageaddr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_cmdq_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tempskb</span><span class="p">;</span>

			<span class="n">tempskb</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tempskb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">tempskb</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">next_all</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_cmdqueue</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_cmdqueue</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_cmdqueue</span><span class="p">));</span>
	<span class="n">slic_cmdqmem_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_cmdq_addcmdpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_cmdqueue</span> <span class="o">*</span><span class="n">cmdq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmdcnt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cmdaddr</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_addrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_addrh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_handle</span> <span class="o">*</span><span class="n">pslic_handle</span><span class="p">;</span>

	<span class="n">cmdaddr</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="p">)</span><span class="n">cmdaddr</span><span class="p">;</span>
	<span class="n">cmdcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">virt_to_bus</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">page</span><span class="p">);</span>
	<span class="n">phys_addrl</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_LOW</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">phys_addrh</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_HIGH</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>

	<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tail</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">cmdcnt</span> <span class="o">&lt;</span> <span class="n">SLIC_CMDQ_CMDSINPAGE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_handle_ix</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Allocate and initialize a SLIC_HANDLE for this command */</span>
		<span class="n">SLIC_GET_SLIC_HANDLE</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pslic_handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pslic_handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">pslic_handle</span> <span class="o">==</span>
		       <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_handles</span><span class="p">[</span><span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span>
					      <span class="n">handle_index</span><span class="p">]);</span>
		<span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SLIC_HANDLE_CMD</span><span class="p">;</span>
		<span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_handle_ix</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">other_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">pslic_handle</span> <span class="o">=</span> <span class="n">pslic_handle</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd64</span><span class="p">.</span><span class="n">hosthandle</span> <span class="o">=</span> <span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">handle_token</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">paddrl</span> <span class="o">=</span> <span class="n">phys_addrl</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">paddrh</span> <span class="o">=</span> <span class="n">phys_addrh</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">next_all</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">phys_addrl</span> <span class="o">+=</span> <span class="n">SLIC_HOSTCMD_SIZE</span><span class="p">;</span>
		<span class="n">cmdaddr</span> <span class="o">+=</span> <span class="n">SLIC_HOSTCMD_SIZE</span><span class="p">;</span>

		<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="p">)</span><span class="n">cmdaddr</span><span class="p">;</span>
		<span class="n">cmdcnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">;</span>
	<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">cmdcnt</span><span class="p">;</span>	<span class="cm">/*  SLIC_CMDQ_CMDSINPAGE;   mooktodo */</span>
	<span class="n">tail</span><span class="o">-&gt;</span><span class="n">next_all</span> <span class="o">=</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
	<span class="n">cmdq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+=</span> <span class="n">cmdcnt</span><span class="p">;</span>	<span class="cm">/*  SLIC_CMDQ_CMDSINPAGE;   mooktodo */</span>
	<span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">prev</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_cmdq_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">pageaddr</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ADAPT_DOWN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_cmdqueue</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_cmdqueue</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_cmdqueue</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">slic_cmdqmem_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_handle_ix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SLIC_CMDQ_INITPAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pageaddr</span> <span class="o">=</span> <span class="n">slic_cmdqmem_addpage</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="cp">#if BITS_PER_LONG == 32</span>
		<span class="n">ASSERT</span><span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">pageaddr</span> <span class="o">&amp;</span> <span class="mh">0xFFFFF000</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">pageaddr</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pageaddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slic_cmdq_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">slic_cmdq_addcmdpage</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pageaddr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_handle_ix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_cmdq_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">hcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">outstanding</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">outstanding</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">.</span><span class="n">count</span> <span class="o">-</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">outstanding</span> <span class="o">-=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">hcmd</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hcmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hcmd</span> <span class="o">=</span> <span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">next_all</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">.</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="n">hcmd</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">.</span><span class="n">head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hcmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">next_all</span><span class="p">;</span>
		<span class="n">hcmd</span> <span class="o">=</span> <span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">next_all</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">count</span> <span class="o">!=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;free_count %d != all count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">count</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_all</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">.</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_cmdq_getdone</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_cmdqueue</span> <span class="o">*</span><span class="n">done_cmdq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_cmdqueue</span> <span class="o">*</span><span class="n">free_cmdq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">free_cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done_cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">done_cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">free_cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">done_cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">free_cmdq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">done_cmdq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">done_cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">done_cmdq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">done_cmdq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">done_cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">done_cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="nf">slic_cmdq_getfree</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_cmdqueue</span> <span class="o">*</span><span class="n">cmdq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_free</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">lock_and_retry:</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<span class="nl">retry:</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">slic_cmdq_getdone</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="o">*</span><span class="n">pageaddr</span><span class="p">;</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
						<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">pageaddr</span> <span class="o">=</span> <span class="n">slic_cmdqmem_addpage</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pageaddr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slic_cmdq_addcmdpage</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">pageaddr</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">lock_and_retry</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_cmdq_putdone_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_cmdqueue</span> <span class="o">*</span><span class="n">cmdq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cmdq_done</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">xmitq_full</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_rcvqueue_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">paddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">paddrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">paddrh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_rcvqueue</span> <span class="o">*</span><span class="n">rcvq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcvqueue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">SLIC_RCVQ_FILLENTRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">slic_rcvbuf</span> <span class="o">*</span><span class="n">rcvbuf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
<span class="cp">#ifdef KLUDGE_FOR_4GB_BOUNDARY</span>
<span class="nl">retry_rcvqfill:</span>
<span class="cp">#endif</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">SLIC_RCVQ_RCVBUFSIZE</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">paddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
							  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
							  <span class="n">SLIC_RCVQ_RCVBUFSIZE</span><span class="p">,</span>
							  <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">paddrl</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_LOW</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
			<span class="n">paddrh</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_HIGH</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>

			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">SLIC_RCVBUF_HEADSIZE</span><span class="p">;</span>
			<span class="n">rcvbuf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_rcvbuf</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
			<span class="n">rcvbuf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#ifdef KLUDGE_FOR_4GB_BOUNDARY</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">paddrl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: LOW 32bits PHYSICAL ADDRESS == 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;skb[%p] PROBLEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         skbdata[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         skblen[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         paddr[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         paddrl[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddrl</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         paddrh[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddrh</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         rcvq-&gt;head[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         rcvq-&gt;tail[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         rcvq-&gt;count[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SKIP THIS SKB!!!!!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">retry_rcvqfill</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">paddrl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: LOW 32bits PHYSICAL ADDRESS == 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;skb[%p] PROBLEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         skbdata[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         skblen[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         paddr[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         paddrl[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddrl</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         paddrh[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddrh</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         rcvq-&gt;head[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         rcvq-&gt;tail[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         rcvq-&gt;count[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GIVE TO CARD ANYWAY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">paddrh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_hbar</span><span class="p">,</span>
						 <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">paddrl</span><span class="p">,</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_hbar64</span><span class="p">,</span>
					<span class="n">paddrl</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
					<span class="n">paddrh</span><span class="p">,</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
				<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;slic_rcvqueue_fill could only get [%d] skbuffs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_rcvqueue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_rcvqueue</span> <span class="o">*</span><span class="n">rcvq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcvqueue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_rcvqueue_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_rcvqueue</span> <span class="o">*</span><span class="n">rcvq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcvqueue</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ADAPT_DOWN</span><span class="p">);</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">SLIC_RCVQ_ENTRIES</span><span class="p">;</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">SLIC_RCVQ_ENTRIES</span> <span class="o">/</span> <span class="n">SLIC_RCVQ_FILLENTRIES</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">+=</span> <span class="n">slic_rcvqueue_fill</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">SLIC_RCVQ_MINENTRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slic_rcvqueue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">slic_rcvqueue_getnext</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_rcvqueue</span> <span class="o">*</span><span class="n">rcvq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcvqueue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_rcvbuf</span> <span class="o">*</span><span class="n">rcvbuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="n">rcvbuf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_rcvbuf</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">rcvbuf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rcvbuf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRHDDR_SVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;RcvQ Empty!! rcvq[%p] count[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">SLIC_RCVQ_FILLTHRESH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">slic_rcvqueue_fill</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">slic_rcvqueue_reinsert</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_rcvqueue</span> <span class="o">*</span><span class="n">rcvq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcvqueue</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">paddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">paddrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">paddrh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_rcvbuf</span> <span class="o">*</span><span class="n">rcvbuf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_rcvbuf</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">SLIC_RCVBUF_HEADSIZE</span><span class="p">);</span>

	<span class="n">paddr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span>
				  <span class="n">SLIC_RCVQ_RCVBUFSIZE</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="n">rcvbuf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">paddrl</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_LOW</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>
	<span class="n">paddrh</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_HIGH</span><span class="p">(</span><span class="n">paddr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">paddrl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: LOW 32bits PHYSICAL ADDRESS == 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;skb[%p] PROBLEM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         skbdata[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         skblen[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         paddr[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddr</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         paddrl[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddrl</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         paddrh[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">paddrh</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         rcvq-&gt;head[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         rcvq-&gt;tail[%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;         rcvq-&gt;count[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">paddrh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_hbar</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">paddrl</span><span class="p">,</span>
				 <span class="n">DONT_FLUSH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_hbar64</span><span class="p">,</span>
				 <span class="n">paddrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
				 <span class="n">paddrh</span><span class="p">,</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
		<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">tail</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_debug_card_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef MOOKTODO</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_config</span> <span class="o">*</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fru</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">atk_fru</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">oemfru</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">OemFru</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;driver_version           : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slic_proc_version</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Microcode versions:           </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;    Gigabit (gb)         : %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">MOJAVE_UCODE_VERS_STRING</span><span class="p">,</span> <span class="n">MOJAVE_UCODE_VERS_DATE</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;    Gigabit Receiver     : %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">GB_RCVUCODE_VERS_STRING</span><span class="p">,</span> <span class="n">GB_RCVUCODE_VERS_DATE</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Vendor                   : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slic_vendor</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Product Name             : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slic_product_name</span><span class="p">);</span>
<span class="cp">#ifdef MOOKTODO</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;VendorId                 : %4.4X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">VendorId</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;DeviceId                 : %4.4X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">DeviceId</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;RevisionId               : %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">RevisionId</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Bus    #                 : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">busnumber</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Device #                 : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">slotnumber</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Interfaces               : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_size</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     Initialized         : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_activated</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     Allocated           : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_allocated</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_size</span> <span class="o">&lt;=</span> <span class="n">SLIC_NBR_MACS</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			   <span class="s">&quot;     MAC%d : %2.2X %2.2X %2.2X %2.2X %2.2X %2.2X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">macinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">macaddrA</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="n">config</span><span class="o">-&gt;</span><span class="n">macinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">macaddrA</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			   <span class="n">config</span><span class="o">-&gt;</span><span class="n">macinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">macaddrA</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			   <span class="n">config</span><span class="o">-&gt;</span><span class="n">macinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">macaddrA</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			   <span class="n">config</span><span class="o">-&gt;</span><span class="n">macinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">macaddrA</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
			   <span class="n">config</span><span class="o">-&gt;</span><span class="n">macinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">macaddrA</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     IF  Init State Duplex/Speed irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;     -------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_allocated</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>

		<span class="n">adapter</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;     %d   %d   %s  %s  %s    0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physport</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
				    <span class="n">SLIC_LINKSTATE</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span><span class="p">),</span>
				    <span class="n">SLIC_DUPLEX</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkduplex</span><span class="p">),</span>
				    <span class="n">SLIC_SPEED</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span><span class="p">),</span>
				    <span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Generation #             : %4.4X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">gennumber</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;RcvQ max entries         : %4.4X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">SLIC_RCVQ_ENTRIES</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Ping Status              : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">pingstatus</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Minimum grant            : %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">MinGrant</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Maximum Latency          : %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">MaxLat</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;PciStatus                : %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">Pcistatus</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Debug Device Id          : %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">DbgDevId</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;DRAM ROM Function        : %4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">DramRomFn</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Network interface Pin 1  : %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">NetIntPin1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Network interface Pin 2  : %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">NetIntPin1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Network interface Pin 3  : %2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">NetIntPin1</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;PM capabilities          : %4.4X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">PMECapab</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;Network Clock Controls   : %4.4X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">config</span><span class="o">-&gt;</span><span class="n">NwClkCtrls</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">FruFormat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATK_FRU_FORMAT</span>:
		<span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			    <span class="s">&quot;Vendor                   : Alacritech, Inc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			    <span class="s">&quot;Assembly #               : %c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">fru</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
				    <span class="n">fru</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;Revision #               : %c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">fru</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">OEMFruFormat</span> <span class="o">==</span> <span class="n">VENDOR4_FRU_FORMAT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
					    <span class="s">&quot;Serial   #               : &quot;</span>
					    <span class="s">&quot;%c%c%c%c%c%c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">fru</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
					    <span class="n">fru</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
					    <span class="n">fru</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span>
					    <span class="n">fru</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
					    <span class="s">&quot;Serial   #               : &quot;</span>
					    <span class="s">&quot;%c%c%c%c%c%c%c%c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">fru</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
					    <span class="n">fru</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
					    <span class="n">fru</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>
					    <span class="n">fru</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span>
					    <span class="n">fru</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="n">fru</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			    <span class="s">&quot;Vendor                   : Alacritech, Inc.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
			    <span class="s">&quot;Serial   #               : Empty FRU</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">OEMFruFormat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VENDOR1_FRU_FORMAT</span>:
		<span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;FRU Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;    Commodity #          : %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Assembly #           : %c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Revision #           : %c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Supplier #           : %c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Date                 : %c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
			<span class="n">seq_sprintf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Sequence #           : %c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">VENDOR2_FRU_FORMAT</span>:
		<span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;FRU Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Part     #           : &quot;</span>
				    <span class="s">&quot;%c%c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Supplier #           : %c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Date                 : %c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
			<span class="n">seq_sprintf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Sequence #           : %c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">VENDOR3_FRU_FORMAT</span>:
		<span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;FRU Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">VENDOR4_FRU_FORMAT</span>:
		<span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;FRU Information:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    FRU Number           : &quot;</span>
				    <span class="s">&quot;%c%c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">seq_sprintf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    Part Number          : &quot;</span>
				    <span class="s">&quot;%c%c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span>
				    <span class="s">&quot;    EC Level             : &quot;</span>
				    <span class="s">&quot;%c%c%c%c%c%c%c%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">17</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">20</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span>
				    <span class="n">oemfru</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">oemfru</span><span class="p">[</span><span class="mi">23</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_debug_adapter_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">seq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">seq</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;info: interface          : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;info: status             : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">SLIC_LINKSTATE</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;info: port               : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physport</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;info: speed              : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">SLIC_SPEED</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;info: duplex             : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">SLIC_DUPLEX</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkduplex</span><span class="p">));</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;info: irq                : 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">uint</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;info: Interrupt Agg Delay: %d usec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadlevel_current</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;info: RcvQ max entries   : %4.4X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">SLIC_RCVQ_ENTRIES</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;info: RcvQ current       : %4.4X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcvqueue</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;rx stats: packets                  : %8.8lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;rx stats: bytes                    : %8.8lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;rx stats: broadcasts               : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_broadcasts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;rx stats: multicasts               : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_multicasts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;rx stats: unicasts                 : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_unicasts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;rx stats: errors                   : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">.</span><span class="n">iface</span><span class="p">.</span><span class="n">rcv_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;rx stats: Missed errors            : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">.</span><span class="n">iface</span><span class="p">.</span><span class="n">rcv_discards</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;rx stats: drops                    : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_drops</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;tx stats: packets                  : %8.8lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;tx stats: bytes                    : %8.8lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;tx stats: errors                   : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">.</span><span class="n">iface</span><span class="p">.</span><span class="n">xmt_errors</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;rx stats: multicasts               : %8.8lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;tx stats: collision errors         : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">.</span><span class="n">iface</span><span class="p">.</span><span class="n">xmit_collisions</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: Max rcv frames/isr           : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_isr_rcvs</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: Rcv interrupt yields         : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_interrupt_yields</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: Max xmit complete/isr        : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_isr_xmits</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: error interrupts             : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">error_interrupts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: error rmiss interrupts       : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">error_rmiss_interrupts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: rcv interrupts               : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_interrupts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: xmit interrupts              : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">xmit_interrupts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: link event interrupts        : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkevent_interrupts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: UPR interrupts               : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_interrupts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: interrupt count              : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_isrs</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: false interrupts             : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">false_interrupts</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: All register writes          : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">all_reg_writes</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: ICR register writes          : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">icr_reg_writes</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;perf: ISR register writes          : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_reg_writes</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: overflow 802 errors      : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">oflow802</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: transport overflow errors: %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Tprtoflow</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: underflow errors         : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">uflow802</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: receive early            : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">rcvearly</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: buffer overflows         : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Bufov</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: carrier errors           : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Carre</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: Long                     : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Longe</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: invalid preambles        : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Invp</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: CRC errors               : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Crc</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: dribble nibbles          : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Drbl</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: Code violations          : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Code</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: TCP checksum errors      : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">TpCsum</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: TCP header short errors  : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">TpHlen</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: IP checksum errors       : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">IpCsum</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: IP frame incompletes     : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">IpLen</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="s">&quot;ifevents: IP headers shorts        : %8.8X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">IpHlen</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_debug_adapter_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">slic_debug_adapter_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_debug_card_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">slic_debug_card_show</span><span class="p">,</span> <span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">slic_debug_adapter_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">slic_debug_adapter_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">slic_debug_card_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">slic_debug_card_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_debug_adapter_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">char</span>    <span class="n">name</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;port%d&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">slic_debug_adapter_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;%s: debugfs create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">debugfs_entry</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_debug_adapter_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">debugfs_entry</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">debugfs_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_debug_card_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">char</span>    <span class="n">name</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;slic%d&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">cardnum</span><span class="p">);</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">slic_debugfs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;%s: debugfs create dir failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;cardinfo&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
				<span class="n">slic_debugfs</span><span class="p">,</span> <span class="n">card</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">slic_debug_card_fops</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">d</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;%s: debugfs create failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_cardinfo</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_debug_card_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>

		<span class="n">adapter</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">)</span>
			<span class="n">slic_debug_adapter_destroy</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_cardinfo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_cardinfo</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_cardinfo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">debugfs_dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_debug_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;slic&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span> <span class="o">||</span> <span class="n">IS_ERR</span><span class="p">(</span><span class="n">ent</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="n">PFX</span> <span class="s">&quot;debugfs create directory failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slic_debugfs</span> <span class="o">=</span> <span class="n">ent</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_debug_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slic_debugfs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">slic_debugfs</span><span class="p">);</span>
		<span class="n">slic_debugfs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * slic_link_event_handler -</span>
<span class="cm"> *</span>
<span class="cm"> * Initiate a link configuration sequence.  The link configuration begins</span>
<span class="cm"> * by issuing a READ_LINK_STATUS command to the Utility Processor on the</span>
<span class="cm"> * SLIC.  Since the command finishes asynchronously, the slic_upr_comlete</span>
<span class="cm"> * routine will follow it up witha UP configuration write command, which</span>
<span class="cm"> * will also complete asynchronously.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_link_event_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_shmem</span> <span class="o">*</span><span class="n">pshmem</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ADAPT_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Adapter is not operational.  Ignore.  */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pshmem</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_shmem</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phys_shmem</span><span class="p">;</span>

<span class="cp">#if BITS_PER_LONG == 64</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">slic_upr_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
				  <span class="n">SLIC_UPR_RLSR</span><span class="p">,</span>
				  <span class="n">SLIC_GET_ADDR_LOW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">linkstatus</span><span class="p">),</span>
				  <span class="n">SLIC_GET_ADDR_HIGH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">linkstatus</span><span class="p">),</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">slic_upr_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">SLIC_UPR_RLSR</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">linkstatus</span><span class="p">,</span>	<span class="cm">/* no 4GB wrap guaranteed */</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_init_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">intrregistered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">intrregistered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_shmem</span><span class="p">),</span>
				    <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phys_shmem</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phys_shmem</span> <span class="o">=</span> <span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimerset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimerset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">slic_rspqueue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">slic_cmdq_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">slic_rcvqueue_free</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Allocate a mcast_address structure to hold the multicast address.</span>
<span class="cm"> *  Link it in.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_mcast_add_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mcast_address</span> <span class="o">*</span><span class="n">mcaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">mlist</span><span class="p">;</span>

	<span class="cm">/* Check to see if it already exists */</span>
	<span class="n">mlist</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcastaddrs</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">compare_ether_addr</span><span class="p">(</span><span class="n">mlist</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">address</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mlist</span> <span class="o">=</span> <span class="n">mlist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Doesn&#39;t already exist.  Allocate a structure to hold it */</span>
	<span class="n">mcaddr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mcast_address</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mcaddr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mcaddr</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">mcaddr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcastaddrs</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcastaddrs</span> <span class="o">=</span> <span class="n">mcaddr</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_mcast_set_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">addresses</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addresses</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">slic_mcast_add_list</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addresses</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">slic_mcast_set_bit</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">addresses</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devflags_prev</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">=</span> <span class="n">MAC_DIRECTED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_BROADCAST</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">|=</span> <span class="n">MAC_BCAST</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">|=</span> <span class="n">MAC_PROMISC</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">|=</span> <span class="n">MAC_ALLMCAST</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_MULTICAST</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">|=</span> <span class="n">MAC_MCAST</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devflags_prev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
		<span class="n">slic_config_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">slic_mcast_set_mask</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define  XMIT_FAIL_LINK_STATE               1</span>
<span class="cp">#define  XMIT_FAIL_ZERO_LENGTH              2</span>
<span class="cp">#define  XMIT_FAIL_HOSTCMD_FAIL             3</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_xmit_build_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">hcmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_host64_cmd</span> <span class="o">*</span><span class="n">ihcmd</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">phys_addr</span><span class="p">;</span>

	<span class="n">ihcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">cmd64</span><span class="p">;</span>

	<span class="n">ihcmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">&lt;&lt;</span> <span class="n">IHFLG_IFSHFT</span><span class="p">);</span>
	<span class="n">ihcmd</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">IHCMD_XMT_REQ</span><span class="p">;</span>
	<span class="n">ihcmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">slic_buffers</span><span class="p">.</span><span class="n">totlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">phys_addr</span> <span class="o">=</span> <span class="n">pci_map_single</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			<span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="n">ihcmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">slic_buffers</span><span class="p">.</span><span class="n">bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">paddrl</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_LOW</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">ihcmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">slic_buffers</span><span class="p">.</span><span class="n">bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">paddrh</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_HIGH</span><span class="p">(</span><span class="n">phys_addr</span><span class="p">);</span>
	<span class="n">ihcmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">slic_buffers</span><span class="p">.</span><span class="n">bufs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="cp">#if BITS_PER_LONG == 64</span>
	<span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">cmdsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">((((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ihcmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">slic_buffers</span><span class="p">.</span><span class="n">bufs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
				     <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">hcmd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">cmdsize</span> <span class="o">=</span> <span class="p">((((</span><span class="n">u32</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ihcmd</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">slic_buffers</span><span class="p">.</span><span class="n">bufs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
			   <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">hcmd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_xmit_fail</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">skbtype</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">xmitq_full</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="n">XMIT_FAIL_HOSTCMD_FAIL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">XMIT_FAIL_LINK_STATE</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;reject xmit skb[%p: %x] linkstate[%s] &quot;</span>
				<span class="s">&quot;adapter[%s:%d] card[%s:%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">,</span>
				<span class="n">SLIC_LINKSTATE</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span><span class="p">),</span>
				<span class="n">SLIC_ADAPTER_STATE</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span>
				<span class="n">SLIC_CARD_STATE</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">),</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XMIT_FAIL_ZERO_LENGTH</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;xmit_start skb-&gt;len == 0 skb[%p] type[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">XMIT_FAIL_HOSTCMD_FAIL</span>:
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;xmit_start skb[%p] type[%x] No host commands &quot;</span>
				<span class="s">&quot;available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_rcv_handle_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">slic_rcvbuf</span> <span class="o">*</span><span class="n">rcvbuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_hddr_wds</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_hddr_wds</span> <span class="o">*</span><span class="p">)</span><span class="n">rcvbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">!=</span> <span class="n">SLIC_1GB_DEVICE_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status14</span> <span class="o">&amp;</span> <span class="n">VRHSTAT_802OE</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">oflow802</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status14</span> <span class="o">&amp;</span> <span class="n">VRHSTAT_TPOFLO</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Tprtoflow</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_802UE</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">uflow802</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_RCVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">rcvearly</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_BUFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Bufov</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_CARRE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Carre</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_LONGE</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Longe</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_PREA</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Invp</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_CRC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Crc</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_DRBL</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Drbl</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_CODE</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Code</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_TPCSUM</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">TpCsum</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_TPHLEN</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">TpHlen</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_IPCSUM</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">IpCsum</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_IPLERR</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">IpLen</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_status_b14</span> <span class="o">&amp;</span> <span class="n">VRHSTATB_IPHERR</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">IpHlen</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_statusGB</span> <span class="o">&amp;</span> <span class="n">VGBSTAT_XPERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">xerr</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_statusGB</span> <span class="o">&gt;&gt;</span> <span class="n">VGBSTAT_XERRSHFT</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">xerr</span> <span class="o">==</span> <span class="n">VGBSTAT_XCSERR</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">TpCsum</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xerr</span> <span class="o">==</span> <span class="n">VGBSTAT_XUFLOW</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Tprtoflow</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">xerr</span> <span class="o">==</span> <span class="n">VGBSTAT_XHLEN</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">TpHlen</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_statusGB</span> <span class="o">&amp;</span> <span class="n">VGBSTAT_NETERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">nerr</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span>
			     <span class="n">frame_statusGB</span> <span class="o">&gt;&gt;</span> <span class="n">VGBSTAT_NERRSHFT</span><span class="p">)</span> <span class="o">&amp;</span>
			    <span class="n">VGBSTAT_NERRMSK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nerr</span> <span class="o">==</span> <span class="n">VGBSTAT_NCSERR</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">IpCsum</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nerr</span> <span class="o">==</span> <span class="n">VGBSTAT_NUFLOW</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">IpLen</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nerr</span> <span class="o">==</span> <span class="n">VGBSTAT_NHLEN</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">IpHlen</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_statusGB</span> <span class="o">&amp;</span> <span class="n">VGBSTAT_LNKERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">lerr</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_statusGB</span> <span class="o">&amp;</span> <span class="n">VGBSTAT_LERRMSK</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lerr</span> <span class="o">==</span> <span class="n">VGBSTAT_LDEARLY</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">rcvearly</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lerr</span> <span class="o">==</span> <span class="n">VGBSTAT_LBOFLO</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Bufov</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lerr</span> <span class="o">==</span> <span class="n">VGBSTAT_LCODERR</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Code</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lerr</span> <span class="o">==</span> <span class="n">VGBSTAT_LDBLNBL</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Drbl</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lerr</span> <span class="o">==</span> <span class="n">VGBSTAT_LCRCERR</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">Crc</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lerr</span> <span class="o">==</span> <span class="n">VGBSTAT_LOFLO</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">oflow802</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lerr</span> <span class="o">==</span> <span class="n">VGBSTAT_LUFLO</span><span class="p">)</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">if_events</span><span class="p">.</span><span class="n">uflow802</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define TCP_OFFLOAD_FRAME_PUSHFLAG  0x10000000</span>
<span class="cp">#define M_FAST_PATH                 0x0040</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_rcv_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_rcvbuf</span> <span class="o">*</span><span class="n">rcvbuf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">slic_rcvqueue_getnext</span><span class="p">(</span><span class="n">adapter</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">rx_bytes</span><span class="p">;</span>

		<span class="n">ASSERT</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">);</span>
		<span class="n">rcvbuf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_rcvbuf</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">events</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcvbuf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">IRHDDR_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">slic_rcv_handle_error</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">rcvbuf</span><span class="p">);</span>
			<span class="n">slic_rcvqueue_reinsert</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slic_mac_filter</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ether_header</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">rcvbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">slic_rcvqueue_reinsert</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">SLIC_RCVBUF_HEADSIZE</span><span class="p">);</span>
		<span class="n">rx_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">rcvbuf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;</span> <span class="n">IRHDDR_FLEN_MSK</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_bytes</span><span class="p">);</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">rx_bytes</span><span class="p">;</span>
<span class="cp">#if SLIC_OFFLOAD_IP_CHECKSUM</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_UNNECESSARY</span><span class="p">;</span>
<span class="cp">#endif</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="o">++</span><span class="n">frames</span><span class="p">;</span>
<span class="cp">#if SLIC_INTERRUPT_PROCESS_LIMIT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frames</span> <span class="o">&gt;=</span> <span class="n">SLIC_RCVQ_MAX_PROCESS_ISR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_interrupt_yields</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_isr_rcvs</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_isr_rcvs</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_xmit_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">hcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_rspbuf</span> <span class="o">*</span><span class="n">rspbuf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_handle_word</span> <span class="n">slic_handle_word</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rspbuf</span> <span class="o">=</span> <span class="n">slic_rspqueue_getnext</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rspbuf</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">xmit_completes</span><span class="o">++</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">events</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 Get the complete host command buffer</span>
<span class="cm">		*/</span>
		<span class="n">slic_handle_word</span><span class="p">.</span><span class="n">handle_token</span> <span class="o">=</span> <span class="n">rspbuf</span><span class="o">-&gt;</span><span class="n">hosthandle</span><span class="p">;</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">slic_handle_word</span><span class="p">.</span><span class="n">handle_index</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">slic_handle_word</span><span class="p">.</span><span class="n">handle_index</span> <span class="o">&lt;=</span> <span class="n">SLIC_CMDQ_MAXCMDS</span><span class="p">);</span>
		<span class="n">hcmd</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_handles</span><span class="p">[</span><span class="n">slic_handle_word</span><span class="p">.</span><span class="n">handle_index</span><span class="p">].</span>
									<span class="n">address</span><span class="p">;</span>
<span class="cm">/*      hcmd = (struct slic_hostcmd *) rspbuf-&gt;hosthandle; */</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">hcmd</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">pslic_handle</span> <span class="o">==</span>
		       <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_handles</span><span class="p">[</span><span class="n">slic_handle_word</span><span class="p">.</span><span class="n">handle_index</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SLIC_CMD_DUMB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">)</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">slic_cmdq_putdone_irq</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">hcmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rspbuf</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rspbuf</span><span class="o">-&gt;</span><span class="n">hosthandle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">frames</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_isr_xmits</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">max_isr_xmits</span><span class="p">,</span> <span class="n">frames</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">slic_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">isr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_icr</span><span class="p">,</span>
				 <span class="n">ICR_INT_MASK</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="n">isr</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isrcopy</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_isrs</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CARD_UP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">ISR_IO</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_ERR</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">error_interrupts</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_RMISS</span><span class="p">)</span> <span class="p">{</span>
						<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
						<span class="kt">int</span> <span class="n">pre_count</span><span class="p">;</span>
						<span class="kt">int</span> <span class="n">errors</span><span class="p">;</span>

						<span class="k">struct</span> <span class="n">slic_rcvqueue</span> <span class="o">*</span><span class="n">rcvq</span> <span class="o">=</span>
						    <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcvqueue</span><span class="p">;</span>

						<span class="n">adapter</span><span class="o">-&gt;</span>
						    <span class="n">error_rmiss_interrupts</span><span class="o">++</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">)</span>
							<span class="n">rcv_count</span> <span class="o">=</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
						<span class="n">pre_count</span> <span class="o">=</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
						<span class="n">errors</span> <span class="o">=</span> <span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">;</span>

						<span class="k">while</span> <span class="p">(</span><span class="n">rcvq</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&lt;</span>
						       <span class="n">SLIC_RCVQ_FILLTHRESH</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">count</span> <span class="o">=</span>
							    <span class="n">slic_rcvqueue_fill</span>
							    <span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
							<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
								<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_XDROP</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="s">&quot;isr &amp; ISR_ERR [%x] &quot;</span>
							<span class="s">&quot;ISR_XDROP </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="s">&quot;isr &amp; ISR_ERR [%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">isr</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_LEVENT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkevent_interrupts</span><span class="o">++</span><span class="p">;</span>
					<span class="n">slic_link_event_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPC</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPCERR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPCBSY</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_interrupts</span><span class="o">++</span><span class="p">;</span>
					<span class="n">slic_upr_request_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_RCV</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_interrupts</span><span class="o">++</span><span class="p">;</span>
				<span class="n">slic_rcv_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_CMD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">xmit_interrupts</span><span class="o">++</span><span class="p">;</span>
				<span class="n">slic_xmit_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CARD_DOWN</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPC</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPCERR</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPCBSY</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_interrupts</span><span class="o">++</span><span class="p">;</span>
				<span class="n">slic_upr_request_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">isr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isrcopy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">all_reg_writes</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isr_reg_writes</span><span class="o">++</span><span class="p">;</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">false_interrupts</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define NORMAL_ETHFRAME     0</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">slic_xmit_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">slic_hostcmd</span> <span class="o">*</span><span class="n">hcmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">skbtype</span> <span class="o">=</span> <span class="n">NORMAL_ETHFRAME</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">offloadcmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">!=</span> <span class="n">LINK_UP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ADAPT_UP</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CARD_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">XMIT_FAIL_LINK_STATE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">xmit_fail</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">XMIT_FAIL_ZERO_LENGTH</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">xmit_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skbtype</span> <span class="o">==</span> <span class="n">NORMAL_ETHFRAME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hcmd</span> <span class="o">=</span> <span class="n">slic_cmdq_getfree</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hcmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">xmitq_full</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">XMIT_FAIL_HOSTCMD_FAIL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">xmit_fail</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">pslic_handle</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">cmd64</span><span class="p">.</span><span class="n">hosthandle</span> <span class="o">==</span>
		       <span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">handle_token</span><span class="p">);</span>
		<span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SLIC_CMD_DUMB</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skbtype</span> <span class="o">==</span> <span class="n">NORMAL_ETHFRAME</span><span class="p">)</span>
			<span class="n">slic_xmit_build_request</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">hcmd</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_DUMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">kill_card</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">slic_host64_cmd</span> <span class="n">ihcmd</span><span class="p">;</span>

		<span class="n">ihcmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">cmd64</span><span class="p">;</span>

		<span class="n">ihcmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">kill_card</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* only do this once */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">paddrh</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_cbar</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">paddrl</span> <span class="o">|</span> <span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">cmdsize</span><span class="p">),</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_cbar64</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">paddrl</span> <span class="o">|</span> <span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">cmdsize</span><span class="p">),</span>
				 <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
				 <span class="n">hcmd</span><span class="o">-&gt;</span><span class="n">paddrh</span><span class="p">,</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">xmit_done:</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="nl">xmit_fail:</span>
	<span class="n">slic_xmit_fail</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">offloadcmd</span><span class="p">,</span> <span class="n">skbtype</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">xmit_done</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_adapter_freeresources</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slic_init_cleanup</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">error_interrupts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_interrupts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">xmit_interrupts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkevent_interrupts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_interrupts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">num_isrs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">xmit_completes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_broadcasts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_multicasts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">rcv_unicasts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_adapter_allocresources</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">intrregistered</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
					<span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">slic_interrupt</span><span class="p">,</span>
				     <span class="n">IRQF_SHARED</span><span class="p">,</span>
				     <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
					<span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;request_irq (%s) FAILED [%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">intrregistered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  slic_if_init</span>
<span class="cm"> *</span>
<span class="cm"> *  Perform initialization of our slic interface.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_if_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_shmem</span> <span class="o">*</span><span class="n">pshmem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* adapter should be down at this point */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ADAPT_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: adapter-&gt;state != ADAPT_DOWN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">==</span> <span class="n">LINK_DOWN</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devflags_prev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">=</span> <span class="n">MAC_DIRECTED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_BROADCAST</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">|=</span> <span class="n">MAC_BCAST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">|=</span> <span class="n">MAC_PROMISC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">|=</span> <span class="n">MAC_ALLMCAST</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_MULTICAST</span><span class="p">)</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">macopts</span> <span class="o">|=</span> <span class="n">MAC_MCAST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">slic_adapter_allocresources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: slic_adapter_allocresources FAILED %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">slic_adapter_freeresources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">queues_initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">slic_rspqueue_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">slic_cmdq_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">slic_rcvqueue_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">queues_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_icr</span><span class="p">,</span> <span class="n">ICR_INT_OFF</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isp_initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pshmem</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_shmem</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phys_shmem</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

<span class="cp">#if BITS_PER_LONG == 64</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
				 <span class="n">SLIC_GET_ADDR_HIGH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">),</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isp</span><span class="p">,</span>
				 <span class="n">SLIC_GET_ADDR_LOW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">),</span> <span class="n">FLUSH</span><span class="p">);</span>
<span class="cp">#else</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isp</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isp_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ADAPT_UP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimerset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimer</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
		    <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">SLIC_LOADTIMER_PERIOD</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">card</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slic_timer_load_check</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimer</span><span class="p">);</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimerset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimerset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimer</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
		    <span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">PING_TIMER_INTERVAL</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">ulong</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slic_timer_ping</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimer</span><span class="p">);</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pingtimerset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pingstatus</span> <span class="o">=</span> <span class="n">ISR_PINGMASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 *    clear any pending events, then enable interrupts</span>
<span class="cm">	 */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">isrcopy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_icr</span><span class="p">,</span> <span class="n">ICR_INT_ON</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

	<span class="n">slic_link_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">LINK_AUTOSPEED</span><span class="p">,</span> <span class="n">LINK_AUTOD</span><span class="p">);</span>
	<span class="n">slic_link_event_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_entry_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
				<span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">activated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_activated</span><span class="o">++</span><span class="p">;</span>
		<span class="n">slic_global</span><span class="p">.</span><span class="n">num_slic_ports_active</span><span class="o">++</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">activated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">slic_if_init</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">activated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_activated</span><span class="o">--</span><span class="p">;</span>
			<span class="n">slic_global</span><span class="p">.</span><span class="n">num_slic_ports_active</span><span class="o">--</span><span class="p">;</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">activated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
						<span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
					<span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">locked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_card_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimerset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimerset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">loadtimer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">slic_debug_card_destroy</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">slic_entry_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mmio_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">mmio_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mcast_address</span> <span class="o">*</span><span class="n">mcaddr</span><span class="p">,</span> <span class="o">*</span><span class="n">mlist</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">slic_adapter_freeresources</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">slic_unmap_mmio_space</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">mmio_len</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
	<span class="cm">/* free multicast addresses */</span>
	<span class="n">mlist</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">mcastaddrs</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mcaddr</span> <span class="o">=</span> <span class="n">mlist</span><span class="p">;</span>
		<span class="n">mlist</span> <span class="o">=</span> <span class="n">mlist</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mcaddr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_allocated</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_allocated</span><span class="o">--</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">curr_card</span> <span class="o">=</span> <span class="n">slic_global</span><span class="p">.</span><span class="n">slic_card</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">curr_card</span> <span class="o">==</span> <span class="n">card</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">slic_global</span><span class="p">.</span><span class="n">slic_card</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">curr_card</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="n">card</span><span class="p">)</span>
				<span class="n">curr_card</span> <span class="o">=</span> <span class="n">curr_card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">ASSERT</span><span class="p">(</span><span class="n">curr_card</span><span class="p">);</span>
			<span class="n">curr_card</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">slic_global</span><span class="p">.</span><span class="n">num_slic_cards</span><span class="p">);</span>
		<span class="n">slic_global</span><span class="p">.</span><span class="n">num_slic_cards</span><span class="o">--</span><span class="p">;</span>
		<span class="n">slic_card_cleanup</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_entry_halt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
				<span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ADAPT_DOWN</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">=</span> <span class="n">LINK_DOWN</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devflags_prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cardindex</span><span class="p">]</span> <span class="o">==</span> <span class="n">adapter</span><span class="p">);</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_icr</span><span class="p">,</span> <span class="n">ICR_INT_OFF</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">all_reg_writes</span><span class="o">++</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">icr_reg_writes</span><span class="o">++</span><span class="p">;</span>
	<span class="n">slic_config_clear</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">activated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_activated</span><span class="o">--</span><span class="p">;</span>
		<span class="n">slic_global</span><span class="p">.</span><span class="n">num_slic_ports_active</span><span class="o">--</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">activated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef AUTOMATIC_RESET</span>
	<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_reset_iface</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Reset the adapter&#39;s cmd queues</span>
<span class="cm">	 */</span>
	<span class="n">slic_cmdq_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

<span class="cp">#ifdef AUTOMATIC_RESET</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_activated</span><span class="p">)</span>
		<span class="n">slic_card_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
				<span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">slic_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">.</span><span class="n">iface</span><span class="p">.</span><span class="n">xmit_collisions</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">.</span><span class="n">iface</span><span class="p">.</span><span class="n">rcv_errors</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">.</span><span class="n">iface</span><span class="p">.</span><span class="n">xmt_errors</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_stats</span><span class="p">.</span><span class="n">iface</span><span class="p">.</span><span class="n">rcv_discards</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">edata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="n">ecmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">intagg</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">rq</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCSLICSETINTAGG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">intagg</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: set interrupt aggregation to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">intagg</span><span class="p">);</span>
		<span class="n">slic_intagg_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">intagg</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SLIC_TRACE_DUMP_ENABLED</span>
	<span class="k">case</span> <span class="n">SIOCSLICTRACEDUMP</span>:
		<span class="p">{</span>
			<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
			<span class="n">DBG_IOCTL</span><span class="p">(</span><span class="s">&quot;slic_ioctl  SIOCSLIC_TRACE_DUMP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="mi">28</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">PRINT_ERROR</span>
				    <span class="p">(</span><span class="s">&quot;slic: copy_from_user FAILED getting initial simba param</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tracemon_request</span> <span class="o">==</span> <span class="n">SLIC_DUMP_DONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PRINT_ERROR</span>
				    <span class="p">(</span><span class="s">&quot;ATK Diagnostic Trace Dump Requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">tracemon_request</span> <span class="o">=</span> <span class="n">SLIC_DUMP_REQUESTED</span><span class="p">;</span>
				<span class="n">tracemon_request_type</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
				<span class="n">tracemon_timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">tracemon_request</span> <span class="o">==</span> <span class="n">SLIC_DUMP_REQUESTED</span><span class="p">)</span> <span class="o">||</span>
				   <span class="p">(</span><span class="n">tracemon_request</span> <span class="o">==</span>
				    <span class="n">SLIC_DUMP_IN_PROGRESS</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">PRINT_ERROR</span>
				    <span class="p">(</span><span class="s">&quot;ATK Diagnostic Trace Dump Requested but already in progress... ignore</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">PRINT_ERROR</span>
				    <span class="p">(</span><span class="s">&quot;ATK Diagnostic Trace Dump Requested</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">tracemon_request</span> <span class="o">=</span> <span class="n">SLIC_DUMP_REQUESTED</span><span class="p">;</span>
				<span class="n">tracemon_request_type</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
				<span class="n">tracemon_timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">case</span> <span class="n">SIOCETHTOOL</span>:
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ecmd</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ecmd</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ETHTOOL_GSET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">edata</span><span class="p">.</span><span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="n">SUPPORTED_10baseT_Half</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_10baseT_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_100baseT_Half</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_100baseT_Full</span> <span class="o">|</span>
					   <span class="n">SUPPORTED_Autoneg</span> <span class="o">|</span> <span class="n">SUPPORTED_MII</span><span class="p">);</span>
			<span class="n">edata</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">PORT_MII</span><span class="p">;</span>
			<span class="n">edata</span><span class="p">.</span><span class="n">transceiver</span> <span class="o">=</span> <span class="n">XCVR_INTERNAL</span><span class="p">;</span>
			<span class="n">edata</span><span class="p">.</span><span class="n">phy_address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_100MB</span><span class="p">)</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_10MB</span><span class="p">)</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkduplex</span> <span class="o">==</span> <span class="n">LINK_FULLD</span><span class="p">)</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

			<span class="n">edata</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
			<span class="n">edata</span><span class="p">.</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">edata</span><span class="p">.</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">edata</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">edata</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ETHTOOL_SSET</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_100MB</span><span class="p">)</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_100</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkspeed</span> <span class="o">==</span> <span class="n">LINK_10MB</span><span class="p">)</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">SPEED_10</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkduplex</span> <span class="o">==</span> <span class="n">LINK_FULLD</span><span class="p">)</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_FULL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">edata</span><span class="p">.</span><span class="n">duplex</span> <span class="o">=</span> <span class="n">DUPLEX_HALF</span><span class="p">;</span>

			<span class="n">edata</span><span class="p">.</span><span class="n">autoneg</span> <span class="o">=</span> <span class="n">AUTONEG_ENABLE</span><span class="p">;</span>
			<span class="n">edata</span><span class="p">.</span><span class="n">maxtxpkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">edata</span><span class="p">.</span><span class="n">maxrxpkt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ecmd</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">edata</span><span class="p">.</span><span class="n">speed</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">ecmd</span><span class="p">.</span><span class="n">duplex</span> <span class="o">!=</span> <span class="n">edata</span><span class="p">.</span><span class="n">duplex</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">speed</span><span class="p">;</span>
				<span class="n">u32</span> <span class="n">duplex</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span><span class="p">)</span>
					<span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">speed</span> <span class="o">=</span> <span class="n">PCR_SPEED_100</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="p">.</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_FULL</span><span class="p">)</span>
					<span class="n">duplex</span> <span class="o">=</span> <span class="n">PCR_DUPLEX_FULL</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">slic_link_config</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">speed</span><span class="p">,</span> <span class="n">duplex</span><span class="p">);</span>
				<span class="n">slic_link_event_handler</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_config_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pci_command</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">new_command</span><span class="p">;</span>

	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_command</span><span class="p">);</span>

	<span class="n">new_command</span> <span class="o">=</span> <span class="n">pci_command</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MASTER</span>
	    <span class="o">|</span> <span class="n">PCI_COMMAND_MEMORY</span>
	    <span class="o">|</span> <span class="n">PCI_COMMAND_INVALIDATE</span>
	    <span class="o">|</span> <span class="n">PCI_COMMAND_PARITY</span> <span class="o">|</span> <span class="n">PCI_COMMAND_SERR</span> <span class="o">|</span> <span class="n">PCI_COMMAND_FAST_BACK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_command</span> <span class="o">!=</span> <span class="n">new_command</span><span class="p">)</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">new_command</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">slic_card_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_eeprom</span> <span class="o">*</span><span class="n">peeprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">oslic_eeprom</span> <span class="o">*</span><span class="n">pOeeprom</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_configh</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phys_configl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_shmem</span> <span class="o">*</span><span class="n">pshmem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">macaddrs</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_size</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">eecodesize</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">dramsize</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">ee_chksum</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">calc_chksum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_config_mac</span> <span class="o">*</span><span class="n">pmac</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fruformat</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">oemfruformat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atk_fru</span> <span class="o">*</span><span class="n">patkfru</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oemfru</span> <span class="o">*</span><span class="n">poemfru</span><span class="p">;</span>

	<span class="cm">/* Reset everything except PCI configuration space */</span>
	<span class="n">slic_soft_reset</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="cm">/* Download the microcode */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">slic_card_download</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;download failed bus %d slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">busnumber</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slotnumber</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">config_set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">peeprom</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_eeprom</span><span class="p">),</span>
					       <span class="o">&amp;</span><span class="n">phys_config</span><span class="p">);</span>

		<span class="n">phys_configl</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_LOW</span><span class="p">(</span><span class="n">phys_config</span><span class="p">);</span>
		<span class="n">phys_configh</span> <span class="o">=</span> <span class="n">SLIC_GET_ADDR_HIGH</span><span class="p">(</span><span class="n">phys_config</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">peeprom</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;eeprom read failed to get memory &quot;</span>
				<span class="s">&quot;bus %d slot %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">busnumber</span><span class="p">,</span>
				<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slotnumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">peeprom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_eeprom</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_icr</span><span class="p">,</span> <span class="n">ICR_INT_OFF</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">pshmem</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_shmem</span> <span class="o">*</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">phys_shmem</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DONT_FLUSH</span><span class="p">);</span>
		<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isp</span><span class="p">,</span>
				 <span class="n">SLIC_GET_ADDR_LOW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">),</span> <span class="n">FLUSH</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">slic_config_get</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">phys_configl</span><span class="p">,</span> <span class="n">phys_configh</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">ISR_UPC</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
					<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isr</span><span class="p">,</span>
							 <span class="mi">0</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>

					<span class="n">slic_upr_request_complete</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="o">-&gt;</span><span class="n">isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">slic_reg32_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isr</span><span class="p">,</span>
							 <span class="mi">0</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
				<span class="n">i</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
						<span class="s">&quot;%d config data fetch timed out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">);</span>
					<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Oasis card */</span>
		<span class="k">case</span> <span class="n">SLIC_2GB_DEVICE_ID</span>:
			<span class="cm">/* extract EEPROM data and pointers to EEPROM data */</span>
			<span class="n">pOeeprom</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">oslic_eeprom</span> <span class="o">*</span><span class="p">)</span> <span class="n">peeprom</span><span class="p">;</span>
			<span class="n">eecodesize</span> <span class="o">=</span> <span class="n">pOeeprom</span><span class="o">-&gt;</span><span class="n">EecodeSize</span><span class="p">;</span>
			<span class="n">dramsize</span> <span class="o">=</span> <span class="n">pOeeprom</span><span class="o">-&gt;</span><span class="n">DramSize</span><span class="p">;</span>
			<span class="n">pmac</span> <span class="o">=</span> <span class="n">pOeeprom</span><span class="o">-&gt;</span><span class="n">MacInfo</span><span class="p">;</span>
			<span class="n">fruformat</span> <span class="o">=</span> <span class="n">pOeeprom</span><span class="o">-&gt;</span><span class="n">FruFormat</span><span class="p">;</span>
			<span class="n">patkfru</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pOeeprom</span><span class="o">-&gt;</span><span class="n">AtkFru</span><span class="p">;</span>
			<span class="n">oemfruformat</span> <span class="o">=</span> <span class="n">pOeeprom</span><span class="o">-&gt;</span><span class="n">OemFruFormat</span><span class="p">;</span>
			<span class="n">poemfru</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pOeeprom</span><span class="o">-&gt;</span><span class="n">OemFru</span><span class="p">;</span>
			<span class="n">macaddrs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="cm">/* Minor kludge for Oasis card</span>
<span class="cm">			     get 2 MAC addresses from the</span>
<span class="cm">			     EEPROM to ensure that function 1</span>
<span class="cm">			     gets the Port 1 MAC address */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* extract EEPROM data and pointers to EEPROM data */</span>
			<span class="n">eecodesize</span> <span class="o">=</span> <span class="n">peeprom</span><span class="o">-&gt;</span><span class="n">EecodeSize</span><span class="p">;</span>
			<span class="n">dramsize</span> <span class="o">=</span> <span class="n">peeprom</span><span class="o">-&gt;</span><span class="n">DramSize</span><span class="p">;</span>
			<span class="n">pmac</span> <span class="o">=</span> <span class="n">peeprom</span><span class="o">-&gt;</span><span class="n">u2</span><span class="p">.</span><span class="n">mac</span><span class="p">.</span><span class="n">MacInfo</span><span class="p">;</span>
			<span class="n">fruformat</span> <span class="o">=</span> <span class="n">peeprom</span><span class="o">-&gt;</span><span class="n">FruFormat</span><span class="p">;</span>
			<span class="n">patkfru</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peeprom</span><span class="o">-&gt;</span><span class="n">AtkFru</span><span class="p">;</span>
			<span class="n">oemfruformat</span> <span class="o">=</span> <span class="n">peeprom</span><span class="o">-&gt;</span><span class="n">OemFruFormat</span><span class="p">;</span>
			<span class="n">poemfru</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">peeprom</span><span class="o">-&gt;</span><span class="n">OemFru</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">EepromValid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="cm">/*  see if the EEPROM is valid by checking it&#39;s checksum */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">eecodesize</span> <span class="o">&lt;=</span> <span class="n">MAX_EECODE_SIZE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">eecodesize</span> <span class="o">&gt;=</span> <span class="n">MIN_EECODE_SIZE</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">ee_chksum</span> <span class="o">=</span>
			    <span class="o">*</span><span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">peeprom</span> <span class="o">+</span> <span class="p">(</span><span class="n">eecodesize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>
			<span class="cm">/*</span>
<span class="cm">			    calculate the EEPROM checksum</span>
<span class="cm">			*/</span>
			<span class="n">calc_chksum</span> <span class="o">=</span>
			    <span class="o">~</span><span class="n">slic_eeprom_cksum</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">peeprom</span><span class="p">,</span>
					       <span class="p">(</span><span class="n">eecodesize</span> <span class="o">-</span> <span class="mi">2</span><span class="p">));</span>
			<span class="cm">/*</span>
<span class="cm">			    if the ucdoe chksum flag bit worked,</span>
<span class="cm">			    we wouldn&#39;t need this shit</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ee_chksum</span> <span class="o">==</span> <span class="n">calc_chksum</span><span class="p">)</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">EepromValid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*  copy in the DRAM size */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">DramSize</span> <span class="o">=</span> <span class="n">dramsize</span><span class="p">;</span>

		<span class="cm">/*  copy in the MAC address(es) */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">macaddrs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">MacInfo</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			       <span class="o">&amp;</span><span class="n">pmac</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_config_mac</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/*  copy the Alacritech FRU information */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">FruFormat</span> <span class="o">=</span> <span class="n">fruformat</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">AtkFru</span><span class="p">,</span> <span class="n">patkfru</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">atk_fru</span><span class="p">));</span>

		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_eeprom</span><span class="p">),</span>
				    <span class="n">peeprom</span><span class="p">,</span> <span class="n">phys_config</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">EepromValid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reg_params</span><span class="p">.</span><span class="n">fail_on_bad_eeprom</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">slic_reg64_write</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">slic_regs</span><span class="o">-&gt;</span><span class="n">slic_addr_upper</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="n">FLUSH</span><span class="p">);</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unsupported CONFIGURATION EEPROM invalid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">config_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slic_card_download_gbrcv</span><span class="p">(</span><span class="n">adapter</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;unable to download GB receive microcode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slic_global</span><span class="p">.</span><span class="n">dynamic_intagg</span><span class="p">)</span>
		<span class="n">slic_intagg_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">slic_intagg_set</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">intagg_delay</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Initialize ping status to &quot;ok&quot;</span>
<span class="cm">	 */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">pingstatus</span> <span class="o">=</span> <span class="n">ISR_PINGMASK</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Lastly, mark our card state as up and return success</span>
<span class="cm">	 */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_UP</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">reset_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_init_driver</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slic_first_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">slic_first_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_global</span><span class="p">.</span><span class="n">driver_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">slic_debug_init</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">slic_init_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_tbl_entry</span><span class="p">,</span>
			      <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">memaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chip_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ushort</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slic_handle</span> <span class="o">*</span><span class="n">pslic_handle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>

<span class="cm">/*	adapter-&gt;pcidev = pcidev;*/</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">vendid</span> <span class="o">=</span> <span class="n">pci_tbl_entry</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span> <span class="o">=</span> <span class="n">pci_tbl_entry</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">subsysid</span> <span class="o">=</span> <span class="n">pci_tbl_entry</span><span class="o">-&gt;</span><span class="n">subdevice</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">busnumber</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slotnumber</span> <span class="o">=</span> <span class="p">((</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">functionnumber</span> <span class="o">=</span> <span class="p">(</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">memorylength</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span> <span class="o">=</span> <span class="p">(</span><span class="n">__iomem</span> <span class="k">struct</span> <span class="n">slic_regs</span> <span class="o">*</span><span class="p">)</span><span class="n">memaddr</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
<span class="cm">/*	adapter-&gt;netdev = netdev;*/</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">next_netdevice</span> <span class="o">=</span> <span class="n">head_netdevice</span><span class="p">;</span>
	<span class="n">head_netdevice</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">chipid</span> <span class="o">=</span> <span class="n">chip_idx</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*adapter-&gt;functionnumber;*/</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">cardindex</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">memorybase</span> <span class="o">=</span> <span class="n">memaddr</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">upr_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">bit64reglock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">adapter_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">reset_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">handle_lock</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	  Initialize slic_handle array</span>
<span class="cm">	*/</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">SLIC_CMDQ_MAXCMDS</span> <span class="o">&lt;=</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 Start with 1.  0 is an invalid host handle.</span>
<span class="cm">	*/</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">pslic_handle</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_handles</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	     <span class="n">index</span> <span class="o">&lt;</span> <span class="n">SLIC_CMDQ_MAXCMDS</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">,</span> <span class="n">pslic_handle</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">token</span><span class="p">.</span><span class="n">handle_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SLIC_HANDLE_FREE</span><span class="p">;</span>
		<span class="n">pslic_handle</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pfree_slic_handles</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pfree_slic_handles</span> <span class="o">=</span> <span class="n">pslic_handle</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">slic_shmem</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_shmem</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span>
					<span class="n">phys_shmem</span><span class="p">);</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pshmem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">slic_shmem</span><span class="p">));</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">slic_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">slic_entry_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">slic_entry_halt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">slic_xmit_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">slic_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">slic_mac_set_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">slic_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">slic_mcast_set_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">slic_card_locate</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">slic_global</span><span class="p">.</span><span class="n">slic_card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">physcard</span> <span class="o">*</span><span class="n">physcard</span> <span class="o">=</span> <span class="n">slic_global</span><span class="p">.</span><span class="n">phys_card</span><span class="p">;</span>
	<span class="n">ushort</span> <span class="n">card_hostid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">hostid_reg</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">uint</span> <span class="n">rdhostid_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">devid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SLIC_2GB_DEVICE_ID</span>:
		<span class="n">rdhostid_offset</span> <span class="o">=</span> <span class="n">SLIC_RDHOSTID_2GB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SLIC_1GB_DEVICE_ID</span>:
		<span class="n">rdhostid_offset</span> <span class="o">=</span> <span class="n">SLIC_RDHOSTID_1GB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hostid_reg</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">u16</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(((</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slic_regs</span><span class="p">))</span> <span class="o">+</span>
	    <span class="n">rdhostid_offset</span><span class="p">);</span>

	<span class="cm">/* read the 16 bit hostid from SRAM */</span>
	<span class="n">card_hostid</span> <span class="o">=</span> <span class="p">(</span><span class="n">ushort</span><span class="p">)</span> <span class="n">readw</span><span class="p">(</span><span class="n">hostid_reg</span><span class="p">);</span>

	<span class="cm">/* Initialize a new card structure if need be */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_hostid</span> <span class="o">==</span> <span class="n">SLIC_HOSTID_DEFAULT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sliccard</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">slic_global</span><span class="p">.</span><span class="n">slic_card</span><span class="p">;</span>
		<span class="n">slic_global</span><span class="p">.</span><span class="n">slic_card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">busnumber</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">busnumber</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">slotnumber</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slotnumber</span><span class="p">;</span>

		<span class="cm">/* Find an available cardnum */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SLIC_MAX_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">slic_global</span><span class="p">.</span><span class="n">cardnuminuse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">slic_global</span><span class="p">.</span><span class="n">cardnuminuse</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">cardnum</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">slic_global</span><span class="p">.</span><span class="n">num_slic_cards</span><span class="o">++</span><span class="p">;</span>

		<span class="n">slic_debug_card_create</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Card exists, find the card this adapter belongs to */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">card</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">cardnum</span> <span class="o">==</span> <span class="n">card_hostid</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="cm">/* Put the adapter in the card&#39;s adapter list */</span>
	<span class="n">ASSERT</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">card_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* one port per *logical* card */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">physcard</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SLIC_MAX_PORTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">physcard</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">SLIC_MAX_PORTS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">physcard</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">slotnumber</span> <span class="o">==</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">slotnumber</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">physcard</span> <span class="o">=</span> <span class="n">physcard</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">physcard</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no structure allocated for this physical card yet */</span>
		<span class="n">physcard</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">physcard</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="n">ASSERT</span><span class="p">(</span><span class="n">physcard</span><span class="p">);</span>

		<span class="n">physcard</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">slic_global</span><span class="p">.</span><span class="n">phys_card</span><span class="p">;</span>
		<span class="n">slic_global</span><span class="p">.</span><span class="n">phys_card</span> <span class="o">=</span> <span class="n">physcard</span><span class="p">;</span>
		<span class="n">physcard</span><span class="o">-&gt;</span><span class="n">adapters_allocd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">physcard</span><span class="o">-&gt;</span><span class="n">adapters_allocd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Note - this is ZERO relative */</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physport</span> <span class="o">=</span> <span class="n">physcard</span><span class="o">-&gt;</span><span class="n">adapters_allocd</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ASSERT</span><span class="p">(</span><span class="n">physcard</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physport</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">physcard</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">[</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physport</span><span class="p">]</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">physcard</span> <span class="o">=</span> <span class="n">physcard</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">slic_entry_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pcidev</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_tbl_entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cards_found</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">did_version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">memmapped_ioaddr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">mmio_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ulong</span> <span class="n">mmio_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sliccard</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">slic_global</span><span class="p">.</span><span class="n">dynamic_intagg</span> <span class="o">=</span> <span class="n">dynamic_intagg</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">slic_debug</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">did_version</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slic_banner</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slic_proc_version</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">64</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to obtain 64-bit DMA for &quot;</span>
					<span class="s">&quot;consistent allocations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_disable_pci</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_using_dac</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no usable DMA configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pci</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t obtain PCI resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_disable_pci</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="n">netdev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adapter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_exit_slic_probe</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">netdev</span><span class="p">;</span>
	<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">pcidev</span> <span class="o">=</span> <span class="n">pcidev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_using_dac</span><span class="p">)</span>
		<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_HIGHDMA</span><span class="p">;</span>

	<span class="n">mmio_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">mmio_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pcidev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


<span class="cm">/*	memmapped_ioaddr =  (u32)ioremap_nocache(mmio_start, mmio_len);*/</span>
	<span class="n">memmapped_ioaddr</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">mmio_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memmapped_ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot remap MMIO region %lx @ %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mmio_len</span><span class="p">,</span> <span class="n">mmio_start</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_netdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slic_config_pci</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>

	<span class="n">slic_init_driver</span><span class="p">();</span>

	<span class="n">slic_init_adapter</span><span class="p">(</span><span class="n">netdev</span><span class="p">,</span>
			  <span class="n">pcidev</span><span class="p">,</span> <span class="n">pci_tbl_entry</span><span class="p">,</span> <span class="n">memmapped_ioaddr</span><span class="p">,</span> <span class="n">cards_found</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">slic_card_locate</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot locate card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free_mmio_region</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">allocated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">adapters_allocated</span><span class="o">++</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">allocated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">slic_card_init</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">adapter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CARD_FAIL</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ADAPT_FAIL</span><span class="p">;</span>
		<span class="n">adapter</span><span class="o">-&gt;</span><span class="n">linkstate</span> <span class="o">=</span> <span class="n">LINK_DOWN</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FAILED status[%x]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">slic_adapter_set_hwaddr</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">memorybase</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">adapter</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">netdev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">slic_netdev_ops</span><span class="p">;</span>

	<span class="n">slic_debug_adapter_create</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcidev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot register net device, aborting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cards_found</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="nl">err_out_unmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">memmapped_ioaddr</span><span class="p">);</span>
<span class="nl">err_out_free_mmio_region:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mmio_start</span><span class="p">,</span> <span class="n">mmio_len</span><span class="p">);</span>
<span class="nl">err_out_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">netdev</span><span class="p">);</span>
<span class="nl">err_out_exit_slic_probe:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
<span class="nl">err_out_disable_pci:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pcidev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">slic_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">slic_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">slic_entry_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">slic_entry_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">slic_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">slic_init_driver</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">slic_debug</span> <span class="o">!=</span> <span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="n">KBUILD_MODNAME</span> <span class="s">&quot;: debug level is %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">debug</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">slic_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">slic_module_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slic_driver</span><span class="p">);</span>
	<span class="n">slic_debug_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">slic_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">slic_module_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
