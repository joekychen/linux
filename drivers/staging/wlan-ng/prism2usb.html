<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › wlan-ng › prism2usb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>prism2usb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &quot;hfa384x_usb.c&quot;</span>
<span class="cp">#include &quot;prism2mgmt.c&quot;</span>
<span class="cp">#include &quot;prism2mib.c&quot;</span>
<span class="cp">#include &quot;prism2sta.c&quot;</span>
<span class="cp">#include &quot;prism2fw.c&quot;</span>

<span class="cp">#define PRISM_USB_DEVICE(vid, pid, name)	\</span>
<span class="cp">	USB_DEVICE(vid, pid),			\</span>
<span class="cp">	.driver_info = (unsigned long) name</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">usb_prism_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x04bb</span><span class="p">,</span> <span class="mh">0x0922</span><span class="p">,</span> <span class="s">&quot;IOData AirPort WN-B11/USBS&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x07aa</span><span class="p">,</span> <span class="mh">0x0012</span><span class="p">,</span> <span class="s">&quot;Corega Wireless LAN USB Stick-11&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x09aa</span><span class="p">,</span> <span class="mh">0x3642</span><span class="p">,</span> <span class="s">&quot;Prism2.x 11Mbps WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x1668</span><span class="p">,</span> <span class="mh">0x0408</span><span class="p">,</span> <span class="s">&quot;Actiontec Prism2.5 11Mbps WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x1668</span><span class="p">,</span> <span class="mh">0x0421</span><span class="p">,</span> <span class="s">&quot;Actiontec Prism2.5 11Mbps WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x1915</span><span class="p">,</span> <span class="mh">0x2236</span><span class="p">,</span> <span class="s">&quot;Linksys WUSB11v3.0 11Mbps WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x066b</span><span class="p">,</span> <span class="mh">0x2212</span><span class="p">,</span> <span class="s">&quot;Linksys WUSB11v2.5 11Mbps WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x066b</span><span class="p">,</span> <span class="mh">0x2213</span><span class="p">,</span> <span class="s">&quot;Linksys WUSB12v1.1 11Mbps WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x067c</span><span class="p">,</span> <span class="mh">0x1022</span><span class="p">,</span> <span class="s">&quot;Siemens SpeedStream 1022 11Mbps WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x049f</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">,</span>
	 <span class="s">&quot;Compaq/Intel W100 PRO/Wireless 11Mbps multiport WLAN Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0411</span><span class="p">,</span> <span class="mh">0x0016</span><span class="p">,</span> <span class="s">&quot;Melco WLI-USB-S11 11Mbps WLAN Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x08de</span><span class="p">,</span> <span class="mh">0x7a01</span><span class="p">,</span> <span class="s">&quot;PRISM25 IEEE 802.11 Mini USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x1111</span><span class="p">,</span> <span class="s">&quot;Intel PRO/Wireless 2011B LAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0d8e</span><span class="p">,</span> <span class="mh">0x7a01</span><span class="p">,</span> <span class="s">&quot;PRISM25 IEEE 802.11 Mini USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x045e</span><span class="p">,</span> <span class="mh">0x006e</span><span class="p">,</span> <span class="s">&quot;Microsoft MN510 Wireless USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x0967</span><span class="p">,</span> <span class="mh">0x0204</span><span class="p">,</span> <span class="s">&quot;Acer Warplink USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0cde</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="s">&quot;Z-Com 725/726 Prism2.5 USB/USB Integrated&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0cde</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="s">&quot;Z-Com Xl735 Wireless 802.11b USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x413c</span><span class="p">,</span> <span class="mh">0x8100</span><span class="p">,</span> <span class="s">&quot;Dell TrueMobile 1180 Wireless USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0b3b</span><span class="p">,</span> <span class="mh">0x1601</span><span class="p">,</span> <span class="s">&quot;ALLNET 0193 11Mbps WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0b3b</span><span class="p">,</span> <span class="mh">0x1602</span><span class="p">,</span> <span class="s">&quot;ZyXEL ZyAIR B200 Wireless USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0baf</span><span class="p">,</span> <span class="mh">0x00eb</span><span class="p">,</span> <span class="s">&quot;USRobotics USR1120 Wireless USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0411</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">,</span> <span class="s">&quot;Melco WLI-USB-KS11G 11Mbps WLAN Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x04f1</span><span class="p">,</span> <span class="mh">0x3009</span><span class="p">,</span> <span class="s">&quot;JVC MP-XP7250 Builtin USB WLAN Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x0846</span><span class="p">,</span> <span class="mh">0x4110</span><span class="p">,</span> <span class="s">&quot;NetGear MA111&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x03f3</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="s">&quot;Adaptec AWN-8020 USB WLAN Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x2821</span><span class="p">,</span> <span class="mh">0x3300</span><span class="p">,</span> <span class="s">&quot;ASUS-WL140 Wireless USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x2001</span><span class="p">,</span> <span class="mh">0x3700</span><span class="p">,</span> <span class="s">&quot;DWL-122 Wireless USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x2001</span><span class="p">,</span> <span class="mh">0x3702</span><span class="p">,</span> <span class="s">&quot;DWL-120 Rev F Wireless USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x50c2</span><span class="p">,</span> <span class="mh">0x4013</span><span class="p">,</span> <span class="s">&quot;Averatec USB WLAN Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x2c02</span><span class="p">,</span> <span class="mh">0x14ea</span><span class="p">,</span> <span class="s">&quot;Planex GW-US11H WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x124a</span><span class="p">,</span> <span class="mh">0x168b</span><span class="p">,</span> <span class="s">&quot;Airvast PRISM3 WLAN USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x083a</span><span class="p">,</span> <span class="mh">0x3503</span><span class="p">,</span> <span class="s">&quot;T-Sinus 111 USB WLAN Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x2821</span><span class="p">,</span> <span class="mh">0x3300</span><span class="p">,</span> <span class="s">&quot;Hawking HighDB USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0411</span><span class="p">,</span> <span class="mh">0x0044</span><span class="p">,</span> <span class="s">&quot;Melco WLI-USB-KB11 11Mbps WLAN Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x1668</span><span class="p">,</span> <span class="mh">0x6106</span><span class="p">,</span> <span class="s">&quot;ROPEX FreeLan 802.11b USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x124a</span><span class="p">,</span> <span class="mh">0x4017</span><span class="p">,</span> <span class="s">&quot;Pheenet WL-503IA 802.11b USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span><span class="p">(</span><span class="mh">0x0bb2</span><span class="p">,</span> <span class="mh">0x0302</span><span class="p">,</span> <span class="s">&quot;Ambit Microsystems Corp.&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x9016</span><span class="p">,</span> <span class="mh">0x182d</span><span class="p">,</span> <span class="s">&quot;Sitecom WL-022 802.11b USB Adapter&quot;</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">PRISM_USB_DEVICE</span>
	 <span class="p">(</span><span class="mh">0x0543</span><span class="p">,</span> <span class="mh">0x0f01</span><span class="p">,</span> <span class="s">&quot;ViewSonic Airsync USB Adapter 11Mbps (Prism2.5)&quot;</span><span class="p">)},</span>
	<span class="p">{</span> <span class="cm">/* terminator */</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">usb_prism_tbl</span><span class="p">);</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_probe_usb</span>
<span class="cm">*</span>
<span class="cm">* Probe routine called by the USB subsystem.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	dev		ptr to the usb_device struct</span>
<span class="cm">*	ifnum		interface number being offered</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	NULL		- we&#39;re not claiming the device+interface</span>
<span class="cm">*	non-NULL	- we are claiming the device+interface and</span>
<span class="cm">*			  this is a ptr to the data we want back</span>
<span class="cm">*			  when disconnect is called.</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	I&#39;m not sure, assume it&#39;s interrupt.</span>
<span class="cm">*</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_probe_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">wlandev</span> <span class="o">=</span> <span class="n">create_wlan</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlandev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Memory allocation failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hw</span> <span class="o">=</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlan_setup</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: wlan_setup() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize the hw data */</span>
	<span class="n">hfa384x_create</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wlandev</span> <span class="o">=</span> <span class="n">wlandev</span><span class="p">;</span>

	<span class="cm">/* Register the wlandev, this gets us a name and registers the</span>
<span class="cm">	 * linux netdevice.</span>
<span class="cm">	 */</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="cm">/* Do a chip-level reset on the MAC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prism2_doreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_corereset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					   <span class="n">prism2_reset_holdtime</span><span class="p">,</span>
					   <span class="n">prism2_reset_settletime</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unregister_wlandev</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
			<span class="n">hfa384x_destroy</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: hfa384x_corereset() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">usb_get_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_HWPRESENT</span><span class="p">;</span>

	<span class="cm">/* Try and load firmware, then enable card before we register */</span>
	<span class="n">prism2_fwtry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wlandev</span><span class="p">);</span>
	<span class="n">prism2sta_ifstate</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">P80211ENUM_ifstate_enable</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_wlandev</span><span class="p">(</span><span class="n">wlandev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: register_wlandev() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">wlandev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">wlandev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_disconnect_usb</span>
<span class="cm">*</span>
<span class="cm">* Called when a device previously claimed by probe is removed</span>
<span class="cm">* from the USB.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	dev		ptr to the usb_device struct</span>
<span class="cm">*	ptr		ptr returned by probe() when the device</span>
<span class="cm">*                       was claimed.</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	Nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	process</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_disconnect_usb</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">;</span>

	<span class="n">wlandev</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlandev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">cleanlist</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctlxq</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">p80211netdev_hwremoved</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctlxq</span><span class="p">.</span><span class="n">reapable</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cleanlist</span><span class="p">);</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctlxq</span><span class="p">.</span><span class="n">completing</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cleanlist</span><span class="p">);</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctlxq</span><span class="p">.</span><span class="n">pending</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cleanlist</span><span class="p">);</span>
		<span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctlxq</span><span class="p">.</span><span class="n">active</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cleanlist</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctlxq</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* There&#39;s no hardware to shutdown, but the driver</span>
<span class="cm">		 * might have some tasks or tasklets that must be</span>
<span class="cm">		 * stopped before we can tear everything down.</span>
<span class="cm">		 */</span>
		<span class="n">prism2sta_ifstate</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">P80211ENUM_ifstate_disable</span><span class="p">);</span>

		<span class="n">del_singleshot_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">throttle</span><span class="p">);</span>
		<span class="n">del_singleshot_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reqtimer</span><span class="p">);</span>
		<span class="n">del_singleshot_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">resptimer</span><span class="p">);</span>

		<span class="cm">/* Unlink all the URBs. This &quot;removes the wheels&quot;</span>
<span class="cm">		 * from the entire CTLX handling mechanism.</span>
<span class="cm">		 */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctlx_urb</span><span class="p">);</span>

		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">completion_bh</span><span class="p">);</span>
		<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">reaper_bh</span><span class="p">);</span>

		<span class="n">flush_scheduled_work</span><span class="p">();</span>

		<span class="cm">/* Now we complete any outstanding commands</span>
<span class="cm">		 * and tell everyone who is waiting for their</span>
<span class="cm">		 * responses that we have shut down.</span>
<span class="cm">		 */</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cleanlist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hfa384x_usbctlx_t</span> <span class="o">*</span><span class="n">ctlx</span><span class="p">;</span>

			<span class="n">ctlx</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">hfa384x_usbctlx_t</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctlx</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Give any outstanding synchronous commands</span>
<span class="cm">		 * a chance to complete. All they need to do</span>
<span class="cm">		 * is &quot;wake up&quot;, so that&#39;s easy.</span>
<span class="cm">		 * (I&#39;d like a better way to do this, really.)</span>
<span class="cm">		 */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="cm">/* Now delete the CTLXs, because no-one else can now. */</span>
		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cleanlist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hfa384x_usbctlx_t</span> <span class="o">*</span><span class="n">ctlx</span><span class="p">;</span>

			<span class="n">ctlx</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">hfa384x_usbctlx_t</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ctlx</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Unhook the wlandev */</span>
		<span class="n">unregister_wlandev</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
		<span class="n">wlan_unsetup</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>

		<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">);</span>

		<span class="n">hfa384x_destroy</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
				<span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">;</span>
	<span class="n">wlandev</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlandev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">prism2sta_ifstate</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">P80211ENUM_ifstate_disable</span><span class="p">);</span>

	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
	<span class="n">usb_kill_urb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ctlx_urb</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">;</span>
	<span class="n">wlandev</span> <span class="o">=</span> <span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlandev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Do a chip-level reset on the MAC */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prism2_doreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_corereset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					   <span class="n">prism2_reset_holdtime</span><span class="p">,</span>
					   <span class="n">prism2_reset_settletime</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unregister_wlandev</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
			<span class="n">hfa384x_destroy</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			       <span class="s">&quot;%s: hfa384x_corereset() failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">wlandev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">prism2sta_ifstate</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">P80211ENUM_ifstate_enable</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define prism2sta_suspend NULL</span>
<span class="cp">#define prism2sta_resume NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">prism2_usb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;prism2_usb&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">prism2sta_probe_usb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">prism2sta_disconnect_usb</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">usb_prism_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">prism2sta_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">prism2sta_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span> <span class="n">prism2sta_resume</span><span class="p">,</span>
	<span class="cm">/* fops, minor? */</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">prism2_usb_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
