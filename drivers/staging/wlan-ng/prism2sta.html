<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › wlan-ng › prism2sta.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>prism2sta.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* src/prism2/driver/prism2sta.c</span>
<span class="cm">*</span>
<span class="cm">* Implements the station functionality for prism2</span>
<span class="cm">*</span>
<span class="cm">* Copyright (C) 1999 AbsoluteValue Systems, Inc.  All Rights Reserved.</span>
<span class="cm">* --------------------------------------------------------------------</span>
<span class="cm">*</span>
<span class="cm">* linux-wlan</span>
<span class="cm">*</span>
<span class="cm">*   The contents of this file are subject to the Mozilla Public</span>
<span class="cm">*   License Version 1.1 (the &quot;License&quot;); you may not use this file</span>
<span class="cm">*   except in compliance with the License. You may obtain a copy of</span>
<span class="cm">*   the License at http://www.mozilla.org/MPL/</span>
<span class="cm">*</span>
<span class="cm">*   Software distributed under the License is distributed on an &quot;AS</span>
<span class="cm">*   IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or</span>
<span class="cm">*   implied. See the License for the specific language governing</span>
<span class="cm">*   rights and limitations under the License.</span>
<span class="cm">*</span>
<span class="cm">*   Alternatively, the contents of this file may be used under the</span>
<span class="cm">*   terms of the GNU Public License version 2 (the &quot;GPL&quot;), in which</span>
<span class="cm">*   case the provisions of the GPL are applicable instead of the</span>
<span class="cm">*   above.  If you wish to allow the use of your version of this file</span>
<span class="cm">*   only under the terms of the GPL and not to allow others to use</span>
<span class="cm">*   your version of this file under the MPL, indicate your decision</span>
<span class="cm">*   by deleting the provisions above and replace them with the notice</span>
<span class="cm">*   and other provisions required by the GPL.  If you do not delete</span>
<span class="cm">*   the provisions above, a recipient may use your version of this</span>
<span class="cm">*   file under either the MPL or the GPL.</span>
<span class="cm">*</span>
<span class="cm">* --------------------------------------------------------------------</span>
<span class="cm">*</span>
<span class="cm">* Inquiries regarding the linux-wlan Open Source project can be</span>
<span class="cm">* made directly to:</span>
<span class="cm">*</span>
<span class="cm">* AbsoluteValue Systems Inc.</span>
<span class="cm">* info@linux-wlan.com</span>
<span class="cm">* http://www.linux-wlan.com</span>
<span class="cm">*</span>
<span class="cm">* --------------------------------------------------------------------</span>
<span class="cm">*</span>
<span class="cm">* Portions of the development of this software were funded by</span>
<span class="cm">* Intersil Corporation as part of PRISM(R) chipset product development.</span>
<span class="cm">*</span>
<span class="cm">* --------------------------------------------------------------------</span>
<span class="cm">*</span>
<span class="cm">* This file implements the module and linux pcmcia routines for the</span>
<span class="cm">* prism2 driver.</span>
<span class="cm">*</span>
<span class="cm">* --------------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/byteorder/generic.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &quot;p80211types.h&quot;</span>
<span class="cp">#include &quot;p80211hdr.h&quot;</span>
<span class="cp">#include &quot;p80211mgmt.h&quot;</span>
<span class="cp">#include &quot;p80211conv.h&quot;</span>
<span class="cp">#include &quot;p80211msg.h&quot;</span>
<span class="cp">#include &quot;p80211netdev.h&quot;</span>
<span class="cp">#include &quot;p80211req.h&quot;</span>
<span class="cp">#include &quot;p80211metadef.h&quot;</span>
<span class="cp">#include &quot;p80211metastruct.h&quot;</span>
<span class="cp">#include &quot;hfa384x.h&quot;</span>
<span class="cp">#include &quot;prism2mgmt.h&quot;</span>

<span class="cm">/* Create a string of printable chars from something that might not be */</span>
<span class="cm">/* It&#39;s recommended that the str be 4*len + 1 bytes long */</span>
<span class="cp">#define wlan_mkprintstr(buf, buflen, str, strlen) \</span>
<span class="cp">{ \</span>
<span class="cp">	int i = 0; \</span>
<span class="cp">	int j = 0; \</span>
<span class="cp">	memset(str, 0, (strlen)); \</span>
<span class="cp">	for (i = 0; i &lt; (buflen); i++) { \</span>
<span class="cp">		if (isprint((buf)[i])) { \</span>
<span class="cp">			(str)[j] = (buf)[i]; \</span>
<span class="cp">			j++; \</span>
<span class="cp">		} else { \</span>
<span class="cp">			(str)[j] = &#39;\\&#39;; \</span>
<span class="cp">			(str)[j+1] = &#39;x&#39;; \</span>
<span class="cp">			(str)[j+2] = hex_asc_hi((buf)[i]); \</span>
<span class="cp">			(str)[j+3] = hex_asc_lo((buf)[i]); \</span>
<span class="cp">			j += 4; \</span>
<span class="cp">		} \</span>
<span class="cp">	} \</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dev_info</span> <span class="o">=</span> <span class="s">&quot;prism2_usb&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">create_wlan</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">prism2_reset_holdtime</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>	<span class="cm">/* Reset hold time in ms */</span>
<span class="kt">int</span> <span class="n">prism2_reset_settletime</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* Reset settle time in ms */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2_doreset</span><span class="p">;</span>	<span class="cm">/* Do a reset at init? */</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">prism2_doreset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">prism2_doreset</span><span class="p">,</span> <span class="s">&quot;Issue a reset on initialization&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">prism2_reset_holdtime</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">prism2_reset_holdtime</span><span class="p">,</span> <span class="s">&quot;reset hold time in ms&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">prism2_reset_settletime</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">prism2_reset_settletime</span><span class="p">,</span> <span class="s">&quot;reset settle time in ms&quot;</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual MPL/GPL&quot;</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">prism2_connect_result</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">failed</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">prism2_disconnected</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">prism2_roamed</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2sta_open</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2sta_close</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_reset</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2sta_txframe</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">p80211_hdr</span> <span class="o">*</span><span class="n">p80211_hdr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">p80211_metawep</span> <span class="o">*</span><span class="n">p80211_wep</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2sta_mlmerequest</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p80211msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2sta_getcardinfo</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2sta_globalsetup</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2sta_setmulticast</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">netdevice_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_handover</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				   <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_tallies</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				  <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_hostscanresults</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
					  <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_scanresults</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				      <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_chinforesults</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
					<span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_linkstatus</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				     <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_assocstatus</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				      <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_authreq</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				  <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_authreq_defer</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
					<span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2sta_inf_psusercnt</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				    <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">);</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_open</span>
<span class="cm">*</span>
<span class="cm">* WLAN device open method.  Called from p80211netdev when kernel</span>
<span class="cm">* device open (start) method is called in response to the</span>
<span class="cm">* SIOCSIIFFLAGS ioctl changing the flags bit IFF_UP</span>
<span class="cm">* from clear to set.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	0	success</span>
<span class="cm">*	&gt;0	f/w reported error</span>
<span class="cm">*	&lt;0	driver reported error</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	process thread</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_open</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We don&#39;t currently have to do anything else.</span>
<span class="cm">	 * The setup of the MAC should be subsequently completed via</span>
<span class="cm">	 * the mlme commands.</span>
<span class="cm">	 * Higher layers know we&#39;re ready from dev-&gt;start==1 and</span>
<span class="cm">	 * dev-&gt;tbusy==0.  Our rx path knows to pass up received/</span>
<span class="cm">	 * frames because of dev-&gt;flags&amp;IFF_UP is true.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_close</span>
<span class="cm">*</span>
<span class="cm">* WLAN device close method.  Called from p80211netdev when kernel</span>
<span class="cm">* device close method is called in response to the</span>
<span class="cm">* SIOCSIIFFLAGS ioctl changing the flags bit IFF_UP</span>
<span class="cm">* from set to clear.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	0	success</span>
<span class="cm">*	&gt;0	f/w reported error</span>
<span class="cm">*	&lt;0	driver reported error</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	process thread</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_close</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We don&#39;t currently have to do anything else.</span>
<span class="cm">	 * Higher layers know we&#39;re not ready from dev-&gt;start==0 and</span>
<span class="cm">	 * dev-&gt;tbusy==1.  Our rx path knows to not pass up received</span>
<span class="cm">	 * frames because of dev-&gt;flags&amp;IFF_UP is false.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_reset</span>
<span class="cm">*</span>
<span class="cm">* Not currently implented.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	none</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	process thread</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_reset</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_txframe</span>
<span class="cm">*</span>
<span class="cm">* Takes a frame from p80211 and queues it for transmission.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	pb		packet buffer struct.  Contains an 802.11</span>
<span class="cm">*			data frame.</span>
<span class="cm">*       p80211_hdr      points to the 802.11 header for the packet.</span>
<span class="cm">* Returns:</span>
<span class="cm">*	0		Success and more buffs available</span>
<span class="cm">*	1		Success but no more buffs</span>
<span class="cm">*	2		Allocation failure</span>
<span class="cm">*	4		Buffer full or queue busy</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	process thread</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_txframe</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">p80211_hdr</span> <span class="o">*</span><span class="n">p80211_hdr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">p80211_metawep</span> <span class="o">*</span><span class="n">p80211_wep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* If necessary, set the 802.11 WEP bit */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">hostwep</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HOSTWEP_PRIVACYINVOKED</span> <span class="o">|</span> <span class="n">HOSTWEP_ENCRYPT</span><span class="p">))</span> <span class="o">==</span>
	    <span class="n">HOSTWEP_PRIVACYINVOKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p80211_hdr</span><span class="o">-&gt;</span><span class="n">a3</span><span class="p">.</span><span class="n">fc</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_SET_FC_ISWEP</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_txframe</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">p80211_hdr</span><span class="p">,</span> <span class="n">p80211_wep</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_mlmerequest</span>
<span class="cm">*</span>
<span class="cm">* wlan command message handler.  All we do here is pass the message</span>
<span class="cm">* over to the prism2sta_mgmt_handler.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	msg		wlan command message</span>
<span class="cm">* Returns:</span>
<span class="cm">*	0		success</span>
<span class="cm">*	&lt;0		successful acceptance of message, but we&#39;re</span>
<span class="cm">*			waiting for an async process to finish before</span>
<span class="cm">*			we&#39;re done with the msg.  When the asynch</span>
<span class="cm">*			process is done, we&#39;ll call the p80211</span>
<span class="cm">*			function p80211req_confirm() .</span>
<span class="cm">*	&gt;0		An error occurred while we were handling</span>
<span class="cm">*			the message.</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	process thread</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_mlmerequest</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">p80211msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">msgcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DIDmsg_dot11req_mibget</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mibget request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_mibset_mibget</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_dot11req_mibset</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mibset request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_mibset_mibget</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_dot11req_scan</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received scan request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_scan</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_dot11req_scan_results</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received scan_results request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_scan_results</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_dot11req_start</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mlme start request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_start</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Prism2 specific messages</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">DIDmsg_p2req_readpda</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mlme readpda request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_readpda</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_p2req_ramdl_state</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mlme ramdl_state request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_ramdl_state</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_p2req_ramdl_write</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mlme ramdl_write request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_ramdl_write</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_p2req_flashdl_state</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mlme flashdl_state request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_flashdl_state</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_p2req_flashdl_write</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mlme flashdl_write request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_flashdl_write</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Linux specific messages</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">DIDmsg_lnxreq_hostwep</span>:
		<span class="k">break</span><span class="p">;</span>		<span class="cm">/* ignore me. */</span>
	<span class="k">case</span> <span class="n">DIDmsg_lnxreq_ifstate</span>:
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">p80211msg_lnxreq_ifstate</span> <span class="o">*</span><span class="n">ifstatemsg</span><span class="p">;</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mlme ifstate request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ifstatemsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p80211msg_lnxreq_ifstate</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span>
			    <span class="n">prism2sta_ifstate</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span>
					      <span class="n">ifstatemsg</span><span class="o">-&gt;</span><span class="n">ifstate</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
			<span class="n">ifstatemsg</span><span class="o">-&gt;</span><span class="n">resultcode</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span>
			    <span class="n">P80211ENUM_msgitem_status_data_ok</span><span class="p">;</span>
			<span class="n">ifstatemsg</span><span class="o">-&gt;</span><span class="n">resultcode</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_lnxreq_wlansniff</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mlme wlansniff request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_wlansniff</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_lnxreq_autojoin</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received mlme autojoin request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">prism2mgmt_autojoin</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DIDmsg_lnxreq_commsquality</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">p80211msg_lnxreq_commsquality</span> <span class="o">*</span><span class="n">qualmsg</span><span class="p">;</span>

			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received commsquality request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">qualmsg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p80211msg_lnxreq_commsquality</span> <span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">;</span>

			<span class="n">qualmsg</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span>
			    <span class="n">P80211ENUM_msgitem_status_data_ok</span><span class="p">;</span>
			<span class="n">qualmsg</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span>
			    <span class="n">P80211ENUM_msgitem_status_data_ok</span><span class="p">;</span>
			<span class="n">qualmsg</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span>
			    <span class="n">P80211ENUM_msgitem_status_data_ok</span><span class="p">;</span>

			<span class="n">qualmsg</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">CQ_currBSS</span><span class="p">);</span>
			<span class="n">qualmsg</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">ASL_currBSS</span><span class="p">);</span>
			<span class="n">qualmsg</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">ANL_currFC</span><span class="p">);</span>
			<span class="n">qualmsg</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unknown mgmt request message 0x%08x&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">msgcode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_ifstate</span>
<span class="cm">*</span>
<span class="cm">* Interface state.  This is the primary WLAN interface enable/disable</span>
<span class="cm">* handler.  Following the driver/load/deviceprobe sequence, this</span>
<span class="cm">* function must be called with a state of &quot;enable&quot; before any other</span>
<span class="cm">* commands will be accepted.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	msgp		ptr to msg buffer</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	A p80211 message resultcode value.</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	process thread  (usually)</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="n">u32</span> <span class="nf">prism2sta_ifstate</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ifstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_implementation_failure</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Current MSD state(%d), requesting(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span><span class="p">,</span> <span class="n">ifstate</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ifstate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">P80211ENUM_ifstate_fwload</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_HWPRESENT</span>:
			<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_FWLOAD_PENDING</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Initialize the device+driver sufficiently</span>
<span class="cm">			 * for firmware loading.</span>
<span class="cm">			 */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_start</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;hfa384x_drvr_start() failed,&quot;</span>
				       <span class="s">&quot;result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="p">);</span>
				<span class="n">result</span> <span class="o">=</span>
				 <span class="n">P80211ENUM_resultcode_implementation_failure</span><span class="p">;</span>
				<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_HWPRESENT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_FWLOAD</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_success</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_FWLOAD</span>:
			<span class="n">hfa384x_cmd_initialize</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_success</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_RUNNING</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			       <span class="s">&quot;Cannot enter fwload state from enable state,&quot;</span>
			       <span class="s">&quot;you must disable first.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_invalid_parameters</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_HWFAIL</span>:
		<span class="nl">default:</span>
			<span class="cm">/* probe() had a problem or the msdstate contains</span>
<span class="cm">			 * an unrecognized value, there&#39;s nothing we can do.</span>
<span class="cm">			 */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_implementation_failure</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P80211ENUM_ifstate_enable</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_HWPRESENT</span>:
		<span class="k">case</span> <span class="n">WLAN_MSD_FWLOAD</span>:
			<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_RUNNING_PENDING</span><span class="p">;</span>
			<span class="cm">/* Initialize the device+driver for full</span>
<span class="cm">			 * operation. Note that this might me an FWLOAD to</span>
<span class="cm">			 * to RUNNING transition so we must not do a chip</span>
<span class="cm">			 * or board level reset.  Note that on failure,</span>
<span class="cm">			 * the MSD state is set to HWPRESENT because we</span>
<span class="cm">			 * can&#39;t make any assumptions about the state</span>
<span class="cm">			 * of the hardware or a previous firmware load.</span>
<span class="cm">			 */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_start</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;hfa384x_drvr_start() failed,&quot;</span>
				       <span class="s">&quot;result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="p">);</span>
				<span class="n">result</span> <span class="o">=</span>
				  <span class="n">P80211ENUM_resultcode_implementation_failure</span><span class="p">;</span>
				<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_HWPRESENT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">prism2sta_getcardinfo</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;prism2sta_getcardinfo() failed,&quot;</span>
				       <span class="s">&quot;result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="p">);</span>
				<span class="n">result</span> <span class="o">=</span>
				  <span class="n">P80211ENUM_resultcode_implementation_failure</span><span class="p">;</span>
				<span class="n">hfa384x_drvr_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
				<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_HWPRESENT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">prism2sta_globalsetup</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;prism2sta_globalsetup() failed,&quot;</span>
				       <span class="s">&quot;result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">result</span><span class="p">);</span>
				<span class="n">result</span> <span class="o">=</span>
				  <span class="n">P80211ENUM_resultcode_implementation_failure</span><span class="p">;</span>
				<span class="n">hfa384x_drvr_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
				<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_HWPRESENT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_RUNNING</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">join_ap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">join_retries</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_success</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_RUNNING</span>:
			<span class="cm">/* Do nothing, we&#39;re already in this state. */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_success</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_HWFAIL</span>:
		<span class="nl">default:</span>
			<span class="cm">/* probe() had a problem or the msdstate contains</span>
<span class="cm">			 * an unrecognized value, there&#39;s nothing we can do.</span>
<span class="cm">			 */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_implementation_failure</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P80211ENUM_ifstate_disable</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_HWPRESENT</span>:
			<span class="cm">/* Do nothing, we&#39;re already in this state. */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_success</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_FWLOAD</span>:
		<span class="k">case</span> <span class="n">WLAN_MSD_RUNNING</span>:
			<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_HWPRESENT_PENDING</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * TODO: Shut down the MAC completely. Here a chip</span>
<span class="cm">			 * or board level reset is probably called for.</span>
<span class="cm">			 * After a &quot;disable&quot; _all_ results are lost, even</span>
<span class="cm">			 * those from a fwload.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">hwremoved</span><span class="p">)</span>
				<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

			<span class="n">hfa384x_drvr_stop</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

			<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">macmode</span> <span class="o">=</span> <span class="n">WLAN_MACMODE_NONE</span><span class="p">;</span>
			<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_HWPRESENT</span><span class="p">;</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_success</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_MSD_HWFAIL</span>:
		<span class="nl">default:</span>
			<span class="cm">/* probe() had a problem or the msdstate contains</span>
<span class="cm">			 * an unrecognized value, there&#39;s nothing we can do.</span>
<span class="cm">			 */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_implementation_failure</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">P80211ENUM_resultcode_invalid_parameters</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_getcardinfo</span>
<span class="cm">*</span>
<span class="cm">* Collect the NICID, firmware version and any other identifiers</span>
<span class="cm">* we&#39;d like to have in host-side data structures.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	0	success</span>
<span class="cm">*	&gt;0	f/w reported error</span>
<span class="cm">*	&lt;0	driver reported error</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	Either.</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_getcardinfo</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">snum</span><span class="p">[</span><span class="n">HFA384x_RID_NICSERIALNUMBER_LEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">pstr</span><span class="p">[(</span><span class="n">HFA384x_RID_NICSERIALNUMBER_LEN</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Collect version and compatibility info */</span>
	<span class="cm">/*  Some are critical, some are not */</span>
	<span class="cm">/* NIC identity */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_NICIDENTITY</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_compident_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve NICIDENTITY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the nic id fields in host byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">major</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ident: nic h/w: id=0x%02x %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>

	<span class="cm">/* Primary f/w identity */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_PRIIDENTITY</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_compident_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve PRIIDENTITY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the private fw id fields in host byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">major</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ident: pri f/w: id=0x%02x %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_pri_fw</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>

	<span class="cm">/* Station (Secondary?) f/w identity */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_STAIDENTITY</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_compident_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve STAIDENTITY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_nic</span><span class="p">.</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;FATAL: Card is not an Intersil Prism2/2.5/3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the station fw id fields in host byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">major</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>

	<span class="cm">/* strip out the &#39;special&#39; variant bits */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">mm_mods</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">variant</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">));</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">variant</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;ident: sta f/w: id=0x%02x %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;ident:  ap f/w: id=0x%02x %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unsupported Tertiary AP firmeare loaded!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Compatibility range, Modem supplier */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_MFISUPRANGE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_caplevel_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve MFISUPRANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the Compatibility range, modem interface supplier</span>
<span class="cm">	   fields in byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">role</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;MFI:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_mfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* Compatibility range, Controller supplier */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_CFISUPRANGE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_caplevel_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve CFISUPRANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the Compatibility range, controller interface supplier</span>
<span class="cm">	   fields in byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">role</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;CFI:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_cfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* Compatibility range, Primary f/w supplier */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_PRISUPRANGE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_caplevel_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve PRISUPRANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the Compatibility range, primary firmware supplier</span>
<span class="cm">	   fields in byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">role</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">bottom</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;PRI:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_pri</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* Compatibility range, Station f/w supplier */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_STASUPRANGE</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_caplevel_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve STASUPRANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the Compatibility range, station firmware supplier</span>
<span class="cm">	   fields in byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">role</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">bottom</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;STA:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;AP:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
		       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_sup_sta</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Compatibility range, primary f/w actor, CFI supplier */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_PRI_CFIACTRANGES</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_caplevel_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve PRI_CFIACTRANGES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the Compatibility range, primary f/w actor, CFI supplier</span>
<span class="cm">	   fields in byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">role</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;PRI-CFI:ACT:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_pri_cfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* Compatibility range, sta f/w actor, CFI supplier */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_STA_CFIACTRANGES</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_caplevel_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve STA_CFIACTRANGES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the Compatibility range, station f/w actor, CFI supplier</span>
<span class="cm">	   fields in byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">role</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;STA-CFI:ACT:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_cfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* Compatibility range, sta f/w actor, MFI supplier */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_STA_MFIACTRANGES</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_caplevel_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve STA_MFIACTRANGES</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get all the Compatibility range, station f/w actor, MFI supplier</span>
<span class="cm">	   fields in byte order */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">role</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">variant</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;STA-MFI:ACT:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">role</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">variant</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
	       <span class="n">hw</span><span class="o">-&gt;</span><span class="n">cap_act_sta_mfi</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* Serial Number */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_NICSERIALNUMBER</span><span class="p">,</span>
					<span class="n">snum</span><span class="p">,</span> <span class="n">HFA384x_RID_NICSERIALNUMBER_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wlan_mkprintstr</span><span class="p">(</span><span class="n">snum</span><span class="p">,</span> <span class="n">HFA384x_RID_NICSERIALNUMBER_LEN</span><span class="p">,</span>
				<span class="n">pstr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pstr</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Prism2 card SN: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pstr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve Prism2 Card SN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Collect the MAC address */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_CNFOWNMACADDR</span><span class="p">,</span>
					<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to retrieve mac address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* short preamble is always implemented */</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">nsdcaps</span> <span class="o">|=</span> <span class="n">P80211_NSDCAP_SHORT_PREAMBLE</span><span class="p">;</span>

	<span class="cm">/* find out if hardware wep is implemented */</span>
	<span class="n">hfa384x_drvr_getconfig16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_PRIVACYOPTIMP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
		<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">nsdcaps</span> <span class="o">|=</span> <span class="n">P80211_NSDCAP_HARDWAREWEP</span><span class="p">;</span>

	<span class="cm">/* get the dBm Scaling constant */</span>
	<span class="n">hfa384x_drvr_getconfig16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_CNFDBMADJUST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dbmadjust</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>

	<span class="cm">/* Only enable scan by default on newer firmware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HFA384x_FIRMWARE_VERSION</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">major</span><span class="p">,</span>
				     <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span>
				     <span class="n">hw</span><span class="o">-&gt;</span><span class="n">ident_sta_fw</span><span class="p">.</span><span class="n">variant</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="n">HFA384x_FIRMWARE_VERSION</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">nsdcaps</span> <span class="o">|=</span> <span class="n">P80211_NSDCAP_NOSCAN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: Set any internally managed config items */</span>

	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="nl">failed:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed, result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_globalsetup</span>
<span class="cm">*</span>
<span class="cm">* Set any global RIDs that we want to set at device activation.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	0	success</span>
<span class="cm">*	&gt;0	f/w reported error</span>
<span class="cm">*	&lt;0	driver reported error</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	process thread</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_globalsetup</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Set the maximum frame size */</span>
	<span class="k">return</span> <span class="n">hfa384x_drvr_setconfig16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_CNFMAXDATALEN</span><span class="p">,</span>
					<span class="n">WLAN_DATA_MAXLEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2sta_setmulticast</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">netdevice_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">promisc</span><span class="p">;</span>

	<span class="cm">/* If we&#39;re not ready, what&#39;s the point? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">HFA384x_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IFF_PROMISC</span> <span class="o">|</span> <span class="n">IFF_ALLMULTI</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">promisc</span> <span class="o">=</span> <span class="n">P80211ENUM_truth_true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">promisc</span> <span class="o">=</span> <span class="n">P80211ENUM_truth_false</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span>
	    <span class="n">hfa384x_drvr_setconfig16_async</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_PROMISCMODE</span><span class="p">,</span>
					   <span class="n">promisc</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_inf_handover</span>
<span class="cm">*</span>
<span class="cm">* Handles the receipt of a Handover info frame. Should only be present</span>
<span class="cm">* in APs only.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to info frame (contents in hfa384x order)</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_handover</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				   <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;received infoframe:HANDOVER (unhandled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_inf_tallies</span>
<span class="cm">*</span>
<span class="cm">* Handles the receipt of a CommTallies info frame.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to info frame (contents in hfa384x order)</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_tallies</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				  <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">src16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">src32</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 ** Determine if these are 16-bit or 32-bit tallies, based on the</span>
<span class="cm">	 ** record length of the info record.</span>
<span class="cm">	 */</span>

	<span class="n">cnt</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_CommTallies32_t</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tallies</span><span class="p">;</span>
		<span class="n">src32</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">commtallies32</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">dst</span><span class="o">++</span><span class="p">,</span> <span class="n">src32</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">src32</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">tallies</span><span class="p">;</span>
		<span class="n">src16</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">commtallies16</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">dst</span><span class="o">++</span><span class="p">,</span> <span class="n">src16</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">dst</span> <span class="o">+=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">src16</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_inf_scanresults</span>
<span class="cm">*</span>
<span class="cm">* Handles the receipt of a Scan Results info frame.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to info frame (contents in hfa384x order)</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_scanresults</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				      <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbss</span><span class="p">;</span>
	<span class="n">hfa384x_ScanResult_t</span> <span class="o">*</span><span class="n">sr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">scanresult</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">hfa384x_JoinRequest_data_t</span> <span class="n">joinreq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* Get the number of results, first in bytes, then in results */</span>
	<span class="n">nbss</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">))</span> <span class="o">-</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">infotype</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">scanresult</span><span class="p">.</span><span class="n">scanreason</span><span class="p">);</span>
	<span class="n">nbss</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_ScanResultSub_t</span><span class="p">);</span>

	<span class="cm">/* Print em */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;rx scanresults, reason=%d, nbss=%d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">scanresult</span><span class="p">.</span><span class="n">scanreason</span><span class="p">,</span> <span class="n">nbss</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbss</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;chid=%d anl=%d sl=%d bcnint=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">sr</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">chid</span><span class="p">,</span>
			 <span class="n">sr</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">anl</span><span class="p">,</span>
			 <span class="n">sr</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sl</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bcnint</span><span class="p">);</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;  capinfo=0x%04x proberesp_rate=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">sr</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">capinfo</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">proberesp_rate</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* issue a join request */</span>
	<span class="n">joinreq</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">chid</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">joinreq</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">sr</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_setconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					<span class="n">HFA384x_RID_JOINREQUEST</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">joinreq</span><span class="p">,</span> <span class="n">HFA384x_RID_JOINREQUEST_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;setconfig(joinreq) failed, result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_inf_hostscanresults</span>
<span class="cm">*</span>
<span class="cm">* Handles the receipt of a Scan Results info frame.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to info frame (contents in hfa384x order)</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_hostscanresults</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
					  <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nbss</span><span class="p">;</span>

	<span class="n">nbss</span> <span class="o">=</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Received %d hostscan results</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nbss</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nbss</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">nbss</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">scanresults</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">scanresults</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_InfFrame_t</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">scanresults</span><span class="p">,</span> <span class="n">inf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_InfFrame_t</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nbss</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">nbss</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Notify/wake the sleeping caller. */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">scanflag</span> <span class="o">=</span> <span class="n">nbss</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">cmdq</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_inf_chinforesults</span>
<span class="cm">*</span>
<span class="cm">* Handles the receipt of a Channel Info Results info frame.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to info frame (contents in hfa384x order)</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_chinforesults</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
					<span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_info</span><span class="p">.</span><span class="n">results</span><span class="p">.</span><span class="n">scanchannels</span> <span class="o">=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">chinforesult</span><span class="p">.</span><span class="n">scanchannels</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">HFA384x_CHINFORESULT_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_info</span><span class="p">.</span><span class="n">results</span><span class="p">.</span><span class="n">scanchannels</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">chinforesult</span><span class="p">.</span><span class="n">result</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">chid</span><span class="p">)</span> <span class="o">-</span>
			    <span class="mi">1</span><span class="p">;</span>
			<span class="n">hfa384x_ChInfoResultSub_t</span> <span class="o">*</span><span class="n">chinforesult</span> <span class="o">=</span>
			    <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_info</span><span class="p">.</span><span class="n">results</span><span class="p">.</span><span class="n">result</span><span class="p">[</span><span class="n">channel</span><span class="p">];</span>
			<span class="n">chinforesult</span><span class="o">-&gt;</span><span class="n">chid</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
			<span class="n">chinforesult</span><span class="o">-&gt;</span><span class="n">anl</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">chinforesult</span><span class="p">.</span><span class="n">result</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">anl</span><span class="p">);</span>
			<span class="n">chinforesult</span><span class="o">-&gt;</span><span class="n">pnl</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">chinforesult</span><span class="p">.</span><span class="n">result</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">pnl</span><span class="p">);</span>
			<span class="n">chinforesult</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">chinforesult</span><span class="p">.</span><span class="n">result</span><span class="p">[</span><span class="n">n</span><span class="p">].</span>
					<span class="n">active</span><span class="p">);</span>
	<span class="n">pr_debug</span>
		<span class="p">(</span><span class="s">&quot;chinfo: channel %d, %s level (avg/peak)=%d/%d dB, pcf %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">channel</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
			     <span class="n">chinforesult</span><span class="o">-&gt;</span>
			     <span class="n">active</span> <span class="o">&amp;</span> <span class="n">HFA384x_CHINFORESULT_BSSACTIVE</span> <span class="o">?</span> <span class="s">&quot;signal&quot;</span>
			     <span class="o">:</span> <span class="s">&quot;noise&quot;</span><span class="p">,</span> <span class="n">chinforesult</span><span class="o">-&gt;</span><span class="n">anl</span><span class="p">,</span> <span class="n">chinforesult</span><span class="o">-&gt;</span><span class="n">pnl</span><span class="p">,</span>
			     <span class="n">chinforesult</span><span class="o">-&gt;</span>
			     <span class="n">active</span> <span class="o">&amp;</span> <span class="n">HFA384x_CHINFORESULT_PCFACTIVE</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">n</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_info</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_info</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">prism2sta_processing_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hfa384x</span><span class="p">,</span> <span class="n">link_bh</span><span class="p">);</span>
	<span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wlandev</span><span class="p">;</span>
	<span class="n">hfa384x_bytestr32_t</span> <span class="n">ssid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="cm">/* First let&#39;s process the auth frames */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">authq</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">inf</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">prism2sta_inf_authreq_defer</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* Now let&#39;s handle the linkstatus stuff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">==</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status_new</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status_new</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HFA384x_LINK_NOTCONNECTED</span>:
		<span class="cm">/* I&#39;m currently assuming that this is the initial link</span>
<span class="cm">		 * state.  It should only be possible immediately</span>
<span class="cm">		 * following an Enable command.</span>
<span class="cm">		 * Response:</span>
<span class="cm">		 * Block Transmits, Ignore receives of data frames</span>
<span class="cm">		 */</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;linkstatus=NOTCONNECTED (unhandled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HFA384x_LINK_CONNECTED</span>:
		<span class="cm">/* This one indicates a successful scan/join/auth/assoc.</span>
<span class="cm">		 * When we have the full MLME complement, this event will</span>
<span class="cm">		 * signify successful completion of both mlme_authenticate</span>
<span class="cm">		 * and mlme_associate.  State management will get a little</span>
<span class="cm">		 * ugly here.</span>
<span class="cm">		 * Response:</span>
<span class="cm">		 * Indicate authentication and/or association</span>
<span class="cm">		 * Enable Transmits, Receives and pass up data frames</span>
<span class="cm">		 */</span>

		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="cm">/* If we are joining a specific AP, set our</span>
<span class="cm">		 * state and reset retries</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">join_ap</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">join_ap</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">join_retries</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>

		<span class="cm">/* Don&#39;t call this in monitor mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">portstatus</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;linkstatus=CONNECTED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* For non-usb devices, we can use the sync versions */</span>
			<span class="cm">/* Collect the BSSID, and set state to allow tx */</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">HFA384x_RID_CURRENTBSSID</span><span class="p">,</span>
						<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
						<span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span>
				    <span class="p">(</span><span class="s">&quot;getconfig(0x%02x) failed, result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">HFA384x_RID_CURRENTBSSID</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							<span class="n">HFA384x_RID_CURRENTSSID</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span>
				    <span class="p">(</span><span class="s">&quot;getconfig(0x%02x) failed, result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">HFA384x_RID_CURRENTSSID</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">prism2mgmt_bytestr2pstr</span><span class="p">((</span><span class="n">hfa384x_bytestr_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span>
						<span class="p">(</span><span class="n">p80211pstrd_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>

			<span class="cm">/* Collect the port status */</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig16</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
							<span class="n">HFA384x_RID_PORTSTATUS</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">portstatus</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span>
				    <span class="p">(</span><span class="s">&quot;getconfig(0x%02x) failed, result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">HFA384x_RID_PORTSTATUS</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">macmode</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">portstatus</span> <span class="o">==</span> <span class="n">HFA384x_PSTATUS_CONN_IBSS</span><span class="p">)</span> <span class="o">?</span>
			    <span class="n">WLAN_MACMODE_IBSS_STA</span> <span class="o">:</span> <span class="n">WLAN_MACMODE_ESS_STA</span><span class="p">;</span>

			<span class="cm">/* signal back up to cfg80211 layer */</span>
			<span class="n">prism2_connect_result</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">P80211ENUM_truth_false</span><span class="p">);</span>

			<span class="cm">/* Get the ball rolling on the comms quality stuff */</span>
			<span class="n">prism2sta_commsqual_defer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">commsqual_bh</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HFA384x_LINK_DISCONNECTED</span>:
		<span class="cm">/* This one indicates that our association is gone.  We&#39;ve</span>
<span class="cm">		 * lost connection with the AP and/or been disassociated.</span>
<span class="cm">		 * This indicates that the MAC has completely cleared it&#39;s</span>
<span class="cm">		 * associated state.  We * should send a deauth indication</span>
<span class="cm">		 * (implying disassoc) up * to the MLME.</span>
<span class="cm">		 * Response:</span>
<span class="cm">		 * Indicate Deauthentication</span>
<span class="cm">		 * Block Transmits, Ignore receives of data frames</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;linkstatus=DISCONNECTED (unhandled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">macmode</span> <span class="o">=</span> <span class="n">WLAN_MACMODE_NONE</span><span class="p">;</span>

		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="cm">/* signal back up to cfg80211 layer */</span>
		<span class="n">prism2_disconnected</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HFA384x_LINK_AP_CHANGE</span>:
		<span class="cm">/* This one indicates that the MAC has decided to and</span>
<span class="cm">		 * successfully completed a change to another AP.  We</span>
<span class="cm">		 * should probably implement a reassociation indication</span>
<span class="cm">		 * in response to this one.  I&#39;m thinking that the the</span>
<span class="cm">		 * p80211 layer needs to be notified in case of</span>
<span class="cm">		 * buffering/queueing issues.  User mode also needs to be</span>
<span class="cm">		 * notified so that any BSS dependent elements can be</span>
<span class="cm">		 * updated.</span>
<span class="cm">		 * associated state.  We * should send a deauth indication</span>
<span class="cm">		 * (implying disassoc) up * to the MLME.</span>
<span class="cm">		 * Response:</span>
<span class="cm">		 * Indicate Reassociation</span>
<span class="cm">		 * Enable Transmits, Receives and pass up data frames</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;linkstatus=AP_CHANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">HFA384x_RID_CURRENTBSSID</span><span class="p">,</span>
						<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;getconfig(0x%02x) failed, result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">HFA384x_RID_CURRENTBSSID</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
						<span class="n">HFA384x_RID_CURRENTSSID</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;getconfig(0x%02x) failed, result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">HFA384x_RID_CURRENTSSID</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prism2mgmt_bytestr2pstr</span><span class="p">((</span><span class="n">hfa384x_bytestr_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span>
					<span class="p">(</span><span class="n">p80211pstrd_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">HFA384x_LINK_CONNECTED</span><span class="p">;</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="cm">/* signal back up to cfg80211 layer */</span>
		<span class="n">prism2_roamed</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HFA384x_LINK_AP_OUTOFRANGE</span>:
		<span class="cm">/* This one indicates that the MAC has decided that the</span>
<span class="cm">		 * AP is out of range, but hasn&#39;t found a better candidate</span>
<span class="cm">		 * so the MAC maintains its &quot;associated&quot; state in case</span>
<span class="cm">		 * we get back in range.  We should block transmits and</span>
<span class="cm">		 * receives in this state.  Do we need an indication here?</span>
<span class="cm">		 * Probably not since a polling user-mode element would</span>
<span class="cm">		 * get this status from from p2PortStatus(FD40). What about</span>
<span class="cm">		 * p80211?</span>
<span class="cm">		 * Response:</span>
<span class="cm">		 * Block Transmits, Ignore receives of data frames</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;linkstatus=AP_OUTOFRANGE (unhandled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HFA384x_LINK_AP_INRANGE</span>:
		<span class="cm">/* This one indicates that the MAC has decided that the</span>
<span class="cm">		 * AP is back in range.  We continue working with our</span>
<span class="cm">		 * existing association.</span>
<span class="cm">		 * Response:</span>
<span class="cm">		 * Enable Transmits, Receives and pass up data frames</span>
<span class="cm">		 */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;linkstatus=AP_INRANGE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">=</span> <span class="n">HFA384x_LINK_CONNECTED</span><span class="p">;</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">HFA384x_LINK_ASSOCFAIL</span>:
		<span class="cm">/* This one is actually a peer to CONNECTED.  We&#39;ve</span>
<span class="cm">		 * requested a join for a given SSID and optionally BSSID.</span>
<span class="cm">		 * We can use this one to indicate authentication and</span>
<span class="cm">		 * association failures.  The trick is going to be</span>
<span class="cm">		 * 1) identifying the failure, and 2) state management.</span>
<span class="cm">		 * Response:</span>
<span class="cm">		 * Disable Transmits, Ignore receives of data frames</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">join_ap</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">join_retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hfa384x_JoinRequest_data_t</span> <span class="n">joinreq</span><span class="p">;</span>
			<span class="n">joinreq</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">joinreq</span><span class="p">;</span>
			<span class="cm">/* Send the join request */</span>
			<span class="n">hfa384x_drvr_setconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					       <span class="n">HFA384x_RID_JOINREQUEST</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">joinreq</span><span class="p">,</span>
					       <span class="n">HFA384x_RID_JOINREQUEST_LEN</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;linkstatus=ASSOCFAIL (re-submitting join)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;linkstatus=ASSOCFAIL (unhandled)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>

		<span class="cm">/* signal back up to cfg80211 layer */</span>
		<span class="n">prism2_connect_result</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">P80211ENUM_truth_true</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* This is bad, IO port problems? */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;unknown linkstatus=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">linkstatus</span> <span class="o">=</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status</span> <span class="o">==</span> <span class="n">HFA384x_LINK_CONNECTED</span><span class="p">);</span>

<span class="nl">failed:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_inf_linkstatus</span>
<span class="cm">*</span>
<span class="cm">* Handles the receipt of a Link Status info frame.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to info frame (contents in hfa384x order)</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_linkstatus</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				     <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_status_new</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">linkstatus</span><span class="p">.</span><span class="n">linkstatus</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_bh</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_inf_assocstatus</span>
<span class="cm">*</span>
<span class="cm">* Handles the receipt of an Association Status info frame. Should</span>
<span class="cm">* be present in APs only.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to info frame (contents in hfa384x order)</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_assocstatus</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				      <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">hfa384x_AssocStatus_t</span> <span class="n">rec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">assocstatus</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">));</span>
	<span class="n">rec</span><span class="p">.</span><span class="n">assocstatus</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">assocstatus</span><span class="p">);</span>
	<span class="n">rec</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">reason</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 ** Find the address in the list of authenticated stations.</span>
<span class="cm">	 ** If it wasn&#39;t found, then this address has not been previously</span>
<span class="cm">	 ** authenticated and something weird has happened if this is</span>
<span class="cm">	 ** anything other than an &quot;authentication failed&quot; message.</span>
<span class="cm">	 ** If the address was found, then set the &quot;associated&quot; flag for</span>
<span class="cm">	 ** that station, based on whether the station is associating or</span>
<span class="cm">	 ** losing its association.  Something weird has also happened</span>
<span class="cm">	 ** if we find the address in the list of authenticated stations</span>
<span class="cm">	 ** but we are getting an &quot;authentication failed&quot; message.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">sta_addr</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">assocstatus</span> <span class="o">!=</span> <span class="n">HFA384x_ASSOCSTATUS_AUTHFAIL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
	<span class="s">&quot;assocstatus info frame received for non-authenticated station.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">assoc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">assocstatus</span> <span class="o">==</span> <span class="n">HFA384x_ASSOCSTATUS_STAASSOC</span> <span class="o">||</span>
		     <span class="n">rec</span><span class="p">.</span><span class="n">assocstatus</span> <span class="o">==</span> <span class="n">HFA384x_ASSOCSTATUS_REASSOC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">assocstatus</span> <span class="o">==</span> <span class="n">HFA384x_ASSOCSTATUS_AUTHFAIL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
<span class="s">&quot;authfail assocstatus info frame received for authenticated station.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_inf_authreq</span>
<span class="cm">*</span>
<span class="cm">* Handles the receipt of an Authentication Request info frame. Should</span>
<span class="cm">* be present in APs only.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to info frame (contents in hfa384x order)</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">*</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_authreq</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				  <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inf</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">inf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">inf</span><span class="p">));</span>
		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">authq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">link_bh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_authreq_defer</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
					<span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">hfa384x_authenticateStation_data_t</span> <span class="n">rec</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 ** Build the AuthenticateStation record.  Initialize it for denying</span>
<span class="cm">	 ** authentication.</span>
<span class="cm">	 */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">authreq</span><span class="p">.</span><span class="n">sta_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">rec</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">P80211ENUM_status_unspec_failure</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 ** Authenticate based on the access mode.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">accessmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_ACCESS_NONE</span>:

		<span class="cm">/*</span>
<span class="cm">		 ** Deny all new authentications.  However, if a station</span>
<span class="cm">		 ** is ALREADY authenticated, then accept it.</span>
<span class="cm">		 */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				   <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rec</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">P80211ENUM_status_successful</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_ACCESS_ALL</span>:

		<span class="cm">/*</span>
<span class="cm">		 ** Allow all authentications.</span>
<span class="cm">		 */</span>

		<span class="n">rec</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">P80211ENUM_status_successful</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_ACCESS_ALLOW</span>:

		<span class="cm">/*</span>
<span class="cm">		 ** Only allow the authentication if the MAC address</span>
<span class="cm">		 ** is in the list of allowed addresses.</span>
<span class="cm">		 **</span>
<span class="cm">		 ** Since this is the interrupt handler, we may be here</span>
<span class="cm">		 ** while the access list is in the middle of being</span>
<span class="cm">		 ** updated.  Choose the list which is currently okay.</span>
<span class="cm">		 ** See &quot;prism2mib_priv_accessallow()&quot; for details.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">allow</span><span class="p">.</span><span class="n">modify</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">allow</span><span class="p">.</span><span class="n">cnt</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">allow</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">allow</span><span class="p">.</span><span class="n">cnt1</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">allow</span><span class="p">.</span><span class="n">addr1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rec</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">P80211ENUM_status_successful</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_ACCESS_DENY</span>:

		<span class="cm">/*</span>
<span class="cm">		 ** Allow the authentication UNLESS the MAC address is</span>
<span class="cm">		 ** in the list of denied addresses.</span>
<span class="cm">		 **</span>
<span class="cm">		 ** Since this is the interrupt handler, we may be here</span>
<span class="cm">		 ** while the access list is in the middle of being</span>
<span class="cm">		 ** updated.  Choose the list which is currently okay.</span>
<span class="cm">		 ** See &quot;prism2mib_priv_accessdeny()&quot; for details.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">deny</span><span class="p">.</span><span class="n">modify</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">deny</span><span class="p">.</span><span class="n">cnt</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">deny</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cnt</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">deny</span><span class="p">.</span><span class="n">cnt1</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">deny</span><span class="p">.</span><span class="n">addr1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">rec</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">P80211ENUM_status_successful</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rec</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">P80211ENUM_status_unspec_failure</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 ** If the authentication is okay, then add the MAC address to the</span>
<span class="cm">	 ** list of authenticated stations.  Don&#39;t add the address if it</span>
<span class="cm">	 ** is already in the list. (802.11b does not seem to disallow</span>
<span class="cm">	 ** a station from issuing an authentication request when the</span>
<span class="cm">	 ** station is already authenticated. Does this sort of thing</span>
<span class="cm">	 ** ever happen?  We might as well do the check just in case.)</span>
<span class="cm">	 */</span>

	<span class="n">added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">P80211ENUM_status_successful</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ETH_ALEN</span><span class="p">)</span>
			    <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">cnt</span> <span class="o">&gt;=</span> <span class="n">WLAN_AUTH_MAX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rec</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">P80211ENUM_status_ap_full</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">addr</span><span class="p">[</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">cnt</span><span class="p">],</span>
				       <span class="n">rec</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
				<span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">added</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 ** Send back the results of the authentication.  If this doesn&#39;t work,</span>
<span class="cm">	 ** then make sure to remove the address from the authenticated list if</span>
<span class="cm">	 ** it was added.</span>
<span class="cm">	 */</span>

	<span class="n">rec</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">rec</span><span class="p">.</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">authreq</span><span class="p">.</span><span class="n">algorithm</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_setconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_AUTHENTICATESTA</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">added</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">authlist</span><span class="p">.</span><span class="n">cnt</span><span class="o">--</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;setconfig(authenticatestation) failed, result=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_inf_psusercnt</span>
<span class="cm">*</span>
<span class="cm">* Handles the receipt of a PowerSaveUserCount info frame. Should</span>
<span class="cm">* be present in APs only.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to info frame (contents in hfa384x order)</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2sta_inf_psusercnt</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span>
				    <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">psusercount</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">psusercnt</span><span class="p">.</span><span class="n">usercnt</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_ev_info</span>
<span class="cm">*</span>
<span class="cm">* Handles the Info event.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	inf		ptr to a generic info frame</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">prism2sta_ev_info</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">hfa384x_InfFrame_t</span> <span class="o">*</span><span class="n">inf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">inf</span><span class="o">-&gt;</span><span class="n">infotype</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">infotype</span><span class="p">);</span>
	<span class="cm">/* Dispatch */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">inf</span><span class="o">-&gt;</span><span class="n">infotype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_HANDOVERADDR</span>:
		<span class="n">prism2sta_inf_handover</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_COMMTALLIES</span>:
		<span class="n">prism2sta_inf_tallies</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_HOSTSCANRESULTS</span>:
		<span class="n">prism2sta_inf_hostscanresults</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_SCANRESULTS</span>:
		<span class="n">prism2sta_inf_scanresults</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_CHINFORESULTS</span>:
		<span class="n">prism2sta_inf_chinforesults</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_LINKSTATUS</span>:
		<span class="n">prism2sta_inf_linkstatus</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_ASSOCSTATUS</span>:
		<span class="n">prism2sta_inf_assocstatus</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_AUTHREQ</span>:
		<span class="n">prism2sta_inf_authreq</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_PSUSERCNT</span>:
		<span class="n">prism2sta_inf_psusercnt</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">inf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_KEYIDCHANGED</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unhandled IT_KEYIDCHANGED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_ASSOCREQ</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unhandled IT_ASSOCREQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_IT_MICFAILURE</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Unhandled IT_MICFAILURE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;Unknown info type=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inf</span><span class="o">-&gt;</span><span class="n">infotype</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_ev_txexc</span>
<span class="cm">*</span>
<span class="cm">* Handles the TxExc event.  A Transmit Exception event indicates</span>
<span class="cm">* that the MAC&#39;s TX process was unsuccessful - so the packet did</span>
<span class="cm">* not get transmitted.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	status		tx frame status word</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">prism2sta_ev_txexc</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;TxExc status=0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_ev_tx</span>
<span class="cm">*</span>
<span class="cm">* Handles the Tx event.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*	status		tx frame status word</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">prism2sta_ev_tx</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Tx Complete, status=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="cm">/* update linux network stats */</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">linux_stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_ev_rx</span>
<span class="cm">*</span>
<span class="cm">* Handles the Rx event.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">prism2sta_ev_rx</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p80211netdev_rx</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* prism2sta_ev_alloc</span>
<span class="cm">*</span>
<span class="cm">* Handles the Alloc event.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	wlandev		wlan device structure</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	nothing</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	interrupt</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="kt">void</span> <span class="nf">prism2sta_ev_alloc</span><span class="p">(</span><span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*----------------------------------------------------------------</span>
<span class="cm">* create_wlan</span>
<span class="cm">*</span>
<span class="cm">* Called at module init time.  This creates the wlandevice_t structure</span>
<span class="cm">* and initializes it with relevant bits.</span>
<span class="cm">*</span>
<span class="cm">* Arguments:</span>
<span class="cm">*	none</span>
<span class="cm">*</span>
<span class="cm">* Returns:</span>
<span class="cm">*	the created wlandevice_t structure.</span>
<span class="cm">*</span>
<span class="cm">* Side effects:</span>
<span class="cm">*	also allocates the priv/hw structures.</span>
<span class="cm">*</span>
<span class="cm">* Call context:</span>
<span class="cm">*	process thread</span>
<span class="cm">*</span>
<span class="cm">----------------------------------------------------------------*/</span>
<span class="k">static</span> <span class="n">wlandevice_t</span> <span class="o">*</span><span class="nf">create_wlan</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Alloc our structures */</span>
	<span class="n">wlandev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wlandevice_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">hw</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wlandev</span> <span class="o">||</span> <span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Memory allocation failure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">wlandev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear all the structs */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wlandevice_t</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hfa384x_t</span><span class="p">));</span>

	<span class="cm">/* Initialize the network device object. */</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">nsdname</span> <span class="o">=</span> <span class="n">dev_info</span><span class="p">;</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">msdstate</span> <span class="o">=</span> <span class="n">WLAN_MSD_HWPRESENT_PENDING</span><span class="p">;</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">prism2sta_open</span><span class="p">;</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">prism2sta_close</span><span class="p">;</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">reset</span> <span class="o">=</span> <span class="n">prism2sta_reset</span><span class="p">;</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">txframe</span> <span class="o">=</span> <span class="n">prism2sta_txframe</span><span class="p">;</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">mlmerequest</span> <span class="o">=</span> <span class="n">prism2sta_mlmerequest</span><span class="p">;</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">set_multicast_list</span> <span class="o">=</span> <span class="n">prism2sta_setmulticast</span><span class="p">;</span>
	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">tx_timeout</span> <span class="o">=</span> <span class="n">hfa384x_tx_timeout</span><span class="p">;</span>

	<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">nsdcaps</span> <span class="o">=</span> <span class="n">P80211_NSDCAP_HWFRAGMENT</span> <span class="o">|</span> <span class="n">P80211_NSDCAP_AUTOJOIN</span><span class="p">;</span>

	<span class="cm">/* Initialize the device private data structure. */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">dot11_desired_bss_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wlandev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">prism2sta_commsqual_defer</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hfa384x</span><span class="p">,</span> <span class="n">commsqual_bh</span><span class="p">);</span>
	<span class="n">wlandevice_t</span> <span class="o">*</span><span class="n">wlandev</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wlandev</span><span class="p">;</span>
	<span class="n">hfa384x_bytestr32_t</span> <span class="n">ssid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p80211msg_dot11req_mibget</span> <span class="n">msg</span><span class="p">;</span>
	<span class="n">p80211item_uint32_t</span> <span class="o">*</span><span class="n">mibitem</span> <span class="o">=</span> <span class="p">(</span><span class="n">p80211item_uint32_t</span> <span class="o">*</span><span class="p">)</span>
						<span class="o">&amp;</span><span class="n">msg</span><span class="p">.</span><span class="n">mibattribute</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">hwremoved</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* we don&#39;t care if we&#39;re in AP mode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">macmode</span> <span class="o">==</span> <span class="n">WLAN_MACMODE_NONE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">macmode</span> <span class="o">==</span> <span class="n">WLAN_MACMODE_ESS_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* It only makes sense to poll these in non-IBSS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">macmode</span> <span class="o">!=</span> <span class="n">WLAN_MACMODE_IBSS_STA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span>
				<span class="n">hw</span><span class="p">,</span> <span class="n">HFA384x_RID_DBMCOMMSQUALITY</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">,</span> <span class="n">HFA384x_RID_DBMCOMMSQUALITY_LEN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;error fetching commsqual</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;commsqual %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">CQ_currBSS</span><span class="p">),</span>
			 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">ASL_currBSS</span><span class="p">),</span>
			 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">ANL_currFC</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Get the signal rate */</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">msgcode</span> <span class="o">=</span> <span class="n">DIDmsg_dot11req_mibget</span><span class="p">;</span>
	<span class="n">mibitem</span><span class="o">-&gt;</span><span class="n">did</span> <span class="o">=</span> <span class="n">DIDmib_p2_p2MAC_p2CurrentTxRate</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">p80211req_dorequest</span><span class="p">(</span><span class="n">wlandev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;get signal rate failed, result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mibitem</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HFA384x_RATEBIT_1</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_RATEBIT_2</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_RATEBIT_5dot5</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384x_RATEBIT_11</span>:
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Bad ratebit (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mibitem</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Lastly, we need to make sure the BSSID didn&#39;t change on us */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					<span class="n">HFA384x_RID_CURRENTBSSID</span><span class="p">,</span>
					<span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">WLAN_BSSID_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;getconfig(0x%02x) failed, result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">HFA384x_RID_CURRENTBSSID</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">hfa384x_drvr_getconfig</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span>
					<span class="n">HFA384x_RID_CURRENTSSID</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;getconfig(0x%02x) failed, result = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">HFA384x_RID_CURRENTSSID</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">prism2mgmt_bytestr2pstr</span><span class="p">((</span><span class="n">hfa384x_bytestr_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span>
				<span class="p">(</span><span class="n">p80211pstrd_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">wlandev</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>

	<span class="cm">/* Reschedule timer */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">commsqual_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">prism2sta_commsqual_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hfa384x_t</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="p">(</span><span class="n">hfa384x_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">commsqual_bh</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
