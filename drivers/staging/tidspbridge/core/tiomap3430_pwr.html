<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › tidspbridge › core › tiomap3430_pwr.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>tiomap3430_pwr.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * tiomap_pwr.c</span>
<span class="cm"> *</span>
<span class="cm"> * DSP-BIOS Bridge driver support functions for TI OMAP processors.</span>
<span class="cm"> *</span>
<span class="cm"> * Implementation of DSP wake/sleep routines.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007-2008 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This package is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS PACKAGE IS PROVIDED ``AS IS&#39;&#39; AND WITHOUT ANY EXPRESS OR</span>
<span class="cm"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
<span class="cm"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm"> */</span>

<span class="cm">/*  ----------------------------------- Host OS */</span>
<span class="cp">#include &lt;dspbridge/host_os.h&gt;</span>

<span class="cp">#include &lt;plat/dsp.h&gt;</span>

<span class="cm">/*  ----------------------------------- DSP/BIOS Bridge */</span>
<span class="cp">#include &lt;dspbridge/dbdefs.h&gt;</span>
<span class="cp">#include &lt;dspbridge/drv.h&gt;</span>
<span class="cp">#include &lt;dspbridge/io_sm.h&gt;</span>

<span class="cm">/*  ----------------------------------- Platform Manager */</span>
<span class="cp">#include &lt;dspbridge/brddefs.h&gt;</span>
<span class="cp">#include &lt;dspbridge/dev.h&gt;</span>
<span class="cp">#include &lt;dspbridge/io.h&gt;</span>

<span class="cm">/* ------------------------------------ Hardware Abstraction Layer */</span>
<span class="cp">#include &lt;hw_defs.h&gt;</span>
<span class="cp">#include &lt;hw_mmu.h&gt;</span>

<span class="cp">#include &lt;dspbridge/pwr.h&gt;</span>

<span class="cm">/*  ----------------------------------- Bridge Driver */</span>
<span class="cp">#include &lt;dspbridge/dspdeh.h&gt;</span>
<span class="cp">#include &lt;dspbridge/wdt.h&gt;</span>

<span class="cm">/*  ----------------------------------- specific to this file */</span>
<span class="cp">#include &quot;_tiomap.h&quot;</span>
<span class="cp">#include &quot;_tiomap_pwr.h&quot;</span>
<span class="cp">#include &lt;mach-omap2/prm-regbits-34xx.h&gt;</span>
<span class="cp">#include &lt;mach-omap2/cm-regbits-34xx.h&gt;</span>

<span class="cp">#define PWRSTST_TIMEOUT          200</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== handle_constraints_set ========</span>
<span class="cm"> *  	Sets new DSP constraint</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">handle_constraints_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">bridge_dev_context</span> <span class="o">*</span><span class="n">dev_context</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">pargs</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_TIDSPBRIDGE_DVFS</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">constraint_val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dsp_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span>
		<span class="n">omap_dspbridge_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">constraint_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pargs</span><span class="p">);</span>
	<span class="cm">/* Read the target value requested by DSP */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;OPP: %s opp requested = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">constraint_val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* Set the new opp value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_set_min_opp</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_set_min_opp</span><span class="p">)</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span><span class="p">(</span><span class="n">constraint_val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_TIDSPBRIDGE_DVFS */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== handle_hibernation_from_dsp ========</span>
<span class="cm"> *  	Handle Hibernation requested from DSP</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">handle_hibernation_from_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bridge_dev_context</span> <span class="o">*</span><span class="n">dev_context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="n">u16</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">PWRSTST_TIMEOUT</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pwr_state</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TIDSPBRIDGE_DVFS</span>
	<span class="n">u32</span> <span class="n">opplevel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_mgr</span> <span class="o">*</span><span class="n">hio_mgr</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">struct</span> <span class="n">omap_dsp_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span>
		<span class="n">omap_dspbridge_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="n">pwr_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_prm_read</span><span class="p">)(</span><span class="n">OMAP3430_IVA2_MOD</span><span class="p">,</span> <span class="n">OMAP2_PM_PWSTST</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">OMAP_POWERSTATEST_MASK</span><span class="p">;</span>
	<span class="cm">/* Wait for DSP to move into OFF state */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">pwr_state</span> <span class="o">!=</span> <span class="n">PWRDM_POWER_OFF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Waiting for DSP OFF mode interrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pwr_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_prm_read</span><span class="p">)(</span><span class="n">OMAP3430_IVA2_MOD</span><span class="p">,</span>
					<span class="n">OMAP2_PM_PWSTST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OMAP_POWERSTATEST_MASK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Timed out waiting for DSP off mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* Save mailbox settings */</span>
		<span class="n">omap_mbox_save_ctx</span><span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">);</span>

		<span class="cm">/* Turn off DSP Peripheral clocks and DSP Load monitor timer */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dsp_clock_disable_all</span><span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">dsp_per_clks</span><span class="p">);</span>

		<span class="cm">/* Disable wdt on hibernation. */</span>
		<span class="n">dsp_wdt_enable</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Update the Bridger Driver state */</span>
			<span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">=</span> <span class="n">BRD_DSP_HIBERNATION</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TIDSPBRIDGE_DVFS</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">dev_get_io_mgr</span><span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hio_mgr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hio_mgr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">DSP_EHANDLE</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">io_sh_msetting</span><span class="p">(</span><span class="n">hio_mgr</span><span class="p">,</span> <span class="n">SHM_GETOPP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opplevel</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Set the OPP to low level before moving to OFF</span>
<span class="cm">			 * mode</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_set_min_opp</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_set_min_opp</span><span class="p">)</span> <span class="p">(</span><span class="n">VDD1_OPP1</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_TIDSPBRIDGE_DVFS */</span><span class="cp"></span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== sleep_dsp ========</span>
<span class="cm"> *  	Put DSP in low power consuming state.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sleep_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bridge_dev_context</span> <span class="o">*</span><span class="n">dev_context</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dw_cmd</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">pargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>
<span class="cp">#ifdef CONFIG_TIDSPBRIDGE_NTFY_PWRERR</span>
	<span class="k">struct</span> <span class="n">deh_mgr</span> <span class="o">*</span><span class="n">hdeh_mgr</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_TIDSPBRIDGE_NTFY_PWRERR */</span><span class="cp"></span>
	<span class="n">u16</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">PWRSTST_TIMEOUT</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pwr_state</span><span class="p">,</span> <span class="n">target_pwr_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">omap_dsp_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span>
		<span class="n">omap_dspbridge_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="cm">/* Check if sleep code is valid */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dw_cmd</span> <span class="o">!=</span> <span class="n">PWR_DEEPSLEEP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dw_cmd</span> <span class="o">!=</span> <span class="n">PWR_EMERGENCYDEEPSLEEP</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BRD_RUNNING</span>:
		<span class="n">omap_mbox_save_ctx</span><span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_test_sleepstate</span> <span class="o">==</span> <span class="n">PWRDM_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sm_interrupt_dsp</span><span class="p">(</span><span class="n">dev_context</span><span class="p">,</span> <span class="n">MBX_PM_DSPHIBERNATE</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;PM: %s - sent hibernate cmd to DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">target_pwr_state</span> <span class="o">=</span> <span class="n">PWRDM_POWER_OFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sm_interrupt_dsp</span><span class="p">(</span><span class="n">dev_context</span><span class="p">,</span> <span class="n">MBX_PM_DSPRETENTION</span><span class="p">);</span>
			<span class="n">target_pwr_state</span> <span class="o">=</span> <span class="n">PWRDM_POWER_RET</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRD_RETENTION</span>:
		<span class="n">omap_mbox_save_ctx</span><span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_test_sleepstate</span> <span class="o">==</span> <span class="n">PWRDM_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sm_interrupt_dsp</span><span class="p">(</span><span class="n">dev_context</span><span class="p">,</span> <span class="n">MBX_PM_DSPHIBERNATE</span><span class="p">);</span>
			<span class="n">target_pwr_state</span> <span class="o">=</span> <span class="n">PWRDM_POWER_OFF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRD_HIBERNATION</span>:
	<span class="k">case</span> <span class="n">BRD_DSP_HIBERNATION</span>:
		<span class="cm">/* Already in Hibernation, so just return */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;PM: %s - DSP already in hibernation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BRD_STOPPED</span>:
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;PM: %s - Board in STOP state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;PM: %s - Bridge in Illegal state</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the PRCM DSP power domain status */</span>
	<span class="n">pwr_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_prm_read</span><span class="p">)(</span><span class="n">OMAP3430_IVA2_MOD</span><span class="p">,</span> <span class="n">OMAP2_PM_PWSTST</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="n">OMAP_POWERSTATEST_MASK</span><span class="p">;</span>

	<span class="cm">/* Wait for DSP to move into target power state */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">pwr_state</span> <span class="o">!=</span> <span class="n">target_pwr_state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Waiting for DSP to Suspend interrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pwr_state</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_prm_read</span><span class="p">)(</span><span class="n">OMAP3430_IVA2_MOD</span><span class="p">,</span>
					<span class="n">OMAP2_PM_PWSTST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">OMAP_POWERSTATEST_MASK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Timed out waiting for DSP off mode, state %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">pwr_state</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_TIDSPBRIDGE_NTFY_PWRERR</span>
		<span class="n">dev_get_deh_mgr</span><span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdeh_mgr</span><span class="p">);</span>
		<span class="n">bridge_deh_notify</span><span class="p">(</span><span class="n">hdeh_mgr</span><span class="p">,</span> <span class="n">DSP_PWRERROR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_TIDSPBRIDGE_NTFY_PWRERR */</span><span class="cp"></span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Update the Bridger Driver state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dsp_test_sleepstate</span> <span class="o">==</span> <span class="n">PWRDM_POWER_OFF</span><span class="p">)</span>
			<span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">=</span> <span class="n">BRD_HIBERNATION</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">=</span> <span class="n">BRD_RETENTION</span><span class="p">;</span>

		<span class="cm">/* Disable wdt on hibernation. */</span>
		<span class="n">dsp_wdt_enable</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

		<span class="cm">/* Turn off DSP Peripheral clocks */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dsp_clock_disable_all</span><span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">dsp_per_clks</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TIDSPBRIDGE_DVFS</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">target_pwr_state</span> <span class="o">==</span> <span class="n">PWRDM_POWER_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Set the OPP to low level before moving to OFF mode</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_set_min_opp</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dsp_set_min_opp</span><span class="p">)</span> <span class="p">(</span><span class="n">VDD1_OPP1</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_TIDSPBRIDGE_DVFS */</span><span class="cp"></span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== wake_dsp ========</span>
<span class="cm"> *  	Wake up DSP from sleep.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wake_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bridge_dev_context</span> <span class="o">*</span><span class="n">dev_context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PM</span>

	<span class="cm">/* Check the board state, if it is not &#39;SLEEP&#39; then return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_RUNNING</span> <span class="o">||</span>
	    <span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The Device is in &#39;RET&#39; or &#39;OFF&#39; state and Bridge state is not</span>
<span class="cm">		 * &#39;SLEEP&#39;, this means state inconsistency, so return */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send a wakeup message to DSP */</span>
	<span class="n">sm_interrupt_dsp</span><span class="p">(</span><span class="n">dev_context</span><span class="p">,</span> <span class="n">MBX_PM_DSPWAKEUP</span><span class="p">);</span>

	<span class="cm">/* Set the device state to RUNNIG */</span>
	<span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">=</span> <span class="n">BRD_RUNNING</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dsp_peripheral_clk_ctrl ========</span>
<span class="cm"> *  	Enable/Disable the DSP peripheral clocks as needed..</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dsp_peripheral_clk_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">bridge_dev_context</span> <span class="o">*</span><span class="n">dev_context</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">pargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ext_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext_clk_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ext_clk_cmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">clk_id_index</span> <span class="o">=</span> <span class="n">MBX_PM_MAX_RESOURCES</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dsp_per_clks_before</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dsp_per_clks_before</span> <span class="o">=</span> <span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">dsp_per_clks</span><span class="p">;</span>

	<span class="n">ext_clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pargs</span><span class="p">);</span>
	<span class="n">ext_clk_id</span> <span class="o">=</span> <span class="n">ext_clk</span> <span class="o">&amp;</span> <span class="n">MBX_PM_CLK_IDMASK</span><span class="p">;</span>

	<span class="cm">/* process the power message -- TODO, keep it in a separate function */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tmp_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp_index</span> <span class="o">&lt;</span> <span class="n">MBX_PM_MAX_RESOURCES</span><span class="p">;</span> <span class="n">tmp_index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ext_clk_id</span> <span class="o">==</span> <span class="n">bpwr_clkid</span><span class="p">[</span><span class="n">tmp_index</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">clk_id_index</span> <span class="o">=</span> <span class="n">tmp_index</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* TODO -- Assert may be a too hard restriction here.. May be we should</span>
<span class="cm">	 * just return with failure when the CLK ID does not match */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clk_id_index</span> <span class="o">==</span> <span class="n">MBX_PM_MAX_RESOURCES</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* return with a more meaningfull error code */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ext_clk_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">ext_clk</span> <span class="o">&gt;&gt;</span> <span class="n">MBX_PM_CLK_CMDSHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MBX_PM_CLK_CMDMASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ext_clk_cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BPWR_DISABLE_CLOCK</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">dsp_clk_disable</span><span class="p">(</span><span class="n">bpwr_clks</span><span class="p">[</span><span class="n">clk_id_index</span><span class="p">].</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">dsp_clk_wakeup_event_ctrl</span><span class="p">(</span><span class="n">bpwr_clks</span><span class="p">[</span><span class="n">clk_id_index</span><span class="p">].</span><span class="n">clk_id</span><span class="p">,</span>
					  <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">dsp_per_clks</span><span class="p">)</span> <span class="o">&amp;=</span>
				<span class="p">(</span><span class="o">~</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bpwr_clks</span><span class="p">[</span><span class="n">clk_id_index</span><span class="p">].</span><span class="n">clk</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BPWR_ENABLE_CLOCK</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">dsp_clk_enable</span><span class="p">(</span><span class="n">bpwr_clks</span><span class="p">[</span><span class="n">clk_id_index</span><span class="p">].</span><span class="n">clk</span><span class="p">);</span>
		<span class="n">dsp_clk_wakeup_event_ctrl</span><span class="p">(</span><span class="n">bpwr_clks</span><span class="p">[</span><span class="n">clk_id_index</span><span class="p">].</span><span class="n">clk_id</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">dsp_per_clks</span><span class="p">)</span> <span class="o">|=</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bpwr_clks</span><span class="p">[</span><span class="n">clk_id_index</span><span class="p">].</span><span class="n">clk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: Unsupported CMD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="cm">/* unsupported cmd */</span>
		<span class="cm">/* TODO -- provide support for AUTOIDLE Enable/Disable</span>
<span class="cm">		 * commands */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ========pre_scale_dsp========</span>
<span class="cm"> *  Sends prescale notification to DSP</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pre_scale_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bridge_dev_context</span> <span class="o">*</span><span class="n">dev_context</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pargs</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_TIDSPBRIDGE_DVFS</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">voltage_domain</span><span class="p">;</span>

	<span class="n">voltage_domain</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pargs</span><span class="p">);</span>
	<span class="n">level</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pargs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;OPP: %s voltage_domain = %x, level = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">voltage_domain</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_HIBERNATION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_RETENTION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_DSP_HIBERNATION</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;OPP: %s IVA in sleep. No message to DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_RUNNING</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Send a prenotificatio to DSP */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;OPP: %s sent notification to DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">sm_interrupt_dsp</span><span class="p">(</span><span class="n">dev_context</span><span class="p">,</span> <span class="n">MBX_PM_SETPOINT_PRENOTIFY</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_TIDSPBRIDGE_DVFS */</span><span class="cp"></span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ========post_scale_dsp========</span>
<span class="cm"> *  Sends postscale notification to DSP</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">post_scale_dsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">bridge_dev_context</span> <span class="o">*</span><span class="n">dev_context</span><span class="p">,</span>
							<span class="kt">void</span> <span class="o">*</span><span class="n">pargs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_TIDSPBRIDGE_DVFS</span>
	<span class="n">u32</span> <span class="n">level</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">voltage_domain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">io_mgr</span> <span class="o">*</span><span class="n">hio_mgr</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dev_get_io_mgr</span><span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hio_mgr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hio_mgr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">voltage_domain</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pargs</span><span class="p">);</span>
	<span class="n">level</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pargs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;OPP: %s voltage_domain = %x, level = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">voltage_domain</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_HIBERNATION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_RETENTION</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_DSP_HIBERNATION</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Update the OPP value in shared memory */</span>
		<span class="n">io_sh_msetting</span><span class="p">(</span><span class="n">hio_mgr</span><span class="p">,</span> <span class="n">SHM_CURROPP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;OPP: %s IVA in sleep. Wrote to shm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev_context</span><span class="o">-&gt;</span><span class="n">brd_state</span> <span class="o">==</span> <span class="n">BRD_RUNNING</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Update the OPP value in shared memory */</span>
		<span class="n">io_sh_msetting</span><span class="p">(</span><span class="n">hio_mgr</span><span class="p">,</span> <span class="n">SHM_CURROPP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">level</span><span class="p">);</span>
		<span class="cm">/* Send a post notification to DSP */</span>
		<span class="n">sm_interrupt_dsp</span><span class="p">(</span><span class="n">dev_context</span><span class="p">,</span> <span class="n">MBX_PM_SETPOINT_POSTNOTIFY</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;OPP: %s wrote to shm. Sent post notification &quot;</span>
			<span class="s">&quot;to DSP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* #ifdef CONFIG_TIDSPBRIDGE_DVFS */</span><span class="cp"></span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">dsp_clk_wakeup_event_ctrl</span><span class="p">(</span><span class="n">u32</span> <span class="n">clock_id</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cfg_hostres</span> <span class="o">*</span><span class="n">resources</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">iva2_grpsel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mpu_grpsel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_object</span> <span class="o">*</span><span class="n">hdev_object</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bridge_dev_context</span> <span class="o">*</span><span class="n">bridge_context</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hdev_object</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dev_object</span> <span class="o">*</span><span class="p">)</span><span class="n">drv_get_first_dev_object</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdev_object</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dev_get_bridge_context</span><span class="p">(</span><span class="n">hdev_object</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bridge_context</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bridge_context</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">resources</span> <span class="o">=</span> <span class="n">bridge_context</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resources</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">clock_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BPWR_GP_TIMER5</span>:
		<span class="n">iva2_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">mpu_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iva2_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_GPT5_MASK</span><span class="p">;</span>
			<span class="n">mpu_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_GPT5_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_GPT5_MASK</span><span class="p">;</span>
			<span class="n">iva2_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_GPT5_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">iva2_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mpu_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BPWR_GP_TIMER6</span>:
		<span class="n">iva2_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">mpu_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iva2_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_GPT6_MASK</span><span class="p">;</span>
			<span class="n">mpu_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_GPT6_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_GPT6_MASK</span><span class="p">;</span>
			<span class="n">iva2_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_GPT6_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">iva2_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mpu_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BPWR_GP_TIMER7</span>:
		<span class="n">iva2_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">mpu_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iva2_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_GPT7_MASK</span><span class="p">;</span>
			<span class="n">mpu_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_GPT7_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_GPT7_MASK</span><span class="p">;</span>
			<span class="n">iva2_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_GPT7_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">iva2_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mpu_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BPWR_GP_TIMER8</span>:
		<span class="n">iva2_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">mpu_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iva2_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_GPT8_MASK</span><span class="p">;</span>
			<span class="n">mpu_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_GPT8_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_GPT8_MASK</span><span class="p">;</span>
			<span class="n">iva2_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_GPT8_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">iva2_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mpu_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BPWR_MCBSP1</span>:
		<span class="n">iva2_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">core_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">mpu_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">core_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iva2_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP1_MASK</span><span class="p">;</span>
			<span class="n">mpu_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP1_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP1_MASK</span><span class="p">;</span>
			<span class="n">iva2_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP1_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">iva2_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">core_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mpu_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">core_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BPWR_MCBSP2</span>:
		<span class="n">iva2_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">mpu_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iva2_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP2_MASK</span><span class="p">;</span>
			<span class="n">mpu_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP2_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP2_MASK</span><span class="p">;</span>
			<span class="n">iva2_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP2_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">iva2_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mpu_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BPWR_MCBSP3</span>:
		<span class="n">iva2_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">mpu_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iva2_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP3_MASK</span><span class="p">;</span>
			<span class="n">mpu_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP3_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP3_MASK</span><span class="p">;</span>
			<span class="n">iva2_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP3_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">iva2_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mpu_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BPWR_MCBSP4</span>:
		<span class="n">iva2_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">mpu_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iva2_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP4_MASK</span><span class="p">;</span>
			<span class="n">mpu_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP4_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP4_MASK</span><span class="p">;</span>
			<span class="n">iva2_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP4_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">iva2_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mpu_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BPWR_MCBSP5</span>:
		<span class="n">iva2_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">mpu_grpsel</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iva2_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP5_MASK</span><span class="p">;</span>
			<span class="n">mpu_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP5_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mpu_grpsel</span> <span class="o">|=</span> <span class="n">OMAP3430_GRPSEL_MCBSP5_MASK</span><span class="p">;</span>
			<span class="n">iva2_grpsel</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3430_GRPSEL_MCBSP5_MASK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">iva2_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA8</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">mpu_grpsel</span><span class="p">,</span> <span class="n">resources</span><span class="o">-&gt;</span><span class="n">per_pm_base</span> <span class="o">+</span> <span class="mh">0xA4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
