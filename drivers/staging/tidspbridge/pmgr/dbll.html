<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › tidspbridge › pmgr › dbll.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dbll.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * dbll.c</span>
<span class="cm"> *</span>
<span class="cm"> * DSP-BIOS Bridge driver support functions for TI OMAP processors.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This package is free software;  you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS PACKAGE IS PROVIDED ``AS IS&#39;&#39; AND WITHOUT ANY EXPRESS OR</span>
<span class="cm"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
<span class="cm"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cm">/*  ----------------------------------- Host OS */</span>
<span class="cp">#include &lt;dspbridge/host_os.h&gt;</span>

<span class="cm">/*  ----------------------------------- DSP/BIOS Bridge */</span>
<span class="cp">#include &lt;dspbridge/dbdefs.h&gt;</span>

<span class="cp">#include &lt;dspbridge/gh.h&gt;</span>

<span class="cm">/*  ----------------------------------- OS Adaptation Layer */</span>

<span class="cm">/* Dynamic loader library interface */</span>
<span class="cp">#include &lt;dspbridge/dynamic_loader.h&gt;</span>
<span class="cp">#include &lt;dspbridge/getsection.h&gt;</span>

<span class="cm">/*  ----------------------------------- This */</span>
<span class="cp">#include &lt;dspbridge/dbll.h&gt;</span>
<span class="cp">#include &lt;dspbridge/rmm.h&gt;</span>

<span class="cm">/* Number of buckets for symbol hash table */</span>
<span class="cp">#define MAXBUCKETS 211</span>

<span class="cm">/* Max buffer length */</span>
<span class="cp">#define MAXEXPR 128</span>

<span class="cp">#define DOFF_ALIGN(x) (((x) + 3) &amp; ~3UL)</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== struct dbll_tar_obj* ========</span>
<span class="cm"> *  A target may have one or more libraries of symbols/code/data loaded</span>
<span class="cm"> *  onto it, where a library is simply the symbols/code/data contained</span>
<span class="cm"> *  in a DOFF file.</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_tar_obj ========</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>	<span class="cm">/* List of all opened libraries */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  The following 4 typedefs are &quot;super classes&quot; of the dynamic loader</span>
<span class="cm"> *  library types used in dynamic loader functions (dynamic_loader.h).</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_stream ========</span>
<span class="cm"> *  Contains dynamic_loader_stream</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dbll_stream</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dynamic_loader_stream</span> <span class="n">dl_stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== ldr_symbol ========</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="n">dl_symbol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_alloc ========</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dbll_alloc</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dynamic_loader_allocate</span> <span class="n">dl_alloc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_init_obj ========</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="n">dl_init</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== DBLL_Library ========</span>
<span class="cm"> *  A library handle is returned by DBLL_Open() and is passed to dbll_load()</span>
<span class="cm"> *  to load symbols/code/data, and to dbll_unload(), to remove the</span>
<span class="cm"> *  symbols/code/data loaded by dbll_load().</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_library_obj ========</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>	<span class="cm">/* Next library in target&#39;s list */</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>	<span class="cm">/* Previous in the list */</span>
	<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">target_obj</span><span class="p">;</span>	<span class="cm">/* target for this library */</span>

	<span class="cm">/* Objects needed by dynamic loader */</span>
	<span class="k">struct</span> <span class="n">dbll_stream</span> <span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="n">symbol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_alloc</span> <span class="n">allocate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="n">init</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dload_mod_obj</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">file_name</span><span class="p">;</span>	<span class="cm">/* COFF file name */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>		<span class="cm">/* Opaque file handle */</span>
	<span class="n">u32</span> <span class="n">entry</span><span class="p">;</span>		<span class="cm">/* Entry point */</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>	<span class="cm">/* desc of DOFF file loaded */</span>
	<span class="n">u32</span> <span class="n">open_ref</span><span class="p">;</span>		<span class="cm">/* Number of times opened */</span>
	<span class="n">u32</span> <span class="n">load_ref</span><span class="p">;</span>		<span class="cm">/* Number of times loaded */</span>
	<span class="k">struct</span> <span class="n">gh_t_hash_tab</span> <span class="o">*</span><span class="n">sym_tab</span><span class="p">;</span>	<span class="cm">/* Hash table of symbols */</span>
	<span class="n">u32</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_symbol ========</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_sym_val</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">dof_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dof_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span><span class="p">);</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">no_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">thisptr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bufr</span><span class="p">,</span>
		 <span class="n">ldr_addr</span> <span class="n">locn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="n">bytsize</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  Functions called by dynamic loader</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cm">/* dynamic_loader_stream */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dbll_read_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_stream</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">bufsize</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dbll_set_file_posn</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_stream</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">);</span>
<span class="cm">/* dynamic_loader_sym */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="n">dbll_find_symbol</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="n">dbll_add_to_symbol_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span>
						       <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
						       <span class="kt">unsigned</span> <span class="n">module_id</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="n">find_in_symbol_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span>
						   <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
						   <span class="kt">unsigned</span> <span class="n">moduleid</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dbll_purge_symbol_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="n">module_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">memsize</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mem_ptr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dbll_err_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">,</span>
			    <span class="kt">va_list</span> <span class="n">args</span><span class="p">);</span>
<span class="cm">/* dynamic_loader_allocate */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dbll_rmm_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_allocate</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">align</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rmm_dealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_allocate</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="cm">/* dynamic_loader_initialize */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">read_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		    <span class="n">ldr_addr</span> <span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="n">bytes</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">write_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		     <span class="n">ldr_addr</span> <span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="n">nbytes</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fill_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">ldr_addr</span> <span class="n">addr</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bytes</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="n">val</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">ldr_addr</span> <span class="n">start</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">);</span>

<span class="cm">/* symbol table hash functions */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">name_hash</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u16</span> <span class="n">max_bucket</span><span class="p">);</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">name_match</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sym_delete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>

<span class="cm">/* Symbol Redefinition */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">redefined_symbol</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">gbl_search</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_close ========</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dbll_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">zl_target</span><span class="p">;</span>

	<span class="n">zl_target</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">open_ref</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">open_ref</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Remove library from list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_target</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">==</span> <span class="n">zl_lib</span><span class="p">)</span>
			<span class="n">zl_target</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span>
			<span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
			<span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>

		<span class="cm">/* Free DOF resources */</span>
		<span class="n">dof_close</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">file_name</span><span class="p">);</span>

		<span class="cm">/* remove symbols from symbol table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span><span class="p">)</span>
			<span class="n">gh_delete</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span><span class="p">);</span>

		<span class="cm">/* remove the library object itself */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>
		<span class="n">zl_lib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_create ========</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dbll_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">**</span><span class="n">target_obj</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="o">*</span><span class="n">pattrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">pzl_target</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Allocate DBL target object */</span>
	<span class="n">pzl_target</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_obj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pzl_target</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">target_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pzl_target</span><span class="o">-&gt;</span><span class="n">attrs</span> <span class="o">=</span> <span class="o">*</span><span class="n">pattrs</span><span class="p">;</span>
			<span class="o">*</span><span class="n">target_obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">pzl_target</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_delete ========</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dbll_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">zl_target</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">target</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">zl_target</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_exit ========</span>
<span class="cm"> *  Discontinue usage of DBL module.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dbll_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* do nothing */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_get_addr ========</span>
<span class="cm"> *  Get address of name in the specified library.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">dbll_get_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">dbll_sym_val</span> <span class="o">**</span><span class="n">sym_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">status</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">gh_find</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sym_val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: lib: %p name: %s paddr: %p, status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">zl_lib</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">sym_val</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_get_attrs ========</span>
<span class="cm"> *  Retrieve the attributes of the target.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dbll_get_attrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="o">*</span><span class="n">pattrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">zl_target</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">target</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pattrs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">zl_target</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="o">*</span><span class="n">pattrs</span> <span class="o">=</span> <span class="n">zl_target</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_get_c_addr ========</span>
<span class="cm"> *  Get address of a &quot;C&quot; name in the specified library.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">dbll_get_c_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">dbll_sym_val</span> <span class="o">**</span><span class="n">sym_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">cname</span><span class="p">[</span><span class="n">MAXEXPR</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">status</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">cname</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">cname</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">cname</span><span class="p">[</span><span class="n">MAXEXPR</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>	<span class="cm">/* insure &#39;\0&#39; string termination */</span>

	<span class="cm">/* Check for C name, if not found */</span>
	<span class="n">sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">gh_find</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span><span class="p">,</span> <span class="n">cname</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sym</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">sym_val</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_get_sect ========</span>
<span class="cm"> *  Get the base address and size (in bytes) of a COFF section.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dbll_get_sect</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">paddr</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="o">*</span><span class="n">psize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">byte_size</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">opened_doff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">sect</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">lib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If DOFF file is not open, we open it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dof_open</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
				<span class="n">opened_doff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fseek</span><span class="p">))</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span>
							      <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span>
							      <span class="n">SEEK_SET</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">byte_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dload_get_section_info</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sect</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">paddr</span> <span class="o">=</span> <span class="n">sect</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">;</span>
			<span class="o">*</span><span class="n">psize</span> <span class="o">=</span> <span class="n">sect</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="n">byte_size</span><span class="p">;</span>
			<span class="cm">/* Make sure size is even for good swap */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">psize</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">psize</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Align size */</span>
			<span class="o">*</span><span class="n">psize</span> <span class="o">=</span> <span class="n">DOFF_ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">psize</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opened_doff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dof_close</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>
		<span class="n">opened_doff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: lib: %p name: %s paddr: %p psize: %p, &quot;</span>
		<span class="s">&quot;status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">paddr</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_init ========</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">dbll_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* do nothing */</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_load ========</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dbll_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">,</span> <span class="n">dbll_flags</span> <span class="n">flags</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">dbzl</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">got_symbols</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">opened_doff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Load if not already loaded.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">load_ref</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DBLL_DYNAMIC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dbzl</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="p">;</span>
		<span class="n">dbzl</span><span class="o">-&gt;</span><span class="n">attrs</span> <span class="o">=</span> <span class="o">*</span><span class="n">attrs</span><span class="p">;</span>
		<span class="cm">/* Create a hash table for symbols if not already created */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">got_symbols</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span> <span class="o">=</span> <span class="n">gh_create</span><span class="p">(</span><span class="n">MAXBUCKETS</span><span class="p">,</span>
						    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_symbol</span><span class="p">),</span>
						    <span class="n">name_hash</span><span class="p">,</span>
						    <span class="n">name_match</span><span class="p">,</span> <span class="n">sym_delete</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Set up objects needed by the dynamic loader</span>
<span class="cm">		 */</span>
		<span class="cm">/* Stream */</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">dl_stream</span><span class="p">.</span><span class="n">read_buffer</span> <span class="o">=</span> <span class="n">dbll_read_buffer</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">dl_stream</span><span class="p">.</span><span class="n">set_file_posn</span> <span class="o">=</span> <span class="n">dbll_set_file_posn</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>
		<span class="cm">/* Symbol */</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">find_matching_symbol</span> <span class="o">=</span>
		    <span class="n">dbll_find_symbol</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">got_symbols</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">add_to_symbol_table</span> <span class="o">=</span>
			    <span class="n">find_in_symbol_table</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">add_to_symbol_table</span> <span class="o">=</span>
			    <span class="n">dbll_add_to_symbol_table</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">purge_symbol_table</span> <span class="o">=</span>
		    <span class="n">dbll_purge_symbol_table</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">dload_allocate</span> <span class="o">=</span> <span class="n">allocate</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">dload_deallocate</span> <span class="o">=</span> <span class="n">deallocate</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">error_report</span> <span class="o">=</span> <span class="n">dbll_err_report</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>
		<span class="cm">/* Allocate */</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">dl_alloc</span><span class="p">.</span><span class="n">dload_allocate</span> <span class="o">=</span> <span class="n">dbll_rmm_alloc</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">dl_alloc</span><span class="p">.</span><span class="n">dload_deallocate</span> <span class="o">=</span> <span class="n">rmm_dealloc</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>
		<span class="cm">/* Init */</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">connect</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">readmem</span> <span class="o">=</span> <span class="n">read_mem</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">writemem</span> <span class="o">=</span> <span class="n">write_mem</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">fillmem</span> <span class="o">=</span> <span class="n">fill_mem</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">execute</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release</span><span class="p">;</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>
		<span class="cm">/* If COFF file is not open, we open it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dof_open</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
				<span class="n">opened_doff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">ftell</span><span class="p">))</span>
			    <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span>
			<span class="cm">/* Reset file cursor */</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fseek</span><span class="p">))</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span>
							      <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
							      <span class="n">SEEK_SET</span><span class="p">);</span>
			<span class="n">symbols_reloaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="cm">/* The 5th argument, DLOAD_INITBSS, tells the DLL</span>
<span class="cm">			 * module to zero-init all BSS sections.  In general,</span>
<span class="cm">			 * this is not necessary and also increases load time.</span>
<span class="cm">			 * We may want to make this configurable by the user */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dynamic_load_module</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">dl_stream</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">dl_alloc</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">,</span>
						  <span class="n">DLOAD_INITBSS</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">dload_mod_obj</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">redefined_symbol</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">load_ref</span><span class="o">++</span><span class="p">;</span>
				<span class="n">dbll_unload</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="o">*</span><span class="p">)</span><span class="n">attrs</span><span class="p">);</span>
				<span class="n">redefined_symbol</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">load_ref</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Clean up DOFF resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opened_doff</span><span class="p">)</span>
		<span class="n">dof_close</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: lib: %p flags: 0x%x entry: %p, status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_open ========</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dbll_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">dbll_flags</span> <span class="n">flags</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">**</span><span class="n">lib_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">zl_target</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">zl_lib</span> <span class="o">=</span> <span class="n">zl_target</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">zl_lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Library is already opened */</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">open_ref</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">zl_lib</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate DBL library object */</span>
		<span class="n">zl_lib</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Increment ref count to allow close on failure</span>
<span class="cm">			 * later on */</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">open_ref</span><span class="o">++</span><span class="p">;</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span> <span class="o">=</span> <span class="n">zl_target</span><span class="p">;</span>
			<span class="cm">/* Keep a copy of the file name */</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
							<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">file_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">strncpy</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span>
					<span class="n">strlen</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Set up objects needed by the dynamic loader</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>

	<span class="cm">/* Stream */</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">dl_stream</span><span class="p">.</span><span class="n">read_buffer</span> <span class="o">=</span> <span class="n">dbll_read_buffer</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">dl_stream</span><span class="p">.</span><span class="n">set_file_posn</span> <span class="o">=</span> <span class="n">dbll_set_file_posn</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>
	<span class="cm">/* Symbol */</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">add_to_symbol_table</span> <span class="o">=</span> <span class="n">dbll_add_to_symbol_table</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">find_matching_symbol</span> <span class="o">=</span> <span class="n">dbll_find_symbol</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">purge_symbol_table</span> <span class="o">=</span> <span class="n">dbll_purge_symbol_table</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">dload_allocate</span> <span class="o">=</span> <span class="n">allocate</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">dload_deallocate</span> <span class="o">=</span> <span class="n">deallocate</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">.</span><span class="n">error_report</span> <span class="o">=</span> <span class="n">dbll_err_report</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>
	<span class="cm">/* Allocate */</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">dl_alloc</span><span class="p">.</span><span class="n">dload_allocate</span> <span class="o">=</span> <span class="n">dbll_rmm_alloc</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">dl_alloc</span><span class="p">.</span><span class="n">dload_deallocate</span> <span class="o">=</span> <span class="n">rmm_dealloc</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>
	<span class="cm">/* Init */</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">connect</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">readmem</span> <span class="o">=</span> <span class="n">read_mem</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">writemem</span> <span class="o">=</span> <span class="n">write_mem</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">fillmem</span> <span class="o">=</span> <span class="n">fill_mem</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">execute</span> <span class="o">=</span> <span class="n">execute</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release</span><span class="p">;</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">lib</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dof_open</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>

	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">ftell</span><span class="p">))</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span>
	<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fseek</span><span class="p">))</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_SET</span><span class="p">);</span>
	<span class="cm">/* Create a hash table for symbols if flag is set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">DBLL_SYMB</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>

	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span> <span class="o">=</span>
	    <span class="n">gh_create</span><span class="p">(</span><span class="n">MAXBUCKETS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_symbol</span><span class="p">),</span> <span class="n">name_hash</span><span class="p">,</span>
		      <span class="n">name_match</span><span class="p">,</span> <span class="n">sym_delete</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Do a fake load to get symbols - set write func to no_op */</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">.</span><span class="n">writemem</span> <span class="o">=</span> <span class="n">no_op</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dynamic_open_module</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">dl_stream</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">dl_alloc</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">dload_mod_obj</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Now that we have the symbol table, we can unload */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">dynamic_unload_module</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">dload_mod_obj</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">dl_alloc</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">dload_mod_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">func_cont:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">open_ref</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* First time opened - insert in list */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">zl_target</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span>
				<span class="p">(</span><span class="n">zl_target</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>

			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">zl_target</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
			<span class="n">zl_target</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="n">zl_lib</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">lib_obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">zl_lib</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">lib_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dbll_close</span><span class="p">((</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">zl_lib</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: target: %p file: %s lib_obj: %p, status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">lib_obj</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_read_sect ========</span>
<span class="cm"> *  Get the content of a COFF section.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dbll_read_sect</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">lib</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">opened_doff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">byte_size</span><span class="p">;</span>		<span class="cm">/* size of bytes */</span>
	<span class="n">u32</span> <span class="n">ul_sect_size</span><span class="p">;</span>	<span class="cm">/* size of section */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">sect</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If DOFF file is not open, we open it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dof_open</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
				<span class="n">opened_doff</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fseek</span><span class="p">))</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span>
							      <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">pos</span><span class="p">,</span>
							      <span class="n">SEEK_SET</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>

	<span class="n">byte_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dload_get_section_info</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sect</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Ensure the supplied buffer size is sufficient to store</span>
<span class="cm">	 * the section buf to be read.</span>
<span class="cm">	 */</span>
	<span class="n">ul_sect_size</span> <span class="o">=</span> <span class="n">sect</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">*</span> <span class="n">byte_size</span><span class="p">;</span>
	<span class="cm">/* Make sure size is even for good swap */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ul_sect_size</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ul_sect_size</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Align size */</span>
	<span class="n">ul_sect_size</span> <span class="o">=</span> <span class="n">DOFF_ALIGN</span><span class="p">(</span><span class="n">ul_sect_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ul_sect_size</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dload_get_section</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">sect</span><span class="p">,</span> <span class="n">buf</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>

	<span class="p">}</span>
<span class="nl">func_cont:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">opened_doff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dof_close</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>
		<span class="n">opened_doff</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: lib: %p name: %s buf: %p size: 0x%x, &quot;</span>
		<span class="s">&quot;status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lib</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_unload ========</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dbll_unload</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="o">*</span><span class="n">attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">lib</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: lib: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lib</span><span class="p">);</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">load_ref</span><span class="o">--</span><span class="p">;</span>
	<span class="cm">/* Unload only if reference count is 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">load_ref</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span> <span class="o">=</span> <span class="o">*</span><span class="n">attrs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">dload_mod_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">dynamic_unload_module</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">dload_mod_obj</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">.</span><span class="n">dl_alloc</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">dl_init</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: failed: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* remove symbols from symbol table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gh_delete</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span><span class="p">);</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* delete DOFF desc since it holds *lots* of host OS</span>
<span class="cm">	 * resources */</span>
	<span class="n">dof_close</span><span class="p">(</span><span class="n">zl_lib</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dof_close ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dof_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dload_module_close</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">);</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* close file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fclose</span><span class="p">)</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dof_open ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dof_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">open</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fopen</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* First open the file for the dynamic loader, then open COF */</span>
	<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">dbll_f_open_fxn</span><span class="p">)</span> <span class="p">(</span><span class="n">open</span><span class="p">))</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">file_name</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">);</span>

	<span class="cm">/* Open DOFF module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">&amp;&amp;</span> <span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fseek</span><span class="p">))</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="mi">0</span><span class="p">,</span>
						      <span class="n">SEEK_SET</span><span class="p">);</span>
		<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span>
		    <span class="n">dload_module_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">.</span><span class="n">dl_stream</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">symbol</span><span class="p">.</span><span class="n">dl_symbol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fclose</span><span class="p">)</span> <span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span>
			<span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== name_hash ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">name_hash</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u16</span> <span class="n">max_bucket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hash</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">;</span>

	<span class="n">hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hash</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hash</span> <span class="o">^=</span> <span class="o">*</span><span class="n">name</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">%</span> <span class="n">max_bucket</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== name_match ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">name_match</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">key</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">key</span><span class="p">,</span> <span class="p">((</span><span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">sp</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span>
		    <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== no_op ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">no_op</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">thisptr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">bufr</span><span class="p">,</span>
		 <span class="n">ldr_addr</span> <span class="n">locn</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bytsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== sym_delete ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sym_delete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Dynamic Loader Functions</span>
<span class="cm"> */</span>

<span class="cm">/* dynamic_loader_stream */</span>
<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_read_buffer ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dbll_read_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_stream</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="n">bufsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_stream</span> <span class="o">*</span><span class="n">pstream</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_stream</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">pstream</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bytes_read</span> <span class="o">=</span>
		    <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fread</span><span class="p">))</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bufsize</span><span class="p">,</span>
						       <span class="n">lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">bytes_read</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_set_file_posn ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dbll_set_file_posn</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_stream</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_stream</span> <span class="o">*</span><span class="n">pstream</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_stream</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Success */</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">pstream</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">fseek</span><span class="p">))</span> <span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">pos</span><span class="p">,</span>
							    <span class="n">SEEK_SET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* dynamic_loader_sym */</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_find_symbol ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="nf">dbll_find_symbol</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="n">ret_sym</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="n">ldr_sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_sym_val</span> <span class="o">*</span><span class="n">dbll_sym</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">status</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>	<span class="cm">/* Symbol not found yet */</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">ldr_sym</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">sym_lookup</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check current lib + base lib + dep lib +</span>
<span class="cm">			 * persistent lib */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">sym_lookup</span><span class="p">))</span>
			    <span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">sym_handle</span><span class="p">,</span>
			     <span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">sym_arg</span><span class="p">,</span>
			     <span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">rmm_handle</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">dbll_sym</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Just check current lib for symbol */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">dbll_get_addr</span><span class="p">((</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">lib</span><span class="p">,</span>
					       <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dbll_sym</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span>
				    <span class="n">dbll_get_c_addr</span><span class="p">((</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="p">)</span>
						    <span class="n">lib</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">dbll_sym</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">gbl_search</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: Symbol not found: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="n">ret_sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">dbll_sym</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret_sym</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== find_in_symbol_table ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="nf">find_in_symbol_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span>
						   <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
						   <span class="kt">unsigned</span> <span class="n">moduleid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="n">ret_sym</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="n">ldr_sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="n">sym</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">ldr_sym</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="n">sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">gh_find</span><span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">);</span>

	<span class="n">ret_sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sym</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret_sym</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_add_to_symbol_table ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="nf">dbll_add_to_symbol_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span>
						       <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
						       <span class="kt">unsigned</span> <span class="n">module_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="n">sym_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="n">symbol</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="n">dbll_sym</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="n">ldr_sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">ldr_sym</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>

	<span class="cm">/* Check to see if symbol is already defined in symbol table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">base_image</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gbl_search</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">dbll_sym</span> <span class="o">=</span> <span class="n">dbll_find_symbol</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">gbl_search</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dbll_sym</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">redefined_symbol</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s already defined in symbol table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Allocate string to copy symbol name */</span>
	<span class="n">symbol</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="k">const</span><span class="p">)</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">symbol</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">symbol</span><span class="p">.</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Just copy name (value will be filled in by dynamic loader) */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">symbol</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="k">const</span><span class="p">)</span><span class="n">name</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="k">const</span><span class="p">)</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Add symbol to symbol table */</span>
		<span class="n">sym_ptr</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">gh_insert</span><span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span><span class="p">,</span>
						    <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">symbol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sym_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">symbol</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sym_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dynload_symbol</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sym_ptr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_purge_symbol_table ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbll_purge_symbol_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="n">module_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="n">ldr_sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">ldr_sym</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="cm">/* May not need to do anything */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== allocate ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">memsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="n">ldr_sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">ldr_sym</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">memsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== deallocate ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">deallocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mem_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="n">ldr_sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">ldr_sym</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mem_ptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_err_report ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dbll_err_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_sym</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errstr</span><span class="p">,</span>
			    <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="n">ldr_sym</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ldr_symbol</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">temp_buf</span><span class="p">[</span><span class="n">MAXEXPR</span><span class="p">];</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">ldr_sym</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="n">vsnprintf</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">temp_buf</span><span class="p">,</span> <span class="n">MAXEXPR</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">errstr</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* dynamic_loader_allocate */</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dbll_rmm_alloc ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dbll_rmm_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_allocate</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">align</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_alloc</span> <span class="o">*</span><span class="n">dbll_alloc_obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_alloc</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mem_sect_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rmm_addr</span> <span class="n">rmm_addr_obj</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">stype</span> <span class="o">=</span> <span class="n">DLOAD_SECTION_TYPE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sz_sec_last_token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sz_last_token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sz_sect_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psz_cur</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">token_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">seg_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">req</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">alloc_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">run_addr_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">dbll_alloc_obj</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>

	<span class="n">mem_sect_type</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">DLOAD_TEXT</span><span class="p">)</span> <span class="o">?</span> <span class="n">DBLL_CODE</span> <span class="o">:</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span>
						 <span class="n">DLOAD_BSS</span><span class="p">)</span> <span class="o">?</span> <span class="n">DBLL_BSS</span> <span class="o">:</span>
	    <span class="n">DBLL_DATA</span><span class="p">;</span>

	<span class="cm">/* Attempt to extract the segment ID and requirement information from</span>
<span class="cm">	   the name of the section */</span>
	<span class="n">token_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">sz_sect_name</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">token_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">sz_last_token</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">token_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">sz_sec_last_token</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">token_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sz_sect_name</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">sz_sec_last_token</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">sz_last_token</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_sect_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="n">token_len</span><span class="p">);</span>
	<span class="n">psz_cur</span> <span class="o">=</span> <span class="n">sz_sect_name</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">token</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_sec_last_token</span><span class="p">,</span> <span class="n">sz_last_token</span><span class="p">,</span>
			<span class="n">strlen</span><span class="p">(</span><span class="n">sz_last_token</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_last_token</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="s">&quot;:&quot;</span><span class="p">);</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* optimizes processing */</span>
	<span class="p">}</span>
	<span class="cm">/* If token is 0 or 1, and sz_sec_last_token is DYN_DARAM or DYN_SARAM,</span>
<span class="cm">	   or DYN_EXTERNAL, then mem granularity information is present</span>
<span class="cm">	   within the section name - only process if there are at least three</span>
<span class="cm">	   tokens within the section name (just a minor optimization) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">strict_strtol</span><span class="p">(</span><span class="n">sz_last_token</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sz_sec_last_token</span><span class="p">,</span> <span class="s">&quot;DYN_DARAM&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seg_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sz_sec_last_token</span><span class="p">,</span> <span class="s">&quot;DYN_SARAM&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seg_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sz_sec_last_token</span><span class="p">,</span>
					   <span class="s">&quot;DYN_EXTERNAL&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">seg_id</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">func_cont:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sz_sect_name</span><span class="p">);</span>
	<span class="n">sz_sect_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sz_last_token</span><span class="p">);</span>
	<span class="n">sz_last_token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sz_sec_last_token</span><span class="p">);</span>
	<span class="n">sz_sec_last_token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem_sect_type</span> <span class="o">==</span> <span class="n">DBLL_CODE</span><span class="p">)</span>
		<span class="n">alloc_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">GEM_L1P_PREFETCH_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">alloc_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">load_addr</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">run_addr</span><span class="p">)</span>
		<span class="n">run_addr_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* TODO - ideally, we can pass the alignment requirement also</span>
<span class="cm">	 * from here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">alloc</span><span class="p">)</span> <span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span>
						    <span class="n">rmm_handle</span><span class="p">,</span> <span class="n">mem_sect_type</span><span class="p">,</span>
						    <span class="n">alloc_size</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span>
						    <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rmm_addr_obj</span><span class="p">,</span>
						    <span class="n">seg_id</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* RMM gives word address. Need to convert to byte address */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">load_addr</span> <span class="o">=</span> <span class="n">rmm_addr_obj</span><span class="p">.</span><span class="n">addr</span> <span class="o">*</span> <span class="n">DSPWORDSIZE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">run_addr_flag</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">run_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">rmm_addr_obj</span><span class="p">.</span><span class="n">segid</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: %s base = 0x%x len = 0x%x, &quot;</span>
			<span class="s">&quot;info-&gt;run_addr 0x%x, info-&gt;load_addr 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">load_addr</span> <span class="o">/</span> <span class="n">DSPWORDSIZE</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">DSPWORDSIZE</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">run_addr</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== rmm_dealloc ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rmm_dealloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_allocate</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_alloc</span> <span class="o">*</span><span class="n">dbll_alloc_obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_alloc</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">segid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">stype</span> <span class="o">=</span> <span class="n">DLOAD_SECTION_TYPE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mem_sect_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">free_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mem_sect_type</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">DLOAD_TEXT</span><span class="p">)</span> <span class="o">?</span> <span class="n">DBLL_CODE</span> <span class="o">:</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span>
						 <span class="n">DLOAD_BSS</span><span class="p">)</span> <span class="o">?</span> <span class="n">DBLL_BSS</span> <span class="o">:</span>
	    <span class="n">DBLL_DATA</span><span class="p">;</span>
	<span class="n">lib</span> <span class="o">=</span> <span class="n">dbll_alloc_obj</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="cm">/* segid was set by alloc function */</span>
	<span class="n">segid</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mem_sect_type</span> <span class="o">==</span> <span class="n">DBLL_CODE</span><span class="p">)</span>
		<span class="n">free_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">+</span> <span class="n">GEM_L1P_PREFETCH_SIZE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">free_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">free</span><span class="p">)</span> <span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span>
						   <span class="n">sym_handle</span><span class="p">,</span> <span class="n">segid</span><span class="p">,</span>
						   <span class="n">info</span><span class="o">-&gt;</span><span class="n">load_addr</span> <span class="o">/</span>
						   <span class="n">DSPWORDSIZE</span><span class="p">,</span> <span class="n">free_size</span><span class="p">,</span>
						   <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* dynamic_loader_initialize */</span>
<span class="cm">/*</span>
<span class="cm"> *  ======== connect ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== read_mem ========</span>
<span class="cm"> *  This function does not need to be implemented.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">read_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		    <span class="n">ldr_addr</span> <span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="n">nbytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="o">*</span><span class="n">init_obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">init_obj</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="cm">/* Need bridge_brd_read function */</span>
	<span class="k">return</span> <span class="n">bytes_read</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== write_mem ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">write_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		     <span class="n">ldr_addr</span> <span class="n">addr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="o">*</span><span class="n">init_obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">target_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_sect_info</span> <span class="n">sect_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mem_sect_type</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">init_obj</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lib</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">target_obj</span> <span class="o">=</span> <span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="p">;</span>

	<span class="n">mem_sect_type</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">DLOAD_SECTION_TYPE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">==</span>
	     <span class="n">DLOAD_TEXT</span><span class="p">)</span> <span class="o">?</span> <span class="n">DBLL_CODE</span> <span class="o">:</span> <span class="n">DBLL_DATA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">target_obj</span> <span class="o">&amp;&amp;</span> <span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">write</span><span class="p">)</span> <span class="p">(</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">input_params</span><span class="p">,</span>
						<span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bytes</span><span class="p">,</span>
						<span class="n">mem_sect_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">log_write</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sect_info</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
			<span class="n">sect_info</span><span class="p">.</span><span class="n">sect_run_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">run_addr</span><span class="p">;</span>
			<span class="n">sect_info</span><span class="p">.</span><span class="n">sect_load_addr</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">load_addr</span><span class="p">;</span>
			<span class="n">sect_info</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="n">sect_info</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">mem_sect_type</span><span class="p">;</span>
			<span class="cm">/* Pass the information about what we&#39;ve written to</span>
<span class="cm">			 * another module */</span>
			<span class="p">(</span><span class="o">*</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">log_write</span><span class="p">)</span> <span class="p">(</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span>
							<span class="n">log_write_handle</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">sect_info</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
							<span class="n">bytes</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== fill_mem ========</span>
<span class="cm"> *  Fill bytes of memory at a given address with a given value by</span>
<span class="cm"> *  writing from a buffer containing the given value.  Write in</span>
<span class="cm"> *  sets of MAXEXPR (128) bytes to avoid large stack buffer issues.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">ldr_addr</span> <span class="n">addr</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ldr_section_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">bytes</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="o">*</span><span class="n">init_obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">init_obj</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* Pass the NULL pointer to write_mem to get the start address of Shared</span>
<span class="cm">	   memory. This is a trick to just get the start address, there is no</span>
<span class="cm">	   writing taking place with this Writemem</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">target_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">.</span><span class="n">write</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">dbll_write_fxn</span><span class="p">)</span> <span class="n">no_op</span><span class="p">)</span>
		<span class="n">write_mem</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== execute ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">ldr_addr</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="o">*</span><span class="n">init_obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_init_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">init_obj</span><span class="o">-&gt;</span><span class="n">lib</span><span class="p">;</span>
	<span class="cm">/* Save entry point */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">lib</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">start</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== release ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">release</span><span class="p">(</span><span class="k">struct</span> <span class="n">dynamic_loader_initialize</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_TIDSPBRIDGE_BACKTRACE</span>
<span class="cm">/**</span>
<span class="cm"> *  find_symbol_context - Basic symbol context structure</span>
<span class="cm"> * @address:		Symbol Address</span>
<span class="cm"> * @offset_range:		Offset range where the search for the DSP symbol</span>
<span class="cm"> *			started.</span>
<span class="cm"> * @cur_best_offset:	Best offset to start looking for the DSP symbol</span>
<span class="cm"> * @sym_addr:		Address of the DSP symbol</span>
<span class="cm"> * @name:		Symbol name</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">find_symbol_context</span> <span class="p">{</span>
	<span class="cm">/* input */</span>
	<span class="n">u32</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset_range</span><span class="p">;</span>
	<span class="cm">/* state */</span>
	<span class="n">u32</span> <span class="n">cur_best_offset</span><span class="p">;</span>
	<span class="cm">/* output */</span>
	<span class="n">u32</span> <span class="n">sym_addr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">120</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * find_symbol_callback() - Validates symbol address and copies the symbol name</span>
<span class="cm"> *			to the user data.</span>
<span class="cm"> * @elem:		dsp library context</span>
<span class="cm"> * @user_data:		Find symbol context</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">find_symbol_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">elem</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_symbol</span> <span class="o">*</span><span class="n">symbol</span> <span class="o">=</span> <span class="n">elem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">find_symbol_context</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="n">user_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">symbol_addr</span> <span class="o">=</span> <span class="n">symbol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">-</span> <span class="n">symbol_addr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Address given should be greater than symbol address,</span>
<span class="cm">	 * symbol address should be  within specified range</span>
<span class="cm">	 * and the offset should be better than previous one</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">&gt;=</span> <span class="n">symbol_addr</span> <span class="o">&amp;&amp;</span> <span class="n">symbol_addr</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span>
		<span class="n">offset</span> <span class="o">&lt;</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">cur_best_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">cur_best_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">sym_addr</span> <span class="o">=</span> <span class="n">symbol_addr</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">symbol</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * dbll_find_dsp_symbol() - This function retrieves the dsp symbol from the dsp binary.</span>
<span class="cm"> * @zl_lib:		DSP binary obj library pointer</span>
<span class="cm"> * @address:		Given address to find the dsp symbol</span>
<span class="cm"> * @offset_range:		offset range to look for dsp symbol</span>
<span class="cm"> * @sym_addr_output:	Symbol Output address</span>
<span class="cm"> * @name_output:		String with the dsp symbol</span>
<span class="cm"> *</span>
<span class="cm"> * 	This function retrieves the dsp symbol from the dsp binary.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">dbll_find_dsp_symbol</span><span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">zl_lib</span><span class="p">,</span> <span class="n">u32</span> <span class="n">address</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">offset_range</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">sym_addr_output</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">name_output</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">status</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">find_symbol_context</span> <span class="n">context</span><span class="p">;</span>

	<span class="n">context</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">address</span><span class="p">;</span>
	<span class="n">context</span><span class="p">.</span><span class="n">offset_range</span> <span class="o">=</span> <span class="n">offset_range</span><span class="p">;</span>
	<span class="n">context</span><span class="p">.</span><span class="n">cur_best_offset</span> <span class="o">=</span> <span class="n">offset_range</span><span class="p">;</span>
	<span class="n">context</span><span class="p">.</span><span class="n">sym_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">context</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">gh_iterate</span><span class="p">(</span><span class="n">zl_lib</span><span class="o">-&gt;</span><span class="n">sym_tab</span><span class="p">,</span> <span class="n">find_symbol_callback</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">name_output</span><span class="p">,</span> <span class="n">context</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="o">*</span><span class="n">sym_addr_output</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">sym_addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
