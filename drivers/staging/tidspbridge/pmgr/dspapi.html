<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › tidspbridge › pmgr › dspapi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dspapi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * dspapi.c</span>
<span class="cm"> *</span>
<span class="cm"> * DSP-BIOS Bridge driver support functions for TI OMAP processors.</span>
<span class="cm"> *</span>
<span class="cm"> * Common DSP API functions, also includes the wrapper</span>
<span class="cm"> * functions called directly by the DeviceIOControl interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This package is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS PACKAGE IS PROVIDED ``AS IS&#39;&#39; AND WITHOUT ANY EXPRESS OR</span>
<span class="cm"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
<span class="cm"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cm">/*  ----------------------------------- Host OS */</span>
<span class="cp">#include &lt;dspbridge/host_os.h&gt;</span>

<span class="cm">/*  ----------------------------------- DSP/BIOS Bridge */</span>
<span class="cp">#include &lt;dspbridge/dbdefs.h&gt;</span>

<span class="cm">/*  ----------------------------------- OS Adaptation Layer */</span>
<span class="cp">#include &lt;dspbridge/ntfy.h&gt;</span>

<span class="cm">/*  ----------------------------------- Platform Manager */</span>
<span class="cp">#include &lt;dspbridge/chnl.h&gt;</span>
<span class="cp">#include &lt;dspbridge/dev.h&gt;</span>
<span class="cp">#include &lt;dspbridge/drv.h&gt;</span>

<span class="cp">#include &lt;dspbridge/proc.h&gt;</span>
<span class="cp">#include &lt;dspbridge/strm.h&gt;</span>

<span class="cm">/*  ----------------------------------- Resource Manager */</span>
<span class="cp">#include &lt;dspbridge/disp.h&gt;</span>
<span class="cp">#include &lt;dspbridge/mgr.h&gt;</span>
<span class="cp">#include &lt;dspbridge/node.h&gt;</span>
<span class="cp">#include &lt;dspbridge/rmm.h&gt;</span>

<span class="cm">/*  ----------------------------------- Others */</span>
<span class="cp">#include &lt;dspbridge/msg.h&gt;</span>
<span class="cp">#include &lt;dspbridge/cmm.h&gt;</span>
<span class="cp">#include &lt;dspbridge/io.h&gt;</span>

<span class="cm">/*  ----------------------------------- This */</span>
<span class="cp">#include &lt;dspbridge/dspapi.h&gt;</span>
<span class="cp">#include &lt;dspbridge/dbdcd.h&gt;</span>

<span class="cp">#include &lt;dspbridge/resourcecleanup.h&gt;</span>

<span class="cm">/*  ----------------------------------- Defines, Data Structures, Typedefs */</span>
<span class="cp">#define MAX_TRACEBUFLEN 255</span>
<span class="cp">#define MAX_LOADARGS    16</span>
<span class="cp">#define MAX_NODES       64</span>
<span class="cp">#define MAX_STREAMS     16</span>
<span class="cp">#define MAX_BUFS	64</span>

<span class="cm">/* Used to get dspbridge ioctl table */</span>
<span class="cp">#define DB_GET_IOC_TABLE(cmd)	(DB_GET_MODULE(cmd) &gt;&gt; DB_MODULE_SHIFT)</span>

<span class="cm">/* Device IOCtl function pointer */</span>
<span class="k">struct</span> <span class="n">api_cmd</span> <span class="p">{</span>
	<span class="n">u32</span><span class="p">(</span><span class="o">*</span><span class="n">fxn</span><span class="p">)</span> <span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*  ----------------------------------- Globals */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">api_c_refs</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *  Function tables.</span>
<span class="cm"> *  The order of these functions MUST be the same as the order of the command</span>
<span class="cm"> *  numbers defined in dspapi-ioctl.h  This is how an IOCTL number in user mode</span>
<span class="cm"> *  turns into a function call in kernel mode.</span>
<span class="cm"> */</span>

<span class="cm">/* MGR wrapper functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">api_cmd</span> <span class="n">mgr_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">mgrwrap_enum_node_info</span><span class="p">},</span>	<span class="cm">/* MGR_ENUMNODE_INFO */</span>
	<span class="p">{</span><span class="n">mgrwrap_enum_proc_info</span><span class="p">},</span>	<span class="cm">/* MGR_ENUMPROC_INFO */</span>
	<span class="p">{</span><span class="n">mgrwrap_register_object</span><span class="p">},</span>	<span class="cm">/* MGR_REGISTEROBJECT */</span>
	<span class="p">{</span><span class="n">mgrwrap_unregister_object</span><span class="p">},</span>	<span class="cm">/* MGR_UNREGISTEROBJECT */</span>
	<span class="p">{</span><span class="n">mgrwrap_wait_for_bridge_events</span><span class="p">},</span>	<span class="cm">/* MGR_WAIT */</span>
	<span class="p">{</span><span class="n">mgrwrap_get_process_resources_info</span><span class="p">},</span>	<span class="cm">/* MGR_GET_PROC_RES */</span>
<span class="p">};</span>

<span class="cm">/* PROC wrapper functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">api_cmd</span> <span class="n">proc_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">procwrap_attach</span><span class="p">},</span>	<span class="cm">/* PROC_ATTACH */</span>
	<span class="p">{</span><span class="n">procwrap_ctrl</span><span class="p">},</span>	<span class="cm">/* PROC_CTRL */</span>
	<span class="p">{</span><span class="n">procwrap_detach</span><span class="p">},</span>	<span class="cm">/* PROC_DETACH */</span>
	<span class="p">{</span><span class="n">procwrap_enum_node_info</span><span class="p">},</span>	<span class="cm">/* PROC_ENUMNODE */</span>
	<span class="p">{</span><span class="n">procwrap_enum_resources</span><span class="p">},</span>	<span class="cm">/* PROC_ENUMRESOURCES */</span>
	<span class="p">{</span><span class="n">procwrap_get_state</span><span class="p">},</span>	<span class="cm">/* PROC_GET_STATE */</span>
	<span class="p">{</span><span class="n">procwrap_get_trace</span><span class="p">},</span>	<span class="cm">/* PROC_GET_TRACE */</span>
	<span class="p">{</span><span class="n">procwrap_load</span><span class="p">},</span>	<span class="cm">/* PROC_LOAD */</span>
	<span class="p">{</span><span class="n">procwrap_register_notify</span><span class="p">},</span>	<span class="cm">/* PROC_REGISTERNOTIFY */</span>
	<span class="p">{</span><span class="n">procwrap_start</span><span class="p">},</span>	<span class="cm">/* PROC_START */</span>
	<span class="p">{</span><span class="n">procwrap_reserve_memory</span><span class="p">},</span>	<span class="cm">/* PROC_RSVMEM */</span>
	<span class="p">{</span><span class="n">procwrap_un_reserve_memory</span><span class="p">},</span>	<span class="cm">/* PROC_UNRSVMEM */</span>
	<span class="p">{</span><span class="n">procwrap_map</span><span class="p">},</span>		<span class="cm">/* PROC_MAPMEM */</span>
	<span class="p">{</span><span class="n">procwrap_un_map</span><span class="p">},</span>	<span class="cm">/* PROC_UNMAPMEM */</span>
	<span class="p">{</span><span class="n">procwrap_flush_memory</span><span class="p">},</span>	<span class="cm">/* PROC_FLUSHMEMORY */</span>
	<span class="p">{</span><span class="n">procwrap_stop</span><span class="p">},</span>	<span class="cm">/* PROC_STOP */</span>
	<span class="p">{</span><span class="n">procwrap_invalidate_memory</span><span class="p">},</span>	<span class="cm">/* PROC_INVALIDATEMEMORY */</span>
	<span class="p">{</span><span class="n">procwrap_begin_dma</span><span class="p">},</span>	<span class="cm">/* PROC_BEGINDMA */</span>
	<span class="p">{</span><span class="n">procwrap_end_dma</span><span class="p">},</span>	<span class="cm">/* PROC_ENDDMA */</span>
<span class="p">};</span>

<span class="cm">/* NODE wrapper functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">api_cmd</span> <span class="n">node_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">nodewrap_allocate</span><span class="p">},</span>	<span class="cm">/* NODE_ALLOCATE */</span>
	<span class="p">{</span><span class="n">nodewrap_alloc_msg_buf</span><span class="p">},</span>	<span class="cm">/* NODE_ALLOCMSGBUF */</span>
	<span class="p">{</span><span class="n">nodewrap_change_priority</span><span class="p">},</span>	<span class="cm">/* NODE_CHANGEPRIORITY */</span>
	<span class="p">{</span><span class="n">nodewrap_connect</span><span class="p">},</span>	<span class="cm">/* NODE_CONNECT */</span>
	<span class="p">{</span><span class="n">nodewrap_create</span><span class="p">},</span>	<span class="cm">/* NODE_CREATE */</span>
	<span class="p">{</span><span class="n">nodewrap_delete</span><span class="p">},</span>	<span class="cm">/* NODE_DELETE */</span>
	<span class="p">{</span><span class="n">nodewrap_free_msg_buf</span><span class="p">},</span>	<span class="cm">/* NODE_FREEMSGBUF */</span>
	<span class="p">{</span><span class="n">nodewrap_get_attr</span><span class="p">},</span>	<span class="cm">/* NODE_GETATTR */</span>
	<span class="p">{</span><span class="n">nodewrap_get_message</span><span class="p">},</span>	<span class="cm">/* NODE_GETMESSAGE */</span>
	<span class="p">{</span><span class="n">nodewrap_pause</span><span class="p">},</span>	<span class="cm">/* NODE_PAUSE */</span>
	<span class="p">{</span><span class="n">nodewrap_put_message</span><span class="p">},</span>	<span class="cm">/* NODE_PUTMESSAGE */</span>
	<span class="p">{</span><span class="n">nodewrap_register_notify</span><span class="p">},</span>	<span class="cm">/* NODE_REGISTERNOTIFY */</span>
	<span class="p">{</span><span class="n">nodewrap_run</span><span class="p">},</span>		<span class="cm">/* NODE_RUN */</span>
	<span class="p">{</span><span class="n">nodewrap_terminate</span><span class="p">},</span>	<span class="cm">/* NODE_TERMINATE */</span>
	<span class="p">{</span><span class="n">nodewrap_get_uuid_props</span><span class="p">},</span>	<span class="cm">/* NODE_GETUUIDPROPS */</span>
<span class="p">};</span>

<span class="cm">/* STRM wrapper functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">api_cmd</span> <span class="n">strm_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">strmwrap_allocate_buffer</span><span class="p">},</span>	<span class="cm">/* STRM_ALLOCATEBUFFER */</span>
	<span class="p">{</span><span class="n">strmwrap_close</span><span class="p">},</span>	<span class="cm">/* STRM_CLOSE */</span>
	<span class="p">{</span><span class="n">strmwrap_free_buffer</span><span class="p">},</span>	<span class="cm">/* STRM_FREEBUFFER */</span>
	<span class="p">{</span><span class="n">strmwrap_get_event_handle</span><span class="p">},</span>	<span class="cm">/* STRM_GETEVENTHANDLE */</span>
	<span class="p">{</span><span class="n">strmwrap_get_info</span><span class="p">},</span>	<span class="cm">/* STRM_GETINFO */</span>
	<span class="p">{</span><span class="n">strmwrap_idle</span><span class="p">},</span>	<span class="cm">/* STRM_IDLE */</span>
	<span class="p">{</span><span class="n">strmwrap_issue</span><span class="p">},</span>	<span class="cm">/* STRM_ISSUE */</span>
	<span class="p">{</span><span class="n">strmwrap_open</span><span class="p">},</span>	<span class="cm">/* STRM_OPEN */</span>
	<span class="p">{</span><span class="n">strmwrap_reclaim</span><span class="p">},</span>	<span class="cm">/* STRM_RECLAIM */</span>
	<span class="p">{</span><span class="n">strmwrap_register_notify</span><span class="p">},</span>	<span class="cm">/* STRM_REGISTERNOTIFY */</span>
	<span class="p">{</span><span class="n">strmwrap_select</span><span class="p">},</span>	<span class="cm">/* STRM_SELECT */</span>
<span class="p">};</span>

<span class="cm">/* CMM wrapper functions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">api_cmd</span> <span class="n">cmm_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">cmmwrap_calloc_buf</span><span class="p">},</span>	<span class="cm">/* CMM_ALLOCBUF */</span>
	<span class="p">{</span><span class="n">cmmwrap_free_buf</span><span class="p">},</span>	<span class="cm">/* CMM_FREEBUF */</span>
	<span class="p">{</span><span class="n">cmmwrap_get_handle</span><span class="p">},</span>	<span class="cm">/* CMM_GETHANDLE */</span>
	<span class="p">{</span><span class="n">cmmwrap_get_info</span><span class="p">},</span>	<span class="cm">/* CMM_GETINFO */</span>
<span class="p">};</span>

<span class="cm">/* Array used to store ioctl table sizes. It can hold up to 8 entries */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">size_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mgr_cmd</span><span class="p">),</span>
	<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">proc_cmd</span><span class="p">),</span>
	<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">node_cmd</span><span class="p">),</span>
	<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">strm_cmd</span><span class="p">),</span>
	<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">cmm_cmd</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_cp_fm_usr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">from</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">from</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">bytes</span><span class="p">)))</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CP_FM_USR(to, from, err, n)				\</span>
<span class="cp">	_cp_fm_usr(to, from, &amp;(err), (n) * sizeof(*(to)))</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">_cp_to_usr</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">from</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">to</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="p">,</span> <span class="n">bytes</span><span class="p">)))</span>
		<span class="o">*</span><span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define CP_TO_USR(to, from, err, n)				\</span>
<span class="cp">	_cp_to_usr(to, from, &amp;(err), (n) * sizeof(*(from)))</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== api_call_dev_ioctl ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Call the (wrapper) function for the corresponding API IOCTL.</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">api_call_dev_ioctl</span><span class="p">(</span><span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
				      <span class="n">u32</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span><span class="p">(</span><span class="o">*</span><span class="n">ioctl_cmd</span><span class="p">)</span> <span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="n">DB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Incompatible dspbridge ioctl number</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DB_GET_IOC_TABLE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">size_cmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: undefined ioctl module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the size of the required cmd table */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">DB_GET_IOC</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">size_cmd</span><span class="p">[</span><span class="n">DB_GET_IOC_TABLE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)])</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: requested ioctl %d out of bounds for table %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">DB_GET_IOC_TABLE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">DB_GET_MODULE</span><span class="p">(</span><span class="n">cmd</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DB_MGR</span>:
		<span class="n">ioctl_cmd</span> <span class="o">=</span> <span class="n">mgr_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fxn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_PROC</span>:
		<span class="n">ioctl_cmd</span> <span class="o">=</span> <span class="n">proc_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fxn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_NODE</span>:
		<span class="n">ioctl_cmd</span> <span class="o">=</span> <span class="n">node_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fxn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_STRM</span>:
		<span class="n">ioctl_cmd</span> <span class="o">=</span> <span class="n">strm_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fxn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_CMM</span>:
		<span class="n">ioctl_cmd</span> <span class="o">=</span> <span class="n">cmm_cmd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fxn</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioctl_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: requested ioctl not defined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ioctl_cmd</span><span class="p">)</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== api_exit ========</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">api_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">api_c_refs</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">api_c_refs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mgr_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== api_init ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Module initialization used by Bridge API.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">api_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">api_c_refs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgr_init</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">api_c_refs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== api_init_complete2 ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Perform any required bridge initialization which cannot</span>
<span class="cm"> *      be performed in api_init() or dev_start_device() due</span>
<span class="cm"> *      to the fact that some services are not yet</span>
<span class="cm"> *      completely initialized.</span>
<span class="cm"> *  Parameters:</span>
<span class="cm"> *  Returns:</span>
<span class="cm"> *      0:	Allow this device to load</span>
<span class="cm"> *      -EPERM:      Failure.</span>
<span class="cm"> *  Requires:</span>
<span class="cm"> *      Bridge API initialized.</span>
<span class="cm"> *  Ensures:</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">api_init_complete2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg_devnode</span> <span class="o">*</span><span class="n">dev_node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dev_object</span> <span class="o">*</span><span class="n">hdev_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">drv_data</span> <span class="o">*</span><span class="n">drv_datap</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_type</span><span class="p">;</span>

	<span class="cm">/*  Walk the list of DevObjects, get each devnode, and attempting to</span>
<span class="cm">	 *  autostart the board. Note that this requires COF loading, which</span>
<span class="cm">	 *  requires KFILE. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">hdev_obj</span> <span class="o">=</span> <span class="n">dev_get_first</span><span class="p">();</span> <span class="n">hdev_obj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
	     <span class="n">hdev_obj</span> <span class="o">=</span> <span class="n">dev_get_next</span><span class="p">(</span><span class="n">hdev_obj</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev_get_dev_node</span><span class="p">(</span><span class="n">hdev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_node</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_get_dev_type</span><span class="p">(</span><span class="n">hdev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_type</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">DSP_UNIT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">IVA_UNIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">drv_datap</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">bridge</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">drv_datap</span> <span class="o">&amp;&amp;</span> <span class="n">drv_datap</span><span class="o">-&gt;</span><span class="n">base_img</span><span class="p">)</span>
				<span class="n">proc_auto_start</span><span class="p">(</span><span class="n">dev_node</span><span class="p">,</span> <span class="n">hdev_obj</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO: Remove deprecated and not implemented ioctl wrappers */</span>

<span class="cm">/*</span>
<span class="cm"> * ======== mgrwrap_enum_node_info ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">mgrwrap_enum_node_info</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pndb_props</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_nodes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_enumnode_info</span><span class="p">.</span><span class="n">ndb_props_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_ndbprops</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pndb_props</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pndb_props</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">mgr_enum_node_info</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_enumnode_info</span><span class="p">.</span><span class="n">node_id</span><span class="p">,</span>
				       <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_ndbprops</span> <span class="o">*</span><span class="p">)</span><span class="n">pndb_props</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">num_nodes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_enumnode_info</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">,</span> <span class="n">pndb_props</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		  <span class="n">size</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_enumnode_info</span><span class="p">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_nodes</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		  <span class="mi">1</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pndb_props</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== mgrwrap_enum_proc_info ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">mgrwrap_enum_proc_info</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">processor_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num_procs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_enumproc_info</span><span class="p">.</span><span class="n">processor_info_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_processorinfo</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">processor_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">processor_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">mgr_enum_processor_info</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_enumproc_info</span><span class="p">.</span>
					    <span class="n">processor_id</span><span class="p">,</span>
					    <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_processorinfo</span> <span class="o">*</span><span class="p">)</span>
					    <span class="n">processor_info</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_procs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_enumproc_info</span><span class="p">.</span><span class="n">processor_info</span><span class="p">,</span> <span class="n">processor_info</span><span class="p">,</span>
		  <span class="n">status</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_enumproc_info</span><span class="p">.</span><span class="n">num_procs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_procs</span><span class="p">,</span>
		  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">processor_info</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WRAP_MAP2CALLER(x) x</span>
<span class="cm">/*</span>
<span class="cm"> * ======== mgrwrap_register_object ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">mgrwrap_register_object</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="n">uuid_obj</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">path_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psz_path_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_obj</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_registerobject</span><span class="p">.</span><span class="n">uuid_obj</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="cm">/* path_size is increased by 1 to accommodate NULL */</span>
	<span class="n">path_size</span> <span class="o">=</span> <span class="n">strlen_user</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_registerobject</span><span class="p">.</span><span class="n">sz_path_name</span><span class="p">)</span> <span class="o">+</span>
	    <span class="mi">1</span><span class="p">;</span>
	<span class="n">psz_path_name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">path_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">psz_path_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">strncpy_from_user</span><span class="p">(</span><span class="n">psz_path_name</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_registerobject</span><span class="p">.</span>
				<span class="n">sz_path_name</span><span class="p">,</span> <span class="n">path_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_registerobject</span><span class="p">.</span><span class="n">obj_type</span> <span class="o">&gt;=</span> <span class="n">DSP_DCDMAXOBJTYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dcd_register_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_obj</span><span class="p">,</span>
				     <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_registerobject</span><span class="p">.</span><span class="n">obj_type</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">psz_path_name</span><span class="p">);</span>
<span class="nl">func_end:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psz_path_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== mgrwrap_unregister_object ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">mgrwrap_unregister_object</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="n">uuid_obj</span><span class="p">;</span>

	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_obj</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_registerobject</span><span class="p">.</span><span class="n">uuid_obj</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dcd_unregister_object</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uuid_obj</span><span class="p">,</span>
				       <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_unregisterobject</span><span class="p">.</span>
				       <span class="n">obj_type</span><span class="p">);</span>
<span class="nl">func_end:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== mgrwrap_wait_for_bridge_events ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">mgrwrap_wait_for_bridge_events</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_notification</span> <span class="o">*</span><span class="n">anotifications</span><span class="p">[</span><span class="n">MAX_EVENTS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dsp_notification</span> <span class="n">notifications</span><span class="p">[</span><span class="n">MAX_EVENTS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_wait</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_EVENTS</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* get the array of pointers to user structures */</span>
	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">anotifications</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_wait</span><span class="p">.</span><span class="n">anotifications</span><span class="p">,</span>
		  <span class="n">status</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="cm">/* get the events */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notifications</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">anotifications</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="o">!</span><span class="n">notifications</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* set the array of pointers to kernel structures */</span>
		<span class="n">anotifications</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">notifications</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mgr_wait_for_bridge_events</span><span class="p">(</span><span class="n">anotifications</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
							 <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span>
							 <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_wait</span><span class="p">.</span>
							 <span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_mgr_wait</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">index</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== MGRWRAP_GetProcessResourceInfo ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="n">__deprecated</span> <span class="nf">mgrwrap_get_process_resources_info</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span> <span class="n">args</span><span class="p">,</span>
						    <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: deprecated dspbridge ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_attach ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_attach</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">processor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_processorattrin</span> <span class="n">proc_attr_in</span><span class="p">,</span> <span class="o">*</span><span class="n">attr_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Optional argument */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_attach</span><span class="p">.</span><span class="n">attr_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc_attr_in</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_attach</span><span class="p">.</span><span class="n">attr_in</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			  <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="n">attr_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc_attr_in</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_attach</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_attach</span><span class="p">.</span><span class="n">processor_id</span><span class="p">,</span> <span class="n">attr_in</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">processor</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_attach</span><span class="p">.</span><span class="n">ph_processor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">processor</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">func_end:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_ctrl ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_ctrl</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cb_data_size</span><span class="p">,</span> <span class="n">__user</span> <span class="o">*</span> <span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
	    <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_ctrl</span><span class="p">.</span><span class="n">args</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pargs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">cb_data_size</span><span class="p">,</span> <span class="n">psize</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cb_data_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="n">pargs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">cb_data_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pargs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">pargs</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_ctrl</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			  <span class="n">cb_data_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">proc_ctrl</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_ctrl</span><span class="p">.</span><span class="n">cmd</span><span class="p">,</span>
				   <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_cbdata</span> <span class="o">*</span><span class="p">)</span><span class="n">pargs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* CP_TO_USR(args-&gt;args_proc_ctrl.args, pargs, status, 1); */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pargs</span><span class="p">);</span>
<span class="nl">func_end:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_detach ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="n">__deprecated</span> <span class="nf">procwrap_detach</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* proc_detach called at bridge_release only */</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: deprecated dspbridge ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_enum_node_info ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_enum_node_info</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">node_tab</span><span class="p">[</span><span class="n">MAX_NODES</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">num_nodes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">alloc_cnt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_enumnode_info</span><span class="p">.</span><span class="n">node_tab_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_enum_nodes</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span>
				 <span class="n">node_tab</span><span class="p">,</span>
				 <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_enumnode_info</span><span class="p">.</span><span class="n">node_tab_size</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">num_nodes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alloc_cnt</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_enumnode_info</span><span class="p">.</span><span class="n">node_tab</span><span class="p">,</span> <span class="n">node_tab</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		  <span class="n">num_nodes</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_enumnode_info</span><span class="p">.</span><span class="n">num_nodes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_nodes</span><span class="p">,</span>
		  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_enumnode_info</span><span class="p">.</span><span class="n">allocated</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">alloc_cnt</span><span class="p">,</span>
		  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">procwrap_end_dma</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_dma</span><span class="p">.</span><span class="n">dir</span> <span class="o">&gt;=</span> <span class="n">DMA_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_end_dma</span><span class="p">(</span><span class="n">pr_ctxt</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_dma</span><span class="p">.</span><span class="n">mpu_addr</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_dma</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_dma</span><span class="p">.</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">procwrap_begin_dma</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_dma</span><span class="p">.</span><span class="n">dir</span> <span class="o">&gt;=</span> <span class="n">DMA_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_begin_dma</span><span class="p">(</span><span class="n">pr_ctxt</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_dma</span><span class="p">.</span><span class="n">mpu_addr</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_dma</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_dma</span><span class="p">.</span><span class="n">dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_flush_memory ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_flush_memory</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_flushmemory</span><span class="p">.</span><span class="n">flags</span> <span class="o">&gt;</span>
	    <span class="n">PROC_WRITEBACK_INVALIDATE_MEM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_flush_memory</span><span class="p">(</span><span class="n">pr_ctxt</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_flushmemory</span><span class="p">.</span><span class="n">mpu_addr</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_flushmemory</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_flushmemory</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_invalidate_memory ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_invalidate_memory</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">proc_invalidate_memory</span><span class="p">(</span><span class="n">pr_ctxt</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_invalidatememory</span><span class="p">.</span><span class="n">mpu_addr</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_invalidatememory</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_enum_resources ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_enum_resources</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_resourceinfo</span> <span class="n">resource_info</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_enumresources</span><span class="p">.</span><span class="n">resource_info_size</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_resourceinfo</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">proc_get_resource_info</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_enumresources</span><span class="p">.</span><span class="n">resource_type</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">resource_info</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_enumresources</span><span class="p">.</span>
				   <span class="n">resource_info_size</span><span class="p">);</span>

	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_enumresources</span><span class="p">.</span><span class="n">resource_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource_info</span><span class="p">,</span>
		  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_get_state ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_get_state</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_processorstate</span> <span class="n">proc_state</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_getstate</span><span class="p">.</span><span class="n">state_info_size</span> <span class="o">&lt;</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_processorstate</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_get_state</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_state</span><span class="p">,</span>
			   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_getstate</span><span class="p">.</span><span class="n">state_info_size</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_getstate</span><span class="p">.</span><span class="n">proc_state_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_state</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		  <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_get_trace ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_get_trace</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_gettrace</span><span class="p">.</span><span class="n">max_size</span> <span class="o">&gt;</span> <span class="n">MAX_TRACEBUFLEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_gettrace</span><span class="p">.</span><span class="n">max_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">proc_get_trace</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span>
					<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_gettrace</span><span class="p">.</span><span class="n">max_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_gettrace</span><span class="p">.</span><span class="n">buf</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		  <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_gettrace</span><span class="p">.</span><span class="n">max_size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pbuf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_load ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_load</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">count</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_load</span><span class="p">.</span><span class="n">argc_index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">**</span><span class="n">argv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">**</span><span class="n">envp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="n">MAX_LOADARGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">argv</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">argv</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_load</span><span class="p">.</span><span class="n">user_args</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
		<span class="n">argv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* User space pointer to argument */</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="cm">/* len is increased by 1 to accommodate NULL */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen_user</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">temp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Kernel space pointer to argument */</span>
			<span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">temp</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* TODO: validate this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_load</span><span class="p">.</span><span class="n">user_envp</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* number of elements in the envp array including NULL */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span>
				     <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_load</span><span class="p">.</span><span class="n">user_envp</span> <span class="o">+</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">temp</span><span class="p">);</span>
		<span class="n">envp</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">envp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">envp</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_load</span><span class="p">.</span><span class="n">user_envp</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">envp</span><span class="p">);</span>
			<span class="n">envp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">envp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* User space pointer to argument */</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">envp</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="cm">/* len is increased by 1 to accommodate NULL */</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen_user</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">temp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="cm">/* Kernel space pointer to argument */</span>
			<span class="n">envp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">envp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">envp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">temp</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">(</span><span class="n">envp</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
					<span class="n">envp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">proc_load</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_load</span><span class="p">.</span><span class="n">argc_index</span><span class="p">,</span>
				   <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">argv</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)</span><span class="n">envp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">func_cont:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">envp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">envp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">envp</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">envp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_load</span><span class="p">.</span><span class="n">argc_index</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">argv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_map ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_map</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">map_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_mapmem</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_map</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_mapmem</span><span class="p">.</span><span class="n">processor</span><span class="p">,</span>
			  <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_mapmem</span><span class="p">.</span><span class="n">mpu_addr</span><span class="p">,</span>
			  <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_mapmem</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
			  <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_mapmem</span><span class="p">.</span><span class="n">req_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">map_addr</span><span class="p">,</span>
			  <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_mapmem</span><span class="p">.</span><span class="n">map_attr</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">map_addr</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_mapmem</span><span class="p">.</span><span class="n">map_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">proc_un_map</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span> <span class="n">map_addr</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_register_notify ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_register_notify</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_notification</span> <span class="n">notification</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="cm">/* Initialize the notification data structure */</span>
	<span class="n">notification</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">notification</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_register_notify</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span>
				 <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_register_notify</span><span class="p">.</span><span class="n">event_mask</span><span class="p">,</span>
				 <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_register_notify</span><span class="p">.</span><span class="n">notify_type</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">notification</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_register_notify</span><span class="p">.</span><span class="n">notification</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notification</span><span class="p">,</span>
		  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_reserve_memory ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_reserve_memory</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">prsv_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_rsvmem</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_rsvmem</span><span class="p">.</span><span class="n">size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PG_SIZE4K</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_reserve_memory</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span>
				     <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_rsvmem</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prsv_addr</span><span class="p">,</span>
				     <span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">prsv_addr</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_rsvmem</span><span class="p">.</span><span class="n">rsv_addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">proc_un_reserve_memory</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_rsvmem</span><span class="p">.</span>
					       <span class="n">processor</span><span class="p">,</span> <span class="n">prsv_addr</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_start ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_start</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">proc_start</span><span class="p">(((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_un_map ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_un_map</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_un_map</span><span class="p">(((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">,</span>
			     <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_unmapmem</span><span class="p">.</span><span class="n">map_addr</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_un_reserve_memory ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_un_reserve_memory</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">proc_un_reserve_memory</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span>
					<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_unrsvmem</span><span class="p">.</span><span class="n">rsv_addr</span><span class="p">,</span>
					<span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== procwrap_stop ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">procwrap_stop</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">proc_stop</span><span class="p">(((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== find_handle =========</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">find_node_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">**</span><span class="n">noderes</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hnode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="o">*</span><span class="n">noderes</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">,</span>
								<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hnode</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_allocate ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_allocate</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="n">node_uuid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cb_data_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocate</span><span class="p">.</span><span class="n">args</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pargs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_nodeattrin</span> <span class="n">proc_attr_in</span><span class="p">,</span> <span class="o">*</span><span class="n">attr_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nodeid</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="cm">/* Optional argument */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">cb_data_size</span><span class="p">,</span> <span class="n">psize</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="n">cb_data_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pargs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">cb_data_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pargs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">pargs</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocate</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			  <span class="n">cb_data_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_uuid</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocate</span><span class="p">.</span><span class="n">node_id_ptr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="cm">/* Optional argument */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocate</span><span class="p">.</span><span class="n">attr_in</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proc_attr_in</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocate</span><span class="p">.</span><span class="n">attr_in</span><span class="p">,</span>
			  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="n">attr_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">proc_attr_in</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">node_allocate</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">node_uuid</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_cbdata</span> <span class="o">*</span><span class="p">)</span><span class="n">pargs</span><span class="p">,</span>
				       <span class="n">attr_in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nodeid</span> <span class="o">=</span> <span class="n">node_res</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocate</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nodeid</span><span class="p">,</span>
			<span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">node_delete</span><span class="p">(</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">func_cont:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pargs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== nodewrap_alloc_msg_buf ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_alloc_msg_buf</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_bufferattr</span> <span class="o">*</span><span class="n">pattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_bufferattr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span>  <span class="n">pr_ctxt</span><span class="p">,</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocmsgbuf</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocmsgbuf</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocmsgbuf</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Optional argument */</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocmsgbuf</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="n">pattr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="cm">/* argument */</span>
	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocmsgbuf</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">node_alloc_msg_buf</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
					    <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocmsgbuf</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
					    <span class="n">pattr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbuffer</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_allocmsgbuf</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_change_priority ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_change_priority</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_changepriority</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">node_change_priority</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
				   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_changepriority</span><span class="p">.</span><span class="n">prio</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_connect ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_connect</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_strmattr</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_strmattr</span> <span class="o">*</span><span class="n">pattrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cb_data_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">conn_param</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pargs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res1</span><span class="p">,</span> <span class="o">*</span><span class="n">node_res2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_object</span> <span class="o">*</span><span class="n">node1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">node2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">node</span> <span class="o">!=</span> <span class="n">DSP_HGPPNODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res1</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node_res1</span><span class="p">)</span>
			<span class="n">node1</span> <span class="o">=</span> <span class="n">node_res1</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">node1</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">node</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">other_node</span> <span class="o">!=</span> <span class="n">DSP_HGPPNODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res2</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">other_node</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node_res2</span><span class="p">)</span>
			<span class="n">node2</span> <span class="o">=</span> <span class="n">node_res2</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">node2</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">other_node</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node1</span> <span class="o">||</span> <span class="o">!</span><span class="n">node2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Optional argument */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psize</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">cb_data_size</span><span class="p">,</span> <span class="n">psize</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="n">cb_data_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pargs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">cb_data_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pargs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">pargs</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">conn_param</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			  <span class="n">cb_data_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">attrs</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Optional argument */</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attrs</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">attrs</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="n">pattrs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">node_connect</span><span class="p">(</span><span class="n">node1</span><span class="p">,</span>
				      <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">stream_id</span><span class="p">,</span>
				      <span class="n">node2</span><span class="p">,</span>
				      <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_connect</span><span class="p">.</span><span class="n">other_stream</span><span class="p">,</span>
				      <span class="n">pattrs</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dsp_cbdata</span> <span class="o">*</span><span class="p">)</span><span class="n">pargs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">func_cont:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pargs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_create ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_create</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_create</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">node_create</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_delete ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_delete</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_delete</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">node_delete</span><span class="p">(</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== nodewrap_free_msg_buf ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_free_msg_buf</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_bufferattr</span> <span class="o">*</span><span class="n">pattr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_bufferattr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_freemsgbuf</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_freemsgbuf</span><span class="p">.</span><span class="n">attr</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Optional argument */</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_freemsgbuf</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="n">pattr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_freemsgbuf</span><span class="p">.</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">node_free_msg_buf</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
					   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_freemsgbuf</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span>
					   <span class="n">pattr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_get_attr ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_get_attr</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_nodeattr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_getattr</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">node_get_attr</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span>
			       <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_getattr</span><span class="p">.</span><span class="n">attr_size</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_getattr</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_get_message ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_get_message</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_getmessage</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">node_get_message</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
				  <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_getmessage</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>

	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_getmessage</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_pause ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_pause</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_pause</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">node_pause</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_put_message ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_put_message</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_putmessage</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_putmessage</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">node_put_message</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span>
				     <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_putmessage</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_register_notify ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_register_notify</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_notification</span> <span class="n">notification</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_registernotify</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Initialize the notification data structure */</span>
	<span class="n">notification</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">notification</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_register_notify</span><span class="p">.</span><span class="n">event_mask</span><span class="p">)</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notification</span><span class="p">,</span>
			  <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_proc_register_notify</span><span class="p">.</span><span class="n">notification</span><span class="p">,</span>
			  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">node_register_notify</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
				      <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_registernotify</span><span class="p">.</span><span class="n">event_mask</span><span class="p">,</span>
				      <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_registernotify</span><span class="p">.</span>
				      <span class="n">notify_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notification</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_registernotify</span><span class="p">.</span><span class="n">notification</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notification</span><span class="p">,</span>
		  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_run ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_run</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_run</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">node_run</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_terminate ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_terminate</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tempstatus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_terminate</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">node_terminate</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempstatus</span><span class="p">);</span>

	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_terminate</span><span class="p">.</span><span class="n">status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tempstatus</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== nodewrap_get_uuid_props ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">nodewrap_get_uuid_props</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="n">node_uuid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_ndbprops</span> <span class="o">*</span><span class="n">pnode_props</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_uuid</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_getuuidprops</span><span class="p">.</span><span class="n">node_id_ptr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		  <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="n">pnode_props</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_ndbprops</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnode_props</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">node_get_uuid_props</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node_uuid</span><span class="p">,</span> <span class="n">pnode_props</span><span class="p">);</span>
		<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_node_getuuidprops</span><span class="p">.</span><span class="n">node_props</span><span class="p">,</span> <span class="n">pnode_props</span><span class="p">,</span>
			  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="nl">func_cont:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pnode_props</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== find_strm_handle =========</span>
<span class="cm"> */</span>
<span class="kr">inline</span> <span class="kt">void</span> <span class="nf">find_strm_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">**</span><span class="n">strmres</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">hstream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="o">*</span><span class="n">strmres</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stream_id</span><span class="p">,</span>
							<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hstream</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_allocate_buffer ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_allocate_buffer</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">**</span><span class="n">ap_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_bufs</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_allocatebuffer</span><span class="p">.</span><span class="n">num_bufs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res</span><span class="p">;</span>

	<span class="n">find_strm_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_allocatebuffer</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strm_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_bufs</span> <span class="o">&gt;</span> <span class="n">MAX_BUFS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ap_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">num_bufs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">strm_allocate_buffer</span><span class="p">(</span><span class="n">strm_res</span><span class="p">,</span>
				      <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_allocatebuffer</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
				      <span class="n">ap_buffer</span><span class="p">,</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_allocatebuffer</span><span class="p">.</span><span class="n">ap_buffer</span><span class="p">,</span> <span class="n">ap_buffer</span><span class="p">,</span>
			  <span class="n">status</span><span class="p">,</span> <span class="n">num_bufs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">strm_free_buffer</span><span class="p">(</span><span class="n">strm_res</span><span class="p">,</span>
					 <span class="n">ap_buffer</span><span class="p">,</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ap_buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_close ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_close</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res</span><span class="p">;</span>

	<span class="n">find_strm_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_close</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strm_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strm_close</span><span class="p">(</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_free_buffer ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_free_buffer</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">**</span><span class="n">ap_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_bufs</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_freebuffer</span><span class="p">.</span><span class="n">num_bufs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res</span><span class="p">;</span>

	<span class="n">find_strm_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_freebuffer</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strm_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_bufs</span> <span class="o">&gt;</span> <span class="n">MAX_BUFS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ap_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">((</span><span class="n">num_bufs</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">ap_buffer</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_freebuffer</span><span class="p">.</span><span class="n">ap_buffer</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		  <span class="n">num_bufs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">strm_free_buffer</span><span class="p">(</span><span class="n">strm_res</span><span class="p">,</span>
					  <span class="n">ap_buffer</span><span class="p">,</span> <span class="n">num_bufs</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">);</span>

	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_freebuffer</span><span class="p">.</span><span class="n">ap_buffer</span><span class="p">,</span> <span class="n">ap_buffer</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		  <span class="n">num_bufs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ap_buffer</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_get_event_handle ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="n">__deprecated</span> <span class="nf">strmwrap_get_event_handle</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span> <span class="n">args</span><span class="p">,</span>
					   <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: deprecated dspbridge ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_get_info ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_get_info</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stream_info</span> <span class="n">strm_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_streaminfo</span> <span class="n">user</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_streaminfo</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res</span><span class="p">;</span>

	<span class="n">find_strm_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_getinfo</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strm_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_info</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_getinfo</span><span class="p">.</span><span class="n">stream_info</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">strm_info</span><span class="p">.</span><span class="n">user_strm</span><span class="p">;</span>

	<span class="n">strm_info</span><span class="p">.</span><span class="n">user_strm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">user</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">strm_get_info</span><span class="p">(</span><span class="n">strm_res</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">strm_info</span><span class="p">,</span>
				       <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_getinfo</span><span class="p">.</span>
				       <span class="n">stream_info_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">strm_info</span><span class="p">.</span><span class="n">user_strm</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strm_info</span><span class="p">.</span><span class="n">user_strm</span> <span class="o">=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_getinfo</span><span class="p">.</span><span class="n">stream_info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">strm_info</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_idle ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_idle</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res</span><span class="p">;</span>

	<span class="n">find_strm_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_idle</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strm_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strm_idle</span><span class="p">(</span><span class="n">strm_res</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_idle</span><span class="p">.</span><span class="n">flush_flag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_issue ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_issue</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res</span><span class="p">;</span>

	<span class="n">find_strm_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_issue</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strm_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_issue</span><span class="p">.</span><span class="n">buffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* No need of doing CP_FM_USR for the user buffer (pbuffer)</span>
<span class="cm">	   as this is done in Bridge internal function bridge_chnl_add_io_req</span>
<span class="cm">	   in chnl_sm.c */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">strm_issue</span><span class="p">(</span><span class="n">strm_res</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span>
			    <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_issue</span><span class="p">.</span><span class="n">buffer</span><span class="p">,</span>
			    <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_issue</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span>
			    <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_issue</span><span class="p">.</span><span class="n">buf_size</span><span class="p">,</span>
			    <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_issue</span><span class="p">.</span><span class="n">arg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_open ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_open</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_attr</span> <span class="n">attr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_streamattrin</span> <span class="n">strm_attr_in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_res_object</span> <span class="o">*</span><span class="n">node_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">strmid</span><span class="p">;</span>

	<span class="n">find_node_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_open</span><span class="p">.</span><span class="n">node</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">node_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_open</span><span class="p">.</span><span class="n">attr_in</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">stream_attr_in</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Optional argument */</span>
		<span class="n">CP_FM_USR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_attr_in</span><span class="p">,</span> <span class="n">attr</span><span class="p">.</span><span class="n">stream_attr_in</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">attr</span><span class="p">.</span><span class="n">stream_attr_in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">strm_attr_in</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attr</span><span class="p">.</span><span class="n">stream_attr_in</span><span class="o">-&gt;</span><span class="n">strm_mode</span> <span class="o">==</span> <span class="n">STRMMODE_LDMA</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">strm_open</span><span class="p">(</span><span class="n">node_res</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span>
			   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_open</span><span class="p">.</span><span class="n">direction</span><span class="p">,</span>
			   <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_open</span><span class="p">.</span><span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">strm_res_obj</span><span class="p">,</span>
			   <span class="n">pr_ctxt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strmid</span> <span class="o">=</span> <span class="n">strm_res_obj</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_open</span><span class="p">.</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">strmid</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_reclaim ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_reclaim</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf_ptr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ul_bytes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw_arg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ul_buf_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res</span><span class="p">;</span>

	<span class="n">find_strm_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_reclaim</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strm_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">strm_reclaim</span><span class="p">(</span><span class="n">strm_res</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_ptr</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">ul_bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul_buf_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw_arg</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_reclaim</span><span class="p">.</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf_ptr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_reclaim</span><span class="p">.</span><span class="n">bytes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul_bytes</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_reclaim</span><span class="p">.</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dw_arg</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_reclaim</span><span class="p">.</span><span class="n">buf_size_ptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_reclaim</span><span class="p">.</span><span class="n">buf_size_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul_buf_size</span><span class="p">,</span>
			  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_register_notify ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_register_notify</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_notification</span> <span class="n">notification</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res</span><span class="p">;</span>

	<span class="n">find_strm_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_registernotify</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strm_res</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Initialize the notification data structure */</span>
	<span class="n">notification</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">notification</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">strm_register_notify</span><span class="p">(</span><span class="n">strm_res</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">,</span>
				      <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_registernotify</span><span class="p">.</span><span class="n">event_mask</span><span class="p">,</span>
				      <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_registernotify</span><span class="p">.</span>
				      <span class="n">notify_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notification</span><span class="p">);</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_registernotify</span><span class="p">.</span><span class="n">notification</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">notification</span><span class="p">,</span>
		  <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== strmwrap_select ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">strmwrap_select</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_object</span> <span class="o">*</span><span class="n">strm_tab</span><span class="p">[</span><span class="n">MAX_STREAMS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">strm_res_object</span> <span class="o">*</span><span class="n">strm_res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">ids</span><span class="p">[</span><span class="n">MAX_STREAMS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_select</span><span class="p">.</span><span class="n">strm_num</span> <span class="o">&gt;</span> <span class="n">MAX_STREAMS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">CP_FM_USR</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_select</span><span class="p">.</span><span class="n">stream_tab</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_select</span><span class="p">.</span><span class="n">strm_num</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_select</span><span class="p">.</span><span class="n">strm_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">find_strm_handle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">strm_res</span><span class="p">,</span> <span class="n">pr_ctxt</span><span class="p">,</span> <span class="n">ids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strm_res</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">strm_tab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">strm_res</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">strm_select</span><span class="p">(</span><span class="n">strm_tab</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_select</span><span class="p">.</span><span class="n">strm_num</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_select</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_strm_select</span><span class="p">.</span><span class="n">mask</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mask</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* CMM */</span>

<span class="cm">/*</span>
<span class="cm"> * ======== cmmwrap_calloc_buf ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="n">__deprecated</span> <span class="nf">cmmwrap_calloc_buf</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This operation is done in kernel */</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: deprecated dspbridge ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== cmmwrap_free_buf ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="n">__deprecated</span> <span class="nf">cmmwrap_free_buf</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This operation is done in kernel */</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: deprecated dspbridge ioctl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== cmmwrap_get_handle ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">cmmwrap_get_handle</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmm_object</span> <span class="o">*</span><span class="n">hcmm_mgr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">hprocessor</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">process_context</span> <span class="o">*</span><span class="p">)</span><span class="n">pr_ctxt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">processor</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cmm_get_handle</span><span class="p">(</span><span class="n">hprocessor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcmm_mgr</span><span class="p">);</span>

	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_cmm_gethandle</span><span class="p">.</span><span class="n">cmm_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hcmm_mgr</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ======== cmmwrap_get_info ========</span>
<span class="cm"> */</span>
<span class="n">u32</span> <span class="nf">cmmwrap_get_info</span><span class="p">(</span><span class="k">union</span> <span class="n">trapped_args</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pr_ctxt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmm_info</span> <span class="n">cmm_info_obj</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cmm_get_info</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_cmm_getinfo</span><span class="p">.</span><span class="n">cmm_mgr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmm_info_obj</span><span class="p">);</span>

	<span class="n">CP_TO_USR</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">args_cmm_getinfo</span><span class="p">.</span><span class="n">cmm_info_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmm_info_obj</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
		  <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
