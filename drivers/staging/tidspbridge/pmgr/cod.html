<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › tidspbridge › pmgr › cod.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cod.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * cod.c</span>
<span class="cm"> *</span>
<span class="cm"> * DSP-BIOS Bridge driver support functions for TI OMAP processors.</span>
<span class="cm"> *</span>
<span class="cm"> * This module implements DSP code management for the DSP/BIOS Bridge</span>
<span class="cm"> * environment. It is mostly a thin wrapper.</span>
<span class="cm"> *</span>
<span class="cm"> * This module provides an interface for loading both static and</span>
<span class="cm"> * dynamic code objects onto DSP systems.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This package is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS PACKAGE IS PROVIDED ``AS IS&#39;&#39; AND WITHOUT ANY EXPRESS OR</span>
<span class="cm"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
<span class="cm"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cm">/*  ----------------------------------- Host OS */</span>
<span class="cp">#include &lt;dspbridge/host_os.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>

<span class="cm">/*  ----------------------------------- DSP/BIOS Bridge */</span>
<span class="cp">#include &lt;dspbridge/dbdefs.h&gt;</span>

<span class="cm">/*  ----------------------------------- Platform Manager */</span>
<span class="cm">/* Include appropriate loader header file */</span>
<span class="cp">#include &lt;dspbridge/dbll.h&gt;</span>

<span class="cm">/*  ----------------------------------- This */</span>
<span class="cp">#include &lt;dspbridge/cod.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_manager ========</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cod_manager</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="n">target</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">base_lib</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">loaded</span><span class="p">;</span>		<span class="cm">/* Base library loaded? */</span>
	<span class="n">u32</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_fxns</span> <span class="n">fxns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="n">attrs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sz_zl_file</span><span class="p">[</span><span class="n">COD_MAXPATHLENGTH</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_libraryobj ========</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">cod_libraryobj</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">dbll_lib</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">dbll_fxns</span> <span class="n">ldr_fxns</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="n">dbll_close_fxn</span><span class="p">)</span> <span class="n">dbll_close</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_create_fxn</span><span class="p">)</span> <span class="n">dbll_create</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_delete_fxn</span><span class="p">)</span> <span class="n">dbll_delete</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_exit_fxn</span><span class="p">)</span> <span class="n">dbll_exit</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_get_attrs_fxn</span><span class="p">)</span> <span class="n">dbll_get_attrs</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_get_addr_fxn</span><span class="p">)</span> <span class="n">dbll_get_addr</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_get_c_addr_fxn</span><span class="p">)</span> <span class="n">dbll_get_c_addr</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_get_sect_fxn</span><span class="p">)</span> <span class="n">dbll_get_sect</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_init_fxn</span><span class="p">)</span> <span class="n">dbll_init</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_load_fxn</span><span class="p">)</span> <span class="n">dbll_load</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_open_fxn</span><span class="p">)</span> <span class="n">dbll_open</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_read_sect_fxn</span><span class="p">)</span> <span class="n">dbll_read_sect</span><span class="p">,</span>
	<span class="p">(</span><span class="n">dbll_unload_fxn</span><span class="p">)</span> <span class="n">dbll_unload</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">no_op</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * File operations (originally were under kfile.c)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">cod_f_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check for valid handle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">filp_close</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* we can&#39;t use 0 here */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">cod_f_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">psz_file_name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sz_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">;</span>

	<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>

	<span class="cm">/* ignore given mode and open file as read-only */</span>
	<span class="n">filp</span> <span class="o">=</span> <span class="n">filp_open</span><span class="p">(</span><span class="n">psz_file_name</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">filp</span><span class="p">))</span>
		<span class="n">filp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">filp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">cod_f_read</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">pbuffer</span><span class="p">,</span> <span class="n">s32</span> <span class="n">size</span><span class="p">,</span> <span class="n">s32</span> <span class="n">count</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check for valid file handle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pbuffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">dw_bytes_read</span><span class="p">;</span>
		<span class="n">mm_segment_t</span> <span class="n">fs</span><span class="p">;</span>

		<span class="cm">/* read from file */</span>
		<span class="n">fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">get_ds</span><span class="p">());</span>
		<span class="n">dw_bytes_read</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">pbuffer</span><span class="p">,</span> <span class="n">size</span> <span class="o">*</span> <span class="n">count</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_pos</span><span class="p">));</span>
		<span class="n">set_fs</span><span class="p">(</span><span class="n">fs</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dw_bytes_read</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">dw_bytes_read</span> <span class="o">/</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">cod_f_seek</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="n">s32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">s32</span> <span class="n">origin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">dw_cur_pos</span><span class="p">;</span>

	<span class="cm">/* check for valid file handle */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* based on the origin flag, move the internal pointer */</span>
	<span class="n">dw_cur_pos</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">llseek</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">origin</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span> <span class="n">dw_cur_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* we can&#39;t use 0 here */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">cod_f_tell</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">loff_t</span> <span class="n">dw_cur_pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filp</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* Get current position */</span>
	<span class="n">dw_cur_pos</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">llseek</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_CUR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span> <span class="n">dw_cur_pos</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dw_cur_pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_close ========</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cod_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_libraryobj</span> <span class="o">*</span><span class="n">lib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">hmgr</span><span class="p">;</span>

	<span class="n">hmgr</span> <span class="o">=</span> <span class="n">lib</span><span class="o">-&gt;</span><span class="n">cod_mgr</span><span class="p">;</span>
	<span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">close_fxn</span><span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">dbll_lib</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">lib</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_create ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Create an object to manage code on a DSP system.</span>
<span class="cm"> *      This object can be used to load an initial program image with</span>
<span class="cm"> *      arguments that can later be expanded with</span>
<span class="cm"> *      dynamically loaded object files.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">**</span><span class="n">mgr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_zl_file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">mgr_new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="n">zl_attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* assume failure */</span>
	<span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mgr_new</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgr_new</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Set up loader functions */</span>
	<span class="n">mgr_new</span><span class="o">-&gt;</span><span class="n">fxns</span> <span class="o">=</span> <span class="n">ldr_fxns</span><span class="p">;</span>

	<span class="cm">/* initialize the ZL module */</span>
	<span class="n">mgr_new</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">init_fxn</span><span class="p">();</span>

	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_alloc_fxn</span><span class="p">)</span> <span class="n">no_op</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_free_fxn</span><span class="p">)</span> <span class="n">no_op</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">fread</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_read_fxn</span><span class="p">)</span> <span class="n">cod_f_read</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">fseek</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_seek_fxn</span><span class="p">)</span> <span class="n">cod_f_seek</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">ftell</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_tell_fxn</span><span class="p">)</span> <span class="n">cod_f_tell</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">fclose</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_f_close_fxn</span><span class="p">)</span> <span class="n">cod_f_close</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">fopen</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_f_open_fxn</span><span class="p">)</span> <span class="n">cod_f_open</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">sym_lookup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">base_image</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">log_write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">log_write_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">rmm_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">input_params</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">sym_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zl_attrs</span><span class="p">.</span><span class="n">sym_arg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mgr_new</span><span class="o">-&gt;</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">zl_attrs</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">mgr_new</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">create_fxn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mgr_new</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zl_attrs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cod_delete</span><span class="p">(</span><span class="n">mgr_new</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESPIPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* return the new manager */</span>
	<span class="o">*</span><span class="n">mgr</span> <span class="o">=</span> <span class="n">mgr_new</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_delete ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Delete a code manager object.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">cod_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">loaded</span><span class="p">)</span>
			<span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">unload_fxn</span><span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">);</span>

		<span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">close_fxn</span><span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">delete_fxn</span><span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">);</span>
		<span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">exit_fxn</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cod_mgr_obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_get_base_lib ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Get handle to the base image DBL library.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_get_base_lib</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr_obj</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">**</span><span class="n">plib</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">plib</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_get_base_name ========</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_get_base_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr_obj</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sz_name</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">usize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usize</span> <span class="o">&lt;=</span> <span class="n">COD_MAXPATHLENGTH</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_name</span><span class="p">,</span> <span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">sz_zl_file</span><span class="p">,</span> <span class="n">usize</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_get_entry ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Retrieve the entry point of a loaded DSP program image</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_get_entry</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr_obj</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">entry_pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">entry_pt</span> <span class="o">=</span> <span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_get_loader ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Get handle to the DBLL loader.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_get_loader</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr_obj</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">**</span><span class="n">loader</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">loader</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">dbll_tar_obj</span> <span class="o">*</span><span class="p">)</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_get_section ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Retrieve the starting address and length of a section in the COFF file</span>
<span class="cm"> *      given the section name.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_get_section</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_libraryobj</span> <span class="o">*</span><span class="n">lib</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_sect</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr_obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cod_mgr_obj</span> <span class="o">=</span> <span class="n">lib</span><span class="o">-&gt;</span><span class="n">cod_mgr</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">get_sect_fxn</span><span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">dbll_lib</span><span class="p">,</span> <span class="n">str_sect</span><span class="p">,</span>
							<span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESPIPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_get_sym_value ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Retrieve the value for the specified symbol. The symbol is first</span>
<span class="cm"> *      searched for literally and then, if not found, searched for as a</span>
<span class="cm"> *      C symbol.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_get_sym_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr_obj</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_sym</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="o">*</span><span class="n">pul_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dbll_sym_val</span> <span class="o">*</span><span class="n">dbll_sym</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: cod_mgr_obj: %p str_sym: %s pul_value: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">cod_mgr_obj</span><span class="p">,</span> <span class="n">str_sym</span><span class="p">,</span> <span class="n">pul_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span>
		    <span class="n">get_addr_fxn</span><span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">,</span> <span class="n">str_sym</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dbll_sym</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span>
			    <span class="n">get_c_addr_fxn</span><span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">,</span> <span class="n">str_sym</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">dbll_sym</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ESPIPE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ESPIPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">pul_value</span> <span class="o">=</span> <span class="n">dbll_sym</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_load_base ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Load the initial program image, optionally with command-line arguments,</span>
<span class="cm"> *      on the DSP system managed by the supplied handle. The program to be</span>
<span class="cm"> *      loaded must be the first element of the args array and must be a fully</span>
<span class="cm"> *      qualified pathname.</span>
<span class="cm"> *  Details:</span>
<span class="cm"> *      if num_argc doesn&#39;t match the number of arguments in the args array, the</span>
<span class="cm"> *      args array is searched for a NULL terminating entry, and argc is</span>
<span class="cm"> *      recalculated to reflect this.  In this way, we can support NULL</span>
<span class="cm"> *      terminating args arrays, if num_argc is very large.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_load_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr_obj</span><span class="p">,</span> <span class="n">u32</span> <span class="n">num_argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">args</span><span class="p">[],</span>
			 <span class="n">cod_writefxn</span> <span class="n">pfn_write</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">envp</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">dbll_flags</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="n">save_attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_attrs</span> <span class="n">new_attrs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Make sure every argv[] stated in argc has a value, or change argc to</span>
<span class="cm">	 *  reflect true number in NULL terminated argv array.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num_argc</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set the write function for this operation */</span>
	<span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">get_attrs_fxn</span><span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">save_attrs</span><span class="p">);</span>

	<span class="n">new_attrs</span> <span class="o">=</span> <span class="n">save_attrs</span><span class="p">;</span>
	<span class="n">new_attrs</span><span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_write_fxn</span><span class="p">)</span> <span class="n">pfn_write</span><span class="p">;</span>
	<span class="n">new_attrs</span><span class="p">.</span><span class="n">input_params</span> <span class="o">=</span> <span class="n">arb</span><span class="p">;</span>
	<span class="n">new_attrs</span><span class="p">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_alloc_fxn</span><span class="p">)</span> <span class="n">no_op</span><span class="p">;</span>
	<span class="n">new_attrs</span><span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">(</span><span class="n">dbll_free_fxn</span><span class="p">)</span> <span class="n">no_op</span><span class="p">;</span>
	<span class="n">new_attrs</span><span class="p">.</span><span class="n">log_write</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">new_attrs</span><span class="p">.</span><span class="n">log_write_handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Load the image */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">DBLL_CODE</span> <span class="o">|</span> <span class="n">DBLL_DATA</span> <span class="o">|</span> <span class="n">DBLL_SYMB</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">load_fxn</span><span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">new_attrs</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">close_fxn</span><span class="p">(</span><span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cod_mgr_obj</span><span class="o">-&gt;</span><span class="n">base_lib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_open ========</span>
<span class="cm"> *      Open library for reading sections.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">hmgr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sz_coff_path</span><span class="p">,</span>
		    <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cod_libraryobj</span> <span class="o">**</span><span class="n">lib_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cod_libraryobj</span> <span class="o">*</span><span class="n">lib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">lib_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lib</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_libraryobj</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lib</span><span class="o">-&gt;</span><span class="n">cod_mgr</span> <span class="o">=</span> <span class="n">hmgr</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">open_fxn</span><span class="p">(</span><span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">sz_coff_path</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">dbll_lib</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
			<span class="o">*</span><span class="n">lib_obj</span> <span class="o">=</span> <span class="n">lib</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: error status 0x%x, sz_coff_path: %s flags: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">sz_coff_path</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_open_base ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Open base image for reading sections.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_open_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">hmgr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sz_coff_path</span><span class="p">,</span>
			 <span class="n">dbll_flags</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dbll_library_obj</span> <span class="o">*</span><span class="n">lib</span><span class="p">;</span>

	<span class="cm">/* if we previously opened a base image, close it now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">loaded</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">unload_fxn</span><span class="p">(</span><span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">attrs</span><span class="p">);</span>
			<span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">close_fxn</span><span class="p">(</span><span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">base_lib</span><span class="p">);</span>
		<span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">base_lib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">open_fxn</span><span class="p">(</span><span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">,</span> <span class="n">sz_coff_path</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lib</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* hang onto the library for subsequent sym table usage */</span>
		<span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">base_lib</span> <span class="o">=</span> <span class="n">lib</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">sz_zl_file</span><span class="p">,</span> <span class="n">sz_coff_path</span><span class="p">,</span> <span class="n">COD_MAXPATHLENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">hmgr</span><span class="o">-&gt;</span><span class="n">sz_zl_file</span><span class="p">[</span><span class="n">COD_MAXPATHLENGTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: error status 0x%x sz_coff_path: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">status</span><span class="p">,</span> <span class="n">sz_coff_path</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== cod_read_section ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Retrieve the content of a code section given the section name.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">cod_read_section</span><span class="p">(</span><span class="k">struct</span> <span class="n">cod_libraryobj</span> <span class="o">*</span><span class="n">lib</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str_sect</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">str_content</span><span class="p">,</span> <span class="n">u32</span> <span class="n">content_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">lib</span><span class="o">-&gt;</span><span class="n">cod_mgr</span><span class="o">-&gt;</span><span class="n">fxns</span><span class="p">.</span><span class="n">read_sect_fxn</span><span class="p">(</span><span class="n">lib</span><span class="o">-&gt;</span><span class="n">dbll_lib</span><span class="p">,</span> <span class="n">str_sect</span><span class="p">,</span>
						     <span class="n">str_content</span><span class="p">,</span> <span class="n">content_size</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ESPIPE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== no_op ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      No Operation.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">no_op</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
