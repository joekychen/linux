<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › tidspbridge › rmgr › disp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>disp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * disp.c</span>
<span class="cm"> *</span>
<span class="cm"> * DSP-BIOS Bridge driver support functions for TI OMAP processors.</span>
<span class="cm"> *</span>
<span class="cm"> * Node Dispatcher interface. Communicates with Resource Manager Server</span>
<span class="cm"> * (RMS) on DSP. Access to RMS is synchronized in NODE.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This package is free software;  you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS PACKAGE IS PROVIDED ``AS IS&#39;&#39; AND WITHOUT ANY EXPRESS OR</span>
<span class="cm"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
<span class="cm"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cm">/*  ----------------------------------- Host OS */</span>
<span class="cp">#include &lt;dspbridge/host_os.h&gt;</span>

<span class="cm">/*  ----------------------------------- DSP/BIOS Bridge */</span>
<span class="cp">#include &lt;dspbridge/dbdefs.h&gt;</span>

<span class="cm">/*  ----------------------------------- OS Adaptation Layer */</span>
<span class="cp">#include &lt;dspbridge/sync.h&gt;</span>

<span class="cm">/*  ----------------------------------- Link Driver */</span>
<span class="cp">#include &lt;dspbridge/dspdefs.h&gt;</span>

<span class="cm">/*  ----------------------------------- Platform Manager */</span>
<span class="cp">#include &lt;dspbridge/dev.h&gt;</span>
<span class="cp">#include &lt;dspbridge/chnldefs.h&gt;</span>

<span class="cm">/*  ----------------------------------- Resource Manager */</span>
<span class="cp">#include &lt;dspbridge/nodedefs.h&gt;</span>
<span class="cp">#include &lt;dspbridge/nodepriv.h&gt;</span>
<span class="cp">#include &lt;dspbridge/rms_sh.h&gt;</span>

<span class="cm">/*  ----------------------------------- This */</span>
<span class="cp">#include &lt;dspbridge/disp.h&gt;</span>

<span class="cm">/* Size of a reply from RMS */</span>
<span class="cp">#define REPLYSIZE (3 * sizeof(rms_word))</span>

<span class="cm">/* Reserved channel offsets for communication with RMS */</span>
<span class="cp">#define CHNLTORMSOFFSET       0</span>
<span class="cp">#define CHNLFROMRMSOFFSET     1</span>

<span class="cp">#define CHNLIOREQS      1</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== disp_object ========</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">disp_object</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">dev_object</span> <span class="o">*</span><span class="n">dev_obj</span><span class="p">;</span>	<span class="cm">/* Device for this processor */</span>
	<span class="cm">/* Function interface to Bridge driver */</span>
	<span class="k">struct</span> <span class="n">bridge_drv_interface</span> <span class="o">*</span><span class="n">intf_fxns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chnl_mgr</span> <span class="o">*</span><span class="n">chnl_mgr</span><span class="p">;</span>	<span class="cm">/* Channel manager */</span>
	<span class="k">struct</span> <span class="n">chnl_object</span> <span class="o">*</span><span class="n">chnl_to_dsp</span><span class="p">;</span>	<span class="cm">/* Chnl for commands to RMS */</span>
	<span class="k">struct</span> <span class="n">chnl_object</span> <span class="o">*</span><span class="n">chnl_from_dsp</span><span class="p">;</span>	<span class="cm">/* Chnl for replies from RMS */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>		<span class="cm">/* Buffer for commands, replies */</span>
	<span class="n">u32</span> <span class="n">bufsize</span><span class="p">;</span>		<span class="cm">/* buf size in bytes */</span>
	<span class="n">u32</span> <span class="n">bufsize_rms</span><span class="p">;</span>	<span class="cm">/* buf size in RMS words */</span>
	<span class="n">u32</span> <span class="n">char_size</span><span class="p">;</span>		<span class="cm">/* Size of DSP character */</span>
	<span class="n">u32</span> <span class="n">word_size</span><span class="p">;</span>		<span class="cm">/* Size of DSP word */</span>
	<span class="n">u32</span> <span class="n">data_mau_size</span><span class="p">;</span>	<span class="cm">/* Size of DSP Data MAU */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">delete_disp</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fill_stream_def</span><span class="p">(</span><span class="n">rms_word</span> <span class="o">*</span><span class="n">pdw_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ptotal</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">node_strmdef</span> <span class="n">strm_def</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">chars_in_rms_word</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">send_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">ul_bytes</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pdw_arg</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== disp_create ========</span>
<span class="cm"> *  Create a NODE Dispatcher object.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">disp_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">**</span><span class="n">dispatch_obj</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">dev_object</span> <span class="o">*</span><span class="n">hdev_obj</span><span class="p">,</span>
		       <span class="k">const</span> <span class="k">struct</span> <span class="n">disp_attr</span> <span class="o">*</span><span class="n">disp_attrs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bridge_drv_interface</span> <span class="o">*</span><span class="n">intf_fxns</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ul_chnl_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chnl_attr</span> <span class="n">chnl_attr_obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_type</span><span class="p">;</span>

	<span class="o">*</span><span class="n">dispatch_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Allocate Node Dispatcher object */</span>
	<span class="n">disp_obj</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disp_obj</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">dev_obj</span> <span class="o">=</span> <span class="n">hdev_obj</span><span class="p">;</span>

	<span class="cm">/* Get Channel manager and Bridge function interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dev_get_chnl_mgr</span><span class="p">(</span><span class="n">hdev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_mgr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dev_get_intf_fxns</span><span class="p">(</span><span class="n">hdev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf_fxns</span><span class="p">);</span>
			<span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">intf_fxns</span> <span class="o">=</span> <span class="n">intf_fxns</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* check device type and decide if streams or messag&#39;ing is used for</span>
<span class="cm">	 * RMS/EDS */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dev_get_dev_type</span><span class="p">(</span><span class="n">hdev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">DSP_UNIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">char_size</span> <span class="o">=</span> <span class="n">DSPWORDSIZE</span><span class="p">;</span>
	<span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">word_size</span> <span class="o">=</span> <span class="n">DSPWORDSIZE</span><span class="p">;</span>
	<span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">data_mau_size</span> <span class="o">=</span> <span class="n">DSPWORDSIZE</span><span class="p">;</span>
	<span class="cm">/* Open channels for communicating with the RMS */</span>
	<span class="n">chnl_attr_obj</span><span class="p">.</span><span class="n">uio_reqs</span> <span class="o">=</span> <span class="n">CHNLIOREQS</span><span class="p">;</span>
	<span class="n">chnl_attr_obj</span><span class="p">.</span><span class="n">event_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ul_chnl_id</span> <span class="o">=</span> <span class="n">disp_attrs</span><span class="o">-&gt;</span><span class="n">chnl_offset</span> <span class="o">+</span> <span class="n">CHNLTORMSOFFSET</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">intf_fxns</span><span class="o">-&gt;</span><span class="n">chnl_open</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_to_dsp</span><span class="p">),</span>
					      <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_mgr</span><span class="p">,</span>
					      <span class="n">CHNL_MODETODSP</span><span class="p">,</span> <span class="n">ul_chnl_id</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">chnl_attr_obj</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ul_chnl_id</span> <span class="o">=</span> <span class="n">disp_attrs</span><span class="o">-&gt;</span><span class="n">chnl_offset</span> <span class="o">+</span> <span class="n">CHNLFROMRMSOFFSET</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="p">(</span><span class="o">*</span><span class="n">intf_fxns</span><span class="o">-&gt;</span><span class="n">chnl_open</span><span class="p">)</span> <span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_from_dsp</span><span class="p">),</span>
						 <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_mgr</span><span class="p">,</span>
						 <span class="n">CHNL_MODEFROMDSP</span><span class="p">,</span> <span class="n">ul_chnl_id</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">chnl_attr_obj</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate buffer for commands, replies */</span>
		<span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">disp_attrs</span><span class="o">-&gt;</span><span class="n">chnl_buf_size</span><span class="p">;</span>
		<span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">bufsize_rms</span> <span class="o">=</span> <span class="n">RMS_COMMANDBUFSIZE</span><span class="p">;</span>
		<span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">bufsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">func_cont:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dispatch_obj</span> <span class="o">=</span> <span class="n">disp_obj</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">delete_disp</span><span class="p">(</span><span class="n">disp_obj</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== disp_delete ========</span>
<span class="cm"> *  Delete the NODE Dispatcher.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">disp_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">delete_disp</span><span class="p">(</span><span class="n">disp_obj</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== disp_node_change_priority ========</span>
<span class="cm"> *  Change the priority of a node currently running on the target.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">disp_node_change_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">node_object</span> <span class="o">*</span><span class="n">hnode</span><span class="p">,</span>
				     <span class="n">u32</span> <span class="n">rms_fxn</span><span class="p">,</span> <span class="n">nodeenv</span> <span class="n">node_env</span><span class="p">,</span> <span class="n">s32</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dw_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rms_command</span> <span class="o">*</span><span class="n">rms_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Send message to RMS to change priority */</span>
	<span class="n">rms_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rms_command</span> <span class="o">*</span><span class="p">)(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">fxn</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="p">(</span><span class="n">rms_fxn</span><span class="p">);</span>
	<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">arg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="n">node_env</span><span class="p">;</span>
	<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">prio</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">send_message</span><span class="p">(</span><span class="n">disp_obj</span><span class="p">,</span> <span class="n">node_get_timeout</span><span class="p">(</span><span class="n">hnode</span><span class="p">),</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_command</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dw_arg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== disp_node_create ========</span>
<span class="cm"> *  Create a node on the DSP by remotely calling the node&#39;s create function.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">disp_node_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">node_object</span> <span class="o">*</span><span class="n">hnode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rms_fxn</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">ul_create_fxn</span><span class="p">,</span>
			    <span class="k">const</span> <span class="k">struct</span> <span class="n">node_createargs</span> <span class="o">*</span><span class="n">pargs</span><span class="p">,</span>
			    <span class="n">nodeenv</span> <span class="o">*</span><span class="n">node_env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">node_msgargs</span> <span class="n">node_msg_args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_taskargs</span> <span class="n">task_arg_obj</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rms_command</span> <span class="o">*</span><span class="n">rms_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rms_msg_args</span> <span class="o">*</span><span class="n">pmsg_args</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rms_more_task_args</span> <span class="o">*</span><span class="n">more_task_args</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">node_type</span> <span class="n">node_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw_length</span><span class="p">;</span>
	<span class="n">rms_word</span> <span class="o">*</span><span class="n">pdw_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ul_bytes</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chars_in_rms_word</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">task_args_offset</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">sio_in_def_offset</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">sio_out_def_offset</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">sio_defs_offset</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">args_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">node_strmdef</span> <span class="n">strm_def</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_nodeinfo</span> <span class="n">node_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_type</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dev_get_dev_type</span><span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">!=</span> <span class="n">DSP_UNIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: unknown device type = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">dev_type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">node_type</span> <span class="o">=</span> <span class="n">node_get_type</span><span class="p">(</span><span class="n">hnode</span><span class="p">);</span>
	<span class="n">node_msg_args</span> <span class="o">=</span> <span class="n">pargs</span><span class="o">-&gt;</span><span class="n">asa</span><span class="p">.</span><span class="n">node_msg_args</span><span class="p">;</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">bufsize_rms</span><span class="p">;</span>	<span class="cm">/*Max # of RMS words that can be sent */</span>
	<span class="n">chars_in_rms_word</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="o">/</span> <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">char_size</span><span class="p">;</span>
	<span class="cm">/* Number of RMS words needed to hold arg data */</span>
	<span class="n">dw_length</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">node_msg_args</span><span class="p">.</span><span class="n">arg_length</span> <span class="o">+</span> <span class="n">chars_in_rms_word</span> <span class="o">-</span>
	     <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">chars_in_rms_word</span><span class="p">;</span>
	<span class="cm">/* Make sure msg args and command fit in buffer */</span>
	<span class="n">total</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_command</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="o">+</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_msg_args</span><span class="p">)</span>
	    <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dw_length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: Message args too large for buffer! size &quot;</span>
			<span class="s">&quot;= %d, max = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 *  Fill in buffer to send to RMS.</span>
<span class="cm">	 *  The buffer will have the following  format:</span>
<span class="cm">	 *</span>
<span class="cm">	 *  RMS command:</span>
<span class="cm">	 *      Address of RMS_CreateNode()</span>
<span class="cm">	 *      Address of node&#39;s create function</span>
<span class="cm">	 *      dummy argument</span>
<span class="cm">	 *      node type</span>
<span class="cm">	 *</span>
<span class="cm">	 *  Message Args:</span>
<span class="cm">	 *      max number of messages</span>
<span class="cm">	 *      segid for message buffer allocation</span>
<span class="cm">	 *      notification type to use when message is received</span>
<span class="cm">	 *      length of message arg data</span>
<span class="cm">	 *      message args data</span>
<span class="cm">	 *</span>
<span class="cm">	 *  Task Args (if task or socket node):</span>
<span class="cm">	 *      priority</span>
<span class="cm">	 *      stack size</span>
<span class="cm">	 *      system stack size</span>
<span class="cm">	 *      stack segment</span>
<span class="cm">	 *      misc</span>
<span class="cm">	 *      number of input streams</span>
<span class="cm">	 *      pSTRMInDef[] - offsets of STRM definitions for input streams</span>
<span class="cm">	 *      number of output streams</span>
<span class="cm">	 *      pSTRMOutDef[] - offsets of STRM definitions for output</span>
<span class="cm">	 *      streams</span>
<span class="cm">	 *      STRMInDef[] - array of STRM definitions for input streams</span>
<span class="cm">	 *      STRMOutDef[] - array of STRM definitions for output streams</span>
<span class="cm">	 *</span>
<span class="cm">	 *  Socket Args (if DAIS socket node):</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Total number of words in buffer so far */</span>
		<span class="n">pdw_buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span> <span class="o">*</span><span class="p">)</span> <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">rms_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rms_command</span> <span class="o">*</span><span class="p">)</span><span class="n">pdw_buf</span><span class="p">;</span>
		<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">fxn</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="p">(</span><span class="n">rms_fxn</span><span class="p">);</span>
		<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">arg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="p">(</span><span class="n">ul_create_fxn</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">node_get_load_type</span><span class="p">(</span><span class="n">hnode</span><span class="p">)</span> <span class="o">==</span> <span class="n">NLDR_DYNAMICLOAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Flush ICACHE on Load */</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">arg2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* dummy argument */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Do not flush ICACHE */</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">arg2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* dummy argument */</span>
		<span class="p">}</span>
		<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">node_get_type</span><span class="p">(</span><span class="n">hnode</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 *  args_offset is the offset of the data field in struct</span>
<span class="cm">		 *  rms_command structure. We need this to calculate stream</span>
<span class="cm">		 *  definition offsets.</span>
<span class="cm">		 */</span>
		<span class="n">args_offset</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_command</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">);</span>
		<span class="cm">/* Message args */</span>
		<span class="n">pmsg_args</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rms_msg_args</span> <span class="o">*</span><span class="p">)(</span><span class="n">pdw_buf</span> <span class="o">+</span> <span class="n">total</span><span class="p">);</span>
		<span class="n">pmsg_args</span><span class="o">-&gt;</span><span class="n">max_msgs</span> <span class="o">=</span> <span class="n">node_msg_args</span><span class="p">.</span><span class="n">max_msgs</span><span class="p">;</span>
		<span class="n">pmsg_args</span><span class="o">-&gt;</span><span class="n">segid</span> <span class="o">=</span> <span class="n">node_msg_args</span><span class="p">.</span><span class="n">seg_id</span><span class="p">;</span>
		<span class="n">pmsg_args</span><span class="o">-&gt;</span><span class="n">notify_type</span> <span class="o">=</span> <span class="n">node_msg_args</span><span class="p">.</span><span class="n">notify_type</span><span class="p">;</span>
		<span class="n">pmsg_args</span><span class="o">-&gt;</span><span class="n">arg_length</span> <span class="o">=</span> <span class="n">node_msg_args</span><span class="p">.</span><span class="n">arg_length</span><span class="p">;</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_msg_args</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pdw_buf</span> <span class="o">+</span> <span class="n">total</span><span class="p">,</span> <span class="n">node_msg_args</span><span class="p">.</span><span class="n">pdata</span><span class="p">,</span>
		       <span class="n">node_msg_args</span><span class="p">.</span><span class="n">arg_length</span><span class="p">);</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">dw_length</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>

	<span class="cm">/* If node is a task node, copy task create arguments into  buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">node_type</span> <span class="o">==</span> <span class="n">NODE_TASK</span> <span class="o">||</span> <span class="n">node_type</span> <span class="o">==</span> <span class="n">NODE_DAISSOCKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task_arg_obj</span> <span class="o">=</span> <span class="n">pargs</span><span class="o">-&gt;</span><span class="n">asa</span><span class="p">.</span><span class="n">task_arg_obj</span><span class="p">;</span>
		<span class="n">task_args_offset</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_more_task_args</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="o">+</span>
		    <span class="mi">1</span> <span class="o">+</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">num_inputs</span> <span class="o">+</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">num_outputs</span><span class="p">;</span>
		<span class="cm">/* Copy task arguments */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">total</span> <span class="o">=</span> <span class="n">task_args_offset</span><span class="p">;</span>
			<span class="n">more_task_args</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rms_more_task_args</span> <span class="o">*</span><span class="p">)(</span><span class="n">pdw_buf</span> <span class="o">+</span>
								       <span class="n">total</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Get some important info about the node. Note that we</span>
<span class="cm">			 * don&#39;t just reach into the hnode struct because</span>
<span class="cm">			 * that would break the node object&#39;s abstraction.</span>
<span class="cm">			 */</span>
			<span class="n">get_node_info</span><span class="p">(</span><span class="n">hnode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node_info</span><span class="p">);</span>
			<span class="n">more_task_args</span><span class="o">-&gt;</span><span class="n">priority</span> <span class="o">=</span> <span class="n">node_info</span><span class="p">.</span><span class="n">execution_priority</span><span class="p">;</span>
			<span class="n">more_task_args</span><span class="o">-&gt;</span><span class="n">stack_size</span> <span class="o">=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">stack_size</span><span class="p">;</span>
			<span class="n">more_task_args</span><span class="o">-&gt;</span><span class="n">sysstack_size</span> <span class="o">=</span>
			    <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">sys_stack_size</span><span class="p">;</span>
			<span class="n">more_task_args</span><span class="o">-&gt;</span><span class="n">stack_seg</span> <span class="o">=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">stack_seg</span><span class="p">;</span>
			<span class="n">more_task_args</span><span class="o">-&gt;</span><span class="n">heap_addr</span> <span class="o">=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">dsp_heap_addr</span><span class="p">;</span>
			<span class="n">more_task_args</span><span class="o">-&gt;</span><span class="n">heap_size</span> <span class="o">=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">heap_size</span><span class="p">;</span>
			<span class="n">more_task_args</span><span class="o">-&gt;</span><span class="n">misc</span> <span class="o">=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">dais_arg</span><span class="p">;</span>
			<span class="n">more_task_args</span><span class="o">-&gt;</span><span class="n">num_input_streams</span> <span class="o">=</span>
			    <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">num_inputs</span><span class="p">;</span>
			<span class="n">total</span> <span class="o">+=</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_more_task_args</span><span class="p">)</span> <span class="o">/</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: dsp_heap_addr %x, heap_size %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">dsp_heap_addr</span><span class="p">,</span>
				<span class="n">task_arg_obj</span><span class="p">.</span><span class="n">heap_size</span><span class="p">);</span>
			<span class="cm">/* Keep track of pSIOInDef[] and pSIOOutDef[]</span>
<span class="cm">			 * positions in the buffer, since this needs to be</span>
<span class="cm">			 * filled in later. */</span>
			<span class="n">sio_in_def_offset</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
			<span class="n">total</span> <span class="o">+=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">num_inputs</span><span class="p">;</span>
			<span class="n">pdw_buf</span><span class="p">[</span><span class="n">total</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">num_outputs</span><span class="p">;</span>
			<span class="n">sio_out_def_offset</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
			<span class="n">total</span> <span class="o">+=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">num_outputs</span><span class="p">;</span>
			<span class="n">sio_defs_offset</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
			<span class="cm">/* Fill SIO defs and offsets */</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">sio_defs_offset</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">num_inputs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">pdw_buf</span><span class="p">[</span><span class="n">sio_in_def_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">args_offset</span><span class="p">)</span>
				    <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="o">/</span> <span class="n">DSPWORDSIZE</span><span class="p">);</span>
				<span class="n">strm_def</span> <span class="o">=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">strm_in_def</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">status</span> <span class="o">=</span>
				    <span class="n">fill_stream_def</span><span class="p">(</span><span class="n">pdw_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						    <span class="n">strm_def</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span>
						    <span class="n">chars_in_rms_word</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">num_outputs</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pdw_buf</span><span class="p">[</span><span class="n">sio_out_def_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">args_offset</span><span class="p">)</span>
				    <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="o">/</span> <span class="n">DSPWORDSIZE</span><span class="p">);</span>
				<span class="n">strm_def</span> <span class="o">=</span> <span class="n">task_arg_obj</span><span class="p">.</span><span class="n">strm_out_def</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="n">status</span> <span class="o">=</span>
				    <span class="n">fill_stream_def</span><span class="p">(</span><span class="n">pdw_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">total</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
						    <span class="n">strm_def</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span>
						    <span class="n">chars_in_rms_word</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Args won&#39;t fit */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ul_bytes</span> <span class="o">=</span> <span class="n">total</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">send_message</span><span class="p">(</span><span class="n">disp_obj</span><span class="p">,</span> <span class="n">node_get_timeout</span><span class="p">(</span><span class="n">hnode</span><span class="p">),</span>
				      <span class="n">ul_bytes</span><span class="p">,</span> <span class="n">node_env</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">func_end:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== disp_node_delete ========</span>
<span class="cm"> *  purpose:</span>
<span class="cm"> *      Delete a node on the DSP by remotely calling the node&#39;s delete function.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">disp_node_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">node_object</span> <span class="o">*</span><span class="n">hnode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rms_fxn</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">ul_delete_fxn</span><span class="p">,</span> <span class="n">nodeenv</span> <span class="n">node_env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dw_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rms_command</span> <span class="o">*</span><span class="n">rms_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_type</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dev_get_dev_type</span><span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">DSP_UNIT</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 *  Fill in buffer to send to RMS</span>
<span class="cm">			 */</span>
			<span class="n">rms_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rms_command</span> <span class="o">*</span><span class="p">)</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">fxn</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="p">(</span><span class="n">rms_fxn</span><span class="p">);</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">arg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="n">node_env</span><span class="p">;</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">arg2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="p">(</span><span class="n">ul_delete_fxn</span><span class="p">);</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">node_get_type</span><span class="p">(</span><span class="n">hnode</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">send_message</span><span class="p">(</span><span class="n">disp_obj</span><span class="p">,</span> <span class="n">node_get_timeout</span><span class="p">(</span><span class="n">hnode</span><span class="p">),</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_command</span><span class="p">),</span>
					      <span class="o">&amp;</span><span class="n">dw_arg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== disp_node_run ========</span>
<span class="cm"> *  purpose:</span>
<span class="cm"> *      Start execution of a node&#39;s execute phase, or resume execution of a node</span>
<span class="cm"> *      that has been suspended (via DISP_NodePause()) on the DSP.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">disp_node_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">node_object</span> <span class="o">*</span><span class="n">hnode</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rms_fxn</span><span class="p">,</span>
			 <span class="n">u32</span> <span class="n">ul_execute_fxn</span><span class="p">,</span> <span class="n">nodeenv</span> <span class="n">node_env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dw_arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rms_command</span> <span class="o">*</span><span class="n">rms_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dev_type</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">dev_get_dev_type</span><span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">dev_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev_type</span> <span class="o">==</span> <span class="n">DSP_UNIT</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/*</span>
<span class="cm">			 *  Fill in buffer to send to RMS.</span>
<span class="cm">			 */</span>
			<span class="n">rms_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rms_command</span> <span class="o">*</span><span class="p">)</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">fxn</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="p">(</span><span class="n">rms_fxn</span><span class="p">);</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">arg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="n">node_env</span><span class="p">;</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">arg2</span> <span class="o">=</span> <span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="p">(</span><span class="n">ul_execute_fxn</span><span class="p">);</span>
			<span class="n">rms_cmd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">node_get_type</span><span class="p">(</span><span class="n">hnode</span><span class="p">);</span>

			<span class="n">status</span> <span class="o">=</span> <span class="n">send_message</span><span class="p">(</span><span class="n">disp_obj</span><span class="p">,</span> <span class="n">node_get_timeout</span><span class="p">(</span><span class="n">hnode</span><span class="p">),</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_command</span><span class="p">),</span>
					      <span class="o">&amp;</span><span class="n">dw_arg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== delete_disp ========</span>
<span class="cm"> *  purpose:</span>
<span class="cm"> *      Frees the resources allocated for the dispatcher.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">delete_disp</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bridge_drv_interface</span> <span class="o">*</span><span class="n">intf_fxns</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disp_obj</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">intf_fxns</span> <span class="o">=</span> <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">intf_fxns</span><span class="p">;</span>

		<span class="cm">/* Free Node Dispatcher resources */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_from_dsp</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Channel close can fail only if the channel handle</span>
<span class="cm">			 * is invalid. */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">intf_fxns</span><span class="o">-&gt;</span><span class="n">chnl_close</span><span class="p">)</span>
			    <span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_from_dsp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: Failed to close channel &quot;</span>
					<span class="s">&quot;from RMS: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_to_dsp</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="p">(</span><span class="o">*</span><span class="n">intf_fxns</span><span class="o">-&gt;</span><span class="n">chnl_close</span><span class="p">)</span> <span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span>
							  <span class="n">chnl_to_dsp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: Failed to close channel to&quot;</span>
					<span class="s">&quot; RMS: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">disp_obj</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== fill_stream_def ========</span>
<span class="cm"> *  purpose:</span>
<span class="cm"> *      Fills stream definitions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_stream_def</span><span class="p">(</span><span class="n">rms_word</span> <span class="o">*</span><span class="n">pdw_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ptotal</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">node_strmdef</span> <span class="n">strm_def</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">chars_in_rms_word</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rms_strm_def</span> <span class="o">*</span><span class="n">strm_def_obj</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">total</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptotal</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">name_len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_strm_def</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strm_def_obj</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rms_strm_def</span> <span class="o">*</span><span class="p">)(</span><span class="n">pdw_buf</span> <span class="o">+</span> <span class="n">total</span><span class="p">);</span>
		<span class="n">strm_def_obj</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">strm_def</span><span class="p">.</span><span class="n">buf_size</span><span class="p">;</span>
		<span class="n">strm_def_obj</span><span class="o">-&gt;</span><span class="n">nbufs</span> <span class="o">=</span> <span class="n">strm_def</span><span class="p">.</span><span class="n">num_bufs</span><span class="p">;</span>
		<span class="n">strm_def_obj</span><span class="o">-&gt;</span><span class="n">segid</span> <span class="o">=</span> <span class="n">strm_def</span><span class="p">.</span><span class="n">seg_id</span><span class="p">;</span>
		<span class="n">strm_def_obj</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">=</span> <span class="n">strm_def</span><span class="p">.</span><span class="n">buf_alignment</span><span class="p">;</span>
		<span class="n">strm_def_obj</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">strm_def</span><span class="p">.</span><span class="n">timeout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Since we haven&#39;t added the device name yet, subtract</span>
<span class="cm">		 *  1 from total.</span>
<span class="cm">		 */</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rms_strm_def</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rms_word</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dw_length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">strm_def</span><span class="p">.</span><span class="n">sz_device</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Number of RMS_WORDS needed to hold device name */</span>
		<span class="n">name_len</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">dw_length</span> <span class="o">+</span> <span class="n">chars_in_rms_word</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">chars_in_rms_word</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">+</span> <span class="n">name_len</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 *  Zero out last word, since the device name may not</span>
<span class="cm">			 *  extend to completely fill this word.</span>
<span class="cm">			 */</span>
			<span class="n">pdw_buf</span><span class="p">[</span><span class="n">total</span> <span class="o">+</span> <span class="n">name_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/** TODO USE SERVICES * */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pdw_buf</span> <span class="o">+</span> <span class="n">total</span><span class="p">,</span> <span class="n">strm_def</span><span class="p">.</span><span class="n">sz_device</span><span class="p">,</span> <span class="n">dw_length</span><span class="p">);</span>
			<span class="n">total</span> <span class="o">+=</span> <span class="n">name_len</span><span class="p">;</span>
			<span class="o">*</span><span class="n">ptotal</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== send_message ======</span>
<span class="cm"> *  Send command message to RMS, get reply from RMS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">send_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">disp_object</span> <span class="o">*</span><span class="n">disp_obj</span><span class="p">,</span> <span class="n">u32</span> <span class="n">timeout</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">ul_bytes</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">pdw_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bridge_drv_interface</span> <span class="o">*</span><span class="n">intf_fxns</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chnl_object</span> <span class="o">*</span><span class="n">chnl_obj</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">chnl_ioc</span> <span class="n">chnl_ioc_obj</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">pdw_arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">intf_fxns</span> <span class="o">=</span> <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">intf_fxns</span><span class="p">;</span>
	<span class="n">chnl_obj</span> <span class="o">=</span> <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_to_dsp</span><span class="p">;</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Send the command */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">intf_fxns</span><span class="o">-&gt;</span><span class="n">chnl_add_io_req</span><span class="p">)</span> <span class="p">(</span><span class="n">chnl_obj</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">ul_bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="mi">0L</span><span class="p">,</span> <span class="n">dw_arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">intf_fxns</span><span class="o">-&gt;</span><span class="n">chnl_get_ioc</span><span class="p">)</span> <span class="p">(</span><span class="n">chnl_obj</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chnl_ioc_obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHNL_IS_IO_COMPLETE</span><span class="p">(</span><span class="n">chnl_ioc_obj</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHNL_IS_TIMED_OUT</span><span class="p">(</span><span class="n">chnl_ioc_obj</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Get the reply */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>

	<span class="n">chnl_obj</span> <span class="o">=</span> <span class="n">disp_obj</span><span class="o">-&gt;</span><span class="n">chnl_from_dsp</span><span class="p">;</span>
	<span class="n">ul_bytes</span> <span class="o">=</span> <span class="n">REPLYSIZE</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">intf_fxns</span><span class="o">-&gt;</span><span class="n">chnl_add_io_req</span><span class="p">)</span> <span class="p">(</span><span class="n">chnl_obj</span><span class="p">,</span> <span class="n">pbuf</span><span class="p">,</span> <span class="n">ul_bytes</span><span class="p">,</span>
						    <span class="mi">0</span><span class="p">,</span> <span class="mi">0L</span><span class="p">,</span> <span class="n">dw_arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">intf_fxns</span><span class="o">-&gt;</span><span class="n">chnl_get_ioc</span><span class="p">)</span> <span class="p">(</span><span class="n">chnl_obj</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chnl_ioc_obj</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHNL_IS_TIMED_OUT</span><span class="p">(</span><span class="n">chnl_ioc_obj</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chnl_ioc_obj</span><span class="p">.</span><span class="n">byte_size</span> <span class="o">&lt;</span> <span class="n">ul_bytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Did not get all of the reply from the RMS */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHNL_IS_IO_COMPLETE</span><span class="p">(</span><span class="n">chnl_ioc_obj</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">chnl_ioc_obj</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Translate DSP&#39;s to kernel error */</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: DSP-side failed:&quot;</span>
						<span class="s">&quot; DSP errcode = 0x%x, Kernel &quot;</span>
						<span class="s">&quot;errcode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
						<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="o">*</span><span class="n">pdw_arg</span> <span class="o">=</span>
				    <span class="p">(((</span><span class="n">rms_word</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">chnl_ioc_obj</span><span class="p">.</span><span class="n">buf</span><span class="p">))[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">func_end:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
