<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › tidspbridge › rmgr › dbdcd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>dbdcd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * dbdcd.c</span>
<span class="cm"> *</span>
<span class="cm"> * DSP-BIOS Bridge driver support functions for TI OMAP processors.</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains the implementation of the DSP/BIOS Bridge</span>
<span class="cm"> * Configuration Database (DCD).</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> *   The fxn dcd_get_objects can apply a callback fxn to each DCD object</span>
<span class="cm"> *   that is located in a specified COFF file.  At the moment,</span>
<span class="cm"> *   dcd_auto_register, dcd_auto_unregister, and NLDR module all use</span>
<span class="cm"> *   dcd_get_objects.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2006 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This package is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS PACKAGE IS PROVIDED ``AS IS&#39;&#39; AND WITHOUT ANY EXPRESS OR</span>
<span class="cm"> * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED</span>
<span class="cm"> * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cm">/*  ----------------------------------- Host OS */</span>
<span class="cp">#include &lt;dspbridge/host_os.h&gt;</span>

<span class="cm">/*  ----------------------------------- DSP/BIOS Bridge */</span>
<span class="cp">#include &lt;dspbridge/dbdefs.h&gt;</span>

<span class="cm">/*  ----------------------------------- Platform Manager */</span>
<span class="cp">#include &lt;dspbridge/cod.h&gt;</span>

<span class="cm">/*  ----------------------------------- Others */</span>
<span class="cp">#include &lt;dspbridge/uuidutil.h&gt;</span>

<span class="cm">/*  ----------------------------------- This */</span>
<span class="cp">#include &lt;dspbridge/dbdcd.h&gt;</span>

<span class="cm">/*  ----------------------------------- Global defines. */</span>
<span class="cp">#define MAX_INT2CHAR_LENGTH     16	</span><span class="cm">/* Max int2char len of 32 bit int */</span><span class="cp"></span>

<span class="cm">/* Name of section containing dependent libraries */</span>
<span class="cp">#define DEPLIBSECT		&quot;.dspbridge_deplibs&quot;</span>

<span class="cm">/* DCD specific structures. */</span>
<span class="k">struct</span> <span class="n">dcd_manager</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr</span><span class="p">;</span>	<span class="cm">/* Handle to COD manager object. */</span>
<span class="p">};</span>

<span class="cm">/*  Pointer to the registry support key */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="n">reg_key_list</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">dbdcd_lock</span><span class="p">);</span>

<span class="cm">/* Global reference variables. */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">refs</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">enum_refs</span><span class="p">;</span>

<span class="cm">/* Helper function prototypes. */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">atoi</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">psz_buf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_attrs_from_buf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">psz_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ul_buf_size</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">dsp_dcdobjtype</span> <span class="n">obj_type</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dcd_genericobj</span> <span class="o">*</span><span class="n">gen_obj</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">compress_buf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">psz_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ul_buf_size</span><span class="p">,</span> <span class="n">s32</span> <span class="n">char_size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">dsp_char2_gpp_char</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">word</span><span class="p">,</span> <span class="n">s32</span> <span class="n">dsp_char_size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_dep_lib_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">uuid_obj</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="o">*</span><span class="n">num_libs</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="o">*</span><span class="n">num_pers_libs</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">dep_lib_uuids</span><span class="p">,</span>
				   <span class="n">bool</span> <span class="o">*</span><span class="n">prstnt_dep_libs</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">nldr_phase</span> <span class="n">phase</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_auto_register ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Parses the supplied image and resigsters with DCD.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_auto_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">,</span>
			     <span class="kt">char</span> <span class="o">*</span><span class="n">sz_coff_path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdcd_mgr</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dcd_get_objects</span><span class="p">(</span><span class="n">hdcd_mgr</span><span class="p">,</span> <span class="n">sz_coff_path</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">dcd_registerfxn</span><span class="p">)</span> <span class="n">dcd_register_object</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sz_coff_path</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_auto_unregister ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Parses the supplied DSP image and unresiters from DCD.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_auto_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">sz_coff_path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdcd_mgr</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dcd_get_objects</span><span class="p">(</span><span class="n">hdcd_mgr</span><span class="p">,</span> <span class="n">sz_coff_path</span><span class="p">,</span>
					 <span class="p">(</span><span class="n">dcd_registerfxn</span><span class="p">)</span> <span class="n">dcd_register_object</span><span class="p">,</span>
					 <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_create_manager ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Creates DCD manager.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_create_manager</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">sz_zl_dll_name</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">**</span><span class="n">dcd_mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cod_manager</span> <span class="o">*</span><span class="n">cod_mgr</span><span class="p">;</span>	<span class="cm">/* COD manager handle */</span>
	<span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">dcd_mgr_obj</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* DCD Manager pointer */</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cod_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cod_mgr</span><span class="p">,</span> <span class="n">sz_zl_dll_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>

	<span class="cm">/* Create a DCD object. */</span>
	<span class="n">dcd_mgr_obj</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dcd_mgr_obj</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fill out the object. */</span>
		<span class="n">dcd_mgr_obj</span><span class="o">-&gt;</span><span class="n">cod_mgr</span> <span class="o">=</span> <span class="n">cod_mgr</span><span class="p">;</span>

		<span class="cm">/* Return handle to this DCD interface. */</span>
		<span class="o">*</span><span class="n">dcd_mgr</span> <span class="o">=</span> <span class="n">dcd_mgr_obj</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If allocation of DcdManager object failed, delete the</span>
<span class="cm">		 * COD manager.</span>
<span class="cm">		 */</span>
		<span class="n">cod_delete</span><span class="p">(</span><span class="n">cod_mgr</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">func_end:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_destroy_manager ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Frees DCD Manager object.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_destroy_manager</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">dcd_mgr_obj</span> <span class="o">=</span> <span class="n">hdcd_mgr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdcd_mgr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Delete the COD manager. */</span>
		<span class="n">cod_delete</span><span class="p">(</span><span class="n">dcd_mgr_obj</span><span class="o">-&gt;</span><span class="n">cod_mgr</span><span class="p">);</span>

		<span class="cm">/* Deallocate a DCD manager object. */</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dcd_mgr_obj</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_enumerate_object ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Enumerates objects in the DCD.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_enumerate_object</span><span class="p">(</span><span class="n">s32</span> <span class="n">index</span><span class="p">,</span> <span class="k">enum</span> <span class="n">dsp_dcdobjtype</span> <span class="n">obj_type</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">uuid_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sz_reg_key</span><span class="p">[</span><span class="n">DCD_MAXPATHLENGTH</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">sz_value</span><span class="p">[</span><span class="n">DCD_MAXPATHLENGTH</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="n">dsp_uuid_obj</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sz_obj_type</span><span class="p">[</span><span class="n">MAX_INT2CHAR_LENGTH</span><span class="p">];</span>	<span class="cm">/* str. rep. of obj_type. */</span>
	<span class="n">u32</span> <span class="n">dw_key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcd_key_elem</span> <span class="o">*</span><span class="n">dcd_key</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">enum_refs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If an enumeration is being performed on an index greater</span>
<span class="cm">		 * than zero, then the current enum_refs must have been</span>
<span class="cm">		 * incremented to greater than zero.</span>
<span class="cm">		 */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Pre-determine final key length. It&#39;s length of DCD_REGKEY +</span>
<span class="cm">		 *  &quot;_\0&quot; + length of sz_obj_type string + terminating NULL.</span>
<span class="cm">		 */</span>
		<span class="n">dw_key_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DCD_REGKEY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Create proper REG key; concatenate DCD_REGKEY with</span>
<span class="cm">		 * obj_type. */</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">DCD_REGKEY</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DCD_REGKEY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">))</span> <span class="o">&lt;</span>
		    <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* This snprintf is guaranteed not to exceed max size of an</span>
<span class="cm">		 * integer. */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">,</span> <span class="n">MAX_INT2CHAR_LENGTH</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span>
				  <span class="n">obj_type</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">))</span> <span class="o">&lt;</span>
			    <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">sz_obj_type</span><span class="p">,</span>
					<span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcd_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">len</span><span class="p">)</span>
						<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">index</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">],</span>
					       <span class="n">strlen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">len</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Create UUID value using string retrieved from</span>
<span class="cm">			 * registry. */</span>
			<span class="n">uuid_uuid_from_string</span><span class="p">(</span><span class="n">sz_value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_uuid_obj</span><span class="p">);</span>

			<span class="o">*</span><span class="n">uuid_obj</span> <span class="o">=</span> <span class="n">dsp_uuid_obj</span><span class="p">;</span>

			<span class="cm">/* Increment enum_refs to update reference count. */</span>
			<span class="n">enum_refs</span><span class="o">++</span><span class="p">;</span>

			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* At the end of enumeration. Reset enum_refs. */</span>
			<span class="n">enum_refs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * TODO: Revisit, this is not an error case but code</span>
<span class="cm">			 * expects non-zero value.</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">ENODATA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_exit ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Discontinue usage of the DCD module.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">dcd_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcd_key_elem</span> <span class="o">*</span><span class="n">rv</span><span class="p">,</span> <span class="o">*</span><span class="n">rv_tmp</span><span class="p">;</span>

	<span class="n">refs</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">refs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">rv_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rv</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rv</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">rv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_get_dep_libs ========</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_get_dep_libs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">uuid_obj</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">num_libs</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">dep_lib_uuids</span><span class="p">,</span>
			    <span class="n">bool</span> <span class="o">*</span><span class="n">prstnt_dep_libs</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">nldr_phase</span> <span class="n">phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">get_dep_lib_info</span><span class="p">(</span><span class="n">hdcd_mgr</span><span class="p">,</span> <span class="n">uuid_obj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">num_libs</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dep_lib_uuids</span><span class="p">,</span>
			     <span class="n">prstnt_dep_libs</span><span class="p">,</span> <span class="n">phase</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_get_num_dep_libs ========</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_get_num_dep_libs</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">uuid_obj</span><span class="p">,</span>
				<span class="n">u16</span> <span class="o">*</span><span class="n">num_libs</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">num_pers_libs</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">nldr_phase</span> <span class="n">phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">get_dep_lib_info</span><span class="p">(</span><span class="n">hdcd_mgr</span><span class="p">,</span> <span class="n">uuid_obj</span><span class="p">,</span> <span class="n">num_libs</span><span class="p">,</span> <span class="n">num_pers_libs</span><span class="p">,</span>
				  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">phase</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_get_object_def ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Retrieves the properties of a node or processor based on the UUID and</span>
<span class="cm"> *      object type.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_get_object_def</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">obj_uuid</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">dsp_dcdobjtype</span> <span class="n">obj_type</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">dcd_genericobj</span> <span class="o">*</span><span class="n">obj_def</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">dcd_mgr_obj</span> <span class="o">=</span> <span class="n">hdcd_mgr</span><span class="p">;</span>	<span class="cm">/* ptr to DCD mgr */</span>
	<span class="k">struct</span> <span class="n">cod_libraryobj</span> <span class="o">*</span><span class="n">lib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ul_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Used by cod_get_section */</span>
	<span class="n">u32</span> <span class="n">ul_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Used by cod_get_section */</span>
	<span class="n">u32</span> <span class="n">dw_buf_size</span><span class="p">;</span>	<span class="cm">/* Used by REG functions */</span>
	<span class="kt">char</span> <span class="n">sz_reg_key</span><span class="p">[</span><span class="n">DCD_MAXPATHLENGTH</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">sz_uuid</span><span class="p">;</span>		<span class="cm">/*[MAXUUIDLEN]; */</span>
	<span class="k">struct</span> <span class="n">dcd_key_elem</span> <span class="o">*</span><span class="n">dcd_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sz_sect_name</span><span class="p">[</span><span class="n">MAXUUIDLEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>	<span class="cm">/* &quot;.[UUID]\0&quot; */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psz_coff_buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw_key_len</span><span class="p">;</span>		<span class="cm">/* Len of REG key. */</span>
	<span class="kt">char</span> <span class="n">sz_obj_type</span><span class="p">[</span><span class="n">MAX_INT2CHAR_LENGTH</span><span class="p">];</span>	<span class="cm">/* str. rep. of obj_type. */</span>

	<span class="n">sz_uuid</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">MAXUUIDLEN</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sz_uuid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdcd_mgr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Pre-determine final key length. It&#39;s length of DCD_REGKEY +</span>
<span class="cm">	 *  &quot;_\0&quot; + length of sz_obj_type string + terminating NULL */</span>
	<span class="n">dw_key_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DCD_REGKEY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Create proper REG key; concatenate DCD_REGKEY with obj_type. */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">DCD_REGKEY</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DCD_REGKEY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span>
		<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">,</span> <span class="n">MAX_INT2CHAR_LENGTH</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">))</span> <span class="o">&lt;</span>
		    <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">sz_obj_type</span><span class="p">,</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Create UUID value to set in registry. */</span>
		<span class="n">uuid_uuid_to_string</span><span class="p">(</span><span class="n">obj_uuid</span><span class="p">,</span> <span class="n">sz_uuid</span><span class="p">,</span> <span class="n">MAXUUIDLEN</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAXUUIDLEN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">sz_uuid</span><span class="p">,</span> <span class="n">MAXUUIDLEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="cm">/* Retrieve paths from the registry based on struct dsp_uuid */</span>
		<span class="n">dw_buf_size</span> <span class="o">=</span> <span class="n">DCD_MAXPATHLENGTH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcd_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz_reg_key</span><span class="p">,</span>
						<span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOKEY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="cm">/* Open COFF file. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cod_open</span><span class="p">(</span><span class="n">dcd_mgr_obj</span><span class="o">-&gt;</span><span class="n">cod_mgr</span><span class="p">,</span> <span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span>
							<span class="n">COD_NOLOAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lib</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure sz_uuid + 1 is not greater than sizeof sz_sect_name. */</span>

	<span class="cm">/* Create section name based on node UUID. A period is</span>
<span class="cm">	 * pre-pended to the UUID string to form the section name.</span>
<span class="cm">	 * I.e. &quot;.24BC8D90_BB45_11d4_B756_006008BDB66F&quot; */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_sect_name</span><span class="p">,</span> <span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">strncat</span><span class="p">(</span><span class="n">sz_sect_name</span><span class="p">,</span> <span class="n">sz_uuid</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sz_uuid</span><span class="p">));</span>

	<span class="cm">/* Get section information. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cod_get_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">sz_sect_name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate zeroed buffer. */</span>
	<span class="n">psz_coff_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ul_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psz_coff_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef _DB_TIOMAP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;iva&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Locate section by objectID and read its content. */</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">cod_read_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">sz_sect_name</span><span class="p">,</span> <span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">cod_read_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">sz_sect_name</span><span class="p">,</span> <span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: Skipped Byte swap for IVA!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cod_read_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">sz_sect_name</span><span class="p">,</span> <span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Compres DSP buffer to conform to PC format. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="s">&quot;iva&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">compress_buf</span><span class="p">(</span><span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">,</span> <span class="n">DSPWORDSIZE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">compress_buf</span><span class="p">(</span><span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: Compressing IVA COFF buffer by 1 &quot;</span>
				<span class="s">&quot;for IVA!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Parse the content of the COFF buffer. */</span>
		<span class="n">status</span> <span class="o">=</span>
		    <span class="n">get_attrs_from_buf</span><span class="p">(</span><span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">,</span> <span class="n">obj_def</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free the previously allocated dynamic buffer. */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psz_coff_buf</span><span class="p">);</span>
<span class="nl">func_end:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span><span class="p">)</span>
		<span class="n">cod_close</span><span class="p">(</span><span class="n">lib</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sz_uuid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_get_objects ========</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_get_objects</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">sz_coff_path</span><span class="p">,</span> <span class="n">dcd_registerfxn</span> <span class="n">register_fxn</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">dcd_mgr_obj</span> <span class="o">=</span> <span class="n">hdcd_mgr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psz_coff_buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psz_cur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cod_libraryobj</span> <span class="o">*</span><span class="n">lib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ul_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Used by cod_get_section */</span>
	<span class="n">u32</span> <span class="n">ul_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Used by cod_get_section */</span>
	<span class="kt">char</span> <span class="n">seps</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;:, &quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="n">dsp_uuid_obj</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">object_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdcd_mgr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Open DSP coff file, don&#39;t load symbols. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cod_open</span><span class="p">(</span><span class="n">dcd_mgr_obj</span><span class="o">-&gt;</span><span class="n">cod_mgr</span><span class="p">,</span> <span class="n">sz_coff_path</span><span class="p">,</span> <span class="n">COD_NOLOAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lib</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get DCD_RESIGER_SECTION section information. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cod_get_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">DCD_REGISTER_SECTION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ul_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate zeroed buffer. */</span>
	<span class="n">psz_coff_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ul_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psz_coff_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef _DB_TIOMAP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">sz_coff_path</span><span class="p">,</span> <span class="s">&quot;iva&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Locate section by objectID and read its content. */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cod_read_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">DCD_REGISTER_SECTION</span><span class="p">,</span>
					  <span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: Skipped Byte swap for IVA!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cod_read_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">DCD_REGISTER_SECTION</span><span class="p">,</span>
					  <span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">status</span> <span class="o">=</span>
	    <span class="n">cod_read_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">DCD_REGISTER_SECTION</span><span class="p">,</span> <span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Compress DSP buffer to conform to PC format. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">sz_coff_path</span><span class="p">,</span> <span class="s">&quot;iva&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">compress_buf</span><span class="p">(</span><span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">,</span> <span class="n">DSPWORDSIZE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">compress_buf</span><span class="p">(</span><span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: Compress COFF buffer with 1 word &quot;</span>
				<span class="s">&quot;for IVA!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Read from buffer and register object in buffer. */</span>
		<span class="n">psz_cur</span> <span class="o">=</span> <span class="n">psz_coff_buf</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">token</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  Retrieve UUID string. */</span>
			<span class="n">uuid_uuid_from_string</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dsp_uuid_obj</span><span class="p">);</span>

			<span class="cm">/*  Retrieve object type */</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

			<span class="cm">/*  Retrieve object type */</span>
			<span class="n">object_type</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 *  Apply register_fxn to the found DCD object.</span>
<span class="cm">			 *  Possible actions include:</span>
<span class="cm">			 *</span>
<span class="cm">			 *  1) Register found DCD object.</span>
<span class="cm">			 *  2) Unregister found DCD object (when handle == NULL)</span>
<span class="cm">			 *  3) Add overlay node.</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span>
			    <span class="n">register_fxn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dsp_uuid_obj</span><span class="p">,</span> <span class="n">object_type</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* if error occurs, break from while loop. */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Free the previously allocated dynamic buffer. */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psz_coff_buf</span><span class="p">);</span>
<span class="nl">func_cont:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span><span class="p">)</span>
		<span class="n">cod_close</span><span class="p">(</span><span class="n">lib</span><span class="p">);</span>

<span class="nl">func_end:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_get_library_name ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Retrieves the library name for the given UUID.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_get_library_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">uuid_obj</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">str_lib_name</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">buff_size</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">nldr_phase</span> <span class="n">phase</span><span class="p">,</span> <span class="n">bool</span> <span class="o">*</span><span class="n">phase_split</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">sz_reg_key</span><span class="p">[</span><span class="n">DCD_MAXPATHLENGTH</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">sz_uuid</span><span class="p">[</span><span class="n">MAXUUIDLEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dw_key_len</span><span class="p">;</span>		<span class="cm">/* Len of REG key. */</span>
	<span class="kt">char</span> <span class="n">sz_obj_type</span><span class="p">[</span><span class="n">MAX_INT2CHAR_LENGTH</span><span class="p">];</span>	<span class="cm">/* str. rep. of obj_type. */</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dcd_key_elem</span> <span class="o">*</span><span class="n">dcd_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: hdcd_mgr %p, uuid_obj %p, str_lib_name %p,&quot;</span>
		<span class="s">&quot; buff_size %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">hdcd_mgr</span><span class="p">,</span> <span class="n">uuid_obj</span><span class="p">,</span> <span class="n">str_lib_name</span><span class="p">,</span>
		<span class="n">buff_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Pre-determine final key length. It&#39;s length of DCD_REGKEY +</span>
<span class="cm">	 *  &quot;_\0&quot; + length of sz_obj_type string + terminating NULL.</span>
<span class="cm">	 */</span>
	<span class="n">dw_key_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DCD_REGKEY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Create proper REG key; concatenate DCD_REGKEY with obj_type. */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">DCD_REGKEY</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DCD_REGKEY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span>
		<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phase</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NLDR_CREATE</span>:
		<span class="cm">/* create phase type */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">DSP_DCDCREATELIBTYPE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLDR_EXECUTE</span>:
		<span class="cm">/* execute phase type */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">DSP_DCDEXECUTELIBTYPE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLDR_DELETE</span>:
		<span class="cm">/* delete phase type */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">DSP_DCDDELETELIBTYPE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NLDR_NOPHASE</span>:
		<span class="cm">/* known to be a dependent library */</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">DSP_DCDLIBRARYTYPE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">))</span> <span class="o">&lt;</span>
		    <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">sz_obj_type</span><span class="p">,</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Create UUID value to find match in registry. */</span>
		<span class="n">uuid_uuid_to_string</span><span class="p">(</span><span class="n">uuid_obj</span><span class="p">,</span> <span class="n">sz_uuid</span><span class="p">,</span> <span class="n">MAXUUIDLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAXUUIDLEN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">sz_uuid</span><span class="p">,</span> <span class="n">MAXUUIDLEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcd_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  See if the name matches. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz_reg_key</span><span class="p">,</span>
						<span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOKEY</span><span class="p">;</span>

	<span class="cm">/* If can&#39;t find, phases might be registered as generic LIBRARYTYPE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;&amp;</span> <span class="n">phase</span> <span class="o">!=</span> <span class="n">NLDR_NOPHASE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phase_split</span><span class="p">)</span>
			<span class="o">*</span><span class="n">phase_split</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">DCD_REGKEY</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DCD_REGKEY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">))</span> <span class="o">&lt;</span>
		    <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">DSP_DCDLIBRARYTYPE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">))</span>
		    <span class="o">&lt;</span> <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">sz_obj_type</span><span class="p">,</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">uuid_uuid_to_string</span><span class="p">(</span><span class="n">uuid_obj</span><span class="p">,</span> <span class="n">sz_uuid</span><span class="p">,</span> <span class="n">MAXUUIDLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAXUUIDLEN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">sz_uuid</span><span class="p">,</span> <span class="n">MAXUUIDLEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcd_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  See if the name matches. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz_reg_key</span><span class="p">,</span>
						<span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>

		<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">)</span> <span class="o">?</span>
						<span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOKEY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">str_lib_name</span><span class="p">,</span> <span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_init ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Initialize the DCD module.</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">dcd_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">ret</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">refs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">refs</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_register_object ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Registers a node or a processor with the DCD.</span>
<span class="cm"> *      If psz_path_name == NULL, unregister the specified DCD object.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_register_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">uuid_obj</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">dsp_dcdobjtype</span> <span class="n">obj_type</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">psz_path_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">sz_reg_key</span><span class="p">[</span><span class="n">DCD_MAXPATHLENGTH</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">sz_uuid</span><span class="p">[</span><span class="n">MAXUUIDLEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dw_path_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dw_key_len</span><span class="p">;</span>		<span class="cm">/* Len of REG key. */</span>
	<span class="kt">char</span> <span class="n">sz_obj_type</span><span class="p">[</span><span class="n">MAX_INT2CHAR_LENGTH</span><span class="p">];</span>	<span class="cm">/* str. rep. of obj_type. */</span>
	<span class="k">struct</span> <span class="n">dcd_key_elem</span> <span class="o">*</span><span class="n">dcd_key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: object UUID %p, obj_type %d, szPathName %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">uuid_obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">,</span> <span class="n">psz_path_name</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Pre-determine final key length. It&#39;s length of DCD_REGKEY +</span>
<span class="cm">	 *  &quot;_\0&quot; + length of sz_obj_type string + terminating NULL.</span>
<span class="cm">	 */</span>
	<span class="n">dw_key_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DCD_REGKEY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Create proper REG key; concatenate DCD_REGKEY with obj_type. */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">DCD_REGKEY</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">DCD_REGKEY</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span>
		<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="s">&quot;_</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">,</span> <span class="n">MAX_INT2CHAR_LENGTH</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">))</span> <span class="o">&lt;</span>
		    <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">sz_obj_type</span><span class="p">,</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">sz_obj_type</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="cm">/* Create UUID value to set in registry. */</span>
		<span class="n">uuid_uuid_to_string</span><span class="p">(</span><span class="n">uuid_obj</span><span class="p">,</span> <span class="n">sz_uuid</span><span class="p">,</span> <span class="n">MAXUUIDLEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAXUUIDLEN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">DCD_MAXPATHLENGTH</span><span class="p">)</span>
			<span class="n">strncat</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">,</span> <span class="n">sz_uuid</span><span class="p">,</span> <span class="n">MAXUUIDLEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If psz_path_name != NULL, perform registration, otherwise,</span>
<span class="cm">	 * perform unregistration.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psz_path_name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw_path_size</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">psz_path_name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcd_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*  See if the name matches. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz_reg_key</span><span class="p">,</span>
						<span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Add new reg value (UUID+obj_type)</span>
<span class="cm">			 * with COFF path info</span>
<span class="cm">			 */</span>

			<span class="n">dcd_key</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_key_elem</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcd_key</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dcd_key</span><span class="p">);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">strncpy</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz_reg_key</span><span class="p">,</span>
						<span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">psz_path_name</span> <span class="p">,</span>
						<span class="n">dw_path_size</span><span class="p">);</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*  Make sure the new data is the same. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">psz_path_name</span><span class="p">,</span>
							<span class="n">dw_path_size</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*  The caller needs a different data size! */</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
				<span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">dw_path_size</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">func_end</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/*  We have a match!  Copy out the data. */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">,</span> <span class="n">psz_path_name</span><span class="p">,</span> <span class="n">dw_path_size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="s">&quot;%s: psz_path_name=%s, dw_path_size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">psz_path_name</span><span class="p">,</span> <span class="n">dw_path_size</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Deregister an existing object */</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dcd_key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sz_reg_key</span><span class="p">,</span>
						<span class="n">strlen</span><span class="p">(</span><span class="n">sz_reg_key</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">dcd_key</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dbdcd_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">dcd_key</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">reg_key_list</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 *  Because the node database has been updated through a</span>
<span class="cm">		 *  successful object registration/de-registration operation,</span>
<span class="cm">		 *  we need to reset the object enumeration counter to allow</span>
<span class="cm">		 *  current enumerations to reflect this update in the node</span>
<span class="cm">		 *  database.</span>
<span class="cm">		 */</span>
		<span class="n">enum_refs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">func_end:</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dcd_unregister_object ========</span>
<span class="cm"> *  Call DCD_Register object with psz_path_name set to NULL to</span>
<span class="cm"> *  perform actual object de-registration.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">dcd_unregister_object</span><span class="p">(</span><span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">uuid_obj</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">dsp_dcdobjtype</span> <span class="n">obj_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  When dcd_register_object is called with NULL as pathname,</span>
<span class="cm">	 *  it indicates an unregister object operation.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">dcd_register_object</span><span class="p">(</span><span class="n">uuid_obj</span><span class="p">,</span> <span class="n">obj_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> **********************************************************************</span>
<span class="cm"> * DCD Helper Functions</span>
<span class="cm"> **********************************************************************</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== atoi ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      This function converts strings in decimal or hex format to integers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">atoi</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">psz_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pch</span> <span class="o">=</span> <span class="n">psz_buf</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">isspace</span><span class="p">(</span><span class="o">*</span><span class="n">pch</span><span class="p">))</span>
		<span class="n">pch</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pch</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">pch</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">pch</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pch</span> <span class="o">&amp;&amp;</span> <span class="n">tolower</span><span class="p">(</span><span class="n">pch</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">pch</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="sc">&#39;h&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">base</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">pch</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== get_attrs_from_buf ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Parse the content of a buffer filled with DSP-side data and</span>
<span class="cm"> *      retrieve an object&#39;s attributes from it. IMPORTANT: Assume the</span>
<span class="cm"> *      buffer has been converted from DSP format to GPP format.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_attrs_from_buf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">psz_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ul_buf_size</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">dsp_dcdobjtype</span> <span class="n">obj_type</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">dcd_genericobj</span> <span class="o">*</span><span class="n">gen_obj</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">seps</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psz_cur</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">token_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef _DB_TIOMAP</span>
	<span class="n">s32</span> <span class="n">entry_id</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">obj_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DSP_DCDNODETYPE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Parse COFF sect buffer to retrieve individual tokens used</span>
<span class="cm">		 * to fill in object attrs.</span>
<span class="cm">		 */</span>
		<span class="n">psz_cur</span> <span class="o">=</span> <span class="n">psz_buf</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* u32 cb_struct */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">cb_struct</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* dsp_uuid ui_node_id */</span>
		<span class="n">uuid_uuid_from_string</span><span class="p">(</span><span class="n">token</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span>
				      <span class="n">ui_node_id</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* ac_name */</span>
		<span class="n">token_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token_len</span> <span class="o">&gt;</span> <span class="n">DSP_MAXNAMELEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">token_len</span> <span class="o">=</span> <span class="n">DSP_MAXNAMELEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">strncpy</span><span class="p">(</span><span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">ac_name</span><span class="p">,</span>
			<span class="n">token</span><span class="p">,</span> <span class="n">token_len</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">ac_name</span><span class="p">[</span><span class="n">token_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="cm">/* u32 ntype */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">ntype</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="cm">/* u32 cache_on_gpp */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">cache_on_gpp</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="cm">/* dsp_resourcereqmts dsp_resource_reqmts */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">dsp_resource_reqmts</span><span class="p">.</span>
		    <span class="n">cb_struct</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span>
		    <span class="n">dsp_resource_reqmts</span><span class="p">.</span><span class="n">static_data_size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span>
		    <span class="n">dsp_resource_reqmts</span><span class="p">.</span><span class="n">global_data_size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span>
		    <span class="n">dsp_resource_reqmts</span><span class="p">.</span><span class="n">program_mem_size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span>
		    <span class="n">dsp_resource_reqmts</span><span class="p">.</span><span class="n">wc_execution_time</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span>
		    <span class="n">dsp_resource_reqmts</span><span class="p">.</span><span class="n">wc_period</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span>
		    <span class="n">dsp_resource_reqmts</span><span class="p">.</span><span class="n">wc_deadline</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span>
		    <span class="n">dsp_resource_reqmts</span><span class="p">.</span><span class="n">avg_exection_time</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span>
		    <span class="n">dsp_resource_reqmts</span><span class="p">.</span><span class="n">minimum_period</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* s32 prio */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">prio</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* u32 stack_size */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">stack_size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* u32 sys_stack_size */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">sys_stack_size</span> <span class="o">=</span>
		    <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* u32 stack_seg */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">stack_seg</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* u32 message_depth */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">message_depth</span> <span class="o">=</span>
		    <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* u32 num_input_streams */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">num_input_streams</span> <span class="o">=</span>
		    <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* u32 num_output_streams */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">num_output_streams</span> <span class="o">=</span>
		    <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* u32 timeout */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* char *str_create_phase_fxn */</span>
		<span class="n">token_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_create_phase_fxn</span> <span class="o">=</span>
					<span class="n">kzalloc</span><span class="p">(</span><span class="n">token_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_create_phase_fxn</span><span class="p">,</span>
			<span class="n">token</span><span class="p">,</span> <span class="n">token_len</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_create_phase_fxn</span><span class="p">[</span><span class="n">token_len</span><span class="p">]</span> <span class="o">=</span>
		    <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* char *str_execute_phase_fxn */</span>
		<span class="n">token_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_execute_phase_fxn</span> <span class="o">=</span>
					<span class="n">kzalloc</span><span class="p">(</span><span class="n">token_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_execute_phase_fxn</span><span class="p">,</span>
			<span class="n">token</span><span class="p">,</span> <span class="n">token_len</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_execute_phase_fxn</span><span class="p">[</span><span class="n">token_len</span><span class="p">]</span> <span class="o">=</span>
		    <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* char *str_delete_phase_fxn */</span>
		<span class="n">token_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_delete_phase_fxn</span> <span class="o">=</span>
					<span class="n">kzalloc</span><span class="p">(</span><span class="n">token_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_delete_phase_fxn</span><span class="p">,</span>
			<span class="n">token</span><span class="p">,</span> <span class="n">token_len</span><span class="p">);</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_delete_phase_fxn</span><span class="p">[</span><span class="n">token_len</span><span class="p">]</span> <span class="o">=</span>
		    <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* Segment id for message buffers */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">msg_segid</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* Message notification type */</span>
		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">msg_notify_type</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="cm">/* char *str_i_alg_name */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">token_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_i_alg_name</span> <span class="o">=</span>
					<span class="n">kzalloc</span><span class="p">(</span><span class="n">token_len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="n">strncpy</span><span class="p">(</span><span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_i_alg_name</span><span class="p">,</span>
				<span class="n">token</span><span class="p">,</span> <span class="n">token_len</span><span class="p">);</span>
			<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">str_i_alg_name</span><span class="p">[</span><span class="n">token_len</span><span class="p">]</span> <span class="o">=</span>
			    <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Load type (static, dynamic, or overlay) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">load_type</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Dynamic load data requirements */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">data_mem_seg_mask</span> <span class="o">=</span>
			    <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Dynamic load code requirements */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">code_mem_seg_mask</span> <span class="o">=</span>
			    <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Extract node profiles into node properties */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">count_profiles</span> <span class="o">=</span>
			    <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">i</span> <span class="o">&lt;</span>
			     <span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span>
			     <span class="n">ndb_props</span><span class="p">.</span><span class="n">count_profiles</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Heap Size for the node */</span>
					<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span>
					    <span class="n">ndb_props</span><span class="p">.</span><span class="n">node_profiles</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
					    <span class="n">heap_size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">node_obj</span><span class="p">.</span><span class="n">ndb_props</span><span class="p">.</span><span class="n">stack_seg_name</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DSP_DCDPROCESSORTYPE</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Parse COFF sect buffer to retrieve individual tokens used</span>
<span class="cm">		 * to fill in object attrs.</span>
<span class="cm">		 */</span>
		<span class="n">psz_cur</span> <span class="o">=</span> <span class="n">psz_buf</span><span class="p">;</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">cb_struct</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">processor_family</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">processor_type</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">clock_rate</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">internal_mem_size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">external_mem_size</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">processor_id</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">ty_running_rtos</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">node_min_priority</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>

		<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">proc_info</span><span class="p">.</span><span class="n">node_max_priority</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

<span class="cp">#ifdef _DB_TIOMAP</span>
		<span class="cm">/* Proc object may contain additional(extended) attributes. */</span>
		<span class="cm">/* attr must match proc.hxx */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">entry_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">entry_id</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">;</span> <span class="n">entry_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
			<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">ext_proc_obj</span><span class="p">.</span><span class="n">ty_tlb</span><span class="p">[</span><span class="n">entry_id</span><span class="p">].</span>
			    <span class="n">gpp_phys</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>

			<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
			<span class="n">gen_obj</span><span class="o">-&gt;</span><span class="n">obj_data</span><span class="p">.</span><span class="n">ext_proc_obj</span><span class="p">.</span><span class="n">ty_tlb</span><span class="p">[</span><span class="n">entry_id</span><span class="p">].</span>
			    <span class="n">dsp_virt</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== CompressBuffer ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Compress the DSP buffer, if necessary, to conform to PC format.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">compress_buf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">psz_buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ul_buf_size</span><span class="p">,</span> <span class="n">s32</span> <span class="n">char_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">psz_buf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">q</span> <span class="o">=</span> <span class="n">psz_buf</span><span class="p">;</span> <span class="n">q</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">psz_buf</span> <span class="o">+</span> <span class="n">ul_buf_size</span><span class="p">);)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="n">dsp_char2_gpp_char</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">char_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span> <span class="o">+=</span> <span class="n">char_size</span><span class="p">;</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="n">dsp_char2_gpp_char</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">char_size</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;t&#39;</span>:
				<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\t&#39;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="sc">&#39;n&#39;</span>:
				<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="sc">&#39;r&#39;</span>:
				<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\r&#39;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="sc">&#39;0&#39;</span>:
				<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="n">q</span> <span class="o">+=</span> <span class="n">char_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NULL out remainder of buffer. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">q</span><span class="p">)</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== dsp_char2_gpp_char ========</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Convert DSP char to host GPP char in a portable manner</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="nf">dsp_char2_gpp_char</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">word</span><span class="p">,</span> <span class="n">s32</span> <span class="n">dsp_char_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">ch</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ch_src</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch_src</span> <span class="o">=</span> <span class="n">word</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">dsp_char_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">ch</span> <span class="o">|=</span> <span class="o">*</span><span class="n">ch_src</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ch</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  ======== get_dep_lib_info ========</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_dep_lib_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">hdcd_mgr</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">uuid_obj</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="o">*</span><span class="n">num_libs</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="o">*</span><span class="n">num_pers_libs</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">dsp_uuid</span> <span class="o">*</span><span class="n">dep_lib_uuids</span><span class="p">,</span>
				   <span class="n">bool</span> <span class="o">*</span><span class="n">prstnt_dep_libs</span><span class="p">,</span>
				   <span class="k">enum</span> <span class="n">nldr_phase</span> <span class="n">phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dcd_manager</span> <span class="o">*</span><span class="n">dcd_mgr_obj</span> <span class="o">=</span> <span class="n">hdcd_mgr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psz_coff_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psz_cur</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">psz_file_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cod_libraryobj</span> <span class="o">*</span><span class="n">lib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ul_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Used by cod_get_section */</span>
	<span class="n">u32</span> <span class="n">ul_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Used by cod_get_section */</span>
	<span class="n">u32</span> <span class="n">dw_data_size</span> <span class="o">=</span> <span class="n">COD_MAXPATHLENGTH</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">seps</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">token</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">get_uuids</span> <span class="o">=</span> <span class="p">(</span><span class="n">dep_lib_uuids</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">dep_libs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*  Initialize to 0 dependent libraries, if only counting number of</span>
<span class="cm">	 *  dependent libraries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_uuids</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">num_libs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">num_pers_libs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate a buffer for file name */</span>
	<span class="n">psz_file_name</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">dw_data_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psz_file_name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Get the name of the library */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">dcd_get_library_name</span><span class="p">(</span><span class="n">hdcd_mgr</span><span class="p">,</span> <span class="n">uuid_obj</span><span class="p">,</span> <span class="n">psz_file_name</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">dw_data_size</span><span class="p">,</span> <span class="n">phase</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Open the library */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cod_open</span><span class="p">(</span><span class="n">dcd_mgr_obj</span><span class="o">-&gt;</span><span class="n">cod_mgr</span><span class="p">,</span> <span class="n">psz_file_name</span><span class="p">,</span>
				  <span class="n">COD_NOLOAD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lib</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get dependent library section information. */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">cod_get_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">DEPLIBSECT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ul_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ok, no dependent libraries */</span>
			<span class="n">ul_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ul_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>

	<span class="cm">/* Allocate zeroed buffer. */</span>
	<span class="n">psz_coff_buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ul_len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">psz_coff_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Read section contents. */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">cod_read_section</span><span class="p">(</span><span class="n">lib</span><span class="p">,</span> <span class="n">DEPLIBSECT</span><span class="p">,</span> <span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">func_cont</span><span class="p">;</span>

	<span class="cm">/* Compress and format DSP buffer to conform to PC format. */</span>
	<span class="n">compress_buf</span><span class="p">(</span><span class="n">psz_coff_buf</span><span class="p">,</span> <span class="n">ul_len</span><span class="p">,</span> <span class="n">DSPWORDSIZE</span><span class="p">);</span>

	<span class="cm">/* Read from buffer */</span>
	<span class="n">psz_cur</span> <span class="o">=</span> <span class="n">psz_coff_buf</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">token</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_uuids</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dep_libs</span> <span class="o">&gt;=</span> <span class="o">*</span><span class="n">num_libs</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Gone beyond the limit */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Retrieve UUID string. */</span>
				<span class="n">uuid_uuid_from_string</span><span class="p">(</span><span class="n">token</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="p">(</span><span class="n">dep_lib_uuids</span>
							<span class="p">[</span><span class="n">dep_libs</span><span class="p">]));</span>
				<span class="cm">/* Is this library persistent? */</span>
				<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
				<span class="n">prstnt_dep_libs</span><span class="p">[</span><span class="n">dep_libs</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
				<span class="n">dep_libs</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Advanc to next token */</span>
			<span class="n">token</span> <span class="o">=</span> <span class="n">strsep</span><span class="p">(</span><span class="o">&amp;</span><span class="n">psz_cur</span><span class="p">,</span> <span class="n">seps</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atoi</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
				<span class="p">(</span><span class="o">*</span><span class="n">num_pers_libs</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* Just counting number of dependent libraries */</span>
			<span class="p">(</span><span class="o">*</span><span class="n">num_libs</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">func_cont:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lib</span><span class="p">)</span>
		<span class="n">cod_close</span><span class="p">(</span><span class="n">lib</span><span class="p">);</span>

	<span class="cm">/* Free previously allocated dynamic buffers. */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">psz_file_name</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">psz_coff_buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
