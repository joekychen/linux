<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rts_pstor › sd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Driver for Realtek PCI-Express card reader</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009 Realtek Semiconductor Corp. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *   wwang (wei_wang@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>

<span class="cp">#include &quot;rtsx.h&quot;</span>
<span class="cp">#include &quot;rtsx_transport.h&quot;</span>
<span class="cp">#include &quot;rtsx_scsi.h&quot;</span>
<span class="cp">#include &quot;rtsx_card.h&quot;</span>
<span class="cp">#include &quot;sd.h&quot;</span>

<span class="cp">#define SD_MAX_RETRY_COUNT	3</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_CFG1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_CFG2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_CFG3</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_STAT1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_STAT2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_BUS_STAT</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_PAD_CTL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_SAMPLE_POINT_CTL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_PUSH_POINT_CTL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_CMD0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_CMD1</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_CMD2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_CMD3</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_CMD4</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_CMD5</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_TRANSFER</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_VPCLK0_CTL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_VPCLK1_CTL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_DCMPS0_CTL</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">REG_SD_DCMPS1_CTL</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sd_set_err_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>

	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">err_code</span> <span class="o">|=</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sd_clr_err_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>

	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sd_check_err_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">err_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">err_code</span> <span class="o">&amp;</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sd_init_reg_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">REG_SD_CFG1</span> <span class="o">=</span> <span class="n">SD_CFG1</span><span class="p">;</span>
		<span class="n">REG_SD_CFG2</span> <span class="o">=</span> <span class="n">SD_CFG2</span><span class="p">;</span>
		<span class="n">REG_SD_CFG3</span> <span class="o">=</span> <span class="n">SD_CFG3</span><span class="p">;</span>
		<span class="n">REG_SD_STAT1</span> <span class="o">=</span> <span class="n">SD_STAT1</span><span class="p">;</span>
		<span class="n">REG_SD_STAT2</span> <span class="o">=</span> <span class="n">SD_STAT2</span><span class="p">;</span>
		<span class="n">REG_SD_BUS_STAT</span> <span class="o">=</span> <span class="n">SD_BUS_STAT</span><span class="p">;</span>
		<span class="n">REG_SD_PAD_CTL</span> <span class="o">=</span> <span class="n">SD_PAD_CTL</span><span class="p">;</span>
		<span class="n">REG_SD_SAMPLE_POINT_CTL</span> <span class="o">=</span> <span class="n">SD_SAMPLE_POINT_CTL</span><span class="p">;</span>
		<span class="n">REG_SD_PUSH_POINT_CTL</span> <span class="o">=</span> <span class="n">SD_PUSH_POINT_CTL</span><span class="p">;</span>
		<span class="n">REG_SD_CMD0</span> <span class="o">=</span> <span class="n">SD_CMD0</span><span class="p">;</span>
		<span class="n">REG_SD_CMD1</span> <span class="o">=</span> <span class="n">SD_CMD1</span><span class="p">;</span>
		<span class="n">REG_SD_CMD2</span> <span class="o">=</span> <span class="n">SD_CMD2</span><span class="p">;</span>
		<span class="n">REG_SD_CMD3</span> <span class="o">=</span> <span class="n">SD_CMD3</span><span class="p">;</span>
		<span class="n">REG_SD_CMD4</span> <span class="o">=</span> <span class="n">SD_CMD4</span><span class="p">;</span>
		<span class="n">REG_SD_CMD5</span> <span class="o">=</span> <span class="n">SD_CMD5</span><span class="p">;</span>
		<span class="n">REG_SD_BYTE_CNT_L</span> <span class="o">=</span> <span class="n">SD_BYTE_CNT_L</span><span class="p">;</span>
		<span class="n">REG_SD_BYTE_CNT_H</span> <span class="o">=</span> <span class="n">SD_BYTE_CNT_H</span><span class="p">;</span>
		<span class="n">REG_SD_BLOCK_CNT_L</span> <span class="o">=</span> <span class="n">SD_BLOCK_CNT_L</span><span class="p">;</span>
		<span class="n">REG_SD_BLOCK_CNT_H</span> <span class="o">=</span> <span class="n">SD_BLOCK_CNT_H</span><span class="p">;</span>
		<span class="n">REG_SD_TRANSFER</span> <span class="o">=</span> <span class="n">SD_TRANSFER</span><span class="p">;</span>
		<span class="n">REG_SD_VPCLK0_CTL</span> <span class="o">=</span> <span class="n">SD_VPCLK0_CTL</span><span class="p">;</span>
		<span class="n">REG_SD_VPCLK1_CTL</span> <span class="o">=</span> <span class="n">SD_VPCLK1_CTL</span><span class="p">;</span>
		<span class="n">REG_SD_DCMPS0_CTL</span> <span class="o">=</span> <span class="n">SD_DCMPS0_CTL</span><span class="p">;</span>
		<span class="n">REG_SD_DCMPS1_CTL</span> <span class="o">=</span> <span class="n">SD_DCMPS1_CTL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">REG_SD_CFG1</span> <span class="o">=</span> <span class="mh">0xFD31</span><span class="p">;</span>
		<span class="n">REG_SD_CFG2</span> <span class="o">=</span> <span class="mh">0xFD33</span><span class="p">;</span>
		<span class="n">REG_SD_CFG3</span> <span class="o">=</span> <span class="mh">0xFD3E</span><span class="p">;</span>
		<span class="n">REG_SD_STAT1</span> <span class="o">=</span> <span class="mh">0xFD30</span><span class="p">;</span>
		<span class="n">REG_SD_STAT2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_SD_BUS_STAT</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_SD_PAD_CTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_SD_SAMPLE_POINT_CTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_SD_PUSH_POINT_CTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_SD_CMD0</span> <span class="o">=</span> <span class="mh">0xFD34</span><span class="p">;</span>
		<span class="n">REG_SD_CMD1</span> <span class="o">=</span> <span class="mh">0xFD35</span><span class="p">;</span>
		<span class="n">REG_SD_CMD2</span> <span class="o">=</span> <span class="mh">0xFD36</span><span class="p">;</span>
		<span class="n">REG_SD_CMD3</span> <span class="o">=</span> <span class="mh">0xFD37</span><span class="p">;</span>
		<span class="n">REG_SD_CMD4</span> <span class="o">=</span> <span class="mh">0xFD38</span><span class="p">;</span>
		<span class="n">REG_SD_CMD5</span> <span class="o">=</span> <span class="mh">0xFD5A</span><span class="p">;</span>
		<span class="n">REG_SD_BYTE_CNT_L</span> <span class="o">=</span> <span class="mh">0xFD39</span><span class="p">;</span>
		<span class="n">REG_SD_BYTE_CNT_H</span> <span class="o">=</span> <span class="mh">0xFD3A</span><span class="p">;</span>
		<span class="n">REG_SD_BLOCK_CNT_L</span> <span class="o">=</span> <span class="mh">0xFD3B</span><span class="p">;</span>
		<span class="n">REG_SD_BLOCK_CNT_H</span> <span class="o">=</span> <span class="mh">0xFD3C</span><span class="p">;</span>
		<span class="n">REG_SD_TRANSFER</span> <span class="o">=</span> <span class="mh">0xFD32</span><span class="p">;</span>
		<span class="n">REG_SD_VPCLK0_CTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_SD_VPCLK1_CTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_SD_DCMPS0_CTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">REG_SD_DCMPS1_CTL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_check_data0_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BUS_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_STAT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SD_DAT0_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUSY</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd_idx</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">arg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rsp_type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rsp_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rty_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sd_clr_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD/MMC CMD %d, arg = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd_idx</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">)</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>

<span class="nl">RTY_SEND_CMD:</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">cmd_idx</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">rsp_type</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span>
			<span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span>
			<span class="mh">0xFF</span><span class="p">,</span> <span class="n">SD_TM_CMD_RSP</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span>
		     <span class="n">SD_TRANSFER_END</span> <span class="o">|</span> <span class="n">SD_STAT_IDLE</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span> <span class="o">|</span> <span class="n">SD_STAT_IDLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">PPBUF_BASE2</span><span class="p">;</span> <span class="n">reg_addr</span> <span class="o">&lt;</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">stat_idx</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">!=</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">REG_SD_CMD0</span><span class="p">;</span> <span class="n">reg_addr</span> <span class="o">&lt;=</span> <span class="n">REG_SD_CMD4</span><span class="p">;</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">stat_idx</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_STAT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_STAT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_STAT1: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_STAT2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_STAT2: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SD_RSP_80CLK_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_RSP_TIMEOUT</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BUS_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_BUS_STAT: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_CFG3: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">&amp;</span> <span class="n">SD_WAIT_BUSY_END</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_data0_status</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TO_ERR</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_STS_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rsp_type</span> <span class="o">&amp;</span> <span class="n">SD_NO_CHECK_CRC7</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">stat_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SD_CRC7_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">WRITE_MULTIPLE_BLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CRC_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rty_cnt</span> <span class="o">&lt;</span> <span class="n">SD_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
				<span class="n">rty_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">RTY_SEND_CMD</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CRC_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd_idx</span> <span class="o">!=</span> <span class="n">SEND_RELATIVE_ADDR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">!=</span> <span class="n">SEND_IF_COND</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">!=</span> <span class="n">STOP_TRANSMISSION</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7D</span><span class="p">)</span>
<span class="cp">#else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span>
<span class="cp">#endif</span>
			<span class="p">{</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ptr[1]: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ptr[2]: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ptr[3]: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_data_buf_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_data_buf_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span> <span class="o">&amp;&amp;</span> <span class="n">rsp_len</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">trans_mode</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">byte_cnt</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">blk_cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_width</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sd_clr_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD/MMC CMD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">?</span> <span class="n">cmd_len</span> <span class="o">:</span> <span class="mi">6</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">byte_cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">byte_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">blk_cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">blk_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SD_CALCULATE_CRC7</span> <span class="o">|</span> <span class="n">SD_CHECK_CRC16</span> <span class="o">|</span> <span class="n">SD_NO_WAIT_BUSY_END</span> <span class="o">|</span>
			<span class="n">SD_CHECK_CRC7</span> <span class="o">|</span> <span class="n">SD_RSP_LEN_6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">trans_mode</span> <span class="o">!=</span> <span class="n">SD_TM_AUTO_TUNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">trans_mode</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span>
					    <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_ppbuf</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">trans_mode</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">u16</span> <span class="n">blk_cnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_width</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sd_clr_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">buf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This function can&#39;t write data more than one page */</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_ppbuf</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD/MMC CMD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">cmd_len</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">?</span> <span class="n">cmd_len</span> <span class="o">:</span> <span class="mi">6</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
				     <span class="n">REG_SD_CMD0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cmd</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">byte_cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">byte_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">blk_cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">blk_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
		<span class="n">SD_CALCULATE_CRC7</span> <span class="o">|</span> <span class="n">SD_CHECK_CRC16</span> <span class="o">|</span> <span class="n">SD_NO_WAIT_BUSY_END</span> <span class="o">|</span>
		<span class="n">SD_CHECK_CRC7</span> <span class="o">|</span> <span class="n">SD_RSP_LEN_6</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">trans_mode</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_check_csd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="n">check_wp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">csd_ver</span><span class="p">,</span> <span class="n">trans_speed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_CSD</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R2</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_csd</span><span class="p">,</span> <span class="n">rsp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CMD5</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_csd</span> <span class="o">+</span> <span class="mi">15</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;CSD Response:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">RTSX_DUMP</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_csd</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">csd_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;csd_ver = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">csd_ver</span><span class="p">);</span>

	<span class="n">trans_speed</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">trans_speed</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">trans_speed</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="mi">47</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_50</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">trans_speed</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x28</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="mi">39</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_40</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">trans_speed</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="mi">29</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_30</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">trans_speed</span> <span class="o">&amp;</span> <span class="mh">0xf8</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="mi">23</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_20</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">trans_speed</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_20</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_SECTOR_MODE</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">CHK_SD_HCXC</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">csd_ver</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">blk_size</span><span class="p">,</span> <span class="n">c_size_mult</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">c_size</span><span class="p">;</span>
			<span class="n">blk_size</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
			<span class="n">c_size</span> <span class="o">=</span>  <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span>
					<span class="o">+</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">rsp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="o">+</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">c_size_mult</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">rsp</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">c_size_mult</span> <span class="o">+=</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">c_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">c_size_mult</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)))</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">blk_size</span> <span class="o">-</span> <span class="mi">9</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">total_sector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">total_sector</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">rsp</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">rsp</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">rsp</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_sector</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_wp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;CSD WP Status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_set_sample_push_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_SDR104</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_SD_SDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG1</span><span class="p">,</span> <span class="mh">0x0C</span> <span class="o">|</span> <span class="n">SD_ASYNC_FIFO_NOT_RST</span><span class="p">,</span>
					<span class="n">SD_30_MODE</span> <span class="o">|</span> <span class="n">SD_ASYNC_FIFO_NOT_RST</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CLK_LOW_FREQ</span><span class="p">,</span> <span class="n">CLK_LOW_FREQ</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_CLK_SOURCE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
					<span class="n">CRC_VAR_CLK0</span> <span class="o">|</span> <span class="n">SD30_FIX_CLK</span> <span class="o">|</span> <span class="n">SAMPLE_VAR_CLK1</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CLK_LOW_FREQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG1</span><span class="p">,</span> <span class="mh">0x0C</span> <span class="o">|</span> <span class="n">SD_ASYNC_FIFO_NOT_RST</span><span class="p">,</span>
					<span class="n">SD_DDR_MODE</span> <span class="o">|</span> <span class="n">SD_ASYNC_FIFO_NOT_RST</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CLK_LOW_FREQ</span><span class="p">,</span> <span class="n">CLK_LOW_FREQ</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_CLK_SOURCE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
					<span class="n">CRC_VAR_CLK0</span> <span class="o">|</span> <span class="n">SD30_FIX_CLK</span> <span class="o">|</span> <span class="n">SAMPLE_VAR_CLK1</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CLK_LOW_FREQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_PUSH_POINT_CTL</span><span class="p">,</span> <span class="n">DDR_VAR_TX_CMD_DAT</span><span class="p">,</span>
					<span class="n">DDR_VAR_TX_CMD_DAT</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_SAMPLE_POINT_CTL</span><span class="p">,</span> <span class="n">DDR_VAR_RX_DAT</span> <span class="o">|</span> <span class="n">DDR_VAR_RX_CMD</span><span class="p">,</span>
					<span class="n">DDR_VAR_RX_DAT</span> <span class="o">|</span> <span class="n">DDR_VAR_RX_CMD</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG1</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="n">SD_20_MODE</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CLK_LOW_FREQ</span><span class="p">,</span> <span class="n">CLK_LOW_FREQ</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_CLK_SOURCE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
					<span class="n">CRC_FIX_CLK</span> <span class="o">|</span> <span class="n">SD30_VAR_CLK0</span> <span class="o">|</span> <span class="n">SAMPLE_VAR_CLK1</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CLK_LOW_FREQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SD_PUSH_POINT_CTL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SD_PUSH_POINT_AUTO</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">SD20_TX_NEG_EDGE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SD_PUSH_POINT_CTL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SD_PUSH_POINT_DELAY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">SD20_TX_14_AHEAD</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">SD20_TX_NEG_EDGE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_PUSH_POINT_CTL</span><span class="p">,</span> <span class="n">SD20_TX_SEL_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SD_SAMPLE_POINT_CTL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SD_SAMPLE_POINT_AUTO</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MMC_52M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">val</span> <span class="o">=</span> <span class="n">SD20_RX_14_DELAY</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">val</span> <span class="o">=</span> <span class="n">SD20_RX_POS_EDGE</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">val</span> <span class="o">=</span> <span class="n">SD20_RX_14_DELAY</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SD_SAMPLE_POINT_CTL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SD_SAMPLE_POINT_DELAY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">SD20_RX_14_DELAY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">SD20_RX_POS_EDGE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_SAMPLE_POINT_CTL</span><span class="p">,</span> <span class="n">SD20_RX_SEL_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SD_PUSH_POINT_CTL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SD_PUSH_POINT_DELAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SD_SAMPLE_POINT_CTL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SD_SAMPLE_POINT_AUTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MMC_52M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SD_SAMPLE_POINT_CTL_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">SD_SAMPLE_POINT_DELAY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sd_choose_proper_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_SDR104</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_sd_sdr104_clk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fpga_sd_sdr104_clk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_sd_ddr50_clk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fpga_sd_ddr50_clk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_SDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_sd_sdr50_clk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fpga_sd_sdr50_clk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_sd_hs_clk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fpga_sd_hs_clk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_52M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_mmc_52m_clk</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">fpga_mmc_52m_clk</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_26M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_50</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_set_clock_divider</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">clk_div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">SD_CLK_DIVIDE_MASK</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">clk_div</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk_div</span> <span class="o">==</span> <span class="n">SD_CLK_DIVIDE_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk_div</span> <span class="o">==</span> <span class="n">SD_CLK_DIVIDE_128</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">clk_div</span> <span class="o">==</span> <span class="n">SD_CLK_DIVIDE_256</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_set_init_para</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_sample_push_timing</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sd_choose_proper_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_select_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">select</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_idx</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">select</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">SELECT_CARD</span><span class="p">;</span>
		<span class="n">cmd_type</span> <span class="o">=</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">DESELECT_CARD</span><span class="p">;</span>
		<span class="n">cmd_type</span> <span class="o">=</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">;</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">cmd_idx</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">cmd_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_update_lock_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">|=</span> <span class="n">SD_LOCKED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_LOCKED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_card-&gt;sd_lock_status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_wait_state_data_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data_ready</span><span class="p">,</span> <span class="kt">int</span> <span class="n">polling_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">polling_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span>
					     <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(((</span><span class="n">rsp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1E</span><span class="p">)</span> <span class="o">==</span> <span class="n">state</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rsp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="n">data_ready</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_change_bank_voltage</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">voltage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">==</span> <span class="n">SD_IO_3V3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x4FC0</span> <span class="o">|</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_voltage</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_PAD_CTL</span><span class="p">,</span> <span class="n">SD_IO_USING_1V8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">voltage</span> <span class="o">==</span> <span class="n">SD_IO_1V8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x4C40</span> <span class="o">|</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_voltage</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_PAD_CTL</span><span class="p">,</span> <span class="n">SD_IO_USING_1V8</span><span class="p">,</span> <span class="n">SD_IO_USING_1V8</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_voltage_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="n">SD_CLK_TOGGLE_EN</span> <span class="o">|</span> <span class="n">SD_CLK_FORCE_STOP</span><span class="p">,</span> <span class="n">SD_CLK_TOGGLE_EN</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">VOLTAGE_SWITCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_voltage_switch_delay</span><span class="p">);</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SD_CMD_STATUS</span> <span class="o">|</span> <span class="n">SD_DAT3_STATUS</span> <span class="o">|</span> <span class="n">SD_DAT2_STATUS</span> <span class="o">|</span>
				<span class="n">SD_DAT1_STATUS</span> <span class="o">|</span> <span class="n">SD_DAT0_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SD_CLK_FORCE_STOP</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_bank_voltage</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_IO_1V8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SD_CLK_TOGGLE_EN</span><span class="p">);</span>
	<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SD_CMD_STATUS</span> <span class="o">|</span> <span class="n">SD_DAT3_STATUS</span> <span class="o">|</span> <span class="n">SD_DAT2_STATUS</span> <span class="o">|</span>
				<span class="n">SD_DAT1_STATUS</span> <span class="o">|</span> <span class="n">SD_DAT0_STATUS</span><span class="p">))</span> <span class="o">!=</span>
			<span class="p">(</span><span class="n">SD_CMD_STATUS</span> <span class="o">|</span> <span class="n">SD_DAT3_STATUS</span> <span class="o">|</span> <span class="n">SD_DAT2_STATUS</span> <span class="o">|</span>
				<span class="n">SD_DAT1_STATUS</span> <span class="o">|</span> <span class="n">SD_DAT0_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_BUS_STAT: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stat</span><span class="p">);</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="n">SD_CLK_TOGGLE_EN</span> <span class="o">|</span> <span class="n">SD_CLK_FORCE_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_CLK_EN</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="n">SD_CLK_TOGGLE_EN</span> <span class="o">|</span> <span class="n">SD_CLK_FORCE_STOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_reset_dcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tune_dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tune_dir</span> <span class="o">==</span> <span class="n">TUNE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DCM_DRP_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">DCM_RESET</span> <span class="o">|</span> <span class="n">DCM_RX</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DCM_DRP_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">DCM_RX</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DCM_DRP_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">DCM_RESET</span> <span class="o">|</span> <span class="n">DCM_TX</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DCM_DRP_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">DCM_TX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_change_phase</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sample_point</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tune_dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">SD_VP_CTL</span><span class="p">,</span> <span class="n">SD_DCMPS_CTL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ddr_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_change_phase (sample_point = %d, tune_dir = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sample_point</span><span class="p">,</span> <span class="n">tune_dir</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tune_dir</span> <span class="o">==</span> <span class="n">TUNE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SD_VP_CTL</span> <span class="o">=</span> <span class="n">SD_VPRX_CTL</span><span class="p">;</span>
		<span class="n">SD_DCMPS_CTL</span> <span class="o">=</span> <span class="n">SD_DCMPS_RX_CTL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ddr_rx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SD_VP_CTL</span> <span class="o">=</span> <span class="n">SD_VPTX_CTL</span><span class="p">;</span>
		<span class="n">SD_DCMPS_CTL</span> <span class="o">=</span> <span class="n">SD_DCMPS_TX_CTL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CHANGE_CLK</span><span class="p">,</span> <span class="n">CHANGE_CLK</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VP_CTL</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="n">sample_point</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VPCLK0_CTL</span><span class="p">,</span> <span class="n">PHASE_NOT_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VPCLK0_CTL</span><span class="p">,</span> <span class="n">PHASE_NOT_RESET</span><span class="p">,</span> <span class="n">PHASE_NOT_RESET</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CHANGE_CLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_RTS_PSTOR_DEBUG</span>
		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VP_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_VP_CTL: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_DCMPS_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_DCMPS_CTL: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ddr_rx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VP_CTL</span><span class="p">,</span> <span class="n">PHASE_CHANGE</span><span class="p">,</span> <span class="n">PHASE_CHANGE</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VP_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
					<span class="n">PHASE_CHANGE</span> <span class="o">|</span> <span class="n">PHASE_NOT_RESET</span> <span class="o">|</span> <span class="n">sample_point</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CHANGE_CLK</span><span class="p">,</span> <span class="n">CHANGE_CLK</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VP_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
					<span class="n">PHASE_NOT_RESET</span> <span class="o">|</span> <span class="n">sample_point</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">SD_DCMPS_CTL</span><span class="p">,</span> <span class="n">DCMPS_CHANGE</span><span class="p">,</span> <span class="n">DCMPS_CHANGE</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">SD_DCMPS_CTL</span><span class="p">,</span> <span class="n">DCMPS_CHANGE_DONE</span><span class="p">,</span> <span class="n">DCMPS_CHANGE_DONE</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Fail</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DCMPS_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Fail</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">DCMPS_CURRENT_PHASE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">sample_point</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Fail</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_DCMPS_CTL</span><span class="p">,</span> <span class="n">DCMPS_CHANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ddr_rx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VP_CTL</span><span class="p">,</span> <span class="n">PHASE_CHANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_CTL</span><span class="p">,</span> <span class="n">CHANGE_CLK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG1</span><span class="p">,</span> <span class="n">SD_ASYNC_FIFO_NOT_RST</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

<span class="nl">Fail:</span>
<span class="cp">#ifdef CONFIG_RTS_PSTOR_DEBUG</span>
	<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VP_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_VP_CTL: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_DCMPS_CTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_DCMPS_CTL: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_DCMPS_CTL</span><span class="p">,</span> <span class="n">DCMPS_CHANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_VP_CTL</span><span class="p">,</span> <span class="n">PHASE_CHANGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">sd_reset_dcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">tune_dir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_check_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">SEND_SCR</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_NORMAL_READ</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_scr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_query_switch_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func_group</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func_to_switch</span><span class="p">,</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">support_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">query_switch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">switch_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">support_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">query_switch_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">check_busy_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">SD_FUNC_GROUP_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">support_offset</span> <span class="o">=</span> <span class="n">FUNCTION_GROUP1_SUPPORT_OFFSET</span><span class="p">;</span>
		<span class="n">query_switch_offset</span> <span class="o">=</span> <span class="n">FUNCTION_GROUP1_QUERY_SWITCH_OFFSET</span><span class="p">;</span>
		<span class="n">check_busy_offset</span> <span class="o">=</span> <span class="n">FUNCTION_GROUP1_CHECK_BUSY_OFFSET</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">func_to_switch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">HS_SUPPORT</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">HS_SUPPORT_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">HS_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">HS_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDR50_SUPPORT</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">SDR50_SUPPORT_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">SDR50_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">SDR50_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDR104_SUPPORT</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">SDR104_SUPPORT_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">SDR104_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">SDR104_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DDR50_SUPPORT</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">DDR50_SUPPORT_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">DDR50_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">DDR50_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">SD_FUNC_GROUP_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">support_offset</span> <span class="o">=</span> <span class="n">FUNCTION_GROUP3_SUPPORT_OFFSET</span><span class="p">;</span>
		<span class="n">query_switch_offset</span> <span class="o">=</span> <span class="n">FUNCTION_GROUP3_QUERY_SWITCH_OFFSET</span><span class="p">;</span>
		<span class="n">check_busy_offset</span> <span class="o">=</span> <span class="n">FUNCTION_GROUP3_CHECK_BUSY_OFFSET</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">func_to_switch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DRIVING_TYPE_A</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">DRIVING_TYPE_A_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">TYPE_A_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">TYPE_A_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DRIVING_TYPE_C</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">DRIVING_TYPE_C_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">TYPE_C_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">TYPE_C_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DRIVING_TYPE_D</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">DRIVING_TYPE_D_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">TYPE_D_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">TYPE_D_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">SD_FUNC_GROUP_4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">support_offset</span> <span class="o">=</span> <span class="n">FUNCTION_GROUP4_SUPPORT_OFFSET</span><span class="p">;</span>
		<span class="n">query_switch_offset</span> <span class="o">=</span> <span class="n">FUNCTION_GROUP4_QUERY_SWITCH_OFFSET</span><span class="p">;</span>
		<span class="n">check_busy_offset</span> <span class="o">=</span> <span class="n">FUNCTION_GROUP4_CHECK_BUSY_OFFSET</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">func_to_switch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CURRENT_LIMIT_400</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_400_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_400_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_400_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CURRENT_LIMIT_600</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_600_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_600_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_600_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CURRENT_LIMIT_800</span>:
			<span class="n">support_mask</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_800_MASK</span><span class="p">;</span>
			<span class="n">query_switch</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_800_QUERY_SWITCH_OK</span><span class="p">;</span>
			<span class="n">switch_busy</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_800_SWITCH_BUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">SD_FUNC_GROUP_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">support_offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">support_mask</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="n">query_switch_offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">!=</span> <span class="n">query_switch</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check &#39;Busy Status&#39; */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="n">DATA_STRUCTURE_VER_OFFSET</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="n">check_busy_offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">switch_busy</span><span class="p">)</span> <span class="o">==</span> <span class="n">switch_busy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_check_switch_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">func_group</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func_to_switch</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_check_switch_mode (mode = %d, func_group = %d, func_to_switch = %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mode</span><span class="p">,</span> <span class="n">func_group</span><span class="p">,</span> <span class="n">func_to_switch</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">SWITCH</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">SD_FUNC_GROUP_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span> <span class="o">+</span> <span class="n">func_to_switch</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">SD_FUNC_GROUP_3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span> <span class="o">+</span> <span class="n">func_to_switch</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">SD_FUNC_GROUP_4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span> <span class="o">+</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SD_CHECK_MODE</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_NORMAL_READ</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DUMP</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">NO_ARGUMENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group1_mask</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x0D</span><span class="p">];</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group2_mask</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x0B</span><span class="p">];</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group3_mask</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x09</span><span class="p">];</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group4_mask</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x07</span><span class="p">];</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;func_group1_mask = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x0D</span><span class="p">]);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;func_group2_mask = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x0B</span><span class="p">]);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;func_group3_mask = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;func_group4_mask = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Maximum current consumption, check whether current is acceptable;</span>
<span class="cm">		 * bit[511:496] = 0x0000 means some error happaned.</span>
<span class="cm">		 */</span>
		<span class="n">u16</span> <span class="n">cc</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Maximum current consumption: %dmA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cc</span> <span class="o">&gt;</span> <span class="mi">800</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_query_switch_result</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">func_group</span><span class="p">,</span> <span class="n">func_to_switch</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cc</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">&gt;</span> <span class="n">CURRENT_LIMIT_400</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPPARA2</span><span class="p">,</span> <span class="n">SD_OCP_THD_MASK</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_800mA_ocp_thd</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PWR_CTL</span><span class="p">,</span> <span class="n">PMOS_STRG_MASK</span><span class="p">,</span> <span class="n">PMOS_STRG_800mA</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">downgrade_switch_mode</span><span class="p">(</span><span class="n">u8</span> <span class="n">func_group</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func_to_switch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">SD_FUNC_GROUP_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">&gt;</span> <span class="n">HS_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">func_to_switch</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_group</span> <span class="o">==</span> <span class="n">SD_FUNC_GROUP_4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">&gt;</span> <span class="n">CURRENT_LIMIT_200</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">func_to_switch</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">func_to_switch</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_check_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
		<span class="n">u8</span> <span class="n">func_group</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func_to_switch</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">switch_good</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_switch_mode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CHECK_MODE</span><span class="p">,</span> <span class="n">func_group</span><span class="p">,</span>
				<span class="n">func_to_switch</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">stat</span><span class="p">;</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_switch_mode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_SWITCH_MODE</span><span class="p">,</span>
					<span class="n">func_group</span><span class="p">,</span> <span class="n">func_to_switch</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">switch_good</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_STAT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">SD_CRC16_ERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD CRC16 error when switching mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">downgrade_switch_mode</span><span class="p">(</span><span class="n">func_group</span><span class="p">,</span> <span class="n">func_to_switch</span><span class="p">);</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">switch_good</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_switch_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bus_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">func_to_switch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get supported functions */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_switch_mode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CHECK_MODE</span><span class="p">,</span>
			<span class="n">NO_ARGUMENT</span><span class="p">,</span> <span class="n">NO_ARGUMENT</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group1_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_switch_fail</span><span class="p">);</span>

	<span class="cm">/* Function Group 1: Access Mode */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_speed_prior</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SDR104_SUPPORT</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group1_mask</span> <span class="o">&amp;</span> <span class="n">SDR104_SUPPORT_MASK</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdr104_en</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">SDR104_SUPPORT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">DDR50_SUPPORT</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group1_mask</span> <span class="o">&amp;</span> <span class="n">DDR50_SUPPORT_MASK</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ddr50_en</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">DDR50_SUPPORT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDR50_SUPPORT</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group1_mask</span> <span class="o">&amp;</span> <span class="n">SDR50_SUPPORT_MASK</span><span class="p">)</span>
					<span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdr50_en</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">SDR50_SUPPORT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">HS_SUPPORT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group1_mask</span> <span class="o">&amp;</span> <span class="n">HS_SUPPORT_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">HS_SUPPORT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>


		<span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_FUNC_GROUP_1: func_to_switch = 0x%02x&quot;</span><span class="p">,</span> <span class="n">func_to_switch</span><span class="p">);</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_SDR_RST</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">DDR50_SUPPORT</span> <span class="o">==</span> <span class="n">func_to_switch</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group1_mask</span> <span class="o">&amp;</span> <span class="n">SDR50_SUPPORT_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">SDR50_SUPPORT</span><span class="p">;</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Using SDR50 instead of DDR50 for SD Lock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_switch</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_FUNC_GROUP_1</span><span class="p">,</span> <span class="n">func_to_switch</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">==</span> <span class="n">SDR104_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_switch_fail</span> <span class="o">=</span> <span class="n">SDR104_SUPPORT_MASK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">==</span> <span class="n">DDR50_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_switch_fail</span> <span class="o">=</span>
					<span class="n">SDR104_SUPPORT_MASK</span> <span class="o">|</span> <span class="n">DDR50_SUPPORT_MASK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">==</span> <span class="n">SDR50_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_switch_fail</span> <span class="o">=</span>
					<span class="n">SDR104_SUPPORT_MASK</span> <span class="o">|</span> <span class="n">DDR50_SUPPORT_MASK</span> <span class="o">|</span>
					<span class="n">SDR50_SUPPORT_MASK</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">==</span> <span class="n">SDR104_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SET_SD_SDR104</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">==</span> <span class="n">DDR50_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SET_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">==</span> <span class="n">SDR50_SUPPORT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SET_SD_SDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SET_SD_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_PUSH_POINT_CTL</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_sample_push_timing</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func_to_switch</span> <span class="o">||</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">==</span> <span class="n">HS_SUPPORT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Do not try to switch current limit if the card doesn&#39;t</span>
<span class="cm">		 * support UHS mode or we don&#39;t want it to support UHS mode</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Function Group 4: Current Limit */</span>
	<span class="n">func_to_switch</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">u8</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_current_prior</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CURRENT_LIMIT_800</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group4_mask</span> <span class="o">&amp;</span> <span class="n">CURRENT_LIMIT_800_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_800</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CURRENT_LIMIT_600</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group4_mask</span> <span class="o">&amp;</span> <span class="n">CURRENT_LIMIT_600_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_600</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CURRENT_LIMIT_400</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group4_mask</span> <span class="o">&amp;</span> <span class="n">CURRENT_LIMIT_400_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_400</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CURRENT_LIMIT_200</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">func_group4_mask</span> <span class="o">&amp;</span> <span class="n">CURRENT_LIMIT_200_MASK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">func_to_switch</span> <span class="o">=</span> <span class="n">CURRENT_LIMIT_200</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_FUNC_GROUP_4: func_to_switch = 0x%02x&quot;</span><span class="p">,</span> <span class="n">func_to_switch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func_to_switch</span> <span class="o">&lt;=</span> <span class="n">CURRENT_LIMIT_800</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_switch</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_FUNC_GROUP_4</span><span class="p">,</span> <span class="n">func_to_switch</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Switch current limit finished! (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_PUSH_POINT_CTL</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_wait_data_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_DATA_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SD_DATA_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_DATA_STATE: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_sdr_tuning_rx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sample_point</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sample_point</span><span class="p">,</span> <span class="n">TUNE_RX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">SEND_TUNING_PATTERN</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_AUTO_TUNING</span><span class="p">,</span>
			<span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">sd_wait_data_idle</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_ddr_tuning_rx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sample_point</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sample_point</span><span class="p">,</span> <span class="n">TUNE_RX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd ddr tuning rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">SD_STATUS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_NORMAL_READ</span><span class="p">,</span>
			<span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">sd_wait_data_idle</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_ddr_tunning_rx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sample_point</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">bus_width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sample_point</span><span class="p">,</span> <span class="n">TUNE_RX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;mmc ddr tuning rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">SEND_EXT_CSD</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_NORMAL_READ</span><span class="p">,</span>
			<span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">sd_wait_data_idle</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_sdr_tuning_tx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sample_point</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sample_point</span><span class="p">,</span> <span class="n">TUNE_TX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span>
		<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_RSP_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_ddr_tuning_tx_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sample_point</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">bus_width</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sample_point</span><span class="p">,</span> <span class="n">TUNE_TX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_wait_state_data_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">PROGRAM_CSD</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_write_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_AUTO_WRITE_2</span><span class="p">,</span>
			<span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_csd</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">sd_search_final_phase</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">phase_map</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tune_dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timing_phase_path</span> <span class="n">path</span><span class="p">[</span><span class="n">MAX_PHASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">cont_path_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_block</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">final_path_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">final_phase</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phase_map</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tune_dir</span> <span class="o">==</span> <span class="n">TUNE_RX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">final_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_default_rx_phase</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">final_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_default_tx_phase</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">Search_Finish</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cont_path_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new_block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_PHASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phase_map</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_block</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new_block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">j</span> <span class="o">=</span> <span class="n">cont_path_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">path</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">end</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">new_block</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cont_path_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">cont_path_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">mid</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cont_path_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;No continuous phase path</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">Search_Finish</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">cont_path_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">mid</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">cont_path_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">end</span> <span class="o">==</span> <span class="n">MAX_PHASE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">cont_path_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">start</span> <span class="o">-</span> <span class="n">MAX_PHASE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">+=</span> <span class="n">path</span><span class="p">[</span><span class="n">cont_path_cnt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
		<span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mid</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span> <span class="o">+</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mid</span> <span class="o">+=</span> <span class="n">MAX_PHASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cont_path_cnt</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">max_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">final_phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">final_path_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cont_path_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">max_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_len</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">;</span>
			<span class="n">final_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mid</span><span class="p">;</span>
			<span class="n">final_path_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;path[%d].start = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">start</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;path[%d].end = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">end</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;path[%d].len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;path[%d].mid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mid</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tune_dir</span> <span class="o">==</span> <span class="n">TUNE_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_SDR104</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">temp_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">temp_final_phase</span> <span class="o">=</span>
					<span class="n">path</span><span class="p">[</span><span class="n">final_path_idx</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">temp_mid</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">temp_final_phase</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">final_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">temp_final_phase</span> <span class="o">+</span> <span class="n">MAX_PHASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">final_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">temp_final_phase</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_SDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">temp_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="mi">13</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">temp_final_phase</span> <span class="o">=</span>
					<span class="n">path</span><span class="p">[</span><span class="n">final_path_idx</span><span class="p">].</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">temp_mid</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">temp_final_phase</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">final_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">temp_final_phase</span> <span class="o">+</span> <span class="n">MAX_PHASE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">final_phase</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">temp_final_phase</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">Search_Finish:</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Final chosen phase: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">final_phase</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">final_phase</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_tuning_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">phase_map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">final_phase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">tuning_cmd</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sample_point</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tuning_cmd</span> <span class="o">=</span> <span class="n">sd_ddr_tuning_rx_cmd</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tuning_cmd</span> <span class="o">=</span> <span class="n">sd_sdr_tuning_rx_cmd</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tuning_cmd</span> <span class="o">=</span> <span class="n">mmc_ddr_tunning_rx_cmd</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raw_phase_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">MAX_PHASE</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">tuning_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">j</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">raw_phase_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">phase_map</span> <span class="o">=</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;RX raw_phase_map[%d] = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;RX phase_map = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phase_map</span><span class="p">);</span>

	<span class="n">final_phase</span> <span class="o">=</span> <span class="n">sd_search_final_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phase_map</span><span class="p">,</span> <span class="n">TUNE_RX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">final_phase</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">final_phase</span><span class="p">,</span> <span class="n">TUNE_RX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_ddr_pre_tuning_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">phase_map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">final_phase</span><span class="p">;</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">);</span>

	<span class="n">phase_map</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MAX_PHASE</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">);</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span>
						<span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">i</span><span class="p">,</span> <span class="n">TUNE_TX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span>
				<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">sd_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_RSP_TIMEOUT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">phase_map</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span> <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;DDR TX pre tune phase_map = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phase_map</span><span class="p">);</span>

	<span class="n">final_phase</span> <span class="o">=</span> <span class="n">sd_search_final_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phase_map</span><span class="p">,</span> <span class="n">TUNE_TX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">final_phase</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">final_phase</span><span class="p">,</span> <span class="n">TUNE_TX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;DDR TX pre tune phase: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">final_phase</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_tuning_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">phase_map</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">final_phase</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">tuning_cmd</span><span class="p">)(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sample_point</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tuning_cmd</span> <span class="o">=</span> <span class="n">sd_ddr_tuning_tx_cmd</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tuning_cmd</span> <span class="o">=</span> <span class="n">sd_sdr_tuning_tx_cmd</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tuning_cmd</span> <span class="o">=</span> <span class="n">sd_ddr_tuning_tx_cmd</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">raw_phase_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">MAX_PHASE</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">);</span>
				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CFG3</span><span class="p">,</span>
						    <span class="n">SD_RSP_80CLK_TIMEOUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">tuning_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">j</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">raw_phase_map</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">phase_map</span> <span class="o">=</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;TX raw_phase_map[%d] = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">raw_phase_map</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;TX phase_map = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phase_map</span><span class="p">);</span>

	<span class="n">final_phase</span> <span class="o">=</span> <span class="n">sd_search_final_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">phase_map</span><span class="p">,</span> <span class="n">TUNE_TX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">final_phase</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">final_phase</span><span class="p">,</span> <span class="n">TUNE_TX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_sdr_tuning</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_tuning_tx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_tuning_rx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_ddr_tuning</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SD_DDR_TX_PHASE_SET_BY_USER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_ddr_pre_tuning_tx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ddr_tx_phase</span><span class="p">,</span> <span class="n">TUNE_TX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_tuning_rx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SD_DDR_TX_PHASE_SET_BY_USER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_tuning_tx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_ddr_tuning</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">MMC_DDR_TX_PHASE_SET_BY_USER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_ddr_pre_tuning_tx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_phase</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmc_ddr_tx_phase</span><span class="p">,</span> <span class="n">TUNE_TX</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_tuning_rx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">MMC_DDR_TX_PHASE_SET_BY_USER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_tuning_tx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_switch_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">re_tuning</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">CHK_SD30_SPEED</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">need_retune</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">!=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">cur_clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">re_tuning</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">need_retune</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">re_tuning</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_ddr_tuning</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_sdr_tuning</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">mmc_ddr_tuning</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_prepare_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="mi">29</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_30</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_data_buf_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SD_CLK_DIVIDE_128</span> <span class="o">|</span> <span class="n">SD_20_MODE</span> <span class="o">|</span> <span class="n">SD_BUS_WIDTH_1</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_SAMPLE_POINT_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SD20_RX_POS_EDGE</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_PUSH_POINT_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_STOP</span><span class="p">,</span> <span class="n">SD_STOP</span> <span class="o">|</span> <span class="n">SD_CLR_ERR</span><span class="p">,</span> <span class="n">SD_STOP</span> <span class="o">|</span> <span class="n">SD_CLR_ERR</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_pull_ctl_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xD5</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_D3_PD</span> <span class="o">|</span> <span class="n">SD_D7_PD</span> <span class="o">|</span> <span class="n">SD_CLK_PD</span> <span class="o">|</span> <span class="n">SD_D5_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SD_D6_PD</span> <span class="o">|</span> <span class="n">SD_D0_PD</span> <span class="o">|</span> <span class="n">SD_D1_PD</span> <span class="o">|</span> <span class="n">XD_D5_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SD_D4_PD</span> <span class="o">|</span> <span class="n">XD_CE_PD</span> <span class="o">|</span> <span class="n">XD_CLE_PD</span> <span class="o">|</span> <span class="n">XD_CD_PU</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_RDY_PD</span> <span class="o">|</span> <span class="n">SD_D3_PD</span> <span class="o">|</span> <span class="n">SD_D2_PD</span> <span class="o">|</span> <span class="n">XD_ALE_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_INS_PU</span> <span class="o">|</span> <span class="n">SD_WP_PD</span> <span class="o">|</span> <span class="n">SD_CD_PU</span> <span class="o">|</span> <span class="n">SD_CMD_PD</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_D5_PD</span> <span class="o">|</span> <span class="n">MS_D4_PD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">QFN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">);</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_pull_ctl_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xE9</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_D3_PD</span> <span class="o">|</span> <span class="n">SD_DAT7_PU</span> <span class="o">|</span> <span class="n">SD_CLK_NP</span> <span class="o">|</span> <span class="n">SD_D5_PU</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SD_D6_PU</span> <span class="o">|</span> <span class="n">SD_D0_PU</span> <span class="o">|</span> <span class="n">SD_D1_PU</span> <span class="o">|</span> <span class="n">XD_D5_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SD_D4_PU</span> <span class="o">|</span> <span class="n">XD_CE_PD</span> <span class="o">|</span> <span class="n">XD_CLE_PD</span> <span class="o">|</span> <span class="n">XD_CD_PU</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">XD_RDY_PD</span> <span class="o">|</span> <span class="n">SD_D3_PU</span> <span class="o">|</span> <span class="n">SD_D2_PU</span> <span class="o">|</span> <span class="n">XD_ALE_PD</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">MS_INS_PU</span> <span class="o">|</span> <span class="n">SD_WP_PU</span> <span class="o">|</span> <span class="n">SD_CD_PU</span> <span class="o">|</span> <span class="n">SD_CMD_PU</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL6</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_D5_PD</span> <span class="o">|</span> <span class="n">MS_D4_PD</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">QFN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xA8</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_PULL_CTL4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_init_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PWR_GATE_CTRL</span><span class="p">,</span> <span class="n">LDO3318_PWR_MASK</span><span class="p">,</span> <span class="n">LDO_OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">enable_card_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_pull_ctl_enable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span> <span class="n">FPGA_SD_PULL_CTL_BIT</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PWR_GATE_CTRL</span><span class="p">,</span> <span class="n">LDO3318_PWR_MASK</span><span class="p">,</span> <span class="n">LDO_ON</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">card_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">260</span><span class="p">);</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SD_OC_NOW</span> <span class="o">|</span> <span class="n">SD_OC_EVER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Over current, OCPSTAT is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">SD_OUTPUT_EN</span><span class="p">,</span> <span class="n">SD_OUTPUT_EN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_dummy_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="n">SD_CLK_TOGGLE_EN</span><span class="p">,</span> <span class="n">SD_CLK_TOGGLE_EN</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="n">SD_CLK_TOGGLE_EN</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG3</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG3</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_read_lba0</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">bus_width</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">READ_SINGLE_BLOCK</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_NORMAL_READ</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
		<span class="mi">5</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sd_check_wp_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sd_card_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">SD_STATUS</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_NORMAL_READ</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;ACMD13:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">RTSX_DUMP</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>

	<span class="n">sd_card_type</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_card_type = 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sd_card_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sd_card_type</span> <span class="o">==</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">sd_card_type</span> <span class="o">==</span> <span class="mh">0x0002</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* ROM card or OTP */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check SD Machanical Write-Protect Switch */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIPR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SD_WRITE_PROTECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_sd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hi_cap_flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sd_dont_switch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">support_1v8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">try_sdio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">switch_bus_width</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">voltage</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sd20_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SET_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>

<span class="nl">Switch_Fail:</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hi_cap_flow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_UNLOCK_POW_ON</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">SD_UNLOCK_ENTRY</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_prepare_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_dummy_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SDIO_IGNORED</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">try_sdio</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">rty_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">rty_cnt</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_retry_cnt</span><span class="p">;</span> <span class="n">rty_cnt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IO_SEND_OP_COND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R4</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">func_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">func_num</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD_IO card (Function number: %d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func_num</span><span class="p">);</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

			<span class="n">sd_dummy_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Normal card!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Start Initialization Process of SD Card */</span>
<span class="nl">RTY_SD_RST:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GO_IDLE_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_IF_COND</span><span class="p">,</span> <span class="mh">0x000001AA</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R7</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rsp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xAA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">rsp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hi_cap_flow</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sd20_mode</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">voltage</span> <span class="o">=</span> <span class="n">SUPPORT_VOLTAGE</span> <span class="o">|</span>
						<span class="n">SUPPORT_HIGH_AND_EXTENDED_CAPACITY</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">voltage</span> <span class="o">=</span> <span class="n">SUPPORT_VOLTAGE</span> <span class="o">|</span>
						<span class="n">SUPPORT_HIGH_AND_EXTENDED_CAPACITY</span> <span class="o">|</span>
						<span class="n">SUPPORT_MAX_POWER_PERMANCE</span> <span class="o">|</span> <span class="n">SUPPORT_1V8</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">voltage</span> <span class="o">=</span> <span class="n">SUPPORT_VOLTAGE</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hi_cap_flow</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">voltage</span> <span class="o">=</span> <span class="n">SUPPORT_VOLTAGE</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GO_IDLE_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		       <span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">RTY_SD_RST</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_APP_OP_COND</span><span class="p">,</span> <span class="n">voltage</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R3</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">k</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">RTY_SD_RST</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hi_cap_flow</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SET_SD_HCXC</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">CLR_SD_HCXC</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">CHK_SD_HCXC</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sd20_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">support_1v8</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">support_1v8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CLR_SD_HCXC</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="n">support_1v8</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;support_1v8 = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">support_1v8</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">support_1v8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_voltage_switch</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALL_SEND_CID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_RELATIVE_ADDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R6</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">rsp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_csd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
<span class="nl">SD_UNLOCK_ENTRY:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_update_lock_status</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_LOCKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SD_LOCK_1BIT_MODE</span> <span class="o">|</span> <span class="n">SD_PWD_EXIST</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_UNLOCK_POW_ON</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_PWD_EXIST</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_CLR_CARD_DETECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">support_1v8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_BUS_WIDTH</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">switch_bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">switch_bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_BLOCKLEN</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_clock_divider</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CLK_DIVIDE_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_csd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
		<span class="n">sd_dont_switch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd_dont_switch</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd20_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set sd_switch_fail here, because we needn&#39;t</span>
<span class="cm">			 * switch to UHS mode</span>
<span class="cm">			 */</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_switch_fail</span> <span class="o">=</span> <span class="n">SDR104_SUPPORT_MASK</span> <span class="o">|</span>
				<span class="n">DDR50_SUPPORT_MASK</span> <span class="o">|</span> <span class="n">SDR50_SUPPORT_MASK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Check the card whether follow SD1.1 spec or higher */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_spec</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">switch_bus_width</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_function</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">switch_bus_width</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">sd_change_bank_voltage</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_IO_3V3</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">sd_dont_switch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">try_sdio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">goto</span> <span class="n">Switch_Fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">support_1v8</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">sd_change_bank_voltage</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_IO_3V3</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">sd_dont_switch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">try_sdio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">goto</span> <span class="n">Switch_Fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">support_1v8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_BUS_WIDTH</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_LOCK_1BIT_MODE</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd20_mode</span> <span class="o">&amp;&amp;</span> <span class="n">CHK_SD30_SPEED</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">read_lba0</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD30_DRIVE_SEL</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd30_drive_sel_1v8</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_ddr_tuning</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_sdr_tuning</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd20_mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">try_sdio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">sd20_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">Switch_Fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD_DDR50</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_wait_state_data_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">read_lba0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_lba0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_lba0</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sd20_mode</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">try_sdio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">sd20_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">Switch_Fail</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_wp_state</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_UNLOCK_POW_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_test_switch_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">},</span> <span class="n">bus_width</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">byte_cnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BUSTEST_W</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">MMC_8BIT_BUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">byte_cnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x5A</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">byte_cnt</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG3</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH_ERR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_write_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_AUTO_WRITE_3</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">val1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_STAT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val1</span><span class="p">);</span>
			<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_STAT2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val2</span><span class="p">);</span>
			<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">val1</span> <span class="o">&amp;</span> <span class="mh">0xE0</span><span class="p">)</span> <span class="o">||</span> <span class="n">val2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH_ERR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG3</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH_ERR</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG3</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH_ERR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD/MMC CMD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BUSTEST_R</span><span class="p">);</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">BUSTEST_R</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">MMC_8BIT_BUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SD_CALCULATE_CRC7</span> <span class="o">|</span> <span class="n">SD_NO_CHECK_CRC16</span> <span class="o">|</span> <span class="n">SD_NO_WAIT_BUSY_END</span> <span class="o">|</span>
			<span class="n">SD_CHECK_CRC7</span> <span class="o">|</span> <span class="n">SD_RSP_LEN_6</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SD_TM_NORMAL_READ</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">MMC_8BIT_BUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH_ERR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="n">MMC_8BIT_BUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;BUSTEST_R [8bits]: 0x%02x 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xAA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">arg</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="mh">0x03B70600</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="mh">0x03B70200</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MMC_SWITCH_ERR</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">SWITCH_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;BUSTEST_R [4bits]: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xA5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="n">u32</span> <span class="n">arg</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="mh">0x03B70500</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">arg</span> <span class="o">=</span> <span class="mh">0x03B70100</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MMC_SWITCH_ERR</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">SWITCH_SUCCESS</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH_FAIL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">mmc_switch_timing_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">switch_ddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">card_type</span><span class="p">,</span> <span class="n">card_type_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">CLR_MMC_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD/MMC CMD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">SEND_EXT_CSD</span><span class="p">);</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">SEND_EXT_CSD</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">SD_CALCULATE_CRC7</span> <span class="o">|</span> <span class="n">SD_CHECK_CRC16</span> <span class="o">|</span> <span class="n">SD_NO_WAIT_BUSY_END</span> <span class="o">|</span>
			<span class="n">SD_CHECK_CRC7</span> <span class="o">|</span> <span class="n">SD_RSP_LEN_6</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SD_TM_NORMAL_READ</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">196</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">212</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">213</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">214</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">215</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span>
					<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SD_TRANSFER_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_SECTOR_MODE</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_SDR_RST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SUPPORT_MMC_DDR_MODE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">card_type_mask</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">card_type_mask</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">SUPPORT_MMC_DDR_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card_type_mask</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">card_type_mask</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card_type_mask</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">card_type</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">card_type_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card_type</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">switch_ddr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SET_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">SET_MMC_52M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">card_type</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SET_MMC_52M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">SET_MMC_26M</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SWITCH</span><span class="p">,</span>
				<span class="mh">0x03B90100</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MMC_SWITCH_ERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">CLR_MMC_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sd_choose_proper_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Test Bus Procedure */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">mmc_test_switch_bus</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MMC_8BIT_BUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">SWITCH_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SET_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_LOCK_1BIT_MODE</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">SWITCH_FAIL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">mmc_test_switch_bus</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MMC_4BIT_BUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">SWITCH_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SET_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_LOCK_1BIT_MODE</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">SWITCH_FAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CLR_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
			<span class="n">CLR_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_mmc</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">switch_ddr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">spec_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">temp</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_UNLOCK_POW_ON</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">MMC_UNLOCK_ENTRY</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="nl">Switch_Fail:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_prepare_reset</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">SET_MMC</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>

<span class="nl">RTY_MMC_RST:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">GO_IDLE_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
	       <span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_OP_COND</span><span class="p">,</span>
				<span class="p">(</span><span class="n">SUPPORT_VOLTAGE</span><span class="o">|</span><span class="mh">0x40000000</span><span class="p">),</span> <span class="n">SD_RSP_TYPE_R3</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUSY</span><span class="p">)</span> <span class="o">||</span> <span class="n">sd_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TO_ERR</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">k</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sd_clr_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">RTY_MMC_RST</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">j</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sd_clr_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">RTY_MMC_RST</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SET_MMC_SECTOR_MODE</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CLR_MMC_SECTOR_MODE</span><span class="p">(</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ALL_SEND_CID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R2</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span> <span class="o">=</span> <span class="mh">0x00100000</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_RELATIVE_ADDR</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R6</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_csd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spec_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_csd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3C</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_BLOCKLEN</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
<span class="nl">MMC_UNLOCK_ENTRY:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_update_lock_status</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_clock_divider</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CLK_DIVIDE_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_bus_width</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">mmc_dont_switch_bus</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">spec_ver</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* MMC 4.x Cards */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">mmc_switch_timing_bus</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">switch_ddr</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">mmc_dont_switch_bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Switch_Fail</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_SECTOR_MODE</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">switch_ddr</span> <span class="o">&amp;&amp;</span> <span class="n">CHK_MMC_DDR52</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">mmc_ddr_tuning</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">switch_ddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Switch_Fail</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_wait_state_data_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_lba0</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">switch_ddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">Switch_Fail</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_UNLOCK_POW_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIPR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">SD_WRITE_PROTECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">reset_sd_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">sd_init_reg_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sd_card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd_info</span><span class="p">));</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">enable_card_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ignore_sd</span> <span class="o">&amp;&amp;</span> <span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SDIO_IGNORED</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_pull_ctl_enable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span>
						     <span class="n">FPGA_SD_PULL_CTL_BIT</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">card_share_mode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ctl</span> <span class="o">&amp;</span> <span class="n">RESET_MMC_FIRST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_mmc</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">))</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_sd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span>
					<span class="n">sd_change_bank_voltage</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_IO_3V3</span><span class="p">);</span>

				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_sd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">))</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_bank_voltage</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_IO_3V3</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_mmc</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_clock_divider</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CLK_DIVIDE_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_card-&gt;sd_type = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_mmc_only</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_data_buf_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_switch_fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">enable_card_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_init_power</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_mmc</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_clock_divider</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CLK_DIVIDE_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_set_init_para</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;In reset_mmc_only, sd_card-&gt;sd_type = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WAIT_DATA_READY_RTY_CNT		255</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_data_buf_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WAIT_DATA_READY_RTY_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_NO_CARD</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_data_buf_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_data_buf_ready</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TO_ERR</span><span class="p">);</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">sd_stop_seq_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STOP_TRANSMISSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">SD_RSP_TYPE_R1b</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_STS_ERR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_wait_state_data_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_STS_ERR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RBCTL</span><span class="p">,</span> <span class="n">RB_FLUSH</span><span class="p">,</span> <span class="n">RB_FLUSH</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sd_auto_tune_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">-=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CLK_200</span>:
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_150</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CLK_150</span>:
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_120</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CLK_120</span>:
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CLK_100</span>:
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_80</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CLK_80</span>:
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_60</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CLK_60</span>:
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_clock</span> <span class="o">=</span> <span class="n">CLK_50</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_rw</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u32</span> <span class="n">start_sector</span><span class="p">,</span> <span class="n">u16</span> <span class="n">sector_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">data_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cfg2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_rw: Read %d %s from 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sector_cnt</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">sector_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;sectors&quot;</span> <span class="o">:</span> <span class="s">&quot;sector&quot;</span><span class="p">,</span> <span class="n">start_sector</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_rw: Write %d %s to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sector_cnt</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">sector_cnt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;sectors&quot;</span> <span class="o">:</span> <span class="s">&quot;sector&quot;</span><span class="p">,</span> <span class="n">start_sector</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">cleanup_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_CARD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_CARD</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_SD_HCXC</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_MMC_SECTOR_MODE</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">data_addr</span> <span class="o">=</span> <span class="n">start_sector</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data_addr</span> <span class="o">=</span> <span class="n">start_sector</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sd_clr_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_IO_ERR</span><span class="p">);</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RW_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_dir</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">)</span>
			<span class="o">||</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_sec_addr</span> <span class="o">+</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_sec_cnt</span><span class="p">)</span> <span class="o">!=</span> <span class="n">start_sector</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_sec_cnt</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_dir</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SD30_SPEED</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SD_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_MMC_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span>
					<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STOP_TRANSMISSION</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_STS_ERR</span><span class="p">);</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RW_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RBCTL</span><span class="p">,</span> <span class="n">RB_FLUSH</span><span class="p">,</span> <span class="n">RB_FLUSH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_IO_ERR</span><span class="p">);</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RW_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_sec_cnt</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SD30_SPEED</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SD_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span>
				<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_MMC_HS</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span>
					<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">sector_cnt</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">sector_cnt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">RING_BUFFER</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg2</span> <span class="o">=</span> <span class="n">SD_NO_CALCULATE_CRC7</span> <span class="o">|</span> <span class="n">SD_CHECK_CRC16</span> <span class="o">|</span> <span class="n">SD_NO_WAIT_BUSY_END</span> <span class="o">|</span>
				<span class="n">SD_NO_CHECK_CRC7</span> <span class="o">|</span> <span class="n">SD_RSP_LEN_0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_SD30_SPEED</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cfg2</span> <span class="o">|=</span> <span class="n">SD_NO_CHECK_WAIT_CRC_TO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cfg2</span><span class="p">);</span>

		<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">sector_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				     <span class="n">SD_TM_AUTO_READ_3</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				     <span class="n">SD_TM_AUTO_WRITE_3</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

		<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span> <span class="o">==</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD/MMC CMD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">READ_MULTIPLE_BLOCK</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				     <span class="mh">0x40</span> <span class="o">|</span> <span class="n">READ_MULTIPLE_BLOCK</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">data_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">data_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">data_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">data_addr</span><span class="p">);</span>

			<span class="n">cfg2</span> <span class="o">=</span> <span class="n">SD_CALCULATE_CRC7</span> <span class="o">|</span> <span class="n">SD_CHECK_CRC16</span> <span class="o">|</span> <span class="n">SD_NO_WAIT_BUSY_END</span> <span class="o">|</span>
					<span class="n">SD_CHECK_CRC7</span> <span class="o">|</span> <span class="n">SD_RSP_LEN_6</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_SD30_SPEED</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">cfg2</span> <span class="o">|=</span> <span class="n">SD_NO_CHECK_WAIT_CRC_TO</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cfg2</span><span class="p">);</span>

			<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">sector_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				     <span class="n">SD_TM_AUTO_READ_2</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span>
				     <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

			<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TO_ERR</span><span class="p">);</span>
				<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RW_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">wait_data_buf_ready</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TO_ERR</span><span class="p">);</span>
				<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RW_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_MULTIPLE_BLOCK</span><span class="p">,</span>
					<span class="n">data_addr</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RW_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

			<span class="n">cfg2</span> <span class="o">=</span> <span class="n">SD_NO_CALCULATE_CRC7</span> <span class="o">|</span> <span class="n">SD_CHECK_CRC16</span> <span class="o">|</span> <span class="n">SD_NO_WAIT_BUSY_END</span> <span class="o">|</span>
					<span class="n">SD_NO_CHECK_CRC7</span> <span class="o">|</span> <span class="n">SD_RSP_LEN_0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_SD30_SPEED</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">cfg2</span> <span class="o">|=</span> <span class="n">SD_NO_CHECK_WAIT_CRC_TO</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">cfg2</span><span class="p">);</span>

			<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">sector_cnt</span> <span class="o">*</span> <span class="mi">512</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				     <span class="n">SD_TM_AUTO_WRITE_3</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span>
				     <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

			<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span>
			<span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_STAT1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;No card exist, exit sd_rw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STOP_TRANSMISSION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_STS_ERR</span><span class="p">);</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RW_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SD_CRC7_ERR</span> <span class="o">|</span> <span class="n">SD_CRC16_ERR</span> <span class="o">|</span> <span class="n">SD_CRC_WRITE_ERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD CRC error, tune clock!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CRC_ERR</span><span class="p">);</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RW_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TO_ERR</span><span class="p">);</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RW_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_sec_addr</span> <span class="o">=</span> <span class="n">start_sector</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_sec_cnt</span> <span class="o">=</span> <span class="n">sector_cnt</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_dir</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">sc_data_direction</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>

<span class="nl">RW_FAIL:</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">detect_card_cd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_need_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;No card exist, exit sd_rw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CRC_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">mmc_dont_switch_bus</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">reset_mmc_only</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">mmc_dont_switch_bus</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">need_retune</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sd_auto_tune_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sd_check_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TO_ERR</span> <span class="o">|</span> <span class="n">SD_STS_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_CARD</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_CPRM</span>
<span class="kt">int</span> <span class="nf">soft_reset_sd_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">reset_sd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd_idx</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">arg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rsp_type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">special_check</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rty_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;EXT SD/MMC CMD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd_idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">RTY_SEND_CMD:</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">cmd_idx</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">arg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">rsp_type</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span>
			<span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span>
			<span class="mh">0xFF</span><span class="p">,</span> <span class="n">SD_TM_CMD_RSP</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">PPBUF_BASE2</span><span class="p">;</span> <span class="n">reg_addr</span> <span class="o">&lt;</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">stat_idx</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">!=</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">REG_SD_CMD0</span><span class="p">;</span> <span class="n">reg_addr</span> <span class="o">&lt;=</span> <span class="n">REG_SD_CMD4</span><span class="p">;</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">stat_idx</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_STAT1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">&amp;</span> <span class="n">SD_WAIT_BUSY_END</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_check_data0_status</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TO_ERR</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_STS_ERR</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rsp_type</span> <span class="o">&amp;</span> <span class="n">SD_NO_CHECK_CRC7</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="n">stat_idx</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SD_CRC7_ERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">WRITE_MULTIPLE_BLOCK</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CRC_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rty_cnt</span> <span class="o">&lt;</span> <span class="n">SD_MAX_RETRY_COUNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
				<span class="n">rty_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">RTY_SEND_CMD</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">sd_set_err_code</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CRC_ERR</span><span class="p">);</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">SELECT_CARD</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">APP_CMD</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">SEND_STATUS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">STOP_TRANSMISSION</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd_idx</span> <span class="o">!=</span> <span class="n">STOP_TRANSMISSION</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">special_check</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7D</span><span class="p">)</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7F</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">SELECT_CARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1E</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1E</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span> <span class="o">&amp;&amp;</span> <span class="n">rsp_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ext_sd_get_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rsp</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rsp_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">PPBUF_BASE2</span><span class="p">;</span> <span class="n">reg_addr</span> <span class="o">&lt;</span> <span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rsp_len</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rsp_type</span> <span class="o">!=</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">REG_SD_CMD0</span><span class="p">;</span> <span class="n">reg_addr</span> <span class="o">&lt;=</span> <span class="n">REG_SD_CMD4</span><span class="p">;</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rsp_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">min_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsp_len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="n">rsp_len</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">rsp</span><span class="p">,</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">),</span> <span class="n">min_len</span><span class="p">);</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;min_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">min_len</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Response in cmd buf: 0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">rsp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rsp</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_pass_thru_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x0E</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x53</span><span class="p">,</span>
		<span class="mh">0x44</span><span class="p">,</span>
		<span class="mh">0x20</span><span class="p">,</span>
		<span class="mh">0x43</span><span class="p">,</span>
		<span class="mh">0x61</span><span class="p">,</span>
		<span class="mh">0x72</span><span class="p">,</span>
		<span class="mh">0x64</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">CHK_BIT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mc</span><span class="p">,</span> <span class="n">lun</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">SET_BIT</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mc</span><span class="p">,</span> <span class="n">lun</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="mh">0x53</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0x44</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">||</span>
			<span class="p">(</span><span class="mh">0x43</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0x61</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">||</span>
			<span class="p">(</span><span class="mh">0x72</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0x64</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_pass_thru_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_pass_thru_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="o">?</span>  <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

	<span class="n">buf</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">get_rsp_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rsp_type</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rsp_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rsp_type</span> <span class="o">||</span> <span class="o">!</span><span class="n">rsp_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x03</span>:
		<span class="o">*</span><span class="n">rsp_type</span> <span class="o">=</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rsp_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x04</span>:
		<span class="o">*</span><span class="n">rsp_type</span> <span class="o">=</span> <span class="n">SD_RSP_TYPE_R1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rsp_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x05</span>:
		<span class="o">*</span><span class="n">rsp_type</span> <span class="o">=</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rsp_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x06</span>:
		<span class="o">*</span><span class="n">rsp_type</span> <span class="o">=</span> <span class="n">SD_RSP_TYPE_R2</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rsp_len</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x07</span>:
		<span class="o">*</span><span class="n">rsp_type</span> <span class="o">=</span> <span class="n">SD_RSP_TYPE_R3</span><span class="p">;</span>
		<span class="o">*</span><span class="n">rsp_len</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_execute_no_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_idx</span><span class="p">,</span> <span class="n">rsp_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">standby</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">acmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_pass_thru_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">standby</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">arg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">get_rsp_type</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">last_rsp_type</span> <span class="o">=</span> <span class="n">rsp_type</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_LOCK_1BIT_MODE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">standby</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span>
				<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">cmd_idx</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">rsp_type</span><span class="p">,</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Cmd_Failed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">standby</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_update_lock_status</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Cmd_Failed</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

<span class="nl">SD_Execute_Cmd_Failed:</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_NO_SENSE</span><span class="p">);</span>
	<span class="n">release_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">do_reset_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_execute_read_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd13_checkbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">read_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_idx</span><span class="p">,</span> <span class="n">rsp_type</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">send_cmd12</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">standby</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">acmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_pass_thru_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_cmd12</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">standby</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">get_rsp_type</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">last_rsp_type</span> <span class="o">=</span> <span class="n">rsp_type</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_LOCK_1BIT_MODE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_8</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;bus_width = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="n">bus_width</span> <span class="o">=</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_BLOCKLEN</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span>
				<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">standby</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span>
				<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">min_len</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">byte_cnt</span><span class="p">,</span> <span class="n">blk_cnt</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

		<span class="n">byte_cnt</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
		<span class="n">blk_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">cmd_idx</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
		<span class="n">cmd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">data_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_read_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_TM_NORMAL_READ</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">byte_cnt</span><span class="p">,</span>
				       <span class="n">blk_cnt</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">min_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">data_len</span><span class="p">,</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">));</span>
		<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">min_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data_len</span> <span class="o">&amp;</span> <span class="mh">0x1FF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span>
				<span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span>
				<span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">data_len</span> <span class="o">&amp;</span> <span class="mh">0x0001FE00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">));</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x40</span> <span class="o">|</span> <span class="n">cmd_idx</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD3</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CMD4</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">bus_width</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_CFG2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">rsp_type</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span>
			     <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SD_TM_AUTO_READ_2</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

		<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span>
			<span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">read_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">,</span> <span class="n">rsp_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">standby</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_cmd12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STOP_TRANSMISSION</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_BLOCKLEN</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span>
				<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd13_checkbit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span>
			<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd13_checkbit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Read_Cmd_Failed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

<span class="nl">SD_Execute_Read_Cmd_Failed:</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_NO_SENSE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">release_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">do_reset_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_execute_write_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd13_checkbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">write_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cmd_idx</span><span class="p">,</span> <span class="n">rsp_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">send_cmd12</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">standby</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">acmd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">arg</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="kt">int</span> <span class="n">lock_cmd_fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sd_lock_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lock_cmd_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_pass_thru_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd_idx</span> <span class="o">=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">send_cmd12</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">standby</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acmd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">arg</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">LOCK_UNLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_lock_state</span> <span class="o">=</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span><span class="p">;</span>
		<span class="n">sd_lock_state</span> <span class="o">&amp;=</span> <span class="n">SD_LOCKED</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">get_rsp_type</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">last_rsp_type</span> <span class="o">=</span> <span class="n">rsp_type</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_switch_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_LOCK_1BIT_MODE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_MMC_8BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHK_MMC_4BIT</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">REG_SD_CFG1</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">SD_BUS_WIDTH_4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_BLOCKLEN</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span>
				<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">standby</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">APP_CMD</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span>
				<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">cmd_idx</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">rsp_type</span><span class="p">,</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">,</span> <span class="n">rsp_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;=</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">data_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_ERROR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtsx_stor_get_xfer_buf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">LOCK_UNLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lock_cmd_type</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
						<span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
						<span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">data_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span>
						<span class="n">PPBUF_BASE2</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">CARD_DATA_SOURCE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">PINGPONG_BUFFER</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			     <span class="n">SD_TM_AUTO_WRITE_3</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data_len</span> <span class="o">&amp;</span> <span class="mh">0x1FF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">trans_dma_enable</span><span class="p">(</span><span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">DMA_512</span><span class="p">);</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_H</span><span class="p">,</span>
				<span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_BLOCK_CNT_L</span><span class="p">,</span>
				<span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">data_len</span> <span class="o">&amp;</span> <span class="mh">0x0001FE00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">));</span>

		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SD_TM_AUTO_WRITE_3</span> <span class="o">|</span> <span class="n">SD_TRANSFER_START</span><span class="p">);</span>
		<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">REG_SD_TRANSFER</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">,</span> <span class="n">SD_TRANSFER_END</span><span class="p">);</span>

		<span class="n">rtsx_send_cmd_no_wait</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_transfer_data</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="n">scsi_sglist</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">scsi_bufflen</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span>
			<span class="n">scsi_sg_count</span><span class="p">(</span><span class="n">srb</span><span class="p">),</span> <span class="n">DMA_TO_DEVICE</span><span class="p">,</span> <span class="mi">10000</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rtsx_clear_sd_error</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">LOCK_UNLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock_cmd_type</span> <span class="o">==</span> <span class="n">SD_ERASE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span> <span class="o">=</span> <span class="n">SD_UNDER_ERASING</span><span class="p">;</span>
			<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="n">SD_DAT0_STATUS</span><span class="p">,</span> <span class="n">SD_DAT0_STATUS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHECK_REG_CMD</span><span class="p">,</span> <span class="mh">0xFD30</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_update_lock_status</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Lock command fail!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">lock_cmd_fail</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* SUPPORT_SD_LOCK */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">standby</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_select_card</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_cmd12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STOP_TRANSMISSION</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">SD_RSP_TYPE_R1b</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="mi">512</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SET_BLOCKLEN</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">,</span>
				<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BYTE_CNT_H</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BYTE_CNT_L</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd13_checkbit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">ext_sd_send_cmd_get_rsp</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SEND_STATUS</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_addr</span><span class="p">,</span>
			<span class="n">SD_RSP_TYPE_R1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd13_checkbit</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_idx</span> <span class="o">==</span> <span class="n">LOCK_UNLOCK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lock_cmd_fail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;lock_cmd_type = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lock_cmd_type</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lock_cmd_type</span> <span class="o">&amp;</span> <span class="n">SD_CLR_PWD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_PWD_EXIST</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lock_cmd_type</span> <span class="o">&amp;</span> <span class="n">SD_SET_PWD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">|=</span> <span class="n">SD_PWD_EXIST</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_lock_state = 0x%x, sd_card-&gt;sd_lock_status = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">sd_lock_state</span><span class="p">,</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd_lock_state</span> <span class="o">^</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_LOCKED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_notify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sd_lock_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;</span> <span class="n">SD_LOCK_1BIT_MODE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">SD_UNLOCK_POW_ON</span> <span class="o">|</span> <span class="n">SD_SDR_RST</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_sd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SD_UNLOCK_POW_ON</span> <span class="o">|</span> <span class="n">SD_SDR_RST</span><span class="p">);</span>
							<span class="n">TRACE_GOTO</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_Execute_Write_Cmd_Failed</span><span class="p">);</span>
						<span class="p">}</span>
					<span class="p">}</span>

					<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SD_UNLOCK_POW_ON</span> <span class="o">|</span> <span class="n">SD_SDR_RST</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock_cmd_fail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_NO_SENSE</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif  </span><span class="cm">/* SUPPORT_SD_LOCK */</span><span class="cp"></span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>

<span class="nl">SD_Execute_Write_Cmd_Failed:</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_NO_SENSE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_WRITE_ERR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">release_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">do_reset_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_get_cmd_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_pass_thru_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">data_len</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">last_rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">last_rsp_type</span> <span class="o">==</span> <span class="n">SD_RSP_TYPE_R2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="mi">17</span><span class="p">)</span> <span class="o">?</span> <span class="n">data_len</span> <span class="o">:</span> <span class="mi">17</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">?</span> <span class="n">data_len</span> <span class="o">:</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rtsx_stor_set_xfer_buf</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">srb</span><span class="p">);</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Response length: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Response: 0x%x 0x%x 0x%x 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">rsp</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_hw_rst</span><span class="p">(</span><span class="k">struct</span> <span class="n">scsi_cmnd</span> <span class="o">*</span><span class="n">srb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lun</span> <span class="o">=</span> <span class="n">SCSI_LUN</span><span class="p">(</span><span class="n">srb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_pass_thru_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_CHANGE</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="mh">0x53</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0x44</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0x20</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">||</span>
			<span class="p">(</span><span class="mh">0x43</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0x61</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">||</span>
			<span class="p">(</span><span class="mh">0x72</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="o">||</span> <span class="p">(</span><span class="mh">0x64</span> <span class="o">!=</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
		<span class="k">if</span> <span class="p">(</span><span class="mh">0x64</span> <span class="o">==</span> <span class="n">srb</span><span class="o">-&gt;</span><span class="n">cmnd</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">|=</span> <span class="n">SD_SDR_RST</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">reset_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_SDR_RST</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_SDR_RST</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">soft_reset_sd_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_NOT_PRESENT</span><span class="p">);</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">pre_cmd_err</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">lun</span><span class="p">,</span> <span class="n">SENSE_TYPE_MEDIA_INVALID_CMD_FIELD</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TRANSPORT_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scsi_set_resid</span><span class="p">(</span><span class="n">srb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">TRANSPORT_GOOD</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">sd_cleanup_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">seq_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SD: stop transmission</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">sd_stop_seq_mode</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">cleanup_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sd_power_off_card3v3</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">disable_card_clock</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">SD_OUTPUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">card_power_off</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_pull_ctl_disable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span>
			<span class="n">FPGA_SD_PULL_CTL_BIT</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">FPGA_SD_PULL_CTL_BIT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">release_sd_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;release_sd_card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_CARD</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_CARD</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_wp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SD_CARD</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_csd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">raw_scr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_change_bank_voltage</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_IO_3V3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SD30_SPEED</span><span class="p">(</span><span class="n">sd_card</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD30_DRIVE_SEL</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd30_drive_sel_3v3</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPPARA2</span><span class="p">,</span> <span class="n">SD_OCP_THD_MASK</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_400mA_ocp_thd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
