<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › staging › rts_pstor › rtsx_chip.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rtsx_chip.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Driver for Realtek PCI-Express card reader</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2009 Realtek Semiconductor Corp. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2, or (at your option) any</span>
<span class="cm"> * later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:</span>
<span class="cm"> *   wwang (wei_wang@realsil.com.cn)</span>
<span class="cm"> *   No. 450, Shenhu Road, Suzhou Industry Park, Suzhou, China</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/blkdev.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &quot;rtsx.h&quot;</span>
<span class="cp">#include &quot;rtsx_transport.h&quot;</span>
<span class="cp">#include &quot;rtsx_scsi.h&quot;</span>
<span class="cp">#include &quot;rtsx_card.h&quot;</span>
<span class="cp">#include &quot;rtsx_chip.h&quot;</span>
<span class="cp">#include &quot;rtsx_sys.h&quot;</span>
<span class="cp">#include &quot;general.h&quot;</span>

<span class="cp">#include &quot;sd.h&quot;</span>
<span class="cp">#include &quot;xd.h&quot;</span>
<span class="cp">#include &quot;ms.h&quot;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtsx_calibration</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1B</span><span class="p">,</span> <span class="mh">0x135E</span><span class="p">);</span>
	<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0280</span><span class="p">);</span>
	<span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x7112</span><span class="p">);</span>
	<span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x7110</span><span class="p">);</span>
	<span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x7112</span><span class="p">);</span>
	<span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x7113</span><span class="p">);</span>
	<span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0288</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_disable_card_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIER</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XD_INT_EN</span> <span class="o">|</span> <span class="n">SD_INT_EN</span> <span class="o">|</span> <span class="n">MS_INT_EN</span><span class="p">);</span>
	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIER</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_enable_card_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIER</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XD_CARD</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">XD_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">SD_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">MS_INT_EN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">SD_INT_EN</span><span class="p">);</span>

	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIER</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_enable_bus_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifndef DISABLE_CARD_INT</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">TRANS_OK_INT_EN</span> <span class="o">|</span> <span class="n">TRANS_FAIL_INT_EN</span><span class="p">;</span>

<span class="cp">#ifndef DISABLE_CARD_INT</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;lun2card[%d] = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XD_CARD</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">XD_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">SD_INT_EN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">MS_INT_EN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">SD_INT_EN</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">&gt;=</span> <span class="n">IC_VER_C</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">DELINK_INT_EN</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">MS_OC_INT_EN</span> <span class="o">|</span> <span class="n">SD_OC_INT_EN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">SD_OC_INT_EN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">OC_INT_EN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">adma_mode</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">DATA_DONE_INT_EN</span><span class="p">;</span>

	<span class="cm">/* Enable Bus Interrupt */</span>
	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIER</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;RTSX_BIER: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_disable_bus_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtsx_pre_handle_sdio_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ignore_sd</span> <span class="o">&amp;&amp;</span> <span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PULL_CTL5</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				<span class="n">MS_INS_PU</span> <span class="o">|</span> <span class="n">SD_WP_PU</span> <span class="o">|</span> <span class="n">SD_CD_PU</span> <span class="o">|</span> <span class="n">SD_CMD_PU</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">FPGA_SD_PULL_CTL_EN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_SHARE_MODE</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">CARD_SHARE_48_SD</span><span class="p">);</span>

		<span class="cm">/* Enable SDIO internal clock */</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFF2C</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SDIO_CTRL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SDIO_BUS_CTRL</span> <span class="o">|</span> <span class="n">SDIO_CD_CTRL</span><span class="p">);</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef HW_AUTO_SWITCH_SD_BUS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rtsx_pre_handle_sdio_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sw_bypass_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">driver_first_load</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE5A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
				<span class="n">sw_bypass_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE70</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">sw_bypass_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SDIO_CFG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">SDIO_BUS_AUTO_SWITCH</span><span class="p">)</span>
				<span class="n">sw_bypass_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_in_charge</span><span class="p">)</span>
			<span class="n">sw_bypass_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;sdio_in_charge = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_in_charge</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;driver_first_load = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">driver_first_load</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sw_bypass_sd = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sw_bypass_sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sw_bypass_sd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">cd_toggle_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TLPTISTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cd_toggle_mask</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cd_toggle_mask</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">cd_toggle_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable sdio_bus_auto_switch */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE5A</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE70</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SDIO_CFG</span><span class="p">,</span> <span class="n">SDIO_BUS_AUTO_SWITCH</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TLPTISTAT</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Chip inserted with SDIO!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">sd_pull_ctl_enable</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPGA_PULL_CTL</span><span class="p">,</span> <span class="n">FPGA_SD_PULL_CTL_BIT</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">card_share_mode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* Enable sdio_bus_auto_switch */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE5A</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE70</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SDIO_CFG</span><span class="p">,</span>
					<span class="n">SDIO_BUS_AUTO_SWITCH</span><span class="p">,</span> <span class="n">SDIO_BUS_AUTO_SWITCH</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_insert_with_sdio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TLPTISTAT</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TLPTISTAT</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">int</span> <span class="nf">rtsx_reset_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_HCBAR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">host_cmds_addr</span><span class="p">);</span>

	<span class="n">rtsx_disable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

		<span class="cm">/* optimize PHY */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xB966</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x713F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xA549</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xB235</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xEF40</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mh">0xF8EB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0xFE6C</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x05C0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Read from phy 0x08: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_voltage</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_voltage</span> <span class="o">&amp;=</span> <span class="mh">0x3F</span><span class="p">;</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;phy_voltage = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_voltage</span><span class="p">);</span>
			<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x3F</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_voltage</span><span class="p">;</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Write to phy 0x08: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_voltage</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Default, chip-&gt;phy_voltage = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_voltage</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">HOST_SLEEP_STATE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* Disable card clock */</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_CLK_EN</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="cm">/* SSC power on, OCD power on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPDCTL</span><span class="p">,</span> <span class="n">OC_POWER_DOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPDCTL</span><span class="p">,</span> <span class="n">OC_POWER_DOWN</span><span class="p">,</span> <span class="n">MS_OC_POWER_DOWN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPPARA1</span><span class="p">,</span> <span class="n">SD_OCP_TIME_MASK</span> <span class="o">|</span> <span class="n">MS_OCP_TIME_MASK</span><span class="p">,</span>
				    <span class="n">SD_OCP_TIME_800</span> <span class="o">|</span> <span class="n">MS_OCP_TIME_800</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPPARA2</span><span class="p">,</span> <span class="n">SD_OCP_THD_MASK</span> <span class="o">|</span> <span class="n">MS_OCP_THD_MASK</span><span class="p">,</span>
				    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_400mA_ocp_thd</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_ocp_thd</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPGLITCH</span><span class="p">,</span> <span class="n">SD_OCP_GLITCH_MASK</span> <span class="o">|</span> <span class="n">MS_OCP_GLITCH_MASK</span><span class="p">,</span>
				       <span class="n">SD_OCP_GLITCH_10000</span> <span class="o">|</span> <span class="n">MS_OCP_GLITCH_10000</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPGLITCH</span><span class="p">,</span> <span class="n">SD_OCP_GLITCH_MASK</span><span class="p">,</span> <span class="n">SD_OCP_GLITCH_10000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPCTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
				    <span class="n">SD_OCP_INT_EN</span> <span class="o">|</span> <span class="n">SD_DETECT_EN</span> <span class="o">|</span> <span class="n">MS_OCP_INT_EN</span> <span class="o">|</span> <span class="n">MS_DETECT_EN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPPARA1</span><span class="p">,</span> <span class="n">OCP_TIME_MASK</span><span class="p">,</span> <span class="n">OCP_TIME_800</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPPARA2</span><span class="p">,</span> <span class="n">OCP_THD_MASK</span><span class="p">,</span> <span class="n">OCP_THD_244_946</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPCTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">CARD_OC_INT_EN</span> <span class="o">|</span> <span class="n">CARD_DETECT_EN</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="cm">/* OC power down */</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPDCTL</span><span class="p">,</span> <span class="n">OC_POWER_DOWN</span><span class="p">,</span> <span class="n">OC_POWER_DOWN</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_GPIO_DIR</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Turn off LED */</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_GPIO</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="cm">/* Reset delink mode */</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Card driving select */</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_DRIVE_SEL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_drive_sel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD30_DRIVE_SEL</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd30_drive_sel_3v3</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef LED_AUTO_BLINK</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_AUTO_BLINK</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="n">LED_BLINK_SPEED</span> <span class="o">|</span> <span class="n">BLINK_EN</span> <span class="o">|</span> <span class="n">LED_GPIO0</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable SSC Clock */</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_CTL1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">SSC_8X_EN</span> <span class="o">|</span> <span class="n">SSC_SEL_4M</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_CTL2</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Disable cd_pwr_save (u_force_rst_core_en=0, u_cd_rst_core_en=0)</span>
<span class="cm">	      0xFE5B</span>
<span class="cm">	      bit[1]    u_cd_rst_core_en    	rst_value = 0</span>
<span class="cm">	      bit[2]    u_force_rst_core_en 	rst_value = 0</span>
<span class="cm">	      bit[5]    u_mac_phy_rst_n_dbg 	rst_value = 1</span>
<span class="cm">	      bit[4]	u_non_sticky_rst_n_dbg	rst_value = 0</span>
<span class="cm">	*/</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="cm">/* Enable ASPM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dynamic_aspm</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ASPM_FORCE_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LCTLR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">&amp;&amp;</span> <span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0129</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LCTLR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x70C</span><span class="p">,</span> <span class="mh">0xFF000000</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mh">0x0103</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">,</span> <span class="n">LINK_RDY_INT</span><span class="p">,</span> <span class="n">LINK_RDY_INT</span><span class="p">);</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PERST_GLITCH_WIDTH</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PWD_SUSPEND_EN</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PWR_GATE_CTRL</span><span class="p">,</span> <span class="n">PWR_GATE_EN</span><span class="p">,</span> <span class="n">PWR_GATE_EN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Enable PCIE interrupt */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CDRESUMECTL</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">rtsx_disable_bus_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtsx_enable_bus_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">&gt;=</span> <span class="n">IC_VER_D</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xFE7F</span><span class="p">;</span>
				<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xFFF7</span><span class="p">;</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">driver_first_load</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">&lt;</span> <span class="n">IC_VER_C</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rtsx_calibration</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_enable_bus_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rtsx_enable_bus_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef HW_INT_WRITE_CLR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Set interrupt write clear */</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">NFTS_TX_CTRL</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIPR</span><span class="p">);</span>
<span class="cp">#ifdef HW_INT_WRITE_CLR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Clear interrupt flag */</span>
		<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIPR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">NextCard</span><span class="p">;</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;In rtsx_reset_chip, chip-&gt;int_reg = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">SD_EXIST</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef HW_AUTO_SWITCH_SD_BUS</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">&lt;</span> <span class="n">IC_VER_C</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_pre_handle_sdio_old</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_pre_handle_sdio_new</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;need_reset = 0x%x (rtsx_reset_chip)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span><span class="p">));</span>
<span class="cp">#else  </span><span class="cm">/* HW_AUTO_SWITCH_SD_BUS */</span><span class="cp"></span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_pre_handle_sdio_old</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif  </span><span class="cm">/* HW_AUTO_SWITCH_SD_BUS */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SDIO_CTRL</span><span class="p">,</span> <span class="n">SDIO_BUS_CTRL</span> <span class="o">|</span> <span class="n">SDIO_CD_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">NextCard:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">XD_EXIST</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">|=</span> <span class="n">XD_CARD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">MS_EXIST</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">CARD_EXIST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_CTL1</span><span class="p">,</span> <span class="n">SSC_RSTB</span><span class="p">,</span> <span class="n">SSC_RSTB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;In rtsx_init_chip, chip-&gt;need_reset = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span><span class="p">));</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RCCTL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Turn off main power when entering S3/S4 state */</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MAIN_PWR_OFF_CTL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">remote_wakeup_en</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WAKE_SEL_CTL</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aux_pwr_exist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PME_FORCE_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WAKE_SEL_CTL</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PME_FORCE_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">&gt;=</span> <span class="n">IC_VER_D</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PETXCFG</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">force_clkreq_0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PETXCFG</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PETXCFG</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">&amp;&amp;</span> <span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_clr_phy_reg_bit</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ft2_fast_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PWR_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_PARTIAL_POWER_ON</span> <span class="o">|</span> <span class="n">SD_PARTIAL_POWER_ON</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pmos_pwr_on_interval</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_PWR_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">MS_POWER_ON</span> <span class="o">|</span> <span class="n">SD_POWER_ON</span><span class="p">);</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Reset card */</span>
	<span class="n">rtsx_reset_detected_cards</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">driver_first_load</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">check_sd_speed_prior</span><span class="p">(</span><span class="n">u32</span> <span class="n">sd_speed_prior</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fake_para</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">sd_speed_prior</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fake_para</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">fake_para</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">check_sd_current_prior</span><span class="p">(</span><span class="n">u32</span> <span class="n">sd_current_prior</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fake_para</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">sd_current_prior</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">8</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fake_para</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">fake_para</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts5209_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">rtsx_readb</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aux_pwr_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_power_class_en</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x724</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;dw in 0x724: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lval</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">lval</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mode</span> <span class="o">=</span> <span class="n">DEFAULT_SINGLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mode</span> <span class="o">=</span> <span class="n">SD_MS_2LUN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">SET_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">CLR_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">SET_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">use_hw_setting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">clk</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">lval</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">!=</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_sd_sdr50_clk</span> <span class="o">=</span> <span class="mi">98</span> <span class="o">-</span> <span class="n">clk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">clk</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">!=</span> <span class="mh">0x07</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_ms_hg_clk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">59</span> <span class="o">-</span> <span class="n">clk</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">lval</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

		<span class="n">clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_sd_hs_clk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">49</span> <span class="o">-</span> <span class="n">clk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_mmc_52m_clk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">49</span> <span class="o">-</span> <span class="n">clk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">!=</span> <span class="mh">0x03</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_sd_ddr50_clk</span> <span class="o">=</span> <span class="p">(</span><span class="mi">48</span> <span class="o">-</span> <span class="n">clk</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdr104_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdr104_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ddr50_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ddr50_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdr50_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdr50_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">lval</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>

		<span class="n">clk</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">clk</span> <span class="o">!=</span> <span class="mh">0x07</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_sd_sdr104_clk</span> <span class="o">=</span> <span class="mi">206</span> <span class="o">-</span> <span class="n">clk</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">power_down_in_ss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">power_down_in_ss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_power_class_en</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">hp_watch_bios_hotplug</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">reg58</span><span class="p">,</span> <span class="n">reg5b</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_pci_cfg_byte</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span>
						<span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg58</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_pci_cfg_byte</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span>
						<span class="mh">0x1C</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg5b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;reg58 = 0x%x, reg5b = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg58</span><span class="p">,</span> <span class="n">reg5b</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">reg58</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg5b</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts5208_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_SEL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_SEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Value of phy register 0x1C is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">PHY_DEBUG_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE80</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PDINFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;PDINFO: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AUX_PWR_DETECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aux_pwr_exist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aux_pwr_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE50</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rtsx_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0E</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SET_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CLR_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">use_hw_setting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rts5288_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_func</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_SEL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_SEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PDINFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;PDINFO: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">AUX_PWR_DETECTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aux_pwr_exist</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aux_pwr_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_SHARE_MODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;CARD_SHARE_MODE: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">baro_pkg</span> <span class="o">=</span> <span class="n">QFN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">baro_pkg</span> <span class="o">=</span> <span class="n">LQFP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE5A</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x718</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lval</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">max_func</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)((</span><span class="n">lval</span> <span class="o">&gt;&gt;</span> <span class="mi">29</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Max function number: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">max_func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_func</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SET_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CLR_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">use_hw_setting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LQFP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mode</span> <span class="o">=</span> <span class="n">SD_MS_1LUN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mode</span> <span class="o">=</span> <span class="n">DEFAULT_SINGLE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_init_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xd_info</span> <span class="o">*</span><span class="n">xd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_card</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ms_info</span> <span class="o">*</span><span class="n">ms_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_card</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Vendor ID: 0x%04x, Product ID: 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">chip</span><span class="o">-&gt;</span><span class="n">vendor_id</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef _MSG_TRACE</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">msg_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">xd_card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xd_info</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">sd_card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sd_info</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ms_card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ms_info</span><span class="p">));</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_reset_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_reset_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_reset_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_show_cnt</span> <span class="o">=</span> <span class="n">MAX_SHOW_CNT</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_show_cnt</span> <span class="o">=</span> <span class="n">MAX_SHOW_CNT</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_show_cnt</span> <span class="o">=</span> <span class="n">MAX_SHOW_CNT</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_INIT</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">chip_insert_with_sdio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_aspm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_idle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cur_card</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_func_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_raw_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_ALLOWED_LUN_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_sense_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">SENSE_TYPE_NO_SENSE</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rw_fail_cnt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sd_speed_prior</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_speed_prior</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_speed_prior</span> <span class="o">=</span> <span class="mh">0x01040203</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_speed_prior = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_speed_prior</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_sd_current_prior</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_current_prior</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_current_prior</span> <span class="o">=</span> <span class="mh">0x00010203</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;sd_current_prior = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_current_prior</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ddr_tx_phase</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ddr_tx_phase</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_ddr_tx_phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmc_ddr_tx_phase</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmc_ddr_tx_phase</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mmc_ddr_tx_phase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPDCTL</span><span class="p">,</span> <span class="n">SSC_POWER_DOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CLK_DIV</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;use_hw_setting = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">use_hw_setting</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts5209_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts5208_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rts5288_init</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;asic_code = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;ic_version = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;phy_debug_mode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;aux_pwr_exist = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aux_pwr_exist</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;sdio_func_exist = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_func_exist</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;hw_bypass_sd = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">hw_bypass_sd</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;aspm_l0s_l1_en = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;lun_mode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun_mode</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;auto_delink_en = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;ss_en = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span><span class="p">);</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;chip-&gt;baro_pkg = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">baro_pkg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">XD_CARD</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SD_CARD</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MS_CARD</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">SET_SDIO_IGNORED</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_1LUN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">XD_CARD</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SD_CARD</span> <span class="o">|</span> <span class="n">MS_CARD</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">XD_CARD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">SD_CARD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card2lun</span><span class="p">[</span><span class="n">MS_CARD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lun2card</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">XD_CARD</span> <span class="o">|</span> <span class="n">SD_CARD</span> <span class="o">|</span> <span class="n">MS_CARD</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">max_lun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_reset_chip</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_release_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xd_free_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">ms_free_l2p_tbl</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if !defined(LED_AUTO_BLINK) &amp;&amp; defined(REGULAR_BLINK)</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">rtsx_blink_led</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">blink_led</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">led_toggle_counter</span> <span class="o">&lt;</span> <span class="n">LED_TOGGLE_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">led_toggle_counter</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">led_toggle_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">toggle_gpio</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LED_GPIO</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtsx_monitor_aspm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">maybe_support_aspm</span><span class="p">,</span> <span class="n">reg_changed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reg1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">maybe_support_aspm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg_changed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rtsx_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LCTLR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">reg0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SDIO_IGNORED</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_read_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">reg1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">reg1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg_changed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">reg0</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg1</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">maybe_support_aspm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg0</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">maybe_support_aspm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg_changed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">maybe_support_aspm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;aspm_level[0] = 0x%02x, aspm_level[1] = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_aspm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ASPM_FORCE_CTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="mh">0x30</span> <span class="o">|</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_polling_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">struct</span> <span class="n">sd_info</span> <span class="o">*</span><span class="n">sd_card</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_card</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">ss_allowed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtsx_chk_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_SUSPEND</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtsx_chk_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_DELINK</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">Delink_Stage</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">polling_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">rtsx_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rtsx_chk_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_SS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_int</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">OCPSTAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_int</span> <span class="o">&amp;</span> <span class="n">SD_OC_INT</span><span class="p">)</span>
				<span class="n">sd_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_int</span> <span class="o">&amp;</span> <span class="n">MS_OC_INT</span><span class="p">)</span>
				<span class="n">ms_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sd_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ms_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">xd_power_off_card3v3</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef SUPPORT_SD_LOCK</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_BUS_STAT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">SD_DAT0_STATUS</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span> <span class="o">=</span> <span class="n">SD_NOT_ERASE</span><span class="p">;</span>
					<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_notify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reinit</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFD30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span> <span class="o">=</span> <span class="n">SD_NOT_ERASE</span><span class="p">;</span>
					<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_lock_notify</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reinit</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sd_card</span><span class="o">-&gt;</span><span class="n">sd_erase_status</span> <span class="o">=</span> <span class="n">SD_NOT_ERASE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">rtsx_init_cards</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ss_allowed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ss_allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SDIO_IGNORED</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
				<span class="n">rtsx_read_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ss_allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ss_allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ss_allowed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RTSX_STAT_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_counter</span> <span class="o">&lt;</span>
				<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_idle_period</span> <span class="o">/</span> <span class="n">POLLING_INTERVAL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_counter</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtsx_exclusive_enter_ss</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_monitor_aspm_config</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

<span class="cp">#ifdef SUPPORT_SDIO_ASPM</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">CHK_SDIO_IGNORED</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dynamic_aspm</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dynamic_configure_sdio_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_aspm</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;SDIO enter ASPM!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
						<span class="n">ASPM_FORCE_CTL</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span>
						<span class="mh">0x30</span> <span class="o">|</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_aspm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">idle_counter</span> <span class="o">&lt;</span> <span class="n">IDLE_MAX_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">idle_counter</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">!=</span> <span class="n">RTSX_STAT_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Idle state!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_IDLE</span><span class="p">);</span>

<span class="cp">#if !defined(LED_AUTO_BLINK) &amp;&amp; defined(REGULAR_BLINK)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">led_toggle_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>

			<span class="n">turn_off_led</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LED_GPIO</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_power_down</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_force_power_down</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span> <span class="o">|</span> <span class="n">OC_PDCTL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RTSX_STAT_RUN</span>:
<span class="cp">#if !defined(LED_AUTO_BLINK) &amp;&amp; defined(REGULAR_BLINK)</span>
		<span class="n">rtsx_blink_led</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">do_remaining_work</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RTSX_STAT_IDLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_int</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">try_to_switch_sdio_ctrl</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">rtsx_enable_aspm</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>


<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_RTS_PSTOR_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SD_OC_NOW</span> <span class="o">|</span> <span class="n">SD_OC_EVER</span> <span class="o">|</span> <span class="n">MS_OC_NOW</span> <span class="o">|</span> <span class="n">MS_OC_EVER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Over current, OCPSTAT is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SD_OC_NOW</span> <span class="o">|</span> <span class="n">SD_OC_EVER</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">SD_OUTPUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">card_power_off</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MS_OC_NOW</span> <span class="o">|</span> <span class="n">MS_OC_EVER</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">MS_OUTPUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">card_power_off</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">MS_CARD</span><span class="p">);</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SD_OC_NOW</span> <span class="o">|</span> <span class="n">SD_OC_EVER</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Over current, OCPSTAT is 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_stat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">SD_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">SD_OUTPUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">SD_CARD</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">MS_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">MS_OUTPUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">MS_CARD</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">&amp;</span> <span class="n">XD_CARD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CARD_OE</span><span class="p">,</span> <span class="n">XD_OUTPUT_EN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_fail</span> <span class="o">|=</span> <span class="n">XD_CARD</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">card_power_off</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_CARD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="nl">Delink_Stage:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_allowed</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ready</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_ejected</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">enter_L1</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_in_L1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span> <span class="o">||</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">delink_stage1_cnt</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">delink_stage1_step</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">delink_stage2_cnt</span> <span class="o">=</span> <span class="n">delink_stage1_cnt</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">delink_stage2_step</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">delink_stage3_cnt</span> <span class="o">=</span> <span class="n">delink_stage2_cnt</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">delink_stage3_step</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_cnt</span> <span class="o">&lt;=</span> <span class="n">delink_stage3_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_cnt</span> <span class="o">==</span> <span class="n">delink_stage1_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_DELINK</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">&amp;&amp;</span> <span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rtsx_set_phy_reg_bit</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;False card inserted, do force delink</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">enter_L1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">HOST_SLEEP_STATE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">enter_L1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rtsx_enter_L1</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_cnt</span> <span class="o">=</span> <span class="n">delink_stage3_cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;No card inserted, do delink</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">enter_L1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">HOST_SLEEP_STATE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
					<span class="p">}</span>
<span class="cp">#ifdef HW_INT_WRITE_CLR</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIPR</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
						<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;RTSX_BIPR: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIPR</span><span class="p">));</span>
					<span class="p">}</span>
<span class="cp">#endif</span>
					<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">enter_L1</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">rtsx_enter_L1</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_cnt</span> <span class="o">==</span> <span class="n">delink_stage2_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Try to do force delink</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">enter_L1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">rtsx_exit_L1</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">&amp;&amp;</span> <span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rtsx_set_phy_reg_bit</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_undo_delink</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_allowed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rtsx_stop_cmd - stop command transfer and DMA transfer</span>
<span class="cm"> * @chip: Realtek&#39;s card reader chip</span>
<span class="cm"> * @card: flash card type</span>
<span class="cm"> *</span>
<span class="cm"> * Stop command transfer and DMA transfer.</span>
<span class="cm"> * This function is called in error handler.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtsx_stop_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">RTSX_HCBAR</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;BAR (0x%02x): 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_HCBCTLR</span><span class="p">,</span> <span class="n">STOP_CMD</span><span class="p">);</span>
	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_HDBCTLR</span><span class="p">,</span> <span class="n">STOP_DMA</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">addr</span> <span class="o">=</span> <span class="mh">0xFE20</span> <span class="o">+</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">rtsx_read_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;0x%04X: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">DMACTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RBCTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_RW_REG_CNT		1024</span>

<span class="kt">int</span> <span class="nf">rtsx_write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x3FFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_HAIMR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RW_REG_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_HAIMR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x3FFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_HAIMR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RW_REG_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_HAIMR</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_RW_REG_CNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_write_cfg_dw</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func_no</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGDATA0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				       <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGADDR0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGADDR1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGRWCTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span>
			       <span class="mh">0x80</span> <span class="o">|</span> <span class="n">mode</span> <span class="o">|</span> <span class="p">((</span><span class="n">func_no</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RW_REG_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGRWCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_read_cfg_dw</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func_no</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGADDR0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGADDR1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGRWCTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x80</span> <span class="o">|</span> <span class="p">((</span><span class="n">func_no</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_RW_REG_CNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGRWCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CFGDATA0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_write_cfg_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aligned_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dw_len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_NOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dw_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;dw_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_len</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">dw_len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_NOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">dw_len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_NOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">|=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">RTSX_DUMP</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dw_len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">RTSX_DUMP</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dw_len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dw_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">aligned_addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_read_cfg_seq</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">func</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">%</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aligned_addr</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dw_len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dw_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dw_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;dw_len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dw_len</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">vmalloc</span><span class="p">(</span><span class="n">dw_len</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_NOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dw_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">aligned_addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">offset</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">j</span><span class="o">++</span><span class="p">;</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_write_phy_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">finished</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYDATA0</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYDATA1</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYADDR</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYRWCTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYRWCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">finished</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_read_phy_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">finished</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYADDR</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYRWCTL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYRWCTL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">finished</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">finished</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYDATA0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PHYDATA1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_read_efuse</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">EFUSE_CTRL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x80</span><span class="o">|</span><span class="n">addr</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">EFUSE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">EFUSE_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_write_efuse</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Write 0x%x to 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">EFUSE_DATA</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">RTSX_WRITE_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">EFUSE_CTRL</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xA0</span><span class="o">|</span><span class="n">addr</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">EFUSE_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_TIMEDOUT</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_clr_phy_reg_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_set_phy_reg_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_read_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_check_link_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">RTSX_READ_REG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;IRQSTAT0: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">LINK_RDY_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Delinked!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">,</span> <span class="n">LINK_RDY_INT</span><span class="p">,</span> <span class="n">LINK_RDY_INT</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtsx_handle_pm_dstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dstate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ultmp</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;%04x set pm_dstate to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">product_id</span><span class="p">,</span> <span class="n">dstate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">func_no</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">func_no</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">func_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rtsx_read_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">func_no</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ultmp</span><span class="p">);</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;pm_dstate of function %d: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">func_no</span><span class="p">,</span> <span class="n">ultmp</span><span class="p">);</span>
		<span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">func_no</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">dstate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">dstate</span><span class="p">);</span>
	<span class="n">rtsx_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_enter_L1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtsx_handle_pm_dstate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_exit_L1</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">rtsx_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">rtsx_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_enter_ss</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Enter Selective Suspend State!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">IRQSTAT0</span><span class="p">,</span> <span class="n">LINK_RDY_INT</span><span class="p">,</span> <span class="n">LINK_RDY_INT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">power_down_in_ss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_power_off_card</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">rtsx_force_power_down</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span> <span class="o">|</span> <span class="n">OC_PDCTL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">HOST_SLEEP_STATE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phy_debug_mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIER</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">CARD_INT</span><span class="p">;</span>
			<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIER</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_enter_L1</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">RTSX_CLR_DELINK</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_SS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_exit_ss</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Exit Selective Suspend State!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rtsx_exit_L1</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">power_down_in_ss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span> <span class="o">|</span> <span class="n">OC_PDCTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">RTSX_TST_DELINK</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reinit</span> <span class="o">=</span> <span class="n">SD_CARD</span> <span class="o">|</span> <span class="n">MS_CARD</span> <span class="o">|</span> <span class="n">XD_CARD</span><span class="p">;</span>
		<span class="n">rtsx_reinit_cards</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">RTSX_CLR_DELINK</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">power_down_in_ss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reinit</span> <span class="o">=</span> <span class="n">SD_CARD</span> <span class="o">|</span> <span class="n">MS_CARD</span> <span class="o">|</span> <span class="n">XD_CARD</span><span class="p">;</span>
		<span class="n">rtsx_reinit_cards</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_pre_handle_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">int_enable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exit_ss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="n">u32</span> <span class="n">ocp_int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ocp_int</span> <span class="o">=</span> <span class="n">MS_OC_INT</span> <span class="o">|</span> <span class="n">SD_OC_INT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ocp_int</span> <span class="o">=</span> <span class="n">SD_OC_INT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ocp_int</span> <span class="o">=</span> <span class="n">OC_INT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ss_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rtsx_get_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">)</span> <span class="o">==</span> <span class="n">RTSX_STAT_SS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">exit_ss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rtsx_exit_L1</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
			<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_RUN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">int_enable</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIER</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">=</span> <span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIPR</span><span class="p">);</span>

<span class="cp">#ifdef HW_INT_WRITE_CLR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rtsx_writel</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_BIPR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">int_enable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">msi_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">rtsx_read_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">STATUS_FAIL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">int_enable</span> <span class="o">|</span> <span class="mh">0x7FFFFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">CARD_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_INT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_EXIST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">SD_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">SD_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_release</span><span class="p">));</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_reset_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_show_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">SD_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If multi-luns, it&#39;s possible that</span>
<span class="cm">			   when plugging/unplugging one card</span>
<span class="cm">			   there is another card which still</span>
<span class="cm">			   exists in the slot. In this case,</span>
<span class="cm">			   all existed cards should be reset.</span>
<span class="cm">			*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exit_ss</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SD_EXIST</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">SD_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reinit</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">)</span> <span class="o">||</span> <span class="n">CHECK_BARO_PKG</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">QFN</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">XD_INT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">XD_EXIST</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">XD_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span><span class="p">));</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">XD_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_release</span><span class="p">));</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_reset_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">xd_show_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">clear_bit</span><span class="p">(</span><span class="n">XD_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">exit_ss</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">XD_EXIST</span><span class="p">))</span>
					<span class="n">set_bit</span><span class="p">(</span><span class="n">XD_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reinit</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MS_INT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MS_EXIST</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MS_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MS_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_release</span><span class="p">));</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_reset_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ms_show_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">MS_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reset</span><span class="p">));</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exit_ss</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">MS_EXIST</span><span class="p">))</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">MS_NR</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">need_reinit</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ocp_int</span> <span class="o">=</span> <span class="n">ocp_int</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">&amp;</span> <span class="n">DATA_DONE_INT</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">DATA_DONE_INT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_do_before_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pm_stat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;rtsx_do_before_power_down, pm_stat = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pm_stat</span><span class="p">);</span>

	<span class="n">rtsx_set_stat</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">RTSX_STAT_SUSPEND</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_force_power_on</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rtsx_release_cards</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">rtsx_disable_bus_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">turn_off_led</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LED_GPIO</span><span class="p">);</span>

<span class="cp">#ifdef HW_AUTO_SWITCH_SD_BUS</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">sdio_in_charge</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TLPTISTAT</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
			<span class="cm">/* Enable sdio_bus_auto_switch */</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE70</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TLPTISTAT</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
			<span class="cm">/* Enable sdio_bus_auto_switch */</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0xFE5A</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TLPTISTAT</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
			<span class="cm">/* Enable sdio_bus_auto_switch */</span>
			<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SDIO_CFG</span><span class="p">,</span> <span class="n">SDIO_BUS_AUTO_SWITCH</span><span class="p">,</span> <span class="n">SDIO_BUS_AUTO_SWITCH</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ic_version</span> <span class="o">&gt;=</span> <span class="n">IC_VER_D</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* u_force_clkreq_0 */</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PETXCFG</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5209</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* u_force_clkreq_0 */</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PETXCFG</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm_stat</span> <span class="o">==</span> <span class="n">PM_S1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Host enter S1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">HOST_SLEEP_STATE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">HOST_ENTER_S1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pm_stat</span> <span class="o">==</span> <span class="n">PM_S3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">s3_pwr_off_delay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wait_timeout</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">s3_pwr_off_delay</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Host enter S3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">HOST_SLEEP_STATE</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="n">HOST_ENTER_S3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">do_delink_before_power_down</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">auto_delink_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CHANGE_LINK_STATE</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rtsx_force_power_down</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SSC_PDCTL</span> <span class="o">|</span> <span class="n">OC_PDCTL</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cur_clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">cur_card</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card_exist</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_enable_aspm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dynamic_aspm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Try to enable ASPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">&amp;&amp;</span> <span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span>
				<span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ASPM_FORCE_CTL</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span>
					<span class="mh">0x30</span> <span class="o">|</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtsx_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LCTLR</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">CHK_SDIO_EXIST</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u16</span> <span class="n">val</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">rtsx_write_cfg_dw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtsx_disable_aspm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span>
		<span class="n">rtsx_monitor_aspm_config</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_l0s_l1_en</span> <span class="o">&amp;&amp;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dynamic_aspm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">RTSX_DEBUGP</span><span class="p">(</span><span class="s">&quot;Try to disable ASPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">aspm_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">asic_code</span> <span class="o">&amp;&amp;</span> <span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span>
				<span class="n">rtsx_write_phy_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x0129</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5208</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ASPM_FORCE_CTL</span><span class="p">,</span> <span class="mh">0xF3</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rtsx_write_config_byte</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">LCTLR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_read_ppbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">PPBUF_BASE2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="o">/</span><span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">),</span> <span class="mi">256</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span><span class="o">%</span><span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="o">%</span><span class="mi">256</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">READ_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">rtsx_get_cmd_data</span><span class="p">(</span><span class="n">chip</span><span class="p">),</span> <span class="n">buf_len</span><span class="o">%</span><span class="mi">256</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_write_ppbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_ERROR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">reg_addr</span> <span class="o">=</span> <span class="n">PPBUF_BASE2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="o">/</span><span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf_len</span><span class="o">%</span><span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rtsx_init_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">buf_len</span><span class="o">%</span><span class="mi">256</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rtsx_add_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">WRITE_REG_CMD</span><span class="p">,</span> <span class="n">reg_addr</span><span class="o">++</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_send_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_check_chip_exist</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rtsx_readl</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xFFFFFFFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_force_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">SSC_PDCTL</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SSC_POWER_DOWN</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">OC_PDCTL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SD_OC_POWER_DOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">MS_OC_POWER_DOWN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPDCTL</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_PID</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x5288</span><span class="p">))</span>
			<span class="n">wait_timeout</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">rtsx_force_power_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">rtsx_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">SSC_PDCTL</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SSC_POWER_DOWN</span><span class="p">;</span>

<span class="cp">#ifdef SUPPORT_OCP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">OC_PDCTL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">SD_OC_POWER_DOWN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">CHECK_LUN_MODE</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">SD_MS_2LUN</span><span class="p">))</span>
			<span class="n">mask</span> <span class="o">|=</span> <span class="n">MS_OC_POWER_DOWN</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rtsx_write_register</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">FPDCTL</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">TRACE_RET</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">STATUS_FAIL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
